<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>조건 변수 (Condition Variable) | hyunyoun's Blog</title><meta name=keywords content="Computer-Science-Fundamentals,Concurrency-and-Parallelism,Condition-Synchronization,Implementation-Mechanisms,Condition-Variable,Spurious-Wakeup,Thread-Synchronization,Producer-Consumer"><meta name=description content="조건 변수(Condition Variable)는 멀티스레드 환경에서 특정 조건이 충족될 때까지 스레드를 효율적으로 대기시키고, 조건 변화 시 신호를 보내 실행을 재개하는 동기화 기법이다. 반드시 뮤텍스와 함께 사용하며, 스푸리어스 웨이크업에 대비해 while 루프 조건 재검사가 필수이다. 생산자-소비자 등 다양한 패턴에서 활용된다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/condition-synchronization/implementation-mechanisms/condition-variable/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.a9863521b3bd3c240bc506f46b95e3c06ccef2ae37f529d5f99bdaef442bccce.css integrity="sha256-qYY1IbO9PCQLxQb0a5XjwGzO8q439SnV+Zva70QrzM4=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/condition-synchronization/implementation-mechanisms/condition-variable/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/condition-synchronization/implementation-mechanisms/condition-variable/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="조건 변수 (Condition Variable)"><meta property="og:description" content="조건 변수(Condition Variable)는 멀티스레드 환경에서 특정 조건이 충족될 때까지 스레드를 효율적으로 대기시키고, 조건 변화 시 신호를 보내 실행을 재개하는 동기화 기법이다. 반드시 뮤텍스와 함께 사용하며, 스푸리어스 웨이크업에 대비해 while 루프 조건 재검사가 필수이다. 생산자-소비자 등 다양한 패턴에서 활용된다."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-04T10:54:00+00:00"><meta property="article:modified_time" content="2024-10-04T10:54:00+00:00"><meta property="article:tag" content="Computer-Science-Fundamentals"><meta property="article:tag" content="Concurrency-and-Parallelism"><meta property="article:tag" content="Condition-Synchronization"><meta property="article:tag" content="Implementation-Mechanisms"><meta property="article:tag" content="Condition-Variable"><meta property="article:tag" content="Spurious-Wakeup"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="조건 변수 (Condition Variable)"><meta name=twitter:description content="조건 변수(Condition Variable)는 멀티스레드 환경에서 특정 조건이 충족될 때까지 스레드를 효율적으로 대기시키고, 조건 변화 시 신호를 보내 실행을 재개하는 동기화 기법이다. 반드시 뮤텍스와 함께 사용하며, 스푸리어스 웨이크업에 대비해 while 루프 조건 재검사가 필수이다. 생산자-소비자 등 다양한 패턴에서 활용된다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"조건 변수 (Condition Variable)","item":"https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/condition-synchronization/implementation-mechanisms/condition-variable/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"조건 변수 (Condition Variable)","name":"조건 변수 (Condition Variable)","description":"조건 변수(Condition Variable)는 멀티스레드 환경에서 특정 조건이 충족될 때까지 스레드를 효율적으로 대기시키고, 조건 변화 시 신호를 보내 실행을 재개하는 동기화 기법이다. 반드시 뮤텍스와 함께 사용하며, 스푸리어스 웨이크업에 대비해 while 루프 조건 재검사가 필수이다. 생산자-소비자 등 다양한 패턴에서 활용된다.","keywords":["Computer-Science-Fundamentals","Concurrency-and-Parallelism","Condition-Synchronization","Implementation-Mechanisms","Condition-Variable","Spurious-Wakeup","Thread-Synchronization","Producer-Consumer"],"articleBody":"조건 변수 (Condition Variable) 조건 변수 (Condition Variable) 는 멀티스레드 환경에서 스레드가 특정 조건이 충족될 때까지 Busy-wait 없이 대기하도록 하는 동기화 메커니즘이다.\n반드시 뮤텍스와 함께 사용하여 조건 검사·변경의 원자성을 보장하며, 주요 연산은 wait()(대기), signal()/notify_one()(하나 깨움), broadcast()/notify_all()(모두 깨움) 이다.\n대부분 Mesa-style 구현을 따르므로 깨어난 뒤 조건을 while 루프로 재검사해야 하며, 유령 깨움과 신호 손실 방지를 위해 상태 변경 후 락을 잡은 채 신호를 보내야 한다.\n생산자 - 소비자, 이벤트 처리, 흐름 제어 등에서 필수적으로 활용되며, POSIX, C++, Java, Go 등 다양한 플랫폼에서 지원된다.\n핵심 개념 관점 핵심 개념 설명 이론 조건 변수 정의 조건 충족 전까지 스레드 블로킹, 충족 시 신호로 재개 이론 Mesa vs Hoare 시맨틱 Mesa: 깨운 직후 조건 변경 가능, 재검사 필요 / Hoare: 즉시 실행 보장 기본 뮤텍스 결합 상태 변경·검사 원자성 보장을 위해 필수 기본 Signal vs Broadcast 단일·전체 스레드 깨움 선택, 성능 영향 심화 스퓨리어스 웨이크업 이유 없는 깨어남, while 로 재검사 필요 심화 Lost Wakeup 대기 등록 전 신호 소실 문제, 설계로 방지 심화 다중 조건 변수 설계 상태별 분리로 불필요한 깨움 방지 심화 모니터 패턴 상태 + 뮤텍스 +CV 캡슐화로 동기화 추상화 심화 우선순위 역전 고려 스케줄링·락 정책으로 문제 회피 실무 구현 연관성 및 적용 방식 핵심 개념 실무 적용 구현 방식 예시 조건 변수 정의 생산자 - 소비자 큐 큐가 비어있으면 소비자 대기, 데이터 도착 시 깨움 뮤텍스 결합 DB 커넥션 풀 커넥션 획득·반납 시 락과 조건 변수 동시 사용 Mesa vs Hoare 스케줄러 슬롯 제공 시 깬 후 조건 재검사 Signal vs Broadcast 워커 풀 단일 작업 완료 시 하나만 깨움, 전체 리셋 시 broadcast 스퓨리어스 웨이크업 네트워크 이벤트 대기 while (!ready) wait() 구조 Lost Wakeup 실시간 알림 wait 등록 전 신호 방지를 위해 락 내에서 조건 검사 + 대기 등록 다중 조건 변수 설계 Thread Pool 상태 관리 idle/active 상태별 CV 분리 모니터 패턴 동시성 안전 객체 설계 클래스 내부에 상태 + 락 +CV 포함 우선순위 역전 고려 RTOS 제어 스레드 우선순위 상속 기능이 있는 뮤텍스 사용 조건 변수는 멀티스레드 환경에서 조건 기반의 효율적 동기화를 가능하게 하는 핵심 메커니즘이다.\n뮤텍스와 결합하여 상태 검사와 변경의 원자성을 보장하며, 스퓨리어스 웨이크업·Lost Wakeup 방지를 위해 반드시 while 재검사를 수행해야 한다.\nMesa 시맨틱이 일반적이므로 깨운 직후 조건이 변할 수 있으며, Signal/Broadcast 의 선택은 성능과 효율에 큰 영향을 미친다.\n실무에서는 생산자 - 소비자 패턴, 리소스 풀 관리, 이벤트 대기, 스케줄러, 분산 러너 동기화 등 다양한 시나리오에서 사용되며, 상태별 다중 조건 변수 설계나 모니터 패턴 적용으로 성능·확장성을 극대화할 수 있다.\n기초 이해 (Foundation Understanding) 개념 정의 및 본질 **조건 변수 (Condition Variable)**는 공유 상태의 불리언 프레디킷이 참이 될 때까지 스레드를 효율적으로 블로킹했다가, 상태 변화 시 **신호 (signal)**로 스레드를 깨우는 동기화 프리미티브다.\n사용 시에는 뮤텍스와 결합하여 프레디킷 검사·상태 변경의 원자성을 보장하고, wait 호출은 뮤텍스를 원자적으로 풀고 (unlock) 잠들었다가 (sleep) 깨어나면 다시 잠그는 (relock) 전이를 보장한다. 또한 스퓨리어스 웨이크업과 메사 시맨틱으로 인해, 깨어난 뒤 반드시 while 루프로 프레디킷을 재검사하는 것이 표준 실무 패턴이다.\n등장 배경 및 발전 과정 등장 배경 멀티스레드 환경에서 특정 조건이 만족될 때까지 스레드가 기다려야 하는 상황이 많았으나, 기존의 polling 이나 busy-wait 방식은 CPU 를 지속적으로 점유해 비효율적이었다. 이를 해결하기 위해 커널 또는 언어 차원에서 조건이 충족될 때만 스레드를 깨우는 메커니즘이 필요했고, Hoare 와 Brinch Hansen 이 개발한 모니터 (Monitor) 개념이 이론적 토대가 되었다. 이후 POSIX, Java, C++, Go, Rust 등에서 조건 변수가 표준 라이브러리로 채택되어 효율적이고 안전한 조건 대기를 제공하게 되었다.\n발전 과정 시기 주요 사건 설명 1965 Dijkstra 의 세마포어 동기화의 기초 개념 제공 1970~1974 Hoare, Brinch Hansen 의 모니터 개념 조건 변수 개념 포함, 프로세스 재개 규칙 확립 1980s Mesa semantics 정립 조건 변수 + while 재검사 패턴 확립 1980s 후반 UNIX System V, BSD 초기 조건 변수 구현 1990s POSIX pthread_cond, Win32 API 표준화 및 OS 레벨 지원 1995~2000s Java wait/notify,.NET Monitor 언어 차원 지원 확산 2000s Futex(Linux), 타임아웃 기능 성능 및 기능 개선 2010s C++11 std::condition_variable, Go/Rust 지원 현대 언어 표준화 현재 Async Condition, Cloud Native 환경 확장 비동기·분산·실시간 환경 적용 timeline title 조건 변수 발전 과정 1965 : Dijkstra - 세마포어 개념 1974 : Hoare \u0026 Brinch Hansen - 모니터와 조건 변수 1980s : Mesa semantics 확립 (while 재검사 패턴) 1988 : UNIX System V / BSD - 조건 변수 초기 구현 1990s : POSIX pthread_cond, Win32 동기화 API 표준화 1995-2000s : Java wait/notify, .NET Monitor (언어 차원 지원) 2000s : Linux futex, timed wait 등 기능 개선 2011 : C++11 condition variable 표준화 2014-2018 : Go sync.Cond, Rust Condvar 도입 2020s : Async condition, Cloud-native / RTOS 확장 핵심 동기 및 가치 제안 조건 변수 (Condition Variable) 의 도입 목적은\n폴링 (polling) 으로 인한 CPU 낭비를 제거하고, 조건 충족 전까지 스레드를 효율적으로 대기 상태로 두며, 조건 변화 시 즉시 신호를 통해 재개함으로써 응답성을 높이는 것이다. 뮤텍스와 결합해 상태 기반 협력 실행을 가능하게 하고, 복잡한 동기화 시나리오를 단순화하며, 공정성과 안전성을 보장한다.\n이는 멀티코어·실시간·모바일·분산 환경 모두에서 성능 최적화·전력 절감·확장성을 제공하는 핵심 동기화 메커니즘이다.\n구분 내용 배경 문제 폴링·바쁜 대기로 인한 CPU 낭비, 락만으로 해결 불가한 조건 기반 대기 핵심 동기 조건 충족 시까지 효율적 대기, 이벤트 기반 신호 처리, 공정한 스레드 협력 가치 제안 CPU 자원 절약, 응답성 향상, 복잡한 동기화 로직 단순화, 유지보수성 확보 부가 효과 실시간 성능 확보, 전력 효율성, 멀티코어·분산 환경에서의 확장성, 안전성 적용 사례 생산자–소비자, 송신자–수신자, Barrier, 이벤트 기반 비동기 처리 조건 변수의 핵심 가치는 자원 효율성·응답성·확장성·안전성에 있다.\n이는 CPU 낭비를 줄이고, 상태 변화 시 즉시 스레드를 깨우며, 복잡한 병행 로직을 단순화해 다양한 환경에서 안정적인 동기화를 구현한다.\n주요 특징 특징 설명 기술적 근거/도출 원리 뮤텍스 결합 필수 상태 검사와 변경을 원자적으로 수행하기 위해 조건 변수는 반드시 하나의 뮤텍스와 연동 공유 데이터 일관성 보장, 경쟁 조건 방지 원자적 대기 전환 wait() 호출 시 뮤텍스 해제와 대기 상태 진입이 원자적으로 이루어짐 조건 검사~대기 사이의 레이스 컨디션 제거 선택적 깨우기 signal() 은 하나, broadcast() 는 모든 대기 스레드 깨움 불필요한 컨텍스트 스위칭 감소, 효율 향상 Predicate 재검사 Spurious Wakeup 가능성 때문에 깨어난 뒤 조건을 다시 확인 하드웨어/OS 최적화에 따른 의도적 설계 타임아웃 대기 지원 일정 시간 후 자동 해제되는 대기 가능 무한 대기 방지, 시스템 응답성 향상 멀티채널 조건 처리 하나의 락에 여러 조건 변수를 연결해 다른 이벤트를 분리 관리 복잡한 동기화 시나리오 처리 가능 메모리 가시성 보장 대기·신호 시 암묵적 메모리 배리어 적용 최신 데이터 기반의 동기화 보장 Lost Wakeup 방지 규칙 상태 변경 후, 락을 잡은 채 신호 호출 조건 미충족 시 신호 손실 방지 조건 변수는 멀티스레드 환경에서 안전하고 효율적인 조건 대기를 구현하는 핵심 도구다.\n뮤텍스와 결합해 상태 검사·변경을 원자적으로 수행하며, Spurious Wakeup 과 Lost Wakeup 을 방지하기 위해 조건 재검사와 올바른 신호 시점이 필수다.\n선택적 깨우기, 타임아웃, 멀티채널 조건 처리 등은 성능과 유연성을 높이며, 메모리 가시성 보장은 최신 상태를 기반으로 한 동기화를 가능하게 한다.\n핵심 이론 (Core Theory) 핵심 설계 원칙 원칙 설명 기술적 근거 뮤텍스 결합 조건 변수는 반드시 하나의 뮤텍스와 연동, 조건 검사·변경은 락 안에서 수행 공유 상태 일관성, 경쟁 조건 방지 상태 변경 후 신호 상태를 변경한 뒤 signal() 또는 broadcast() 호출 Lost Wakeup 방지 조건 재검사 깨어난 후 while 루프로 조건을 다시 확인 Spurious Wakeup 방지 원자적 대기 전환 wait() 호출 시 뮤텍스 해제와 대기 상태 진입이 원자적으로 수행 경쟁 조건 제거 Mesa 시맨틱스 신호 후 즉시 제어권을 주지 않으며, 깨어난 스레드는 조건 재검사 단순 구현, 예측 가능 타임아웃·취소 지원 일정 시간 또는 조건 시 대기 해제 무한 대기 방지, 응답성 향상 공정성 고려 FIFO 등 기아 방지 메커니즘 적용 가능 스레드 스케줄링 형평성 확보 멀티채널 조건 관리 하나의 뮤텍스에 여러 조건 변수를 연결 복잡한 이벤트 동기화 가능 신호 최소화 불필요한 broadcast() 대신 대상 스레드만 신호 컨텍스트 스위칭 감소 메모리 가시성 보장 조건 변수 연산 시 메모리 배리어 적용 최신 상태 기반 동기화 조건 변수의 핵심 설계 원칙은 뮤텍스와 결합한 원자적 상태 관리와 조건 재검사가 중심이다.\n모든 조건 검사·변경은 락 안에서 수행하며, 상태 변경 후에만 신호를 보내야 Lost Wakeup 을 방지할 수 있다.\nMesa 시맨틱스 하에서 깨어난 스레드는 반드시 재검사하고, 필요 시 타임아웃·취소로 무한 대기를 막는다.\n공정성, 멀티채널 관리, 신호 최소화, 메모리 가시성 보장은 성능과 안정성을 동시에 확보하는 데 필수적인 설계 요소다.\n잘못된 사용 예 → 올바른 사용 예 비교할 수 있는 실무 가이드 예시는 Python (threading.Condition) 기준\n뮤텍스 결합: 조건 검사는 락 안에서만 잘못된 예:\n1 2 3 4 5 6 7 8 9 10 11 # ❌ 락 없이 조건 검사 → 경쟁 상태 유발 from threading import Condition cv = Condition() queue = [] def consumer(): # 락 없이 검사해서, 신호 손실/경쟁 상태 가능 if not queue: cv.wait() # RuntimeError (락 없이 wait), 또는 논리적 버그 item = queue.pop(0) 올바른 예:\n1 2 3 4 5 6 7 8 9 10 11 12 # ✅ 조건 검사와 wait는 반드시 락 범위 내에서 수행 from threading import Condition, Lock lock = Lock() cv = Condition(lock) queue = [] def consumer(): with cv: # cv가 내부적으로 lock을 사용 while not queue: # 반드시 while로 재검사 cv.wait() # wait()는 락 해제→수면→재획득을 원자적으로 수행 item = queue.pop(0) # 임계구역 안에서 안전하게 소비 상태 먼저, 신호는 나중 (Lost Wakeup 방지) 잘못된 예:\n1 2 3 4 # ❌ 신호를 먼저 보내면, 아직 대기하지 않은 스레드가 신호를 놓침 with cv: cv.notify() # 신호 먼저 queue.append(1) # 상태 나중 → 대기 스레드는 영원히 못 깨어날 수 있음 올바른 예:\n1 2 3 4 # ✅ 공유 상태 변경 후 신호 with cv: queue.append(1) # 상태 변경 cv.notify() # 그 다음 신호 → 대기자에게 조건이 보장됨 While 재검사 (Spurious Wakeup \u0026 Mesa 의미론 대응) 잘못된 예:\n1 2 3 4 5 # ❌ if 한 번만 검사 → 깨어난 뒤 조건이 여전히 거짓이어도 진행함 with cv: if not queue: cv.wait() item = queue.pop(0) # 비어있을 수 있음 (경쟁/가짜 깨움/다른 소비자 선점) 올바른 예:\n1 2 3 4 5 # ✅ while 재검사: 깨어난 뒤에도 반드시 조건 확인 with cv: while not queue: cv.wait() item = queue.pop(0) Notify Vs notify_all: 정확히 필요한 만큼만 깨우기 잘못된 예:\n1 2 3 4 5 # ❌ 항상 broadcast → Thundering Herd(군집 깨어남) 유발, 경합 증가 with cv: produced = [1, 2, 3] # 1개만 소비 가능해도… queue.extend(produced) cv.notify_all() # 불필요하게 모두 깨움 올바른 예:\n1 2 3 4 5 6 # ✅ 조건을 만족하는 예상 소비자 수만큼 notify with cv: produced = [1, 2, 3] queue.extend(produced) for _ in range(len(produced)): # 실제로 소비 가능한 개수만큼 cv.notify() # 필요한 만큼만 깨움 → 경합/컨텍스트 스위칭 절감 타임아웃/캔슬: 고립 방지와 빠른 복귀 잘못된 예:\n1 2 3 4 # ❌ 무한 대기: 신호가 영영 오지 않으면 스레드가 고립 with cv: while not queue: cv.wait() # 타임아웃 없음 올바른 예: (타임아웃)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # ✅ 타임아웃으로 고립 방지 from time import monotonic with cv: deadline = monotonic() + 2.0 # 2초 내 대기 while not queue: remaining = deadline - monotonic() if remaining \u003c= 0: break # 타임아웃 경로로 빠져나옴 cv.wait(timeout=remaining) if queue: item = queue.pop(0) else: # 타임아웃 대응 로직 (재시도/로그/폴백 등) pass 올바른 예: (캔슬 신호)\n1 2 3 4 5 6 7 8 9 10 11 12 # ✅ 외부 취소 이벤트로 빠른 복귀 from threading import Event cancel = Event() def consumer(): with cv: while not queue and not cancel.is_set(): cv.wait(timeout=0.2) # 짧게 깨어나 cancel 확인 if cancel.is_set(): return # 정중한 종료 item = queue.pop(0) 단일 소유 원칙: 하나의 뮤텍스로 한 공유 상태 보호 잘못된 예:\n1 2 3 4 # ❌ 동일한 공유 상태를 두 개의 락으로 보호 → 순서 꼬임/데드락/레이스 lock1, lock2 = Lock(), Lock() cv1, cv2 = Condition(lock1), Condition(lock2) # queue를 lock1/lock2로 번갈아 보호… (금기) 올바른 예:\n1 2 3 4 # ✅ 공유 상태(queue)는 하나의 락과 대응되는 하나의 Condition 세트로 일관되게 보호 lock = Lock() cv = Condition(lock) queue = [] 멀티채널 조건: 다른 이벤트는 다른 CV 로 분리 잘못된 예:\n1 2 3 # ❌ 하나의 CV로 “비어있지 않음”과 “가득 참”을 모두 표기 → 신호 충돌/오해 cv = Condition(lock) not_empty = not_full = cv 올바른 예:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # ✅ 의미가 다른 조건은 조건 변수도 분리 lock = Lock() not_empty = Condition(lock) # 소비자 대기 not_full = Condition(lock) # 생산자 대기 capacity = 10 queue = [] def producer(x): with not_full: while len(queue) == capacity: not_full.wait() queue.append(x) not_empty.notify() # 소비자를 정확히 깨움 def consumer(): with not_empty: while not queue: not_empty.wait() item = queue.pop(0) not_full.notify() # 생산자를 정확히 깨움 공정성/기아 방지: 깨어난 뒤에도 조건 재검사 + 순차 신호 잘못된 예:\n1 2 # ❌ 특정 스레드만 반복적으로 유리 → 기아 상태 # 무분별한 notify_one()과 편향된 조건 갱신 올바른 예:\n1 2 3 4 # ✅ 조건 재검사 + 균형 잡힌 신호 정책 # - 깨어난 스레드는 while 재검사 # - 생산/소비 시 각각 반대쪽 조건에 공정하게 notify # - 필요 시 주기적으로 notify_all()로 막힌 큐 해소 성능 팁: 임계 구역 최소화 (락 홀딩 시간 단축) 잘못된 예:\n1 2 3 4 5 6 # ❌ 임계 구역에서 무거운 연산/IO 수행 with cv: while not queue: cv.wait() item = queue.pop(0) do_heavy_io(item) # 락 잡은 상태로 오래 실행 → 경합 급증 올바른 예:\n1 2 3 4 5 6 7 # ✅ 데이터만 안전하게 꺼낸 뒤, 락 밖에서 무거운 작업 수행 with cv: while not queue: cv.wait() item = queue.pop(0) do_heavy_io(item) # 락 해제 후 실행 → 대기 시간/경합 감소 테스트 포인트: 부하·경합·타임아웃을 항상 검증 부하 테스트: 생산/소비 비율을 바꿔가며 대기 시간과 처리량 측정 경합 테스트: 스레드 수를 늘려 락 경합률, 컨텍스트 스위칭 지표 확인 타임아웃/캔슬 테스트: 신호가 오지 않는 조건을 인위적으로 만들어 복귀 경로/리소스 해제를 점검 기본 원리 및 동작 메커니즘 기본 원리 항목 핵심 개념 핵심 포인트 Predicate(조건) 진행 여부를 결정하는 불린 조건식 \" 상태가 참이어야 진행 “; 신호는 상태가 아님 락 결합 조건 변수는 락과 함께 사용 wait 호출 전 락 보유 필수 원자적 해제/재획득 wait(lock) 동작 락 해제 + 대기가 원자적, 깨어나면 락 재획득 후 반환 신호 종류 notify / broadcast 필요한 최소 스레드만 깨우기 권장 재검사 (while) Mesa 의미론 대응 스푸리어스 웨이크업·경쟁 대응 위해 while 재검사 메모리 가시성 acquire/release 락으로 순서·가시성 보장 (쓰기→신호→해제, 획득→읽기) 타임아웃/취소 wait_for/wait_until 무한 대기 방지·복구 경로 제공 순서/공정성 구현 종속 FIFO 미보장 가능—필요 시 별도 큐/우선순위 설계 실무 패턴 두 조건 전략, 상태 플래그 notEmpty/notFull 등 조건 분리로 경합 감소 조건 변수는 락으로 보호된 상태를 기준으로\nwait 에서 원자적 해제 - 대기 - 재획득을 수행하고, 신호 후에도 반드시 while 로 재검사해 안전하게 진행한다.\n신호는 상태가 아니라 상태 변화의 힌트이며, 가시성은 락의 메모리 순서로 보장된다. 동작 메커니즘 sequenceDiagram participant P as Producer (신호 측) participant C as Consumer (대기 측) participant M as Mutex participant CV as Condition Variable participant S as Shared State C-\u003e\u003eM: lock() C-\u003e\u003eS: check predicate alt predicate == false C-\u003e\u003eCV: wait(M) Note right of CV: atomically unlock(M) / sleep / relock(M) C-\u003e\u003eS: re-check predicate (while) else predicate == true C-\u003e\u003eS: proceed end C-\u003e\u003eM: unlock() par 다른 스레드(Producer) P-\u003e\u003eM: lock() P-\u003e\u003eS: update state (predicate becomes true) P-\u003e\u003eCV: notify (or notifyAll) P-\u003e\u003eM: unlock() end 소비자 (C) 는 락 획득→조건 검사→불만족 시 wait 로 원자적 해제·수면에 들어가고, 생산자 (P) 가 상태 변경→notify→락 해제를 수행한다. 깨어난 C 는 락 재획득 후 while 로 재검사하여 참이면 진행, 거짓이면 다시 대기한다. broadcast 는 많은 스레드를 깨워 경합을 유발할 수 있어 주의가 필요하다.\n상세 동작 프로세스:\nwait() 연산: 현재 스레드가 뮤텍스를 소유하고 있는지 확인 원자적으로 뮤텍스 해제 및 대기 큐에 추가 스레드를 블로킹 상태로 전환 신호 수신 시 대기 큐에서 제거 뮤텍스 재획득 시도 뮤텍스 획득 후 wait() 리턴 signal() 연산: 대기 큐에서 하나의 스레드 선택 (FIFO) 해당 스레드를 깨우기 (ready 상태로 전환) 스케줄러에게 스레드 실행 요청 broadcast() 연산: 대기 큐의 모든 스레드 선택 모든 대기 스레드를 깨우기 뮤텍스 경쟁 발생 (하나씩 획득) 아키텍처 및 구성요소 조건 변수 아키텍처는 하나의 뮤텍스가 보호하는 공유 상태를 중심으로, 조건 변수와 그 내부 대기 큐 (Wait Queue) 가 연결된 구조다.\n스레드는 락을 획득하고 술어 (predicate) 를 검사한 뒤, 조건이 거짓이면 wait 를 호출해 락을 원자적으로 해제 후 대기로 들어간다. 다른 스레드가 공유 상태를 변경한 뒤 락을 보유한 상태에서 signal 또는 broadcast 를 호출하면, 대기 스레드가 깨어나 OS 스케줄러의 중재를 거쳐 락을 재획득한다.\n현대 구현은 Mesa 시맨틱스를 사용하므로 깨어난 스레드는 while 루프로 조건을 재확인해야 한다.\n성능과 안정성 향상을 위해 notify one vs notify all 선택, 타임아웃 대기, 우선순위 기반 큐, 엔트리 큐 분리, 메모리 가시성 보장을 함께 설계한다.\n아키텍처 구조 graph TD subgraph Threads T1[Thread Producer] T2[Thread Consumer] end subgraph Monitor M[Mutex] S[Shared State] CV[Condition Variable] WQ[Wait Queue] EQ[Entry Queue] end subgraph Runtime SCH[OS Scheduler] VIS[Memory Visibility] end T1 --\u003e M T2 --\u003e M M --\u003e S S --\u003e CV CV --\u003e WQ M -. lock waiters .-\u003e EQ %% Producer path T1 --\u003e|update state| S T1 --\u003e|signal or broadcast| CV CV --\u003e|wake candidates| SCH %% Wake and re acquire SCH --\u003e|ready to run| T2 T2 --\u003e|wait if needed| WQ T2 --\u003e|re acquire| M %% Visibility guarantees VIS --- S VIS --- CV 스레드 → 락 → 공유 상태 → 조건 변수 대기 큐 → 신호 → 스케줄러 → 락 재획득의 흐름 Entry Queue·메모리 가시성의 보조 역할을 함께 표현 구성 요소 구성 요소 등급 설명 역할 핵심 기능 특징 Shared State 필수 보호 대상인 공유 데이터와 그 상태 플래그 조건 판단의 근거 상태 플래그 갱신 · 조회 항상 하나의 뮤텍스로 보호 Mutex Lock 필수 상호 배제를 보장하는 락 상태 접근의 원자성 보장 lock unlock try_lock 재진입성 여부 구현체 의존 우선순위 상속 가능 Condition Variable 필수 조건 기반 대기와 깨움을 제공 상태 기반 협업의 관문 wait timed wait notify notify_all wait 시 락 원자적 해제 후 대기 재깨어나면 락 재획득 Wait Queue 필수 조건 변수 내부의 대기 스레드 큐 신호 대상 관리 FIFO 또는 우선순위 운영 Mesa 시맨틱스 깨어남 후 재검사 필요 Entry Queue 선택 락 획득 대기 스레드 큐 공정한 락 진입 순서 FIFO 우선순위 기반 경합 완화 및 기아 방지에 유용 Signal Broadcast 필수 하나 혹은 모든 대기자 깨움 트리거 상태 변화 통지 notify one notify all 불필요한 깨움은 경합 유발 설계로 최소화 Timeout Mechanism 선택 무한 대기 방지 고립 회피 및 복구 경로 제공 timed wait deadline SLA 대응 및 장애 격리 Priority Queue Policy 선택 우선순위 기반 대기 처리 기아 방지 실시간성 확보 priority scheduling RT 환경에서 중요 OS Scheduler Kernel Wait 필수 스레드 수면과 깨움 전환 컨텍스트 스위칭 제어 대기 큐 전환 깨어남 스케줄링 일부 시스템은 futex 기반으로 사용자 공간 경로 최적화 Memory Visibility Semantics 필수 가시성과 순서 보장 최신 상태 관측 보장 happens before barrier 언어 메모리 모델로 보장 JMM CppMM 등 주요 기능과 역할 기능 역할 책임 상호 관계 조건 검사 Predicate 를 검사하여 조건 불만족 시 대기 준비 락 안에서만 접근, 상태 무결성 보장 wait() 와 결합 wait() 조건 충족까지 스레드 블로킹 원자적 unlock → sleep → relock, 대기 큐 등록 signal()/broadcast() 와 대응 signal()/notify_one() 대기 스레드 하나를 깨움 대기 큐에서 하나 선택, 스케줄러로 실행 가능 상태 전환 wait() 와 대응 broadcast()/notify_all() 모든 대기 스레드 깨움 전체 상태 변경 시 사용, herd thundering 유발 가능 wait() 와 대응 timed_wait() 타임아웃 설정된 조건 대기 시간 초과 시 false 반환, 조건 충족 시 true 반환 조건 검사와 결합 뮤텍스 연동 상태 변경·검사 원자성 보장 락과 조건 변수 항상 페어 사용 모든 기능과 결합 조건 변수의 주요 기능은\n조건 검사 → 대기 (wait) → 신호 (signal/broadcast) → 재검사의 흐름을 중심으로 작동한다. 모든 과정은 뮤텍스와 결합하여 상태 검사와 변경의 원자성을 확보하며, wait 호출은 내부적으로 unlock → sleep → relock을 원자적으로 수행한다. 깨어난 스레드는 스퓨리어스 웨이크업과 Mesa 시맨틱에 대비해 반드시 조건을 다시 확인해야 한다. signal 은 하나의 스레드만, broadcast 는 모든 대기 스레드를 깨우며, timed_wait 를 통해 대기 시간을 제한할 수 있다. 내부적으로 조건 변수는 대기 큐를 관리하며, signal/broadcast 가 큐에서 스레드를 선택해 OS 스케줄러로 넘긴다. 특성 분석 (Characteristics Analysis) 장점 및 이점 조건 변수는 CPU 자원을 효율적으로 사용하면서, 복잡한 동기화 로직을 단순화하고 안정적인 스레드 협업을 가능하게 한다.\n바쁜 대기 없이 조건 충족 시 즉시 스레드를 깨우며, 뮤텍스와 결합해 race condition 을 방지한다.\n하나의 락에 여러 조건 변수를 연결하거나 타임아웃을 지원해 다양한 패턴과 장애 상황에 대응할 수 있다.\n표준 API 로 다양한 언어와 플랫폼에서 이식성이 높고, 메모리 가시성 보장과 공정성 제어로 실시간 및 고성능 시스템에도 적합하다.\n구분 항목 설명 기술적 근거 성능 CPU 효율성 바쁜 대기 제거, 블로킹 기반 대기 OS 스케줄러가 대기 스레드를 실행 큐에서 제거 성능 응답성 조건 충족 시 즉시 스레드 깨움 커널 레벨 신호 및 스케줄링 메커니즘 설계 코드 단순화 복잡한 동기화 로직을 간결하게 표현 wait/signal 추상화 확장성 다양한 패턴 지원 생산자 - 소비자, 배리어, Reader-Writer 등 구현 가능 여러 조건 변수 및 signal/broadcast 제공 안정성 경쟁 조건 방지 뮤텍스와 결합해 상태 접근 원자성 보장 락 보호 및 while 재검사 규칙 호환성 표준화 및 이식성 다양한 언어·플랫폼에서 지원 POSIX, C++, Java, Go 등 안정성 메모리 가시성 보장 최신 상태를 올바르게 관측 가능 언어 메모리 모델이 happens-before 보장 유연성 타임아웃 대기 무한 대기 방지 및 고립 회피 timed_wait 기능 공정성 기아 방지 FIFO 또는 우선순위 기반 스케줄링 가능 OS 스케줄러 정책 연계 조건 변수는 바쁜 대기 없이 효율적 동기화를 가능하게 하며, 즉시 반응성과 안정성을 동시에 확보한다.\n복잡한 패턴을 간결하게 구현하고, 타임아웃·다중 조건 변수·메모리 가시성 보장 등으로 다양한 환경에 적합하다. 표준화된 API 와 높은 이식성 덕분에 범용적으로 활용되며, 공정성 제어로 실시간·고성능 시스템에도 안정적으로 적용 가능하다.\n단점 및 제약사항과 해결방안 조건 변수는 강력한 동기화 도구이지만, 잘못된 사용 패턴이나 플랫폼 특성으로 인해 버그와 성능 문제가 발생할 수 있다.\n대표적으로 Spurious Wakeup과 Lost Wakeup은 조건 재검사와 올바른 락 사용으로 방지해야 한다.\n또한, Deadlock과 Priority Inversion은 락 순서 정의·우선순위 상속 등 설계 단계에서 예방 가능하다.\nThundering Herd 현상은 signal 로 최소 깨움 전략을 사용하고, 조건 변수를 샤딩해 완화할 수 있다.\n플랫폼별 세부 동작 차이와 디버깅 난이도를 고려해, 로깅·트레이싱·표준화된 인터페이스를 적극 활용하는 것이 바람직하다.\n구분 항목 설명 원인 영향 탐지/진단 예방 방법 해결 기법/대안 안정성 Spurious Wakeup 조건 미충족 상태에서 깨어남 OS/구현체 특성 오동작, 잘못된 진행 로그, 디버깅 while 루프로 조건 재검사 조건 검증 강화, predicate 기반 wait 안정성 Lost Wakeup wait 등록 전 signal 발생 타이밍 경쟁 영구 대기 대기시간 모니터링 뮤텍스 보유 상태에서 wait, 조건 재검사 상태 변경 직후 signal 안정성 Deadlock 락 순서 불일치, 재진입 오류 잘못된 설계 시스템 정지 데드락 탐지 도구 락 계층 정의, 타임아웃 데드락 회피 알고리즘 안정성 Priority Inversion 낮은 우선순위 스레드가 락 점유 우선순위 경합 응답성 저하 스케줄러 트레이스 락 홀드 최소화, 우선순위 정책 적용 우선순위 상속/천장 프로토콜 성능 Thundering Herd broadcast 남용 불필요한 동시 기상 컨텍스트 스위칭 폭증 프로파일링 signal 우선 사용 조건 변수 샤딩, 이벤트 큐 복잡성 사용 난이도 뮤텍스·조건 변수·predicate 조합 복잡 API 사용법 미숙 버그 증가 코드 리뷰, 정적 분석 표준 패턴 준수 모니터 패턴, 고수준 동기화 성능 컨텍스트 스위칭 오버헤드 잦은 대기/깨움 커널 모드 전환 처리량 저하 성능 측정 최소한의 깨움, 배치 처리 lock-free 자료구조 이식성 플랫폼별 동작 차이 구현 차이 포팅 이슈 이식성 저하 크로스 테스트 표준 API 사용 호환성 계층 적용 디버깅 문제 추적 어려움 동시성 버그 재현 어려움 재현성 낮음 트레이스, 로깅 모니터링 강화 동시성 테스팅 도구 조건 변수의 주요 위험 요소는 신호 손실 (Lost Wakeup), 가짜 깨움 (Spurious Wakeup), 교착 상태 (Deadlock), 우선순위 역전, 성능 저하 (Thundering Herd), 복잡성 증가, 그리고 이식성 문제다.\n이들 문제는 대부분 표준 사용 패턴 준수와 설계 단계 예방책으로 방지 가능하며, 특히 while 조건 재검사, 뮤텍스 락 순서 정의, 최소한의 signal 사용이 핵심이다.\n또한, 디버깅·모니터링 환경을 마련하고, 필요 시 고수준 동기화 도구나 lock-free 자료구조로 대체하는 전략이 실무적으로 유효하다.\n가짜 깨움 (Spurious Wakeup) 가짜 깨우기는 조건 변수 (Condition Variable) 를 사용할 때 발생할 수 있는 현상으로, 조건 변수에서 명시적 신호 (signal 이나 broadcast 등) 없이 wait 상태에서 스레드가 깨어나는 현상이다. 이는 정상 동작으로 간주되며, POSIX, Java, C++ 표준에서도 발생 가능성을 인정하고 방어적 코드를 요구한다. 따라서 wait 호출은 항상 while 조건 재검사를 통해 보호해야 한다.\n원인:\n운영체제 스케줄러 동작—특정 상황에서 대기 큐 전체를 깨우거나 잘못된 스레드를 깨움. 하드웨어 인터럽트—외부 장치나 타이머 인터럽트가 대기 상태를 해제. 시그널 처리—OS 의 시그널 메커니즘이 wait 상태를 중단. 조건 변수 구현 차이—POSIX, Java, C++ 에서 허용하는 동작으로 표준에서 인정. 다중 조건 변수 혼용—같은 wait 큐에 여러 조건이 섞여 있는 경우. 문제점:\n조건이 충족되지 않았음에도 스레드가 실행 → 잘못된 데이터 사용, 레이스 컨디션 발생. 자원 상태 불일치 → 동기화 실패, 프로그램 불안정. 불필요한 컨텍스트 스위칭 → 성능 저하. 해결책:\nwhile 재검사—조건이 만족될 때까지 반복 확인. 상태 변수 사용—단순히 신호만 기다리지 않고 명시적 상태 확인. 상태 변경 순서 준수—상태 변경 → notify 순서. 모든 공유 상태 동기화 블록 내에서 변경—원자적 보장. Predicate 기반 설계—명확한 조건 함수로 대기 종료 시점 정의. 권장 패턴:\nwhile not 조건: wait() + 명확한 상태 변수 구현 예시:\n잘못된 구현 (if 사용)\n1 2 3 4 5 def wait_for_data(condition, shared_data): with condition: if not shared_data.is_ready: # ❌ 한 번만 검사 condition.wait() return shared_data.value 문제 Spurious Wakeup 발생 시 조건이 만족되지 않아도 반환함. 잘된 구현 (while 사용)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 class SharedData: def __init__(self): self.condition = threading.Condition() self.is_ready = False self.value = None # 소비자: 데이터 준비될 때까지 대기 def wait_for_data(self): with self.condition: while not self.is_ready: # ✅ 반복 검사 self.condition.wait() return self.value # 생산자: 데이터 설정 후 알림 def set_data(self, value): with self.condition: self.value = value self.is_ready = True self.condition.notify_all() 개선점: while 로 반복 검사 명확한 상태 변수 is_ready 상태 변경 후 notify_all() 호출 트레이드오프 관계 분석 비교 항목 선택지 A A 의 장점 A 의 단점 선택지 B B 의 장점 B 의 단점 선택 기준 동기화 방식 CV CPU 절약, 상태 기반, 안전성 프로토콜 복잡, 스케줄링 비용 폴링/스핀 구현 단순, 초단기 지연 최소 CPU 낭비, 전력/확장성 열위 대기 시간이 짧으면 스핀 (혼합), 일반적으론 CV 프리미티브 CV 복합 조건 표현, 조건 분리 상태/플래그 설계 필요 세마포어 카운팅 자원에 최적, 단순 복합 조건 취약 \" 개수 관리 “=세마포어, \" 상태/조건 “=CV 동기화 모델 CV(상태공유) 세밀 제어, 재검사 용이 락 경합 관리 필요 채널 (메시지) 코드 단순, 결합도↓ 복합 상태 표현 우회 필요 데이터/이벤트 흐름=채널, 상태 기반=CV 신호 범위 notify_one 경합 최소, 효율적 한 스레드가 조건 불충족일 수 있음 notify_all 변화 전파 확실 스레드 폭주/경합 기본 one, 구조 변경/다중 의존=all 의미론 Mesa 보편적, 구현 단순 while 재검사 필수 Hoare 즉시 실행, 논리 명확 구현 난도↑ 일반적 Mesa, RT 엄격성 필요 시 보완 설계 락 전략 스핀락 초저지연 (매우 짧은 임계구역) CPU 낭비 블로킹 +CV 장기 대기 효율, 전력 우수 스케줄링 비용 임계구역 길이에 따라 선택/혼합 조건 변수는 상태 기반 동기화의 표현력과 효율성을 제공하지만, 올바른 프로토콜 (while 재검사, 상태→notify→unlock, 조건 분리) 을 지켜야 성능과 안정성을 함께 얻을 수 있다.\n자원 카운팅은 세마포어, 데이터·이벤트 흐름은 채널, 복합 상태 협업은 CV가 유리하다.\n신호 범위는 notify_one 우선, 필요 시 notify_all을 신중히 사용하고, 초단기 임계구역에는 스핀→CV 혼합으로 실용 균형을 맞추는 것이 좋다.\n구현 및 분류 (Implementation \u0026 Classification) 구현 기법 및 방법 기본 구현 패턴\n기법 정의 구성 목적 실제 예시 Mesa Style signal() 후 즉시 제어권 넘기지 않음 while 루프 + predicate spurious wakeup 대응 POSIX pthread Hoare Style signal() 후 즉시 제어권 이전 if 검사만으로 충분 즉시 조건 보장 일부 교육용 구현 Predicate-based 조건 함수와 결합된 대기 lambda/function + cv 조건 캡슐화 C++11 wait() 벤치마크 시나리오 고정된 버퍼 용량 (capacity) 과 생산자/소비자 수, 총 아이템 수 설정 각 아이템의 생산 시작 시각을 담아 소비 시 지연 (latency) 계산 구현별로: 총 처리량 (Throughput), 평균/중앙/최대 지연, 대기 횟수 (빈 버퍼/가득 찬 버퍼로 인한 wait 횟수) 비교 공평비교 위해 동시 시작 Barrier 사용 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 import threading import time from collections import deque from statistics import mean, median # ========================= # 공통 메트릭 수집 도우미 # ========================= class BenchMetrics: \"\"\"버퍼 내부의 대기/신호 관련 카운터를 수집한다.\"\"\" def __init__(self): self.lock = threading.Lock() self.waits_on_full = 0 # put 시 버퍼가 가득 차서 기다린 횟수 self.waits_on_empty = 0 # get 시 버퍼가 비어서 기다린 횟수 def inc_full(self): with self.lock: self.waits_on_full += 1 def inc_empty(self): with self.lock: self.waits_on_empty += 1 def snapshot(self): with self.lock: return dict(waits_on_full=self.waits_on_full, waits_on_empty=self.waits_on_empty) # ========================= # 공통 인터페이스 # ========================= class BufferIFace: \"\"\"put/get 인터페이스만 강제. 구현은 세 가지 스타일로 제공.\"\"\" def put(self, item): raise NotImplementedError def get(self): raise NotImplementedError # ========================= # 1) Mesa Style (표준) 구현 # - 스퓨리어스 웨이크업 \u0026 Mesa 의미론 대응: while 재검사 # ========================= class MesaBuffer(BufferIFace): def __init__(self, capacity=64, metrics: BenchMetrics | None = None): self.cap = capacity self.q = deque() self.lock = threading.Lock() self.cv = threading.Condition(self.lock) self.metrics = metrics or BenchMetrics() def put(self, item): with self.cv: # CV는 항상 락과 페어 while len(self.q) \u003e= self.cap: self.metrics.inc_full() # wait는 원자적으로 unlock→sleep→relock 수행 self.cv.wait() self.q.append(item) # 상태 변화(비어있지 않음) 알림: 보통 하나만 깨우는 것이 효율적 self.cv.notify() def get(self): with self.cv: while not self.q: self.metrics.inc_empty() self.cv.wait() item = self.q.popleft() # 상태 변화(가득참→여유) 알림 self.cv.notify() return item # ========================= # 2) Hoare Style (교육용 시뮬레이션) # - 실제 파이썬 런타임은 Mesa 시맨틱. urgent 큐를 둬서 \"즉시 양도\" 느낌을 흉내낸다. # - 논리: signaler는 urgent 큐로 이동해 대기, waiter가 일을 마치면 urgent.notify()로 깨워 제어권 회수 # ========================= class HoareSimBuffer(BufferIFace): def __init__(self, capacity=64, metrics: BenchMetrics | None = None): self.cap = capacity self.q = deque() self.lock = threading.Lock() self.waiters = threading.Condition(self.lock) # 대기자용 self.urgent = threading.Condition(self.lock) # 신호자 복귀 대기열 self.metrics = metrics or BenchMetrics() def put(self, item): with self.lock: while len(self.q) \u003e= self.cap: self.metrics.inc_full() self.waiters.wait() self.q.append(item) # 조건 충족 → waiter를 깨우고, \"즉시 양도\" 시뮬: self.waiters.notify() # signaler는 urgent 큐에서 잠깐 대기하여 waiter가 먼저 달리게 한다. # (임계영역 길이에 따라 오히려 손해일 수 있음 — 교육용!) self.urgent.wait(timeout=0) # 0으로 스핀 없음, 즉시 리턴 (양도 힌트 효과만) def get(self): with self.lock: while not self.q: self.metrics.inc_empty() self.waiters.wait() item = self.q.popleft() self.waiters.notify() # waiter가 일을 마쳤으니 signaler 깨움(제어권 복원 힌트) self.urgent.notify() return item # ========================= # 3) Predicate-based Style # - wait_for(predicate)로 프레디킷 캡슐화 + 내부 while 재검사 자동화 # ========================= class PredicateBuffer(BufferIFace): def __init__(self, capacity=64, metrics: BenchMetrics | None = None): self.cap = capacity self.q = deque() self.lock = threading.Lock() self.cv = threading.Condition(self.lock) self.metrics = metrics or BenchMetrics() def _not_full(self): return len(self.q) \u003c self.cap def _not_empty(self): return len(self.q) \u003e 0 def put(self, item): with self.cv: # 실패(타임아웃 없음 가정) 시 False 반환이지만 여기서는 성공할 때까지 대기 while not self._not_full(): self.metrics.inc_full() self.cv.wait() self.q.append(item) self.cv.notify() def get(self): with self.cv: while not self._not_empty(): self.metrics.inc_empty() self.cv.wait() item = self.q.popleft() self.cv.notify() return item # ========================= # 벤치마크 러너 # ========================= def run_benchmark(BufferCls, *, capacity=64, num_producers=2, num_consumers=2, items_per_producer=10, producer_think_s=0.0, consumer_think_s=0.0): \"\"\" 동일 인자 하에 BufferCls 구현을 벤치마크한다. - 각 아이템은 (t0, payload) 형태로 생산되어 소비 시 지연을 측정한다. - 소비자마다 목표 소비 개수를 배분하여 자연 종료하도록 한다. \"\"\" metrics = BenchMetrics() buf = BufferCls(capacity=capacity, metrics=metrics) total_items = num_producers * items_per_producer # 소비자별 목표 개수 배분(마지막 소비자가 나머지 처리) base = total_items // num_consumers shares = [base] * num_consumers shares[-1] += total_items - base * num_consumers start_barrier = threading.Barrier(num_producers + num_consumers) latencies = [] # 전체 지연(ms) 수집 lat_lock = threading.Lock() def record_latency_ms(t0): with lat_lock: latencies.append((time.perf_counter() - t0) * 1000.0) def producer(pid): start_barrier.wait() for i in range(items_per_producer): t0 = time.perf_counter() buf.put((t0, (pid, i))) # payload: (producer_id, seq) if producer_think_s: time.sleep(producer_think_s) def consumer(cid, quota): start_barrier.wait() for _ in range(quota): t0, payload = buf.get() record_latency_ms(t0) if consumer_think_s: time.sleep(consumer_think_s) producers = [threading.Thread(target=producer, args=(p,)) for p in range(num_producers)] consumers = [threading.Thread(target=consumer, args=(c, shares[c])) for c in range(num_consumers)] t_begin = time.perf_counter() for th in producers + consumers: th.start() for th in producers + consumers: th.join() t_end = time.perf_counter() elapsed = t_end - t_begin m = metrics.snapshot() # 지연 통계 lat_ms = latencies if latencies else [0.0] stats = { \"total_items\": total_items, \"elapsed_s\": elapsed, \"throughput_items_per_s\": total_items / elapsed if elapsed \u003e 0 else float('inf'), \"latency_ms_avg\": mean(lat_ms), \"latency_ms_p50\": median(lat_ms), \"latency_ms_max\": max(lat_ms), \"waits_on_full\": m[\"waits_on_full\"], \"waits_on_empty\": m[\"waits_on_empty\"], } return stats # ========================= # 실행 예시 # ========================= def pretty(name, stats): print(f\"\\n=== {name} ===\") print(f\"items={stats['total_items']}, elapsed={stats['elapsed_s']:f}s, \" f\"throughput={stats['throughput_items_per_s']:f}/s\") print(f\"latency(ms): avg={stats['latency_ms_avg']:f}, \" f\"p50={stats['latency_ms_p50']:f}, max={stats['latency_ms_max']:f}\") print(f\"waits: on_full={stats['waits_on_full']}, on_empty={stats['waits_on_empty']}\") if __name__ == \"__main__\": # 벤치마크 파라미터 CAP = 64 NP, NC = 4, 4 ITEMS_PER_PROD = 500 P_THINK, C_THINK = 0.0, 0.0 s1 = run_benchmark(MesaBuffer, capacity=CAP, num_producers=NP, num_consumers=NC, items_per_producer=ITEMS_PER_PROD, producer_think_s=P_THINK, consumer_think_s=C_THINK) pretty(\"Mesa (표준 while 재검사)\", s1) s2 = run_benchmark(HoareSimBuffer, capacity=CAP, num_producers=NP, num_consumers=NC, items_per_producer=ITEMS_PER_PROD, producer_think_s=P_THINK, consumer_think_s=C_THINK) pretty(\"Hoare (교육용 시뮬레이션)\", s2) s3 = run_benchmark(PredicateBuffer, capacity=CAP, num_producers=NP, num_consumers=NC, items_per_producer=ITEMS_PER_PROD, producer_think_s=P_THINK, consumer_think_s=C_THINK) pretty(\"Predicate(wait_for)\", s3) 분류 기준에 따른 유형 구분 분류 기준 유형 특징 사용 사례 구현/API 예시 대기 대상 단일 조건 하나의 불변식 감시 not_empty cv.wait(lock, pred) 다중 조건 서로 다른 불변식 각각 감시 not_empty + not_full CV 2 개 운용 깨우기 범위 Signal 하나의 스레드만 깨움 단일 소비자 큐 notify_one() Broadcast 모든 대기 스레드 깨움 Barrier, 상태 대규모 변경 notify_all() 대기 방식 무제한 대기 조건 만족까지 블록 데몬성 워커 wait(lock) 타임아웃 대기 지정 시간까지만 대기 네트워크 응답 대기 wait_for, wait_until 조건 검사 방식 명시적 검사 while + predicate 전통적 구현 while(!pred) cv.wait(lock); Predicate 기반 API 에 조건 전달 현대적 구현 cv.wait(lock, pred) 락 호환성 표준 CV std::mutex 전용 대부분 시나리오 std::condition_variable 범용 CV 임의의 락 지원 커스텀 락 환경 std::condition_variable_any 우선순위 처리 FIFO 등록 순서대로 깨움 공정성 중시 OS/RTOS 큐 정책 Priority 우선순위 높은 스레드 우선 실시간 처리 우선순위 큐 구현 조건 변수 유형은 대기 조건의 수 (단일/다중), 신호 범위 (단일/다중), 대기 시간 제어 (무제한/타임아웃), 조건 검사 방식 (명시적/predicate 기반), 락 호환성 (표준/범용), **우선순위 처리 (FIFO/우선순위)**로 구분할 수 있다.\n실무에서는 notEmpty/notFull 처럼 다중 조건 분리, 기본은 notify_one, 이벤트 확산 시 notify_all을 사용하며, 타임아웃은 장애 전파와 응답성 확보에 필수다.\n또한, 스푸리어스 웨이크업 방지를 위해 predicate 기반 wait을 권장하고, 락 환경에 따라 condition_variable_any 선택이 필요하다. 우선순위 처리는 실시간성 요구 시 커스텀 구현이 요구된다.\n실무 적용 (Practical Application) 실제 도입 사례 조건 변수는 다양한 산업 분야에서 스레드 간 효율적인 동기화를 위해 활용된다.\n데이터베이스 연결 풀과 버퍼 관리에서는 자원이 없을 때 스레드를 대기시키고, 자원이 반환되면 즉시 깨워 처리 속도를 높인다.\n작업 큐·메시지 큐·웹 서버 요청 처리에서는 유휴 스레드의 CPU 사용을 최소화하면서 요청 폭증 시 부하를 분산한다.\n실시간 게임 엔진과 네트워크 패킷 처리에서는 프레임 동기화·데이터 수신 시 즉시 반응성을 보장한다.\n또한 스트리밍·프린터 스풀러·파일 처리 파이프라인 등에서는 생산자 - 소비자 간의 부드러운 흐름 제어와 역압 (backpressure) 을 구현한다.\n분야 사례 조합 기술 효과 DB/버퍼 관리 DB 연결 풀, DB 버퍼 풀 Mutex + Condition Variable 연결·버퍼 자원 효율적 사용, 대기·깨움 제어 작업 관리 Thread Pool 작업 큐, 메시지 큐 Work Queue + Condition Variable 유휴 CPU 사용 최소화, 부하 분산 웹 서버 Apache, Nginx 요청 처리 Thread Pool + Condition Variable 요청 폭증 시 부하 분산, 응답 일관성 향상 실시간 처리 Unity, Unreal Frame Sync Frame Sync + Task System + Condition Variable 프레임률 안정성, 지연 최소화 네트워크 패킷 수신 처리 Socket Buffer + Condition Variable 데이터 도착 시 즉시 처리 미디어 처리 동영상 스트리밍 버퍼 Decoder/Renderer + Condition Variable 끊김 없는 재생, 버퍼 관리 최적화 장치 제어 프린터 스풀러 Job Queue + Condition Variable 인쇄 작업 흐름 제어, 자원 낭비 방지 파이프라인 파일 처리 파이프라인, 역압 구현 Stage Buffer + Condition Variable 생산·소비 균형, 메모리 사용 최적화 제어 로직 레이트 리밋 토큰 버킷 Token Bucket + Condition Variable 요청 처리 속도 제어, 서비스 안정성 조건 변수의 실제 도입 사례를 보면 **” 상태 변화 시점에만 스레드 활성화 “**라는 핵심 원리가 공통적으로 적용된다.\n이는 CPU 와 메모리 사용을 최소화하면서도 필요한 순간에 즉각적으로 반응할 수 있는 구조를 만든다.\n특히 생산자 - 소비자 패턴, 이벤트 기반 처리, 실시간 동기화 시나리오에 강력하며, 복잡한 동기화 로직을 단순화하는 장점이 있다.\n다만 잘못 사용하면 데드락, 스푸리어스 웨이크업, 신호 손실 등 문제가 발생할 수 있으므로 설계 원칙과 모니터링 체계를 반드시 병행해야 한다.\n실습 예제 및 코드 구현 사례: 고정 크기 바운디드 큐 기반 생산자 - 소비자 시나리오: 고정 크기 바운디드 큐 기반 생산자 - 소비자\n시스템 구성:\nProducer(s), Consumer(s), BoundedBuffer(상태 + 뮤텍스 +CV) graph TB P1[Producer] --\u003e B[\"BoundedBuffer (mutex+CV)\"] P2[Producer] --\u003e B B --\u003e C1[Consumer] B --\u003e C2[Consumer] Workflow:\n소비자: while empty: not_empty.wait() 생산자: while full: not_full.wait() 생산자 enqueue 후 not_empty.signal() 소비자 dequeue 후 not_full.signal() 핵심 역할:\n조건 변수: not_empty, not_full 뮤텍스: 버퍼 상태 보호 유무에 따른 차이점:\n도입 전: 폴링/슬립 루프, CPU 낭비 도입 후: 이벤트 기반 대기, 안정적 지연시간 구현 예시: Python (threading.Condition)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 import threading, time, random from collections import deque class BoundedBuffer: def __init__(self, capacity: int): self.capacity = capacity self.q = deque() self.lock = threading.Lock() self.not_empty = threading.Condition(self.lock) self.not_full = threading.Condition(self.lock) def put(self, item, timeout=None): with self.not_full: # while 재검사로 스푸리어스 웨이크업/레이스 방지 if not self.not_full.wait_for(lambda: len(self.q) \u003c self.capacity, timeout=timeout): raise TimeoutError(\"put timed out\") self.q.append(item) # 상태 변경 후 신호 self.not_empty.notify() def get(self, timeout=None): with self.not_empty: if not self.not_empty.wait_for(lambda: len(self.q) \u003e 0, timeout=timeout): raise TimeoutError(\"get timed out\") item = self.q.popleft() self.not_full.notify() return item def producer(buf: BoundedBuffer, pid: int): for i in range(20): item = (pid, i) buf.put(item, timeout=5) # 관측성: 간단한 로그 print(f\"[P{pid}] produced {item} (size={len(buf.q)})\") time.sleep(random.random() * 0.05) def consumer(buf: BoundedBuffer, cid: int): for _ in range(20): item = buf.get(timeout=5) print(f\"[C{cid}] consumed {item} (size={len(buf.q)})\") time.sleep(random.random() * 0.08) if __name__ == \"__main__\": buf = BoundedBuffer(capacity=10) threads = [threading.Thread(target=producer, args=(buf, p)) for p in range(2)] + \\ [threading.Thread(target=consumer, args=(buf, c)) for c in range(2)] for t in threads: t.start() for t in threads: t.join() 사례: 생산자 - 소비자 문제 해결 시나리오: 생산자 - 소비자 문제 해결\n시스템 구성:\n생산자 쓰레드: 데이터 생성 후 signal 소비자 쓰레드: 데이터 없으면 wait graph TB Producer --\u003e|signal| ConditionVariable Consumer --\u003e|wait| ConditionVariable ConditionVariable --\u003e SharedQueue Workflow:\n소비자: 큐 비어있으면 wait 생산자: 데이터 넣고 signal 소비자: 깨어나서 데이터 소비 구현 예시 (Python):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import threading import time from collections import deque queue = deque() condition = threading.Condition() def consumer(): while True: with condition: while not queue: condition.wait() # 조건이 만족될 때까지 대기 item = queue.popleft() print(f\"Consumed: {item}\") def producer(): for i in range(5): time.sleep(1) with condition: queue.append(i) print(f\"Produced: {i}\") condition.notify() threading.Thread(target=consumer, daemon=True).start() threading.Thread(target=producer).start() 사례: 멀티스레드 로그 수집 시스템 시나리오: 멀티스레드 로그 수집 시스템\n시스템 구성:\n여러 로그 생성 스레드 (Producer) 단일 로그 처리 스레드 (Consumer) 원형 버퍼 (Circular Buffer) 조건 변수 기반 동기화 graph TB subgraph \"Log Collection System\" LP1[Log Producer 1] LP2[Log Producer 2] LP3[Log Producer N] subgraph \"Synchronization\" CB[Circular Buffer] CV1[NotFull Condition] CV2[NotEmpty Condition] M[Mutex] end LC[Log Consumer] FS[File System] end LP1 --\u003e CB LP2 --\u003e CB LP3 --\u003e CB CB --\u003e LC LC --\u003e FS CV1 -.-\u003e LP1 CV1 -.-\u003e LP2 CV1 -.-\u003e LP3 CV2 -.-\u003e LC Workflow:\n각 로그 생성 스레드가 로그 메시지 생성 버퍼 가득 참 시 notFull 조건 변수에서 대기 로그 처리 스레드가 버퍼에서 메시지 추출 버퍼 비어있음 시 notEmpty 조건 변수에서 대기 처리된 로그를 파일 시스템에 기록 핵심 역할:\n조건 변수가 생산자 - 소비자 간 효율적 동기화 담당 버퍼 상태 변화 시 적절한 스레드만 선택적 깨우기 시스템 자원 사용량 최적화 유무에 따른 차이점:\n도입 전: 폴링 기반 상태 확인으로 CPU 낭비 발생 도입 후: 이벤트 기반 처리로 효율적 자원 활용 구현 예시 (Python):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 import threading import time import random from collections import deque from datetime import datetime class LogBuffer: \"\"\"조건 변수를 활용한 로그 버퍼\"\"\" def __init__(self, max_size=100): self.buffer = deque() self.max_size = max_size # 조건 변수들과 연관된 뮤텍스 self.mutex = threading.Lock() self.not_full = threading.Condition(self.mutex) self.not_empty = threading.Condition(self.mutex) self.running = True def produce_log(self, log_message): \"\"\"로그 메시지 생성 (Producer)\"\"\" with self.not_full: # 뮤텍스 자동 획득 # Mesa 스타일: while 루프로 조건 재검사 while len(self.buffer) \u003e= self.max_size and self.running: print(f\"Buffer full, producer waiting…\") self.not_full.wait() # 버퍼에 공간 생길 때까지 대기 if self.running: # 타임스탬프와 함께 로그 저장 timestamped_log = { 'timestamp': datetime.now(), 'message': log_message, 'thread_id': threading.get_ident() } self.buffer.append(timestamped_log) print(f\"Produced: {log_message}\") # 소비자에게 데이터 준비됨을 알림 self.not_empty.notify() def consume_log(self): \"\"\"로그 메시지 소비 (Consumer)\"\"\" with self.not_empty: # 버퍼가 비어있으면 대기 while len(self.buffer) == 0 and self.running: print(\"Buffer empty, consumer waiting…\") self.not_empty.wait() if self.running and self.buffer: log_entry = self.buffer.popleft() print(f\"Consumed: {log_entry['message']} \" f\"at {log_entry['timestamp']}\") # 생산자에게 공간 생겼음을 알림 self.not_full.notify() return log_entry return None def shutdown(self): \"\"\"시스템 종료\"\"\" with self.mutex: self.running = False # 모든 대기 중인 스레드 깨우기 self.not_full.notify_all() self.not_empty.notify_all() class LogProducer(threading.Thread): \"\"\"로그 생성 스레드\"\"\" def __init__(self, buffer, producer_id, log_count=10): super().__init__() self.buffer = buffer self.producer_id = producer_id self.log_count = log_count def run(self): for i in range(self.log_count): # 실제 로그 생성 시뮬레이션 log_message = f\"Producer-{self.producer_id} Log-{i}\" self.buffer.produce_log(log_message) # 가변적인 로그 생성 간격 time.sleep(random.uniform(0.1, 0.5)) print(f\"Producer-{self.producer_id} finished\") class LogConsumer(threading.Thread): \"\"\"로그 처리 스레드\"\"\" def __init__(self, buffer, output_file=\"logs.txt\"): super().__init__() self.buffer = buffer self.output_file = output_file self.processed_count = 0 def run(self): with open(self.output_file, 'w') as f: while self.buffer.running or len(self.buffer.buffer) \u003e 0: log_entry = self.buffer.consume_log() if log_entry: # 파일에 로그 기록 f.write(f\"{log_entry['timestamp']}: \" f\"{log_entry['message']}\\n\") f.flush() # 즉시 디스크에 쓰기 self.processed_count += 1 # 처리 시간 시뮬레이션 time.sleep(random.uniform(0.05, 0.2)) print(f\"Consumer processed {self.processed_count} logs\") # 시스템 실행 예제 def main(): \"\"\"로그 수집 시스템 메인\"\"\" # 공유 버퍼 생성 log_buffer = LogBuffer(max_size=10) # 여러 생산자 스레드 생성 producers = [] for i in range(3): producer = LogProducer(log_buffer, i, log_count=5) producers.append(producer) # 단일 소비자 스레드 생성 consumer = LogConsumer(log_buffer) print(\"Starting log collection system…\") # 모든 스레드 시작 consumer.start() for producer in producers: producer.start() # 모든 생산자 완료까지 대기 for producer in producers: producer.join() print(\"All producers finished, shutting down…\") # 버퍼 정리 후 소비자 종료 time.sleep(1) # 마지막 로그 처리 시간 확보 log_buffer.shutdown() consumer.join() print(\"Log collection system shutdown complete\") if __name__ == \"__main__\": main() 핵심 학습 포인트:\nMesa 스타일 구현: while 루프를 통한 조건 재검사 효율적 자원 관리: 바쁜 대기 없는 블로킹 우아한 종료: 시스템 종료 시 모든 대기 스레드 해제 실제 성능 측정: 처리량과 지연 시간 모니터링#### 실제 도입 사례의 코드 구현 사례: 웹 서버의 로그 처리 시스템 시나리오: 웹 서버의 로그 처리 시스템에서 로그 수집 스레드와 로그 저장 스레드의 동기화\n시스템 구성:\n로그 수집기 (Log Collector) 로그 처리기 (Log Processor) 시스템 구성 다이어그램:\ngraph TB Collector[Log Collector] --\u003e |notify| ConditionVariable ConditionVariable --\u003e |wait| Processor[Log Processor] Workflow:\nCollector 가 로그 메시지를 큐에 담음 Condition Variable 로 Processor 에 신호 Processor 는 신호를 받고 로그를 처리 유무 비교:\n도입 전: Processor 가 계속 큐를 폴링 (polling) → CPU 낭비 도입 후: Processor 는 효율적으로 대기, Collector 신호 시 즉시 처리 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import threading import time import queue log_queue = queue.Queue() condition = threading.Condition() def log_collector(): for i in range(3): with condition: log_queue.put(f\"log message {i}\") print(\"[Collector] 로그 추가\") condition.notify() time.sleep(1) def log_processor(): while True: with condition: while log_queue.empty(): condition.wait() log = log_queue.get() print(f\"[Processor] 로그 처리: {log}\") threading.Thread(target=log_processor, daemon=True).start() threading.Thread(target=log_collector).start() 사례: DB 커넥션 풀 (Connection Pool) 시나리오: DB 커넥션 풀 (Connection Pool)\n애플리케이션 스레드가 커넥션을 요청하고, 풀이 가득 차면 조건 변수로 대기. 커넥션 반환 시 signal로 대기자 깨움. 타임아웃/취소/헬스체크/관측성 포함. 시스템 구성:\nPoolState: 현재 커넥션 수, 대기열, 최소/최대 설정 Mutex + Condition: not_full, not_empty HealthChecker: 비정상 커넥션 제거 및 보충 Metrics: 대기 시간, 풀 사용률, 타임아웃 수 graph TB A[App Threads] --\u003e|acquire| P[\"Connection Pool (mutex + CV)\"] P --\u003e|hand out| A A --\u003e|release| P HC[HealthChecker] --\u003e|evict/create| P P --\u003e M[Metrics/Logs] Workflow:\nacquire(timeout): while size==max and idle==0: not_full.wait(timeout) 성공 시 idle→active 이동, 타임아웃 시 예외 release(conn): active→idle 이동, not_empty.signal() 또는 not_full.signal() HealthChecker: 주기적 검증/보충, broadcast 최소화 (필요 시에만) 핵심 역할:\n조건 변수: 풀 포화/가용성 변곡점에서 정확한 깨우기 뮤텍스: 풀 상태 불변식 유지 (0 ≤ idle ≤ max, active+idle=size) 유무에 따른 차이점:\n도입 전: 폴링/슬립으로 커넥션 회전율 저하, p99 지연 증가 도입 후: 이벤트 기반 대기, 안정적 처리량과 예측 가능한 지연 구현 예시: Python, threading.Condition + Prometheus 지표\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 # pip install prometheus-client import threading, time, queue, contextlib, random from prometheus_client import Counter, Histogram, Gauge, start_http_server REQS_WAIT = Histogram(\"pool_wait_seconds\", \"Time waiting for a connection\") REQS_TIMEOUT = Counter(\"pool_acquire_timeout_total\", \"Acquire timeouts\") POOL_ACTIVE = Gauge(\"pool_active_connections\", \"Active connections\") POOL_IDLE = Gauge(\"pool_idle_connections\", \"Idle connections\") class Connection: def __init__(self, id): self.id = id def healthy(self): return True def close(self): pass class ConnectionPool: def __init__(self, min_size=2, max_size=10, check_interval=5.0): self.min = min_size; self.max = max_size self.idle = queue.deque() self.active = set() self.size = 0 self.mu = threading.Lock() self.not_empty = threading.Condition(self.mu) # idle\u003e0 self.not_full = threading.Condition(self.mu) # size","wordCount":"14318","inLanguage":"en","image":"https://buenhyden.github.io/images","datePublished":"2024-10-04T10:54:00Z","dateModified":"2024-10-04T10:54:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/condition-synchronization/implementation-mechanisms/condition-variable/"},"publisher":{"@type":"Organization","name":"hyunyoun's Blog","logo":{"@type":"ImageObject","url":"https://buenhyden.github.io/favicons/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a></div><h1 class="post-title entry-hint-parent">조건 변수 (Condition Variable)</h1><div class=post-description>조건 변수(Condition Variable)는 멀티스레드 환경에서 특정 조건이 충족될 때까지 스레드를 효율적으로 대기시키고, 조건 변화 시 신호를 보내 실행을 재개하는 동기화 기법이다. 반드시 뮤텍스와 함께 사용하며, 스푸리어스 웨이크업에 대비해 while 루프 조건 재검사가 필수이다. 생산자-소비자 등 다양한 패턴에서 활용된다.</div><div class=post-meta><span title='2024-10-04 10:54:00 +0000 UTC'>October 4, 2024</span>&nbsp;·&nbsp;68 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/buenhyden/blog-data/main/content/posts/Computer%20Science%20Fundamentals/Concurrency%20and%20Parallelism/Condition%20Synchronization/Implementation%20Mechanisms/Condition-Variable.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#조건-변수-condition-variable>조건 변수 (Condition Variable)</a><ul><li><a href=#핵심-개념>핵심 개념</a></li><li><a href=#기초-이해-foundation-understanding>기초 이해 (Foundation Understanding)</a></li><li><a href=#핵심-이론-core-theory>핵심 이론 (Core Theory)</a></li><li><a href=#특성-분석-characteristics-analysis>특성 분석 (Characteristics Analysis)</a></li><li><a href=#구현-및-분류-implementation--classification>구현 및 분류 (Implementation & Classification)</a></li><li><a href=#실무-적용-practical-application>실무 적용 (Practical Application)</a></li><li><a href=#운영-및-최적화-operations--optimization>운영 및 최적화 (Operations & Optimization)</a></li><li><a href=#고급-주제-advanced-topics>고급 주제 (Advanced Topics)</a></li></ul></li><li><a href=#정리-및-학습-가이드>정리 및 학습 가이드</a><ul><li><a href=#내용-정리>내용 정리</a></li><li><a href=#학습-로드맵>학습 로드맵</a></li><li><a href=#학습-항목-매트릭스>학습 항목 매트릭스</a></li></ul></li><li><a href=#용어-정리>용어 정리</a></li><li><a href=#참고-및-출처><strong>참고 및 출처</strong></a><ul><li><a href=#공식-문서-및-표준><strong>공식 문서 및 표준</strong></a></li><li><a href=#학술-논문-및-역사적-자료><strong>학술 논문 및 역사적 자료</strong></a></li><li><a href=#교육-자료-및-강의><strong>교육 자료 및 강의</strong></a></li><li><a href=#기술-블로그-및-실무-사례><strong>기술 블로그 및 실무 사례</strong></a></li><li><a href=#오픈소스-구현체><strong>오픈소스 구현체</strong></a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=조건-변수-condition-variable>조건 변수 (Condition Variable)<a hidden class=anchor aria-hidden=true href=#조건-변수-condition-variable>#</a></h2><p>조건 변수 (Condition Variable) 는 멀티스레드 환경에서 스레드가 특정 조건이 충족될 때까지 <strong>Busy-wait 없이 대기</strong>하도록 하는 동기화 메커니즘이다.<br>반드시 <strong>뮤텍스와 함께</strong> 사용하여 조건 검사·변경의 원자성을 보장하며, 주요 연산은 <code>wait()</code>(대기), <code>signal()</code>/<code>notify_one()</code>(하나 깨움), <code>broadcast()</code>/<code>notify_all()</code>(모두 깨움) 이다.<br>대부분 <strong>Mesa-style</strong> 구현을 따르므로 깨어난 뒤 조건을 <strong>while 루프</strong>로 재검사해야 하며, <strong>유령 깨움</strong>과 <strong>신호 손실</strong> 방지를 위해 상태 변경 후 락을 잡은 채 신호를 보내야 한다.<br><strong>생산자 - 소비자, 이벤트 처리, 흐름 제어</strong> 등에서 필수적으로 활용되며, POSIX, C++, Java, Go 등 다양한 플랫폼에서 지원된다.</p><h3 id=핵심-개념>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념>#</a></h3><table><thead><tr><th>관점</th><th>핵심 개념</th><th>설명</th></tr></thead><tbody><tr><td><strong>이론</strong></td><td>조건 변수 정의</td><td>조건 충족 전까지 스레드 블로킹, 충족 시 신호로 재개</td></tr><tr><td><strong>이론</strong></td><td>Mesa vs Hoare 시맨틱</td><td>Mesa: 깨운 직후 조건 변경 가능, 재검사 필요 / Hoare: 즉시 실행 보장</td></tr><tr><td><strong>기본</strong></td><td>뮤텍스 결합</td><td>상태 변경·검사 원자성 보장을 위해 필수</td></tr><tr><td><strong>기본</strong></td><td>Signal vs Broadcast</td><td>단일·전체 스레드 깨움 선택, 성능 영향</td></tr><tr><td><strong>심화</strong></td><td>스퓨리어스 웨이크업</td><td>이유 없는 깨어남, <code>while</code> 로 재검사 필요</td></tr><tr><td><strong>심화</strong></td><td>Lost Wakeup</td><td>대기 등록 전 신호 소실 문제, 설계로 방지</td></tr><tr><td><strong>심화</strong></td><td>다중 조건 변수 설계</td><td>상태별 분리로 불필요한 깨움 방지</td></tr><tr><td><strong>심화</strong></td><td>모니터 패턴</td><td>상태 + 뮤텍스 +CV 캡슐화로 동기화 추상화</td></tr><tr><td><strong>심화</strong></td><td>우선순위 역전 고려</td><td>스케줄링·락 정책으로 문제 회피</td></tr></tbody></table><h4 id=실무-구현-연관성-및-적용-방식>실무 구현 연관성 및 적용 방식<a hidden class=anchor aria-hidden=true href=#실무-구현-연관성-및-적용-방식>#</a></h4><table><thead><tr><th>핵심 개념</th><th>실무 적용</th><th>구현 방식 예시</th></tr></thead><tbody><tr><td>조건 변수 정의</td><td>생산자 - 소비자 큐</td><td>큐가 비어있으면 소비자 대기, 데이터 도착 시 깨움</td></tr><tr><td>뮤텍스 결합</td><td>DB 커넥션 풀</td><td>커넥션 획득·반납 시 락과 조건 변수 동시 사용</td></tr><tr><td>Mesa vs Hoare</td><td>스케줄러</td><td>슬롯 제공 시 깬 후 조건 재검사</td></tr><tr><td>Signal vs Broadcast</td><td>워커 풀</td><td>단일 작업 완료 시 하나만 깨움, 전체 리셋 시 broadcast</td></tr><tr><td>스퓨리어스 웨이크업</td><td>네트워크 이벤트 대기</td><td><code>while (!ready) wait()</code> 구조</td></tr><tr><td>Lost Wakeup</td><td>실시간 알림</td><td>wait 등록 전 신호 방지를 위해 락 내에서 조건 검사 + 대기 등록</td></tr><tr><td>다중 조건 변수 설계</td><td>Thread Pool 상태 관리</td><td>idle/active 상태별 CV 분리</td></tr><tr><td>모니터 패턴</td><td>동시성 안전 객체 설계</td><td>클래스 내부에 상태 + 락 +CV 포함</td></tr><tr><td>우선순위 역전 고려</td><td>RTOS 제어 스레드</td><td>우선순위 상속 기능이 있는 뮤텍스 사용</td></tr></tbody></table><p>조건 변수는 멀티스레드 환경에서 <strong>조건 기반의 효율적 동기화</strong>를 가능하게 하는 핵심 메커니즘이다.<br>뮤텍스와 결합하여 상태 검사와 변경의 원자성을 보장하며, 스퓨리어스 웨이크업·Lost Wakeup 방지를 위해 반드시 <code>while</code> 재검사를 수행해야 한다.<br>Mesa 시맨틱이 일반적이므로 깨운 직후 조건이 변할 수 있으며, Signal/Broadcast 의 선택은 성능과 효율에 큰 영향을 미친다.<br>실무에서는 생산자 - 소비자 패턴, 리소스 풀 관리, 이벤트 대기, 스케줄러, 분산 러너 동기화 등 다양한 시나리오에서 사용되며, 상태별 다중 조건 변수 설계나 모니터 패턴 적용으로 성능·확장성을 극대화할 수 있다.</p><h3 id=기초-이해-foundation-understanding>기초 이해 (Foundation Understanding)<a hidden class=anchor aria-hidden=true href=#기초-이해-foundation-understanding>#</a></h3><h4 id=개념-정의-및-본질>개념 정의 및 본질<a hidden class=anchor aria-hidden=true href=#개념-정의-및-본질>#</a></h4><p>**조건 변수 (Condition Variable)**는 <strong>공유 상태의 불리언 프레디킷</strong>이 참이 될 때까지 스레드를 <strong>효율적으로 블로킹</strong>했다가, 상태 변화 시 **신호 (signal)**로 스레드를 깨우는 <strong>동기화 프리미티브</strong>다.<br>사용 시에는 <strong>뮤텍스와 결합</strong>하여 프레디킷 검사·상태 변경의 <strong>원자성</strong>을 보장하고, <code>wait</code> 호출은 <strong>뮤텍스를 원자적으로 풀고 (unlock) 잠들었다가 (sleep) 깨어나면 다시 잠그는 (relock)</strong> 전이를 보장한다. 또한 <strong>스퓨리어스 웨이크업</strong>과 <strong>메사 시맨틱</strong>으로 인해, 깨어난 뒤 <strong>반드시 while 루프로 프레디킷을 재검사</strong>하는 것이 표준 실무 패턴이다.</p><h4 id=등장-배경-및-발전-과정>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정>#</a></h4><h5 id=등장-배경><strong>등장 배경</strong><a hidden class=anchor aria-hidden=true href=#등장-배경>#</a></h5><p>멀티스레드 환경에서 특정 조건이 만족될 때까지 스레드가 기다려야 하는 상황이 많았으나, 기존의 polling 이나 busy-wait 방식은 CPU 를 지속적으로 점유해 비효율적이었다. 이를 해결하기 위해 커널 또는 언어 차원에서 <strong>조건이 충족될 때만 스레드를 깨우는</strong> 메커니즘이 필요했고, Hoare 와 Brinch Hansen 이 개발한 <strong>모니터 (Monitor)</strong> 개념이 이론적 토대가 되었다. 이후 POSIX, Java, C++, Go, Rust 등에서 조건 변수가 표준 라이브러리로 채택되어 효율적이고 안전한 조건 대기를 제공하게 되었다.</p><h5 id=발전-과정>발전 과정<a hidden class=anchor aria-hidden=true href=#발전-과정>#</a></h5><table><thead><tr><th>시기</th><th>주요 사건</th><th>설명</th></tr></thead><tbody><tr><td>1965</td><td>Dijkstra 의 세마포어</td><td>동기화의 기초 개념 제공</td></tr><tr><td>1970~1974</td><td>Hoare, Brinch Hansen 의 모니터 개념</td><td>조건 변수 개념 포함, 프로세스 재개 규칙 확립</td></tr><tr><td>1980s</td><td>Mesa semantics 정립</td><td>조건 변수 + while 재검사 패턴 확립</td></tr><tr><td>1980s 후반</td><td>UNIX System V, BSD</td><td>초기 조건 변수 구현</td></tr><tr><td>1990s</td><td>POSIX <code>pthread_cond</code>, Win32 API</td><td>표준화 및 OS 레벨 지원</td></tr><tr><td>1995~2000s</td><td>Java <code>wait/notify</code>,.NET Monitor</td><td>언어 차원 지원 확산</td></tr><tr><td>2000s</td><td>Futex(Linux), 타임아웃 기능</td><td>성능 및 기능 개선</td></tr><tr><td>2010s</td><td>C++11 <code>std::condition_variable</code>, Go/Rust 지원</td><td>현대 언어 표준화</td></tr><tr><td>현재</td><td>Async Condition, Cloud Native 환경 확장</td><td>비동기·분산·실시간 환경 적용</td></tr></tbody></table><pre class=mermaid>timeline
  title 조건 변수 발전 과정
  1965 : Dijkstra - 세마포어 개념
  1974 : Hoare &amp; Brinch Hansen - 모니터와 조건 변수
  1980s : Mesa semantics 확립 (while 재검사 패턴)
  1988 : UNIX System V / BSD - 조건 변수 초기 구현
  1990s : POSIX pthread_cond, Win32 동기화 API 표준화
  1995-2000s : Java wait/notify, .NET Monitor (언어 차원 지원)
  2000s : Linux futex, timed wait 등 기능 개선
  2011 : C++11 condition variable 표준화
  2014-2018 : Go sync.Cond, Rust Condvar 도입
  2020s : Async condition, Cloud-native / RTOS 확장
</pre><h4 id=핵심-동기-및-가치-제안>핵심 동기 및 가치 제안<a hidden class=anchor aria-hidden=true href=#핵심-동기-및-가치-제안>#</a></h4><p>조건 변수 (Condition Variable) 의 도입 목적은</p><ul><li><strong>폴링 (polling) 으로 인한 CPU 낭비를 제거</strong>하고,</li><li>조건 충족 전까지 스레드를 <strong>효율적으로 대기 상태</strong>로 두며,</li><li>조건 변화 시 <strong>즉시 신호를 통해 재개</strong>함으로써 응답성을 높이는 것이다.</li></ul><p>뮤텍스와 결합해 <strong>상태 기반 협력 실행</strong>을 가능하게 하고, 복잡한 동기화 시나리오를 단순화하며, 공정성과 안전성을 보장한다.</p><p>이는 멀티코어·실시간·모바일·분산 환경 모두에서 <strong>성능 최적화·전력 절감·확장성</strong>을 제공하는 핵심 동기화 메커니즘이다.</p><table><thead><tr><th>구분</th><th>내용</th></tr></thead><tbody><tr><td><strong>배경 문제</strong></td><td>폴링·바쁜 대기로 인한 CPU 낭비, 락만으로 해결 불가한 조건 기반 대기</td></tr><tr><td><strong>핵심 동기</strong></td><td>조건 충족 시까지 효율적 대기, 이벤트 기반 신호 처리, 공정한 스레드 협력</td></tr><tr><td><strong>가치 제안</strong></td><td>CPU 자원 절약, 응답성 향상, 복잡한 동기화 로직 단순화, 유지보수성 확보</td></tr><tr><td><strong>부가 효과</strong></td><td>실시간 성능 확보, 전력 효율성, 멀티코어·분산 환경에서의 확장성, 안전성</td></tr><tr><td><strong>적용 사례</strong></td><td>생산자–소비자, 송신자–수신자, Barrier, 이벤트 기반 비동기 처리</td></tr></tbody></table><p>조건 변수의 핵심 가치는 <strong>자원 효율성·응답성·확장성·안전성</strong>에 있다.<br>이는 CPU 낭비를 줄이고, 상태 변화 시 즉시 스레드를 깨우며, 복잡한 병행 로직을 단순화해 다양한 환경에서 안정적인 동기화를 구현한다.</p><h4 id=주요-특징>주요 특징<a hidden class=anchor aria-hidden=true href=#주요-특징>#</a></h4><table><thead><tr><th>특징</th><th>설명</th><th>기술적 근거/도출 원리</th></tr></thead><tbody><tr><td><strong>뮤텍스 결합 필수</strong></td><td>상태 검사와 변경을 원자적으로 수행하기 위해 조건 변수는 반드시 하나의 뮤텍스와 연동</td><td>공유 데이터 일관성 보장, 경쟁 조건 방지</td></tr><tr><td><strong>원자적 대기 전환</strong></td><td><code>wait()</code> 호출 시 뮤텍스 해제와 대기 상태 진입이 원자적으로 이루어짐</td><td>조건 검사~대기 사이의 레이스 컨디션 제거</td></tr><tr><td><strong>선택적 깨우기</strong></td><td><code>signal()</code> 은 하나, <code>broadcast()</code> 는 모든 대기 스레드 깨움</td><td>불필요한 컨텍스트 스위칭 감소, 효율 향상</td></tr><tr><td><strong>Predicate 재검사</strong></td><td>Spurious Wakeup 가능성 때문에 깨어난 뒤 조건을 다시 확인</td><td>하드웨어/OS 최적화에 따른 의도적 설계</td></tr><tr><td><strong>타임아웃 대기 지원</strong></td><td>일정 시간 후 자동 해제되는 대기 가능</td><td>무한 대기 방지, 시스템 응답성 향상</td></tr><tr><td><strong>멀티채널 조건 처리</strong></td><td>하나의 락에 여러 조건 변수를 연결해 다른 이벤트를 분리 관리</td><td>복잡한 동기화 시나리오 처리 가능</td></tr><tr><td><strong>메모리 가시성 보장</strong></td><td>대기·신호 시 암묵적 메모리 배리어 적용</td><td>최신 데이터 기반의 동기화 보장</td></tr><tr><td><strong>Lost Wakeup 방지 규칙</strong></td><td>상태 변경 후, 락을 잡은 채 신호 호출</td><td>조건 미충족 시 신호 손실 방지</td></tr></tbody></table><p>조건 변수는 멀티스레드 환경에서 안전하고 효율적인 조건 대기를 구현하는 핵심 도구다.<br>뮤텍스와 결합해 상태 검사·변경을 원자적으로 수행하며, Spurious Wakeup 과 Lost Wakeup 을 방지하기 위해 <strong>조건 재검사와 올바른 신호 시점</strong>이 필수다.<br>선택적 깨우기, 타임아웃, 멀티채널 조건 처리 등은 성능과 유연성을 높이며, 메모리 가시성 보장은 최신 상태를 기반으로 한 동기화를 가능하게 한다.</p><h3 id=핵심-이론-core-theory>핵심 이론 (Core Theory)<a hidden class=anchor aria-hidden=true href=#핵심-이론-core-theory>#</a></h3><h4 id=핵심-설계-원칙>핵심 설계 원칙<a hidden class=anchor aria-hidden=true href=#핵심-설계-원칙>#</a></h4><table><thead><tr><th>원칙</th><th>설명</th><th>기술적 근거</th></tr></thead><tbody><tr><td><strong>뮤텍스 결합</strong></td><td>조건 변수는 반드시 하나의 뮤텍스와 연동, 조건 검사·변경은 락 안에서 수행</td><td>공유 상태 일관성, 경쟁 조건 방지</td></tr><tr><td><strong>상태 변경 후 신호</strong></td><td>상태를 변경한 뒤 <code>signal()</code> 또는 <code>broadcast()</code> 호출</td><td>Lost Wakeup 방지</td></tr><tr><td><strong>조건 재검사</strong></td><td>깨어난 후 <code>while</code> 루프로 조건을 다시 확인</td><td>Spurious Wakeup 방지</td></tr><tr><td><strong>원자적 대기 전환</strong></td><td><code>wait()</code> 호출 시 뮤텍스 해제와 대기 상태 진입이 원자적으로 수행</td><td>경쟁 조건 제거</td></tr><tr><td><strong>Mesa 시맨틱스</strong></td><td>신호 후 즉시 제어권을 주지 않으며, 깨어난 스레드는 조건 재검사</td><td>단순 구현, 예측 가능</td></tr><tr><td><strong>타임아웃·취소 지원</strong></td><td>일정 시간 또는 조건 시 대기 해제</td><td>무한 대기 방지, 응답성 향상</td></tr><tr><td><strong>공정성 고려</strong></td><td>FIFO 등 기아 방지 메커니즘 적용 가능</td><td>스레드 스케줄링 형평성 확보</td></tr><tr><td><strong>멀티채널 조건 관리</strong></td><td>하나의 뮤텍스에 여러 조건 변수를 연결</td><td>복잡한 이벤트 동기화 가능</td></tr><tr><td><strong>신호 최소화</strong></td><td>불필요한 <code>broadcast()</code> 대신 대상 스레드만 신호</td><td>컨텍스트 스위칭 감소</td></tr><tr><td><strong>메모리 가시성 보장</strong></td><td>조건 변수 연산 시 메모리 배리어 적용</td><td>최신 상태 기반 동기화</td></tr></tbody></table><p>조건 변수의 핵심 설계 원칙은 <strong>뮤텍스와 결합한 원자적 상태 관리</strong>와 <strong>조건 재검사</strong>가 중심이다.<br>모든 조건 검사·변경은 락 안에서 수행하며, 상태 변경 후에만 신호를 보내야 Lost Wakeup 을 방지할 수 있다.<br>Mesa 시맨틱스 하에서 깨어난 스레드는 반드시 재검사하고, 필요 시 타임아웃·취소로 무한 대기를 막는다.<br>공정성, 멀티채널 관리, 신호 최소화, 메모리 가시성 보장은 성능과 안정성을 동시에 확보하는 데 필수적인 설계 요소다.</p><h5 id=잘못된-사용-예--올바른-사용-예-비교할-수-있는-실무-가이드>잘못된 사용 예 → 올바른 사용 예 비교할 수 있는 실무 가이드<a hidden class=anchor aria-hidden=true href=#잘못된-사용-예--올바른-사용-예-비교할-수-있는-실무-가이드>#</a></h5><p>예시는 <strong>Python (<code>threading.Condition</code>)</strong> 기준</p><h6 id=뮤텍스-결합-조건-검사는-락-안에서만>뮤텍스 결합: 조건 검사는 락 안에서만<a hidden class=anchor aria-hidden=true href=#뮤텍스-결합-조건-검사는-락-안에서만>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 락 없이 조건 검사 → 경쟁 상태 유발</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>threading</span> <span class=kn>import</span> <span class=n>Condition</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cv</span> <span class=o>=</span> <span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 락 없이 검사해서, 신호 손실/경쟁 상태 가능</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># RuntimeError (락 없이 wait), 또는 논리적 버그</span>
</span></span><span class=line><span class=cl>    <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 조건 검사와 wait는 반드시 락 범위 내에서 수행</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>threading</span> <span class=kn>import</span> <span class=n>Condition</span><span class=p>,</span> <span class=n>Lock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cv</span> <span class=o>=</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>cv</span><span class=p>:</span>  <span class=c1># cv가 내부적으로 lock을 사용</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>         <span class=c1># 반드시 while로 재검사</span>
</span></span><span class=line><span class=cl>            <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>            <span class=c1># wait()는 락 해제→수면→재획득을 원자적으로 수행</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>      <span class=c1># 임계구역 안에서 안전하게 소비</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=상태-먼저-신호는-나중-lost-wakeup-방지>상태 먼저, 신호는 나중 (Lost Wakeup 방지)<a hidden class=anchor aria-hidden=true href=#상태-먼저-신호는-나중-lost-wakeup-방지>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 신호를 먼저 보내면, 아직 대기하지 않은 스레드가 신호를 놓침</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>       <span class=c1># 신호 먼저</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>   <span class=c1># 상태 나중 → 대기 스레드는 영원히 못 깨어날 수 있음</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 공유 상태 변경 후 신호</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>   <span class=c1># 상태 변경</span>
</span></span><span class=line><span class=cl>    <span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>       <span class=c1># 그 다음 신호 → 대기자에게 조건이 보장됨</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=while-재검사-spurious-wakeup--mesa-의미론-대응>While 재검사 (Spurious Wakeup & Mesa 의미론 대응)<a hidden class=anchor aria-hidden=true href=#while-재검사-spurious-wakeup--mesa-의미론-대응>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ if 한 번만 검사 → 깨어난 뒤 조건이 여전히 거짓이어도 진행함</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># 비어있을 수 있음 (경쟁/가짜 깨움/다른 소비자 선점)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2>2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3>3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4>4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ while 재검사: 깨어난 뒤에도 반드시 조건 확인</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=notify-vs-notify_all-정확히-필요한-만큼만-깨우기>Notify Vs notify_all: 정확히 필요한 만큼만 깨우기<a hidden class=anchor aria-hidden=true href=#notify-vs-notify_all-정확히-필요한-만큼만-깨우기>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 항상 broadcast → Thundering Herd(군집 깨어남) 유발, 경합 증가</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>produced</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>  <span class=c1># 1개만 소비 가능해도…</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>produced</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cv</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>       <span class=c1># 불필요하게 모두 깨움</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 조건을 만족하는 예상 소비자 수만큼 notify</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>produced</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>produced</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>produced</span><span class=p>)):</span>  <span class=c1># 실제로 소비 가능한 개수만큼</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>                  <span class=c1># 필요한 만큼만 깨움 → 경합/컨텍스트 스위칭 절감</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=타임아웃캔슬-고립-방지와-빠른-복귀>타임아웃/캔슬: 고립 방지와 빠른 복귀<a hidden class=anchor aria-hidden=true href=#타임아웃캔슬-고립-방지와-빠른-복귀>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 무한 대기: 신호가 영영 오지 않으면 스레드가 고립</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># 타임아웃 없음</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>: (타임아웃)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 타임아웃으로 고립 방지</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>monotonic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>deadline</span> <span class=o>=</span> <span class=n>monotonic</span><span class=p>()</span> <span class=o>+</span> <span class=mf>2.0</span>  <span class=c1># 2초 내 대기</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>remaining</span> <span class=o>=</span> <span class=n>deadline</span> <span class=o>-</span> <span class=n>monotonic</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>remaining</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>                  <span class=c1># 타임아웃 경로로 빠져나옴</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=n>remaining</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 타임아웃 대응 로직 (재시도/로그/폴백 등)</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>: (캔슬 신호)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 외부 취소 이벤트로 빠른 복귀</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>threading</span> <span class=kn>import</span> <span class=n>Event</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cancel</span> <span class=o>=</span> <span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>cancel</span><span class=o>.</span><span class=n>is_set</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 짧게 깨어나 cancel 확인</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cancel</span><span class=o>.</span><span class=n>is_set</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>  <span class=c1># 정중한 종료</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=단일-소유-원칙-하나의-뮤텍스로-한-공유-상태-보호>단일 소유 원칙: 하나의 뮤텍스로 한 공유 상태 보호<a hidden class=anchor aria-hidden=true href=#단일-소유-원칙-하나의-뮤텍스로-한-공유-상태-보호>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 동일한 공유 상태를 두 개의 락으로 보호 → 순서 꼬임/데드락/레이스</span>
</span></span><span class=line><span class=cl><span class=n>lock1</span><span class=p>,</span> <span class=n>lock2</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>(),</span> <span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cv1</span><span class=p>,</span> <span class=n>cv2</span> <span class=o>=</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock1</span><span class=p>),</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># queue를 lock1/lock2로 번갈아 보호… (금기)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 공유 상태(queue)는 하나의 락과 대응되는 하나의 Condition 세트로 일관되게 보호</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cv</span> <span class=o>=</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=멀티채널-조건-다른-이벤트는-다른-cv-로-분리>멀티채널 조건: 다른 이벤트는 다른 CV 로 분리<a hidden class=anchor aria-hidden=true href=#멀티채널-조건-다른-이벤트는-다른-cv-로-분리>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 하나의 CV로 “비어있지 않음”과 “가득 참”을 모두 표기 → 신호 충돌/오해</span>
</span></span><span class=line><span class=cl><span class=n>cv</span> <span class=o>=</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>not_empty</span> <span class=o>=</span> <span class=n>not_full</span> <span class=o>=</span> <span class=n>cv</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a class=lnlinks href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a class=lnlinks href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a class=lnlinks href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a class=lnlinks href=#hl-15-15>15</a>
</span><span class=lnt id=hl-15-16><a class=lnlinks href=#hl-15-16>16</a>
</span><span class=lnt id=hl-15-17><a class=lnlinks href=#hl-15-17>17</a>
</span><span class=lnt id=hl-15-18><a class=lnlinks href=#hl-15-18>18</a>
</span><span class=lnt id=hl-15-19><a class=lnlinks href=#hl-15-19>19</a>
</span><span class=lnt id=hl-15-20><a class=lnlinks href=#hl-15-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 의미가 다른 조건은 조건 변수도 분리</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>not_empty</span> <span class=o>=</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span>  <span class=c1># 소비자 대기</span>
</span></span><span class=line><span class=cl><span class=n>not_full</span>  <span class=o>=</span> <span class=n>Condition</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span>  <span class=c1># 생산자 대기</span>
</span></span><span class=line><span class=cl><span class=n>capacity</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>not_full</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>queue</span><span class=p>)</span> <span class=o>==</span> <span class=n>capacity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>not_full</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>not_empty</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>  <span class=c1># 소비자를 정확히 깨움</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>not_empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>not_empty</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>not_full</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>   <span class=c1># 생산자를 정확히 깨움</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=공정성기아-방지-깨어난-뒤에도-조건-재검사--순차-신호>공정성/기아 방지: 깨어난 뒤에도 조건 재검사 + 순차 신호<a hidden class=anchor aria-hidden=true href=#공정성기아-방지-깨어난-뒤에도-조건-재검사--순차-신호>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 특정 스레드만 반복적으로 유리 → 기아 상태</span>
</span></span><span class=line><span class=cl><span class=c1># 무분별한 notify_one()과 편향된 조건 갱신</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 조건 재검사 + 균형 잡힌 신호 정책</span>
</span></span><span class=line><span class=cl><span class=c1># - 깨어난 스레드는 while 재검사</span>
</span></span><span class=line><span class=cl><span class=c1># - 생산/소비 시 각각 반대쪽 조건에 공정하게 notify</span>
</span></span><span class=line><span class=cl><span class=c1># - 필요 시 주기적으로 notify_all()로 막힌 큐 해소</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=성능-팁-임계-구역-최소화-락-홀딩-시간-단축>성능 팁: 임계 구역 최소화 (락 홀딩 시간 단축)<a hidden class=anchor aria-hidden=true href=#성능-팁-임계-구역-최소화-락-홀딩-시간-단축>#</a></h6><p><strong>잘못된 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 임계 구역에서 무거운 연산/IO 수행</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>do_heavy_io</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>  <span class=c1># 락 잡은 상태로 오래 실행 → 경합 급증</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>올바른 예</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4>4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5>5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6>6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 데이터만 안전하게 꺼낸 뒤, 락 밖에서 무거운 작업 수행</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>do_heavy_io</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>  <span class=c1># 락 해제 후 실행 → 대기 시간/경합 감소</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=테스트-포인트-부하경합타임아웃을-항상-검증>테스트 포인트: 부하·경합·타임아웃을 항상 검증<a hidden class=anchor aria-hidden=true href=#테스트-포인트-부하경합타임아웃을-항상-검증>#</a></h6><ul><li><strong>부하 테스트</strong>: 생산/소비 비율을 바꿔가며 대기 시간과 처리량 측정</li><li><strong>경합 테스트</strong>: 스레드 수를 늘려 락 경합률, 컨텍스트 스위칭 지표 확인</li><li><strong>타임아웃/캔슬 테스트</strong>: 신호가 오지 않는 조건을 인위적으로 만들어 복귀 경로/리소스 해제를 점검</li></ul><h4 id=기본-원리-및-동작-메커니즘>기본 원리 및 동작 메커니즘<a hidden class=anchor aria-hidden=true href=#기본-원리-및-동작-메커니즘>#</a></h4><h5 id=기본-원리>기본 원리<a hidden class=anchor aria-hidden=true href=#기본-원리>#</a></h5><table><thead><tr><th>항목</th><th>핵심 개념</th><th>핵심 포인트</th></tr></thead><tbody><tr><td>Predicate(조건)</td><td>진행 여부를 결정하는 불린 조건식</td><td>" 상태가 참이어야 진행 &ldquo;; 신호는 상태가 아님</td></tr><tr><td>락 결합</td><td>조건 변수는 락과 함께 사용</td><td><code>wait</code> 호출 전 <strong>락 보유</strong> 필수</td></tr><tr><td>원자적 해제/재획득</td><td><code>wait(lock)</code> 동작</td><td>락 <strong>해제 + 대기</strong>가 원자적, 깨어나면 <strong>락 재획득</strong> 후 반환</td></tr><tr><td>신호 종류</td><td>notify / broadcast</td><td>필요한 최소 스레드만 깨우기 권장</td></tr><tr><td>재검사 (while)</td><td>Mesa 의미론 대응</td><td>스푸리어스 웨이크업·경쟁 대응 위해 <strong>while 재검사</strong></td></tr><tr><td>메모리 가시성</td><td>acquire/release</td><td>락으로 순서·가시성 보장 (쓰기→신호→해제, 획득→읽기)</td></tr><tr><td>타임아웃/취소</td><td><code>wait_for</code>/<code>wait_until</code></td><td>무한 대기 방지·복구 경로 제공</td></tr><tr><td>순서/공정성</td><td>구현 종속</td><td>FIFO 미보장 가능—필요 시 별도 큐/우선순위 설계</td></tr><tr><td>실무 패턴</td><td>두 조건 전략, 상태 플래그</td><td>notEmpty/notFull 등 <strong>조건 분리</strong>로 경합 감소</td></tr></tbody></table><p>조건 변수는 <strong>락으로 보호된 상태</strong>를 기준으로</p><ul><li><code>wait</code> 에서 <strong>원자적 해제 - 대기 - 재획득</strong>을 수행하고,</li><li><strong>신호 후에도 반드시 while 로 재검사</strong>해 안전하게 진행한다.<br>신호는 상태가 아니라 <strong>상태 변화의 힌트</strong>이며, 가시성은 <strong>락의 메모리 순서</strong>로 보장된다.</li></ul><h5 id=동작-메커니즘>동작 메커니즘<a hidden class=anchor aria-hidden=true href=#동작-메커니즘>#</a></h5><pre class=mermaid>sequenceDiagram
  participant P as Producer (신호 측)
  participant C as Consumer (대기 측)
  participant M as Mutex
  participant CV as Condition Variable
  participant S as Shared State

  C-&gt;&gt;M: lock()
  C-&gt;&gt;S: check predicate
  alt predicate == false
    C-&gt;&gt;CV: wait(M)
    Note right of CV: atomically unlock(M) / sleep / relock(M)
    C-&gt;&gt;S: re-check predicate (while)
  else predicate == true
    C-&gt;&gt;S: proceed
  end
  C-&gt;&gt;M: unlock()

  par 다른 스레드(Producer)
    P-&gt;&gt;M: lock()
    P-&gt;&gt;S: update state (predicate becomes true)
    P-&gt;&gt;CV: notify (or notifyAll)
    P-&gt;&gt;M: unlock()
  end
</pre><p>소비자 (C) 는 <strong>락 획득→조건 검사→불만족 시 wait 로 원자적 해제·수면</strong>에 들어가고, 생산자 (P) 가 <strong>상태 변경→notify→락 해제</strong>를 수행한다. 깨어난 C 는 <strong>락 재획득 후 while 로 재검사</strong>하여 참이면 진행, 거짓이면 다시 대기한다. broadcast 는 많은 스레드를 깨워 <strong>경합</strong>을 유발할 수 있어 주의가 필요하다.</p><p><strong>상세 동작 프로세스</strong>:</p><ol><li><strong>wait() 연산</strong>:<ol><li>현재 스레드가 뮤텍스를 소유하고 있는지 확인</li><li>원자적으로 뮤텍스 해제 및 대기 큐에 추가</li><li>스레드를 블로킹 상태로 전환</li><li>신호 수신 시 대기 큐에서 제거</li><li>뮤텍스 재획득 시도</li><li>뮤텍스 획득 후 wait() 리턴</li></ol></li><li><strong>signal() 연산</strong>:<ol><li>대기 큐에서 하나의 스레드 선택 (FIFO)</li><li>해당 스레드를 깨우기 (ready 상태로 전환)</li><li>스케줄러에게 스레드 실행 요청</li></ol></li><li><strong>broadcast() 연산</strong>:<ol><li>대기 큐의 모든 스레드 선택</li><li>모든 대기 스레드를 깨우기</li><li>뮤텍스 경쟁 발생 (하나씩 획득)</li></ol></li></ol><h4 id=아키텍처-및-구성요소>아키텍처 및 구성요소<a hidden class=anchor aria-hidden=true href=#아키텍처-및-구성요소>#</a></h4><p>조건 변수 아키텍처는 <strong>하나의 뮤텍스가 보호하는 공유 상태</strong>를 중심으로, <strong>조건 변수와 그 내부 대기 큐 (Wait Queue)</strong> 가 연결된 구조다.<br>스레드는 락을 획득하고 <strong>술어 (predicate)</strong> 를 검사한 뒤, 조건이 거짓이면 <code>wait</code> 를 호출해 <strong>락을 원자적으로 해제 후 대기</strong>로 들어간다. 다른 스레드가 공유 상태를 변경한 뒤 <strong>락을 보유한 상태에서</strong> <code>signal</code> 또는 <code>broadcast</code> 를 호출하면, 대기 스레드가 깨어나 <strong>OS 스케줄러의 중재</strong>를 거쳐 <strong>락을 재획득</strong>한다.</p><p>현대 구현은 <strong>Mesa 시맨틱스</strong>를 사용하므로 깨어난 스레드는 <strong>while 루프</strong>로 조건을 재확인해야 한다.<br>성능과 안정성 향상을 위해 <strong>notify one vs notify all 선택</strong>, <strong>타임아웃 대기</strong>, <strong>우선순위 기반 큐</strong>, <strong>엔트리 큐 분리</strong>, <strong>메모리 가시성 보장</strong>을 함께 설계한다.</p><h5 id=아키텍처-구조>아키텍처 구조<a hidden class=anchor aria-hidden=true href=#아키텍처-구조>#</a></h5><pre class=mermaid>graph TD
  subgraph Threads
    T1[Thread Producer]
    T2[Thread Consumer]
  end

  subgraph Monitor
    M[Mutex]
    S[Shared State]
    CV[Condition Variable]
    WQ[Wait Queue]
    EQ[Entry Queue]
  end

  subgraph Runtime
    SCH[OS Scheduler]
    VIS[Memory Visibility]
  end

  T1 --&gt; M
  T2 --&gt; M
  M --&gt; S
  S --&gt; CV
  CV --&gt; WQ
  M -. lock waiters .-&gt; EQ

  %% Producer path
  T1 --&gt;|update state| S
  T1 --&gt;|signal or broadcast| CV
  CV --&gt;|wake candidates| SCH

  %% Wake and re acquire
  SCH --&gt;|ready to run| T2
  T2 --&gt;|wait if needed| WQ
  T2 --&gt;|re acquire| M

  %% Visibility guarantees
  VIS --- S
  VIS --- CV
</pre><ul><li><strong>스레드 → 락 → 공유 상태 → 조건 변수 대기 큐 → 신호 → 스케줄러 → 락 재획득</strong>의 흐름</li><li><strong>Entry Queue</strong>·<strong>메모리 가시성</strong>의 보조 역할을 함께 표현</li></ul><h5 id=구성-요소>구성 요소<a hidden class=anchor aria-hidden=true href=#구성-요소>#</a></h5><table><thead><tr><th>구성 요소</th><th>등급</th><th>설명</th><th>역할</th><th>핵심 기능</th><th>특징</th></tr></thead><tbody><tr><td><strong>Shared State</strong></td><td>필수</td><td>보호 대상인 공유 데이터와 그 상태 플래그</td><td>조건 판단의 근거</td><td>상태 플래그 갱신 · 조회</td><td>항상 하나의 뮤텍스로 보호</td></tr><tr><td><strong>Mutex Lock</strong></td><td>필수</td><td>상호 배제를 보장하는 락</td><td>상태 접근의 원자성 보장</td><td>lock unlock try_lock</td><td>재진입성 여부 구현체 의존 우선순위 상속 가능</td></tr><tr><td><strong>Condition Variable</strong></td><td>필수</td><td>조건 기반 대기와 깨움을 제공</td><td>상태 기반 협업의 관문</td><td>wait timed wait notify notify_all</td><td>wait 시 락 원자적 해제 후 대기 재깨어나면 락 재획득</td></tr><tr><td><strong>Wait Queue</strong></td><td>필수</td><td>조건 변수 내부의 대기 스레드 큐</td><td>신호 대상 관리</td><td>FIFO 또는 우선순위 운영</td><td>Mesa 시맨틱스 깨어남 후 재검사 필요</td></tr><tr><td><strong>Entry Queue</strong></td><td>선택</td><td>락 획득 대기 스레드 큐</td><td>공정한 락 진입 순서</td><td>FIFO 우선순위 기반</td><td>경합 완화 및 기아 방지에 유용</td></tr><tr><td><strong>Signal Broadcast</strong></td><td>필수</td><td>하나 혹은 모든 대기자 깨움 트리거</td><td>상태 변화 통지</td><td>notify one notify all</td><td>불필요한 깨움은 경합 유발 설계로 최소화</td></tr><tr><td><strong>Timeout Mechanism</strong></td><td>선택</td><td>무한 대기 방지</td><td>고립 회피 및 복구 경로 제공</td><td>timed wait deadline</td><td>SLA 대응 및 장애 격리</td></tr><tr><td><strong>Priority Queue Policy</strong></td><td>선택</td><td>우선순위 기반 대기 처리</td><td>기아 방지 실시간성 확보</td><td>priority scheduling</td><td>RT 환경에서 중요</td></tr><tr><td><strong>OS Scheduler Kernel Wait</strong></td><td>필수</td><td>스레드 수면과 깨움 전환</td><td>컨텍스트 스위칭 제어</td><td>대기 큐 전환 깨어남 스케줄링</td><td>일부 시스템은 futex 기반으로 사용자 공간 경로 최적화</td></tr><tr><td><strong>Memory Visibility Semantics</strong></td><td>필수</td><td>가시성과 순서 보장</td><td>최신 상태 관측 보장</td><td>happens before barrier</td><td>언어 메모리 모델로 보장 JMM CppMM 등</td></tr></tbody></table><h4 id=주요-기능과-역할>주요 기능과 역할<a hidden class=anchor aria-hidden=true href=#주요-기능과-역할>#</a></h4><table><thead><tr><th>기능</th><th>역할</th><th>책임</th><th>상호 관계</th></tr></thead><tbody><tr><td><strong>조건 검사</strong></td><td>Predicate 를 검사하여 조건 불만족 시 대기 준비</td><td>락 안에서만 접근, 상태 무결성 보장</td><td>wait() 와 결합</td></tr><tr><td><strong>wait()</strong></td><td>조건 충족까지 스레드 블로킹</td><td>원자적 unlock → sleep → relock, 대기 큐 등록</td><td>signal()/broadcast() 와 대응</td></tr><tr><td><strong>signal()/notify_one()</strong></td><td>대기 스레드 하나를 깨움</td><td>대기 큐에서 하나 선택, 스케줄러로 실행 가능 상태 전환</td><td>wait() 와 대응</td></tr><tr><td><strong>broadcast()/notify_all()</strong></td><td>모든 대기 스레드 깨움</td><td>전체 상태 변경 시 사용, herd thundering 유발 가능</td><td>wait() 와 대응</td></tr><tr><td><strong>timed_wait()</strong></td><td>타임아웃 설정된 조건 대기</td><td>시간 초과 시 false 반환, 조건 충족 시 true 반환</td><td>조건 검사와 결합</td></tr><tr><td><strong>뮤텍스 연동</strong></td><td>상태 변경·검사 원자성 보장</td><td>락과 조건 변수 항상 페어 사용</td><td>모든 기능과 결합</td></tr></tbody></table><p>조건 변수의 주요 기능은</p><ul><li><strong>조건 검사 → 대기 (wait) → 신호 (signal/broadcast) → 재검사</strong>의 흐름을 중심으로 작동한다.</li><li>모든 과정은 <strong>뮤텍스와 결합</strong>하여 상태 검사와 변경의 원자성을 확보하며, <code>wait</code> 호출은 내부적으로 <strong>unlock → sleep → relock</strong>을 원자적으로 수행한다.</li><li>깨어난 스레드는 <strong>스퓨리어스 웨이크업</strong>과 <strong>Mesa 시맨틱</strong>에 대비해 반드시 조건을 다시 확인해야 한다.</li><li><code>signal</code> 은 하나의 스레드만, <code>broadcast</code> 는 모든 대기 스레드를 깨우며, <code>timed_wait</code> 를 통해 대기 시간을 제한할 수 있다.</li><li>내부적으로 조건 변수는 대기 큐를 관리하며, signal/broadcast 가 큐에서 스레드를 선택해 OS 스케줄러로 넘긴다.</li></ul><h3 id=특성-분석-characteristics-analysis>특성 분석 (Characteristics Analysis)<a hidden class=anchor aria-hidden=true href=#특성-분석-characteristics-analysis>#</a></h3><h4 id=장점-및-이점>장점 및 이점<a hidden class=anchor aria-hidden=true href=#장점-및-이점>#</a></h4><p>조건 변수는 CPU 자원을 효율적으로 사용하면서, 복잡한 동기화 로직을 단순화하고 안정적인 스레드 협업을 가능하게 한다.<br>바쁜 대기 없이 조건 충족 시 즉시 스레드를 깨우며, 뮤텍스와 결합해 race condition 을 방지한다.<br>하나의 락에 여러 조건 변수를 연결하거나 타임아웃을 지원해 다양한 패턴과 장애 상황에 대응할 수 있다.<br>표준 API 로 다양한 언어와 플랫폼에서 이식성이 높고, 메모리 가시성 보장과 공정성 제어로 실시간 및 고성능 시스템에도 적합하다.</p><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>기술적 근거</th></tr></thead><tbody><tr><td>성능</td><td><strong>CPU 효율성</strong></td><td>바쁜 대기 제거, 블로킹 기반 대기</td><td>OS 스케줄러가 대기 스레드를 실행 큐에서 제거</td></tr><tr><td>성능</td><td><strong>응답성</strong></td><td>조건 충족 시 즉시 스레드 깨움</td><td>커널 레벨 신호 및 스케줄링 메커니즘</td></tr><tr><td>설계</td><td><strong>코드 단순화</strong></td><td>복잡한 동기화 로직을 간결하게 표현</td><td>wait/signal 추상화</td></tr><tr><td>확장성</td><td><strong>다양한 패턴 지원</strong></td><td>생산자 - 소비자, 배리어, Reader-Writer 등 구현 가능</td><td>여러 조건 변수 및 signal/broadcast 제공</td></tr><tr><td>안정성</td><td><strong>경쟁 조건 방지</strong></td><td>뮤텍스와 결합해 상태 접근 원자성 보장</td><td>락 보호 및 while 재검사 규칙</td></tr><tr><td>호환성</td><td><strong>표준화 및 이식성</strong></td><td>다양한 언어·플랫폼에서 지원</td><td>POSIX, C++, Java, Go 등</td></tr><tr><td>안정성</td><td><strong>메모리 가시성 보장</strong></td><td>최신 상태를 올바르게 관측 가능</td><td>언어 메모리 모델이 happens-before 보장</td></tr><tr><td>유연성</td><td><strong>타임아웃 대기</strong></td><td>무한 대기 방지 및 고립 회피</td><td>timed_wait 기능</td></tr><tr><td>공정성</td><td><strong>기아 방지</strong></td><td>FIFO 또는 우선순위 기반 스케줄링 가능</td><td>OS 스케줄러 정책 연계</td></tr></tbody></table><p>조건 변수는 <strong>바쁜 대기 없이 효율적 동기화</strong>를 가능하게 하며, <strong>즉시 반응성</strong>과 <strong>안정성</strong>을 동시에 확보한다.<br>복잡한 패턴을 간결하게 구현하고, 타임아웃·다중 조건 변수·메모리 가시성 보장 등으로 다양한 환경에 적합하다. 표준화된 API 와 높은 이식성 덕분에 범용적으로 활용되며, 공정성 제어로 실시간·고성능 시스템에도 안정적으로 적용 가능하다.</p><h4 id=단점-및-제약사항과-해결방안>단점 및 제약사항과 해결방안<a hidden class=anchor aria-hidden=true href=#단점-및-제약사항과-해결방안>#</a></h4><p>조건 변수는 강력한 동기화 도구이지만, <strong>잘못된 사용 패턴</strong>이나 <strong>플랫폼 특성</strong>으로 인해 버그와 성능 문제가 발생할 수 있다.<br>대표적으로 <strong>Spurious Wakeup</strong>과 <strong>Lost Wakeup</strong>은 조건 재검사와 올바른 락 사용으로 방지해야 한다.<br>또한, <strong>Deadlock</strong>과 <strong>Priority Inversion</strong>은 락 순서 정의·우선순위 상속 등 설계 단계에서 예방 가능하다.<br><strong>Thundering Herd</strong> 현상은 signal 로 최소 깨움 전략을 사용하고, 조건 변수를 샤딩해 완화할 수 있다.<br>플랫폼별 세부 동작 차이와 디버깅 난이도를 고려해, 로깅·트레이싱·표준화된 인터페이스를 적극 활용하는 것이 바람직하다.</p><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>원인</th><th>영향</th><th>탐지/진단</th><th>예방 방법</th><th>해결 기법/대안</th></tr></thead><tbody><tr><td>안정성</td><td><strong>Spurious Wakeup</strong></td><td>조건 미충족 상태에서 깨어남</td><td>OS/구현체 특성</td><td>오동작, 잘못된 진행</td><td>로그, 디버깅</td><td>while 루프로 조건 재검사</td><td>조건 검증 강화, predicate 기반 wait</td></tr><tr><td>안정성</td><td><strong>Lost Wakeup</strong></td><td>wait 등록 전 signal 발생</td><td>타이밍 경쟁</td><td>영구 대기</td><td>대기시간 모니터링</td><td>뮤텍스 보유 상태에서 wait, 조건 재검사</td><td>상태 변경 직후 signal</td></tr><tr><td>안정성</td><td><strong>Deadlock</strong></td><td>락 순서 불일치, 재진입 오류</td><td>잘못된 설계</td><td>시스템 정지</td><td>데드락 탐지 도구</td><td>락 계층 정의, 타임아웃</td><td>데드락 회피 알고리즘</td></tr><tr><td>안정성</td><td><strong>Priority Inversion</strong></td><td>낮은 우선순위 스레드가 락 점유</td><td>우선순위 경합</td><td>응답성 저하</td><td>스케줄러 트레이스</td><td>락 홀드 최소화, 우선순위 정책 적용</td><td>우선순위 상속/천장 프로토콜</td></tr><tr><td>성능</td><td><strong>Thundering Herd</strong></td><td>broadcast 남용</td><td>불필요한 동시 기상</td><td>컨텍스트 스위칭 폭증</td><td>프로파일링</td><td>signal 우선 사용</td><td>조건 변수 샤딩, 이벤트 큐</td></tr><tr><td>복잡성</td><td><strong>사용 난이도</strong></td><td>뮤텍스·조건 변수·predicate 조합 복잡</td><td>API 사용법 미숙</td><td>버그 증가</td><td>코드 리뷰, 정적 분석</td><td>표준 패턴 준수</td><td>모니터 패턴, 고수준 동기화</td></tr><tr><td>성능</td><td><strong>컨텍스트 스위칭 오버헤드</strong></td><td>잦은 대기/깨움</td><td>커널 모드 전환</td><td>처리량 저하</td><td>성능 측정</td><td>최소한의 깨움, 배치 처리</td><td>lock-free 자료구조</td></tr><tr><td>이식성</td><td><strong>플랫폼별 동작 차이</strong></td><td>구현 차이</td><td>포팅 이슈</td><td>이식성 저하</td><td>크로스 테스트</td><td>표준 API 사용</td><td>호환성 계층 적용</td></tr><tr><td>디버깅</td><td><strong>문제 추적 어려움</strong></td><td>동시성 버그 재현 어려움</td><td>재현성 낮음</td><td>트레이스, 로깅</td><td>모니터링 강화</td><td>동시성 테스팅 도구</td><td></td></tr></tbody></table><p>조건 변수의 주요 위험 요소는 <strong>신호 손실 (Lost Wakeup)</strong>, <strong>가짜 깨움 (Spurious Wakeup)</strong>, <strong>교착 상태 (Deadlock)</strong>, <strong>우선순위 역전</strong>, <strong>성능 저하 (Thundering Herd)</strong>, <strong>복잡성 증가</strong>, 그리고 <strong>이식성 문제</strong>다.<br>이들 문제는 대부분 <strong>표준 사용 패턴 준수</strong>와 <strong>설계 단계 예방책</strong>으로 방지 가능하며, 특히 <code>while</code> 조건 재검사, 뮤텍스 락 순서 정의, 최소한의 signal 사용이 핵심이다.<br>또한, 디버깅·모니터링 환경을 마련하고, 필요 시 <strong>고수준 동기화 도구</strong>나 <strong>lock-free 자료구조</strong>로 대체하는 전략이 실무적으로 유효하다.</p><h5 id=가짜-깨움-spurious-wakeup>가짜 깨움 (Spurious Wakeup)<a hidden class=anchor aria-hidden=true href=#가짜-깨움-spurious-wakeup>#</a></h5><p>가짜 깨우기는 조건 변수 (Condition Variable) 를 사용할 때 발생할 수 있는 현상으로, 조건 변수에서 <strong>명시적 신호 (signal 이나 broadcast 등) 없이 wait 상태에서 스레드가 깨어나는 현상</strong>이다. 이는 정상 동작으로 간주되며, POSIX, Java, C++ 표준에서도 발생 가능성을 인정하고 방어적 코드를 요구한다. 따라서 wait 호출은 항상 <strong>while 조건 재검사</strong>를 통해 보호해야 한다.</p><p><strong>원인</strong>:</p><ol><li><strong>운영체제 스케줄러 동작</strong>—특정 상황에서 대기 큐 전체를 깨우거나 잘못된 스레드를 깨움.</li><li><strong>하드웨어 인터럽트</strong>—외부 장치나 타이머 인터럽트가 대기 상태를 해제.</li><li><strong>시그널 처리</strong>—OS 의 시그널 메커니즘이 wait 상태를 중단.</li><li><strong>조건 변수 구현 차이</strong>—POSIX, Java, C++ 에서 허용하는 동작으로 표준에서 인정.</li><li><strong>다중 조건 변수 혼용</strong>—같은 wait 큐에 여러 조건이 섞여 있는 경우.</li></ol><p><strong>문제점</strong>:</p><ul><li>조건이 충족되지 않았음에도 스레드가 실행 → 잘못된 데이터 사용, 레이스 컨디션 발생.</li><li>자원 상태 불일치 → 동기화 실패, 프로그램 불안정.</li><li>불필요한 컨텍스트 스위칭 → 성능 저하.</li></ul><p><strong>해결책</strong>:</p><ol><li><strong>while 재검사</strong>—조건이 만족될 때까지 반복 확인.</li><li><strong>상태 변수 사용</strong>—단순히 신호만 기다리지 않고 명시적 상태 확인.</li><li><strong>상태 변경 순서 준수</strong>—상태 변경 → notify 순서.</li><li><strong>모든 공유 상태 동기화 블록 내에서 변경</strong>—원자적 보장.</li><li><strong>Predicate 기반 설계</strong>—명확한 조건 함수로 대기 종료 시점 정의.</li></ol><p><strong>권장 패턴</strong>:</p><ul><li><code>while not 조건: wait()</code> + 명확한 상태 변수</li></ul><p><strong>구현 예시</strong>:</p><ul><li><p>잘못된 구현 (if 사용)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>wait_for_data</span><span class=p>(</span><span class=n>condition</span><span class=p>,</span> <span class=n>shared_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>shared_data</span><span class=o>.</span><span class=n>is_ready</span><span class=p>:</span>  <span class=c1># ❌ 한 번만 검사</span>
</span></span><span class=line><span class=cl>            <span class=n>condition</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>shared_data</span><span class=o>.</span><span class=n>value</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>문제</strong> Spurious Wakeup 발생 시 조건이 만족되지 않아도 반환함.</li></ul></li><li><p><strong>잘된 구현 (while 사용)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>SharedData</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>condition</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_ready</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># 소비자: 데이터 준비될 때까지 대기</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wait_for_data</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_ready</span><span class=p>:</span>  <span class=c1># ✅ 반복 검사</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># 생산자: 데이터 설정 후 알림</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>is_ready</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>개선점</strong>:<ul><li><code>while</code> 로 반복 검사</li><li>명확한 상태 변수 <code>is_ready</code></li><li>상태 변경 후 <code>notify_all()</code> 호출</li></ul></li></ul></li></ul><h4 id=트레이드오프-관계-분석>트레이드오프 관계 분석<a hidden class=anchor aria-hidden=true href=#트레이드오프-관계-분석>#</a></h4><table><thead><tr><th>비교 항목</th><th>선택지 A</th><th>A 의 장점</th><th>A 의 단점</th><th>선택지 B</th><th>B 의 장점</th><th>B 의 단점</th><th>선택 기준</th></tr></thead><tbody><tr><td>동기화 방식</td><td><strong>CV</strong></td><td>CPU 절약, 상태 기반, 안전성</td><td>프로토콜 복잡, 스케줄링 비용</td><td><strong>폴링/스핀</strong></td><td>구현 단순, 초단기 지연 최소</td><td>CPU 낭비, 전력/확장성 열위</td><td>대기 시간이 짧으면 스핀 (혼합), 일반적으론 CV</td></tr><tr><td>프리미티브</td><td><strong>CV</strong></td><td>복합 조건 표현, 조건 분리</td><td>상태/플래그 설계 필요</td><td><strong>세마포어</strong></td><td>카운팅 자원에 최적, 단순</td><td>복합 조건 취약</td><td>" 개수 관리 &ldquo;=세마포어, " 상태/조건 &ldquo;=CV</td></tr><tr><td>동기화 모델</td><td><strong>CV(상태공유)</strong></td><td>세밀 제어, 재검사 용이</td><td>락 경합 관리 필요</td><td><strong>채널 (메시지)</strong></td><td>코드 단순, 결합도↓</td><td>복합 상태 표현 우회 필요</td><td>데이터/이벤트 흐름=채널, 상태 기반=CV</td></tr><tr><td>신호 범위</td><td><strong>notify_one</strong></td><td>경합 최소, 효율적</td><td>한 스레드가 조건 불충족일 수 있음</td><td><strong>notify_all</strong></td><td>변화 전파 확실</td><td>스레드 폭주/경합</td><td>기본 one, 구조 변경/다중 의존=all</td></tr><tr><td>의미론</td><td><strong>Mesa</strong></td><td>보편적, 구현 단순</td><td>while 재검사 필수</td><td><strong>Hoare</strong></td><td>즉시 실행, 논리 명확</td><td>구현 난도↑</td><td>일반적 Mesa, RT 엄격성 필요 시 보완 설계</td></tr><tr><td>락 전략</td><td><strong>스핀락</strong></td><td>초저지연 (매우 짧은 임계구역)</td><td>CPU 낭비</td><td><strong>블로킹 +CV</strong></td><td>장기 대기 효율, 전력 우수</td><td>스케줄링 비용</td><td>임계구역 길이에 따라 선택/혼합</td></tr></tbody></table><p>조건 변수는 <strong>상태 기반 동기화의 표현력과 효율성</strong>을 제공하지만, 올바른 프로토콜 (while 재검사, 상태→notify→unlock, 조건 분리) 을 지켜야 성능과 안정성을 함께 얻을 수 있다.<br>자원 카운팅은 <strong>세마포어</strong>, 데이터·이벤트 흐름은 <strong>채널</strong>, 복합 상태 협업은 <strong>CV</strong>가 유리하다.<br>신호 범위는 <strong>notify_one 우선</strong>, 필요 시 <strong>notify_all</strong>을 신중히 사용하고, 초단기 임계구역에는 <strong>스핀→CV 혼합</strong>으로 실용 균형을 맞추는 것이 좋다.</p><h3 id=구현-및-분류-implementation--classification>구현 및 분류 (Implementation & Classification)<a hidden class=anchor aria-hidden=true href=#구현-및-분류-implementation--classification>#</a></h3><h4 id=구현-기법-및-방법>구현 기법 및 방법<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법>#</a></h4><p><strong>기본 구현 패턴</strong></p><table><thead><tr><th>기법</th><th>정의</th><th>구성</th><th>목적</th><th>실제 예시</th></tr></thead><tbody><tr><td><strong>Mesa Style</strong></td><td>signal() 후 즉시 제어권 넘기지 않음</td><td>while 루프 + predicate</td><td>spurious wakeup 대응</td><td>POSIX pthread</td></tr><tr><td><strong>Hoare Style</strong></td><td>signal() 후 즉시 제어권 이전</td><td>if 검사만으로 충분</td><td>즉시 조건 보장</td><td>일부 교육용 구현</td></tr><tr><td><strong>Predicate-based</strong></td><td>조건 함수와 결합된 대기</td><td>lambda/function + cv</td><td>조건 캡슐화</td><td>C++11 wait()</td></tr></tbody></table><h5 id=벤치마크-시나리오>벤치마크 시나리오<a hidden class=anchor aria-hidden=true href=#벤치마크-시나리오>#</a></h5><ul><li>고정된 <strong>버퍼 용량 (capacity)</strong> 과 <strong>생산자/소비자 수</strong>, <strong>총 아이템 수</strong> 설정</li><li><strong>각 아이템의 생산 시작 시각</strong>을 담아 소비 시 <strong>지연 (latency)</strong> 계산</li><li>구현별로: <strong>총 처리량 (Throughput)</strong>, <strong>평균/중앙/최대 지연</strong>, <strong>대기 횟수 (빈 버퍼/가득 찬 버퍼로 인한 wait 횟수)</strong> 비교</li><li>공평비교 위해 <strong>동시 시작 Barrier</strong> 사용</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1>  1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2>  2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3>  3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4>  4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5>  5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6>  6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7>  7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8>  8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9>  9</a>
</span><span class=lnt id=hl-24-10><a class=lnlinks href=#hl-24-10> 10</a>
</span><span class=lnt id=hl-24-11><a class=lnlinks href=#hl-24-11> 11</a>
</span><span class=lnt id=hl-24-12><a class=lnlinks href=#hl-24-12> 12</a>
</span><span class=lnt id=hl-24-13><a class=lnlinks href=#hl-24-13> 13</a>
</span><span class=lnt id=hl-24-14><a class=lnlinks href=#hl-24-14> 14</a>
</span><span class=lnt id=hl-24-15><a class=lnlinks href=#hl-24-15> 15</a>
</span><span class=lnt id=hl-24-16><a class=lnlinks href=#hl-24-16> 16</a>
</span><span class=lnt id=hl-24-17><a class=lnlinks href=#hl-24-17> 17</a>
</span><span class=lnt id=hl-24-18><a class=lnlinks href=#hl-24-18> 18</a>
</span><span class=lnt id=hl-24-19><a class=lnlinks href=#hl-24-19> 19</a>
</span><span class=lnt id=hl-24-20><a class=lnlinks href=#hl-24-20> 20</a>
</span><span class=lnt id=hl-24-21><a class=lnlinks href=#hl-24-21> 21</a>
</span><span class=lnt id=hl-24-22><a class=lnlinks href=#hl-24-22> 22</a>
</span><span class=lnt id=hl-24-23><a class=lnlinks href=#hl-24-23> 23</a>
</span><span class=lnt id=hl-24-24><a class=lnlinks href=#hl-24-24> 24</a>
</span><span class=lnt id=hl-24-25><a class=lnlinks href=#hl-24-25> 25</a>
</span><span class=lnt id=hl-24-26><a class=lnlinks href=#hl-24-26> 26</a>
</span><span class=lnt id=hl-24-27><a class=lnlinks href=#hl-24-27> 27</a>
</span><span class=lnt id=hl-24-28><a class=lnlinks href=#hl-24-28> 28</a>
</span><span class=lnt id=hl-24-29><a class=lnlinks href=#hl-24-29> 29</a>
</span><span class=lnt id=hl-24-30><a class=lnlinks href=#hl-24-30> 30</a>
</span><span class=lnt id=hl-24-31><a class=lnlinks href=#hl-24-31> 31</a>
</span><span class=lnt id=hl-24-32><a class=lnlinks href=#hl-24-32> 32</a>
</span><span class=lnt id=hl-24-33><a class=lnlinks href=#hl-24-33> 33</a>
</span><span class=lnt id=hl-24-34><a class=lnlinks href=#hl-24-34> 34</a>
</span><span class=lnt id=hl-24-35><a class=lnlinks href=#hl-24-35> 35</a>
</span><span class=lnt id=hl-24-36><a class=lnlinks href=#hl-24-36> 36</a>
</span><span class=lnt id=hl-24-37><a class=lnlinks href=#hl-24-37> 37</a>
</span><span class=lnt id=hl-24-38><a class=lnlinks href=#hl-24-38> 38</a>
</span><span class=lnt id=hl-24-39><a class=lnlinks href=#hl-24-39> 39</a>
</span><span class=lnt id=hl-24-40><a class=lnlinks href=#hl-24-40> 40</a>
</span><span class=lnt id=hl-24-41><a class=lnlinks href=#hl-24-41> 41</a>
</span><span class=lnt id=hl-24-42><a class=lnlinks href=#hl-24-42> 42</a>
</span><span class=lnt id=hl-24-43><a class=lnlinks href=#hl-24-43> 43</a>
</span><span class=lnt id=hl-24-44><a class=lnlinks href=#hl-24-44> 44</a>
</span><span class=lnt id=hl-24-45><a class=lnlinks href=#hl-24-45> 45</a>
</span><span class=lnt id=hl-24-46><a class=lnlinks href=#hl-24-46> 46</a>
</span><span class=lnt id=hl-24-47><a class=lnlinks href=#hl-24-47> 47</a>
</span><span class=lnt id=hl-24-48><a class=lnlinks href=#hl-24-48> 48</a>
</span><span class=lnt id=hl-24-49><a class=lnlinks href=#hl-24-49> 49</a>
</span><span class=lnt id=hl-24-50><a class=lnlinks href=#hl-24-50> 50</a>
</span><span class=lnt id=hl-24-51><a class=lnlinks href=#hl-24-51> 51</a>
</span><span class=lnt id=hl-24-52><a class=lnlinks href=#hl-24-52> 52</a>
</span><span class=lnt id=hl-24-53><a class=lnlinks href=#hl-24-53> 53</a>
</span><span class=lnt id=hl-24-54><a class=lnlinks href=#hl-24-54> 54</a>
</span><span class=lnt id=hl-24-55><a class=lnlinks href=#hl-24-55> 55</a>
</span><span class=lnt id=hl-24-56><a class=lnlinks href=#hl-24-56> 56</a>
</span><span class=lnt id=hl-24-57><a class=lnlinks href=#hl-24-57> 57</a>
</span><span class=lnt id=hl-24-58><a class=lnlinks href=#hl-24-58> 58</a>
</span><span class=lnt id=hl-24-59><a class=lnlinks href=#hl-24-59> 59</a>
</span><span class=lnt id=hl-24-60><a class=lnlinks href=#hl-24-60> 60</a>
</span><span class=lnt id=hl-24-61><a class=lnlinks href=#hl-24-61> 61</a>
</span><span class=lnt id=hl-24-62><a class=lnlinks href=#hl-24-62> 62</a>
</span><span class=lnt id=hl-24-63><a class=lnlinks href=#hl-24-63> 63</a>
</span><span class=lnt id=hl-24-64><a class=lnlinks href=#hl-24-64> 64</a>
</span><span class=lnt id=hl-24-65><a class=lnlinks href=#hl-24-65> 65</a>
</span><span class=lnt id=hl-24-66><a class=lnlinks href=#hl-24-66> 66</a>
</span><span class=lnt id=hl-24-67><a class=lnlinks href=#hl-24-67> 67</a>
</span><span class=lnt id=hl-24-68><a class=lnlinks href=#hl-24-68> 68</a>
</span><span class=lnt id=hl-24-69><a class=lnlinks href=#hl-24-69> 69</a>
</span><span class=lnt id=hl-24-70><a class=lnlinks href=#hl-24-70> 70</a>
</span><span class=lnt id=hl-24-71><a class=lnlinks href=#hl-24-71> 71</a>
</span><span class=lnt id=hl-24-72><a class=lnlinks href=#hl-24-72> 72</a>
</span><span class=lnt id=hl-24-73><a class=lnlinks href=#hl-24-73> 73</a>
</span><span class=lnt id=hl-24-74><a class=lnlinks href=#hl-24-74> 74</a>
</span><span class=lnt id=hl-24-75><a class=lnlinks href=#hl-24-75> 75</a>
</span><span class=lnt id=hl-24-76><a class=lnlinks href=#hl-24-76> 76</a>
</span><span class=lnt id=hl-24-77><a class=lnlinks href=#hl-24-77> 77</a>
</span><span class=lnt id=hl-24-78><a class=lnlinks href=#hl-24-78> 78</a>
</span><span class=lnt id=hl-24-79><a class=lnlinks href=#hl-24-79> 79</a>
</span><span class=lnt id=hl-24-80><a class=lnlinks href=#hl-24-80> 80</a>
</span><span class=lnt id=hl-24-81><a class=lnlinks href=#hl-24-81> 81</a>
</span><span class=lnt id=hl-24-82><a class=lnlinks href=#hl-24-82> 82</a>
</span><span class=lnt id=hl-24-83><a class=lnlinks href=#hl-24-83> 83</a>
</span><span class=lnt id=hl-24-84><a class=lnlinks href=#hl-24-84> 84</a>
</span><span class=lnt id=hl-24-85><a class=lnlinks href=#hl-24-85> 85</a>
</span><span class=lnt id=hl-24-86><a class=lnlinks href=#hl-24-86> 86</a>
</span><span class=lnt id=hl-24-87><a class=lnlinks href=#hl-24-87> 87</a>
</span><span class=lnt id=hl-24-88><a class=lnlinks href=#hl-24-88> 88</a>
</span><span class=lnt id=hl-24-89><a class=lnlinks href=#hl-24-89> 89</a>
</span><span class=lnt id=hl-24-90><a class=lnlinks href=#hl-24-90> 90</a>
</span><span class=lnt id=hl-24-91><a class=lnlinks href=#hl-24-91> 91</a>
</span><span class=lnt id=hl-24-92><a class=lnlinks href=#hl-24-92> 92</a>
</span><span class=lnt id=hl-24-93><a class=lnlinks href=#hl-24-93> 93</a>
</span><span class=lnt id=hl-24-94><a class=lnlinks href=#hl-24-94> 94</a>
</span><span class=lnt id=hl-24-95><a class=lnlinks href=#hl-24-95> 95</a>
</span><span class=lnt id=hl-24-96><a class=lnlinks href=#hl-24-96> 96</a>
</span><span class=lnt id=hl-24-97><a class=lnlinks href=#hl-24-97> 97</a>
</span><span class=lnt id=hl-24-98><a class=lnlinks href=#hl-24-98> 98</a>
</span><span class=lnt id=hl-24-99><a class=lnlinks href=#hl-24-99> 99</a>
</span><span class=lnt id=hl-24-100><a class=lnlinks href=#hl-24-100>100</a>
</span><span class=lnt id=hl-24-101><a class=lnlinks href=#hl-24-101>101</a>
</span><span class=lnt id=hl-24-102><a class=lnlinks href=#hl-24-102>102</a>
</span><span class=lnt id=hl-24-103><a class=lnlinks href=#hl-24-103>103</a>
</span><span class=lnt id=hl-24-104><a class=lnlinks href=#hl-24-104>104</a>
</span><span class=lnt id=hl-24-105><a class=lnlinks href=#hl-24-105>105</a>
</span><span class=lnt id=hl-24-106><a class=lnlinks href=#hl-24-106>106</a>
</span><span class=lnt id=hl-24-107><a class=lnlinks href=#hl-24-107>107</a>
</span><span class=lnt id=hl-24-108><a class=lnlinks href=#hl-24-108>108</a>
</span><span class=lnt id=hl-24-109><a class=lnlinks href=#hl-24-109>109</a>
</span><span class=lnt id=hl-24-110><a class=lnlinks href=#hl-24-110>110</a>
</span><span class=lnt id=hl-24-111><a class=lnlinks href=#hl-24-111>111</a>
</span><span class=lnt id=hl-24-112><a class=lnlinks href=#hl-24-112>112</a>
</span><span class=lnt id=hl-24-113><a class=lnlinks href=#hl-24-113>113</a>
</span><span class=lnt id=hl-24-114><a class=lnlinks href=#hl-24-114>114</a>
</span><span class=lnt id=hl-24-115><a class=lnlinks href=#hl-24-115>115</a>
</span><span class=lnt id=hl-24-116><a class=lnlinks href=#hl-24-116>116</a>
</span><span class=lnt id=hl-24-117><a class=lnlinks href=#hl-24-117>117</a>
</span><span class=lnt id=hl-24-118><a class=lnlinks href=#hl-24-118>118</a>
</span><span class=lnt id=hl-24-119><a class=lnlinks href=#hl-24-119>119</a>
</span><span class=lnt id=hl-24-120><a class=lnlinks href=#hl-24-120>120</a>
</span><span class=lnt id=hl-24-121><a class=lnlinks href=#hl-24-121>121</a>
</span><span class=lnt id=hl-24-122><a class=lnlinks href=#hl-24-122>122</a>
</span><span class=lnt id=hl-24-123><a class=lnlinks href=#hl-24-123>123</a>
</span><span class=lnt id=hl-24-124><a class=lnlinks href=#hl-24-124>124</a>
</span><span class=lnt id=hl-24-125><a class=lnlinks href=#hl-24-125>125</a>
</span><span class=lnt id=hl-24-126><a class=lnlinks href=#hl-24-126>126</a>
</span><span class=lnt id=hl-24-127><a class=lnlinks href=#hl-24-127>127</a>
</span><span class=lnt id=hl-24-128><a class=lnlinks href=#hl-24-128>128</a>
</span><span class=lnt id=hl-24-129><a class=lnlinks href=#hl-24-129>129</a>
</span><span class=lnt id=hl-24-130><a class=lnlinks href=#hl-24-130>130</a>
</span><span class=lnt id=hl-24-131><a class=lnlinks href=#hl-24-131>131</a>
</span><span class=lnt id=hl-24-132><a class=lnlinks href=#hl-24-132>132</a>
</span><span class=lnt id=hl-24-133><a class=lnlinks href=#hl-24-133>133</a>
</span><span class=lnt id=hl-24-134><a class=lnlinks href=#hl-24-134>134</a>
</span><span class=lnt id=hl-24-135><a class=lnlinks href=#hl-24-135>135</a>
</span><span class=lnt id=hl-24-136><a class=lnlinks href=#hl-24-136>136</a>
</span><span class=lnt id=hl-24-137><a class=lnlinks href=#hl-24-137>137</a>
</span><span class=lnt id=hl-24-138><a class=lnlinks href=#hl-24-138>138</a>
</span><span class=lnt id=hl-24-139><a class=lnlinks href=#hl-24-139>139</a>
</span><span class=lnt id=hl-24-140><a class=lnlinks href=#hl-24-140>140</a>
</span><span class=lnt id=hl-24-141><a class=lnlinks href=#hl-24-141>141</a>
</span><span class=lnt id=hl-24-142><a class=lnlinks href=#hl-24-142>142</a>
</span><span class=lnt id=hl-24-143><a class=lnlinks href=#hl-24-143>143</a>
</span><span class=lnt id=hl-24-144><a class=lnlinks href=#hl-24-144>144</a>
</span><span class=lnt id=hl-24-145><a class=lnlinks href=#hl-24-145>145</a>
</span><span class=lnt id=hl-24-146><a class=lnlinks href=#hl-24-146>146</a>
</span><span class=lnt id=hl-24-147><a class=lnlinks href=#hl-24-147>147</a>
</span><span class=lnt id=hl-24-148><a class=lnlinks href=#hl-24-148>148</a>
</span><span class=lnt id=hl-24-149><a class=lnlinks href=#hl-24-149>149</a>
</span><span class=lnt id=hl-24-150><a class=lnlinks href=#hl-24-150>150</a>
</span><span class=lnt id=hl-24-151><a class=lnlinks href=#hl-24-151>151</a>
</span><span class=lnt id=hl-24-152><a class=lnlinks href=#hl-24-152>152</a>
</span><span class=lnt id=hl-24-153><a class=lnlinks href=#hl-24-153>153</a>
</span><span class=lnt id=hl-24-154><a class=lnlinks href=#hl-24-154>154</a>
</span><span class=lnt id=hl-24-155><a class=lnlinks href=#hl-24-155>155</a>
</span><span class=lnt id=hl-24-156><a class=lnlinks href=#hl-24-156>156</a>
</span><span class=lnt id=hl-24-157><a class=lnlinks href=#hl-24-157>157</a>
</span><span class=lnt id=hl-24-158><a class=lnlinks href=#hl-24-158>158</a>
</span><span class=lnt id=hl-24-159><a class=lnlinks href=#hl-24-159>159</a>
</span><span class=lnt id=hl-24-160><a class=lnlinks href=#hl-24-160>160</a>
</span><span class=lnt id=hl-24-161><a class=lnlinks href=#hl-24-161>161</a>
</span><span class=lnt id=hl-24-162><a class=lnlinks href=#hl-24-162>162</a>
</span><span class=lnt id=hl-24-163><a class=lnlinks href=#hl-24-163>163</a>
</span><span class=lnt id=hl-24-164><a class=lnlinks href=#hl-24-164>164</a>
</span><span class=lnt id=hl-24-165><a class=lnlinks href=#hl-24-165>165</a>
</span><span class=lnt id=hl-24-166><a class=lnlinks href=#hl-24-166>166</a>
</span><span class=lnt id=hl-24-167><a class=lnlinks href=#hl-24-167>167</a>
</span><span class=lnt id=hl-24-168><a class=lnlinks href=#hl-24-168>168</a>
</span><span class=lnt id=hl-24-169><a class=lnlinks href=#hl-24-169>169</a>
</span><span class=lnt id=hl-24-170><a class=lnlinks href=#hl-24-170>170</a>
</span><span class=lnt id=hl-24-171><a class=lnlinks href=#hl-24-171>171</a>
</span><span class=lnt id=hl-24-172><a class=lnlinks href=#hl-24-172>172</a>
</span><span class=lnt id=hl-24-173><a class=lnlinks href=#hl-24-173>173</a>
</span><span class=lnt id=hl-24-174><a class=lnlinks href=#hl-24-174>174</a>
</span><span class=lnt id=hl-24-175><a class=lnlinks href=#hl-24-175>175</a>
</span><span class=lnt id=hl-24-176><a class=lnlinks href=#hl-24-176>176</a>
</span><span class=lnt id=hl-24-177><a class=lnlinks href=#hl-24-177>177</a>
</span><span class=lnt id=hl-24-178><a class=lnlinks href=#hl-24-178>178</a>
</span><span class=lnt id=hl-24-179><a class=lnlinks href=#hl-24-179>179</a>
</span><span class=lnt id=hl-24-180><a class=lnlinks href=#hl-24-180>180</a>
</span><span class=lnt id=hl-24-181><a class=lnlinks href=#hl-24-181>181</a>
</span><span class=lnt id=hl-24-182><a class=lnlinks href=#hl-24-182>182</a>
</span><span class=lnt id=hl-24-183><a class=lnlinks href=#hl-24-183>183</a>
</span><span class=lnt id=hl-24-184><a class=lnlinks href=#hl-24-184>184</a>
</span><span class=lnt id=hl-24-185><a class=lnlinks href=#hl-24-185>185</a>
</span><span class=lnt id=hl-24-186><a class=lnlinks href=#hl-24-186>186</a>
</span><span class=lnt id=hl-24-187><a class=lnlinks href=#hl-24-187>187</a>
</span><span class=lnt id=hl-24-188><a class=lnlinks href=#hl-24-188>188</a>
</span><span class=lnt id=hl-24-189><a class=lnlinks href=#hl-24-189>189</a>
</span><span class=lnt id=hl-24-190><a class=lnlinks href=#hl-24-190>190</a>
</span><span class=lnt id=hl-24-191><a class=lnlinks href=#hl-24-191>191</a>
</span><span class=lnt id=hl-24-192><a class=lnlinks href=#hl-24-192>192</a>
</span><span class=lnt id=hl-24-193><a class=lnlinks href=#hl-24-193>193</a>
</span><span class=lnt id=hl-24-194><a class=lnlinks href=#hl-24-194>194</a>
</span><span class=lnt id=hl-24-195><a class=lnlinks href=#hl-24-195>195</a>
</span><span class=lnt id=hl-24-196><a class=lnlinks href=#hl-24-196>196</a>
</span><span class=lnt id=hl-24-197><a class=lnlinks href=#hl-24-197>197</a>
</span><span class=lnt id=hl-24-198><a class=lnlinks href=#hl-24-198>198</a>
</span><span class=lnt id=hl-24-199><a class=lnlinks href=#hl-24-199>199</a>
</span><span class=lnt id=hl-24-200><a class=lnlinks href=#hl-24-200>200</a>
</span><span class=lnt id=hl-24-201><a class=lnlinks href=#hl-24-201>201</a>
</span><span class=lnt id=hl-24-202><a class=lnlinks href=#hl-24-202>202</a>
</span><span class=lnt id=hl-24-203><a class=lnlinks href=#hl-24-203>203</a>
</span><span class=lnt id=hl-24-204><a class=lnlinks href=#hl-24-204>204</a>
</span><span class=lnt id=hl-24-205><a class=lnlinks href=#hl-24-205>205</a>
</span><span class=lnt id=hl-24-206><a class=lnlinks href=#hl-24-206>206</a>
</span><span class=lnt id=hl-24-207><a class=lnlinks href=#hl-24-207>207</a>
</span><span class=lnt id=hl-24-208><a class=lnlinks href=#hl-24-208>208</a>
</span><span class=lnt id=hl-24-209><a class=lnlinks href=#hl-24-209>209</a>
</span><span class=lnt id=hl-24-210><a class=lnlinks href=#hl-24-210>210</a>
</span><span class=lnt id=hl-24-211><a class=lnlinks href=#hl-24-211>211</a>
</span><span class=lnt id=hl-24-212><a class=lnlinks href=#hl-24-212>212</a>
</span><span class=lnt id=hl-24-213><a class=lnlinks href=#hl-24-213>213</a>
</span><span class=lnt id=hl-24-214><a class=lnlinks href=#hl-24-214>214</a>
</span><span class=lnt id=hl-24-215><a class=lnlinks href=#hl-24-215>215</a>
</span><span class=lnt id=hl-24-216><a class=lnlinks href=#hl-24-216>216</a>
</span><span class=lnt id=hl-24-217><a class=lnlinks href=#hl-24-217>217</a>
</span><span class=lnt id=hl-24-218><a class=lnlinks href=#hl-24-218>218</a>
</span><span class=lnt id=hl-24-219><a class=lnlinks href=#hl-24-219>219</a>
</span><span class=lnt id=hl-24-220><a class=lnlinks href=#hl-24-220>220</a>
</span><span class=lnt id=hl-24-221><a class=lnlinks href=#hl-24-221>221</a>
</span><span class=lnt id=hl-24-222><a class=lnlinks href=#hl-24-222>222</a>
</span><span class=lnt id=hl-24-223><a class=lnlinks href=#hl-24-223>223</a>
</span><span class=lnt id=hl-24-224><a class=lnlinks href=#hl-24-224>224</a>
</span><span class=lnt id=hl-24-225><a class=lnlinks href=#hl-24-225>225</a>
</span><span class=lnt id=hl-24-226><a class=lnlinks href=#hl-24-226>226</a>
</span><span class=lnt id=hl-24-227><a class=lnlinks href=#hl-24-227>227</a>
</span><span class=lnt id=hl-24-228><a class=lnlinks href=#hl-24-228>228</a>
</span><span class=lnt id=hl-24-229><a class=lnlinks href=#hl-24-229>229</a>
</span><span class=lnt id=hl-24-230><a class=lnlinks href=#hl-24-230>230</a>
</span><span class=lnt id=hl-24-231><a class=lnlinks href=#hl-24-231>231</a>
</span><span class=lnt id=hl-24-232><a class=lnlinks href=#hl-24-232>232</a>
</span><span class=lnt id=hl-24-233><a class=lnlinks href=#hl-24-233>233</a>
</span><span class=lnt id=hl-24-234><a class=lnlinks href=#hl-24-234>234</a>
</span><span class=lnt id=hl-24-235><a class=lnlinks href=#hl-24-235>235</a>
</span><span class=lnt id=hl-24-236><a class=lnlinks href=#hl-24-236>236</a>
</span><span class=lnt id=hl-24-237><a class=lnlinks href=#hl-24-237>237</a>
</span><span class=lnt id=hl-24-238><a class=lnlinks href=#hl-24-238>238</a>
</span><span class=lnt id=hl-24-239><a class=lnlinks href=#hl-24-239>239</a>
</span><span class=lnt id=hl-24-240><a class=lnlinks href=#hl-24-240>240</a>
</span><span class=lnt id=hl-24-241><a class=lnlinks href=#hl-24-241>241</a>
</span><span class=lnt id=hl-24-242><a class=lnlinks href=#hl-24-242>242</a>
</span><span class=lnt id=hl-24-243><a class=lnlinks href=#hl-24-243>243</a>
</span><span class=lnt id=hl-24-244><a class=lnlinks href=#hl-24-244>244</a>
</span><span class=lnt id=hl-24-245><a class=lnlinks href=#hl-24-245>245</a>
</span><span class=lnt id=hl-24-246><a class=lnlinks href=#hl-24-246>246</a>
</span><span class=lnt id=hl-24-247><a class=lnlinks href=#hl-24-247>247</a>
</span><span class=lnt id=hl-24-248><a class=lnlinks href=#hl-24-248>248</a>
</span><span class=lnt id=hl-24-249><a class=lnlinks href=#hl-24-249>249</a>
</span><span class=lnt id=hl-24-250><a class=lnlinks href=#hl-24-250>250</a>
</span><span class=lnt id=hl-24-251><a class=lnlinks href=#hl-24-251>251</a>
</span><span class=lnt id=hl-24-252><a class=lnlinks href=#hl-24-252>252</a>
</span><span class=lnt id=hl-24-253><a class=lnlinks href=#hl-24-253>253</a>
</span><span class=lnt id=hl-24-254><a class=lnlinks href=#hl-24-254>254</a>
</span><span class=lnt id=hl-24-255><a class=lnlinks href=#hl-24-255>255</a>
</span><span class=lnt id=hl-24-256><a class=lnlinks href=#hl-24-256>256</a>
</span><span class=lnt id=hl-24-257><a class=lnlinks href=#hl-24-257>257</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>statistics</span> <span class=kn>import</span> <span class=n>mean</span><span class=p>,</span> <span class=n>median</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 공통 메트릭 수집 도우미</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BenchMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;버퍼 내부의 대기/신호 관련 카운터를 수집한다.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waits_on_full</span> <span class=o>=</span> <span class=mi>0</span>    <span class=c1># put 시 버퍼가 가득 차서 기다린 횟수</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waits_on_empty</span> <span class=o>=</span> <span class=mi>0</span>   <span class=c1># get 시 버퍼가 비어서 기다린 횟수</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>inc_full</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waits_on_full</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>inc_empty</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waits_on_empty</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=n>waits_on_full</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>waits_on_full</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>waits_on_empty</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>waits_on_empty</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 공통 인터페이스</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BufferIFace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;put/get 인터페이스만 강제. 구현은 세 가지 스타일로 제공.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>NotImplementedError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 1) Mesa Style (표준) 구현</span>
</span></span><span class=line><span class=cl><span class=c1># - 스퓨리어스 웨이크업 &amp; Mesa 의미론 대응: while 재검사</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MesaBuffer</span><span class=p>(</span><span class=n>BufferIFace</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>capacity</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=n>BenchMetrics</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cap</span> <span class=o>=</span> <span class=n>capacity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>q</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cv</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>metrics</span> <span class=ow>or</span> <span class=n>BenchMetrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=p>:</span>  <span class=c1># CV는 항상 락과 페어</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cap</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>inc_full</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=c1># wait는 원자적으로 unlock→sleep→relock 수행</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 상태 변화(비어있지 않음) 알림: 보통 하나만 깨우는 것이 효율적</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>inc_empty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># 상태 변화(가득참→여유) 알림</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 2) Hoare Style (교육용 시뮬레이션)</span>
</span></span><span class=line><span class=cl><span class=c1># - 실제 파이썬 런타임은 Mesa 시맨틱. urgent 큐를 둬서 &#34;즉시 양도&#34; 느낌을 흉내낸다.</span>
</span></span><span class=line><span class=cl><span class=c1># - 논리: signaler는 urgent 큐로 이동해 대기, waiter가 일을 마치면 urgent.notify()로 깨워 제어권 회수</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HoareSimBuffer</span><span class=p>(</span><span class=n>BufferIFace</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>capacity</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=n>BenchMetrics</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cap</span> <span class=o>=</span> <span class=n>capacity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>q</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>waiters</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>  <span class=c1># 대기자용</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>urgent</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>   <span class=c1># 신호자 복귀 대기열</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>metrics</span> <span class=ow>or</span> <span class=n>BenchMetrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cap</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>inc_full</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>waiters</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 조건 충족 → waiter를 깨우고, &#34;즉시 양도&#34; 시뮬:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waiters</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># signaler는 urgent 큐에서 잠깐 대기하여 waiter가 먼저 달리게 한다.</span>
</span></span><span class=line><span class=cl>            <span class=c1># (임계영역 길이에 따라 오히려 손해일 수 있음 — 교육용!)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>urgent</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># 0으로 스핀 없음, 즉시 리턴 (양도 힌트 효과만)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>inc_empty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>waiters</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>waiters</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># waiter가 일을 마쳤으니 signaler 깨움(제어권 복원 힌트)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>urgent</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 3) Predicate-based Style</span>
</span></span><span class=line><span class=cl><span class=c1># - wait_for(predicate)로 프레디킷 캡슐화 + 내부 while 재검사 자동화</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PredicateBuffer</span><span class=p>(</span><span class=n>BufferIFace</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>capacity</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=n>BenchMetrics</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cap</span> <span class=o>=</span> <span class=n>capacity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>q</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cv</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>metrics</span> <span class=ow>or</span> <span class=n>BenchMetrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_not_full</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>cap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_not_empty</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 실패(타임아웃 없음 가정) 시 False 반환이지만 여기서는 성공할 때까지 대기</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_not_full</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>inc_full</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_not_empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>inc_empty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 벤치마크 러너</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_benchmark</span><span class=p>(</span><span class=n>BufferCls</span><span class=p>,</span> <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>capacity</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>num_producers</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>num_consumers</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>items_per_producer</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>producer_think_s</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>consumer_think_s</span><span class=o>=</span><span class=mf>0.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    동일 인자 하에 BufferCls 구현을 벤치마크한다.
</span></span></span><span class=line><span class=cl><span class=s2>    - 각 아이템은 (t0, payload) 형태로 생산되어 소비 시 지연을 측정한다.
</span></span></span><span class=line><span class=cl><span class=s2>    - 소비자마다 목표 소비 개수를 배분하여 자연 종료하도록 한다.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>BenchMetrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span> <span class=o>=</span> <span class=n>BufferCls</span><span class=p>(</span><span class=n>capacity</span><span class=o>=</span><span class=n>capacity</span><span class=p>,</span> <span class=n>metrics</span><span class=o>=</span><span class=n>metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>total_items</span> <span class=o>=</span> <span class=n>num_producers</span> <span class=o>*</span> <span class=n>items_per_producer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 소비자별 목표 개수 배분(마지막 소비자가 나머지 처리)</span>
</span></span><span class=line><span class=cl>    <span class=n>base</span> <span class=o>=</span> <span class=n>total_items</span> <span class=o>//</span> <span class=n>num_consumers</span>
</span></span><span class=line><span class=cl>    <span class=n>shares</span> <span class=o>=</span> <span class=p>[</span><span class=n>base</span><span class=p>]</span> <span class=o>*</span> <span class=n>num_consumers</span>
</span></span><span class=line><span class=cl>    <span class=n>shares</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+=</span> <span class=n>total_items</span> <span class=o>-</span> <span class=n>base</span> <span class=o>*</span> <span class=n>num_consumers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start_barrier</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Barrier</span><span class=p>(</span><span class=n>num_producers</span> <span class=o>+</span> <span class=n>num_consumers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>latencies</span> <span class=o>=</span> <span class=p>[]</span>            <span class=c1># 전체 지연(ms) 수집</span>
</span></span><span class=line><span class=cl>    <span class=n>lat_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_latency_ms</span><span class=p>(</span><span class=n>t0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>lat_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>latencies</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>t0</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1000.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>pid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>start_barrier</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>items_per_producer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>t0</span><span class=p>,</span> <span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=n>i</span><span class=p>)))</span>  <span class=c1># payload: (producer_id, seq)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>producer_think_s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>producer_think_s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>cid</span><span class=p>,</span> <span class=n>quota</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>start_barrier</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>quota</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>t0</span><span class=p>,</span> <span class=n>payload</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>record_latency_ms</span><span class=p>(</span><span class=n>t0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>consumer_think_s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>consumer_think_s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>producers</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>producer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>p</span><span class=p>,))</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_producers</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>consumers</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>consumer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>shares</span><span class=p>[</span><span class=n>c</span><span class=p>]))</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_consumers</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>t_begin</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>th</span> <span class=ow>in</span> <span class=n>producers</span> <span class=o>+</span> <span class=n>consumers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>th</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>th</span> <span class=ow>in</span> <span class=n>producers</span> <span class=o>+</span> <span class=n>consumers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>th</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t_end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>elapsed</span> <span class=o>=</span> <span class=n>t_end</span> <span class=o>-</span> <span class=n>t_begin</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>snapshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 지연 통계</span>
</span></span><span class=line><span class=cl>    <span class=n>lat_ms</span> <span class=o>=</span> <span class=n>latencies</span> <span class=k>if</span> <span class=n>latencies</span> <span class=k>else</span> <span class=p>[</span><span class=mf>0.0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;total_items&#34;</span><span class=p>:</span> <span class=n>total_items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;elapsed_s&#34;</span><span class=p>:</span> <span class=n>elapsed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;throughput_items_per_s&#34;</span><span class=p>:</span> <span class=n>total_items</span> <span class=o>/</span> <span class=n>elapsed</span> <span class=k>if</span> <span class=n>elapsed</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;latency_ms_avg&#34;</span><span class=p>:</span> <span class=n>mean</span><span class=p>(</span><span class=n>lat_ms</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;latency_ms_p50&#34;</span><span class=p>:</span> <span class=n>median</span><span class=p>(</span><span class=n>lat_ms</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;latency_ms_max&#34;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>lat_ms</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;waits_on_full&#34;</span><span class=p>:</span> <span class=n>m</span><span class=p>[</span><span class=s2>&#34;waits_on_full&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;waits_on_empty&#34;</span><span class=p>:</span> <span class=n>m</span><span class=p>[</span><span class=s2>&#34;waits_on_empty&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl><span class=c1># 실행 예시</span>
</span></span><span class=line><span class=cl><span class=c1># =========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pretty</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>stats</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2> ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;items=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total_items&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, elapsed=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;elapsed_s&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>s, &#34;</span>
</span></span><span class=line><span class=cl>          <span class=sa>f</span><span class=s2>&#34;throughput=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;throughput_items_per_s&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>/s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;latency(ms): avg=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;latency_ms_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>, &#34;</span>
</span></span><span class=line><span class=cl>          <span class=sa>f</span><span class=s2>&#34;p50=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;latency_ms_p50&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>, max=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;latency_ms_max&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;waits: on_full=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;waits_on_full&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, on_empty=</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;waits_on_empty&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 벤치마크 파라미터</span>
</span></span><span class=line><span class=cl>    <span class=n>CAP</span> <span class=o>=</span> <span class=mi>64</span>
</span></span><span class=line><span class=cl>    <span class=n>NP</span><span class=p>,</span> <span class=n>NC</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>ITEMS_PER_PROD</span> <span class=o>=</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>    <span class=n>P_THINK</span><span class=p>,</span> <span class=n>C_THINK</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>=</span> <span class=n>run_benchmark</span><span class=p>(</span><span class=n>MesaBuffer</span><span class=p>,</span> <span class=n>capacity</span><span class=o>=</span><span class=n>CAP</span><span class=p>,</span> <span class=n>num_producers</span><span class=o>=</span><span class=n>NP</span><span class=p>,</span> <span class=n>num_consumers</span><span class=o>=</span><span class=n>NC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>items_per_producer</span><span class=o>=</span><span class=n>ITEMS_PER_PROD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>producer_think_s</span><span class=o>=</span><span class=n>P_THINK</span><span class=p>,</span> <span class=n>consumer_think_s</span><span class=o>=</span><span class=n>C_THINK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pretty</span><span class=p>(</span><span class=s2>&#34;Mesa (표준 while 재검사)&#34;</span><span class=p>,</span> <span class=n>s1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>s2</span> <span class=o>=</span> <span class=n>run_benchmark</span><span class=p>(</span><span class=n>HoareSimBuffer</span><span class=p>,</span> <span class=n>capacity</span><span class=o>=</span><span class=n>CAP</span><span class=p>,</span> <span class=n>num_producers</span><span class=o>=</span><span class=n>NP</span><span class=p>,</span> <span class=n>num_consumers</span><span class=o>=</span><span class=n>NC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>items_per_producer</span><span class=o>=</span><span class=n>ITEMS_PER_PROD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>producer_think_s</span><span class=o>=</span><span class=n>P_THINK</span><span class=p>,</span> <span class=n>consumer_think_s</span><span class=o>=</span><span class=n>C_THINK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pretty</span><span class=p>(</span><span class=s2>&#34;Hoare (교육용 시뮬레이션)&#34;</span><span class=p>,</span> <span class=n>s2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>s3</span> <span class=o>=</span> <span class=n>run_benchmark</span><span class=p>(</span><span class=n>PredicateBuffer</span><span class=p>,</span> <span class=n>capacity</span><span class=o>=</span><span class=n>CAP</span><span class=p>,</span> <span class=n>num_producers</span><span class=o>=</span><span class=n>NP</span><span class=p>,</span> <span class=n>num_consumers</span><span class=o>=</span><span class=n>NC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>items_per_producer</span><span class=o>=</span><span class=n>ITEMS_PER_PROD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>producer_think_s</span><span class=o>=</span><span class=n>P_THINK</span><span class=p>,</span> <span class=n>consumer_think_s</span><span class=o>=</span><span class=n>C_THINK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pretty</span><span class=p>(</span><span class=s2>&#34;Predicate(wait_for)&#34;</span><span class=p>,</span> <span class=n>s3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=분류-기준에-따른-유형-구분>분류 기준에 따른 유형 구분<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-유형-구분>#</a></h4><table><thead><tr><th>분류 기준</th><th>유형</th><th>특징</th><th>사용 사례</th><th>구현/API 예시</th></tr></thead><tbody><tr><td><strong>대기 대상</strong></td><td>단일 조건</td><td>하나의 불변식 감시</td><td>not_empty</td><td><code>cv.wait(lock, pred)</code></td></tr><tr><td></td><td>다중 조건</td><td>서로 다른 불변식 각각 감시</td><td>not_empty + not_full</td><td>CV 2 개 운용</td></tr><tr><td><strong>깨우기 범위</strong></td><td>Signal</td><td>하나의 스레드만 깨움</td><td>단일 소비자 큐</td><td><code>notify_one()</code></td></tr><tr><td></td><td>Broadcast</td><td>모든 대기 스레드 깨움</td><td>Barrier, 상태 대규모 변경</td><td><code>notify_all()</code></td></tr><tr><td><strong>대기 방식</strong></td><td>무제한 대기</td><td>조건 만족까지 블록</td><td>데몬성 워커</td><td><code>wait(lock)</code></td></tr><tr><td></td><td>타임아웃 대기</td><td>지정 시간까지만 대기</td><td>네트워크 응답 대기</td><td><code>wait_for</code>, <code>wait_until</code></td></tr><tr><td><strong>조건 검사 방식</strong></td><td>명시적 검사</td><td>while + predicate</td><td>전통적 구현</td><td><code>while(!pred) cv.wait(lock);</code></td></tr><tr><td></td><td>Predicate 기반</td><td>API 에 조건 전달</td><td>현대적 구현</td><td><code>cv.wait(lock, pred)</code></td></tr><tr><td><strong>락 호환성</strong></td><td>표준 CV</td><td><code>std::mutex</code> 전용</td><td>대부분 시나리오</td><td><code>std::condition_variable</code></td></tr><tr><td></td><td>범용 CV</td><td>임의의 락 지원</td><td>커스텀 락 환경</td><td><code>std::condition_variable_any</code></td></tr><tr><td><strong>우선순위 처리</strong></td><td>FIFO</td><td>등록 순서대로 깨움</td><td>공정성 중시</td><td>OS/RTOS 큐 정책</td></tr><tr><td></td><td>Priority</td><td>우선순위 높은 스레드 우선</td><td>실시간 처리</td><td>우선순위 큐 구현</td></tr></tbody></table><p>조건 변수 유형은 <strong>대기 조건의 수 (단일/다중)</strong>, <strong>신호 범위 (단일/다중)</strong>, <strong>대기 시간 제어 (무제한/타임아웃)</strong>, <strong>조건 검사 방식 (명시적/predicate 기반)</strong>, <strong>락 호환성 (표준/범용)</strong>, **우선순위 처리 (FIFO/우선순위)**로 구분할 수 있다.<br>실무에서는 notEmpty/notFull 처럼 <strong>다중 조건 분리</strong>, 기본은 <strong>notify_one</strong>, 이벤트 확산 시 <strong>notify_all</strong>을 사용하며, 타임아웃은 장애 전파와 응답성 확보에 필수다.<br>또한, 스푸리어스 웨이크업 방지를 위해 <strong>predicate 기반 wait</strong>을 권장하고, 락 환경에 따라 <code>condition_variable_any</code> 선택이 필요하다. 우선순위 처리는 실시간성 요구 시 커스텀 구현이 요구된다.</p><h3 id=실무-적용-practical-application>실무 적용 (Practical Application)<a hidden class=anchor aria-hidden=true href=#실무-적용-practical-application>#</a></h3><h4 id=실제-도입-사례>실제 도입 사례<a hidden class=anchor aria-hidden=true href=#실제-도입-사례>#</a></h4><p>조건 변수는 다양한 산업 분야에서 스레드 간 효율적인 동기화를 위해 활용된다.<br>데이터베이스 연결 풀과 버퍼 관리에서는 자원이 없을 때 스레드를 대기시키고, 자원이 반환되면 즉시 깨워 처리 속도를 높인다.<br>작업 큐·메시지 큐·웹 서버 요청 처리에서는 유휴 스레드의 CPU 사용을 최소화하면서 요청 폭증 시 부하를 분산한다.<br>실시간 게임 엔진과 네트워크 패킷 처리에서는 프레임 동기화·데이터 수신 시 즉시 반응성을 보장한다.<br>또한 스트리밍·프린터 스풀러·파일 처리 파이프라인 등에서는 생산자 - 소비자 간의 부드러운 흐름 제어와 역압 (backpressure) 을 구현한다.</p><table><thead><tr><th>분야</th><th>사례</th><th>조합 기술</th><th>효과</th></tr></thead><tbody><tr><td>DB/버퍼 관리</td><td>DB 연결 풀, DB 버퍼 풀</td><td>Mutex + Condition Variable</td><td>연결·버퍼 자원 효율적 사용, 대기·깨움 제어</td></tr><tr><td>작업 관리</td><td>Thread Pool 작업 큐, 메시지 큐</td><td>Work Queue + Condition Variable</td><td>유휴 CPU 사용 최소화, 부하 분산</td></tr><tr><td>웹 서버</td><td>Apache, Nginx 요청 처리</td><td>Thread Pool + Condition Variable</td><td>요청 폭증 시 부하 분산, 응답 일관성 향상</td></tr><tr><td>실시간 처리</td><td>Unity, Unreal Frame Sync</td><td>Frame Sync + Task System + Condition Variable</td><td>프레임률 안정성, 지연 최소화</td></tr><tr><td>네트워크</td><td>패킷 수신 처리</td><td>Socket Buffer + Condition Variable</td><td>데이터 도착 시 즉시 처리</td></tr><tr><td>미디어 처리</td><td>동영상 스트리밍 버퍼</td><td>Decoder/Renderer + Condition Variable</td><td>끊김 없는 재생, 버퍼 관리 최적화</td></tr><tr><td>장치 제어</td><td>프린터 스풀러</td><td>Job Queue + Condition Variable</td><td>인쇄 작업 흐름 제어, 자원 낭비 방지</td></tr><tr><td>파이프라인</td><td>파일 처리 파이프라인, 역압 구현</td><td>Stage Buffer + Condition Variable</td><td>생산·소비 균형, 메모리 사용 최적화</td></tr><tr><td>제어 로직</td><td>레이트 리밋 토큰 버킷</td><td>Token Bucket + Condition Variable</td><td>요청 처리 속도 제어, 서비스 안정성</td></tr></tbody></table><p>조건 변수의 실제 도입 사례를 보면 **&rdquo; 상태 변화 시점에만 스레드 활성화 &ldquo;**라는 핵심 원리가 공통적으로 적용된다.<br>이는 CPU 와 메모리 사용을 최소화하면서도 필요한 순간에 즉각적으로 반응할 수 있는 구조를 만든다.<br>특히 생산자 - 소비자 패턴, 이벤트 기반 처리, 실시간 동기화 시나리오에 강력하며, 복잡한 동기화 로직을 단순화하는 장점이 있다.<br>다만 잘못 사용하면 데드락, 스푸리어스 웨이크업, 신호 손실 등 문제가 발생할 수 있으므로 설계 원칙과 모니터링 체계를 반드시 병행해야 한다.</p><h4 id=실습-예제-및-코드-구현>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현>#</a></h4><h5 id=사례-고정-크기-바운디드-큐-기반-생산자---소비자>사례: 고정 크기 바운디드 큐 기반 생산자 - 소비자<a hidden class=anchor aria-hidden=true href=#사례-고정-크기-바운디드-큐-기반-생산자---소비자>#</a></h5><p><strong>시나리오</strong>: 고정 크기 <strong>바운디드 큐</strong> 기반 생산자 - 소비자</p><p><strong>시스템 구성</strong>:</p><ul><li>Producer(s), Consumer(s), BoundedBuffer(상태 + 뮤텍스 +CV)</li></ul><pre class=mermaid>graph TB
    P1[Producer] --&gt; B[&#34;BoundedBuffer (mutex+CV)&#34;]
    P2[Producer] --&gt; B
    B --&gt; C1[Consumer]
    B --&gt; C2[Consumer]
</pre><p><strong>Workflow</strong>:</p><ol><li>소비자: <code>while empty: not_empty.wait()</code></li><li>생산자: <code>while full: not_full.wait()</code></li><li>생산자 <code>enqueue</code> 후 <code>not_empty.signal()</code></li><li>소비자 <code>dequeue</code> 후 <code>not_full.signal()</code></li></ol><p><strong>핵심 역할</strong>:</p><ul><li>조건 변수: <code>not_empty</code>, <code>not_full</code></li><li>뮤텍스: 버퍼 상태 보호</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 폴링/슬립 루프, CPU 낭비</li><li>도입 후: 이벤트 기반 대기, 안정적 지연시간</li></ul><p><strong>구현 예시</strong>: Python (threading.Condition)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1> 1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2> 2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3> 3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4> 4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5> 5</a>
</span><span class=lnt id=hl-26-6><a class=lnlinks href=#hl-26-6> 6</a>
</span><span class=lnt id=hl-26-7><a class=lnlinks href=#hl-26-7> 7</a>
</span><span class=lnt id=hl-26-8><a class=lnlinks href=#hl-26-8> 8</a>
</span><span class=lnt id=hl-26-9><a class=lnlinks href=#hl-26-9> 9</a>
</span><span class=lnt id=hl-26-10><a class=lnlinks href=#hl-26-10>10</a>
</span><span class=lnt id=hl-26-11><a class=lnlinks href=#hl-26-11>11</a>
</span><span class=lnt id=hl-26-12><a class=lnlinks href=#hl-26-12>12</a>
</span><span class=lnt id=hl-26-13><a class=lnlinks href=#hl-26-13>13</a>
</span><span class=lnt id=hl-26-14><a class=lnlinks href=#hl-26-14>14</a>
</span><span class=lnt id=hl-26-15><a class=lnlinks href=#hl-26-15>15</a>
</span><span class=lnt id=hl-26-16><a class=lnlinks href=#hl-26-16>16</a>
</span><span class=lnt id=hl-26-17><a class=lnlinks href=#hl-26-17>17</a>
</span><span class=lnt id=hl-26-18><a class=lnlinks href=#hl-26-18>18</a>
</span><span class=lnt id=hl-26-19><a class=lnlinks href=#hl-26-19>19</a>
</span><span class=lnt id=hl-26-20><a class=lnlinks href=#hl-26-20>20</a>
</span><span class=lnt id=hl-26-21><a class=lnlinks href=#hl-26-21>21</a>
</span><span class=lnt id=hl-26-22><a class=lnlinks href=#hl-26-22>22</a>
</span><span class=lnt id=hl-26-23><a class=lnlinks href=#hl-26-23>23</a>
</span><span class=lnt id=hl-26-24><a class=lnlinks href=#hl-26-24>24</a>
</span><span class=lnt id=hl-26-25><a class=lnlinks href=#hl-26-25>25</a>
</span><span class=lnt id=hl-26-26><a class=lnlinks href=#hl-26-26>26</a>
</span><span class=lnt id=hl-26-27><a class=lnlinks href=#hl-26-27>27</a>
</span><span class=lnt id=hl-26-28><a class=lnlinks href=#hl-26-28>28</a>
</span><span class=lnt id=hl-26-29><a class=lnlinks href=#hl-26-29>29</a>
</span><span class=lnt id=hl-26-30><a class=lnlinks href=#hl-26-30>30</a>
</span><span class=lnt id=hl-26-31><a class=lnlinks href=#hl-26-31>31</a>
</span><span class=lnt id=hl-26-32><a class=lnlinks href=#hl-26-32>32</a>
</span><span class=lnt id=hl-26-33><a class=lnlinks href=#hl-26-33>33</a>
</span><span class=lnt id=hl-26-34><a class=lnlinks href=#hl-26-34>34</a>
</span><span class=lnt id=hl-26-35><a class=lnlinks href=#hl-26-35>35</a>
</span><span class=lnt id=hl-26-36><a class=lnlinks href=#hl-26-36>36</a>
</span><span class=lnt id=hl-26-37><a class=lnlinks href=#hl-26-37>37</a>
</span><span class=lnt id=hl-26-38><a class=lnlinks href=#hl-26-38>38</a>
</span><span class=lnt id=hl-26-39><a class=lnlinks href=#hl-26-39>39</a>
</span><span class=lnt id=hl-26-40><a class=lnlinks href=#hl-26-40>40</a>
</span><span class=lnt id=hl-26-41><a class=lnlinks href=#hl-26-41>41</a>
</span><span class=lnt id=hl-26-42><a class=lnlinks href=#hl-26-42>42</a>
</span><span class=lnt id=hl-26-43><a class=lnlinks href=#hl-26-43>43</a>
</span><span class=lnt id=hl-26-44><a class=lnlinks href=#hl-26-44>44</a>
</span><span class=lnt id=hl-26-45><a class=lnlinks href=#hl-26-45>45</a>
</span><span class=lnt id=hl-26-46><a class=lnlinks href=#hl-26-46>46</a>
</span><span class=lnt id=hl-26-47><a class=lnlinks href=#hl-26-47>47</a>
</span><span class=lnt id=hl-26-48><a class=lnlinks href=#hl-26-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BoundedBuffer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>capacity</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>capacity</span> <span class=o>=</span> <span class=n>capacity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>q</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># while 재검사로 스푸리어스 웨이크업/레이스 방지</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>capacity</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>TimeoutError</span><span class=p>(</span><span class=s2>&#34;put timed out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 상태 변경 후 신호</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>TimeoutError</span><span class=p>(</span><span class=s2>&#34;get timed out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=n>buf</span><span class=p>:</span> <span class=n>BoundedBuffer</span><span class=p>,</span> <span class=n>pid</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>buf</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 관측성: 간단한 로그</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[P</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>] produced </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2> (size=</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>buf</span><span class=o>.</span><span class=n>q</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=o>*</span> <span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=n>buf</span><span class=p>:</span> <span class=n>BoundedBuffer</span><span class=p>,</span> <span class=n>cid</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[C</span><span class=si>{</span><span class=n>cid</span><span class=si>}</span><span class=s2>] consumed </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2> (size=</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>buf</span><span class=o>.</span><span class=n>q</span><span class=p>)</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=o>*</span> <span class=mf>0.08</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span> <span class=o>=</span> <span class=n>BoundedBuffer</span><span class=p>(</span><span class=n>capacity</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>producer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>p</span><span class=p>))</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)]</span> <span class=o>+</span> \
</span></span><span class=line><span class=cl>              <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>consumer</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>c</span><span class=p>))</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-생산자---소비자-문제-해결>사례: 생산자 - 소비자 문제 해결<a hidden class=anchor aria-hidden=true href=#사례-생산자---소비자-문제-해결>#</a></h5><p><strong>시나리오</strong>: 생산자 - 소비자 문제 해결</p><p><strong>시스템 구성</strong>:</p><ul><li>생산자 쓰레드: 데이터 생성 후 signal</li><li>소비자 쓰레드: 데이터 없으면 wait</li></ul><pre class=mermaid>graph TB
    Producer --&gt;|signal| ConditionVariable
    Consumer --&gt;|wait| ConditionVariable
    ConditionVariable --&gt; SharedQueue
</pre><p><strong>Workflow</strong>:</p><ol><li>소비자: 큐 비어있으면 wait</li><li>생산자: 데이터 넣고 signal</li><li>소비자: 깨어나서 데이터 소비</li></ol><p><strong>구현 예시 (Python)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a class=lnlinks href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a class=lnlinks href=#hl-28-18>18</a>
</span><span class=lnt id=hl-28-19><a class=lnlinks href=#hl-28-19>19</a>
</span><span class=lnt id=hl-28-20><a class=lnlinks href=#hl-28-20>20</a>
</span><span class=lnt id=hl-28-21><a class=lnlinks href=#hl-28-21>21</a>
</span><span class=lnt id=hl-28-22><a class=lnlinks href=#hl-28-22>22</a>
</span><span class=lnt id=hl-28-23><a class=lnlinks href=#hl-28-23>23</a>
</span><span class=lnt id=hl-28-24><a class=lnlinks href=#hl-28-24>24</a>
</span><span class=lnt id=hl-28-25><a class=lnlinks href=#hl-28-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>queue</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>condition</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consumer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>condition</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># 조건이 만족될 때까지 대기</span>
</span></span><span class=line><span class=cl>            <span class=n>item</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Consumed: </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>producer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Produced: </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>condition</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>consumer</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>producer</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-멀티스레드-로그-수집-시스템>사례: 멀티스레드 로그 수집 시스템<a hidden class=anchor aria-hidden=true href=#사례-멀티스레드-로그-수집-시스템>#</a></h5><p><strong>시나리오</strong>: 멀티스레드 로그 수집 시스템<br><strong>시스템 구성</strong>:</p><ul><li>여러 로그 생성 스레드 (Producer)</li><li>단일 로그 처리 스레드 (Consumer)</li><li>원형 버퍼 (Circular Buffer)</li><li>조건 변수 기반 동기화</li></ul><pre class=mermaid>graph TB
    subgraph &#34;Log Collection System&#34;
        LP1[Log Producer 1]
        LP2[Log Producer 2]
        LP3[Log Producer N]
        
        subgraph &#34;Synchronization&#34;
            CB[Circular Buffer]
            CV1[NotFull Condition]
            CV2[NotEmpty Condition]
            M[Mutex]
        end
        
        LC[Log Consumer]
        FS[File System]
    end
    
    LP1 --&gt; CB
    LP2 --&gt; CB
    LP3 --&gt; CB
    CB --&gt; LC
    LC --&gt; FS
    
    CV1 -.-&gt; LP1
    CV1 -.-&gt; LP2
    CV1 -.-&gt; LP3
    CV2 -.-&gt; LC
</pre><p><strong>Workflow</strong>:</p><ol><li>각 로그 생성 스레드가 로그 메시지 생성</li><li>버퍼 가득 참 시 notFull 조건 변수에서 대기</li><li>로그 처리 스레드가 버퍼에서 메시지 추출</li><li>버퍼 비어있음 시 notEmpty 조건 변수에서 대기</li><li>처리된 로그를 파일 시스템에 기록</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>조건 변수가 생산자 - 소비자 간 효율적 동기화 담당</li><li>버퍼 상태 변화 시 적절한 스레드만 선택적 깨우기</li><li>시스템 자원 사용량 최적화</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 폴링 기반 상태 확인으로 CPU 낭비 발생</li><li><strong>도입 후</strong>: 이벤트 기반 처리로 효율적 자원 활용</li></ul><p><strong>구현 예시</strong> (Python):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1>  1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2>  2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3>  3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4>  4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5>  5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6>  6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7>  7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8>  8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9>  9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10> 10</a>
</span><span class=lnt id=hl-30-11><a class=lnlinks href=#hl-30-11> 11</a>
</span><span class=lnt id=hl-30-12><a class=lnlinks href=#hl-30-12> 12</a>
</span><span class=lnt id=hl-30-13><a class=lnlinks href=#hl-30-13> 13</a>
</span><span class=lnt id=hl-30-14><a class=lnlinks href=#hl-30-14> 14</a>
</span><span class=lnt id=hl-30-15><a class=lnlinks href=#hl-30-15> 15</a>
</span><span class=lnt id=hl-30-16><a class=lnlinks href=#hl-30-16> 16</a>
</span><span class=lnt id=hl-30-17><a class=lnlinks href=#hl-30-17> 17</a>
</span><span class=lnt id=hl-30-18><a class=lnlinks href=#hl-30-18> 18</a>
</span><span class=lnt id=hl-30-19><a class=lnlinks href=#hl-30-19> 19</a>
</span><span class=lnt id=hl-30-20><a class=lnlinks href=#hl-30-20> 20</a>
</span><span class=lnt id=hl-30-21><a class=lnlinks href=#hl-30-21> 21</a>
</span><span class=lnt id=hl-30-22><a class=lnlinks href=#hl-30-22> 22</a>
</span><span class=lnt id=hl-30-23><a class=lnlinks href=#hl-30-23> 23</a>
</span><span class=lnt id=hl-30-24><a class=lnlinks href=#hl-30-24> 24</a>
</span><span class=lnt id=hl-30-25><a class=lnlinks href=#hl-30-25> 25</a>
</span><span class=lnt id=hl-30-26><a class=lnlinks href=#hl-30-26> 26</a>
</span><span class=lnt id=hl-30-27><a class=lnlinks href=#hl-30-27> 27</a>
</span><span class=lnt id=hl-30-28><a class=lnlinks href=#hl-30-28> 28</a>
</span><span class=lnt id=hl-30-29><a class=lnlinks href=#hl-30-29> 29</a>
</span><span class=lnt id=hl-30-30><a class=lnlinks href=#hl-30-30> 30</a>
</span><span class=lnt id=hl-30-31><a class=lnlinks href=#hl-30-31> 31</a>
</span><span class=lnt id=hl-30-32><a class=lnlinks href=#hl-30-32> 32</a>
</span><span class=lnt id=hl-30-33><a class=lnlinks href=#hl-30-33> 33</a>
</span><span class=lnt id=hl-30-34><a class=lnlinks href=#hl-30-34> 34</a>
</span><span class=lnt id=hl-30-35><a class=lnlinks href=#hl-30-35> 35</a>
</span><span class=lnt id=hl-30-36><a class=lnlinks href=#hl-30-36> 36</a>
</span><span class=lnt id=hl-30-37><a class=lnlinks href=#hl-30-37> 37</a>
</span><span class=lnt id=hl-30-38><a class=lnlinks href=#hl-30-38> 38</a>
</span><span class=lnt id=hl-30-39><a class=lnlinks href=#hl-30-39> 39</a>
</span><span class=lnt id=hl-30-40><a class=lnlinks href=#hl-30-40> 40</a>
</span><span class=lnt id=hl-30-41><a class=lnlinks href=#hl-30-41> 41</a>
</span><span class=lnt id=hl-30-42><a class=lnlinks href=#hl-30-42> 42</a>
</span><span class=lnt id=hl-30-43><a class=lnlinks href=#hl-30-43> 43</a>
</span><span class=lnt id=hl-30-44><a class=lnlinks href=#hl-30-44> 44</a>
</span><span class=lnt id=hl-30-45><a class=lnlinks href=#hl-30-45> 45</a>
</span><span class=lnt id=hl-30-46><a class=lnlinks href=#hl-30-46> 46</a>
</span><span class=lnt id=hl-30-47><a class=lnlinks href=#hl-30-47> 47</a>
</span><span class=lnt id=hl-30-48><a class=lnlinks href=#hl-30-48> 48</a>
</span><span class=lnt id=hl-30-49><a class=lnlinks href=#hl-30-49> 49</a>
</span><span class=lnt id=hl-30-50><a class=lnlinks href=#hl-30-50> 50</a>
</span><span class=lnt id=hl-30-51><a class=lnlinks href=#hl-30-51> 51</a>
</span><span class=lnt id=hl-30-52><a class=lnlinks href=#hl-30-52> 52</a>
</span><span class=lnt id=hl-30-53><a class=lnlinks href=#hl-30-53> 53</a>
</span><span class=lnt id=hl-30-54><a class=lnlinks href=#hl-30-54> 54</a>
</span><span class=lnt id=hl-30-55><a class=lnlinks href=#hl-30-55> 55</a>
</span><span class=lnt id=hl-30-56><a class=lnlinks href=#hl-30-56> 56</a>
</span><span class=lnt id=hl-30-57><a class=lnlinks href=#hl-30-57> 57</a>
</span><span class=lnt id=hl-30-58><a class=lnlinks href=#hl-30-58> 58</a>
</span><span class=lnt id=hl-30-59><a class=lnlinks href=#hl-30-59> 59</a>
</span><span class=lnt id=hl-30-60><a class=lnlinks href=#hl-30-60> 60</a>
</span><span class=lnt id=hl-30-61><a class=lnlinks href=#hl-30-61> 61</a>
</span><span class=lnt id=hl-30-62><a class=lnlinks href=#hl-30-62> 62</a>
</span><span class=lnt id=hl-30-63><a class=lnlinks href=#hl-30-63> 63</a>
</span><span class=lnt id=hl-30-64><a class=lnlinks href=#hl-30-64> 64</a>
</span><span class=lnt id=hl-30-65><a class=lnlinks href=#hl-30-65> 65</a>
</span><span class=lnt id=hl-30-66><a class=lnlinks href=#hl-30-66> 66</a>
</span><span class=lnt id=hl-30-67><a class=lnlinks href=#hl-30-67> 67</a>
</span><span class=lnt id=hl-30-68><a class=lnlinks href=#hl-30-68> 68</a>
</span><span class=lnt id=hl-30-69><a class=lnlinks href=#hl-30-69> 69</a>
</span><span class=lnt id=hl-30-70><a class=lnlinks href=#hl-30-70> 70</a>
</span><span class=lnt id=hl-30-71><a class=lnlinks href=#hl-30-71> 71</a>
</span><span class=lnt id=hl-30-72><a class=lnlinks href=#hl-30-72> 72</a>
</span><span class=lnt id=hl-30-73><a class=lnlinks href=#hl-30-73> 73</a>
</span><span class=lnt id=hl-30-74><a class=lnlinks href=#hl-30-74> 74</a>
</span><span class=lnt id=hl-30-75><a class=lnlinks href=#hl-30-75> 75</a>
</span><span class=lnt id=hl-30-76><a class=lnlinks href=#hl-30-76> 76</a>
</span><span class=lnt id=hl-30-77><a class=lnlinks href=#hl-30-77> 77</a>
</span><span class=lnt id=hl-30-78><a class=lnlinks href=#hl-30-78> 78</a>
</span><span class=lnt id=hl-30-79><a class=lnlinks href=#hl-30-79> 79</a>
</span><span class=lnt id=hl-30-80><a class=lnlinks href=#hl-30-80> 80</a>
</span><span class=lnt id=hl-30-81><a class=lnlinks href=#hl-30-81> 81</a>
</span><span class=lnt id=hl-30-82><a class=lnlinks href=#hl-30-82> 82</a>
</span><span class=lnt id=hl-30-83><a class=lnlinks href=#hl-30-83> 83</a>
</span><span class=lnt id=hl-30-84><a class=lnlinks href=#hl-30-84> 84</a>
</span><span class=lnt id=hl-30-85><a class=lnlinks href=#hl-30-85> 85</a>
</span><span class=lnt id=hl-30-86><a class=lnlinks href=#hl-30-86> 86</a>
</span><span class=lnt id=hl-30-87><a class=lnlinks href=#hl-30-87> 87</a>
</span><span class=lnt id=hl-30-88><a class=lnlinks href=#hl-30-88> 88</a>
</span><span class=lnt id=hl-30-89><a class=lnlinks href=#hl-30-89> 89</a>
</span><span class=lnt id=hl-30-90><a class=lnlinks href=#hl-30-90> 90</a>
</span><span class=lnt id=hl-30-91><a class=lnlinks href=#hl-30-91> 91</a>
</span><span class=lnt id=hl-30-92><a class=lnlinks href=#hl-30-92> 92</a>
</span><span class=lnt id=hl-30-93><a class=lnlinks href=#hl-30-93> 93</a>
</span><span class=lnt id=hl-30-94><a class=lnlinks href=#hl-30-94> 94</a>
</span><span class=lnt id=hl-30-95><a class=lnlinks href=#hl-30-95> 95</a>
</span><span class=lnt id=hl-30-96><a class=lnlinks href=#hl-30-96> 96</a>
</span><span class=lnt id=hl-30-97><a class=lnlinks href=#hl-30-97> 97</a>
</span><span class=lnt id=hl-30-98><a class=lnlinks href=#hl-30-98> 98</a>
</span><span class=lnt id=hl-30-99><a class=lnlinks href=#hl-30-99> 99</a>
</span><span class=lnt id=hl-30-100><a class=lnlinks href=#hl-30-100>100</a>
</span><span class=lnt id=hl-30-101><a class=lnlinks href=#hl-30-101>101</a>
</span><span class=lnt id=hl-30-102><a class=lnlinks href=#hl-30-102>102</a>
</span><span class=lnt id=hl-30-103><a class=lnlinks href=#hl-30-103>103</a>
</span><span class=lnt id=hl-30-104><a class=lnlinks href=#hl-30-104>104</a>
</span><span class=lnt id=hl-30-105><a class=lnlinks href=#hl-30-105>105</a>
</span><span class=lnt id=hl-30-106><a class=lnlinks href=#hl-30-106>106</a>
</span><span class=lnt id=hl-30-107><a class=lnlinks href=#hl-30-107>107</a>
</span><span class=lnt id=hl-30-108><a class=lnlinks href=#hl-30-108>108</a>
</span><span class=lnt id=hl-30-109><a class=lnlinks href=#hl-30-109>109</a>
</span><span class=lnt id=hl-30-110><a class=lnlinks href=#hl-30-110>110</a>
</span><span class=lnt id=hl-30-111><a class=lnlinks href=#hl-30-111>111</a>
</span><span class=lnt id=hl-30-112><a class=lnlinks href=#hl-30-112>112</a>
</span><span class=lnt id=hl-30-113><a class=lnlinks href=#hl-30-113>113</a>
</span><span class=lnt id=hl-30-114><a class=lnlinks href=#hl-30-114>114</a>
</span><span class=lnt id=hl-30-115><a class=lnlinks href=#hl-30-115>115</a>
</span><span class=lnt id=hl-30-116><a class=lnlinks href=#hl-30-116>116</a>
</span><span class=lnt id=hl-30-117><a class=lnlinks href=#hl-30-117>117</a>
</span><span class=lnt id=hl-30-118><a class=lnlinks href=#hl-30-118>118</a>
</span><span class=lnt id=hl-30-119><a class=lnlinks href=#hl-30-119>119</a>
</span><span class=lnt id=hl-30-120><a class=lnlinks href=#hl-30-120>120</a>
</span><span class=lnt id=hl-30-121><a class=lnlinks href=#hl-30-121>121</a>
</span><span class=lnt id=hl-30-122><a class=lnlinks href=#hl-30-122>122</a>
</span><span class=lnt id=hl-30-123><a class=lnlinks href=#hl-30-123>123</a>
</span><span class=lnt id=hl-30-124><a class=lnlinks href=#hl-30-124>124</a>
</span><span class=lnt id=hl-30-125><a class=lnlinks href=#hl-30-125>125</a>
</span><span class=lnt id=hl-30-126><a class=lnlinks href=#hl-30-126>126</a>
</span><span class=lnt id=hl-30-127><a class=lnlinks href=#hl-30-127>127</a>
</span><span class=lnt id=hl-30-128><a class=lnlinks href=#hl-30-128>128</a>
</span><span class=lnt id=hl-30-129><a class=lnlinks href=#hl-30-129>129</a>
</span><span class=lnt id=hl-30-130><a class=lnlinks href=#hl-30-130>130</a>
</span><span class=lnt id=hl-30-131><a class=lnlinks href=#hl-30-131>131</a>
</span><span class=lnt id=hl-30-132><a class=lnlinks href=#hl-30-132>132</a>
</span><span class=lnt id=hl-30-133><a class=lnlinks href=#hl-30-133>133</a>
</span><span class=lnt id=hl-30-134><a class=lnlinks href=#hl-30-134>134</a>
</span><span class=lnt id=hl-30-135><a class=lnlinks href=#hl-30-135>135</a>
</span><span class=lnt id=hl-30-136><a class=lnlinks href=#hl-30-136>136</a>
</span><span class=lnt id=hl-30-137><a class=lnlinks href=#hl-30-137>137</a>
</span><span class=lnt id=hl-30-138><a class=lnlinks href=#hl-30-138>138</a>
</span><span class=lnt id=hl-30-139><a class=lnlinks href=#hl-30-139>139</a>
</span><span class=lnt id=hl-30-140><a class=lnlinks href=#hl-30-140>140</a>
</span><span class=lnt id=hl-30-141><a class=lnlinks href=#hl-30-141>141</a>
</span><span class=lnt id=hl-30-142><a class=lnlinks href=#hl-30-142>142</a>
</span><span class=lnt id=hl-30-143><a class=lnlinks href=#hl-30-143>143</a>
</span><span class=lnt id=hl-30-144><a class=lnlinks href=#hl-30-144>144</a>
</span><span class=lnt id=hl-30-145><a class=lnlinks href=#hl-30-145>145</a>
</span><span class=lnt id=hl-30-146><a class=lnlinks href=#hl-30-146>146</a>
</span><span class=lnt id=hl-30-147><a class=lnlinks href=#hl-30-147>147</a>
</span><span class=lnt id=hl-30-148><a class=lnlinks href=#hl-30-148>148</a>
</span><span class=lnt id=hl-30-149><a class=lnlinks href=#hl-30-149>149</a>
</span><span class=lnt id=hl-30-150><a class=lnlinks href=#hl-30-150>150</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LogBuffer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;조건 변수를 활용한 로그 버퍼&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_size</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span> <span class=o>=</span> <span class=n>max_size</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 조건 변수들과 연관된 뮤텍스</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mutex</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mutex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mutex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>running</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>produce_log</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>log_message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;로그 메시지 생성 (Producer)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=p>:</span>  <span class=c1># 뮤텍스 자동 획득</span>
</span></span><span class=line><span class=cl>            <span class=c1># Mesa 스타일: while 루프로 조건 재검사</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>running</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Buffer full, producer waiting…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># 버퍼에 공간 생길 때까지 대기</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>running</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 타임스탬프와 함께 로그 저장</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamped_log</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=n>log_message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;thread_id&#39;</span><span class=p>:</span> <span class=n>threading</span><span class=o>.</span><span class=n>get_ident</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>timestamped_log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Produced: </span><span class=si>{</span><span class=n>log_message</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 소비자에게 데이터 준비됨을 알림</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>consume_log</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;로그 메시지 소비 (Consumer)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 버퍼가 비어있으면 대기</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>running</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Buffer empty, consumer waiting…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>running</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_entry</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Consumed: </span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=s1>&#39;message&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> &#34;</span>
</span></span><span class=line><span class=cl>                      <span class=sa>f</span><span class=s2>&#34;at </span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 생산자에게 공간 생겼음을 알림</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>log_entry</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>shutdown</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;시스템 종료&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>mutex</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>running</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=c1># 모든 대기 중인 스레드 깨우기</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LogProducer</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;로그 생성 스레드&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>producer_id</span><span class=p>,</span> <span class=n>log_count</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>producer_id</span> <span class=o>=</span> <span class=n>producer_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>log_count</span> <span class=o>=</span> <span class=n>log_count</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>log_count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 실제 로그 생성 시뮬레이션</span>
</span></span><span class=line><span class=cl>            <span class=n>log_message</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Producer-</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>producer_id</span><span class=si>}</span><span class=s2> Log-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>produce_log</span><span class=p>(</span><span class=n>log_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 가변적인 로그 생성 간격</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Producer-</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>producer_id</span><span class=si>}</span><span class=s2> finished&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LogConsumer</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;로그 처리 스레드&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>output_file</span><span class=o>=</span><span class=s2>&#34;logs.txt&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output_file</span> <span class=o>=</span> <span class=n>output_file</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>processed_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>running</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>buffer</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log_entry</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>consume_log</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>log_entry</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 파일에 로그 기록</span>
</span></span><span class=line><span class=cl>                    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>                           <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=s1>&#39;message&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>f</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>  <span class=c1># 즉시 디스크에 쓰기</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>processed_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 처리 시간 시뮬레이션</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Consumer processed </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>processed_count</span><span class=si>}</span><span class=s2> logs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 시스템 실행 예제</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;로그 수집 시스템 메인&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 공유 버퍼 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>log_buffer</span> <span class=o>=</span> <span class=n>LogBuffer</span><span class=p>(</span><span class=n>max_size</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 여러 생산자 스레드 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>producers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>producer</span> <span class=o>=</span> <span class=n>LogProducer</span><span class=p>(</span><span class=n>log_buffer</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>log_count</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>producers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>producer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 단일 소비자 스레드 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span> <span class=o>=</span> <span class=n>LogConsumer</span><span class=p>(</span><span class=n>log_buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Starting log collection system…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 모든 스레드 시작</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>producer</span> <span class=ow>in</span> <span class=n>producers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>producer</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 모든 생산자 완료까지 대기</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>producer</span> <span class=ow>in</span> <span class=n>producers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>producer</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;All producers finished, shutting down…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 버퍼 정리 후 소비자 종료</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 마지막 로그 처리 시간 확보</span>
</span></span><span class=line><span class=cl>    <span class=n>log_buffer</span><span class=o>.</span><span class=n>shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Log collection system shutdown complete&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>핵심 학습 포인트</strong>:</p><ol><li><strong>Mesa 스타일 구현</strong>: while 루프를 통한 조건 재검사</li><li><strong>효율적 자원 관리</strong>: 바쁜 대기 없는 블로킹</li><li><strong>우아한 종료</strong>: 시스템 종료 시 모든 대기 스레드 해제</li><li><strong>실제 성능 측정</strong>: 처리량과 지연 시간 모니터링#### 실제 도입 사례의 코드 구현</li></ol><h5 id=사례-웹-서버의-로그-처리-시스템>사례: 웹 서버의 로그 처리 시스템<a hidden class=anchor aria-hidden=true href=#사례-웹-서버의-로그-처리-시스템>#</a></h5><p><strong>시나리오</strong>: 웹 서버의 로그 처리 시스템에서 로그 수집 스레드와 로그 저장 스레드의 동기화<br><strong>시스템 구성</strong>:</p><ul><li>로그 수집기 (Log Collector)</li><li>로그 처리기 (Log Processor)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    Collector[Log Collector] --&gt; |notify| ConditionVariable
    ConditionVariable --&gt; |wait| Processor[Log Processor]
</pre><p><strong>Workflow</strong>:</p><ol><li>Collector 가 로그 메시지를 큐에 담음</li><li>Condition Variable 로 Processor 에 신호</li><li>Processor 는 신호를 받고 로그를 처리</li></ol><p><strong>유무 비교</strong>:</p><ul><li>도입 전: Processor 가 계속 큐를 폴링 (polling) → CPU 낭비</li><li>도입 후: Processor 는 효율적으로 대기, Collector 신호 시 즉시 처리</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1> 1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2> 2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3> 3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4> 4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5> 5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6> 6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7> 7</a>
</span><span class=lnt id=hl-32-8><a class=lnlinks href=#hl-32-8> 8</a>
</span><span class=lnt id=hl-32-9><a class=lnlinks href=#hl-32-9> 9</a>
</span><span class=lnt id=hl-32-10><a class=lnlinks href=#hl-32-10>10</a>
</span><span class=lnt id=hl-32-11><a class=lnlinks href=#hl-32-11>11</a>
</span><span class=lnt id=hl-32-12><a class=lnlinks href=#hl-32-12>12</a>
</span><span class=lnt id=hl-32-13><a class=lnlinks href=#hl-32-13>13</a>
</span><span class=lnt id=hl-32-14><a class=lnlinks href=#hl-32-14>14</a>
</span><span class=lnt id=hl-32-15><a class=lnlinks href=#hl-32-15>15</a>
</span><span class=lnt id=hl-32-16><a class=lnlinks href=#hl-32-16>16</a>
</span><span class=lnt id=hl-32-17><a class=lnlinks href=#hl-32-17>17</a>
</span><span class=lnt id=hl-32-18><a class=lnlinks href=#hl-32-18>18</a>
</span><span class=lnt id=hl-32-19><a class=lnlinks href=#hl-32-19>19</a>
</span><span class=lnt id=hl-32-20><a class=lnlinks href=#hl-32-20>20</a>
</span><span class=lnt id=hl-32-21><a class=lnlinks href=#hl-32-21>21</a>
</span><span class=lnt id=hl-32-22><a class=lnlinks href=#hl-32-22>22</a>
</span><span class=lnt id=hl-32-23><a class=lnlinks href=#hl-32-23>23</a>
</span><span class=lnt id=hl-32-24><a class=lnlinks href=#hl-32-24>24</a>
</span><span class=lnt id=hl-32-25><a class=lnlinks href=#hl-32-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>queue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log_queue</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>condition</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_collector</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log_queue</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;log message </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[Collector] 로그 추가&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>condition</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_processor</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=n>log_queue</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>condition</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span> <span class=o>=</span> <span class=n>log_queue</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Processor] 로그 처리: </span><span class=si>{</span><span class=n>log</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>log_processor</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>log_collector</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-db-커넥션-풀-connection-pool>사례: DB 커넥션 풀 (Connection Pool)<a hidden class=anchor aria-hidden=true href=#사례-db-커넥션-풀-connection-pool>#</a></h5><p><strong>시나리오</strong>: DB 커넥션 풀 (Connection Pool)</p><ul><li>애플리케이션 스레드가 커넥션을 요청하고, 풀이 가득 차면 <strong>조건 변수</strong>로 대기.</li><li>커넥션 반환 시 <strong>signal</strong>로 대기자 깨움.</li><li>타임아웃/취소/헬스체크/관측성 포함.</li></ul><p><strong>시스템 구성</strong>:</p><ul><li><code>PoolState</code>: 현재 커넥션 수, 대기열, 최소/최대 설정</li><li><code>Mutex + Condition</code>: <code>not_full</code>, <code>not_empty</code></li><li><code>HealthChecker</code>: 비정상 커넥션 제거 및 보충</li><li><code>Metrics</code>: 대기 시간, 풀 사용률, 타임아웃 수</li></ul><pre class=mermaid>graph TB
    A[App Threads] --&gt;|acquire| P[&#34;Connection Pool (mutex + CV)&#34;]
    P --&gt;|hand out| A
    A --&gt;|release| P
    HC[HealthChecker] --&gt;|evict/create| P
    P --&gt; M[Metrics/Logs]
</pre><p><strong>Workflow</strong>:</p><ol><li><code>acquire(timeout)</code>:<ul><li><code>while size==max and idle==0: not_full.wait(timeout)</code></li><li>성공 시 idle→active 이동, 타임아웃 시 예외</li></ul></li><li><code>release(conn)</code>:<ul><li>active→idle 이동, <code>not_empty.signal()</code> 또는 <code>not_full.signal()</code></li></ul><ol><li><code>HealthChecker</code>: 주기적 검증/보충, broadcast 최소화 (필요 시에만)</li></ol></li></ol><p><strong>핵심 역할</strong>:</p><ul><li>조건 변수: <strong>풀 포화/가용성</strong> 변곡점에서 정확한 깨우기</li><li>뮤텍스: 풀 상태 불변식 유지 (<code>0 ≤ idle ≤ max</code>, <code>active+idle=size</code>)</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 폴링/슬립으로 커넥션 회전율 저하, p99 지연 증가</li><li>도입 후: 이벤트 기반 대기, 안정적 처리량과 예측 가능한 지연</li></ul><p><strong>구현 예시</strong>: Python, threading.Condition + Prometheus 지표</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a class=lnlinks href=#hl-34-1>  1</a>
</span><span class=lnt id=hl-34-2><a class=lnlinks href=#hl-34-2>  2</a>
</span><span class=lnt id=hl-34-3><a class=lnlinks href=#hl-34-3>  3</a>
</span><span class=lnt id=hl-34-4><a class=lnlinks href=#hl-34-4>  4</a>
</span><span class=lnt id=hl-34-5><a class=lnlinks href=#hl-34-5>  5</a>
</span><span class=lnt id=hl-34-6><a class=lnlinks href=#hl-34-6>  6</a>
</span><span class=lnt id=hl-34-7><a class=lnlinks href=#hl-34-7>  7</a>
</span><span class=lnt id=hl-34-8><a class=lnlinks href=#hl-34-8>  8</a>
</span><span class=lnt id=hl-34-9><a class=lnlinks href=#hl-34-9>  9</a>
</span><span class=lnt id=hl-34-10><a class=lnlinks href=#hl-34-10> 10</a>
</span><span class=lnt id=hl-34-11><a class=lnlinks href=#hl-34-11> 11</a>
</span><span class=lnt id=hl-34-12><a class=lnlinks href=#hl-34-12> 12</a>
</span><span class=lnt id=hl-34-13><a class=lnlinks href=#hl-34-13> 13</a>
</span><span class=lnt id=hl-34-14><a class=lnlinks href=#hl-34-14> 14</a>
</span><span class=lnt id=hl-34-15><a class=lnlinks href=#hl-34-15> 15</a>
</span><span class=lnt id=hl-34-16><a class=lnlinks href=#hl-34-16> 16</a>
</span><span class=lnt id=hl-34-17><a class=lnlinks href=#hl-34-17> 17</a>
</span><span class=lnt id=hl-34-18><a class=lnlinks href=#hl-34-18> 18</a>
</span><span class=lnt id=hl-34-19><a class=lnlinks href=#hl-34-19> 19</a>
</span><span class=lnt id=hl-34-20><a class=lnlinks href=#hl-34-20> 20</a>
</span><span class=lnt id=hl-34-21><a class=lnlinks href=#hl-34-21> 21</a>
</span><span class=lnt id=hl-34-22><a class=lnlinks href=#hl-34-22> 22</a>
</span><span class=lnt id=hl-34-23><a class=lnlinks href=#hl-34-23> 23</a>
</span><span class=lnt id=hl-34-24><a class=lnlinks href=#hl-34-24> 24</a>
</span><span class=lnt id=hl-34-25><a class=lnlinks href=#hl-34-25> 25</a>
</span><span class=lnt id=hl-34-26><a class=lnlinks href=#hl-34-26> 26</a>
</span><span class=lnt id=hl-34-27><a class=lnlinks href=#hl-34-27> 27</a>
</span><span class=lnt id=hl-34-28><a class=lnlinks href=#hl-34-28> 28</a>
</span><span class=lnt id=hl-34-29><a class=lnlinks href=#hl-34-29> 29</a>
</span><span class=lnt id=hl-34-30><a class=lnlinks href=#hl-34-30> 30</a>
</span><span class=lnt id=hl-34-31><a class=lnlinks href=#hl-34-31> 31</a>
</span><span class=lnt id=hl-34-32><a class=lnlinks href=#hl-34-32> 32</a>
</span><span class=lnt id=hl-34-33><a class=lnlinks href=#hl-34-33> 33</a>
</span><span class=lnt id=hl-34-34><a class=lnlinks href=#hl-34-34> 34</a>
</span><span class=lnt id=hl-34-35><a class=lnlinks href=#hl-34-35> 35</a>
</span><span class=lnt id=hl-34-36><a class=lnlinks href=#hl-34-36> 36</a>
</span><span class=lnt id=hl-34-37><a class=lnlinks href=#hl-34-37> 37</a>
</span><span class=lnt id=hl-34-38><a class=lnlinks href=#hl-34-38> 38</a>
</span><span class=lnt id=hl-34-39><a class=lnlinks href=#hl-34-39> 39</a>
</span><span class=lnt id=hl-34-40><a class=lnlinks href=#hl-34-40> 40</a>
</span><span class=lnt id=hl-34-41><a class=lnlinks href=#hl-34-41> 41</a>
</span><span class=lnt id=hl-34-42><a class=lnlinks href=#hl-34-42> 42</a>
</span><span class=lnt id=hl-34-43><a class=lnlinks href=#hl-34-43> 43</a>
</span><span class=lnt id=hl-34-44><a class=lnlinks href=#hl-34-44> 44</a>
</span><span class=lnt id=hl-34-45><a class=lnlinks href=#hl-34-45> 45</a>
</span><span class=lnt id=hl-34-46><a class=lnlinks href=#hl-34-46> 46</a>
</span><span class=lnt id=hl-34-47><a class=lnlinks href=#hl-34-47> 47</a>
</span><span class=lnt id=hl-34-48><a class=lnlinks href=#hl-34-48> 48</a>
</span><span class=lnt id=hl-34-49><a class=lnlinks href=#hl-34-49> 49</a>
</span><span class=lnt id=hl-34-50><a class=lnlinks href=#hl-34-50> 50</a>
</span><span class=lnt id=hl-34-51><a class=lnlinks href=#hl-34-51> 51</a>
</span><span class=lnt id=hl-34-52><a class=lnlinks href=#hl-34-52> 52</a>
</span><span class=lnt id=hl-34-53><a class=lnlinks href=#hl-34-53> 53</a>
</span><span class=lnt id=hl-34-54><a class=lnlinks href=#hl-34-54> 54</a>
</span><span class=lnt id=hl-34-55><a class=lnlinks href=#hl-34-55> 55</a>
</span><span class=lnt id=hl-34-56><a class=lnlinks href=#hl-34-56> 56</a>
</span><span class=lnt id=hl-34-57><a class=lnlinks href=#hl-34-57> 57</a>
</span><span class=lnt id=hl-34-58><a class=lnlinks href=#hl-34-58> 58</a>
</span><span class=lnt id=hl-34-59><a class=lnlinks href=#hl-34-59> 59</a>
</span><span class=lnt id=hl-34-60><a class=lnlinks href=#hl-34-60> 60</a>
</span><span class=lnt id=hl-34-61><a class=lnlinks href=#hl-34-61> 61</a>
</span><span class=lnt id=hl-34-62><a class=lnlinks href=#hl-34-62> 62</a>
</span><span class=lnt id=hl-34-63><a class=lnlinks href=#hl-34-63> 63</a>
</span><span class=lnt id=hl-34-64><a class=lnlinks href=#hl-34-64> 64</a>
</span><span class=lnt id=hl-34-65><a class=lnlinks href=#hl-34-65> 65</a>
</span><span class=lnt id=hl-34-66><a class=lnlinks href=#hl-34-66> 66</a>
</span><span class=lnt id=hl-34-67><a class=lnlinks href=#hl-34-67> 67</a>
</span><span class=lnt id=hl-34-68><a class=lnlinks href=#hl-34-68> 68</a>
</span><span class=lnt id=hl-34-69><a class=lnlinks href=#hl-34-69> 69</a>
</span><span class=lnt id=hl-34-70><a class=lnlinks href=#hl-34-70> 70</a>
</span><span class=lnt id=hl-34-71><a class=lnlinks href=#hl-34-71> 71</a>
</span><span class=lnt id=hl-34-72><a class=lnlinks href=#hl-34-72> 72</a>
</span><span class=lnt id=hl-34-73><a class=lnlinks href=#hl-34-73> 73</a>
</span><span class=lnt id=hl-34-74><a class=lnlinks href=#hl-34-74> 74</a>
</span><span class=lnt id=hl-34-75><a class=lnlinks href=#hl-34-75> 75</a>
</span><span class=lnt id=hl-34-76><a class=lnlinks href=#hl-34-76> 76</a>
</span><span class=lnt id=hl-34-77><a class=lnlinks href=#hl-34-77> 77</a>
</span><span class=lnt id=hl-34-78><a class=lnlinks href=#hl-34-78> 78</a>
</span><span class=lnt id=hl-34-79><a class=lnlinks href=#hl-34-79> 79</a>
</span><span class=lnt id=hl-34-80><a class=lnlinks href=#hl-34-80> 80</a>
</span><span class=lnt id=hl-34-81><a class=lnlinks href=#hl-34-81> 81</a>
</span><span class=lnt id=hl-34-82><a class=lnlinks href=#hl-34-82> 82</a>
</span><span class=lnt id=hl-34-83><a class=lnlinks href=#hl-34-83> 83</a>
</span><span class=lnt id=hl-34-84><a class=lnlinks href=#hl-34-84> 84</a>
</span><span class=lnt id=hl-34-85><a class=lnlinks href=#hl-34-85> 85</a>
</span><span class=lnt id=hl-34-86><a class=lnlinks href=#hl-34-86> 86</a>
</span><span class=lnt id=hl-34-87><a class=lnlinks href=#hl-34-87> 87</a>
</span><span class=lnt id=hl-34-88><a class=lnlinks href=#hl-34-88> 88</a>
</span><span class=lnt id=hl-34-89><a class=lnlinks href=#hl-34-89> 89</a>
</span><span class=lnt id=hl-34-90><a class=lnlinks href=#hl-34-90> 90</a>
</span><span class=lnt id=hl-34-91><a class=lnlinks href=#hl-34-91> 91</a>
</span><span class=lnt id=hl-34-92><a class=lnlinks href=#hl-34-92> 92</a>
</span><span class=lnt id=hl-34-93><a class=lnlinks href=#hl-34-93> 93</a>
</span><span class=lnt id=hl-34-94><a class=lnlinks href=#hl-34-94> 94</a>
</span><span class=lnt id=hl-34-95><a class=lnlinks href=#hl-34-95> 95</a>
</span><span class=lnt id=hl-34-96><a class=lnlinks href=#hl-34-96> 96</a>
</span><span class=lnt id=hl-34-97><a class=lnlinks href=#hl-34-97> 97</a>
</span><span class=lnt id=hl-34-98><a class=lnlinks href=#hl-34-98> 98</a>
</span><span class=lnt id=hl-34-99><a class=lnlinks href=#hl-34-99> 99</a>
</span><span class=lnt id=hl-34-100><a class=lnlinks href=#hl-34-100>100</a>
</span><span class=lnt id=hl-34-101><a class=lnlinks href=#hl-34-101>101</a>
</span><span class=lnt id=hl-34-102><a class=lnlinks href=#hl-34-102>102</a>
</span><span class=lnt id=hl-34-103><a class=lnlinks href=#hl-34-103>103</a>
</span><span class=lnt id=hl-34-104><a class=lnlinks href=#hl-34-104>104</a>
</span><span class=lnt id=hl-34-105><a class=lnlinks href=#hl-34-105>105</a>
</span><span class=lnt id=hl-34-106><a class=lnlinks href=#hl-34-106>106</a>
</span><span class=lnt id=hl-34-107><a class=lnlinks href=#hl-34-107>107</a>
</span><span class=lnt id=hl-34-108><a class=lnlinks href=#hl-34-108>108</a>
</span><span class=lnt id=hl-34-109><a class=lnlinks href=#hl-34-109>109</a>
</span><span class=lnt id=hl-34-110><a class=lnlinks href=#hl-34-110>110</a>
</span><span class=lnt id=hl-34-111><a class=lnlinks href=#hl-34-111>111</a>
</span><span class=lnt id=hl-34-112><a class=lnlinks href=#hl-34-112>112</a>
</span><span class=lnt id=hl-34-113><a class=lnlinks href=#hl-34-113>113</a>
</span><span class=lnt id=hl-34-114><a class=lnlinks href=#hl-34-114>114</a>
</span><span class=lnt id=hl-34-115><a class=lnlinks href=#hl-34-115>115</a>
</span><span class=lnt id=hl-34-116><a class=lnlinks href=#hl-34-116>116</a>
</span><span class=lnt id=hl-34-117><a class=lnlinks href=#hl-34-117>117</a>
</span><span class=lnt id=hl-34-118><a class=lnlinks href=#hl-34-118>118</a>
</span><span class=lnt id=hl-34-119><a class=lnlinks href=#hl-34-119>119</a>
</span><span class=lnt id=hl-34-120><a class=lnlinks href=#hl-34-120>120</a>
</span><span class=lnt id=hl-34-121><a class=lnlinks href=#hl-34-121>121</a>
</span><span class=lnt id=hl-34-122><a class=lnlinks href=#hl-34-122>122</a>
</span><span class=lnt id=hl-34-123><a class=lnlinks href=#hl-34-123>123</a>
</span><span class=lnt id=hl-34-124><a class=lnlinks href=#hl-34-124>124</a>
</span><span class=lnt id=hl-34-125><a class=lnlinks href=#hl-34-125>125</a>
</span><span class=lnt id=hl-34-126><a class=lnlinks href=#hl-34-126>126</a>
</span><span class=lnt id=hl-34-127><a class=lnlinks href=#hl-34-127>127</a>
</span><span class=lnt id=hl-34-128><a class=lnlinks href=#hl-34-128>128</a>
</span><span class=lnt id=hl-34-129><a class=lnlinks href=#hl-34-129>129</a>
</span><span class=lnt id=hl-34-130><a class=lnlinks href=#hl-34-130>130</a>
</span><span class=lnt id=hl-34-131><a class=lnlinks href=#hl-34-131>131</a>
</span><span class=lnt id=hl-34-132><a class=lnlinks href=#hl-34-132>132</a>
</span><span class=lnt id=hl-34-133><a class=lnlinks href=#hl-34-133>133</a>
</span><span class=lnt id=hl-34-134><a class=lnlinks href=#hl-34-134>134</a>
</span><span class=lnt id=hl-34-135><a class=lnlinks href=#hl-34-135>135</a>
</span><span class=lnt id=hl-34-136><a class=lnlinks href=#hl-34-136>136</a>
</span><span class=lnt id=hl-34-137><a class=lnlinks href=#hl-34-137>137</a>
</span><span class=lnt id=hl-34-138><a class=lnlinks href=#hl-34-138>138</a>
</span><span class=lnt id=hl-34-139><a class=lnlinks href=#hl-34-139>139</a>
</span><span class=lnt id=hl-34-140><a class=lnlinks href=#hl-34-140>140</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># pip install prometheus-client</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>queue</span><span class=o>,</span> <span class=nn>contextlib</span><span class=o>,</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>Gauge</span><span class=p>,</span> <span class=n>start_http_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>REQS_WAIT</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span><span class=s2>&#34;pool_wait_seconds&#34;</span><span class=p>,</span> <span class=s2>&#34;Time waiting for a connection&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>REQS_TIMEOUT</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=s2>&#34;pool_acquire_timeout_total&#34;</span><span class=p>,</span> <span class=s2>&#34;Acquire timeouts&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>POOL_ACTIVE</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s2>&#34;pool_active_connections&#34;</span><span class=p>,</span> <span class=s2>&#34;Active connections&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>POOL_IDLE</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s2>&#34;pool_idle_connections&#34;</span><span class=p>,</span> <span class=s2>&#34;Idle connections&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Connection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>id</span><span class=p>):</span> <span class=bp>self</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=nb>id</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>healthy</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span> <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConnectionPool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>min_size</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>max_size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>check_interval</span><span class=o>=</span><span class=mf>5.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>min</span> <span class=o>=</span> <span class=n>min_size</span><span class=p>;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max</span> <span class=o>=</span> <span class=n>max_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>idle</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>active</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mu</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mu</span><span class=p>)</span>  <span class=c1># idle&gt;0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mu</span><span class=p>)</span>   <span class=c1># size&lt;max</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_start</span><span class=p>(</span><span class=n>min_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_hc</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_health_checker</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>check_interval</span><span class=p>,),</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_hc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_start</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_create_locked</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_create_locked</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>Connection</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>POOL_IDLE</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>POOL_ACTIVE</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@contextlib.contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mf>3.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_acquire</span><span class=p>(</span><span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>release</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>REQS_WAIT</span><span class=o>.</span><span class=n>observe</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>mu</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>timeout</span> <span class=k>if</span> <span class=n>timeout</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=c1># 대기조건: idle==0 &amp;&amp; size==max</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>max</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>remaining</span> <span class=o>=</span> <span class=n>end</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=k>if</span> <span class=n>end</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>remaining</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>remaining</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>REQS_TIMEOUT</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>TimeoutError</span><span class=p>(</span><span class=s2>&#34;acquire timed out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>remaining</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span> <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;pool closed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># idle이 있다면 사용</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># idle이 없고 size&lt;max면 생성</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>_create_locked</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=n>conn</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 방어적: 재검사 루프가 보장하지만 안전망</span>
</span></span><span class=line><span class=cl>                    <span class=n>REQS_TIMEOUT</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>TimeoutError</span><span class=p>(</span><span class=s2>&#34;acquire contention&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>POOL_IDLE</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>));</span> <span class=n>POOL_ACTIVE</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># 상태 변경 후 신호: idle 감소 → not_empty는 생략, not_full은 다른 waiters가 유의</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>mu</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>conn</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>POOL_IDLE</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>));</span> <span class=n>POOL_ACTIVE</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=c1># idle 증가 → idle을 기다리던 소비자를 깨움</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>  <span class=c1># size&lt;max 대기자에게도 힌트</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 이중 반환 방지</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_health_checker</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>interval</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>mu</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 비건전 커넥션 제거 및 보충</span>
</span></span><span class=line><span class=cl>                <span class=n>evicted</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>idle</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>deque</span><span class=p>([</span><span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>idle</span> <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>healthy</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>                <span class=c1># size 재계산은 간단화: unhealthy 없다고 가정 (데모)</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>min</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>_create_locked</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=c1># 상태가 좋아졌을 수 있으니 최소한으로 깨움 (broadcast 지양)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>mu</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_closed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=c1># 대기자 종료</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>not_empty</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>not_full</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># 리소스 정리</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>idle</span><span class=p>):</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>active</span><span class=p>):</span> <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 데모 실행</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>start_http_server</span><span class=p>(</span><span class=mi>8000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span> <span class=o>=</span> <span class=n>ConnectionPool</span><span class=p>(</span><span class=n>min_size</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>max_size</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>worker</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=n>pool</span><span class=o>.</span><span class=n>acquire</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[W</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>] got conn </span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[W</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>] timeout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.02</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>i</span><span class=p>,))</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>포인트</strong></p><ul><li><strong>while 재검사</strong> + <strong>상태 변경 후 notify</strong> 규칙 준수</li><li><code>notify_all()</code>(broadcast) 최소화 → <strong>헤드 스로깅</strong> 방지</li><li><strong>타임아웃</strong>, <strong>Graceful close</strong>로 영구 대기 방지</li><li><strong>Prometheus</strong> 메트릭으로 대기 시간·활성/유휴 커넥션 수 관찰</li></ul><h5 id=사례-데이터베이스-연결-풀-database-connection-pool>사례: 데이터베이스 연결 풀 (Database Connection Pool)<a hidden class=anchor aria-hidden=true href=#사례-데이터베이스-연결-풀-database-connection-pool>#</a></h5><p><strong>시나리오</strong>: 여러 개의 애플리케이션 스레드가 제한된 수의 DB(Connection) 객체를 공유하고 사용해야 하는 상황에서,<br>사용 가능한 객체가 없을 경우 스레드는 대기 (wait) 상태에 들어가고, 다른 스레드가 객체를 반환하면 신호 (notify) 를 통해 재개된다.</p><p><strong>시스템 구성</strong></p><ul><li>커넥션 풀 매니저 (Connection Pool Manager)</li><li>쓰레드풀 (Job Workers)</li><li>DB 서버 (DB Server)</li><li>조건변수 (Condition Variable) + 뮤텍스 (Mutex)</li></ul><p><strong>구성도</strong></p><pre class=mermaid>graph LR
    A[Thread 1] --&gt; |Request Connection| CP[Connection Pool Manager]
    B[Thread 2] --&gt; |Request Connection| CP
    CP --&gt; |Wait if No Connection| CV[Condition Variable]
    DB[(Database Server)] --&gt; CP
    CP --&gt; |Notify Waiting Threads| CV
</pre><p><strong>Workflow</strong></p><ol><li>스레드가 커넥션 풀 매니저에게 DB 연결 요청</li><li>사용 가능한 연결이 없다면 <code>condition.wait()</code></li><li>다른 스레드가 사용을 마치고 연결 반환 시 <code>condition.notify()</code></li><li>대기 중이던 스레드가 깨어나 연결을 획득</li></ol><p><strong>Python 예제 구현</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a class=lnlinks href=#hl-36-1> 1</a>
</span><span class=lnt id=hl-36-2><a class=lnlinks href=#hl-36-2> 2</a>
</span><span class=lnt id=hl-36-3><a class=lnlinks href=#hl-36-3> 3</a>
</span><span class=lnt id=hl-36-4><a class=lnlinks href=#hl-36-4> 4</a>
</span><span class=lnt id=hl-36-5><a class=lnlinks href=#hl-36-5> 5</a>
</span><span class=lnt id=hl-36-6><a class=lnlinks href=#hl-36-6> 6</a>
</span><span class=lnt id=hl-36-7><a class=lnlinks href=#hl-36-7> 7</a>
</span><span class=lnt id=hl-36-8><a class=lnlinks href=#hl-36-8> 8</a>
</span><span class=lnt id=hl-36-9><a class=lnlinks href=#hl-36-9> 9</a>
</span><span class=lnt id=hl-36-10><a class=lnlinks href=#hl-36-10>10</a>
</span><span class=lnt id=hl-36-11><a class=lnlinks href=#hl-36-11>11</a>
</span><span class=lnt id=hl-36-12><a class=lnlinks href=#hl-36-12>12</a>
</span><span class=lnt id=hl-36-13><a class=lnlinks href=#hl-36-13>13</a>
</span><span class=lnt id=hl-36-14><a class=lnlinks href=#hl-36-14>14</a>
</span><span class=lnt id=hl-36-15><a class=lnlinks href=#hl-36-15>15</a>
</span><span class=lnt id=hl-36-16><a class=lnlinks href=#hl-36-16>16</a>
</span><span class=lnt id=hl-36-17><a class=lnlinks href=#hl-36-17>17</a>
</span><span class=lnt id=hl-36-18><a class=lnlinks href=#hl-36-18>18</a>
</span><span class=lnt id=hl-36-19><a class=lnlinks href=#hl-36-19>19</a>
</span><span class=lnt id=hl-36-20><a class=lnlinks href=#hl-36-20>20</a>
</span><span class=lnt id=hl-36-21><a class=lnlinks href=#hl-36-21>21</a>
</span><span class=lnt id=hl-36-22><a class=lnlinks href=#hl-36-22>22</a>
</span><span class=lnt id=hl-36-23><a class=lnlinks href=#hl-36-23>23</a>
</span><span class=lnt id=hl-36-24><a class=lnlinks href=#hl-36-24>24</a>
</span><span class=lnt id=hl-36-25><a class=lnlinks href=#hl-36-25>25</a>
</span><span class=lnt id=hl-36-26><a class=lnlinks href=#hl-36-26>26</a>
</span><span class=lnt id=hl-36-27><a class=lnlinks href=#hl-36-27>27</a>
</span><span class=lnt id=hl-36-28><a class=lnlinks href=#hl-36-28>28</a>
</span><span class=lnt id=hl-36-29><a class=lnlinks href=#hl-36-29>29</a>
</span><span class=lnt id=hl-36-30><a class=lnlinks href=#hl-36-30>30</a>
</span><span class=lnt id=hl-36-31><a class=lnlinks href=#hl-36-31>31</a>
</span><span class=lnt id=hl-36-32><a class=lnlinks href=#hl-36-32>32</a>
</span><span class=lnt id=hl-36-33><a class=lnlinks href=#hl-36-33>33</a>
</span><span class=lnt id=hl-36-34><a class=lnlinks href=#hl-36-34>34</a>
</span><span class=lnt id=hl-36-35><a class=lnlinks href=#hl-36-35>35</a>
</span><span class=lnt id=hl-36-36><a class=lnlinks href=#hl-36-36>36</a>
</span><span class=lnt id=hl-36-37><a class=lnlinks href=#hl-36-37>37</a>
</span><span class=lnt id=hl-36-38><a class=lnlinks href=#hl-36-38>38</a>
</span><span class=lnt id=hl-36-39><a class=lnlinks href=#hl-36-39>39</a>
</span><span class=lnt id=hl-36-40><a class=lnlinks href=#hl-36-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>queue</span> <span class=kn>import</span> <span class=n>Queue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConnectionPool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_connections</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>available</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=n>max_connections</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_connections</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>available</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;DB-Conn-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>condition</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>thread_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>available</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>thread_name</span><span class=si>}</span><span class=s2>: 연결 없음, 대기 중…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>available</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>thread_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>conn</span><span class=si>}</span><span class=s2> 획득&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>thread_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>available</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>thread_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>conn</span><span class=si>}</span><span class=s2> 반환&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>worker</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>thread_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=n>acquire</span><span class=p>(</span><span class=n>thread_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># DB 작업 시뮬레이션</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span><span class=o>.</span><span class=n>release</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>thread_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span> <span class=o>=</span> <span class=n>ConnectionPool</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;Thread-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>이점</strong></p><ul><li>대기 스레드가 busy waiting 없이 효율적으로 자원 확보</li><li>DB 연결 자원 사용량 제어</li><li>시스템 자원 낭비 최소화</li></ul><h5 id=실습-예제-비동기-환경에서의-조건-변수>실습 예제: 비동기 환경에서의 조건 변수<a hidden class=anchor aria-hidden=true href=#실습-예제-비동기-환경에서의-조건-변수>#</a></h5><ul><li><code>asyncio.Condition</code> 은 파이썬의 비동기 I/O 프레임워크 <strong>asyncio</strong>에서 제공하는 조건 변수 구현이다.</li><li>구조와 개념은 일반 조건 변수와 동일하지만, <strong>스레드 블로킹 대신 이벤트 루프 기반의 coroutine 대기</strong>를 수행한다.</li><li>I/O 바운드 작업이 많은 환경에서 CPU 자원 활용을 극대화할 수 있다.</li></ul><p><strong>비동기 조건 변수의 장점</strong>:</p><table><thead><tr><th>구분</th><th>설명</th><th>기술 근거</th></tr></thead><tbody><tr><td>CPU 효율성</td><td>I/O 대기 시 CPU 낭비 최소</td><td>이벤트 루프 기반 대기</td></tr><tr><td>다중 소비자 지원</td><td><code>notify_all()</code> 로 모든 대기 소비자 깨움</td><td>협업 채팅/알림 서비스에 적합</td></tr><tr><td>높은 확장성</td><td>다중 네트워크 연결 처리에 강함</td><td>비동기 소켓/웹소켓 서버에 최적화</td></tr></tbody></table><p><strong>시나리오</strong>: 비동기 채팅 서버</p><ul><li><strong>Producer 역할</strong>: 채팅 메시지를 생성하는 사용자의 입력 처리</li><li><strong>Consumer 역할</strong>: 메시지를 받아서 각 사용자에게 전송</li><li>메시지 큐가 비어있으면 비동기 consumer 는 <code>await condition.wait()</code> 로 대기하고, 메시지가 추가되면 producer 가 <code>notify_all()</code> 로 모든 consumer 를 깨움.</li></ul><p><strong>시스템 구성</strong>:</p><pre class=mermaid>graph TB
    UserInput[사용자 입력 Producer] --&gt; |notify_all| AsyncCondition[asyncio.Condition]
    AsyncCondition --&gt; |wait| MessageSender[메시지 송신 Consumer]
</pre><p><strong>코드 구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a class=lnlinks href=#hl-38-1> 1</a>
</span><span class=lnt id=hl-38-2><a class=lnlinks href=#hl-38-2> 2</a>
</span><span class=lnt id=hl-38-3><a class=lnlinks href=#hl-38-3> 3</a>
</span><span class=lnt id=hl-38-4><a class=lnlinks href=#hl-38-4> 4</a>
</span><span class=lnt id=hl-38-5><a class=lnlinks href=#hl-38-5> 5</a>
</span><span class=lnt id=hl-38-6><a class=lnlinks href=#hl-38-6> 6</a>
</span><span class=lnt id=hl-38-7><a class=lnlinks href=#hl-38-7> 7</a>
</span><span class=lnt id=hl-38-8><a class=lnlinks href=#hl-38-8> 8</a>
</span><span class=lnt id=hl-38-9><a class=lnlinks href=#hl-38-9> 9</a>
</span><span class=lnt id=hl-38-10><a class=lnlinks href=#hl-38-10>10</a>
</span><span class=lnt id=hl-38-11><a class=lnlinks href=#hl-38-11>11</a>
</span><span class=lnt id=hl-38-12><a class=lnlinks href=#hl-38-12>12</a>
</span><span class=lnt id=hl-38-13><a class=lnlinks href=#hl-38-13>13</a>
</span><span class=lnt id=hl-38-14><a class=lnlinks href=#hl-38-14>14</a>
</span><span class=lnt id=hl-38-15><a class=lnlinks href=#hl-38-15>15</a>
</span><span class=lnt id=hl-38-16><a class=lnlinks href=#hl-38-16>16</a>
</span><span class=lnt id=hl-38-17><a class=lnlinks href=#hl-38-17>17</a>
</span><span class=lnt id=hl-38-18><a class=lnlinks href=#hl-38-18>18</a>
</span><span class=lnt id=hl-38-19><a class=lnlinks href=#hl-38-19>19</a>
</span><span class=lnt id=hl-38-20><a class=lnlinks href=#hl-38-20>20</a>
</span><span class=lnt id=hl-38-21><a class=lnlinks href=#hl-38-21>21</a>
</span><span class=lnt id=hl-38-22><a class=lnlinks href=#hl-38-22>22</a>
</span><span class=lnt id=hl-38-23><a class=lnlinks href=#hl-38-23>23</a>
</span><span class=lnt id=hl-38-24><a class=lnlinks href=#hl-38-24>24</a>
</span><span class=lnt id=hl-38-25><a class=lnlinks href=#hl-38-25>25</a>
</span><span class=lnt id=hl-38-26><a class=lnlinks href=#hl-38-26>26</a>
</span><span class=lnt id=hl-38-27><a class=lnlinks href=#hl-38-27>27</a>
</span><span class=lnt id=hl-38-28><a class=lnlinks href=#hl-38-28>28</a>
</span><span class=lnt id=hl-38-29><a class=lnlinks href=#hl-38-29>29</a>
</span><span class=lnt id=hl-38-30><a class=lnlinks href=#hl-38-30>30</a>
</span><span class=lnt id=hl-38-31><a class=lnlinks href=#hl-38-31>31</a>
</span><span class=lnt id=hl-38-32><a class=lnlinks href=#hl-38-32>32</a>
</span><span class=lnt id=hl-38-33><a class=lnlinks href=#hl-38-33>33</a>
</span><span class=lnt id=hl-38-34><a class=lnlinks href=#hl-38-34>34</a>
</span><span class=lnt id=hl-38-35><a class=lnlinks href=#hl-38-35>35</a>
</span><span class=lnt id=hl-38-36><a class=lnlinks href=#hl-38-36>36</a>
</span><span class=lnt id=hl-38-37><a class=lnlinks href=#hl-38-37>37</a>
</span><span class=lnt id=hl-38-38><a class=lnlinks href=#hl-38-38>38</a>
</span><span class=lnt id=hl-38-39><a class=lnlinks href=#hl-38-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ChatServer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 메시지 큐</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>condition</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>producer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;메시지 생산자: 사용자가 메시지를 입력&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 네트워크 처리 시뮬레이션</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>의 메시지 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Producer] </span><span class=si>{</span><span class=n>msg</span><span class=si>}</span><span class=s2> 추가&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># 모든 대기 중인 Consumer에게 알림</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=o>.</span><span class=n>notify_all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>consumer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;메시지 소비자: 채팅 메시지 송신&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>condition</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Consumer </span><span class=si>{</span><span class=n>cid</span><span class=si>}</span><span class=s2>] &#39;</span><span class=si>{</span><span class=n>msg</span><span class=si>}</span><span class=s2>&#39; 전송 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>ChatServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Producer 2개, Consumer 2개 실행</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span><span class=o>.</span><span class=n>producer</span><span class=p>(</span><span class=s2>&#34;UserA&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span><span class=o>.</span><span class=n>producer</span><span class=p>(</span><span class=s2>&#34;UserB&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span><span class=o>.</span><span class=n>consumer</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span><span class=o>.</span><span class=n>consumer</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><p><strong><code>asyncio.Condition()</code></strong></p><ul><li>내부적으로 asyncio.Lock 을 사용</li><li>동기 버전의 <code>Condition</code> 과 동일한 인터페이스 (<code>wait()</code>, <code>notify()</code>, <code>notify_all()</code> 사용)</li></ul></li><li><p><strong><code>async with self.condition</code></strong></p><ul><li>락 획득에 <code>await</code> 없이도 빠른 진입 가능 (다만 내부적으론 event loop 스케줄링)</li></ul></li><li><p><strong><code>await self.condition.wait()</code></strong></p><ul><li>coroutine 이 <strong>이벤트 루프에 제어를 반환</strong>하고 대기</li><li>핸들링 시점 (신호 수신) 에서만 재개됨</li></ul></li></ol><h5 id=실습-예제-다중-조건-변수--상태-머신-기반-동기화-패턴>실습 예제: 다중 조건 변수 + 상태 머신 기반 동기화 패턴<a hidden class=anchor aria-hidden=true href=#실습-예제-다중-조건-변수--상태-머신-기반-동기화-패턴>#</a></h5><ul><li><strong>다중 조건 변수 (Multiple Condition Variables)</strong>: 하나의 뮤텍스 (Mutex) 로 여러 조건 변수를 관리하여, 조건별로 대기 스레드를 선택적으로 깨우는 방식</li><li><strong>상태 머신 (State Machine)</strong>: 시스템의 상태를 정의하고, 상태 전이에 따라 동기화 및 신호 방식을 결정하는 설계 패턴</li></ul><p><strong>시나리오</strong>: 실시간 금융 거래 처리 시스템</p><ul><li><strong>상황</strong>: 주문 (Order) 스레드와 결제 (Payment) 스레드, 출고 (Shipping) 스레드가 서로 다른 조건에서 동작</li><li>주문 완료 → 결제 처리 가능 상태 → 결제 완료 → 출고 가능 상태</li><li>결제와 출고는 독립적인 조건 변수로 대기하다가, 상태가 변하면 각각 신호를 받아 처리</li></ul><p><strong>시스템 구성</strong>:</p><pre class=mermaid>graph LR
    A[Order Thread] --&gt; |신호: 주문완료| CV1[결제 조건변수]
    CV1 --&gt; B[Payment Thread]
    B --&gt; |신호: 결제완료| CV2[출고 조건변수]
    CV2 --&gt; C[Shipping Thread]
</pre><p><strong>상태 머신 (State Machine) 설계</strong>:</p><table><thead><tr><th>상태 코드</th><th>상태명</th><th>다음 상태</th><th>조건 변수</th></tr></thead><tbody><tr><td>0</td><td>주문 대기 (Order Pending)</td><td>주문 완료 (1)</td><td>결제 조건변수 (CV1)</td></tr><tr><td>1</td><td>결제 대기 (Payment Pending)</td><td>결제 완료 (2)</td><td>출고 조건변수 (CV2)</td></tr><tr><td>2</td><td>출고 대기 (Shipping Pending)</td><td>완료</td><td>-</td></tr></tbody></table><p><strong>Python 예시 구현</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a class=lnlinks href=#hl-40-1> 1</a>
</span><span class=lnt id=hl-40-2><a class=lnlinks href=#hl-40-2> 2</a>
</span><span class=lnt id=hl-40-3><a class=lnlinks href=#hl-40-3> 3</a>
</span><span class=lnt id=hl-40-4><a class=lnlinks href=#hl-40-4> 4</a>
</span><span class=lnt id=hl-40-5><a class=lnlinks href=#hl-40-5> 5</a>
</span><span class=lnt id=hl-40-6><a class=lnlinks href=#hl-40-6> 6</a>
</span><span class=lnt id=hl-40-7><a class=lnlinks href=#hl-40-7> 7</a>
</span><span class=lnt id=hl-40-8><a class=lnlinks href=#hl-40-8> 8</a>
</span><span class=lnt id=hl-40-9><a class=lnlinks href=#hl-40-9> 9</a>
</span><span class=lnt id=hl-40-10><a class=lnlinks href=#hl-40-10>10</a>
</span><span class=lnt id=hl-40-11><a class=lnlinks href=#hl-40-11>11</a>
</span><span class=lnt id=hl-40-12><a class=lnlinks href=#hl-40-12>12</a>
</span><span class=lnt id=hl-40-13><a class=lnlinks href=#hl-40-13>13</a>
</span><span class=lnt id=hl-40-14><a class=lnlinks href=#hl-40-14>14</a>
</span><span class=lnt id=hl-40-15><a class=lnlinks href=#hl-40-15>15</a>
</span><span class=lnt id=hl-40-16><a class=lnlinks href=#hl-40-16>16</a>
</span><span class=lnt id=hl-40-17><a class=lnlinks href=#hl-40-17>17</a>
</span><span class=lnt id=hl-40-18><a class=lnlinks href=#hl-40-18>18</a>
</span><span class=lnt id=hl-40-19><a class=lnlinks href=#hl-40-19>19</a>
</span><span class=lnt id=hl-40-20><a class=lnlinks href=#hl-40-20>20</a>
</span><span class=lnt id=hl-40-21><a class=lnlinks href=#hl-40-21>21</a>
</span><span class=lnt id=hl-40-22><a class=lnlinks href=#hl-40-22>22</a>
</span><span class=lnt id=hl-40-23><a class=lnlinks href=#hl-40-23>23</a>
</span><span class=lnt id=hl-40-24><a class=lnlinks href=#hl-40-24>24</a>
</span><span class=lnt id=hl-40-25><a class=lnlinks href=#hl-40-25>25</a>
</span><span class=lnt id=hl-40-26><a class=lnlinks href=#hl-40-26>26</a>
</span><span class=lnt id=hl-40-27><a class=lnlinks href=#hl-40-27>27</a>
</span><span class=lnt id=hl-40-28><a class=lnlinks href=#hl-40-28>28</a>
</span><span class=lnt id=hl-40-29><a class=lnlinks href=#hl-40-29>29</a>
</span><span class=lnt id=hl-40-30><a class=lnlinks href=#hl-40-30>30</a>
</span><span class=lnt id=hl-40-31><a class=lnlinks href=#hl-40-31>31</a>
</span><span class=lnt id=hl-40-32><a class=lnlinks href=#hl-40-32>32</a>
</span><span class=lnt id=hl-40-33><a class=lnlinks href=#hl-40-33>33</a>
</span><span class=lnt id=hl-40-34><a class=lnlinks href=#hl-40-34>34</a>
</span><span class=lnt id=hl-40-35><a class=lnlinks href=#hl-40-35>35</a>
</span><span class=lnt id=hl-40-36><a class=lnlinks href=#hl-40-36>36</a>
</span><span class=lnt id=hl-40-37><a class=lnlinks href=#hl-40-37>37</a>
</span><span class=lnt id=hl-40-38><a class=lnlinks href=#hl-40-38>38</a>
</span><span class=lnt id=hl-40-39><a class=lnlinks href=#hl-40-39>39</a>
</span><span class=lnt id=hl-40-40><a class=lnlinks href=#hl-40-40>40</a>
</span><span class=lnt id=hl-40-41><a class=lnlinks href=#hl-40-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=mi>0</span>  <span class=c1># 0: 주문 대기, 1: 결제 대기, 2: 출고 대기</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>payment_cv</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>shipping_cv</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>place_order</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[Order] 주문 접수 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>payment_cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>  <span class=c1># 결제 스레드만 깨움</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_payment</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>payment_cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># 결제 상태 대기</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[Payment] 결제 처리 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>shipping_cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>  <span class=c1># 출고 스레드만 깨움</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_shipping</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>shipping_cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># 출고 상태 대기</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[Shipping] 상품 출고 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 테스트 실행</span>
</span></span><span class=line><span class=cl><span class=n>order_system</span> <span class=o>=</span> <span class=n>OrderSystem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>order_system</span><span class=o>.</span><span class=n>process_shipping</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>order_system</span><span class=o>.</span><span class=n>process_payment</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order_system</span><span class=o>.</span><span class=n>place_order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>주석 설명</strong></p><ul><li><code>payment_cv</code> 와 <code>shipping_cv</code> 는 각각 결제 단계, 출고 단계의 조건 변수</li><li>상태 머신의 <code>state</code> 값에 따라 알맞은 조건 변수만 깨움</li><li>단일 뮤텍스를 유지하면서 조건별로 선택적으로 스레드 깨우기 가능</li></ul><p><strong>장점</strong>:</p><table><thead><tr><th>구분</th><th>설명</th><th>기술 근거</th></tr></thead><tbody><tr><td>선택적 깨우기</td><td>불필요한 스레드 깨어남 방지</td><td>특정 조건 변수에만 notify</td></tr><tr><td>구조 명확화</td><td>상태 머신으로 로직 명확화</td><td>각 상태 전이에 따른 조건 변수 사용</td></tr><tr><td>성능 최적화</td><td>컨텍스트 스위칭 최소화</td><td>관련 스레드만 깨어남</td></tr></tbody></table><p><strong>실무 적용 포인트</strong>:</p><ul><li>**이벤트 기반 시스템 (EDA, Event-Driven Architecture)**에서 다중 조건 변수를 쓰면 특정 이벤트 대상 스레드만 깨울 수 있어 효율적</li><li>IoT(Internet of Things) 환경에서 센서별로 조건 변수를 두어 필요 시에만 신호 전송</li><li>실시간 게임 서버에서 플레이어 상태 (대기 - 매칭 - 게임 시작) 에 따라 여러 조건 변수로 단계별 제어 가능</li></ul><h5 id=실습-예제-분산-환경에서의-조건-변수-확장-응용>실습 예제: 분산 환경에서의 조건 변수 확장 응용<a hidden class=anchor aria-hidden=true href=#실습-예제-분산-환경에서의-조건-변수-확장-응용>#</a></h5><ul><li><strong>POSIX Thread / 로컬 조건 변수 한계</strong>: 단일 프로세스/서버 내부에서만 스레드 간 동기화 가능</li><li><strong>분산 확장 필요성</strong>: 다중 서버에서 동일한 상태 변화에 따라 작업 스레드를 깨워야 할 때, 로컬 조건 변수 대신 네트워크 기반 시그널링 필요</li><li><strong>대체 기술</strong>:<ul><li><strong>메시지 브로커 (Message Broker)</strong>: Kafka, RabbitMQ, NATS</li><li><strong>인메모리 데이터 저장소 (In-Memory Data Store)</strong> Pub/Sub: Redis Pub/Sub, Redis Streams</li><li><strong>분산 락 관리 (Distributed Lock Manager)</strong>: Redisson, Zookeeper</li></ul></li></ul><p><strong>시나리오</strong>: 주문·결제·출고가 서로 다른 서버에서 처리되는 마이크로서비스</p><ul><li><strong>Order Service</strong>: 주문 완료 시 결제 서비스에 알림</li><li><strong>Payment Service</strong>: 결제 완료 시 출고 서비스에 알림</li><li><strong>Shipping Service</strong>: 출고 처리</li></ul><p><strong>아키텍처</strong>:</p><pre class=mermaid>graph LR
    O[Order Service] --Publish--&gt; RedisPubSub[(Redis Pub/Sub Channel)]
    P[Payment Service] --Subscribe--&gt; RedisPubSub
    P --Publish--&gt; RedisPubSub2[(Redis Pub/Sub Channel 2)]
    S[Shipping Service] --Subscribe--&gt; RedisPubSub2
</pre><p><strong>구현 예제</strong>: Python + Redis Pub/Sub</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a class=lnlinks href=#hl-42-1> 1</a>
</span><span class=lnt id=hl-42-2><a class=lnlinks href=#hl-42-2> 2</a>
</span><span class=lnt id=hl-42-3><a class=lnlinks href=#hl-42-3> 3</a>
</span><span class=lnt id=hl-42-4><a class=lnlinks href=#hl-42-4> 4</a>
</span><span class=lnt id=hl-42-5><a class=lnlinks href=#hl-42-5> 5</a>
</span><span class=lnt id=hl-42-6><a class=lnlinks href=#hl-42-6> 6</a>
</span><span class=lnt id=hl-42-7><a class=lnlinks href=#hl-42-7> 7</a>
</span><span class=lnt id=hl-42-8><a class=lnlinks href=#hl-42-8> 8</a>
</span><span class=lnt id=hl-42-9><a class=lnlinks href=#hl-42-9> 9</a>
</span><span class=lnt id=hl-42-10><a class=lnlinks href=#hl-42-10>10</a>
</span><span class=lnt id=hl-42-11><a class=lnlinks href=#hl-42-11>11</a>
</span><span class=lnt id=hl-42-12><a class=lnlinks href=#hl-42-12>12</a>
</span><span class=lnt id=hl-42-13><a class=lnlinks href=#hl-42-13>13</a>
</span><span class=lnt id=hl-42-14><a class=lnlinks href=#hl-42-14>14</a>
</span><span class=lnt id=hl-42-15><a class=lnlinks href=#hl-42-15>15</a>
</span><span class=lnt id=hl-42-16><a class=lnlinks href=#hl-42-16>16</a>
</span><span class=lnt id=hl-42-17><a class=lnlinks href=#hl-42-17>17</a>
</span><span class=lnt id=hl-42-18><a class=lnlinks href=#hl-42-18>18</a>
</span><span class=lnt id=hl-42-19><a class=lnlinks href=#hl-42-19>19</a>
</span><span class=lnt id=hl-42-20><a class=lnlinks href=#hl-42-20>20</a>
</span><span class=lnt id=hl-42-21><a class=lnlinks href=#hl-42-21>21</a>
</span><span class=lnt id=hl-42-22><a class=lnlinks href=#hl-42-22>22</a>
</span><span class=lnt id=hl-42-23><a class=lnlinks href=#hl-42-23>23</a>
</span><span class=lnt id=hl-42-24><a class=lnlinks href=#hl-42-24>24</a>
</span><span class=lnt id=hl-42-25><a class=lnlinks href=#hl-42-25>25</a>
</span><span class=lnt id=hl-42-26><a class=lnlinks href=#hl-42-26>26</a>
</span><span class=lnt id=hl-42-27><a class=lnlinks href=#hl-42-27>27</a>
</span><span class=lnt id=hl-42-28><a class=lnlinks href=#hl-42-28>28</a>
</span><span class=lnt id=hl-42-29><a class=lnlinks href=#hl-42-29>29</a>
</span><span class=lnt id=hl-42-30><a class=lnlinks href=#hl-42-30>30</a>
</span><span class=lnt id=hl-42-31><a class=lnlinks href=#hl-42-31>31</a>
</span><span class=lnt id=hl-42-32><a class=lnlinks href=#hl-42-32>32</a>
</span><span class=lnt id=hl-42-33><a class=lnlinks href=#hl-42-33>33</a>
</span><span class=lnt id=hl-42-34><a class=lnlinks href=#hl-42-34>34</a>
</span><span class=lnt id=hl-42-35><a class=lnlinks href=#hl-42-35>35</a>
</span><span class=lnt id=hl-42-36><a class=lnlinks href=#hl-42-36>36</a>
</span><span class=lnt id=hl-42-37><a class=lnlinks href=#hl-42-37>37</a>
</span><span class=lnt id=hl-42-38><a class=lnlinks href=#hl-42-38>38</a>
</span><span class=lnt id=hl-42-39><a class=lnlinks href=#hl-42-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis 연결 (로컬 또는 분산 구성 가능)</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 결제 조건 스레드</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>payment_service</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>pubsub</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pubsub</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pubsub</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s1>&#39;order_done&#39;</span><span class=p>)</span>  <span class=c1># 주문 완료 채널 구독</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>pubsub</span><span class=o>.</span><span class=n>listen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>message</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;message&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order_id</span> <span class=o>=</span> <span class=n>message</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Payment Service] 주문 </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> 결제 처리 시작&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;payment_done&#39;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>)</span>  <span class=c1># 결제 완료 발행</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 출고 조건 스레드</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shipping_service</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>pubsub</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pubsub</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pubsub</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s1>&#39;payment_done&#39;</span><span class=p>)</span>  <span class=c1># 결제 완료 채널 구독</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>pubsub</span><span class=o>.</span><span class=n>listen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>message</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;message&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order_id</span> <span class=o>=</span> <span class=n>message</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Shipping Service] 주문 </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> 출고 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 주문 생성 스레드</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>order_service</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Order Service] 주문 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> 생성 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;order_done&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>  <span class=c1># 주문 완료 발행</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 스레드 실행</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>payment_service</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>shipping_service</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>order_service</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>특징 비교: 로컬 조건 변수 vs. 분산 Pub/Sub</strong></p><table><thead><tr><th>구분</th><th>로컬 조건 변수 (Condition Variable)</th><th>분산 Pub/Sub</th></tr></thead><tbody><tr><td>동기화 범위</td><td>같은 프로세스 내 스레드</td><td>서로 다른 서버·프로세스 포함</td></tr><tr><td>지연 시간</td><td>매우 짧음 (메모리 접근)</td><td>네트워크 지연 발생 가능</td></tr><tr><td>구현 복잡도</td><td>비교적 단순</td><td>브로커/네트워크 구성 필요</td></tr><tr><td>실시간성</td><td>매우 높음</td><td>브로커 성능 및 네트워크 품질에 의존</td></tr><tr><td>활용 예</td><td>스레드 풀, 로컬 큐 처리</td><td>마이크로서비스 이벤트 연계</td></tr></tbody></table><p><strong>실무 적용 팁</strong>:</p><ol><li><strong>이벤트 이름/채널 표준화</strong><ul><li><code>주문완료(order_done)</code> → <code>결제완료(payment_done)</code> → <code>출고완료(shipping_done)</code> 등 상태 전환 명확화</li></ul></li><li><strong>타임아웃/리트라이 (Timeout/Retry)</strong><ul><li>네트워크 장애나 브로커 장애 시 재시도 로직 필수</li></ul></li><li><strong>혼합 패턴 (Hybrid Pattern)</strong><ul><li>로컬 서버 내부의 각 서비스 스레드 동기화 → 조건 변수 활용</li><li>서비스 간 이벤트 전달 → 메시지 브로커 기반 Pub/Sub</li></ul></li></ol><h3 id=운영-및-최적화-operations--optimization>운영 및 최적화 (Operations & Optimization)<a hidden class=anchor aria-hidden=true href=#운영-및-최적화-operations--optimization>#</a></h3><h4 id=보안-및-거버넌스>보안 및 거버넌스<a hidden class=anchor aria-hidden=true href=#보안-및-거버넌스>#</a></h4><p>조건 변수의 보안 및 거버넌스는 크게 <strong>동기화 안전성 확보</strong>, <strong>서비스 가용성 보장</strong>, <strong>표준 및 규정 준수</strong>로 나뉜다.<br>동기화 안전성 확보를 위해서는 데이터 경쟁과 데드락을 방지하고, API 오용을 최소화하며, 멀티테넌시 환경에서 불필요한 간섭을 줄여야 한다.<br>서비스 가용성을 위해서는 무기한 대기를 피하고, 종료 시 자원 누수를 방지하며, 예외 상황에서도 안전하게 복구하는 구조를 갖춰야 한다.<br>규정 준수 측면에서는 POSIX, C++ 등 표준과 메모리 모델을 준수하고, 실시간/안전 중요 시스템의 요구사항 (우선순위 상속, 형식 검증 등) 에 맞춰야 하며, 감사 로그와 권한 관리를 통해 운영 안정성을 높인다.</p><table><thead><tr><th>구분</th><th>위험/목표</th><th>대응 방안</th><th>구현 방법</th></tr></thead><tbody><tr><td><strong>보안</strong></td><td>데이터 경쟁</td><td>모든 공유 자원 접근 시 락 보호</td><td>mutex + condition_variable 조합</td></tr><tr><td></td><td>데드락</td><td>락 순서 정의, 타임아웃 설정</td><td>계층적 락 설계, timed_wait 사용</td></tr><tr><td></td><td>DoS 위험</td><td>무기한 대기 방지</td><td>외부 입력 기반 wait 시 타임아웃·취소 지원</td></tr><tr><td></td><td>리소스 누수</td><td>종료 시 대기 스레드 해제</td><td>종료 훅에서 broadcast 호출</td></tr><tr><td></td><td>멀티테넌시 간섭</td><td>불필요한 broadcast 최소화</td><td>워크로드 분리, 조건 변수 분리</td></tr><tr><td></td><td>타이밍 공격</td><td>대기 시간 기반 정보 유출 방지</td><td>상수 시간 대기 설계</td></tr><tr><td><strong>거버넌스</strong></td><td>권한 관리</td><td>동기화 객체 접근 제한</td><td>OS/언어 레벨 권한 제어</td></tr><tr><td></td><td>감사 로그</td><td>사용 이력 추적</td><td>wait/signal 호출 로깅</td></tr><tr><td></td><td>규정 준수</td><td>표준 API/메모리 모델 준수</td><td>POSIX, C++11+, Java 등</td></tr><tr><td></td><td>안전 중요 요구</td><td>예측 가능한 응답·검증</td><td>우선순위 상속, 형식 검증, TSan 활용</td></tr></tbody></table><p>조건 변수의 보안 및 거버넌스는 <strong>무결성·가용성·이식성</strong>을 중심으로 설계되어야 한다.<br>락과 조건 변수를 올바르게 결합하여 데이터 경쟁과 데드락을 방지하고, 무기한 대기나 리소스 누수로 인한 서비스 중단을 피해야 한다.<br>멀티테넌시 환경에서는 간섭을 줄이고 권한 관리를 강화해야 하며, 고성능·안전 중요 시스템에서는 타이밍 공격 방지, 우선순위 상속, 정적 분석 도구 활용 등 강화된 검증 절차가 필요하다.<br>모든 구현은 POSIX·C++ 표준 등 언어/플랫폼 표준을 준수하고, 운영 중에는 감사 로그를 통해 문제 추적 가능성을 확보해야 한다.</p><h4 id=모니터링-및-관측성>모니터링 및 관측성<a hidden class=anchor aria-hidden=true href=#모니터링-및-관측성>#</a></h4><table><thead><tr><th>영역</th><th>항목</th><th>지표/로그 예시</th><th>권장 임계/규칙</th><th>비고</th></tr></thead><tbody><tr><td>지연</td><td>대기 시간 분포</td><td><code>cv_wait_duration_ms</code> (histogram: p50/p95/p99)</td><td>p95 가 평시 대비 +50% 이상을 5 분 지속 시 경보</td><td>버킷 예: 1,2,5,10,20,50,100,200,500,1000ms</td></tr><tr><td>규모</td><td>현재 대기자 수</td><td><code>cv_waiters_count</code> (gauge)</td><td>평시 평균의 2 배 초과 10 분 지속 시 경보</td><td>큐 폭증 조기 감지</td></tr><tr><td>활동</td><td>신호 빈도</td><td><code>cv_signal_total</code>, <code>cv_broadcast_total</code> (counter)</td><td><code>broadcast / signal > 0.1</code> 지속 시 점검</td><td>히어드 가능성</td></tr><tr><td>안정성</td><td>타임아웃 비율</td><td><code>cv_timeout_total / cv_wait_total</code></td><td>1%↑ 5 분 지속 시 경보</td><td>장애·백프레셔 신호</td></tr><tr><td>품질</td><td>스푸리어스 추정</td><td><code>cv_spurious_total / cv_wait_total</code></td><td>5%↑ 시 코드/플래그 점검</td><td>" 깨어남→즉시 재대기 " 로 추정</td></tr><tr><td>락</td><td>락 보유 시간</td><td><code>lock_hold_time_ms</code> (histogram)</td><td>상위 3 컴포넌트 p95 ↑ 시 알람</td><td>wait 지연과 교차 분석</td></tr><tr><td>로깅</td><td>대기/종료 이벤트</td><td><code>wait_start</code>, <code>wait_end</code>, <code>notify</code></td><td>타임아웃→WARN, 스푸리어스→DEBUG</td><td>구조화 로깅 (JSON)</td></tr><tr><td>트레이싱</td><td>스팬</td><td><code>cv.wait</code> span, tags: <code>cv_name</code>, <code>predicate</code>, <code>outcome</code></td><td>타임아웃 시 <code>error=true</code> 태깅</td><td>상위 트레이스와 연계</td></tr><tr><td>프로파일링</td><td>경합/컨텍스트스위치</td><td>OS/런타임 프로파일러 (JFR, pprof 등)</td><td><code>notify_all</code> 직후 switch 급증 시 최적화</td><td><code>notify_one</code> 우선</td></tr></tbody></table><p><strong>Prometheus 메트릭 이름 가이드</strong></p><ul><li><code>cv_wait_duration_ms_bucket|sum|count</code></li><li><code>cv_wait_total</code></li><li><code>cv_signal_total</code></li><li><code>cv_broadcast_total</code></li><li><code>cv_timeout_total</code></li><li><code>cv_spurious_total</code></li><li><code>cv_waiters</code></li><li><code>lock_hold_time_ms_*</code></li></ul><p>관측성의 핵심은 ** 대기 지연 분포 (p95/p99)** 와 <strong>대기 규모 (waiters)</strong>, <strong>타임아웃율</strong>을 주 지표로 삼고, <strong>락 보유 시간</strong>과 ** 신호 패턴 (signal/broadcast 비율)** 을 함께 본선에서 <strong>원인 - 결과를 연결</strong>해 해석하는 거야. 이벤트는 <strong>구조화 로깅과 트레이싱 스팬</strong>으로 맥락을 남기고, 메트릭은 <strong>샘플링·라벨 최소화</strong>로 비용을 통제한다. 알람은 절대값보다 <strong>증분 추세</strong>로 민감도를 조정하고, <code>notify_all</code> 남용으로 인한 <strong>히어드 징후</strong>를 별도 룰로 감시하면 운영이 안정해진다.</p><h4 id=실무-적용-고려사항-및-주의점>실무 적용 고려사항 및 주의점<a hidden class=anchor aria-hidden=true href=#실무-적용-고려사항-및-주의점>#</a></h4><table><thead><tr><th>카테고리</th><th>고려사항</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>설계</strong></td><td>Predicate 명확화</td><td>단순한 불린 식으로 정의·문서화</td></tr><tr><td></td><td>CV- 뮤텍스 페어 설계</td><td>관련 뮤텍스 전용 할당</td></tr><tr><td></td><td>락 순서 표준화</td><td>문서화·일관성 유지</td></tr><tr><td><strong>동기화</strong></td><td>조건 재검사</td><td>wait 후 while 루프 재검사</td></tr><tr><td></td><td>신호 타이밍</td><td>상태 변경 직후 signal/broadcast</td></tr><tr><td></td><td>신호 선택</td><td>기본 signal, 필요 시 broadcast</td></tr><tr><td><strong>성능/확장성</strong></td><td>notify_all 최소화</td><td>조건별 CV 샤딩</td></tr><tr><td></td><td>락 홀드 최소화</td><td>임계 구역 I/O 금지</td></tr><tr><td></td><td>고경합 최적화</td><td>아토믹/락프리 구조 검토</td></tr><tr><td><strong>안정성/에러 대응</strong></td><td>Deadlock 예방</td><td>타임아웃·락 순서 준수</td></tr><tr><td></td><td>Lost Wakeup 방지</td><td>상태 변수·신호 순서 설계</td></tr><tr><td></td><td>공정성 보장</td><td>우선순위 역전 방지 기법</td></tr><tr><td><strong>운영/테스트</strong></td><td>동시성·스트레스 테스트</td><td>자동화·다중 스레드 시나리오</td></tr><tr><td></td><td>모니터링</td><td>대기/신호 이벤트 수 추적</td></tr><tr><td></td><td>자원 해제</td><td>pthread_cond_destroy 등 호출</td></tr></tbody></table><ul><li><strong>설계</strong>: 조건과 락 설계를 명확히 하고 표준화된 패턴을 따른다.</li><li><strong>동기화</strong>: 항상 while 로 재검사하고, 신호는 정확한 시점과 범위로 보낸다.</li><li><strong>성능/확장성</strong>: 불필요한 wake-up 을 줄이고, 고경합 시 구조 자체를 최적화한다.</li><li><strong>안정성/에러 대응</strong>: Deadlock·Lost Wakeup·우선순위 역전 예방이 핵심.</li><li><strong>운영/테스트</strong>: 테스트·모니터링 체계를 갖추고 자원 정리를 철저히 한다.</li></ul><h4 id=성능-최적화-전략-및-고려사항>성능 최적화 전략 및 고려사항<a hidden class=anchor aria-hidden=true href=#성능-최적화-전략-및-고려사항>#</a></h4><table><thead><tr><th>카테고리</th><th>전략</th><th>방법</th><th>기대 효과</th><th>주의사항</th></tr></thead><tbody><tr><td>신호·조건 설계</td><td>신호 최소화</td><td><code>notify_one</code> 기본, 대규모 변화만 <code>notify_all</code></td><td>컨텍스트 스위치/경합 감소</td><td>조건 미충족 스레드 깨움 방지 위해 <strong>predicate 설계</strong> 정밀화</td></tr><tr><td></td><td>배치 신호</td><td>N 개 처리 후 1 회 신호</td><td>신호 폭발 억제, CPU 안정화</td><td>지연 증가 위험 → 임계치·타이머 기반 플러시</td></tr><tr><td></td><td>조건 분리</td><td>notEmpty/notFull 별도 CV</td><td>불필요한 깨움 제거</td><td>CV/락 수 증가로 메모리·복잡도 상승</td></tr><tr><td>락·임계구역</td><td>보유 시간 단축</td><td>임계구역 최소화, 상태→notify→unlock</td><td>wait 지연 단축</td><td>I/O, 긴 계산은 락 밖으로 이동</td></tr><tr><td></td><td>데이터 배치</td><td>상태/락/CV 구조체화, 캐시 친화적 레이아웃</td><td>캐시 미스/NUMA 비용 감소</td><td>구조 변경 시 동시성 가정 재검증</td></tr><tr><td>대기 전략</td><td>스핀→CV</td><td>짧은 대기는 스핀, 그 외 CV 블록</td><td>p99 지연·오버헤드 절충</td><td>스핀 한계 시간 (수~수백 µs) 상정</td></tr><tr><td></td><td>타임아웃</td><td><code>wait_for/until</code></td><td>장애 격리·백프레셔</td><td>타임아웃 후 롤백/재시도 정책 필요</td></tr><tr><td>파티셔닝·스케줄링</td><td>샤딩</td><td>큐/락/CV 를 워크로드로 분할</td><td>경합 분산·스케일아웃</td><td>균형 불량 시 핫샤드 발생</td></tr><tr><td></td><td>우선순위</td><td>중요 스레드 우선 깨움</td><td>응답시간 보장</td><td>우선순위 역전 방지 (상속/ceiling)</td></tr><tr><td>하이브리드·대안</td><td>CV+ 아토믹</td><td>빠른 경로는 원자 연산, 복합 상태는 CV</td><td>평균·상위 지연 개선</td><td>경로 전환 조건 명확화</td></tr><tr><td></td><td>CV↔세마포어</td><td>수량 문제는 세마포어로 모델링</td><td>모델 단순화/성능</td><td>상태 기반 로직은 CV 유지</td></tr><tr><td>관측·프로파일링</td><td>지표/알람</td><td>p95 wait, waiters, lock_hold, broadcast 비율</td><td>병목·히어드 조기 탐지</td><td>라벨 폭발/과도 로깅 방지</td></tr></tbody></table><p>핵심은 <strong>불필요한 깨움과 락 경합을 줄이는 설계</strong>야. 이를 위해 <strong>조건 분리·notify_one·배치 신호</strong>를 기본으로 하되, <strong>임계구역 축소</strong>와 <strong>스핀→CV 하이브리드</strong>로 p99 를 다듬어. 운영 단계에서는 <strong>p95 대기·락 보유·브로드캐스트 비율</strong>을 감시해 파티셔닝·배치 임계치를 지속 튜닝하면 안정적인 처리량과 낮은 지연을 동시에 달성할 수 있어.</p><h5 id=조건-변수-최적화-패턴-optimization-patterns>조건 변수 최적화 패턴 (Optimization Patterns)<a hidden class=anchor aria-hidden=true href=#조건-변수-최적화-패턴-optimization-patterns>#</a></h5><table><thead><tr><th>패턴</th><th>설명</th><th>적용 예시</th></tr></thead><tbody><tr><td>조건 변수 분할 (Condition Splitting)</td><td>한 조건 변수를 여러 개로 나누어 락 경합 줄이기</td><td>읽기/쓰기 대기 분리</td></tr><tr><td>신호 최소화 (Minimal Signaling)</td><td>가능한 한 적은 <code>notify</code> 호출</td><td>대기자 없으면 signal 호출 생략</td></tr><tr><td>배치 알림 (Batch Notification)</td><td>일정량의 이벤트가 누적되면 한번에 Broadcast</td><td>대규모 소비자 환경</td></tr><tr><td>타임아웃 대기 (Timed Wait)</td><td>무한 대기 방지, Fault-tolerance 강화</td><td>네트워크 응답 대기</td></tr><tr><td>대체 동기화 (Alternative Sync)</td><td>락프리/세마포어와 혼합 사용</td><td>초저지연 시스템</td></tr></tbody></table><h3 id=고급-주제-advanced-topics>고급 주제 (Advanced Topics)<a hidden class=anchor aria-hidden=true href=#고급-주제-advanced-topics>#</a></h3><h4 id=현재-도전-과제>현재 도전 과제<a hidden class=anchor aria-hidden=true href=#현재-도전-과제>#</a></h4><p>조건 변수의 실무 적용에서 직면하는 도전 과제는 크게 <strong>기본 동기화 신뢰성</strong>, <strong>성능·확장성</strong>, <strong>실시간·임베디드 제약</strong>, <strong>아키텍처·환경 한계</strong>로 나눌 수 있다.<br>기본 동기화 신뢰성은 OS 특성 및 호출 순서 문제로 인한 잘못된 깨어남이나 무한 대기, 다중 조건 설계 난이도가 핵심이다.<br>성능·확장성 측면에서는 대규모 스레드 동시 대기/깨움에서의 병목, NUMA 환경에서의 메모리 지연, 불필요한 신호 남용이 문제다.<br>실시간·임베디드 제약에서는 우선순위 역전, 예측 불가능한 대기 시간, 전력 효율 저하가 주요 이슈다.<br>아키텍처·환경 한계는 약한 메모리 모델에서의 일관성 문제, 프로세스/노드 경계를 넘어선 동기화 불가, 동기화 병목을 진단하기 어려운 점이 포함된다.</p><table><thead><tr><th>카테고리</th><th>과제</th><th>원인</th><th>영향</th><th>해결방안</th></tr></thead><tbody><tr><td><strong>기본 동기화 신뢰성</strong></td><td>Spurious Wakeup</td><td>OS/스케줄러 특성</td><td>불필요한 처리 반복</td><td><code>while</code> 조건 재검사</td></tr><tr><td></td><td>Lost Wakeup</td><td>잘못된 호출 순서</td><td>무한 대기</td><td>신호 - 대기 프로토콜 표준화</td></tr><tr><td></td><td>복잡한 Predicate</td><td>다중 조건·상태 관리</td><td>설계/디버깅 난이도 상승</td><td>상태 머신 도입</td></tr><tr><td><strong>성능·확장성</strong></td><td>대규모 병행 시 병목</td><td>수백~수천 스레드 broadcast</td><td>Context Switch 폭증</td><td>샤딩, rate-limit broadcast</td></tr><tr><td></td><td>NUMA Locality 문제</td><td>원격 메모리 접근</td><td>성능 저하</td><td>프로세서 친화성 설정</td></tr><tr><td></td><td>신호 남용</td><td>불필요한 notify_all</td><td>전체 성능 저하</td><td>조건별 CV 분리, notify_one 우선</td></tr><tr><td><strong>실시간·임베디드 제약</strong></td><td>우선순위 역전</td><td>낮은 우선순위 스레드의 락 보유</td><td>실시간 요구 불충족</td><td>PI 락, 작업 양도</td></tr><tr><td></td><td>실시간 보장 실패</td><td>비결정적 대기 시간</td><td>Deadline Miss</td><td>대기 시간 상한, 전용 스케줄러</td></tr><tr><td></td><td>에너지 효율성 저하</td><td>불필요한 깨어남</td><td>배터리 소모 증가</td><td>적응형 폴링, 배치 처리</td></tr><tr><td><strong>아키텍처·환경 한계</strong></td><td>메모리 일관성 문제</td><td>약한 메모리 모델</td><td>데이터 불일치</td><td>명시적 메모리 배리어</td></tr><tr><td></td><td>분산 환경 한계</td><td>노드 간 동기화 불가</td><td>기능 제약</td><td>메시지 브로커·스트림 결합</td></tr><tr><td></td><td>모니터링/진단 부재</td><td>병목/데드락 실시간 파악 불가</td><td>문제 장기화</td><td>동기화 이벤트 로깅/프로파일링</td></tr></tbody></table><p>조건 변수의 실무 난제는 <strong>신뢰성</strong>, <strong>성능</strong>, <strong>실시간성</strong>, <strong>환경 제약</strong>으로 구분된다.</p><ul><li>신뢰성: Spurious Wakeup 과 Lost Wakeup 은 조건 재검사와 표준화된 호출 순서로 해결 가능하지만, 복합 조건 동기화는 여전히 높은 설계 난이도를 가진다.</li><li>성능: 대규모 스레드 환경에서는 broadcast 최적화, NUMA 고려, 신호 남용 방지가 필요하다.</li><li>실시간성: 우선순위 역전 방지와 예측 가능한 응답 시간 확보가 필수이며, 전력 효율도 고려해야 한다.</li><li>환경 제약: 약한 메모리 모델, 분산 환경 동기화 한계, 모니터링 부재는 시스템 설계 초기부터 대응 전략을 포함해야 한다.</li></ul><h4 id=생태계-및-관련-기술>생태계 및 관련 기술<a hidden class=anchor aria-hidden=true href=#생태계-및-관련-기술>#</a></h4><table><thead><tr><th>카테고리</th><th>기술/예시</th><th>설명</th></tr></thead><tbody><tr><td><strong>동기화 프리미티브</strong></td><td>Mutex, RWLock, Semaphore, Barrier, Latch, Event, Atomic, CAS</td><td>조건 변수와 함께 자원 보호·신호 관리</td></tr><tr><td><strong>동시성 디자인 패턴</strong></td><td>Monitor, Producer-Consumer, Readers-Writers, Thread Pool, Future/Promise, Actor Model</td><td>조건 변수로 패턴 내 상태 대기/변경 제어</td></tr><tr><td><strong>표준 및 프로토콜</strong></td><td>POSIX <code>pthread_cond_t</code>, C++11 <code>std::condition_variable</code>, Java <code>Condition</code>, Go <code>sync.Cond</code>, Windows <code>CONDITION_VARIABLE</code></td><td>주요 언어·OS 에서 표준 제공</td></tr><tr><td><strong>OS/런타임 메커니즘</strong></td><td>Linux futex, JVM <code>LockSupport.park/unpark</code>, Go runtime scheduler</td><td>커널/VM 수준 효율적 대기·깨우기</td></tr><tr><td><strong>확장·응용 기술</strong></td><td>분산 큐, Pub/Sub, Reactive Streams, CSP, async/await, Transactional Memory, Wait-Free, Hazard Pointer, GPU CUDA/OpenCL events, Web Worker, SharedArrayBuffer Atomics</td><td>조건 변수 개념의 확장 적용 영역</td></tr></tbody></table><ul><li><strong>동기화 프리미티브</strong>: 조건 변수는 반드시 다른 동기화 객체와 결합해 사용하며, 이들이 기본 구성 요소.</li><li><strong>동시성 디자인 패턴</strong>: 고수준 패턴 내부의 상태 전환·대기 제어에 필수.</li><li><strong>표준 및 프로토콜</strong>: 모든 주요 언어·플랫폼에서 표준화된 API 제공으로 이식성이 우수.</li><li><strong>OS/런타임 메커니즘</strong>: 커널·런타임 수준에서 최적화된 대기/신호 처리 제공.</li><li><strong>확장·응용 기술</strong>: 단일 프로세스 스레드 동기화를 넘어 분산·비동기·GPU·웹 환경에도 확장 가능.</li></ul><h4 id=최신-트렌드와-미래-방향>최신 트렌드와 미래 방향<a hidden class=anchor aria-hidden=true href=#최신-트렌드와-미래-방향>#</a></h4><table><thead><tr><th>카테고리</th><th>핵심 트렌드</th><th>대표 기술/플랫폼</th><th>적용 포인트</th><th>리스크·한계</th></tr></thead><tbody><tr><td>언어·런타임 전환</td><td>구조화된 동시성, async 조건 대기</td><td>Python <code>TaskGroup</code>, Swift/Kotlin Concurrency, Rust async</td><td>수명/취소/타임아웃 일관성, 코드 단순화</td><td>동기/비동기 혼합 경계 복잡성</td></tr><tr><td>고성능/하드웨어</td><td>락프리/웨이트프리, NUMA-aware, HTM</td><td>atomics/CAS, shard-local, TSX(제한적)</td><td>p95/p99 지연 축소, 경합 완화</td><td>구현 난도↑, 디버깅 난이도↑</td></tr><tr><td>분산/클라우드</td><td>워크플로/오케스트레이션, 분산 락, Wasm Threads</td><td>Temporal, Step Functions, etcd/Consul, Wasm+SAB</td><td>조건 대기를 이벤트/상태머신으로 모델링</td><td>외부 의존·일관성/지연 트레이드오프</td></tr><tr><td>운영/관측성·자동화</td><td>OTel 표준 스팬, eBPF, 정책 자동화</td><td>OpenTelemetry, Grafana/Tempo, eBPF</td><td>병목 근본 원인 추적, 자동 튜닝</td><td>라벨 폭발·오버헤드 관리 필요</td></tr><tr><td>지능형 (ML/AI)</td><td>예측·적응형 조건 동기화</td><td>학습 기반 튜너, 이상 탐지</td><td>배치/타임아웃/notify 전략 자동화</td><td>데이터 품질·드리프트 리스크</td></tr><tr><td>미래 탐색</td><td>양자/뉴로모픽·가속기 협처리</td><td>양자 오라클, DPU/GPU 동기화</td><td>차세대 이벤트·시간 동기화 모델</td><td>실사용까지 시간·불확실성 큼</td></tr></tbody></table><p>2025 년의 조건 동기화는 <strong>언어·런타임 차원의 구조화된 비동기화</strong>, <strong>NUMA/락프리 기반의 고성능 경로</strong>, <strong>분산 오케스트레이션으로의 추상화</strong>, <strong>OTel·eBPF 중심의 관측성 내장</strong>, <strong>AI 에 의한 동적 정책 최적화</strong>로 진화 중이다.</p><p>실무에서는 " 핫패스=원자적/락프리, 콜드패스=CV&rdquo;, " 로컬=CV, 분산=워크플로/메시징 " 식의 <strong>하이브리드 설계</strong>가 가장 현실적인 선택지다.</p><h4 id=분산-조건-변수-distributed-condition-variable>분산 조건 변수 (Distributed Condition Variable)<a hidden class=anchor aria-hidden=true href=#분산-조건-변수-distributed-condition-variable>#</a></h4><p>분산 조건 변수는 <strong>여러 노드/프로세스가 네트워크를 통해 공유 상태를 관찰하고, 특정 조건 충족 시 대기 중인 작업을 깨우는 동기화 패턴</strong>이다.<br>기본 조건 변수는 단일 프로세스 내부 스레드 간 동기화만 가능하므로, 분산 환경에서는 다음과 같은 방식으로 확장한다.</p><h5 id=구성-요소-1>구성 요소<a hidden class=anchor aria-hidden=true href=#구성-요소-1>#</a></h5><ol><li><p><strong>상태 저장소 (State Store)</strong></p><ul><li>조건 충족 여부를 기록하는 신뢰성 있는 저장소</li><li>예: Redis, Etcd, ZooKeeper</li></ul></li><li><p><strong>이벤트 브로커 (Event Broker)</strong></p><ul><li>상태 변화 이벤트를 발행·구독 형태로 전파</li><li>예: Kafka, RabbitMQ, NATS</li></ul></li><li><p><strong>워커 노드 (Worker Nodes)</strong></p><ul><li>조건 충족 시 실제 동작을 수행하는 프로세스/스레드</li></ul></li></ol><h5 id=주요-구현-전략>주요 구현 전략<a hidden class=anchor aria-hidden=true href=#주요-구현-전략>#</a></h5><table><thead><tr><th>전략</th><th>장점</th><th>단점</th></tr></thead><tbody><tr><td>중앙 집중형</td><td>구조 단순, 관리 용이</td><td>SPOF 위험</td></tr><tr><td>분산 합의 기반</td><td>높은 신뢰성, 장애 복원</td><td>합의 지연</td></tr><tr><td>메시지 기반</td><td>확장성, 느슨한 결합</td><td>메시지 중복/유실 관리 필요</td></tr></tbody></table><h5 id=참조-아키텍처>참조 아키텍처<a hidden class=anchor aria-hidden=true href=#참조-아키텍처>#</a></h5><pre class=mermaid>graph LR
    subgraph Node1
        W1[Worker Thread] --&gt;|Wait| LocalListener
    end
    subgraph Node2
        W2[Worker Thread] --&gt;|Wait| LocalListener
    end
    subgraph Node3
        W3[Worker Thread] --&gt;|Wait| LocalListener
    end

    LocalListener --&gt;|Subscribe| Broker
    Broker --&gt;|Condition Event| LocalListener
    Broker --&gt; StateStore
    StateStore --&gt; Broker
</pre><h5 id=워크플로-조건-충족--이벤트-전파>워크플로 (조건 충족 → 이벤트 전파)<a hidden class=anchor aria-hidden=true href=#워크플로-조건-충족--이벤트-전파>#</a></h5><pre class=mermaid>sequenceDiagram
    participant P as Producer Service
    participant S as State Store
    participant B as Event Broker
    participant W as Worker Node

    P-&gt;&gt;S: Update condition state (e.g., count &gt;= threshold)
    S-&gt;&gt;B: Publish &#34;Condition Met&#34; event
    B--&gt;&gt;W: Notify subscribers
    W-&gt;&gt;W: Acquire local lock &amp; execute task
</pre><hr><h5 id=설계-시-고려사항>설계 시 고려사항<a hidden class=anchor aria-hidden=true href=#설계-시-고려사항>#</a></h5><table><thead><tr><th>고려 영역</th><th>설계 지침</th></tr></thead><tbody><tr><td>상태 저장소</td><td>단일 장애점 (SPOF) 방지 위해 고가용성 (HA) 구성</td></tr><tr><td>이벤트 브로커</td><td>Exactly-once 또는 At-least-once 전달 보장 선택</td></tr><tr><td>워커 로직</td><td>조건 충족 후에도 상태 재검사 필수 (네트워크 지연/중복 이벤트 대비)</td></tr><tr><td>보안</td><td>이벤트 채널 인증/인가, TLS 암호화</td></tr></tbody></table><h5 id=예시-1-시나리오>예시 1: 시나리오<a hidden class=anchor aria-hidden=true href=#예시-1-시나리오>#</a></h5><p><strong>조건</strong>: <code>counter >= THRESHOLD</code> 이면 작업 실행<br><strong>키 설계 (예)</strong></p><ul><li><code>cond:counter</code>: 현재 카운터</li><li><code>cond:version</code>: 상태 변경 버전 (정수 증가)</li><li><code>cond:done:v{N}</code>: 버전 N 에 대해 작업이 수행되었음을 기록 (멱등)</li><li><code>cond:lock</code>: 실행 락 (<code>SET NX PX</code>)</li><li>채널: <code>cond:channel</code>: 이벤트 발행 채널</li></ul><p><strong>메시지 페이로드 (문자열 JSON)</strong>: <code>{"version":123,"counter":100,"met":true}</code></p><p><strong>코드</strong>:</p><ul><li>Redis Pub/Sub + 상태 재검사 + 버전/락 적용 (Python)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a class=lnlinks href=#hl-45-1>  1</a>
</span><span class=lnt id=hl-45-2><a class=lnlinks href=#hl-45-2>  2</a>
</span><span class=lnt id=hl-45-3><a class=lnlinks href=#hl-45-3>  3</a>
</span><span class=lnt id=hl-45-4><a class=lnlinks href=#hl-45-4>  4</a>
</span><span class=lnt id=hl-45-5><a class=lnlinks href=#hl-45-5>  5</a>
</span><span class=lnt id=hl-45-6><a class=lnlinks href=#hl-45-6>  6</a>
</span><span class=lnt id=hl-45-7><a class=lnlinks href=#hl-45-7>  7</a>
</span><span class=lnt id=hl-45-8><a class=lnlinks href=#hl-45-8>  8</a>
</span><span class=lnt id=hl-45-9><a class=lnlinks href=#hl-45-9>  9</a>
</span><span class=lnt id=hl-45-10><a class=lnlinks href=#hl-45-10> 10</a>
</span><span class=lnt id=hl-45-11><a class=lnlinks href=#hl-45-11> 11</a>
</span><span class=lnt id=hl-45-12><a class=lnlinks href=#hl-45-12> 12</a>
</span><span class=lnt id=hl-45-13><a class=lnlinks href=#hl-45-13> 13</a>
</span><span class=lnt id=hl-45-14><a class=lnlinks href=#hl-45-14> 14</a>
</span><span class=lnt id=hl-45-15><a class=lnlinks href=#hl-45-15> 15</a>
</span><span class=lnt id=hl-45-16><a class=lnlinks href=#hl-45-16> 16</a>
</span><span class=lnt id=hl-45-17><a class=lnlinks href=#hl-45-17> 17</a>
</span><span class=lnt id=hl-45-18><a class=lnlinks href=#hl-45-18> 18</a>
</span><span class=lnt id=hl-45-19><a class=lnlinks href=#hl-45-19> 19</a>
</span><span class=lnt id=hl-45-20><a class=lnlinks href=#hl-45-20> 20</a>
</span><span class=lnt id=hl-45-21><a class=lnlinks href=#hl-45-21> 21</a>
</span><span class=lnt id=hl-45-22><a class=lnlinks href=#hl-45-22> 22</a>
</span><span class=lnt id=hl-45-23><a class=lnlinks href=#hl-45-23> 23</a>
</span><span class=lnt id=hl-45-24><a class=lnlinks href=#hl-45-24> 24</a>
</span><span class=lnt id=hl-45-25><a class=lnlinks href=#hl-45-25> 25</a>
</span><span class=lnt id=hl-45-26><a class=lnlinks href=#hl-45-26> 26</a>
</span><span class=lnt id=hl-45-27><a class=lnlinks href=#hl-45-27> 27</a>
</span><span class=lnt id=hl-45-28><a class=lnlinks href=#hl-45-28> 28</a>
</span><span class=lnt id=hl-45-29><a class=lnlinks href=#hl-45-29> 29</a>
</span><span class=lnt id=hl-45-30><a class=lnlinks href=#hl-45-30> 30</a>
</span><span class=lnt id=hl-45-31><a class=lnlinks href=#hl-45-31> 31</a>
</span><span class=lnt id=hl-45-32><a class=lnlinks href=#hl-45-32> 32</a>
</span><span class=lnt id=hl-45-33><a class=lnlinks href=#hl-45-33> 33</a>
</span><span class=lnt id=hl-45-34><a class=lnlinks href=#hl-45-34> 34</a>
</span><span class=lnt id=hl-45-35><a class=lnlinks href=#hl-45-35> 35</a>
</span><span class=lnt id=hl-45-36><a class=lnlinks href=#hl-45-36> 36</a>
</span><span class=lnt id=hl-45-37><a class=lnlinks href=#hl-45-37> 37</a>
</span><span class=lnt id=hl-45-38><a class=lnlinks href=#hl-45-38> 38</a>
</span><span class=lnt id=hl-45-39><a class=lnlinks href=#hl-45-39> 39</a>
</span><span class=lnt id=hl-45-40><a class=lnlinks href=#hl-45-40> 40</a>
</span><span class=lnt id=hl-45-41><a class=lnlinks href=#hl-45-41> 41</a>
</span><span class=lnt id=hl-45-42><a class=lnlinks href=#hl-45-42> 42</a>
</span><span class=lnt id=hl-45-43><a class=lnlinks href=#hl-45-43> 43</a>
</span><span class=lnt id=hl-45-44><a class=lnlinks href=#hl-45-44> 44</a>
</span><span class=lnt id=hl-45-45><a class=lnlinks href=#hl-45-45> 45</a>
</span><span class=lnt id=hl-45-46><a class=lnlinks href=#hl-45-46> 46</a>
</span><span class=lnt id=hl-45-47><a class=lnlinks href=#hl-45-47> 47</a>
</span><span class=lnt id=hl-45-48><a class=lnlinks href=#hl-45-48> 48</a>
</span><span class=lnt id=hl-45-49><a class=lnlinks href=#hl-45-49> 49</a>
</span><span class=lnt id=hl-45-50><a class=lnlinks href=#hl-45-50> 50</a>
</span><span class=lnt id=hl-45-51><a class=lnlinks href=#hl-45-51> 51</a>
</span><span class=lnt id=hl-45-52><a class=lnlinks href=#hl-45-52> 52</a>
</span><span class=lnt id=hl-45-53><a class=lnlinks href=#hl-45-53> 53</a>
</span><span class=lnt id=hl-45-54><a class=lnlinks href=#hl-45-54> 54</a>
</span><span class=lnt id=hl-45-55><a class=lnlinks href=#hl-45-55> 55</a>
</span><span class=lnt id=hl-45-56><a class=lnlinks href=#hl-45-56> 56</a>
</span><span class=lnt id=hl-45-57><a class=lnlinks href=#hl-45-57> 57</a>
</span><span class=lnt id=hl-45-58><a class=lnlinks href=#hl-45-58> 58</a>
</span><span class=lnt id=hl-45-59><a class=lnlinks href=#hl-45-59> 59</a>
</span><span class=lnt id=hl-45-60><a class=lnlinks href=#hl-45-60> 60</a>
</span><span class=lnt id=hl-45-61><a class=lnlinks href=#hl-45-61> 61</a>
</span><span class=lnt id=hl-45-62><a class=lnlinks href=#hl-45-62> 62</a>
</span><span class=lnt id=hl-45-63><a class=lnlinks href=#hl-45-63> 63</a>
</span><span class=lnt id=hl-45-64><a class=lnlinks href=#hl-45-64> 64</a>
</span><span class=lnt id=hl-45-65><a class=lnlinks href=#hl-45-65> 65</a>
</span><span class=lnt id=hl-45-66><a class=lnlinks href=#hl-45-66> 66</a>
</span><span class=lnt id=hl-45-67><a class=lnlinks href=#hl-45-67> 67</a>
</span><span class=lnt id=hl-45-68><a class=lnlinks href=#hl-45-68> 68</a>
</span><span class=lnt id=hl-45-69><a class=lnlinks href=#hl-45-69> 69</a>
</span><span class=lnt id=hl-45-70><a class=lnlinks href=#hl-45-70> 70</a>
</span><span class=lnt id=hl-45-71><a class=lnlinks href=#hl-45-71> 71</a>
</span><span class=lnt id=hl-45-72><a class=lnlinks href=#hl-45-72> 72</a>
</span><span class=lnt id=hl-45-73><a class=lnlinks href=#hl-45-73> 73</a>
</span><span class=lnt id=hl-45-74><a class=lnlinks href=#hl-45-74> 74</a>
</span><span class=lnt id=hl-45-75><a class=lnlinks href=#hl-45-75> 75</a>
</span><span class=lnt id=hl-45-76><a class=lnlinks href=#hl-45-76> 76</a>
</span><span class=lnt id=hl-45-77><a class=lnlinks href=#hl-45-77> 77</a>
</span><span class=lnt id=hl-45-78><a class=lnlinks href=#hl-45-78> 78</a>
</span><span class=lnt id=hl-45-79><a class=lnlinks href=#hl-45-79> 79</a>
</span><span class=lnt id=hl-45-80><a class=lnlinks href=#hl-45-80> 80</a>
</span><span class=lnt id=hl-45-81><a class=lnlinks href=#hl-45-81> 81</a>
</span><span class=lnt id=hl-45-82><a class=lnlinks href=#hl-45-82> 82</a>
</span><span class=lnt id=hl-45-83><a class=lnlinks href=#hl-45-83> 83</a>
</span><span class=lnt id=hl-45-84><a class=lnlinks href=#hl-45-84> 84</a>
</span><span class=lnt id=hl-45-85><a class=lnlinks href=#hl-45-85> 85</a>
</span><span class=lnt id=hl-45-86><a class=lnlinks href=#hl-45-86> 86</a>
</span><span class=lnt id=hl-45-87><a class=lnlinks href=#hl-45-87> 87</a>
</span><span class=lnt id=hl-45-88><a class=lnlinks href=#hl-45-88> 88</a>
</span><span class=lnt id=hl-45-89><a class=lnlinks href=#hl-45-89> 89</a>
</span><span class=lnt id=hl-45-90><a class=lnlinks href=#hl-45-90> 90</a>
</span><span class=lnt id=hl-45-91><a class=lnlinks href=#hl-45-91> 91</a>
</span><span class=lnt id=hl-45-92><a class=lnlinks href=#hl-45-92> 92</a>
</span><span class=lnt id=hl-45-93><a class=lnlinks href=#hl-45-93> 93</a>
</span><span class=lnt id=hl-45-94><a class=lnlinks href=#hl-45-94> 94</a>
</span><span class=lnt id=hl-45-95><a class=lnlinks href=#hl-45-95> 95</a>
</span><span class=lnt id=hl-45-96><a class=lnlinks href=#hl-45-96> 96</a>
</span><span class=lnt id=hl-45-97><a class=lnlinks href=#hl-45-97> 97</a>
</span><span class=lnt id=hl-45-98><a class=lnlinks href=#hl-45-98> 98</a>
</span><span class=lnt id=hl-45-99><a class=lnlinks href=#hl-45-99> 99</a>
</span><span class=lnt id=hl-45-100><a class=lnlinks href=#hl-45-100>100</a>
</span><span class=lnt id=hl-45-101><a class=lnlinks href=#hl-45-101>101</a>
</span><span class=lnt id=hl-45-102><a class=lnlinks href=#hl-45-102>102</a>
</span><span class=lnt id=hl-45-103><a class=lnlinks href=#hl-45-103>103</a>
</span><span class=lnt id=hl-45-104><a class=lnlinks href=#hl-45-104>104</a>
</span><span class=lnt id=hl-45-105><a class=lnlinks href=#hl-45-105>105</a>
</span><span class=lnt id=hl-45-106><a class=lnlinks href=#hl-45-106>106</a>
</span><span class=lnt id=hl-45-107><a class=lnlinks href=#hl-45-107>107</a>
</span><span class=lnt id=hl-45-108><a class=lnlinks href=#hl-45-108>108</a>
</span><span class=lnt id=hl-45-109><a class=lnlinks href=#hl-45-109>109</a>
</span><span class=lnt id=hl-45-110><a class=lnlinks href=#hl-45-110>110</a>
</span><span class=lnt id=hl-45-111><a class=lnlinks href=#hl-45-111>111</a>
</span><span class=lnt id=hl-45-112><a class=lnlinks href=#hl-45-112>112</a>
</span><span class=lnt id=hl-45-113><a class=lnlinks href=#hl-45-113>113</a>
</span><span class=lnt id=hl-45-114><a class=lnlinks href=#hl-45-114>114</a>
</span><span class=lnt id=hl-45-115><a class=lnlinks href=#hl-45-115>115</a>
</span><span class=lnt id=hl-45-116><a class=lnlinks href=#hl-45-116>116</a>
</span><span class=lnt id=hl-45-117><a class=lnlinks href=#hl-45-117>117</a>
</span><span class=lnt id=hl-45-118><a class=lnlinks href=#hl-45-118>118</a>
</span><span class=lnt id=hl-45-119><a class=lnlinks href=#hl-45-119>119</a>
</span><span class=lnt id=hl-45-120><a class=lnlinks href=#hl-45-120>120</a>
</span><span class=lnt id=hl-45-121><a class=lnlinks href=#hl-45-121>121</a>
</span><span class=lnt id=hl-45-122><a class=lnlinks href=#hl-45-122>122</a>
</span><span class=lnt id=hl-45-123><a class=lnlinks href=#hl-45-123>123</a>
</span><span class=lnt id=hl-45-124><a class=lnlinks href=#hl-45-124>124</a>
</span><span class=lnt id=hl-45-125><a class=lnlinks href=#hl-45-125>125</a>
</span><span class=lnt id=hl-45-126><a class=lnlinks href=#hl-45-126>126</a>
</span><span class=lnt id=hl-45-127><a class=lnlinks href=#hl-45-127>127</a>
</span><span class=lnt id=hl-45-128><a class=lnlinks href=#hl-45-128>128</a>
</span><span class=lnt id=hl-45-129><a class=lnlinks href=#hl-45-129>129</a>
</span><span class=lnt id=hl-45-130><a class=lnlinks href=#hl-45-130>130</a>
</span><span class=lnt id=hl-45-131><a class=lnlinks href=#hl-45-131>131</a>
</span><span class=lnt id=hl-45-132><a class=lnlinks href=#hl-45-132>132</a>
</span><span class=lnt id=hl-45-133><a class=lnlinks href=#hl-45-133>133</a>
</span><span class=lnt id=hl-45-134><a class=lnlinks href=#hl-45-134>134</a>
</span><span class=lnt id=hl-45-135><a class=lnlinks href=#hl-45-135>135</a>
</span><span class=lnt id=hl-45-136><a class=lnlinks href=#hl-45-136>136</a>
</span><span class=lnt id=hl-45-137><a class=lnlinks href=#hl-45-137>137</a>
</span><span class=lnt id=hl-45-138><a class=lnlinks href=#hl-45-138>138</a>
</span><span class=lnt id=hl-45-139><a class=lnlinks href=#hl-45-139>139</a>
</span><span class=lnt id=hl-45-140><a class=lnlinks href=#hl-45-140>140</a>
</span><span class=lnt id=hl-45-141><a class=lnlinks href=#hl-45-141>141</a>
</span><span class=lnt id=hl-45-142><a class=lnlinks href=#hl-45-142>142</a>
</span><span class=lnt id=hl-45-143><a class=lnlinks href=#hl-45-143>143</a>
</span><span class=lnt id=hl-45-144><a class=lnlinks href=#hl-45-144>144</a>
</span><span class=lnt id=hl-45-145><a class=lnlinks href=#hl-45-145>145</a>
</span><span class=lnt id=hl-45-146><a class=lnlinks href=#hl-45-146>146</a>
</span><span class=lnt id=hl-45-147><a class=lnlinks href=#hl-45-147>147</a>
</span><span class=lnt id=hl-45-148><a class=lnlinks href=#hl-45-148>148</a>
</span><span class=lnt id=hl-45-149><a class=lnlinks href=#hl-45-149>149</a>
</span><span class=lnt id=hl-45-150><a class=lnlinks href=#hl-45-150>150</a>
</span><span class=lnt id=hl-45-151><a class=lnlinks href=#hl-45-151>151</a>
</span><span class=lnt id=hl-45-152><a class=lnlinks href=#hl-45-152>152</a>
</span><span class=lnt id=hl-45-153><a class=lnlinks href=#hl-45-153>153</a>
</span><span class=lnt id=hl-45-154><a class=lnlinks href=#hl-45-154>154</a>
</span><span class=lnt id=hl-45-155><a class=lnlinks href=#hl-45-155>155</a>
</span><span class=lnt id=hl-45-156><a class=lnlinks href=#hl-45-156>156</a>
</span><span class=lnt id=hl-45-157><a class=lnlinks href=#hl-45-157>157</a>
</span><span class=lnt id=hl-45-158><a class=lnlinks href=#hl-45-158>158</a>
</span><span class=lnt id=hl-45-159><a class=lnlinks href=#hl-45-159>159</a>
</span><span class=lnt id=hl-45-160><a class=lnlinks href=#hl-45-160>160</a>
</span><span class=lnt id=hl-45-161><a class=lnlinks href=#hl-45-161>161</a>
</span><span class=lnt id=hl-45-162><a class=lnlinks href=#hl-45-162>162</a>
</span><span class=lnt id=hl-45-163><a class=lnlinks href=#hl-45-163>163</a>
</span><span class=lnt id=hl-45-164><a class=lnlinks href=#hl-45-164>164</a>
</span><span class=lnt id=hl-45-165><a class=lnlinks href=#hl-45-165>165</a>
</span><span class=lnt id=hl-45-166><a class=lnlinks href=#hl-45-166>166</a>
</span><span class=lnt id=hl-45-167><a class=lnlinks href=#hl-45-167>167</a>
</span><span class=lnt id=hl-45-168><a class=lnlinks href=#hl-45-168>168</a>
</span><span class=lnt id=hl-45-169><a class=lnlinks href=#hl-45-169>169</a>
</span><span class=lnt id=hl-45-170><a class=lnlinks href=#hl-45-170>170</a>
</span><span class=lnt id=hl-45-171><a class=lnlinks href=#hl-45-171>171</a>
</span><span class=lnt id=hl-45-172><a class=lnlinks href=#hl-45-172>172</a>
</span><span class=lnt id=hl-45-173><a class=lnlinks href=#hl-45-173>173</a>
</span><span class=lnt id=hl-45-174><a class=lnlinks href=#hl-45-174>174</a>
</span><span class=lnt id=hl-45-175><a class=lnlinks href=#hl-45-175>175</a>
</span><span class=lnt id=hl-45-176><a class=lnlinks href=#hl-45-176>176</a>
</span><span class=lnt id=hl-45-177><a class=lnlinks href=#hl-45-177>177</a>
</span><span class=lnt id=hl-45-178><a class=lnlinks href=#hl-45-178>178</a>
</span><span class=lnt id=hl-45-179><a class=lnlinks href=#hl-45-179>179</a>
</span><span class=lnt id=hl-45-180><a class=lnlinks href=#hl-45-180>180</a>
</span><span class=lnt id=hl-45-181><a class=lnlinks href=#hl-45-181>181</a>
</span><span class=lnt id=hl-45-182><a class=lnlinks href=#hl-45-182>182</a>
</span><span class=lnt id=hl-45-183><a class=lnlinks href=#hl-45-183>183</a>
</span><span class=lnt id=hl-45-184><a class=lnlinks href=#hl-45-184>184</a>
</span><span class=lnt id=hl-45-185><a class=lnlinks href=#hl-45-185>185</a>
</span><span class=lnt id=hl-45-186><a class=lnlinks href=#hl-45-186>186</a>
</span><span class=lnt id=hl-45-187><a class=lnlinks href=#hl-45-187>187</a>
</span><span class=lnt id=hl-45-188><a class=lnlinks href=#hl-45-188>188</a>
</span><span class=lnt id=hl-45-189><a class=lnlinks href=#hl-45-189>189</a>
</span><span class=lnt id=hl-45-190><a class=lnlinks href=#hl-45-190>190</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># 설정</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=n>REDIS_URL</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;REDIS_URL&#34;</span><span class=p>,</span> <span class=s2>&#34;redis://localhost:6379/0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CHANNEL</span> <span class=o>=</span> <span class=s2>&#34;cond:channel&#34;</span>
</span></span><span class=line><span class=cl><span class=n>KEY_COUNTER</span> <span class=o>=</span> <span class=s2>&#34;cond:counter&#34;</span>
</span></span><span class=line><span class=cl><span class=n>KEY_VERSION</span> <span class=o>=</span> <span class=s2>&#34;cond:version&#34;</span>
</span></span><span class=line><span class=cl><span class=n>KEY_LOCK</span> <span class=o>=</span> <span class=s2>&#34;cond:lock&#34;</span>               <span class=c1># 분산 락</span>
</span></span><span class=line><span class=cl><span class=n>LOCK_TTL_MS</span> <span class=o>=</span> <span class=mi>10_000</span>                 <span class=c1># 실행 락 TTL</span>
</span></span><span class=line><span class=cl><span class=n>THRESHOLD</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis 클라이언트</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=n>REDIS_URL</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># Lua 스크립트: 상태 업데이트 + 버전 증가 + 이벤트 발행 (원자적 처리)</span>
</span></span><span class=line><span class=cl><span class=c1># - counter를 delta만큼 증가</span>
</span></span><span class=line><span class=cl><span class=c1># - 만약 counter &gt;= THRESHOLD이면 version += 1</span>
</span></span><span class=line><span class=cl><span class=c1># - 이벤트 payload를 채널에 publish</span>
</span></span><span class=line><span class=cl><span class=c1># 반환: {version, counter, met}</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LUA_UPDATE_AND_PUBLISH</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>register_script</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>local key_counter = KEYS[1]
</span></span></span><span class=line><span class=cl><span class=s2>local key_version = KEYS[2]
</span></span></span><span class=line><span class=cl><span class=s2>local channel     = KEYS[3]
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>local delta       = tonumber(ARGV[1])
</span></span></span><span class=line><span class=cl><span class=s2>local threshold   = tonumber(ARGV[2])
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>-- 카운터 증가
</span></span></span><span class=line><span class=cl><span class=s2>local c = redis.call(&#39;INCRBY&#39;, key_counter, delta)
</span></span></span><span class=line><span class=cl><span class=s2>-- 버전 확인/증가
</span></span></span><span class=line><span class=cl><span class=s2>local v = tonumber(redis.call(&#39;GET&#39;, key_version) or &#39;0&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>local met = (c &gt;= threshold)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>if met then
</span></span></span><span class=line><span class=cl><span class=s2>  v = v + 1
</span></span></span><span class=line><span class=cl><span class=s2>  redis.call(&#39;SET&#39;, key_version, v)
</span></span></span><span class=line><span class=cl><span class=s2>  local payload = cjson.encode({version=v, counter=c, met=true})
</span></span></span><span class=line><span class=cl><span class=s2>  redis.call(&#39;PUBLISH&#39;, channel, payload)
</span></span></span><span class=line><span class=cl><span class=s2>  return {tostring(v), tostring(c), &#34;1&#34;}
</span></span></span><span class=line><span class=cl><span class=s2>else
</span></span></span><span class=line><span class=cl><span class=s2>  -- 조건 미충족이라도 상태 관측을 위해 알림이 필요할 수 있음(옵션)
</span></span></span><span class=line><span class=cl><span class=s2>  -- 여기선 발행하지 않음
</span></span></span><span class=line><span class=cl><span class=s2>  return {tostring(v), tostring(c), &#34;0&#34;}
</span></span></span><span class=line><span class=cl><span class=s2>end
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># 도우미: 분산 락 (SET NX PX) + 토큰 기반 해제</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>distributed_lock</span><span class=p>(</span><span class=n>lock_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>ttl_ms</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>px</span><span class=o>=</span><span class=n>ttl_ms</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ok</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>token</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 토큰 확인 후 해제 (멱등/안전)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pipe</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipe</span><span class=o>.</span><span class=n>watch</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>val</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipe</span><span class=o>.</span><span class=n>multi</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>val</span> <span class=o>==</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>pipe</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>pipe</span><span class=o>.</span><span class=n>unwatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipe</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>redis</span><span class=o>.</span><span class=n>WatchError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># 조건 재검사 함수: 이벤트 수신/폴링 시 공통 사용</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_and_execute</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    - Redis에서 현재 counter, version 읽기
</span></span></span><span class=line><span class=cl><span class=s2>    - 조건(counter &gt;= THRESHOLD)이 맞으면 분산 락 획득 후 &#39;한 번만&#39; 실행
</span></span></span><span class=line><span class=cl><span class=s2>    - 이미 처리한 version이면 건너뜀(멱등)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 현재 상태 읽기</span>
</span></span><span class=line><span class=cl>    <span class=n>pipe</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>counter</span><span class=p>,</span> <span class=n>version</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>KEY_COUNTER</span><span class=p>)</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>KEY_VERSION</span><span class=p>)</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>counter</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>counter</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>version</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>counter</span> <span class=o>&lt;</span> <span class=n>THRESHOLD</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 이미 처리했는지 버전 기반 멱등 체크</span>
</span></span><span class=line><span class=cl>    <span class=n>done_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;cond:done:v</span><span class=si>{</span><span class=n>version</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>done_key</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이미 처리됨</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 분산 락 획득</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>distributed_lock</span><span class=p>(</span><span class=n>KEY_LOCK</span><span class=p>,</span> <span class=n>LOCK_TTL_MS</span><span class=p>)</span> <span class=k>as</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 다른 노드가 처리 중</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=c1># 실행 섹션 (여기에 실제 작업 로직)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[EXECUTE] version=</span><span class=si>{</span><span class=n>version</span><span class=si>}</span><span class=s2> counter=</span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s2> (node=</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getpid</span><span class=p>()</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 실행 시간 시뮬레이션</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># Publisher 예시: 카운터 증가 API</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>publish_delta</span><span class=p>(</span><span class=n>delta</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;카운터를 늘리고, 조건 충족 시 원자적으로 이벤트 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>met</span> <span class=o>=</span> <span class=n>LUA_UPDATE_AND_PUBLISH</span><span class=p>(</span><span class=n>keys</span><span class=o>=</span><span class=p>[</span><span class=n>KEY_COUNTER</span><span class=p>,</span> <span class=n>KEY_VERSION</span><span class=p>,</span> <span class=n>CHANNEL</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                                       <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=n>delta</span><span class=p>,</span> <span class=n>THRESHOLD</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=p>,</span> <span class=n>counter</span><span class=p>,</span> <span class=n>met_flag</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>v</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>c</span><span class=p>),</span> <span class=p>(</span><span class=n>met</span> <span class=o>==</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[PUBLISH] delta=</span><span class=si>{</span><span class=n>delta</span><span class=si>}</span><span class=s2> counter=</span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s2> version=</span><span class=si>{</span><span class=n>version</span><span class=si>}</span><span class=s2> met=</span><span class=si>{</span><span class=n>met_flag</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>version</span><span class=p>,</span> <span class=n>counter</span><span class=p>,</span> <span class=n>met_flag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># Subscriber: Pub/Sub 수신 + 상태 재검사</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>subscriber_loop</span><span class=p>(</span><span class=n>poll_interval</span><span class=o>=</span><span class=mf>5.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    - Pub/Sub로 이벤트 수신 시 즉시 재검사
</span></span></span><span class=line><span class=cl><span class=s2>    - 이벤트 유실/순서 뒤바뀜 대비로 주기 폴링도 병행
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>pubsub</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pubsub</span><span class=p>(</span><span class=n>ignore_subscribe_messages</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pubsub</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=n>CHANNEL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>last_poll</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[SUB] started. waiting for events...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>pubsub</span><span class=o>.</span><span class=n>listen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>message</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>message</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;message&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>payload</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>payload</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[SUB] event: </span><span class=si>{</span><span class=n>payload</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 이벤트 수신 후에도 반드시 재검사</span>
</span></span><span class=line><span class=cl>            <span class=n>check_and_execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 주기 폴링 (이벤트 유실 대비)</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>last_poll</span> <span class=o>&gt;=</span> <span class=n>poll_interval</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>last_poll</span> <span class=o>=</span> <span class=n>now</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[SUB] periodic poll&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>check_and_execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># 데모: 프로듀서/서브스크라이버 실행</span>
</span></span><span class=line><span class=cl><span class=c1># -------------------------------</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>demo</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 초기화(데모용): 카운터/버전 리셋</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>mset</span><span class=p>({</span><span class=n>KEY_COUNTER</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=n>KEY_VERSION</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=c1># Subscriber 스레드 시작</span>
</span></span><span class=line><span class=cl>    <span class=n>t_sub</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>subscriber_loop</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t_sub</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 프로듀서 시뮬레이션</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>15</span><span class=p>]:</span>  <span class=c1># 합계 125 → 임계치 100 넘김</span>
</span></span><span class=line><span class=cl>        <span class=n>publish_delta</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 처리가 끝날 시간 대기</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>2.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>demo</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>상태 변경과 이벤트 발행의 원자성</strong>: Lua 스크립트로 <code>INCRBY(counter) → (충족 시) version++ → PUBLISH</code> 를 한 번에 수행</li><li><strong>상태 재검사</strong>: Subscriber 는 이벤트 수신 후 ** 반드시 <code>check_and_execute()</code>** 로 Redis 에서 현 상태 재확인</li><li><strong>멱등성</strong>: <code>cond:done:v{version}</code> 키로 <strong>버전 단위 1 회 실행 보장</strong></li><li><strong>분산 락</strong>: <code>SET cond:lock NX PX</code> + 토큰 검증으로 <strong>동시 실행 방지</strong></li><li><strong>유실 대비</strong>: 주기 폴링을 병행해 이벤트를 놓쳐도 <strong>결국 실행</strong></li><li><strong>운영 팁</strong>: 실제 환경에서는 Redis ACL/TLS, Redis Cluster/Replica, 모니터링 (실행 횟수·중복률·지연) 을 함께 구성</li></ul><h5 id=예시-2-시나리오>예시 2: 시나리오<a hidden class=anchor aria-hidden=true href=#예시-2-시나리오>#</a></h5><p><strong>Producer 서비스</strong>가 Redis 상태를 갱신하고, <strong>조건 충족 시 Kafka 토픽으로 이벤트 발행</strong>.<br><strong>Worker 서비스</strong>는 Kafka 를 구독해 이벤트를 받고 <strong>다시 Redis 에서 조건을 재검사</strong>한 뒤, <strong>분산 락 + 멱등 처리</strong>로 안전하게 작업을 수행.</p><p><strong>시스템 구성</strong>:</p><ul><li>상태저장소: Redis</li><li>이벤트 브로커: Kafka</li><li>워커 노드</li></ul><p><strong>공통: 키/토픽 설계와 환경 변수</strong>:</p><ul><li><p>Redis 키</p><ul><li><code>cond:counter</code>: 누적 카운터 값</li><li><code>cond:version</code>: 상태 변경 버전 (정수 증가)</li><li><code>cond:done:v{N}</code>: 버전 N 처리 여부 (멱등 확인용)</li><li><code>cond:lock</code>: 실행 락 키</li></ul></li><li><p>Kafka 토픽</p><ul><li><code>condition.events</code>: 조건 충족 이벤트를 발행하는 토픽</li></ul></li><li><p>임계치</p><ul><li><code>THRESHOLD = 100</code> (예시)</li></ul></li></ul><p><strong>환경 변수</strong>: 둘 다 서비스에서 공통 사용</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a class=lnlinks href=#hl-46-1>1</a>
</span><span class=lnt id=hl-46-2><a class=lnlinks href=#hl-46-2>2</a>
</span><span class=lnt id=hl-46-3><a class=lnlinks href=#hl-46-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>REDIS_URL</span><span class=o>=</span><span class=s2>&#34;redis://localhost:6379/0&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KAFKA_BOOTSTRAP</span><span class=o>=</span><span class=s2>&#34;localhost:9092&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KAFKA_TOPIC</span><span class=o>=</span><span class=s2>&#34;condition.events&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>코드</strong>:</p><ol><li><p><code>shared.py</code> - 공통 유틸 (Redis/Lua, 락, 상수)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a class=lnlinks href=#hl-47-1> 1</a>
</span><span class=lnt id=hl-47-2><a class=lnlinks href=#hl-47-2> 2</a>
</span><span class=lnt id=hl-47-3><a class=lnlinks href=#hl-47-3> 3</a>
</span><span class=lnt id=hl-47-4><a class=lnlinks href=#hl-47-4> 4</a>
</span><span class=lnt id=hl-47-5><a class=lnlinks href=#hl-47-5> 5</a>
</span><span class=lnt id=hl-47-6><a class=lnlinks href=#hl-47-6> 6</a>
</span><span class=lnt id=hl-47-7><a class=lnlinks href=#hl-47-7> 7</a>
</span><span class=lnt id=hl-47-8><a class=lnlinks href=#hl-47-8> 8</a>
</span><span class=lnt id=hl-47-9><a class=lnlinks href=#hl-47-9> 9</a>
</span><span class=lnt id=hl-47-10><a class=lnlinks href=#hl-47-10>10</a>
</span><span class=lnt id=hl-47-11><a class=lnlinks href=#hl-47-11>11</a>
</span><span class=lnt id=hl-47-12><a class=lnlinks href=#hl-47-12>12</a>
</span><span class=lnt id=hl-47-13><a class=lnlinks href=#hl-47-13>13</a>
</span><span class=lnt id=hl-47-14><a class=lnlinks href=#hl-47-14>14</a>
</span><span class=lnt id=hl-47-15><a class=lnlinks href=#hl-47-15>15</a>
</span><span class=lnt id=hl-47-16><a class=lnlinks href=#hl-47-16>16</a>
</span><span class=lnt id=hl-47-17><a class=lnlinks href=#hl-47-17>17</a>
</span><span class=lnt id=hl-47-18><a class=lnlinks href=#hl-47-18>18</a>
</span><span class=lnt id=hl-47-19><a class=lnlinks href=#hl-47-19>19</a>
</span><span class=lnt id=hl-47-20><a class=lnlinks href=#hl-47-20>20</a>
</span><span class=lnt id=hl-47-21><a class=lnlinks href=#hl-47-21>21</a>
</span><span class=lnt id=hl-47-22><a class=lnlinks href=#hl-47-22>22</a>
</span><span class=lnt id=hl-47-23><a class=lnlinks href=#hl-47-23>23</a>
</span><span class=lnt id=hl-47-24><a class=lnlinks href=#hl-47-24>24</a>
</span><span class=lnt id=hl-47-25><a class=lnlinks href=#hl-47-25>25</a>
</span><span class=lnt id=hl-47-26><a class=lnlinks href=#hl-47-26>26</a>
</span><span class=lnt id=hl-47-27><a class=lnlinks href=#hl-47-27>27</a>
</span><span class=lnt id=hl-47-28><a class=lnlinks href=#hl-47-28>28</a>
</span><span class=lnt id=hl-47-29><a class=lnlinks href=#hl-47-29>29</a>
</span><span class=lnt id=hl-47-30><a class=lnlinks href=#hl-47-30>30</a>
</span><span class=lnt id=hl-47-31><a class=lnlinks href=#hl-47-31>31</a>
</span><span class=lnt id=hl-47-32><a class=lnlinks href=#hl-47-32>32</a>
</span><span class=lnt id=hl-47-33><a class=lnlinks href=#hl-47-33>33</a>
</span><span class=lnt id=hl-47-34><a class=lnlinks href=#hl-47-34>34</a>
</span><span class=lnt id=hl-47-35><a class=lnlinks href=#hl-47-35>35</a>
</span><span class=lnt id=hl-47-36><a class=lnlinks href=#hl-47-36>36</a>
</span><span class=lnt id=hl-47-37><a class=lnlinks href=#hl-47-37>37</a>
</span><span class=lnt id=hl-47-38><a class=lnlinks href=#hl-47-38>38</a>
</span><span class=lnt id=hl-47-39><a class=lnlinks href=#hl-47-39>39</a>
</span><span class=lnt id=hl-47-40><a class=lnlinks href=#hl-47-40>40</a>
</span><span class=lnt id=hl-47-41><a class=lnlinks href=#hl-47-41>41</a>
</span><span class=lnt id=hl-47-42><a class=lnlinks href=#hl-47-42>42</a>
</span><span class=lnt id=hl-47-43><a class=lnlinks href=#hl-47-43>43</a>
</span><span class=lnt id=hl-47-44><a class=lnlinks href=#hl-47-44>44</a>
</span><span class=lnt id=hl-47-45><a class=lnlinks href=#hl-47-45>45</a>
</span><span class=lnt id=hl-47-46><a class=lnlinks href=#hl-47-46>46</a>
</span><span class=lnt id=hl-47-47><a class=lnlinks href=#hl-47-47>47</a>
</span><span class=lnt id=hl-47-48><a class=lnlinks href=#hl-47-48>48</a>
</span><span class=lnt id=hl-47-49><a class=lnlinks href=#hl-47-49>49</a>
</span><span class=lnt id=hl-47-50><a class=lnlinks href=#hl-47-50>50</a>
</span><span class=lnt id=hl-47-51><a class=lnlinks href=#hl-47-51>51</a>
</span><span class=lnt id=hl-47-52><a class=lnlinks href=#hl-47-52>52</a>
</span><span class=lnt id=hl-47-53><a class=lnlinks href=#hl-47-53>53</a>
</span><span class=lnt id=hl-47-54><a class=lnlinks href=#hl-47-54>54</a>
</span><span class=lnt id=hl-47-55><a class=lnlinks href=#hl-47-55>55</a>
</span><span class=lnt id=hl-47-56><a class=lnlinks href=#hl-47-56>56</a>
</span><span class=lnt id=hl-47-57><a class=lnlinks href=#hl-47-57>57</a>
</span><span class=lnt id=hl-47-58><a class=lnlinks href=#hl-47-58>58</a>
</span><span class=lnt id=hl-47-59><a class=lnlinks href=#hl-47-59>59</a>
</span><span class=lnt id=hl-47-60><a class=lnlinks href=#hl-47-60>60</a>
</span><span class=lnt id=hl-47-61><a class=lnlinks href=#hl-47-61>61</a>
</span><span class=lnt id=hl-47-62><a class=lnlinks href=#hl-47-62>62</a>
</span><span class=lnt id=hl-47-63><a class=lnlinks href=#hl-47-63>63</a>
</span><span class=lnt id=hl-47-64><a class=lnlinks href=#hl-47-64>64</a>
</span><span class=lnt id=hl-47-65><a class=lnlinks href=#hl-47-65>65</a>
</span><span class=lnt id=hl-47-66><a class=lnlinks href=#hl-47-66>66</a>
</span><span class=lnt id=hl-47-67><a class=lnlinks href=#hl-47-67>67</a>
</span><span class=lnt id=hl-47-68><a class=lnlinks href=#hl-47-68>68</a>
</span><span class=lnt id=hl-47-69><a class=lnlinks href=#hl-47-69>69</a>
</span><span class=lnt id=hl-47-70><a class=lnlinks href=#hl-47-70>70</a>
</span><span class=lnt id=hl-47-71><a class=lnlinks href=#hl-47-71>71</a>
</span><span class=lnt id=hl-47-72><a class=lnlinks href=#hl-47-72>72</a>
</span><span class=lnt id=hl-47-73><a class=lnlinks href=#hl-47-73>73</a>
</span><span class=lnt id=hl-47-74><a class=lnlinks href=#hl-47-74>74</a>
</span><span class=lnt id=hl-47-75><a class=lnlinks href=#hl-47-75>75</a>
</span><span class=lnt id=hl-47-76><a class=lnlinks href=#hl-47-76>76</a>
</span><span class=lnt id=hl-47-77><a class=lnlinks href=#hl-47-77>77</a>
</span><span class=lnt id=hl-47-78><a class=lnlinks href=#hl-47-78>78</a>
</span><span class=lnt id=hl-47-79><a class=lnlinks href=#hl-47-79>79</a>
</span><span class=lnt id=hl-47-80><a class=lnlinks href=#hl-47-80>80</a>
</span><span class=lnt id=hl-47-81><a class=lnlinks href=#hl-47-81>81</a>
</span><span class=lnt id=hl-47-82><a class=lnlinks href=#hl-47-82>82</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># shared.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 환경 변수 -----</span>
</span></span><span class=line><span class=cl><span class=n>REDIS_URL</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;REDIS_URL&#34;</span><span class=p>,</span> <span class=s2>&#34;redis://localhost:6379/0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>KAFKA_BOOTSTRAP</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;KAFKA_BOOTSTRAP&#34;</span><span class=p>,</span> <span class=s2>&#34;localhost:9092&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>KAFKA_TOPIC</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;KAFKA_TOPIC&#34;</span><span class=p>,</span> <span class=s2>&#34;condition.events&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 비즈니스 상수 -----</span>
</span></span><span class=line><span class=cl><span class=n>THRESHOLD</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;THRESHOLD&#34;</span><span class=p>,</span> <span class=s2>&#34;100&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>KEY_COUNTER</span> <span class=o>=</span> <span class=s2>&#34;cond:counter&#34;</span>
</span></span><span class=line><span class=cl><span class=n>KEY_VERSION</span> <span class=o>=</span> <span class=s2>&#34;cond:version&#34;</span>
</span></span><span class=line><span class=cl><span class=n>KEY_DONE_FMT</span> <span class=o>=</span> <span class=s2>&#34;cond:done:v</span><span class=si>{}</span><span class=s2>&#34;</span>   <span class=c1># 멱등 검사용</span>
</span></span><span class=line><span class=cl><span class=n>KEY_LOCK</span> <span class=o>=</span> <span class=s2>&#34;cond:lock&#34;</span>           <span class=c1># 분산 락 키</span>
</span></span><span class=line><span class=cl><span class=n>LOCK_TTL_MS</span> <span class=o>=</span> <span class=mi>10_000</span>             <span class=c1># 분산 락 TTL(ms)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- Redis 클라이언트 -----</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=n>REDIS_URL</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 상태 업데이트 &amp; 버전 증가 (원자적) -----</span>
</span></span><span class=line><span class=cl><span class=c1># counter += delta; if counter &gt;= THRESHOLD: version += 1 (조건 충족)</span>
</span></span><span class=line><span class=cl><span class=c1># 반환: version, counter, met_flag(&#34;1&#34;/&#34;0&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>LUA_UPDATE</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>register_script</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>local key_counter = KEYS[1]
</span></span></span><span class=line><span class=cl><span class=s2>local key_version = KEYS[2]
</span></span></span><span class=line><span class=cl><span class=s2>local delta       = tonumber(ARGV[1])
</span></span></span><span class=line><span class=cl><span class=s2>local threshold   = tonumber(ARGV[2])
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>local c = redis.call(&#39;INCRBY&#39;, key_counter, delta)
</span></span></span><span class=line><span class=cl><span class=s2>local v = tonumber(redis.call(&#39;GET&#39;, key_version) or &#39;0&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>local met = (c &gt;= threshold)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>if met then
</span></span></span><span class=line><span class=cl><span class=s2>  v = v + 1
</span></span></span><span class=line><span class=cl><span class=s2>  redis.call(&#39;SET&#39;, key_version, v)
</span></span></span><span class=line><span class=cl><span class=s2>  return {tostring(v), tostring(c), &#34;1&#34;}
</span></span></span><span class=line><span class=cl><span class=s2>else
</span></span></span><span class=line><span class=cl><span class=s2>  return {tostring(v), tostring(c), &#34;0&#34;}
</span></span></span><span class=line><span class=cl><span class=s2>end
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>atomic_update_counter</span><span class=p>(</span><span class=n>delta</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;counter를 원자적으로 증가시키고 조건 충족 여부를 계산.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>met</span> <span class=o>=</span> <span class=n>LUA_UPDATE</span><span class=p>(</span><span class=n>keys</span><span class=o>=</span><span class=p>[</span><span class=n>KEY_COUNTER</span><span class=p>,</span> <span class=n>KEY_VERSION</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                           <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=n>delta</span><span class=p>,</span> <span class=n>THRESHOLD</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>v</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>c</span><span class=p>),</span> <span class=p>(</span><span class=n>met</span> <span class=o>==</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 분산 락 (SET NX PX) + 토큰 검증 해제 -----</span>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>distributed_lock</span><span class=p>(</span><span class=n>lock_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>ttl_ms</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>px</span><span class=o>=</span><span class=n>ttl_ms</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>token</span> <span class=k>if</span> <span class=n>ok</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 토큰 일치 시에만 해제 (안전/멱등)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>pipe</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipe</span><span class=o>.</span><span class=n>watch</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>val</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipe</span><span class=o>.</span><span class=n>multi</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>val</span> <span class=o>==</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>pipe</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>pipe</span><span class=o>.</span><span class=n>unwatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipe</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>redis</span><span class=o>.</span><span class=n>WatchError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_event</span><span class=p>(</span><span class=n>version</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>counter</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>met</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Kafka 페이로드(문자열 JSON)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s2>&#34;version&#34;</span><span class=p>:</span> <span class=n>version</span><span class=p>,</span> <span class=s2>&#34;counter&#34;</span><span class=p>:</span> <span class=n>counter</span><span class=p>,</span> <span class=s2>&#34;met&#34;</span><span class=p>:</span> <span class=nb>bool</span><span class=p>(</span><span class=n>met</span><span class=p>)})</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><code>producer_app.py</code> - <strong>상태저장소 (Redis) 갱신 + Kafka 이벤트 발행</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a class=lnlinks href=#hl-48-1> 1</a>
</span><span class=lnt id=hl-48-2><a class=lnlinks href=#hl-48-2> 2</a>
</span><span class=lnt id=hl-48-3><a class=lnlinks href=#hl-48-3> 3</a>
</span><span class=lnt id=hl-48-4><a class=lnlinks href=#hl-48-4> 4</a>
</span><span class=lnt id=hl-48-5><a class=lnlinks href=#hl-48-5> 5</a>
</span><span class=lnt id=hl-48-6><a class=lnlinks href=#hl-48-6> 6</a>
</span><span class=lnt id=hl-48-7><a class=lnlinks href=#hl-48-7> 7</a>
</span><span class=lnt id=hl-48-8><a class=lnlinks href=#hl-48-8> 8</a>
</span><span class=lnt id=hl-48-9><a class=lnlinks href=#hl-48-9> 9</a>
</span><span class=lnt id=hl-48-10><a class=lnlinks href=#hl-48-10>10</a>
</span><span class=lnt id=hl-48-11><a class=lnlinks href=#hl-48-11>11</a>
</span><span class=lnt id=hl-48-12><a class=lnlinks href=#hl-48-12>12</a>
</span><span class=lnt id=hl-48-13><a class=lnlinks href=#hl-48-13>13</a>
</span><span class=lnt id=hl-48-14><a class=lnlinks href=#hl-48-14>14</a>
</span><span class=lnt id=hl-48-15><a class=lnlinks href=#hl-48-15>15</a>
</span><span class=lnt id=hl-48-16><a class=lnlinks href=#hl-48-16>16</a>
</span><span class=lnt id=hl-48-17><a class=lnlinks href=#hl-48-17>17</a>
</span><span class=lnt id=hl-48-18><a class=lnlinks href=#hl-48-18>18</a>
</span><span class=lnt id=hl-48-19><a class=lnlinks href=#hl-48-19>19</a>
</span><span class=lnt id=hl-48-20><a class=lnlinks href=#hl-48-20>20</a>
</span><span class=lnt id=hl-48-21><a class=lnlinks href=#hl-48-21>21</a>
</span><span class=lnt id=hl-48-22><a class=lnlinks href=#hl-48-22>22</a>
</span><span class=lnt id=hl-48-23><a class=lnlinks href=#hl-48-23>23</a>
</span><span class=lnt id=hl-48-24><a class=lnlinks href=#hl-48-24>24</a>
</span><span class=lnt id=hl-48-25><a class=lnlinks href=#hl-48-25>25</a>
</span><span class=lnt id=hl-48-26><a class=lnlinks href=#hl-48-26>26</a>
</span><span class=lnt id=hl-48-27><a class=lnlinks href=#hl-48-27>27</a>
</span><span class=lnt id=hl-48-28><a class=lnlinks href=#hl-48-28>28</a>
</span><span class=lnt id=hl-48-29><a class=lnlinks href=#hl-48-29>29</a>
</span><span class=lnt id=hl-48-30><a class=lnlinks href=#hl-48-30>30</a>
</span><span class=lnt id=hl-48-31><a class=lnlinks href=#hl-48-31>31</a>
</span><span class=lnt id=hl-48-32><a class=lnlinks href=#hl-48-32>32</a>
</span><span class=lnt id=hl-48-33><a class=lnlinks href=#hl-48-33>33</a>
</span><span class=lnt id=hl-48-34><a class=lnlinks href=#hl-48-34>34</a>
</span><span class=lnt id=hl-48-35><a class=lnlinks href=#hl-48-35>35</a>
</span><span class=lnt id=hl-48-36><a class=lnlinks href=#hl-48-36>36</a>
</span><span class=lnt id=hl-48-37><a class=lnlinks href=#hl-48-37>37</a>
</span><span class=lnt id=hl-48-38><a class=lnlinks href=#hl-48-38>38</a>
</span><span class=lnt id=hl-48-39><a class=lnlinks href=#hl-48-39>39</a>
</span><span class=lnt id=hl-48-40><a class=lnlinks href=#hl-48-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># producer_app.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaProducer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>shared</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=p>,</span> <span class=n>atomic_update_counter</span><span class=p>,</span> <span class=n>build_event</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>KAFKA_BOOTSTRAP</span><span class=p>,</span> <span class=n>KAFKA_TOPIC</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>new_producer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># KafkaProducer: JSON은 bytes로 보내야 하므로 utf-8 인코딩</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>KafkaProducer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap_servers</span><span class=o>=</span><span class=n>KAFKA_BOOTSTRAP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>linger_ms</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>value_serializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>v</span><span class=p>:</span> <span class=n>v</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>publish_event</span><span class=p>(</span><span class=n>producer</span><span class=p>:</span> <span class=n>KafkaProducer</span><span class=p>,</span> <span class=n>payload</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 비동기 전송, 필요 시 future.get(timeout)으로 동기화 가능</span>
</span></span><span class=line><span class=cl>    <span class=n>producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>KAFKA_TOPIC</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 데모: counter를 여러 번 증가시키며 임계치 도달 시 이벤트 발행</span>
</span></span><span class=line><span class=cl>    <span class=n>producer</span> <span class=o>=</span> <span class=n>new_producer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>deltas</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>15</span><span class=p>]</span>  <span class=c1># 합계 125 → 임계치(100) 넘김</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>deltas</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span><span class=p>,</span> <span class=n>counter</span><span class=p>,</span> <span class=n>met</span> <span class=o>=</span> <span class=n>atomic_update_counter</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[PRODUCER] delta=</span><span class=si>{</span><span class=n>d</span><span class=si>}</span><span class=s2> counter=</span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s2> version=</span><span class=si>{</span><span class=n>version</span><span class=si>}</span><span class=s2> met=</span><span class=si>{</span><span class=n>met</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>met</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 조건 충족 시 Kafka에 이벤트 발행</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>=</span> <span class=n>build_event</span><span class=p>(</span><span class=n>version</span><span class=p>,</span> <span class=n>counter</span><span class=p>,</span> <span class=n>met</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>publish_event</span><span class=p>(</span><span class=n>producer</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>producer</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[PRODUCER] done.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>상태 변경 (<code>counter += delta</code>) 과 조건 판단 (임계치 도달) 은 <strong>Redis Lua</strong>로 원자적 처리.</li><li>조건 충족 시에만 <strong>Kafka 토픽으로 이벤트 발행</strong>.</li><li>Kafka 는 <strong>이벤트 브로커 역할</strong>만 수행하며, **진실의 근원 (SSOT)**은 언제나 Redis.</li></ul></li><li><p><code>worker_app.py</code> - <strong>Kafka 구독 + Redis 재검사 + 분산 락/멱등 처리</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a class=lnlinks href=#hl-49-1> 1</a>
</span><span class=lnt id=hl-49-2><a class=lnlinks href=#hl-49-2> 2</a>
</span><span class=lnt id=hl-49-3><a class=lnlinks href=#hl-49-3> 3</a>
</span><span class=lnt id=hl-49-4><a class=lnlinks href=#hl-49-4> 4</a>
</span><span class=lnt id=hl-49-5><a class=lnlinks href=#hl-49-5> 5</a>
</span><span class=lnt id=hl-49-6><a class=lnlinks href=#hl-49-6> 6</a>
</span><span class=lnt id=hl-49-7><a class=lnlinks href=#hl-49-7> 7</a>
</span><span class=lnt id=hl-49-8><a class=lnlinks href=#hl-49-8> 8</a>
</span><span class=lnt id=hl-49-9><a class=lnlinks href=#hl-49-9> 9</a>
</span><span class=lnt id=hl-49-10><a class=lnlinks href=#hl-49-10>10</a>
</span><span class=lnt id=hl-49-11><a class=lnlinks href=#hl-49-11>11</a>
</span><span class=lnt id=hl-49-12><a class=lnlinks href=#hl-49-12>12</a>
</span><span class=lnt id=hl-49-13><a class=lnlinks href=#hl-49-13>13</a>
</span><span class=lnt id=hl-49-14><a class=lnlinks href=#hl-49-14>14</a>
</span><span class=lnt id=hl-49-15><a class=lnlinks href=#hl-49-15>15</a>
</span><span class=lnt id=hl-49-16><a class=lnlinks href=#hl-49-16>16</a>
</span><span class=lnt id=hl-49-17><a class=lnlinks href=#hl-49-17>17</a>
</span><span class=lnt id=hl-49-18><a class=lnlinks href=#hl-49-18>18</a>
</span><span class=lnt id=hl-49-19><a class=lnlinks href=#hl-49-19>19</a>
</span><span class=lnt id=hl-49-20><a class=lnlinks href=#hl-49-20>20</a>
</span><span class=lnt id=hl-49-21><a class=lnlinks href=#hl-49-21>21</a>
</span><span class=lnt id=hl-49-22><a class=lnlinks href=#hl-49-22>22</a>
</span><span class=lnt id=hl-49-23><a class=lnlinks href=#hl-49-23>23</a>
</span><span class=lnt id=hl-49-24><a class=lnlinks href=#hl-49-24>24</a>
</span><span class=lnt id=hl-49-25><a class=lnlinks href=#hl-49-25>25</a>
</span><span class=lnt id=hl-49-26><a class=lnlinks href=#hl-49-26>26</a>
</span><span class=lnt id=hl-49-27><a class=lnlinks href=#hl-49-27>27</a>
</span><span class=lnt id=hl-49-28><a class=lnlinks href=#hl-49-28>28</a>
</span><span class=lnt id=hl-49-29><a class=lnlinks href=#hl-49-29>29</a>
</span><span class=lnt id=hl-49-30><a class=lnlinks href=#hl-49-30>30</a>
</span><span class=lnt id=hl-49-31><a class=lnlinks href=#hl-49-31>31</a>
</span><span class=lnt id=hl-49-32><a class=lnlinks href=#hl-49-32>32</a>
</span><span class=lnt id=hl-49-33><a class=lnlinks href=#hl-49-33>33</a>
</span><span class=lnt id=hl-49-34><a class=lnlinks href=#hl-49-34>34</a>
</span><span class=lnt id=hl-49-35><a class=lnlinks href=#hl-49-35>35</a>
</span><span class=lnt id=hl-49-36><a class=lnlinks href=#hl-49-36>36</a>
</span><span class=lnt id=hl-49-37><a class=lnlinks href=#hl-49-37>37</a>
</span><span class=lnt id=hl-49-38><a class=lnlinks href=#hl-49-38>38</a>
</span><span class=lnt id=hl-49-39><a class=lnlinks href=#hl-49-39>39</a>
</span><span class=lnt id=hl-49-40><a class=lnlinks href=#hl-49-40>40</a>
</span><span class=lnt id=hl-49-41><a class=lnlinks href=#hl-49-41>41</a>
</span><span class=lnt id=hl-49-42><a class=lnlinks href=#hl-49-42>42</a>
</span><span class=lnt id=hl-49-43><a class=lnlinks href=#hl-49-43>43</a>
</span><span class=lnt id=hl-49-44><a class=lnlinks href=#hl-49-44>44</a>
</span><span class=lnt id=hl-49-45><a class=lnlinks href=#hl-49-45>45</a>
</span><span class=lnt id=hl-49-46><a class=lnlinks href=#hl-49-46>46</a>
</span><span class=lnt id=hl-49-47><a class=lnlinks href=#hl-49-47>47</a>
</span><span class=lnt id=hl-49-48><a class=lnlinks href=#hl-49-48>48</a>
</span><span class=lnt id=hl-49-49><a class=lnlinks href=#hl-49-49>49</a>
</span><span class=lnt id=hl-49-50><a class=lnlinks href=#hl-49-50>50</a>
</span><span class=lnt id=hl-49-51><a class=lnlinks href=#hl-49-51>51</a>
</span><span class=lnt id=hl-49-52><a class=lnlinks href=#hl-49-52>52</a>
</span><span class=lnt id=hl-49-53><a class=lnlinks href=#hl-49-53>53</a>
</span><span class=lnt id=hl-49-54><a class=lnlinks href=#hl-49-54>54</a>
</span><span class=lnt id=hl-49-55><a class=lnlinks href=#hl-49-55>55</a>
</span><span class=lnt id=hl-49-56><a class=lnlinks href=#hl-49-56>56</a>
</span><span class=lnt id=hl-49-57><a class=lnlinks href=#hl-49-57>57</a>
</span><span class=lnt id=hl-49-58><a class=lnlinks href=#hl-49-58>58</a>
</span><span class=lnt id=hl-49-59><a class=lnlinks href=#hl-49-59>59</a>
</span><span class=lnt id=hl-49-60><a class=lnlinks href=#hl-49-60>60</a>
</span><span class=lnt id=hl-49-61><a class=lnlinks href=#hl-49-61>61</a>
</span><span class=lnt id=hl-49-62><a class=lnlinks href=#hl-49-62>62</a>
</span><span class=lnt id=hl-49-63><a class=lnlinks href=#hl-49-63>63</a>
</span><span class=lnt id=hl-49-64><a class=lnlinks href=#hl-49-64>64</a>
</span><span class=lnt id=hl-49-65><a class=lnlinks href=#hl-49-65>65</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># worker_app.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaConsumer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>shared</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=p>,</span> <span class=n>distributed_lock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>KAFKA_BOOTSTRAP</span><span class=p>,</span> <span class=n>KAFKA_TOPIC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>THRESHOLD</span><span class=p>,</span> <span class=n>KEY_COUNTER</span><span class=p>,</span> <span class=n>KEY_VERSION</span><span class=p>,</span> <span class=n>KEY_LOCK</span><span class=p>,</span> <span class=n>KEY_DONE_FMT</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>new_consumer</span><span class=p>(</span><span class=n>group_id</span><span class=o>=</span><span class=s2>&#34;cond-workers&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 같은 group_id를 쓰는 워커들은 파티션을 분할해 소비 (스케일아웃)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>KafkaConsumer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>KAFKA_TOPIC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap_servers</span><span class=o>=</span><span class=n>KAFKA_BOOTSTRAP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>group_id</span><span class=o>=</span><span class=n>group_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>enable_auto_commit</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>auto_offset_reset</span><span class=o>=</span><span class=s2>&#34;earliest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>value_deserializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>b</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>b</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=n>consumer_timeout_ms</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># 블로킹</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_and_execute</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    - Kafka 이벤트만 믿지 말고 항상 Redis에서 &#39;현재 상태&#39;를 다시 확인
</span></span></span><span class=line><span class=cl><span class=s2>    - counter &gt;= THRESHOLD 이고, 해당 version이 아직 처리되지 않았다면
</span></span></span><span class=line><span class=cl><span class=s2>      분산 락으로 단일 실행을 보장하고 작업 수행
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>pipe</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>counter</span><span class=p>,</span> <span class=n>version</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>KEY_COUNTER</span><span class=p>)</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>KEY_VERSION</span><span class=p>)</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>counter</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>counter</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>version</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>counter</span> <span class=o>&lt;</span> <span class=n>THRESHOLD</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 멱등 체크: 같은 version 중복 실행 방지</span>
</span></span><span class=line><span class=cl>    <span class=n>done_key</span> <span class=o>=</span> <span class=n>KEY_DONE_FMT</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>done_key</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이미 처리됨</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 분산 락 획득 (다른 노드와 동시 실행 방지)</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>shared</span> <span class=kn>import</span> <span class=n>LOCK_TTL_MS</span>  <span class=c1># 순환 import 피하려고 내부에서 import</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>distributed_lock</span><span class=p>(</span><span class=n>KEY_LOCK</span><span class=p>,</span> <span class=n>LOCK_TTL_MS</span><span class=p>)</span> <span class=k>as</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=c1># ==== 실제 업무 로직 ====</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[WORKER] EXECUTE: version=</span><span class=si>{</span><span class=n>version</span><span class=si>}</span><span class=s2>, counter=</span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>  <span class=c1># 작업 시뮬</span>
</span></span><span class=line><span class=cl>        <span class=c1># ======================</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span> <span class=o>=</span> <span class=n>new_consumer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[WORKER] started. waiting kafka events...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>consumer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=n>value</span>  <span class=c1># {&#34;version&#34;:N,&#34;counter&#34;:C,&#34;met&#34;:true}</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[WORKER] event: </span><span class=si>{</span><span class=n>payload</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트를 받았더라도 항상 재검사</span>
</span></span><span class=line><span class=cl>        <span class=n>check_and_execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>Kafka</strong>에서 이벤트를 구독하여 <strong>트리거</strong>로 사용.</li><li>이벤트 수신 뒤 <strong>반드시 Redis 상태 재검사</strong> → 네트워크 지연, 중복 이벤트, 순서 뒤바뀜에 안전.</li><li>**멱등 키 (<code>cond:done:v{version}</code>)**로 <strong>한 번만 처리</strong> 보장.</li><li><strong>분산 락</strong>으로 다중 노드 동시 실행 방지.</li></ul></li><li><p>(선택) 로컬 실행용 Docker Compose 스니펫</p><ul><li>운영 환경에서는 보안/스토리지/모니터링 설정을 추가한다.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a class=lnlinks href=#hl-50-1> 1</a>
</span><span class=lnt id=hl-50-2><a class=lnlinks href=#hl-50-2> 2</a>
</span><span class=lnt id=hl-50-3><a class=lnlinks href=#hl-50-3> 3</a>
</span><span class=lnt id=hl-50-4><a class=lnlinks href=#hl-50-4> 4</a>
</span><span class=lnt id=hl-50-5><a class=lnlinks href=#hl-50-5> 5</a>
</span><span class=lnt id=hl-50-6><a class=lnlinks href=#hl-50-6> 6</a>
</span><span class=lnt id=hl-50-7><a class=lnlinks href=#hl-50-7> 7</a>
</span><span class=lnt id=hl-50-8><a class=lnlinks href=#hl-50-8> 8</a>
</span><span class=lnt id=hl-50-9><a class=lnlinks href=#hl-50-9> 9</a>
</span><span class=lnt id=hl-50-10><a class=lnlinks href=#hl-50-10>10</a>
</span><span class=lnt id=hl-50-11><a class=lnlinks href=#hl-50-11>11</a>
</span><span class=lnt id=hl-50-12><a class=lnlinks href=#hl-50-12>12</a>
</span><span class=lnt id=hl-50-13><a class=lnlinks href=#hl-50-13>13</a>
</span><span class=lnt id=hl-50-14><a class=lnlinks href=#hl-50-14>14</a>
</span><span class=lnt id=hl-50-15><a class=lnlinks href=#hl-50-15>15</a>
</span><span class=lnt id=hl-50-16><a class=lnlinks href=#hl-50-16>16</a>
</span><span class=lnt id=hl-50-17><a class=lnlinks href=#hl-50-17>17</a>
</span><span class=lnt id=hl-50-18><a class=lnlinks href=#hl-50-18>18</a>
</span><span class=lnt id=hl-50-19><a class=lnlinks href=#hl-50-19>19</a>
</span><span class=lnt id=hl-50-20><a class=lnlinks href=#hl-50-20>20</a>
</span><span class=lnt id=hl-50-21><a class=lnlinks href=#hl-50-21>21</a>
</span><span class=lnt id=hl-50-22><a class=lnlinks href=#hl-50-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># docker-compose.yml (예시)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;6379:6379&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zookeeper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>bitnami/zookeeper:3.9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ALLOW_ANONYMOUS_LOGIN</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;yes&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;2181:2181&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kafka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>bitnami/kafka:3.7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KAFKA_CFG_ZOOKEEPER_CONNECT</span><span class=p>:</span><span class=w> </span><span class=l>zookeeper:2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KAFKA_CFG_LISTENERS</span><span class=p>:</span><span class=w> </span><span class=l>PLAINTEXT://:9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KAFKA_CFG_ADVERTISED_LISTENERS</span><span class=p>:</span><span class=w> </span><span class=l>PLAINTEXT://localhost:9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ALLOW_PLAINTEXT_LISTENER</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;yes&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>zookeeper]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;9092:9092&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>토픽 생성 (로컬):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a class=lnlinks href=#hl-51-1>1</a>
</span><span class=lnt id=hl-51-2><a class=lnlinks href=#hl-51-2>2</a>
</span><span class=lnt id=hl-51-3><a class=lnlinks href=#hl-51-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it &lt;kafka_container_id&gt; kafka-topics.sh --create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --topic condition.events --partitions <span class=m>3</span> --replication-factor <span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --bootstrap-server localhost:9092
</span></span></code></pre></td></tr></table></div></div></li><li><p>운영 팁 (핵심만)</p><ul><li><strong>내구성 이벤트가 중요</strong>하면 Redis Pub/Sub 대신 <strong>Kafka/Redis Streams/NATS JetStream</strong> 같은 <strong>로그 기반</strong>을 써야 함.</li><li>이벤트는 <strong>최소 한 번 (at-least-once)</strong> 전제를 두고, <strong>항상 상태 재검사</strong> + <strong>멱등/락</strong>으로 안전성 확보.</li><li>Redis 는 <strong>Replica/Cluster</strong>, Kafka 는 <strong>멀티 브로커/ISR</strong> 구성으로 HA 확보.</li><li><strong>메트릭</strong>: 처리 건수, 중복률, 실행 지연, 락 대기/실패율, 재시도율 등을 수집해 튜닝.</li></ul></li></ol><hr><h2 id=정리-및-학습-가이드>정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#정리-및-학습-가이드>#</a></h2><h3 id=내용-정리>내용 정리<a hidden class=anchor aria-hidden=true href=#내용-정리>#</a></h3><p>조건 변수 (Condition Variable) 는 현대 동시성 프로그래밍에서 <strong>상태 기반 동기화의 표준 메커니즘</strong>으로, 스레드가 특정 조건이 충족될 때까지 효율적으로 대기하고, 조건이 만족되면 신호를 받아 실행을 재개하도록 한다.</p><p><strong>핵심 사용 원칙</strong>은 다음과 같다:</p><ul><li><strong>뮤텍스와 원자적 결합</strong>: 조건 변수 사용 시 반드시 보호 대상 자원에 대한 락을 확보</li><li><strong>while 루프 재검사</strong>: Spurious Wakeup 방지를 위해 신호 수신 후 조건을 다시 검사</li><li><strong>정확한 신호 시점</strong>: Lost Wakeup 방지를 위해 조건 충족 직후 신호</li><li><strong>적절한 신호 방식 선택</strong>: notify_one vs notify_all 구분</li><li><strong>타임아웃/취소</strong>: 무한 대기 방지를 위해 제한 시간 또는 취소 조건 설정</li></ul><p><strong>주요 장점</strong>은 CPU 효율성, 동기화 표현력, 확장성, 안정성이다. 이는 생산자 - 소비자 패턴, 스레드 풀, 자원 풀 등 다양한 실무 시나리오에서 활용된다.</p><p><strong>성능 최적화</strong>를 위해 대규모 환경에서는 샤딩, 배치 신호, 수량형 모델 등을 적용하며, <strong>운영 단계에서는 관측성 확보</strong>(대기 시간, 경합 지표 수집) 를 통해 안정성을 유지한다.</p><p><strong>미래 발전 방향</strong>으로는 Lock-free 기법과 async/await 구조화 동시성, AI 기반 동기화 최적화, 크로스 플랫폼 및 분산 환경 최적화 등이 있다. 대안 동기화 기법 (세마포어, 채널 등) 과 비교하여 사용 맥락을 명확히 하는 것도 중요하다.</p><table><thead><tr><th>구분</th><th>내용</th></tr></thead><tbody><tr><td><strong>정의</strong></td><td>상태 기반 동기화 메커니즘, 특정 조건 충족 시 스레드를 깨워 실행 재개</td></tr><tr><td><strong>핵심 사용 원칙</strong></td><td>뮤텍스와 원자적 결합, while 루프 재검사, 정확한 신호 시점, notify_one/notify_all 구분, 타임아웃·취소 적용</td></tr><tr><td><strong>주요 장점</strong></td><td>CPU 효율성, 동기화 표현력, 확장성, 안정성</td></tr><tr><td><strong>대표 적용 사례</strong></td><td>생산자 - 소비자, 스레드 풀, 리소스 풀, 이벤트 핸들러</td></tr><tr><td><strong>성능 최적화 전략</strong></td><td>샤딩, 배치 신호, 수량형 모델, 조건별 CV 분리</td></tr><tr><td><strong>운영 고려사항</strong></td><td>관측성 (대기 시간·신호 빈도·경합 지표), 성능·안정성 모니터링</td></tr><tr><td><strong>미래 트렌드</strong></td><td>Lock-free, async/await, 구조화 동시성, AI 기반 최적화, 분산·크로스 플랫폼 최적화</td></tr><tr><td><strong>대안 비교 기준</strong></td><td>세마포어·채널·이벤트 오브젝트와의 특성 차이 및 선택 기준</td></tr></tbody></table><p>조건 변수는 <strong>효율적이고 안정적인 상태 기반 동기화</strong>를 구현하는 표준 도구다.<br>핵심은 <strong>뮤텍스 결합·조건 재검사·정확한 신호 시점</strong>이고, 성능 최적화와 관측성을 함께 설계해야 한다.<br>미래에는 <strong>Lock-free, async/await, AI 최적화</strong>와의 융합이 확대될 것이며, 상황에 맞춰 다른 동기화 기법과 비교·선택하는 안목이 중요하다.</p><h3 id=학습-로드맵>학습 로드맵<a hidden class=anchor aria-hidden=true href=#학습-로드맵>#</a></h3><table><thead><tr><th>단계</th><th>카테고리</th><th>학습 항목</th><th>목표</th></tr></thead><tbody><tr><td>1</td><td>기초/이론</td><td>Mesa 의미론, Spurious Wakeup, while 재검사, Mutex·조건 변수 결합 구조</td><td>조건 변수의 핵심 개념과 시맨틱스 이해</td></tr><tr><td>2</td><td>구현 실습</td><td>Producer-Consumer, 다중 조건 변수, 타임아웃·취소 처리</td><td>조건 변수 활용 패턴 구현 능력 확보</td></tr><tr><td>3</td><td>운영/관측</td><td>메트릭 수집, 경합률 분석, 스트레스 테스트</td><td>성능 및 안정성 모니터링·디버깅 능력</td></tr><tr><td>4</td><td>고급/확장</td><td>샤딩, 배치 신호, Lock-free·CAS 대체, 구조적 동시성, 분산·GPU·RTOS 확장</td><td>실무·고성능·특수 환경 적용 역량</td></tr></tbody></table><ul><li><strong>1 단계 (기초/이론)</strong>: 조건 변수의 작동 원리와 스레드 동기화 시맨틱스를 깊이 있게 이해하는 단계.</li><li><strong>2 단계 (구현 실습)</strong>: 대표 패턴 구현을 통해 코드 레벨에서 조건 변수를 다루는 능력 강화.</li><li><strong>3 단계 (운영/관측)</strong>: 성능·안정성 관점에서 조건 변수 동작을 측정·분석하고 문제를 재현·해결하는 단계.</li><li><strong>4 단계 (고급/확장)</strong>: 확장된 환경·패턴·최적화 전략까지 아우르는 실무 최상위 역량 습득.</li></ul><h3 id=학습-항목-매트릭스>학습 항목 매트릭스<a hidden class=anchor aria-hidden=true href=#학습-항목-매트릭스>#</a></h3><table><thead><tr><th>카테고리</th><th>Phase</th><th>항목</th><th>중요도</th><th>설명</th></tr></thead><tbody><tr><td>기초</td><td>1</td><td>개념 정의/필요성</td><td>필수</td><td>조건 변수의 역할과 필요성 이해</td></tr><tr><td>기초</td><td>1</td><td>Mesa vs Hoare 시맨틱스</td><td>필수</td><td>while 재검사의 이유와 안전성</td></tr><tr><td>기초</td><td>1</td><td>Spurious Wakeup</td><td>필수</td><td>가짜 깨어남 현상과 방지 방법</td></tr><tr><td>이론</td><td>2</td><td>모니터 패턴 구조</td><td>필수</td><td>상태 + 뮤텍스 + 조건 변수 통합 구조</td></tr><tr><td>이론</td><td>2</td><td>signal vs broadcast</td><td>필수</td><td>사용 차이와 선택 기준</td></tr><tr><td>이론</td><td>2</td><td>Happens-Before/메모리 모델</td><td>권장</td><td>일관성과 원자성 보장 메커니즘</td></tr><tr><td>구현</td><td>4~5</td><td>Producer-Consumer</td><td>필수</td><td>대표적인 조건 변수 활용 패턴</td></tr><tr><td>구현</td><td>4~5</td><td>Bounded Buffer 예제</td><td>권장</td><td>생산자 - 소비자 심화 예제</td></tr><tr><td>구현</td><td>4~5</td><td>실무 적용 사례</td><td>권장</td><td>연결 풀, 웹 서버 등</td></tr><tr><td>운영</td><td>6</td><td>대기시간/경합 메트릭</td><td>필수</td><td>SLO/p99 안정화 핵심</td></tr><tr><td>운영</td><td>6</td><td>Broadcast 억제/샤딩/배치</td><td>권장</td><td>성능 최적화 전략</td></tr><tr><td>운영</td><td>6</td><td>장애 대응 전략</td><td>권장</td><td>데드락 탐지, 타임아웃 설계</td></tr><tr><td>고급</td><td>7</td><td>Lock-free 통합</td><td>선택</td><td>고성능 환경 통합 전략</td></tr><tr><td>고급</td><td>7</td><td>분산 조건 변수</td><td>선택</td><td>분산 환경 동기화 설계</td></tr><tr><td>고급</td><td>7</td><td>AI/ML 기반 최적화</td><td>선택</td><td>동적 성능 조정 및 미래 트렌드</td></tr></tbody></table><p>조건 변수 학습은 <strong>기초 개념 이해 → 동작 원리 심화 → 구현 경험 → 운영 최적화 → 고급 기술 확장</strong>의 5 단계 로드맵이 효과적이다.<br>초반에는 Mesa 시맨틱스, Spurious Wakeup, 모니터 패턴 등 안전성 기반 원칙을 이해하고,<br>중반에는 생산자 - 소비자, Bounded Buffer 등 실무 예제로 구현 능력을 키우며,<br>후반에는 메트릭 기반 운영, Broadcast 최적화, 장애 대응을 학습해야 한다.<br>마지막으로 Lock-free, 분산, AI 최적화 같은 최신 트렌드로 확장하면 완성도 높은 역량을 갖출 수 있다.</p><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>정의</th><th>관련 개념</th></tr></thead><tbody><tr><td>핵심 개념</td><td>조건 변수 (Condition Variable)</td><td>조건 충족 시까지 스레드를 대기·재개하는 동기화 객체</td><td>Mutex, Predicate</td></tr><tr><td>핵심 개념</td><td>Mesa 의미론</td><td>signal 후 즉시 제어권 이동 보장 안 함 → 조건 재검사 필요</td><td>Hoare 의미론</td></tr><tr><td>핵심 개념</td><td>Hoare 의미론</td><td>signal 후 즉시 제어권을 이전하여 조건 보장</td><td>Mesa 의미론</td></tr><tr><td>핵심 개념</td><td>Predicate</td><td>wait 해제 여부를 판단하는 조건식/함수</td><td>상태 변수</td></tr><tr><td>구현 요소</td><td>Mutex</td><td>상호 배제를 위한 락, 조건 변수와 함께 상태 보호</td><td>Spinlock</td></tr><tr><td>구현 요소</td><td>wait()</td><td>조건 충족 시까지 뮤텍스 해제 후 대기, 재획득 후 조건 재검사</td><td>sleep, block</td></tr><tr><td>구현 요소</td><td>signal/notify_one</td><td>대기 스레드 하나를 깨움</td><td>broadcast</td></tr><tr><td>구현 요소</td><td>broadcast/notify_all</td><td>모든 대기 스레드를 깨움</td><td>signal</td></tr><tr><td>구현 요소</td><td>Wait Queue</td><td>대기 스레드 관리 큐</td><td>FIFO, 우선순위 큐</td></tr><tr><td>운영·문제</td><td>Spurious Wakeup</td><td>조건 충족 없이 깨어남 → while 재검사 필수</td><td>Mesa 의미론</td></tr><tr><td>운영·문제</td><td>Lost Wakeup</td><td>신호가 대기 진입 전에 발생해 손실</td><td>상태→신호 순서</td></tr><tr><td>운영·문제</td><td>Deadlock</td><td>락 순환 대기로 인한 무한 대기</td><td>락 순서</td></tr><tr><td>운영·문제</td><td>Priority Inversion</td><td>낮은 우선순위가 높은 우선순위 스레드를 지연</td><td>PI 락</td></tr><tr><td>운영·문제</td><td>Thundering Herd</td><td>broadcast 로 인해 불필요한 다수 스레드가 깨어남</td><td>성능 저하</td></tr><tr><td>최적화·고급</td><td>Adaptive Spinning</td><td>짧은 대기 시 스핀락 활용</td><td>Hybrid 접근</td></tr><tr><td>최적화·고급</td><td>구조적 동시성</td><td>작업 취소·타임아웃 스코프화 동기화</td><td>TaskGroup</td></tr><tr><td>최적화·고급</td><td>Lock-free 대체</td><td>락 없는 동기화 기법</td><td>CAS, Atomic</td></tr></tbody></table><hr><h2 id=참고-및-출처><strong>참고 및 출처</strong><a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><h3 id=공식-문서-및-표준><strong>공식 문서 및 표준</strong><a hidden class=anchor aria-hidden=true href=#공식-문서-및-표준>#</a></h3><ul><li><a href=https://pubs.opengroup.org/onlinepubs/9699919799/functions/pthread_cond_wait.html>POSIX.1-2017 pthread_cond_wait</a></li><li><a href=https://en.cppreference.com/w/cpp/thread/condition_variable>C++ std::condition_variable - cppreference</a></li><li><a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Condition.html>Java Condition Interface</a></li><li><a href=https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait-->Java Object.wait()/notify()</a></li><li><a href=https://docs.python.org/3/library/threading.html#condition-objects>Python threading.Condition 공식 문서</a></li><li><a href=https://pkg.go.dev/sync#Cond>Go sync.Cond 공식 문서</a></li><li><a href=https://doc.rust-lang.org/std/sync/struct.Condvar.html>Rust std::sync::Condvar 공식 문서</a></li><li><a href=https://learn.microsoft.com/en-us/windows/win32/sync/condition-variables>Microsoft Windows Condition Variables</a></li><li><a href="https://www.ibm.com/docs/en/aix/7.2?topic=programming-using-condition-variables">IBM Using condition variables</a></li></ul><h3 id=학술-논문-및-역사적-자료><strong>학술 논문 및 역사적 자료</strong><a hidden class=anchor aria-hidden=true href=#학술-논문-및-역사적-자료>#</a></h3><ul><li><a href=https://dl.acm.org/doi/10.1145/355620.361161>Hoare, &ldquo;Monitors: An Operating System Structuring Concept&rdquo; (1974)</a></li><li><a href=https://dl.acm.org/doi/10.1145/358818.358824>Lampson & Redell, &ldquo;Experience with Processes and Monitors in Mesa&rdquo; (1980)</a></li><li><a href=https://www.cs.utexas.edu/~EWD/ewd01xx/EWD123.PDF>Dijkstra, &ldquo;Cooperating Sequential Processes&rdquo; (1968)</a></li><li><a href=https://dl.acm.org/doi/10.5555/579645>Hansen, &ldquo;Operating System Principles&rdquo; (1973)</a></li></ul><h3 id=교육-자료-및-강의><strong>교육 자료 및 강의</strong><a hidden class=anchor aria-hidden=true href=#교육-자료-및-강의>#</a></h3><ul><li><a href=https://pages.cs.wisc.edu/~remzi/OSTEP/threads-cv.pdf>Operating Systems: Three Easy Pieces - Condition Variables</a></li><li><a href=https://web.stanford.edu/class/archive/cs/cs111/cs111.1232/lectures/15/Lecture15.pdf>Stanford CS111 - Condition Variables</a></li><li><a href=https://www.cs.cornell.edu/courses/cs3110/2012fa/recitations/rec16.html>Cornell University - Condition Variables</a></li><li><a href=https://www.sysnet.ucsd.edu/~voelker/class/cse120/condvars.html>CSE 120: Condition Variables (UCSD)</a></li></ul><h3 id=기술-블로그-및-실무-사례><strong>기술 블로그 및 실무 사례</strong><a hidden class=anchor aria-hidden=true href=#기술-블로그-및-실무-사례>#</a></h3><ul><li><a href=https://www.geeksforgeeks.org/cpp-multithreading-condition-variables/>GeeksforGeeks - Condition Variables in C++</a></li><li><a href=https://medium.com/@jtchen2k/using-c-conditional-variables-for-thread-synchronization-87fb1ac3601c>Understanding Conditional Variables in C++ - Medium</a></li><li><a href=https://www.modernescpp.com/index.php/condition-variables/>Modernes C++ Blog - Condition Variables</a></li><li><a href=https://medium.com/@polyglot_factotum/rust-concurrency-patterns-condvars-and-locks-e278f18db74f>Rust concurrency patterns: condvars and locks</a></li></ul><h3 id=오픈소스-구현체><strong>오픈소스 구현체</strong><a hidden class=anchor aria-hidden=true href=#오픈소스-구현체>#</a></h3><ul><li><a href=https://github.com/torvalds/linux/blob/master/kernel/futex.c>Linux Kernel futex implementation</a></li><li><a href=https://github.com/boostorg/thread>Boost.Thread condition_variable</a></li><li><a href=https://github.com/golang/go/blob/master/src/sync/cond.go>Go sync.Cond 소스코드</a></li><li><a href=https://github.com/rust-lang/rust/blob/master/library/std/src/sync/condvar.rs>Rust std::sync::Condvar 소스코드</a></li></ul><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://buenhyden.github.io/tags/computer-science-fundamentals/>Computer-Science-Fundamentals</a></li><li><a href=https://buenhyden.github.io/tags/concurrency-and-parallelism/>Concurrency-and-Parallelism</a></li><li><a href=https://buenhyden.github.io/tags/condition-synchronization/>Condition-Synchronization</a></li><li><a href=https://buenhyden.github.io/tags/implementation-mechanisms/>Implementation-Mechanisms</a></li><li><a href=https://buenhyden.github.io/tags/condition-variable/>Condition-Variable</a></li><li><a href=https://buenhyden.github.io/tags/spurious-wakeup/>Spurious-Wakeup</a></li><li><a href=https://buenhyden.github.io/tags/thread-synchronization/>Thread-Synchronization</a></li><li><a href=https://buenhyden.github.io/tags/producer-consumer/>Producer-Consumer</a></li></ul><nav class=paginav><a class=prev href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/synchronization-primitives/software-level/mutex/><span class=title>« Prev</span><br><span>Mutex</span>
</a><a class=next href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-and-parallelism/synchronization-primitives/hardware-level/atomic-operation/><span class=title>Next »</span><br><span>원자적 연산 (Atomic Operation)</span></a></nav></footer><div class=comments><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const n={src:"https://giscus.app/client.js","data-repo":"buenhyden/buenhyden.github.io","data-repo-id":"R_kgDONsSnFQ","data-category":"General","data-category-id":"DIC_kwDONsSnFc4CmK-R","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"en","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(n).forEach(([t,n])=>e.setAttribute(t,n)),console.log(e),document.querySelector(".comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme)})</script></div></article></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>