<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pessimistic vs. Optimistic Locking | hyunyoun's Blog</title><meta name=keywords content="Computer-Science-Fundamentals,Concurrency-and-Parallelism,Lock,Pessimistic-vs-Optimistic-Locking,Pessimistic-Locking,Optimistic-Locking,Concurrency-Control,Transaction-Management,Data-Consistency"><meta name=description content="Pessimistic과 Optimistic Locking은 데이터 무결성 보장을 위한 두 가지 대표 동시성 제어 전략이다. 전자는 충돌을 사전에 차단하고, 후자는 충돌 발생 시 검증한다. 충돌 빈도, 시스템 환경, 성능 요구에 따라 적절히 선택해야 한다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/pessimistic-vs-optimistic-locking/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.a9863521b3bd3c240bc506f46b95e3c06ccef2ae37f529d5f99bdaef442bccce.css integrity="sha256-qYY1IbO9PCQLxQb0a5XjwGzO8q439SnV+Zva70QrzM4=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/pessimistic-vs-optimistic-locking/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/pessimistic-vs-optimistic-locking/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Pessimistic vs. Optimistic Locking"><meta property="og:description" content="Pessimistic과 Optimistic Locking은 데이터 무결성 보장을 위한 두 가지 대표 동시성 제어 전략이다. 전자는 충돌을 사전에 차단하고, 후자는 충돌 발생 시 검증한다. 충돌 빈도, 시스템 환경, 성능 요구에 따라 적절히 선택해야 한다."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-04T03:58:00+00:00"><meta property="article:modified_time" content="2025-08-04T03:58:00+00:00"><meta property="article:tag" content="Computer-Science-Fundamentals"><meta property="article:tag" content="Concurrency-and-Parallelism"><meta property="article:tag" content="Lock"><meta property="article:tag" content="Pessimistic-vs-Optimistic-Locking"><meta property="article:tag" content="Pessimistic-Locking"><meta property="article:tag" content="Optimistic-Locking"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Pessimistic vs. Optimistic Locking"><meta name=twitter:description content="Pessimistic과 Optimistic Locking은 데이터 무결성 보장을 위한 두 가지 대표 동시성 제어 전략이다. 전자는 충돌을 사전에 차단하고, 후자는 충돌 발생 시 검증한다. 충돌 빈도, 시스템 환경, 성능 요구에 따라 적절히 선택해야 한다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HY's Blog","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Computer Science Fundamentals","item":"https://buenhyden.github.io/posts/computer-science-fundamentals/"},{"@type":"ListItem","position":5,"name":"Lock","item":"https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/"},{"@type":"ListItem","position":6,"name":"Pessimistic vs. Optimistic Locking","item":"https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/pessimistic-vs-optimistic-locking/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pessimistic vs. Optimistic Locking","name":"Pessimistic vs. Optimistic Locking","description":"Pessimistic과 Optimistic Locking은 데이터 무결성 보장을 위한 두 가지 대표 동시성 제어 전략이다. 전자는 충돌을 사전에 차단하고, 후자는 충돌 발생 시 검증한다. 충돌 빈도, 시스템 환경, 성능 요구에 따라 적절히 선택해야 한다.","keywords":["Computer-Science-Fundamentals","Concurrency-and-Parallelism","Lock","Pessimistic-vs-Optimistic-Locking","Pessimistic-Locking","Optimistic-Locking","Concurrency-Control","Transaction-Management","Data-Consistency"],"articleBody":"Pessimistic vs. Optimistic Locking Pessimistic Locking은 충돌을 우려해 먼저 락을 거는 방식으로, 데이터 무결성이 중요한 환경에서 적합하다. Optimistic Locking은 충돌 가능성이 낮다고 보고 사후 검증을 통해 일관성을 보장한다. 시스템 요구사항과 성능 특성에 따라 선택된다.\n등장 배경 및 발전 과정 Pessimistic Locking은 초기 RDBMS + ACID 보장 요구에서 발전했으며, 충돌 회피를 위한 보수적 접근 방식이 정립되었으며, Optimistic Locking은 낮은 충돌 환경을 가정한 성능 중심 전략으로, 분산 시스템, 웹/모바일 기반 환경에서 발전해왔다.\nPessimistic Locking 등장 배경:\n1970 년대 초반, IBM System R 등의 RDBMS 에서 ACID 보장과 동시성 제어를 위해 등장.\n특히 Lost Update, Dirty Read 같은 문제 해결이 핵심 과제였음.\n발전 과정:\n1976 년 Jim Gray의 트랜잭션 및 2PL 이론 등장 1980 년대 주요 상용 DB (Oracle, DB2 등) 에 비관적 락 기본 내장 ERP, 금융, 제조 등 고정합성 업무에서 지금까지도 널리 사용됨 분산 환경에서는 분산 락 (ZooKeeper, etcd) 기반으로 확장됨 Optimistic Locking 등장 배경:\n1979 년 H.T. Kung과 John T. Robinson의 논문에서 낮은 충돌 환경 가정 하에 효율적인 동시성 제어로 제안.\n트랜잭션 간 충돌이 드물고 읽기 위주의 처리량 증가가 필요한 환경을 타깃으로 하였다.\n발전 과정:\n1990 년대 이후 웹 애플리케이션, 분산 시스템 확산과 함께 주목 @Version 기반 낙관적 락이 JPA, Hibernate 등에서 표준화 NoSQL DB (MongoDB, DynamoDB 등) 에서 충돌 검증 알고리즘으로 응용 최근에는 CQRS, 이벤트 소싱, API 기반 마이크로서비스에 핵심 요소로 사용됨 목적 및 필요성 공통적인 목적 및 필요성 데이터 정합성 유지: 여러 사용자가 동시에 공유 자원에 접근하는 상황에서 일관성과 무결성을 보장함. 충돌 관리 전략: 동시 접근 시 발생할 수 있는 충돌을 예방하거나 감지하고 복구하여 시스템 오류나 데이터 손실을 방지함. 시스템 성능 - 신뢰성 균형: 높은 처리량을 유지하면서도 신뢰성 있는 트랜잭션 처리를 도모함. 방식별 목적 및 필요성 구분 비관적 락 (Pessimistic) 낙관적 락 (Optimistic) 핵심 목적 선제적으로 자원 점유하여 충돌 자체를 방지 충돌이 적다는 가정 하에 최대 동시성과 성능 확보 필요성 충돌 빈도가 높고, 데이터 정합성 위반 시 치명적인 환경 (금융, 예약 등) 충돌 가능성이 낮고, 롤백이나 재시도가 비용적으로 용인되는 환경 (분산 처리, 분석 등) 적용 예시 은행 계좌 출금, 항공 좌석 예약, 창고 재고 처리 등 게시글 수정, 실시간 로그 저장, 통계 데이터 집계 등 핵심 개념 Pessimistic 과 Optimistic Locking 은 데이터 정합성과 성능 균형을 위한 핵심 동시성 제어 전략이다.\n전자는 충돌 회피 중심의 락 기반 방식, 후자는 충돌 검증 기반의 비 - 락 방식이며, 충돌 빈도와 시스템 특성에 따라 선택된다.\n공통 핵심 개념 항목 설명 동시성 제어 수단 데이터 일관성과 무결성 유지를 위한 트랜잭션 제어 방식 락을 통한 경쟁 제어 동시 접근 시 자원 충돌이나 정합성 문제를 예방하기 위한 전략 실무 전략 선택 기준 충돌 빈도, 데이터 정합성 요구 수준, 시스템 특성 등 고려 Pessimistic Locking 항목 내용 정의 리소스 접근 전에 락을 걸어 다른 트랜잭션의 접근을 차단 전제 충돌 발생 가능성이 높음 (ex. 다중 사용자가 동일 자원 수정) 기술 기반 2PL (Two-Phase Locking), DB 물리적 락, 트랜잭션 격리 수준 실무 적용 금융, ERP, 재고 관리 등 정합성 최우선 환경 장애 대응 Deadlock 감지 및 타임아웃 설정 필수 성능 영향 높은 락 경쟁으로 인한 병목 가능성, 락 해제까지 자원 점유 Optimistic Locking 항목 내용 정의 트랜잭션 완료 시 충돌 여부를 검사하고 필요 시 롤백 처리 전제 충돌이 드문 환경, 읽기 빈도 높고 쓰기 적은 워크로드 기술 기반 MVCC, 버전 번호, Timestamp, Checksum 기반 충돌 검증 실무 적용 웹 애플리케이션, 쇼핑몰, 게시판, API 서버 등 장애 대응 충돌 시 재시도 로직, 백오프 알고리즘 필요 성능 영향 락 없음 → 처리량 증가 가능성, 다만 충돌 시 비용 상승 전략 선택 가이드라인 요약 조건 권장 전략 충돌 가능성 높음 Pessimistic Locking 충돌 가능성 낮음 Optimistic Locking 실시간 고정합성 필요 Pessimistic 응답속도/확장성 우선 Optimistic 네트워크 지연/분산 환경 Optimistic (재시도 기반이 유리) 주요 기능 및 역할 공통 기능 및 역할 공통 기능: 동시 접근 시 자원 상태를 통제하여 경쟁 조건을 제어 공통 역할: 데이터 정합성 유지와 트랜잭션 충돌 대응을 통해 시스템 신뢰성을 확보 방식별 기능 및 역할 구분 기능 역할 Pessimistic Locking 자원 접근 전 락 선점\nRow/Table 수준의 독점 락 자원 충돌 차단 → 안정성 보장 트랜잭션 종료 후 해제\n데드락 방지 정책 적용 정해진 순서에 따라 순차 처리 유도 Optimistic Locking 버전 정보 또는 타임스탬프 활용\n커밋 시 변경 여부 확인 충돌 감지 및 롤백 기반 처리 → 처리량 최대화 실패 시 재시도 로직 또는 사용자 안내 메시지 제공 동시성 확보 및 블로킹 없는 읽기 보장 Pessimistic Locking은 충돌이 치명적인 환경에서의 사전 방어형 전략이며, 데이터 정합성 보장을 우선시함. Optimistic Locking은 충돌이 드물고 빠른 처리가 중요한 환경에서의 사후 복구형 전략으로, 성능과 확장성 확보에 적합함. 둘 모두 트랜잭션 제어 및 일관성 유지에 필수적인 전략이며, 사용 환경에 따라 병행 적용 가능. 락 정책 선택 가이드라인 매트릭스 판단 기준 선택 기준 설명 권장 락 방식 비고 충돌 발생 가능성 자원에 대한 동시 접근 및 갱신 충돌이 빈번하게 발생하는가? Pessimistic Locking 충돌 방지 목적이 우선. 데이터 무결성 중시 시스템에 적합 충돌이 드물고 대부분이 읽기 위주인가? Optimistic Locking 성능 중시. 충돌 감지 후 재시도 처리 가능 트랜잭션 지속 시간 트랜잭션이 오래 지속되어 락 점유 시간이 긴가? Optimistic Locking 락 보유로 인한 병목 방지 짧은 시간 내에 처리되는 작업인가? Pessimistic Locking 단기간 독점이 효과적일 수 있음 데이터 정합성 중요도 재고/금융/예약처럼 절대 오류가 없어야 하는가? Pessimistic Locking 강한 정합성과 예측 가능한 처리 보장 일부 손실 또는 재시도가 허용 가능한가? Optimistic Locking 처리량과 성능에 유리 트랜잭션 충돌 처리 비용 충돌 시 복구/재처리 비용이 높은가? Pessimistic Locking 충돌 자체를 방지하는 것이 유리 충돌 시 복구가 용이하고 자동화되어 있는가? Optimistic Locking 롤백 및 재시도 비용이 적고 예측 가능할 경우 적합 동시성 수준 요구 동시 요청 처리량이 매우 중요한가 (읽기 작업이 대부분)? Optimistic Locking 락이 없거나 최소한으로 작용하므로 성능 극대화 가능 트랜잭션 수보다 정합성과 순서가 중요한가? Pessimistic Locking 충돌 방지가 핵심일 경우 적합 네트워크 환경 네트워크 지연이 큰 분산 환경인가? Optimistic Locking 락 회수를 위한 round-trip 이 없음 단일 DB 또는 로컬 환경인가? Pessimistic Locking 빠른 락 획득/해제가 가능한 환경에 적합 판단 흐름 flowchart TD A[충돌 가능성 높음?] --\u003e|Yes| B[Pessimistic Locking] A --\u003e|No| C[낙관적 접근 가능성 검토] C --\u003e D[트랜잭션 길고 성능 중요?] D --\u003e|Yes| E[Optimistic Locking] D --\u003e|No| F[복구 비용 고려] F --\u003e|복구 비용 큼| B F --\u003e|복구 용이| E 적용 예시 적용 시스템 선택 전략 사유 은행 송금 시스템 Pessimistic Locking 충돌 발생 시 데이터 손실 불가, 동시성보다 정합성 우선 쇼핑몰 재고관리 Pessimistic Locking 수량 초과 주문 방지 필요, 재고 감소 시 강한 일관성 필요 게시판 댓글 작성 Optimistic Locking 충돌 발생 가능성 낮음, 대부분 읽기 위주 작업 협업 문서 편집기 Optimistic Locking 실시간 편집, 성능/확장성 우선, 버전 충돌 시 사용자 재시도 처리 특징 공통 특징 동시성 환경에서의 정합성 보장 메커니즘 트랜잭션 기반 처리와 밀접한 관련 충돌 발생 가능성에 대한 대응 전략 존재 Pessimistic vs. Optimistic Locking 특징 카테고리 Pessimistic Locking Optimistic Locking 접근 방식 충돌을 사전에 방지 (보수적 접근) 충돌을 사후에 감지 (낙관적 접근) 락 사용 락 지속 점유 (트랜잭션 중 락 소유) 락 없음, 대신 버전 번호 또는 타임스탬프 사용 충돌 처리 방식 즉시 차단 및 대기 (락이 걸리면 대기) 커밋 시 충돌 검증 후 실패 시 롤백 + 재시도 동시성 제어 낮은 동시성, 읽기 - 쓰기 경쟁 시 병목 발생 가능 높은 동시성, 병렬 처리 효율적 성능 특성 충돌 많을수록 안정적이나 락 오버헤드 존재 충돌 적을수록 우수, 충돌 발생 시 재시도 비용 증가 장애 대응 전략 Deadlock 감지/회피 필요, 타임아웃 설정 필요 재시도 정책 및 백오프 로직 필요, 충돌 실패 처리 설계 프로그래밍 복잡도 상대적으로 단순한 구조 충돌 처리, 재시도, 버전 관리 로직 필요 적용 환경 예시 재고관리, 예약시스템, 금융거래 등 정합성 우선 환경 게시판 수정, 쇼핑몰 검색 등 비정합 허용 환경 접근 방식: 충돌 대응 시점의 차이. Pessimistic 은 사전 차단, Optimistic 은 사후 검증 중심으로 설계됨. 락 사용: 락 지속 점유 여부가 전략을 가르는 핵심. Pessimistic 은 명시적 락, Optimistic 은 논리적 버전 기반. 충돌 처리: 즉시 블로킹 vs. 충돌 발생 후 롤백 및 재시도 방식으로 처리 방식이 다름. 동시성: 락 사용 유무에 따라 블로킹 발생 여부가 달라지고, 이는 동시성 수준에 큰 영향. 성능: 환경에 따라 상반된 성능 특성. 충돌 빈도/경합 강도가 전략 선택에 핵심 기준. 장애 대응: Pessimistic 은 Deadlock 대비, Optimistic 은 재시도/백오프 등의 보완 로직 필요. 프로그래밍 난이도: Pessimistic 은 단순, Optimistic 은 로직 설계 복잡도가 있음. 적용 사례: 강한 정합성 필요시 Pessimistic, 사용자 경험/속도 우선 환경은 Optimistic 이 적합. 핵심 원칙 정합성 보장: 트랜잭션 충돌을 방지하거나 검출해 데이터 일관성을 확보 충돌 대응 전략 필요: 사전 또는 사후 충돌을 처리하는 메커니즘이 반드시 존재해야 함 시스템 성능과 정합성 사이의 균형 설계가 중요 Pessimistic Locking 원칙 핵심 원칙 설명 Lock Ordering 트랜잭션 간 락 획득 순서를 일관되게 유지해 데드락 방지 Minimal Lock Time 락 보유 시간 최소화로 병목 및 경합 완화 Granularity Tuning 테이블/행/컬럼 수준의 락 범위 최적화 필요 Lock Timeout 데드락 방지를 위한 타임아웃 설정 필수 Consistency First 병행성보다 데이터 정합성을 우선하는 설계 철학 Optimistic Locking 원칙 핵심 원칙 설명 Version Field Update 데이터 변경 시 버전 증가 또는 타임스탬프 갱신 필수 Conflict Detection 커밋 시 버전 비교로 충돌 감지 Retry Strategy 충돌 시 재시도 로직, 최대 시도 횟수 및 종료 조건 필요 Backoff Mechanism 재시도 간 간격을 늘리는 백오프 전략 (지수 백오프 등) 도입 Concurrency First 정합성보다 병행성과 처리량을 우선하는 설계 철학 핵심 원칙 비교 카테고리 Pessimistic Locking Optimistic Locking 충돌 대응 시점 충돌 사전 차단 충돌 사후 검출 락 정책 명시적 락 획득 및 해제 필요, 순서 보장 필수 락 없음, 버전 기반 충돌 감지 정합성 우선 원칙 정합성 우선 (ACID, Serializable isolation) 병행성 우선 (높은 처리량, eventual consistency 수용 가능) 자원 점유 시간 가능한 최소화 필요 (Minimal Lock Duration) 점유 없음, 대신 재시도 및 백오프 전략 필요 데드락 예방 전략 락 순서 일관성, 타임아웃 설정 데드락 없음, 대신 충돌 재시도 비용 고려 충돌 처리 방식 트랜잭션 차단 (lock blocking) 커밋 시점에 버전 비교, 실패 시 롤백 및 재시도 확장성 대응 전략 락 병목 발생 가능, 고경합 상황 취약 분산 환경에서 뛰어난 확장성 충돌 처리 시점: Pessimistic 은 사전 차단을 통해 안전성을 확보하고, Optimistic 은 사후 검출로 성능을 확보한다. 락 관리: Pessimistic 은 락을 명시적으로 소유하고 해제하며, 락 순서와 유지 시간이 중요하다. 반면 Optimistic 은 락을 사용하지 않고 버전 필드를 활용한다. 에러 대응 전략: Pessimistic 은 데드락을 피해야 하고, Optimistic 은 충돌 재시도에 대비한 정책을 마련해야 한다. 설계 철학: Pessimistic 은 데이터 정합성을 절대적으로 우선하며, Optimistic 은 시스템 병행성과 성능을 우선시한다. 확장성 및 성능: Pessimistic 은 고정밀 정합성 환경에 적합하고, Optimistic 은 사용자 수가 많은 웹 기반 시스템에 적합하다. 주요 원리 및 작동 방식 동시 접근 환경에서 데이터 정합성 및 충돌 제어를 구현 Pessimistic: 충돌 차단 Optimistic: 충돌 감지 및 복구 flowchart LR A[Pessimistic: Acquire → Operate → Release] B[Optimistic: Read → Operate → Validate → Commit/Rollback] 작동 원리 및 방식 방식 주요 원리 작동 흐름 요약 Pessimistic Locking Two-Phase Locking 기반, Blocking 방식 Lock 획득 → 작업 수행 → Commit/Unlock Optimistic Locking 버전 기반 Validation, Non-blocking 작업 → 커밋 전 검증 (버전 비교) → 성공 or 재시도 Pessimistic Locking sequenceDiagram participant T1 participant DB participant T2 T1-\u003e\u003eDB: BEGIN T1-\u003e\u003eDB: SELECT ... FOR UPDATE (Acquire Lock) DB--\u003e\u003eT1: Lock Acquired T2-\u003e\u003eDB: SELECT ... FOR UPDATE (Block) T1-\u003e\u003eDB: UPDATE T1-\u003e\u003eDB: COMMIT (Release Lock) DB--\u003e\u003eT2: Lock Granted 락 획득 단계\n1 2 3 4 5 -- Shared Lock (읽기 락) SELECT * FROM products WHERE id = 1 FOR SHARE; -- Exclusive Lock (쓰기 락) SELECT * FROM products WHERE id = 1 FOR UPDATE; 데이터 조작 단계\n1 UPDATE products SET quantity = quantity - 1 WHERE id = 1; 락 해제 단계\n1 COMMIT; -- 또는 ROLLBACK Optimistic Locking sequenceDiagram participant T1 participant DB participant T2 T1-\u003e\u003eDB: SELECT data, version → v=1 T2-\u003e\u003eDB: SELECT data, version → v=1 T1-\u003e\u003eDB: UPDATE WHERE version=1 → Success, version=2 T2-\u003e\u003eDB: UPDATE WHERE version=1 → Fail (version mismatch) T2-\u003e\u003eDB: Retry SELECT → v=2 T2-\u003e\u003eDB: UPDATE WHERE version=2 → Success 초기 읽기 단계\n1 2 SELECT id, name, quantity, version FROM products WHERE id = 1; -- 결과: id=1, name='Product A', quantity=100, version=5 조건부 업데이트 단계\n1 2 3 4 UPDATE products SET quantity = 99, version = version + 1 WHERE id = 1 AND version = 5; -- 영향받은 행 수를 확인하여 충돌 감지 충돌 처리 단계\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # Pseudocode def update_product_optimistic(product_id, new_quantity): max_retries = 3 for attempt in range(max_retries): # 1. 현재 데이터 조회 product = select_product(product_id) # 2. 비즈니스 로직 수행 if product.quantity \u003e= new_quantity: # 3. 조건부 업데이트 시도 affected_rows = update_product_with_version( product_id, new_quantity, product.version ) if affected_rows == 1: return \"Success\" # 성공 else: continue # 충돌 발생, 재시도 else: return \"Insufficient quantity\" return \"Max retries exceeded\" Pessimistic vs. Optimistic Locking: 실전 구현 전략 구분 Pessimistic Locking Optimistic Locking 트랜잭션 시작 시 동작 읽기 또는 쓰기 전에 즉시 락 획득 데이터 조회 시 별도 락 없음 충돌 처리 방식 락 보유를 통한 사전 차단 커밋 시점 버전 비교를 통한 사후 검출 트랜잭션 실패 시 처리 Deadlock 또는 타임아웃 오류 발생 가능 Version mismatch → 트랜잭션 실패 및 재시도 구현 기술/예시 DB 락 (SELECT FOR UPDATE), JPA @Lock(LockModeType.PESSIMISTIC_WRITE) JPA @Version, 수동 버전 필드 검증, CAS 방식 등 재시도 메커니즘 주로 자동 처리 불가, 비즈니스 로직에서 직접 예외 처리 필요 자동/수동 재시도 로직 구현 가능, 재시도 지수 백오프 등 적용 가능 유효한 시나리오 금융 트랜잭션, 재고 차감, 병렬 충돌 가능성 높은 시스템 게시판 수정, 장바구니 변경 등 경합이 드문 시나리오 실전 구현 전략에서는 시스템의 특성 (읽기/쓰기 비율, 충돌 가능성 등) 에 따라 적절한 락 전략과 기술이 결정된다. 비관적 락은 안정성을, 낙관적 락은 성능과 확장성을 우선시한다. 구조 및 아키텍처 공통적인 구조·역할 두 방식 모두 트랜잭션 단위의 동시성 제어 구조를 갖추며, 정합성 보장 목적을 공유. 다만 락 기반 관리 vs. 버전 기반 검증이라는 구조 차이 존재. 방식별 구조 및 비교 Pessimistic Locking 필수 요소: Lock Manager, Lock Table, Wait Queue 선택 요소: Deadlock Detector, Lock Escalation 등 작동 기반: DB 내부 Lock Manager, Two-Phase Locking Protocol 사용됨 graph TD subgraph DB Layer TM[Transaction Manager] LM[Lock Manager] LT[Lock Table] WQ[Wait Queue] DD[Deadlock Detector] end TM --\u003e LM LM --\u003e LT LM --\u003e WQ LM -. optional .-\u003e DD WQ --\u003e LM Optimistic Locking 필수 요소: Version Control (버전 필드), Conflict Detection, Retry Mechanism 선택 요소: Adaptive Retry Controller, Performance Monitor 등 작동 기반: 주로 애플리케이션 레이어에서 동작하며 DB 검증 로직 포함 graph TD subgraph App Layer TX[Transaction Start] OP[\"Operation (no lock)\"] VD[Version Validate] RL[Retry Logic] end subgraph Data Layer DC[Conflict Detection Engine] VM[Version Control Store] end TX --\u003e OP OP --\u003e VD VD --\u003e|no conflict| DC DC --\u003e|validate| VM VD --\u003e|conflict| RL RL --\u003e TX 구성 요소 락 방식 구성 요소 설명 기능 역할 필수/선택 Pessimistic Lock Manager 트랜잭션 락 요청/해제 제어, 데드락 감지 포함 락 할당·관리의 핵심 엔진 필수 Lock Table 현재 락 상태, 소유자, 리소스 정보 저장 충돌 감지 및 락 상태 추적 필수 Wait Queue 락 요청 대기 트랜잭션을 순서대로 관리 공정성 유지, 대기 상태 관리 필수 Deadlock Detector 순환 대기 감지 알고리즘 실행 시스템 정지 방지 선택 Lock Escalation Manager 다수 row→table 락 자동 전환 제어 락 오버헤드 최적화 선택 Optimistic Version Control 각 레코드의 버전 번호/타임스탬프 항목 충돌 검증 기준 제공 필수 Conflict Detection Engine 커밋 시점에 버전 비교하여 충돌 여부 결정 동시성 위반 감지 필수 Retry Mechanism 충돌 시 백오프 전략, 재시도 로직 수행 오류 복구 및 일관성 유지 필수 Performance Monitor 충돌 빈도, 재시도 패턴, 병목 상황 로깅 전략 최적화 및 동시성 분석 지원 선택 Adaptive Retry Controller 시스템 부하에 따라 재시도 정책 동적으로 조정 실시간 성능 대응 선택 구현 기법 및 방법 공통점:\n동시성 제어 목적 트랜잭션 충돌 방지/처리 고유한 충돌 감지 및 회피 메커니즘 존재 차이점:\n락 시점과 방식 (사전 vs 사후) 충돌 발생 시 대응 방식 (대기 vs 재시도) 구현 위치 (DB, App Layer 등) 분류 정의 구성 요소 원리 목적 사용 상황 특징 Database-Level Locking DB 가 제공하는 네이티브 락 (예: SELECT FOR UPDATE) DB 커넥션, 트랜잭션, 락 구문 트랜잭션 내 명시적 락 획득 강력한 일관성과 충돌 사전 방지 단일 DB 중심 트랜잭션 구현 단순, 일관성 높음, 동시성 낮음 Application-Level Locking 분산 시스템에서 Redis/ZK 등을 활용한 락 구현 분산 저장소 (Redis/ZK), TTL, 락 토큰 락 키를 원자적으로 설정/해제 분산 환경에서의 자원 충돌 방지 MSA, Redis 기반 시스템 구현 유연성 높음, 네트워크 지연 민감 Version-Based Locking 데이터 변경 시 버전 필드 비교를 통한 충돌 감지 버전 번호, 업데이트 조건, CAS 로직 읽기 → 수정 → 커밋 시점에 버전 비교 성능 최적화 및 병행성 확보 충돌 빈도 낮은 시스템 락 없음, 재시도 필요, 높은 동시성 Timestamp-Based Locking 마지막 수정 시간 기반 동시성 제어 타임스탬프 필드, 클라이언트/서버 간 시간 동기화 수정 시간 일치 여부로 충돌 여부 판단 복잡한 버전 관리 피하고 단순한 검증 클럭 동기화 가능한 환경, 이벤트 기반 시스템 설정 단순, 클럭 불일치 시 오류 발생 가능성 있음 Database-Level Locking은 가장 고전적이고 안정적인 방식으로 강한 일관성을 보장하나, 동시성은 낮음. 주로 OLTP 시스템에서 사용.\nApplication-Level Locking은 분산 환경에서 자원을 보호할 때 유용하며, Redis/Zookeeper 등 외부 도구 필요.\nVersion-Based Locking은 높은 동시성을 제공하지만 충돌 발생 시 재시도가 필요하므로, 충돌이 빈번한 환경에는 부적절.\nTimestamp-Based Locking은 구현이 단순하지만 시간 동기화 문제가 존재하며, IoT/이벤트 시스템에 적합.\nDatabase-Level Locking 1 2 3 4 5 -- PostgreSQL 예시 BEGIN; SELECT * FROM inventory WHERE product_id = 1 FOR UPDATE; UPDATE inventory SET quantity = quantity - 1 WHERE product_id = 1; COMMIT; Application-Level Locking (Python, Redis) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import redis import time class RedisLock: def __init__(self, redis_client, key, expire=5): self.redis = redis_client self.key = key self.expire = expire def acquire(self): while not self.redis.set(self.key, \"lock\", nx=True, ex=self.expire): time.sleep(0.05) def release(self): self.redis.delete(self.key) # 사용 예 lock = RedisLock(redis.StrictRedis(), \"resource:lock\") lock.acquire() try: # 작업 수행 … finally: lock.release() Version-Based Locking (Node.js + PostgreSQL) 1 2 3 4 5 6 7 8 9 10 11 12 async function updateWithVersion(db, id, newName) { const data = await db.query('SELECT name, version FROM items WHERE id = $1', [id]); const { name, version } = data.rows[0]; const updated = await db.query(` UPDATE items SET name = $1, version = $2 WHERE id = $3 AND version = $4 `, [newName, version + 1, id, version]); if (updated.rowCount === 0) { throw new Error(\"Version conflict detected\"); } } Timestamp-Based Locking (Python + SQLAlchemy) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def update_with_timestamp(session, model, item_id, new_data): for _ in range(3): entity = session.query(model).filter_by(id=item_id).first() original_ts = entity.updated_at for key, value in new_data.items(): setattr(entity, key, value) entity.updated_at = datetime.utcnow() updated = session.query(model).filter_by(id=item_id, updated_at=original_ts).update(new_data) if updated: session.commit() return else: session.rollback() time.sleep(0.05) raise Exception(\"Timestamp conflict detected\") Pessimistic vs. Optimistic Locking 비교 비관적 락은 락을 통한 선제 보호에 무게, 낙관적 락은 병행성과 성능에 무게를 둔다.\n데이터 충돌 가능성 예측과 도메인 특성을 토대로 선택·조합.\n비교 항목 비관적 락 (Pessimistic Locking) 낙관적 락 (Optimistic Locking) 데이터 락 획득 시점 작업 전락 선점 작업 완료 (커밋 직전) 충돌 검사 성능 (Throughput) 병행성 낮음, Lock 대기 시간 발생 병행성 높음, 재시도 비용 발생 충돌 대처 충돌 발생 전 차단 충돌 발생시 롤백 후 재시도 구현 복잡성 상대적으로 단순, 관리 필요 충돌 처리 및 버전 관리 필요 Deadlock(교착상태) 위험 있음 없음 활용 적합 환경 트랜잭션 충돌 빈번, 데이터 무결성이 중요한 곳 읽기 많고, 충돌 적은 곳, 대규모 분산 시스템 공통점과 차이점 공통점: 두 방식 모두 데이터 정합성과 동시성 제어를 목적으로 하며, 트랜잭션 기반 시스템에서 충돌을 방지하거나 감지하는 구조이다.\n차이점:\nPessimistic 은 선점 기반의 충돌 회피로 강한 일관성과 예측 가능한 동작을 제공하지만, 락 경합과 데드락 관리 이슈가 있다. Optimistic 은 후처리 기반 충돌 감지로 처리량과 확장성은 뛰어나지만, 충돌 복구 로직과 재시도 정책이 중요하다. 적용 가이드라인:\n충돌이 자주 발생하고 결과가 치명적인 경우에는 Pessimistic Locking. 충돌 빈도가 낮고 고성능을 요구하는 경우에는 Optimistic Locking이 적합하다. 목적 및 적용 대상 항목 공통점 차이점 적용 목적 데이터 정합성 유지, 동시성 제어 Pessimistic: 충돌 사전 차단 Optimistic: 충돌 발생 시 감지 및 처리 적용 환경 DB, ORM, Application 모두에서 구현 가능 Pessimistic: 충돌 빈도 높은 환경 Optimistic: 충돌이 드문 환경에 적합 트랜잭션 성격 ACID 보장 Pessimistic: Isolation 우선 Optimistic: Consistency/Availability 우선 두 방식 모두 데이터 무결성과 동시성 보장을 목적으로 하지만, Pessimistic 은 \" 충돌 회피 \" 에, Optimistic 은 \" 성능 최적화와 사후 회복 \" 에 초점이 맞춰져 있음.\n동작 원리 및 트랜잭션 처리 항목 공통점 차이점 동작 구조 트랜잭션 단위로 충돌 방지 또는 감지 처리 수행 Pessimistic: 작업 전 락 선점 → 수행 → 커밋\nOptimistic: 수행 → 커밋 시점에 충돌 감지 및 롤백 Isolation 수준 기본적으로 ACID 트랜잭션 모델 지원 Pessimistic: 높은 격리 수준 가능\nOptimistic: 낮은 격리 수준에서도 활용 가능 롤백 처리 충돌 발생 시 트랜잭션 롤백 처리 가능 Pessimistic: 거의 발생하지 않음\nOptimistic: 자주 발생 가능 (재시도 포함) Pessimistic 은 사전 락 확보로 충돌 가능성을 원천 차단하는 반면, Optimistic 은 커밋 단계의 충돌 감지를 통해 처리량을 높이고 유연한 트랜잭션 구성을 가능하게 한다.\n구현 복잡성 및 예외 처리 항목 공통점 차이점 예외 처리 충돌/타임아웃/무결성 위반 등 예외 상황 대비 필요 Pessimistic: 데드락, 락 타임아웃\nOptimistic: 버전 불일치 예외 및 재시도 처리 필요 구현 난이도 애플리케이션 또는 DB 설정 필요 Pessimistic: 락 관리 로직 복잡\nOptimistic: 버전 관리 및 충돌 복구 로직 필요 장애 대응 충돌 또는 병목 발생 시 복구 전략 필요 Pessimistic: 병목 발생시 처리량 급감 가능\nOptimistic: 충돌 빈도 증가 시 무한 재시도 위험 Optimistic 은 구현이 유연하지만 충돌 복구 로직이 필요하며, Pessimistic 은 안정적이나 데드락 예방 및 락 해제 정책 관리가 핵심 과제가 된다.\n성능 및 확장성 관점 항목 공통점 차이점 성능 병목 가능성 동시성 제어 실패 시 전체 처리량 저하 유발 가능 Pessimistic: 락 경쟁으로 병목 발생 Optimistic: 재시도 비용 증가 가능 확장성 적절히 구성되면 스케일 아웃 가능한 구조 Optimistic 은 비블로킹 구조로 확장성 우수 Pessimistic 은 락 서버 병목 위험 분산 환경 대응 동시성 보장 메커니즘 요구 Pessimistic: 락 관리자 필요 (ZK, etcd)Optimistic: 버전 기반 처리로 네트워크 지연 내성 우수 장점과 단점 Pessimistic Locking 은 강력한 데이터 정합성과 충돌 회피가 강점이며, 데이터 중심 트랜잭션에 적합하다. 그러나 성능 저하와 데드락 리스크, 확장성 한계가 단점이다. Optimistic Locking 은 충돌 가능성이 낮고 병렬성 높은 환경에 유리하며, 웹 API 나 분산 시스템에서 적합하다. 다만, 충돌 발생 시 높은 재시도 비용과 복잡한 오류 처리가 필요하다. 실무에서는 사용 환경, 충돌 빈도, DB/프레임워크 지원 등을 고려하여 두 접근법을 선택하거나 혼용하는 것이 효과적이다. 공통 장점 데이터 무결성을 보장하고 트랜잭션 충돌 방지 혹은 감지 능력을 제공함 환경에 따라 선택적으로 도입하여 트랜잭션 오류를 줄일 수 있음 Pessimistic Locking 장점: 충돌을 사전 방지하여 정합성 보장, 구현 단순, 예측 가능한 동작 단점: 데드락 위험, 커넥션 점유, 확장성 낮음 Optimistic Locking 장점: 락 비용 없음, HTTP 및 분산 환경에 적합, 병행성 우수 단점: 충돌 시 재시도 비용 증가, 복잡한 오류 처리, 충돌 감지 시점 지연 카테고리별 비교 데이터 정합성 항목 Pessimistic Locking Optimistic Locking 보장 수준 실시간 강력한 정합성 보장 결과적 정합성 보장 (커밋 시점까지 미확정) 오류 감지 충돌 발생 전에 차단 커밋 시점에만 감지 상태 관리 트랜잭션 상태 지속 필요 Stateless 구조 가능 성능 및 확장성 항목 Pessimistic Locking Optimistic Locking 성능 락 처리로 오버헤드 존재 락 없음으로 처리 속도 우수 (충돌 적을 시) 확장성 낮음, 락으로 인해 병목 발생 가능 높음, 병렬 처리 유리 커넥션 연결 유지 필요 (DB 세션 지속) 비연결 환경에 적합 (웹 API 등) 충돌 및 오류 처리 항목 Pessimistic Locking Optimistic Locking 충돌 처리 충돌 자체가 거의 발생하지 않음 충돌 감지 후 전체 작업 재시도 필요 재시도 비용 낮음 높음 (전체 트랜잭션 롤백 및 재시작) 복잡도 단순 (DB 기능으로 구현 가능) 충돌 감지 로직, 버전 관리 필요 환경 적합성 항목 Pessimistic Locking Optimistic Locking 웹/HTTP 부적합 (상태 지속 필요) 적합 (Stateless 구조 적합) 분산 시스템 동기 락 확장성 낮음 분산 환경에 적합, 스케일 아웃 용이 클라우드 락 서버 병목 및 장애 위험 있음 서버리스, 클라우드에 적합 도전 과제 공통 도전 과제 도전 과제 원인 영향 대응 전략 및 해결 방법 성능 병목 락 경합, 트랜잭션 길이 응답 지연, 처리량 저하 트랜잭션 분리, 락 세분화, 캐시 활용 확장성 한계 단일 노드 의존, 수직 확장 한계 사용자 증가 시 성능 저하 수평 확장, 마이크로서비스, 샤딩 오류 복잡성 동시성 예외, 예측 불가한 경합 사용성 저하, 롤백 증가 예외 전파 설계, 사용자 메시지 보완 스레드 풀 고갈 락 대기 중 스레드 블로킹 스레드 자원 부족, 시스템 정지 위험 비동기 처리, 워커 수 튜닝 분산 트랜잭션 통합 어려움 락과 분산 트랜잭션 (SAGA/2PC) 병행 시 복잡성 장애 복구 및 충돌 처리 어려움 트랜잭션 경계 최소화, 보상 트랜잭션 설계 락 전략과 무관하게 발생할 수 있는 시스템/운영 이슈로서, 확장성, 자원 한계, 복잡한 예외 흐름 등을 다룬다. 특히 멀티노드 환경에서는 스레드 풀 고갈, 트랜잭션 경계 불명확성으로 인해 예기치 않은 병목이 발생할 수 있다.\nPessimistic Locking 특화 도전 과제 도전 과제 원인 영향 대응 전략 및 해결 방법 데드락 락 순서 충돌, 교착 상태 발생 트랜잭션 정지, 성능 저하 락 획득 순서 정형화, 타임아웃 설정, 감지 도구 도입 락 타임아웃 긴 락 대기, 부하 집중 트랜잭션 실패, 오류 발생 트랜잭션 시간 제한, 처리 분리 락 에스컬레이션 다량의 행 락이 테이블 락으로 확대 동시성 급감, 전체 시스템 지연 배치 분할, 인덱스 최적화 락 해제 누락 예외 처리 누락, 명시적 해제 실패 리소스 장기 점유, 서비스 장애 try-finally 구조, 자동 해제 도입 락의 존재 자체가 시스템 리스크 로 작용하는 상황에 초점을 맞춘다. 데드락이나 타임아웃, 락 점유 누락은 실시간 서비스에서 치명적인 영향을 미치며, 락 정책의 정교함이 요구된다.\nOptimistic Locking 특화 도전 과제 도전 과제 원인 영향 대응 전략 및 해결 방법 재시도 스톰 충돌 다발 시 재시도 폭발 부하 집중, 처리량 감소 지수 백오프, 최대 재시도 제한 버전 불일치 분산 노드 간 버전 불균형 데이터 불일치, 충돌 글로벌 버전 관리, CQRS ABA 문제 값 변경 후 동일 값 복원 상황 변경 탐지 실패, 무결성 오류 체크섬/버전 해시, 단조 증가 번호 사용 세밀한 버전 추적 어려움 필드 수준 변경 탐지 어려움 false conflict, 충돌 오탐 변경 이력 관리, 필드별 검증 로직 설계 충돌 감지 및 재시도 처리 에 초점을 둔다. 충돌 빈도에 따라 재시도 폭발 (Replay Storm), 논리적 충돌 미감지 (ABA), 불필요한 충돌 감지 (False Conflict) 등이 발생하며, 이를 해결하기 위해 충돌 완화 설계와 히스토리 기반의 정합성 검증이 요구된다.\n실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점 공통 고려사항 충돌 가능성 및 트래픽 패턴 분석 필요 모니터링과 지표 수집, 실시간 알림 연동 필수 테스트 환경에서의 사전 검증 및 시나리오 테스트 수행 성능/안정성/비즈니스 중요도를 고려한 전략적 선택 요구 비교 카테고리 고려사항 Pessimistic Locking Optimistic Locking 권장 사항 요약 트랜잭션 지속 시간 락 보유 시간 짧게 유지하여 데드락 및 병목 방지 상대적으로 유연함, 충돌 시 재시도 필요 비즈니스 로직은 트랜잭션 외부로 이동 데드락 예방 전략 락 순서, 타임아웃 자원 획득 순서 보장 및 타임아웃 필수 해당 없음 자원 ID 기준 정렬된 획득 순서 사용 타임아웃 및 오류 처리 실패 복구 로직 타임아웃 시 즉시 실패 또는 빠른 재시도 적용 충돌 시 재시도 백오프 전략 필요 공통적으로 재시도 횟수 제한, 사용자 친화적 오류 메시지 필요 트래픽 충돌 빈도 동시성 처리 충돌 빈도 높을수록 효과적 충돌 적은 환경에서 유리 사전 로그 분석 및 통계 기반 충돌 예측 후 선택 성능 요구사항 응답 시간/속도 짧은 응답 보장 어려움, 강한 일관성 중심 빠른 응답 가능, 결과적 일관성에 가까움 성능 민감 시스템은 Optimistic 우선 고려 기술 지원 및 DB 호환성 락/버전 지원 여부 대부분의 DB 에서 FOR UPDATE 지원 버전 필드 필수, ORM 에서 지원 여부 확인 ORM 환경에선 Optimistic, SQL 직접 사용 가능 시엔 Pessimistic 적용 용이 시스템 환경 특성 클라우드, MSA 환경 락 집중 시 병목 우려, 노드 간 일관성 보장 어려움 분산 환경 적합, 스케일 아웃 구조에 유리 분산 시스템 및 MSA 에서는 Optimistic 선호 운영 모니터링 및 테스트 전략 충돌/락 추적, 부하 테스트 락 대기 시간, 데드락 모니터링 필요 충돌 재시도 로그 및 패턴 수집 충돌 패턴, 락 대기시간, 성능 지표 수집 → 경고 및 대시보드 통합 필요 Pessimistic Locking은 충돌 방지에 효과적이나, 락 보유 시간이 길고 데드락에 취약하며 응답 지연이 있을 수 있다. 락 순서를 명확히 정의하고 타임아웃 및 빠른 실패 처리를 설계해야 한다.\nOptimistic Locking은 높은 동시성과 낮은 락 비용을 제공하지만, 충돌 발생 시 재시도 로직과 백오프 전략이 필수이다. 트래픽이 많거나 클라우드 분산 환경에서 적합하다.\n공통적으로 성능 지표, 충돌 로그, 트랜잭션 모니터링을 기반으로 사전 테스트 및 실시간 추적 체계를 갖추는 것이 중요하다.\n실무 도입 가이드 도입 절차 트랜잭션 경합 분석 주요 테이블/기능의 쓰기 충돌 빈도, 동시성 수준 측정 전략 선택 충돌 빈도 높음: Pessimistic 충돌 빈도 낮음: Optimistic 프레임워크 지원 여부 확인 ORM, DBMS 기능 확인 (e.g., JPA, Sequelize, SQLAlchemy) 락 정책 구현 버전 관리, with_for_update 등 적용 테스트 및 롤백 전략 수립 낙관적 충돌 검출 및 재시도 전략 포함 적용 체크리스트 항목 설명 확인 여부 트랜잭션 시간 최소화 락 지속 시간 단축 필수 ✅ 충돌 검출 후 재시도 정책 백오프 및 횟수 제한 포함 ✅ 재시도 불가 시 fallback 대체 로직 존재 여부 ✅ 롤백 감지 예외 발생 시 트랜잭션 롤백 처리 ✅ 관찰 및 경고 락 대기/충돌 경고 모니터링 ✅ 실무 검증/운영 팁 공통: 스트레스 테스트 (동시성 테스트), 실제 사용자 트래픽 패턴 반영해 검증 시스템 모니터링 도구 (예: Prometheus, Grafana) 와 연계 비관적 락: 트랜잭션/쿼리 로그를 통해 락 대기, Deadlock, Timeout 빈도 모니터링 DBMS Lock Table 상태 주기적 점검, 락 그레뉼러리티 (행/테이블 등) 조정 낙관적 락: 충돌률, 롤백률, 재시도 성공률 등 메트릭 수집 Version 관리 및 재시도 정책 (Backoff, 최대 재시도 횟수) 주기적 조정 락 전략의 테스트 및 검증 방법 비관적 락 (Pessimistic Locking) 테스트 포인트 동시성 충돌 발생 시 트랜잭션이 적절히 대기하거나 차단되는지 확인 데드락 (Deadlock) 발생 상황 시 시스템이 자동 감지 및 회복되는지 검증 검증 시나리오 두 개 이상의 클라이언트가 동일 데이터를 동시에 쓰기 시도 → 한쪽만 성공, 다른 쪽은 대기 또는 실패 트랜잭션이 오래 대기하면 타임아웃 후 적절히 롤백되는지 확인 테스트 예시 (Python, SQLite 사용) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import sqlite3 import threading def update_pessimistic(): conn = sqlite3.connect('test.db', timeout=5, isolation_level='EXCLUSIVE') cur = conn.cursor() try: cur.execute(\"BEGIN EXCLUSIVE\") # 테스트를 위해 긴 시간 작업 시뮬레이션 cur.execute(\"UPDATE products SET stock = stock - 1 WHERE id = 1\") conn.commit() except Exception as e: print(\"Lock Error:\", e) conn.rollback() finally: conn.close() 설명: 두 명 이상이 동시에 실행하면 한 쪽만 진입, 나머지는 타임아웃 혹은 대기.\n낙관적 락 (Optimistic Locking) 테스트 포인트 동시 커밋 시 버전 불일치 (충돌) 가 감지되고, 트랜잭션이 적절히 롤백 및 재시도 되는지 확인 재시도 정책 및 알림 로직 정상 동작 확인 검증 시나리오 실제 버전 정보를 변경하지 않고 여러 쓰기 트랜잭션 동시 실행 → 일부만 업데이트, 나머지 롤백/재시도 빈번한 충돌 환경에서 성능 및 충돌 발생률 관찰 테스트 예시 (Python, SQLAlchemy) 1 2 3 4 5 6 7 8 9 10 11 12 def update_optimistic(session, product_id, order_qty, cur_version): product = session.query(Product).filter_by(id=product_id, version=cur_version).first() if product and product.stock \u003e= order_qty: product.stock -= order_qty product.version += 1 try: session.commit() return True except: session.rollback() # 버전 충돌 발생 시 롤백 return False return False 설명: 데이터베이스 테이블에 version 필드 필수. 버전이 다르면 commit 실패 (충돌).\n트랜잭션 격리 수준과의 연계 분석 트랜잭션 격리 수준 동작 방식 및 락킹 전략 연계 Pessimistic 과 Optimistic 연계 분석 Read Uncommitted 커밋되지 않은 변경 읽기 허용 (Dirty Read) 일반적으로 Locking 불필요 (둘 다 위험) Read Committed 커밋된 데이터만 읽기 허용, 읽을 때 공유락 (S-lock) 사용 Pessimistic → SELECT FOR UPDATE\nOptimistic → 가능하나 낮은 보장 Repeatable Read 동일 트랜잭션 내 동일 쿼리 결과 일관 보장, Phantom Read 는 차단 안 됨 Pessimistic → S-lock 지속\nOptimistic → 버전 충돌 가능 대비 필요 Serializable 가장 강력한 격리, 트랜잭션 직렬화 수준으로 처리 Pessimistic → 거의 완벽하게 일관성 유지\nOptimistic → 재시도 빈번 트랜잭션 격리 수준은 Pessimistic Locking 과 더 밀접하게 연동되며, 높은 격리 수준일수록 낙관적 락의 재시도 및 충돌 가능성이 높아진다. 반면 비관적 락은 트랜잭션 격리 수준의 효과를 보강하거나 대체하는 역할도 가능하다. 최적화하기 위한 고려사항 및 주의할 점 카테고리 고려 항목 Pessimistic Locking Optimistic Locking 공통 권장사항 및 주의점 1. Lock 범위 최적화 Granularity, 에스컬레이션 행 락 사용, 자동 승격 조정 필드 기반 버전 관리 필요 최소 범위로 제어, 설정 임계 검토 2. 트랜잭션 최적화 트랜잭션 시간, 커밋 빈도 짧은 트랜잭션 유지, 커밋 전 자원 해제 커밋 시 충돌 검증 최적화 트랜잭션 최소화, 병렬성/정합성 균형 3. 재시도/백오프 전략 충돌 복구, 반복 요청 제한 락 충돌 시 대기 큐 활용 Exponential Backoff, 재시도 제한 설정 반복 재시도 시 타임아웃 및 우선순위 고려 4. 읽기/쓰기 전략 복제본, 분리 처리 읽기 복제본 활용하여 쓰기 병목 분산 읽기 중심 시 낙관적 활용, 쓰기는 동기 처리 읽기/쓰기 트래픽 특성 기반 전략 분리 5. 버전 관리 최적화 인덱스, 캐시, 압축 관련 없음 버전 필드 인덱스, TTL 캐시 적용 캐시 - 저장소 간 TTL/일관성 동기화 주의 6. 비동기/비차단 처리 메시지 큐, 비동기 트랜잭션 락 이후 후속 작업 비동기화 충돌 시 비동기 재처리 큐 활용 Kafka, RabbitMQ 등 연계 고려 7. 분산 환경 최적화 노드 간 동기화, 글로벌 버전 관리 Zookeeper 기반 분산 락 Vector Clock 기반 버전 관리 Global 상태 지연 최소화 설계 필요 8. 모니터링 및 분석 락 상태, 충돌 지표 수집 Lock Manager 상태 추적, Deadlock Graph 분석 충돌율, 재시도 비율 분석, 실패 로그 추적 실시간 지표 대시보드 및 Alert 정책 설정 필요 Lock 범위 최적화\n락이 지나치게 넓거나 세밀할 경우 모두 성능 병목으로 이어질 수 있다. 락 단위 조정과 자동 에스컬레이션 정책은 DB 벤더별로 튜닝 필요.\n트랜잭션 최적화\n트랜잭션을 작게 유지하는 것이 락 유지 시간을 줄이고 교착상태를 방지하며, 전체 시스템 처리량을 향상시킨다.\n재시도/백오프 전략\n낙관적 락에서는 충돌 시 재시도가 핵심 전략이 되므로, 재시도 횟수 제한과 백오프 전략은 성능 유지에 필수적이다.\n읽기/쓰기 전략\n읽기와 쓰기 트래픽이 혼합된 경우에는 락 방식도 혼합 적용하는 것이 효과적이다. 읽기 복제본 활용은 Pessimistic 에서도 유효하다.\n버전 관리 최적화\n낙관적 락은 버전 필드가 핵심이므로, 캐싱, 인덱싱, TTL 관리로 성능 병목을 예방해야 한다.\n비동기/비차단 처리\n락 또는 충돌 이후의 후처리를 비동기로 분리하면 응답 지연을 줄이고 시스템 유연성을 높일 수 있다.\n분산 환경 최적화\n분산 락 및 글로벌 버전 정보는 네트워크 지연 및 장애 대응 능력이 중요한데, Redis/Zookeeper/etcd 각각의 특성을 고려해 설계해야 한다.\n모니터링 및 분석\n락 충돌, 대기 시간, 트랜잭션 충돌률을 정량적으로 측정하고 분석하는 것은 성능 최적화뿐 아니라 문제 조기 발견에 결정적이다.\n공통적으로 고려해야 할 사항 락 범위와 트랜잭션 시간은 성능과 정합성의 균형을 결정짓는 핵심. 모니터링과 지표 기반 튜닝은 락 충돌, 재시도 비율, 대기 시간 등을 실시간으로 확인해 최적화에 반영해야 함. Pessimistic Locking 특화 고려사항 락 에스컬레이션은 필요 이상으로 큰 범위에 락이 걸리지 않도록 튜닝해야 하며, 데이터 밀집도에 따라 조절해야 함. 데드락 방지를 위한 순서 보장, 타임아웃 설정, 우선순위 기반 정책도 고려 필요. Optimistic Locking 특화 고려사항 버전 충돌 시 복구 전략이 명확해야 하고, 과도한 재시도를 방지하는 백오프 알고리즘이 필요함. 버전 필드 캐싱, 압축, 인덱싱 최적화를 통해 성능 병목 최소화. 실무 사용 예시 금융 및 트랜잭션 시스템 시나리오 락 타입 적용 이유 특징 및 고려사항 은행 계좌 이체 Pessimistic 이중 인출 방지, 원자성 보장 락 순서 정의, 트랜잭션 타임아웃 필요 송금 처리 Pessimistic 복수 계좌 잔액 동시 정합성 요구 데드락 가능성 존재, 분산 트랜잭션과 연계 전자상거래 및 예약 시스템 시나리오 락 타입 적용 이유 특징 및 고려사항 재고 수량 관리 혼합형 조회는 성능 중심, 결제는 정확성 중심 Optimistic → Pessimistic 전환 구조 좌석 예약 혼합형 조회는 낙관적 처리, 예약 확정은 락 필요 중복 방지, 트랜잭션 분리 필수 🔹 협업 및 콘텐츠 편집 시나리오 락 타입 적용 이유 특징 및 고려사항 문서 동시 편집 Pessimistic 변경 충돌 방지 편집 락, 사용자 인터페이스와의 연계 필요 댓글/알림/이력 저장 Optimistic 드문 충돌, 실시간 처리 우선 버전 충돌 시 재시도 SaaS 기반 문서 편집기 Optimistic + CRDT 병합 기반 협업 기능 제공 Conflict-free 구조 필요, 병합 로직 중요 🔹 로그/통계/IoT/게임 등 실시간 데이터 시나리오 락 타입 적용 이유 특징 및 고려사항 통계 로그 저장 Optimistic 유실 감내 가능, 이벤트 중심 설계 일시적 실패 허용, 큐 기반 처리 적합 IoT 알람 트리거 혼합형 알람은 정합성 필요, 센싱은 실시간성 중시 알람 트리거만 락 적용, 데이터 수집은 낙관적 처리 랭킹, 게임 입찰 처리 Pessimistic 일관성 필수 (입찰, 아이템 거래 등) 성능 보장 위해 분산 락 또는 캐시 필요 ✅ 6. 요약 정리 (카테고리별 핵심 내용) 금융/트랜잭션: 모든 상태 변경에 대해 정합성이 핵심이므로 Pessimistic Locking이 권장되며, 트랜잭션 중 데드락이나 락 타임아웃 대응이 필요함.\n전자상거래/예약 시스템: 조회는 Optimistic, 결제나 확정 단계에서는 정확성이 중요해 혼합 전략이 일반적임.\n협업 도구/콘텐츠 편집: 사용자 경험과 병합 편의성을 위해 Optimistic Locking 또는 CRDT 기반 처리로 전환됨.\n로그/통계/IoT/게임 처리: 실시간성 우선 환경에서는 대부분 Optimistic Locking을 적용하며, 중요 트리거나 리소스에는 제한적으로 락을 적용함.\n필요하다면 각 시나리오별로 실제 구현 코드 예시, 락 전략 전환 조건, 트랜잭션 경계 설정 방식 등도 추가 분석해줄 수 있어. 다음 단계로 확장하고 싶은 부분이 있다면 알려줘.\n활용 사례 사례 1: 대형 온라인 쇼핑몰에서 재고 부족으로 인한 결제 실패 방지 시나리오: 대형 온라인 쇼핑몰에서 상품 재고 수량 관리 시 재고 부족으로 인한 결제 실패 방지\n시스템 구성:\n사용자 → 주문 시스템 → 재고 관리 서비스 → DB graph TD User --\u003e OrderSystem OrderSystem --\u003e InventoryService InventoryService --\u003e DB[Inventory DB] Workflow:\n주문 요청 → 재고 확인 → Pessimistic Lock → 재고 차감 → 주문 처리 → Lock 해제 역할:\n재고 수량 정확성 보장 동시 결제 충돌 방지 유무에 따른 차이점:\n적용 시: 주문 충돌 없음, 정확한 재고 유지 미적용 시: 동시에 결제 시 재고 초과 주문 가능 구현 예시 (Python + SQLAlchemy):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from sqlalchemy import select, update, and_ from sqlalchemy.orm import Session from models import Inventory def reserve_stock(session: Session, product_id: int, quantity: int): with session.begin(): item = session.execute( select(Inventory).where(Inventory.product_id == product_id).with_for_update() ).scalar_one() if item.stock \u003c quantity: raise Exception(\"Out of stock\") item.stock -= quantity session.commit() 사례 2: 전자상거래 플랫폼의 플래시 세일 이벤트 시스템 시나리오: 대규모 전자상거래 플랫폼의 플래시 세일 이벤트 시스템\n시스템 구성:\n웹 서버: Load Balancer 뒤의 다중 인스턴스 데이터베이스: PostgreSQL 클러스터 (Master-Slave) 캐시: Redis 클러스터 메시지 큐: RabbitMQ 모니터링: Prometheus + Grafana graph TB subgraph \"사용자 요청\" U1[User 1] U2[User 2] U3[User N] end subgraph \"웹 계층\" LB[Load Balancer] W1[Web Server 1] W2[Web Server 2] W3[Web Server N] end subgraph \"서비스 계층\" OS[Order Service] IS[Inventory Service] PS[Payment Service] end subgraph \"데이터 계층\" RC[Redis Cache] MQ[Message Queue] DB[(PostgreSQL)] DBR[(Read Replica)] end subgraph \"모니터링\" MON[Monitoring System] end U1 --\u003e LB U2 --\u003e LB U3 --\u003e LB LB --\u003e W1 LB --\u003e W2 LB --\u003e W3 W1 --\u003e OS W2 --\u003e OS W3 --\u003e OS OS --\u003e IS OS --\u003e PS OS --\u003e MQ IS --\u003e RC IS --\u003e DB PS --\u003e DB DB --\u003e DBR OS --\u003e MON IS --\u003e MON PS --\u003e MON Workflow:\n상품 조회 단계: Redis 캐시에서 상품 정보 조회 (Optimistic) 장바구니 담기: 버전 기반 Optimistic Locking 으로 장바구니 업데이트 재고 확인: Read Replica 에서 재고 조회 (성능 최적화) 주문 생성: Pessimistic Locking 으로 재고 차감 및 주문 생성 결제 처리: 외부 PG 연동 시 타임아웃 고려한 락 관리 주문 완료: 비동기 메시지로 후속 처리 (배송, 알림 등) 역할:\nPessimistic Locking: 재고 차감, 결제 처리에서 데이터 정확성 보장 Optimistic Locking: 장바구니, 사용자 프로필 업데이트에서 성능 최적화 Redis Cache: 상품 정보 캐싱으로 DB 부하 감소 Message Queue: 비동기 처리로 사용자 응답 시간 단축 유무에 따른 차이점:\n락킹 메커니즘 없는 경우: 재고 오버셀링 발생 (100 개 재고에 150 개 주문 접수) 결제 중복 처리로 인한 고객 불만 및 환불 비용 데이터 불일치로 인한 운영 복잡성 증가 Pessimistic Locking 만 사용하는 경우: 안전하지만 동시 접속자 증가 시 심각한 성능 저하 평균 응답 시간 3-5 초 증가 데드락 발생으로 인한 시스템 불안정 Optimistic Locking 만 사용하는 경우: 높은 성능이지만 플래시 세일 시 대량 충돌 발생 재시도 스톰으로 인한 서버 부하 급증 사용자 경험 저하 (반복적인 \" 다시 시도 \" 메시지) 하이브리드 접근법 (권장): 상황별 최적 락킹 전략 적용 평균 응답 시간 1 초 이내 유지 99.9% 데이터 정확성 보장 구현 예시:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 # Python Flask + SQLAlchemy 구현 from flask import Flask, request, jsonify from sqlalchemy import create_engine, Column, Integer, String, DateTime from sqlalchemy.ext.declarative import declarative_base from sqlalchemy.orm import sessionmaker from datetime import datetime import redis import json app = Flask(__name__) # Database 설정 engine = create_engine('postgresql://user:pass@localhost/ecommerce') SessionLocal = sessionmaker(bind=engine) Base = declarative_base() # Redis 설정 redis_client = redis.Redis(host='localhost', port=6379, db=0) class Product(Base): __tablename__ = 'products' id = Column(Integer, primary_key=True) name = Column(String) price = Column(Integer) stock_quantity = Column(Integer) version = Column(Integer, default=1) updated_at = Column(DateTime, default=datetime.utcnow) class Order(Base): __tablename__ = 'orders' id = Column(Integer, primary_key=True) user_id = Column(Integer) product_id = Column(Integer) quantity = Column(Integer) total_amount = Column(Integer) status = Column(String, default='pending') created_at = Column(DateTime, default=datetime.utcnow) @app.route('/api/products/', methods=['GET']) def get_product(product_id): \"\"\"상품 정보 조회 - Redis 캐시 + Optimistic 접근\"\"\" # 1. Redis 캐시 확인 cached_product = redis_client.get(f'product:{product_id}') if cached_product: return jsonify(json.loads(cached_product)) # 2. DB에서 조회 (Read Replica 사용) session = SessionLocal() try: product = session.query(Product).filter_by(id=product_id).first() if not product: return jsonify({'error': 'Product not found'}), 404 product_data = { 'id': product.id, 'name': product.name, 'price': product.price, 'stock_quantity': product.stock_quantity, 'version': product.version } # 3. Redis에 캐시 저장 (5분 TTL) redis_client.setex( f'product:{product_id}', 300, json.dumps(product_data) ) return jsonify(product_data) finally: session.close() @app.route('/api/orders', methods=['POST']) def create_order(): \"\"\"주문 생성 - Pessimistic Locking 적용\"\"\" data = request.get_json() user_id = data.get('user_id') product_id = data.get('product_id') quantity = data.get('quantity', 1) session = SessionLocal() try: session.begin() # 1. Pessimistic Lock으로 재고 확인 및 차감 product = session.query(Product).filter_by(id=product_id).with_for_update().first() if not product: session.rollback() return jsonify({'error': 'Product not found'}), 404 if product.stock_quantity \u003c quantity: session.rollback() return jsonify({'error': 'Insufficient stock'}), 400 # 2. 재고 차감 product.stock_quantity -= quantity product.updated_at = datetime.utcnow() # 3. 주문 생성 order = Order( user_id=user_id, product_id=product_id, quantity=quantity, total_amount=product.price * quantity ) session.add(order) # 4. 트랜잭션 커밋 session.commit() # 5. 캐시 무효화 redis_client.delete(f'product:{product_id}') return jsonify({ 'order_id': order.id, 'status': 'success', 'remaining_stock': product.stock_quantity }) except Exception as e: session.rollback() return jsonify({'error': str(e)}), 500 finally: session.close() @app.route('/api/cart', methods=['PUT']) def update_cart(): \"\"\"장바구니 업데이트 - Optimistic Locking 적용\"\"\" data = request.get_json() user_id = data.get('user_id') items = data.get('items', []) max_retries = 3 for attempt in range(max_retries): session = SessionLocal() try: # 1. 현재 사용자 카트 정보 조회 cart_key = f'cart:{user_id}' current_cart = redis_client.get(cart_key) if current_cart: cart_data = json.loads(current_cart) original_version = cart_data.get('version', 1) else: cart_data = {'items': [], 'version': 1} original_version = 1 # 2. 카트 데이터 업데이트 new_cart_data = { 'items': items, 'version': original_version + 1, 'updated_at': datetime.utcnow().isoformat() } # 3. Optimistic Update (Lua 스크립트 사용) lua_script = \"\"\" local key = KEYS[1] local expected_version = tonumber(ARGV[1]) local new_data = ARGV[2] local current_data = redis.call('GET', key) if current_data then local current_version = cjson.decode(current_data).version if current_version ~= expected_version then return 0 -- 버전 충돌 end end redis.call('SET', key, new_data) redis.call('EXPIRE', key, 3600) -- 1시간 TTL return 1 -- 성공 \"\"\" result = redis_client.eval( lua_script, 1, cart_key, original_version, json.dumps(new_cart_data) ) if result == 1: return jsonify({ 'status': 'success', 'cart': new_cart_data }) else: # 충돌 발생, 재시도 if attempt \u003c max_retries - 1: time.sleep(0.1 * (2 ** attempt)) # 지수 백오프 continue else: return jsonify({'error': 'Cart update conflict'}), 409 except Exception as e: return jsonify({'error': str(e)}), 500 finally: session.close() return jsonify({'error': 'Max retries exceeded'}), 503 if __name__ == '__main__': app.run(debug=True) 사례 3: 온라인 쇼핑몰에서 재고관리 시나리오: 온라인 쇼핑몰에서 재고관리 API 에 동시에 다수의 주문 요청이 들어올 때\n시스템 구성:\nWeb API 서버 데이터베이스 시스템 (DBMS) 클라이언트 (사용자 및 주문 API) graph TD Client1(Client A) --\u003e WebAPI(Web API 서버) Client2(Client B) --\u003e WebAPI WebAPI --\u003e DB[DB - 상품 테이블] Workflow:\n고객이 상품 주문 요청을 보내면 Web API 가 재고를 확인, 감산하여 DB 에 반영 비관적 락: 주문 처리 중 다른 처리 차단 낙관적 락: 처리 후 커밋 시점 충돌 검사, 충돌 시 롤백 후 재시도 역할:\n비관적 락: 데이터 충돌 선제 차단 낙관적 락: 빠른 처리와 충돌 발생 시 롤백 대응 유무에 따른 차이점:\n비관적 락 도입: 주문 동시 처리 불가, 대기 시간 증가. 데이터 충돌 완전 차단 낙관적 락 도입: 빠른 처리, 동시에 주문할 경우 일부에서는 실패 및 재시도 발생 가능 구현 예시: Python, SQLAlchemy ORM 기반\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # 비관적 락 from sqlalchemy import select, update, and_, text from sqlalchemy.orm import Session def process_order_pessimistic(session: Session, product_id: int, order_qty: int): # 상품 행을 SELECT FOR UPDATE로 가져옴(락 선점) product = session.execute( select(Product).where(Product.id == product_id).with_for_update() ).scalar_one_or_none() if product and product.stock \u003e= order_qty: product.stock -= order_qty # 변경사항 커밋 session.commit() return True else: session.rollback() return False # 낙관적 락 def process_order_optimistic(session: Session, product_id: int, order_qty: int, version: int): product = session.query(Product).filter( and_(Product.id == product_id, Product.version == version) ).with_for_update(nowait=False).first() # 버전이 일치하면 업데이트 if product and product.stock \u003e= order_qty: product.stock -= order_qty product.version += 1 # 버전 증가 try: session.commit() return True except: session.rollback() return False else: session.rollback() return False 사례 4: 클라우드 기반 분산 처리 시스템 시나리오: 대형 온라인 상품 검색 시스템에서 수많은 사용자가 동시에 상품 정보를 조회 및 일부 수정\n시스템 구성:\n검색 API 서버 (분산) DBMS(예: PostgreSQL, MySQL: MVCC 지원) 캐시 레이어 (Redis 등) Mermaid 다이어그램 (분산 낙관적 락/MVCC 기반)\nsequenceDiagram participant User participant APIServer participant DBMS as Database (MVCC) User-\u003e\u003eAPIServer: 상품 수정 요청 APIServer-\u003e\u003eDBMS: 최신 버전 조회 DBMS-\u003e\u003eAPIServer: 버전 정보와 데이터 반환 APIServer-\u003e\u003eDBMS: 데이터 변경 요청 (버전 함께 전달) alt 충돌 없음 DBMS-\u003e\u003eAPIServer: 변경 성공/커밋 else 충돌 발생 DBMS-\u003e\u003eAPIServer: 충돌, 롤백 알림 APIServer-\u003e\u003eUser: 재시도 요청 또는 오류 반환 end Workflow:\nAPI 서버가 최신 상품 정보 (버전 포함) 읽기 사용자 정보로 수정 요청 DB 는 커밋 시점에 버전 비교하여 충돌 확인 충돌 없으면 반영, 있으면 롤백 및 오류 알림 역할:\nDBMS(MVCC/낙관적 락): 동시성 보장/정합성 유지 API 서버: 재시도/백오프 등 비즈니스 로직 유무에 따른 차이점:\nMVCC/낙관적 락 없을 때: 일관성 저하, 일시적 데이터 잘못된 접근 가능 있을 때: lock-free 읽기, 대규모 확장성 및 성능 확보 구현 예시 (Python, SQLAlchemy, MVCC 기반 PostgreSQL):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # MVCC 기반으로 Version 필드(예: xmin)을 사용 from sqlalchemy.orm import Session from sqlalchemy.exc import StaleDataError def update_product_mvcc(session: Session, product_id: int, new_price: float, expected_version: int): try: product = session.query(Product).filter_by(id=product_id, version=expected_version).first() if not product: return False # 충돌 발생 product.price = new_price product.version += 1 session.commit() return True except StaleDataError: session.rollback() return False 설명: 트랜잭션 커밋 시도 전의 version 값이 일치하면 성공, 아니면 충돌 감지 후 롤백. 정리 및 학습 가이드 내용 정리 Pessimistic vs. Optimistic Locking 은 단순한 선택이 아니라, **시스템 요구사항 (정합성 vs 성능 vs 확장성)**에 따라 유연하게 구성되어야 할 전략이다. 특히 현대 분산 시스템에서는 조합 전략과 상황 기반 정책을 통해 충돌 회피와 성능 확보를 동시에 추구하는 방향이 명확히 드러나고 있다.\n이제 단일 방식보다는 트래픽 특성, 비즈니스 도메인, 기술 인프라에 따라 동적이고 조합적인 락 전략이 핵심이 된다.\n항목 Pessimistic Locking Optimistic Locking 기본 철학 충돌이 일어난다 충돌은 드물다 적용 시점 접근 전 락 획득 커밋 시 충돌 검증 장점 강력한 정합성, 예측 가능성 높은 성능, 확장성 단점 성능 저하, 데드락 위험 충돌 시 재시도, 오류 처리 복잡 적합 사례 금융, 재고, 예약 시스템 SNS, 로깅, 콘텐츠 시스템 실무 전략 핵심 구간에만 적용, 트랜잭션 단위로 관리 충돌 감지/재시도 논리 포함 조합 전략 하이브리드 전략 (읽기 - 낙관적 / 쓰기 - 비관적) 기술 트렌드 Redis Redlock, Zookeeper, etcd 등 분산 락 CQRS, Event Sourcing 과 연계된 동시성 제어 방식 트렌드 및 최신 기술 동향 요약 분산 환경 확산: 락의 중앙 집중화는 병목이 될 수 있어, 분산 락 시스템 (Redis Redlock, etcd, Zookeeper 등) 이 부상 CQRS + Event Sourcing: CQRS: 커맨드 (Command) 와 쿼리 (Query) 를 분리해 동시성 충돌 가능성 최소화 Event Sourcing: 상태 변경을 이벤트 로그로 대체해 트랜잭션 충돌 문제를 완화 Lock Granularity: Row-level, Column-level, Attribute-level Locking 등으로 세분화 → 경쟁 최소화 + 성능 향상 Adaptive Locking Strategy: 동적 정책 기반 적용: 트래픽 분석 → 충돌 빈도에 따라 전략 자동 전환 (예: optimistic fallback to pessimistic) 학습 항목 정리 중요도 카테고리 주제 항목 설명 기본 동시성 제어 트랜잭션 기본 개념 ACID, 격리 수준 락 전략과 트랜잭션 일관성 사이의 관계 이해 기본 락 전략 Pessimistic Locking SELECT FOR UPDATE, 2PL 트랜잭션 시작 시점에서 리소스를 선점하여 충돌 방지 기본 락 전략 Optimistic Locking 버전 관리, 충돌 감지 커밋 시점에 버전 일치 여부로 충돌 여부 판단 기본 트랜잭션 제어 락 세분화 Row/Table/DB 수준 락 과도한 락으로 인한 병목 방지를 위해 적용 수준 조절 심화 구현 기법 충돌 감지 및 해결 CAS, 재시도, 백오프 충돌 발생 시 무한 루프를 방지하고 효율적 처리 전략 필요 심화 성능 최적화 Granularity Tuning 락 범위 및 기간 조절 성능 병목 최소화를 위한 락 조정 전략 심화 분산 환경 Redis/ZooKeeper 락 Redlock, ZK 기반 락 분산 트랜잭션에서의 정합성 보장을 위한 락 매커니즘 실무 구현 전략 MVCC 다중 버전 일관성 제어 Oracle/PostgreSQL 등에서 사용하는 논블로킹 동시성 제어 방식 실무 실무 적용 전략 CQRS, 이벤트 소싱 Command/Query 분리 전략 락 병목을 아키텍처 수준에서 해소 실무 실무 적용 전략 모니터링 및 테스트 성능 메트릭, 부하 테스트 도구 충돌 빈도, 락 대기 시간 측정 및 시뮬레이션 도구 활용 실무 장애 대응 데드락 탐지 및 회피 Timeout, Wait-for Graph Pessimistic 환경에서 반드시 적용해야 할 보호 전략 기본 항목에서는 락 전략의 선택을 위한 트랜잭션 이론과 기본 동작 이해가 중요하며, 격리 수준과 ACID 특성, 그리고 데이터베이스 락 동작 방식은 반드시 선행 학습이 필요함.\n심화 항목에서는 충돌 해결 및 최적화 전략에 대한 이해가 중요하다. 특히 낙관적 락에서는 CAS, 재시도, 백오프가 실질적인 핵심이며, 분산 환경에서의 락 일관성은 고급 주제로 분류됨.\n실무 항목에서는 CQRS 및 이벤트 소싱 등 아키텍처 차원의 해결 전략과 함께, 락으로 인한 병목을 감지하고 대응하기 위한 모니터링과 테스트 전략이 중요하다.\n특히 Pessimistic은 데드락 방지와 락 유지 최소화 전략, Optimistic은 충돌 후 전략적 복구 설계가 실무의 핵심이다.\n용어 정리 카테고리 용어 설명 기본 개념 트랜잭션 격리 수준 (Isolation Level) 트랜잭션 간 간섭 허용 수준 (RU, RC, RR, Serializable 등) 동시성 제어 (Concurrency Control) 다중 트랜잭션 간 무결성 보장 메커니즘 Lost Update 동시 수정으로 인해 변경사항 손실되는 현상 Deadlock (교착 상태) 서로 자원을 기다리며 무한 대기 락킹 전략 Pessimistic Locking 트랜잭션 시작 시점에 락 획득 Optimistic Locking 커밋 시점 충돌 검증을 통한 병행성 확보 2PL (Two-Phase Locking) Lock → Unlock 두 단계로 처리 Shared / Exclusive Lock 읽기 공유 / 쓰기 배타 락 구분 Lock Escalation 세부 락을 대범위 락으로 승격 낙관적 락 핵심 요소 Version Number 레코드 변경 이력 기반 충돌 감지용 필드 Timestamp 트랜잭션 시작 시각 기반 충돌 감지 CAS (Compare-And-Swap) 메모리 기반 원자적 갱신 연산 ABA 문제 값이 원래 값으로 복귀해도 변경을 감지하지 못하는 문제 성능 및 운영 전략 Lock Timeout 일정 시간 경과 시 자동 락 해제 Backoff Strategy 실패 후 재시도 간 시간 지연 전략 Granularity Tuning 락 단위 조절로 병목 완화 분산 락 및 고급 기술 Distributed Lock 다중 노드 락 제어 기법 Redlock (Redis 기반) Redis 인스턴스 기반 분산 락 MVCC 멀티 버전 데이터로 충돌 최소화 Event Sourcing 상태 변경을 이벤트 로그로 관리 SQL/구현 도구 SELECT FOR UPDATE 락을 동반하는 SQL 명령 Lock Table 현재 락 상태를 저장하는 DB 내부 구조 Stress Test 극한 상황에서 시스템 동시성 검증 참고 및 출처 Pessimistic vs. Optimistic Locking – Martin Fowler Pessimistic Locking in JPA – Baeldung Optimistic Locking in JPA – Baeldung Optimistic Concurrency Control – MongoDB Docs java.util.concurrent.locks – Oracle Java Docs Redlock Algorithm – Redis Docs Optimistic Locking vs Pessimistic Locking – Medium Optimistic vs. Pessimistic Locking – Stack Overflow How Databases Guarantee Isolation – FreeCodeCamp Optimistic vs. Pessimistic Locking – Vlad Mihalcea Optimistic and Pessimistic Locking in SQL – Learning Notes Concurrency Control and Optimistic Locking – SleekFlow Pessimistic vs. Optimistic Locking in MySQL – DEV Community Optimistic Concurrency Control – Wikipedia Pessimistic Locking – Wikipedia Multi-Version Concurrency Control (MVCC) – Wikipedia Optimistic Locking vs. Pessimistic: A Guide for System Designers – LinkedIn Pros and Cons of Locking in SQL Transactions – LinkedIn Lock-Free Programming – Wikipedia Optimistic Locking in SQLAlchemy Docs Pessimistic Locking Pattern – Martin Fowler Pessimistic vs. Optimistic Locking in PostgreSQL – Cybertec Transaction Concurrency Control – PostgreSQL Docs Pessimistic vs Optimistic Locking in Database Systems – Baeldung Optimistic and Pessimistic Concurrency Control in Distributed Databases – Stanford Distributed Lock with Redis: Redlock – Redis Docs ","wordCount":"8514","inLanguage":"en","image":"https://buenhyden.github.io/images","datePublished":"2025-08-04T03:58:00Z","dateModified":"2025-08-04T03:58:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/pessimistic-vs-optimistic-locking/"},"publisher":{"@type":"Organization","name":"hyunyoun's Blog","logo":{"@type":"ImageObject","url":"https://buenhyden.github.io/favicons/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>HY's Blog</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/computer-science-fundamentals/>Computer Science Fundamentals</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency-fundamentals/basic-concepts/lock/>Lock</a></div><h1 class="post-title entry-hint-parent">Pessimistic vs. Optimistic Locking</h1><div class=post-description>Pessimistic과 Optimistic Locking은 데이터 무결성 보장을 위한 두 가지 대표 동시성 제어 전략이다. 전자는 충돌을 사전에 차단하고, 후자는 충돌 발생 시 검증한다. 충돌 빈도, 시스템 환경, 성능 요구에 따라 적절히 선택해야 한다.</div><div class=post-meta><span title='2025-08-04 03:58:00 +0000 UTC'>August 4, 2025</span>&nbsp;·&nbsp;40 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/buenhyden/blog-data/main/content/posts/Computer%20Science%20Fundamentals/Concurrency%20Fundamentals/Basic%20Concepts/Lock/pessimistic-vs-optimistic-locking.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#pessimistic-vs-optimistic-locking>Pessimistic vs. Optimistic Locking</a><ul><li><a href=#등장-배경-및-발전-과정>등장 배경 및 발전 과정</a></li><li><a href=#목적-및-필요성>목적 및 필요성</a></li><li><a href=#핵심-개념>핵심 개념</a></li><li><a href=#주요-기능-및-역할>주요 기능 및 역할</a></li><li><a href=#특징>특징</a></li><li><a href=#핵심-원칙>핵심 원칙</a></li><li><a href=#주요-원리-및-작동-방식>주요 원리 및 작동 방식</a></li><li><a href=#구조-및-아키텍처>구조 및 아키텍처</a></li><li><a href=#구현-기법-및-방법>구현 기법 및 방법</a></li><li><a href=#pessimistic-vs-optimistic-locking-비교>Pessimistic vs. Optimistic Locking 비교</a></li><li><a href=#공통점과-차이점>공통점과 차이점</a></li><li><a href=#장점과-단점>장점과 단점</a></li><li><a href=#도전-과제>도전 과제</a></li><li><a href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점</a></li><li><a href=#최적화하기-위한-고려사항-및-주의할-점>최적화하기 위한 고려사항 및 주의할 점</a></li><li><a href=#실무-사용-예시>실무 사용 예시</a></li><li><a href=#-협업-및-콘텐츠-편집>🔹 협업 및 콘텐츠 편집</a></li><li><a href=#-로그통계iot게임-등-실시간-데이터>🔹 로그/통계/IoT/게임 등 실시간 데이터</a></li></ul></li><li><a href=#-6-요약-정리-카테고리별-핵심-내용>✅ 6. 요약 정리 (카테고리별 핵심 내용)</a><ul><li><a href=#활용-사례>활용 사례</a></li></ul></li><li><a href=#정리-및-학습-가이드>정리 및 학습 가이드</a><ul><li><a href=#내용-정리>내용 정리</a></li><li><a href=#학습-항목-정리>학습 항목 정리</a></li></ul></li><li><a href=#용어-정리>용어 정리</a></li><li><a href=#참고-및-출처>참고 및 출처</a></li></ul></nav></div></details></div><div class=post-content><h2 id=pessimistic-vs-optimistic-locking>Pessimistic vs. Optimistic Locking<a hidden class=anchor aria-hidden=true href=#pessimistic-vs-optimistic-locking>#</a></h2><p><strong>Pessimistic Locking</strong>은 충돌을 우려해 먼저 락을 거는 방식으로, 데이터 무결성이 중요한 환경에서 적합하다. <strong>Optimistic Locking</strong>은 충돌 가능성이 낮다고 보고 사후 검증을 통해 일관성을 보장한다. 시스템 요구사항과 성능 특성에 따라 선택된다.</p><h3 id=등장-배경-및-발전-과정>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정>#</a></h3><p><strong>Pessimistic Locking</strong>은 <strong>초기 RDBMS + ACID 보장</strong> 요구에서 발전했으며, 충돌 회피를 위한 보수적 접근 방식이 정립되었으며, <strong>Optimistic Locking</strong>은 <strong>낮은 충돌 환경을 가정</strong>한 성능 중심 전략으로, <strong>분산 시스템, 웹/모바일 기반 환경</strong>에서 발전해왔다.</p><h4 id=pessimistic-locking>Pessimistic Locking<a hidden class=anchor aria-hidden=true href=#pessimistic-locking>#</a></h4><ul><li><p><strong>등장 배경</strong>:<br>1970 년대 초반, IBM System R 등의 RDBMS 에서 <strong>ACID 보장과 동시성 제어</strong>를 위해 등장.<br>특히 <strong>Lost Update, Dirty Read</strong> 같은 문제 해결이 핵심 과제였음.</p></li><li><p><strong>발전 과정</strong>:</p><ul><li>1976 년 <strong>Jim Gray</strong>의 트랜잭션 및 2PL 이론 등장</li><li>1980 년대 주요 상용 DB (Oracle, DB2 등) 에 <strong>비관적 락 기본 내장</strong></li><li><strong>ERP, 금융, 제조 등 고정합성 업무</strong>에서 지금까지도 널리 사용됨</li><li>분산 환경에서는 <strong>분산 락 (ZooKeeper, etcd)</strong> 기반으로 확장됨</li></ul></li></ul><h4 id=optimistic-locking>Optimistic Locking<a hidden class=anchor aria-hidden=true href=#optimistic-locking>#</a></h4><ul><li><p><strong>등장 배경</strong>:<br>1979 년 <strong>H.T. Kung</strong>과 <strong>John T. Robinson</strong>의 논문에서 <strong>낮은 충돌 환경</strong> 가정 하에 효율적인 동시성 제어로 제안.<br>트랜잭션 간 충돌이 드물고 <strong>읽기 위주의 처리량 증가</strong>가 필요한 환경을 타깃으로 하였다.</p></li><li><p><strong>발전 과정</strong>:</p><ul><li>1990 년대 이후 <strong>웹 애플리케이션, 분산 시스템</strong> 확산과 함께 주목</li><li><strong>@Version 기반 낙관적 락</strong>이 JPA, Hibernate 등에서 표준화</li><li><strong>NoSQL DB (MongoDB, DynamoDB 등)</strong> 에서 충돌 검증 알고리즘으로 응용</li><li>최근에는 <strong>CQRS, 이벤트 소싱, API 기반 마이크로서비스</strong>에 핵심 요소로 사용됨</li></ul></li></ul><h3 id=목적-및-필요성>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성>#</a></h3><h4 id=공통적인-목적-및-필요성>공통적인 목적 및 필요성<a hidden class=anchor aria-hidden=true href=#공통적인-목적-및-필요성>#</a></h4><ul><li><strong>데이터 정합성 유지</strong>: 여러 사용자가 동시에 공유 자원에 접근하는 상황에서 일관성과 무결성을 보장함.</li><li><strong>충돌 관리 전략</strong>: 동시 접근 시 발생할 수 있는 충돌을 예방하거나 감지하고 복구하여 시스템 오류나 데이터 손실을 방지함.</li><li><strong>시스템 성능 - 신뢰성 균형</strong>: 높은 처리량을 유지하면서도 신뢰성 있는 트랜잭션 처리를 도모함.</li></ul><h4 id=방식별-목적-및-필요성>방식별 목적 및 필요성<a hidden class=anchor aria-hidden=true href=#방식별-목적-및-필요성>#</a></h4><table><thead><tr><th>구분</th><th>비관적 락 (Pessimistic)</th><th>낙관적 락 (Optimistic)</th></tr></thead><tbody><tr><td><strong>핵심 목적</strong></td><td>선제적으로 자원 점유하여 충돌 자체를 방지</td><td>충돌이 적다는 가정 하에 최대 동시성과 성능 확보</td></tr><tr><td><strong>필요성</strong></td><td>충돌 빈도가 높고, 데이터 정합성 위반 시 치명적인 환경 (금융, 예약 등)</td><td>충돌 가능성이 낮고, 롤백이나 재시도가 비용적으로 용인되는 환경 (분산 처리, 분석 등)</td></tr><tr><td><strong>적용 예시</strong></td><td>은행 계좌 출금, 항공 좌석 예약, 창고 재고 처리 등</td><td>게시글 수정, 실시간 로그 저장, 통계 데이터 집계 등</td></tr></tbody></table><h3 id=핵심-개념>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념>#</a></h3><p>Pessimistic 과 Optimistic Locking 은 데이터 정합성과 성능 균형을 위한 핵심 동시성 제어 전략이다.<br>전자는 충돌 회피 중심의 락 기반 방식, 후자는 충돌 검증 기반의 비 - 락 방식이며, 충돌 빈도와 시스템 특성에 따라 선택된다.</p><h4 id=공통-핵심-개념>공통 핵심 개념<a hidden class=anchor aria-hidden=true href=#공통-핵심-개념>#</a></h4><table><thead><tr><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>동시성 제어 수단</strong></td><td>데이터 일관성과 무결성 유지를 위한 트랜잭션 제어 방식</td></tr><tr><td><strong>락을 통한 경쟁 제어</strong></td><td>동시 접근 시 자원 충돌이나 정합성 문제를 예방하기 위한 전략</td></tr><tr><td><strong>실무 전략 선택 기준</strong></td><td>충돌 빈도, 데이터 정합성 요구 수준, 시스템 특성 등 고려</td></tr></tbody></table><h4 id=pessimistic-locking-1>Pessimistic Locking<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-1>#</a></h4><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>정의</strong></td><td>리소스 접근 전에 락을 걸어 다른 트랜잭션의 접근을 차단</td></tr><tr><td><strong>전제</strong></td><td>충돌 발생 가능성이 높음 (ex. 다중 사용자가 동일 자원 수정)</td></tr><tr><td><strong>기술 기반</strong></td><td>2PL (Two-Phase Locking), DB 물리적 락, 트랜잭션 격리 수준</td></tr><tr><td><strong>실무 적용</strong></td><td>금융, ERP, 재고 관리 등 정합성 최우선 환경</td></tr><tr><td><strong>장애 대응</strong></td><td>Deadlock 감지 및 타임아웃 설정 필수</td></tr><tr><td><strong>성능 영향</strong></td><td>높은 락 경쟁으로 인한 병목 가능성, 락 해제까지 자원 점유</td></tr></tbody></table><h4 id=optimistic-locking-1>Optimistic Locking<a hidden class=anchor aria-hidden=true href=#optimistic-locking-1>#</a></h4><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>정의</strong></td><td>트랜잭션 완료 시 충돌 여부를 검사하고 필요 시 롤백 처리</td></tr><tr><td><strong>전제</strong></td><td>충돌이 드문 환경, 읽기 빈도 높고 쓰기 적은 워크로드</td></tr><tr><td><strong>기술 기반</strong></td><td>MVCC, 버전 번호, Timestamp, Checksum 기반 충돌 검증</td></tr><tr><td><strong>실무 적용</strong></td><td>웹 애플리케이션, 쇼핑몰, 게시판, API 서버 등</td></tr><tr><td><strong>장애 대응</strong></td><td>충돌 시 재시도 로직, 백오프 알고리즘 필요</td></tr><tr><td><strong>성능 영향</strong></td><td>락 없음 → 처리량 증가 가능성, 다만 충돌 시 비용 상승</td></tr></tbody></table><h4 id=전략-선택-가이드라인-요약>전략 선택 가이드라인 요약<a hidden class=anchor aria-hidden=true href=#전략-선택-가이드라인-요약>#</a></h4><table><thead><tr><th>조건</th><th>권장 전략</th></tr></thead><tbody><tr><td>충돌 가능성 높음</td><td>Pessimistic Locking</td></tr><tr><td>충돌 가능성 낮음</td><td>Optimistic Locking</td></tr><tr><td>실시간 고정합성 필요</td><td>Pessimistic</td></tr><tr><td>응답속도/확장성 우선</td><td>Optimistic</td></tr><tr><td>네트워크 지연/분산 환경</td><td>Optimistic (재시도 기반이 유리)</td></tr></tbody></table><h3 id=주요-기능-및-역할>주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#주요-기능-및-역할>#</a></h3><h4 id=공통-기능-및-역할>공통 기능 및 역할<a hidden class=anchor aria-hidden=true href=#공통-기능-및-역할>#</a></h4><ul><li><strong>공통 기능</strong>: 동시 접근 시 자원 상태를 통제하여 <strong>경쟁 조건을 제어</strong></li><li><strong>공통 역할</strong>: <strong>데이터 정합성 유지</strong>와 <strong>트랜잭션 충돌 대응</strong>을 통해 시스템 신뢰성을 확보</li></ul><h4 id=방식별-기능-및-역할>방식별 기능 및 역할<a hidden class=anchor aria-hidden=true href=#방식별-기능-및-역할>#</a></h4><table><thead><tr><th>구분</th><th>기능</th><th>역할</th></tr></thead><tbody><tr><td>Pessimistic Locking</td><td>자원 접근 전 락 선점<br>Row/Table 수준의 독점 락</td><td><strong>자원 충돌 차단 → 안정성 보장</strong></td></tr><tr><td></td><td>트랜잭션 종료 후 해제<br>데드락 방지 정책 적용</td><td><strong>정해진 순서에 따라 순차 처리 유도</strong></td></tr><tr><td>Optimistic Locking</td><td>버전 정보 또는 타임스탬프 활용<br>커밋 시 변경 여부 확인</td><td><strong>충돌 감지 및 롤백 기반 처리 → 처리량 최대화</strong></td></tr><tr><td></td><td>실패 시 재시도 로직 또는 사용자 안내 메시지 제공</td><td><strong>동시성 확보 및 블로킹 없는 읽기 보장</strong></td></tr></tbody></table><ul><li><strong>Pessimistic Locking</strong>은 충돌이 치명적인 환경에서의 <strong>사전 방어형 전략</strong>이며, 데이터 정합성 보장을 우선시함.</li><li><strong>Optimistic Locking</strong>은 충돌이 드물고 빠른 처리가 중요한 환경에서의 <strong>사후 복구형 전략</strong>으로, 성능과 확장성 확보에 적합함.</li><li><strong>둘 모두 트랜잭션 제어 및 일관성 유지에 필수적인 전략이며</strong>, 사용 환경에 따라 병행 적용 가능.</li></ul><h4 id=락-정책-선택-가이드라인-매트릭스>락 정책 선택 가이드라인 매트릭스<a hidden class=anchor aria-hidden=true href=#락-정책-선택-가이드라인-매트릭스>#</a></h4><table><thead><tr><th>판단 기준</th><th>선택 기준 설명</th><th>권장 락 방식</th><th>비고</th></tr></thead><tbody><tr><td><strong>충돌 발생 가능성</strong></td><td>자원에 대한 동시 접근 및 갱신 충돌이 빈번하게 발생하는가?</td><td>Pessimistic Locking</td><td>충돌 방지 목적이 우선. 데이터 무결성 중시 시스템에 적합</td></tr><tr><td></td><td>충돌이 드물고 대부분이 읽기 위주인가?</td><td>Optimistic Locking</td><td>성능 중시. 충돌 감지 후 재시도 처리 가능</td></tr><tr><td><strong>트랜잭션 지속 시간</strong></td><td>트랜잭션이 오래 지속되어 락 점유 시간이 긴가?</td><td>Optimistic Locking</td><td>락 보유로 인한 병목 방지</td></tr><tr><td></td><td>짧은 시간 내에 처리되는 작업인가?</td><td>Pessimistic Locking</td><td>단기간 독점이 효과적일 수 있음</td></tr><tr><td><strong>데이터 정합성 중요도</strong></td><td>재고/금융/예약처럼 절대 오류가 없어야 하는가?</td><td>Pessimistic Locking</td><td>강한 정합성과 예측 가능한 처리 보장</td></tr><tr><td></td><td>일부 손실 또는 재시도가 허용 가능한가?</td><td>Optimistic Locking</td><td>처리량과 성능에 유리</td></tr><tr><td><strong>트랜잭션 충돌 처리 비용</strong></td><td>충돌 시 복구/재처리 비용이 높은가?</td><td>Pessimistic Locking</td><td>충돌 자체를 방지하는 것이 유리</td></tr><tr><td></td><td>충돌 시 복구가 용이하고 자동화되어 있는가?</td><td>Optimistic Locking</td><td>롤백 및 재시도 비용이 적고 예측 가능할 경우 적합</td></tr><tr><td><strong>동시성 수준 요구</strong></td><td>동시 요청 처리량이 매우 중요한가 (읽기 작업이 대부분)?</td><td>Optimistic Locking</td><td>락이 없거나 최소한으로 작용하므로 성능 극대화 가능</td></tr><tr><td></td><td>트랜잭션 수보다 정합성과 순서가 중요한가?</td><td>Pessimistic Locking</td><td>충돌 방지가 핵심일 경우 적합</td></tr><tr><td><strong>네트워크 환경</strong></td><td>네트워크 지연이 큰 분산 환경인가?</td><td>Optimistic Locking</td><td>락 회수를 위한 round-trip 이 없음</td></tr><tr><td></td><td>단일 DB 또는 로컬 환경인가?</td><td>Pessimistic Locking</td><td>빠른 락 획득/해제가 가능한 환경에 적합</td></tr></tbody></table><h5 id=판단-흐름>판단 흐름<a hidden class=anchor aria-hidden=true href=#판단-흐름>#</a></h5><pre class=mermaid>flowchart TD
    A[충돌 가능성 높음?] --&gt;|Yes| B[Pessimistic Locking]
    A --&gt;|No| C[낙관적 접근 가능성 검토]
    C --&gt; D[트랜잭션 길고 성능 중요?]
    D --&gt;|Yes| E[Optimistic Locking]
    D --&gt;|No| F[복구 비용 고려]
    F --&gt;|복구 비용 큼| B
    F --&gt;|복구 용이| E
</pre><h5 id=적용-예시>적용 예시<a hidden class=anchor aria-hidden=true href=#적용-예시>#</a></h5><table><thead><tr><th>적용 시스템</th><th>선택 전략</th><th>사유</th></tr></thead><tbody><tr><td>은행 송금 시스템</td><td>Pessimistic Locking</td><td>충돌 발생 시 데이터 손실 불가, 동시성보다 정합성 우선</td></tr><tr><td>쇼핑몰 재고관리</td><td>Pessimistic Locking</td><td>수량 초과 주문 방지 필요, 재고 감소 시 강한 일관성 필요</td></tr><tr><td>게시판 댓글 작성</td><td>Optimistic Locking</td><td>충돌 발생 가능성 낮음, 대부분 읽기 위주 작업</td></tr><tr><td>협업 문서 편집기</td><td>Optimistic Locking</td><td>실시간 편집, 성능/확장성 우선, 버전 충돌 시 사용자 재시도 처리</td></tr></tbody></table><h3 id=특징>특징<a hidden class=anchor aria-hidden=true href=#특징>#</a></h3><h4 id=공통-특징>공통 특징<a hidden class=anchor aria-hidden=true href=#공통-특징>#</a></h4><ul><li><strong>동시성 환경에서의 정합성 보장 메커니즘</strong></li><li><strong>트랜잭션 기반 처리와 밀접한 관련</strong></li><li><strong>충돌 발생 가능성에 대한 대응 전략 존재</strong></li></ul><h4 id=pessimistic-vs-optimistic-locking-특징>Pessimistic vs. Optimistic Locking 특징<a hidden class=anchor aria-hidden=true href=#pessimistic-vs-optimistic-locking-특징>#</a></h4><table><thead><tr><th><strong>카테고리</strong></th><th><strong>Pessimistic Locking</strong></th><th><strong>Optimistic Locking</strong></th></tr></thead><tbody><tr><td><strong>접근 방식</strong></td><td>충돌을 <strong>사전에 방지</strong> (보수적 접근)</td><td>충돌을 <strong>사후에 감지</strong> (낙관적 접근)</td></tr><tr><td><strong>락 사용</strong></td><td><strong>락 지속 점유</strong> (트랜잭션 중 락 소유)</td><td><strong>락 없음</strong>, 대신 버전 번호 또는 타임스탬프 사용</td></tr><tr><td><strong>충돌 처리 방식</strong></td><td><strong>즉시 차단 및 대기</strong> (락이 걸리면 대기)</td><td><strong>커밋 시 충돌 검증</strong> 후 실패 시 <strong>롤백 + 재시도</strong></td></tr><tr><td><strong>동시성 제어</strong></td><td><strong>낮은 동시성</strong>, 읽기 - 쓰기 경쟁 시 병목 발생 가능</td><td><strong>높은 동시성</strong>, 병렬 처리 효율적</td></tr><tr><td><strong>성능 특성</strong></td><td>충돌 많을수록 안정적이나 <strong>락 오버헤드 존재</strong></td><td>충돌 적을수록 우수, <strong>충돌 발생 시 재시도 비용 증가</strong></td></tr><tr><td><strong>장애 대응 전략</strong></td><td><strong>Deadlock 감지/회피 필요</strong>, 타임아웃 설정 필요</td><td><strong>재시도 정책 및 백오프 로직 필요</strong>, 충돌 실패 처리 설계</td></tr><tr><td><strong>프로그래밍 복잡도</strong></td><td>상대적으로 <strong>단순한 구조</strong></td><td><strong>충돌 처리, 재시도, 버전 관리 로직 필요</strong></td></tr><tr><td><strong>적용 환경 예시</strong></td><td><strong>재고관리, 예약시스템, 금융거래 등 정합성 우선 환경</strong></td><td><strong>게시판 수정, 쇼핑몰 검색 등 비정합 허용 환경</strong></td></tr></tbody></table><ul><li><strong>접근 방식</strong>: 충돌 대응 시점의 차이. Pessimistic 은 사전 차단, Optimistic 은 사후 검증 중심으로 설계됨.</li><li><strong>락 사용</strong>: 락 지속 점유 여부가 전략을 가르는 핵심. Pessimistic 은 명시적 락, Optimistic 은 논리적 버전 기반.</li><li><strong>충돌 처리</strong>: 즉시 블로킹 vs. 충돌 발생 후 롤백 및 재시도 방식으로 처리 방식이 다름.</li><li><strong>동시성</strong>: 락 사용 유무에 따라 블로킹 발생 여부가 달라지고, 이는 동시성 수준에 큰 영향.</li><li><strong>성능</strong>: 환경에 따라 상반된 성능 특성. 충돌 빈도/경합 강도가 전략 선택에 핵심 기준.</li><li><strong>장애 대응</strong>: Pessimistic 은 Deadlock 대비, Optimistic 은 재시도/백오프 등의 보완 로직 필요.</li><li><strong>프로그래밍 난이도</strong>: Pessimistic 은 단순, Optimistic 은 로직 설계 복잡도가 있음.</li><li><strong>적용 사례</strong>: 강한 정합성 필요시 Pessimistic, 사용자 경험/속도 우선 환경은 Optimistic 이 적합.</li></ul><h3 id=핵심-원칙>핵심 원칙<a hidden class=anchor aria-hidden=true href=#핵심-원칙>#</a></h3><ul><li><strong>정합성 보장</strong>: 트랜잭션 충돌을 방지하거나 검출해 데이터 일관성을 확보</li><li><strong>충돌 대응 전략 필요</strong>: 사전 또는 사후 충돌을 처리하는 메커니즘이 반드시 존재해야 함</li><li><strong>시스템 성능과 정합성 사이의 균형 설계가 중요</strong></li></ul><h4 id=pessimistic-locking-원칙>Pessimistic Locking 원칙<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-원칙>#</a></h4><table><thead><tr><th>핵심 원칙</th><th>설명</th></tr></thead><tbody><tr><td><strong>Lock Ordering</strong></td><td>트랜잭션 간 락 획득 순서를 일관되게 유지해 데드락 방지</td></tr><tr><td><strong>Minimal Lock Time</strong></td><td>락 보유 시간 최소화로 병목 및 경합 완화</td></tr><tr><td><strong>Granularity Tuning</strong></td><td>테이블/행/컬럼 수준의 락 범위 최적화 필요</td></tr><tr><td><strong>Lock Timeout</strong></td><td>데드락 방지를 위한 타임아웃 설정 필수</td></tr><tr><td><strong>Consistency First</strong></td><td>병행성보다 데이터 정합성을 우선하는 설계 철학</td></tr></tbody></table><h4 id=optimistic-locking-원칙>Optimistic Locking 원칙<a hidden class=anchor aria-hidden=true href=#optimistic-locking-원칙>#</a></h4><table><thead><tr><th>핵심 원칙</th><th>설명</th></tr></thead><tbody><tr><td><strong>Version Field Update</strong></td><td>데이터 변경 시 버전 증가 또는 타임스탬프 갱신 필수</td></tr><tr><td><strong>Conflict Detection</strong></td><td>커밋 시 버전 비교로 충돌 감지</td></tr><tr><td><strong>Retry Strategy</strong></td><td>충돌 시 재시도 로직, 최대 시도 횟수 및 종료 조건 필요</td></tr><tr><td><strong>Backoff Mechanism</strong></td><td>재시도 간 간격을 늘리는 백오프 전략 (지수 백오프 등) 도입</td></tr><tr><td><strong>Concurrency First</strong></td><td>정합성보다 병행성과 처리량을 우선하는 설계 철학</td></tr></tbody></table><h4 id=핵심-원칙-비교>핵심 원칙 비교<a hidden class=anchor aria-hidden=true href=#핵심-원칙-비교>#</a></h4><table><thead><tr><th><strong>카테고리</strong></th><th><strong>Pessimistic Locking</strong></th><th><strong>Optimistic Locking</strong></th></tr></thead><tbody><tr><td><strong>충돌 대응 시점</strong></td><td>충돌 사전 차단</td><td>충돌 사후 검출</td></tr><tr><td><strong>락 정책</strong></td><td>명시적 락 획득 및 해제 필요, 순서 보장 필수</td><td>락 없음, 버전 기반 충돌 감지</td></tr><tr><td><strong>정합성 우선 원칙</strong></td><td>정합성 우선 (ACID, Serializable isolation)</td><td>병행성 우선 (높은 처리량, eventual consistency 수용 가능)</td></tr><tr><td><strong>자원 점유 시간</strong></td><td>가능한 최소화 필요 (Minimal Lock Duration)</td><td>점유 없음, 대신 재시도 및 백오프 전략 필요</td></tr><tr><td><strong>데드락 예방 전략</strong></td><td>락 순서 일관성, 타임아웃 설정</td><td>데드락 없음, 대신 충돌 재시도 비용 고려</td></tr><tr><td><strong>충돌 처리 방식</strong></td><td>트랜잭션 차단 (lock blocking)</td><td>커밋 시점에 버전 비교, 실패 시 롤백 및 재시도</td></tr><tr><td><strong>확장성 대응 전략</strong></td><td>락 병목 발생 가능, 고경합 상황 취약</td><td>분산 환경에서 뛰어난 확장성</td></tr></tbody></table><ul><li><strong>충돌 처리 시점</strong>: Pessimistic 은 사전 차단을 통해 안전성을 확보하고, Optimistic 은 사후 검출로 성능을 확보한다.</li><li><strong>락 관리</strong>: Pessimistic 은 락을 명시적으로 소유하고 해제하며, 락 순서와 유지 시간이 중요하다. 반면 Optimistic 은 락을 사용하지 않고 버전 필드를 활용한다.</li><li><strong>에러 대응 전략</strong>: Pessimistic 은 데드락을 피해야 하고, Optimistic 은 충돌 재시도에 대비한 정책을 마련해야 한다.</li><li><strong>설계 철학</strong>: Pessimistic 은 데이터 정합성을 절대적으로 우선하며, Optimistic 은 시스템 병행성과 성능을 우선시한다.</li><li><strong>확장성 및 성능</strong>: Pessimistic 은 고정밀 정합성 환경에 적합하고, Optimistic 은 사용자 수가 많은 웹 기반 시스템에 적합하다.</li></ul><h3 id=주요-원리-및-작동-방식>주요 원리 및 작동 방식<a hidden class=anchor aria-hidden=true href=#주요-원리-및-작동-방식>#</a></h3><ul><li>동시 접근 환경에서 <strong>데이터 정합성 및 충돌 제어</strong>를 구현<ul><li>Pessimistic: 충돌 차단</li><li>Optimistic: 충돌 감지 및 복구</li></ul></li></ul><pre class=mermaid>flowchart LR
  A[Pessimistic: Acquire → Operate → Release]
  B[Optimistic: Read → Operate → Validate → Commit/Rollback]
</pre><h4 id=작동-원리-및-방식>작동 원리 및 방식<a hidden class=anchor aria-hidden=true href=#작동-원리-및-방식>#</a></h4><table><thead><tr><th>방식</th><th>주요 원리</th><th>작동 흐름 요약</th></tr></thead><tbody><tr><td>Pessimistic Locking</td><td><strong>Two-Phase Locking</strong> 기반, Blocking 방식</td><td>Lock 획득 → 작업 수행 → Commit/Unlock</td></tr><tr><td>Optimistic Locking</td><td><strong>버전 기반 Validation</strong>, Non-blocking</td><td>작업 → 커밋 전 검증 (버전 비교) → 성공 or 재시도</td></tr></tbody></table><h5 id=pessimistic-locking-2>Pessimistic Locking<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-2>#</a></h5><pre class=mermaid>sequenceDiagram
    participant T1
    participant DB
    participant T2

    T1-&gt;&gt;DB: BEGIN
    T1-&gt;&gt;DB: SELECT ... FOR UPDATE (Acquire Lock)
    DB--&gt;&gt;T1: Lock Acquired
    T2-&gt;&gt;DB: SELECT ... FOR UPDATE (Block)
    T1-&gt;&gt;DB: UPDATE
    T1-&gt;&gt;DB: COMMIT (Release Lock)
    DB--&gt;&gt;T2: Lock Granted
</pre><ol><li><p><strong>락 획득 단계</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Shared Lock (읽기 락)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>SHARE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Exclusive Lock (쓰기 락)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>데이터 조작 단계</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>quantity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>quantity</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>락 해제 단계</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>COMMIT</span><span class=p>;</span><span class=w> </span><span class=c1>-- 또는 ROLLBACK
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h5 id=optimistic-locking-2>Optimistic Locking<a hidden class=anchor aria-hidden=true href=#optimistic-locking-2>#</a></h5><pre class=mermaid>sequenceDiagram
    participant T1
    participant DB
    participant T2

    T1-&gt;&gt;DB: SELECT data, version → v=1
    T2-&gt;&gt;DB: SELECT data, version → v=1
    T1-&gt;&gt;DB: UPDATE WHERE version=1 → Success, version=2
    T2-&gt;&gt;DB: UPDATE WHERE version=1 → Fail (version mismatch)
    T2-&gt;&gt;DB: Retry SELECT → v=2
    T2-&gt;&gt;DB: UPDATE WHERE version=2 → Success
</pre><ol><li><p><strong>초기 읽기 단계</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>quantity</span><span class=p>,</span><span class=w> </span><span class=k>version</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 결과: id=1, name=&#39;Product A&#39;, quantity=100, version=5
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>조건부 업데이트 단계</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>products</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>quantity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>99</span><span class=p>,</span><span class=w> </span><span class=k>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>version</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 영향받은 행 수를 확인하여 충돌 감지
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>충돌 처리 단계</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Pseudocode</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_product_optimistic</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>new_quantity</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 현재 데이터 조회</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span> <span class=o>=</span> <span class=n>select_product</span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 비즈니스 로직 수행</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>product</span><span class=o>.</span><span class=n>quantity</span> <span class=o>&gt;=</span> <span class=n>new_quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 3. 조건부 업데이트 시도</span>
</span></span><span class=line><span class=cl>            <span class=n>affected_rows</span> <span class=o>=</span> <span class=n>update_product_with_version</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>product_id</span><span class=p>,</span> <span class=n>new_quantity</span><span class=p>,</span> <span class=n>product</span><span class=o>.</span><span class=n>version</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>affected_rows</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=s2>&#34;Success&#34;</span>  <span class=c1># 성공</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>  <span class=c1># 충돌 발생, 재시도</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;Insufficient quantity&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;Max retries exceeded&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=pessimistic-vs-optimistic-locking-실전-구현-전략>Pessimistic vs. Optimistic Locking: 실전 구현 전략<a hidden class=anchor aria-hidden=true href=#pessimistic-vs-optimistic-locking-실전-구현-전략>#</a></h4><table><thead><tr><th>구분</th><th>Pessimistic Locking</th><th>Optimistic Locking</th></tr></thead><tbody><tr><td>트랜잭션 시작 시 동작</td><td>읽기 또는 쓰기 전에 즉시 락 획득</td><td>데이터 조회 시 별도 락 없음</td></tr><tr><td>충돌 처리 방식</td><td>락 보유를 통한 사전 차단</td><td>커밋 시점 버전 비교를 통한 사후 검출</td></tr><tr><td>트랜잭션 실패 시 처리</td><td>Deadlock 또는 타임아웃 오류 발생 가능</td><td>Version mismatch → 트랜잭션 실패 및 재시도</td></tr><tr><td>구현 기술/예시</td><td>DB 락 (SELECT FOR UPDATE), JPA <code>@Lock(LockModeType.PESSIMISTIC_WRITE)</code></td><td>JPA <code>@Version</code>, 수동 버전 필드 검증, CAS 방식 등</td></tr><tr><td>재시도 메커니즘</td><td>주로 자동 처리 불가, 비즈니스 로직에서 직접 예외 처리 필요</td><td>자동/수동 재시도 로직 구현 가능, 재시도 지수 백오프 등 적용 가능</td></tr><tr><td>유효한 시나리오</td><td>금융 트랜잭션, 재고 차감, 병렬 충돌 가능성 높은 시스템</td><td>게시판 수정, 장바구니 변경 등 경합이 드문 시나리오</td></tr></tbody></table><ul><li><strong>실전 구현 전략</strong>에서는 시스템의 특성 (읽기/쓰기 비율, 충돌 가능성 등) 에 따라 적절한 락 전략과 기술이 결정된다. 비관적 락은 안정성을, 낙관적 락은 성능과 확장성을 우선시한다.</li></ul><h3 id=구조-및-아키텍처>구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#구조-및-아키텍처>#</a></h3><h4 id=공통적인-구조역할>공통적인 구조·역할<a hidden class=anchor aria-hidden=true href=#공통적인-구조역할>#</a></h4><ul><li>두 방식 모두 <strong>트랜잭션 단위의 동시성 제어 구조</strong>를 갖추며, <strong>정합성 보장 목적</strong>을 공유.</li><li>다만 <strong>락 기반 관리 vs. 버전 기반 검증</strong>이라는 구조 차이 존재.</li></ul><h4 id=방식별-구조-및-비교>방식별 구조 및 비교<a hidden class=anchor aria-hidden=true href=#방식별-구조-및-비교>#</a></h4><h5 id=pessimistic-locking-3>Pessimistic Locking<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-3>#</a></h5><ul><li><strong>필수 요소</strong>: Lock Manager, Lock Table, Wait Queue</li><li><strong>선택 요소</strong>: Deadlock Detector, Lock Escalation 등</li><li><strong>작동 기반</strong>: DB 내부 Lock Manager, Two-Phase Locking Protocol 사용됨</li></ul><pre class=mermaid>graph TD
    subgraph DB Layer
        TM[Transaction Manager]
        LM[Lock Manager]
        LT[Lock Table]
        WQ[Wait Queue]
        DD[Deadlock Detector]
    end
    TM --&gt; LM
    LM --&gt; LT
    LM --&gt; WQ
    LM -. optional .-&gt; DD
    WQ --&gt; LM
</pre><h5 id=optimistic-locking-3>Optimistic Locking<a hidden class=anchor aria-hidden=true href=#optimistic-locking-3>#</a></h5><ul><li><strong>필수 요소</strong>: Version Control (버전 필드), Conflict Detection, Retry Mechanism</li><li><strong>선택 요소</strong>: Adaptive Retry Controller, Performance Monitor 등</li><li><strong>작동 기반</strong>: 주로 애플리케이션 레이어에서 동작하며 DB 검증 로직 포함</li></ul><pre class=mermaid>graph TD
    subgraph App Layer
        TX[Transaction Start]
        OP[&#34;Operation (no lock)&#34;]
        VD[Version Validate]
        RL[Retry Logic]
    end
    subgraph Data Layer
        DC[Conflict Detection Engine]
        VM[Version Control Store]
    end
    TX --&gt; OP
    OP --&gt; VD
    VD --&gt;|no conflict| DC
    DC --&gt;|validate| VM
    VD --&gt;|conflict| RL
    RL --&gt; TX
</pre><h4 id=구성-요소>구성 요소<a hidden class=anchor aria-hidden=true href=#구성-요소>#</a></h4><table><thead><tr><th>락 방식</th><th>구성 요소</th><th>설명</th><th>기능 역할</th><th>필수/선택</th></tr></thead><tbody><tr><td>Pessimistic</td><td>Lock Manager</td><td>트랜잭션 락 요청/해제 제어, 데드락 감지 포함</td><td>락 할당·관리의 핵심 엔진</td><td>필수</td></tr><tr><td></td><td>Lock Table</td><td>현재 락 상태, 소유자, 리소스 정보 저장</td><td>충돌 감지 및 락 상태 추적</td><td>필수</td></tr><tr><td></td><td>Wait Queue</td><td>락 요청 대기 트랜잭션을 순서대로 관리</td><td>공정성 유지, 대기 상태 관리</td><td>필수</td></tr><tr><td></td><td>Deadlock Detector</td><td>순환 대기 감지 알고리즘 실행</td><td>시스템 정지 방지</td><td>선택</td></tr><tr><td></td><td>Lock Escalation Manager</td><td>다수 row→table 락 자동 전환 제어</td><td>락 오버헤드 최적화</td><td>선택</td></tr><tr><td>Optimistic</td><td>Version Control</td><td>각 레코드의 버전 번호/타임스탬프 항목</td><td>충돌 검증 기준 제공</td><td>필수</td></tr><tr><td></td><td>Conflict Detection Engine</td><td>커밋 시점에 버전 비교하여 충돌 여부 결정</td><td>동시성 위반 감지</td><td>필수</td></tr><tr><td></td><td>Retry Mechanism</td><td>충돌 시 백오프 전략, 재시도 로직 수행</td><td>오류 복구 및 일관성 유지</td><td>필수</td></tr><tr><td></td><td>Performance Monitor</td><td>충돌 빈도, 재시도 패턴, 병목 상황 로깅</td><td>전략 최적화 및 동시성 분석 지원</td><td>선택</td></tr><tr><td></td><td>Adaptive Retry Controller</td><td>시스템 부하에 따라 재시도 정책 동적으로 조정</td><td>실시간 성능 대응</td><td>선택</td></tr></tbody></table><h3 id=구현-기법-및-방법>구현 기법 및 방법<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법>#</a></h3><ul><li><p>공통점:</p><ul><li>동시성 제어 목적</li><li>트랜잭션 충돌 방지/처리</li><li>고유한 충돌 감지 및 회피 메커니즘 존재</li></ul></li><li><p>차이점:</p><ul><li>락 시점과 방식 (사전 vs 사후)</li><li>충돌 발생 시 대응 방식 (대기 vs 재시도)</li><li>구현 위치 (DB, App Layer 등)</li></ul></li></ul><table><thead><tr><th>분류</th><th>정의</th><th>구성 요소</th><th>원리</th><th>목적</th><th>사용 상황</th><th>특징</th></tr></thead><tbody><tr><td>Database-Level Locking</td><td>DB 가 제공하는 네이티브 락 (예: SELECT FOR UPDATE)</td><td>DB 커넥션, 트랜잭션, 락 구문</td><td>트랜잭션 내 명시적 락 획득</td><td>강력한 일관성과 충돌 사전 방지</td><td>단일 DB 중심 트랜잭션</td><td>구현 단순, 일관성 높음, 동시성 낮음</td></tr><tr><td>Application-Level Locking</td><td>분산 시스템에서 Redis/ZK 등을 활용한 락 구현</td><td>분산 저장소 (Redis/ZK), TTL, 락 토큰</td><td>락 키를 원자적으로 설정/해제</td><td>분산 환경에서의 자원 충돌 방지</td><td>MSA, Redis 기반 시스템</td><td>구현 유연성 높음, 네트워크 지연 민감</td></tr><tr><td>Version-Based Locking</td><td>데이터 변경 시 버전 필드 비교를 통한 충돌 감지</td><td>버전 번호, 업데이트 조건, CAS 로직</td><td>읽기 → 수정 → 커밋 시점에 버전 비교</td><td>성능 최적화 및 병행성 확보</td><td>충돌 빈도 낮은 시스템</td><td>락 없음, 재시도 필요, 높은 동시성</td></tr><tr><td>Timestamp-Based Locking</td><td>마지막 수정 시간 기반 동시성 제어</td><td>타임스탬프 필드, 클라이언트/서버 간 시간 동기화</td><td>수정 시간 일치 여부로 충돌 여부 판단</td><td>복잡한 버전 관리 피하고 단순한 검증</td><td>클럭 동기화 가능한 환경, 이벤트 기반 시스템</td><td>설정 단순, 클럭 불일치 시 오류 발생 가능성 있음</td></tr></tbody></table><ul><li><p><strong>Database-Level Locking</strong>은 가장 고전적이고 안정적인 방식으로 강한 일관성을 보장하나, 동시성은 낮음. 주로 OLTP 시스템에서 사용.</p></li><li><p><strong>Application-Level Locking</strong>은 분산 환경에서 자원을 보호할 때 유용하며, Redis/Zookeeper 등 외부 도구 필요.</p></li><li><p><strong>Version-Based Locking</strong>은 높은 동시성을 제공하지만 충돌 발생 시 재시도가 필요하므로, 충돌이 빈번한 환경에는 부적절.</p></li><li><p><strong>Timestamp-Based Locking</strong>은 구현이 단순하지만 시간 동기화 문제가 존재하며, IoT/이벤트 시스템에 적합.</p></li></ul><h4 id=database-level-locking>Database-Level Locking<a hidden class=anchor aria-hidden=true href=#database-level-locking>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- PostgreSQL 예시
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>inventory</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>inventory</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>quantity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>quantity</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=application-level-locking-python-redis>Application-Level Locking (Python, Redis)<a hidden class=anchor aria-hidden=true href=#application-level-locking-python-redis>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span><span class=lnt id=hl-13-17><a class=lnlinks href=#hl-13-17>17</a>
</span><span class=lnt id=hl-13-18><a class=lnlinks href=#hl-13-18>18</a>
</span><span class=lnt id=hl-13-19><a class=lnlinks href=#hl-13-19>19</a>
</span><span class=lnt id=hl-13-20><a class=lnlinks href=#hl-13-20>20</a>
</span><span class=lnt id=hl-13-21><a class=lnlinks href=#hl-13-21>21</a>
</span><span class=lnt id=hl-13-22><a class=lnlinks href=#hl-13-22>22</a>
</span><span class=lnt id=hl-13-23><a class=lnlinks href=#hl-13-23>23</a>
</span><span class=lnt id=hl-13-24><a class=lnlinks href=#hl-13-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RedisLock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>expire</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>key</span> <span class=o>=</span> <span class=n>key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>expire</span> <span class=o>=</span> <span class=n>expire</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>key</span><span class=p>,</span> <span class=s2>&#34;lock&#34;</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>expire</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>RedisLock</span><span class=p>(</span><span class=n>redis</span><span class=o>.</span><span class=n>StrictRedis</span><span class=p>(),</span> <span class=s2>&#34;resource:lock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 작업 수행</span>
</span></span><span class=line><span class=cl>    <span class=err>…</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=version-based-locking-nodejs--postgresql>Version-Based Locking (Node.js + PostgreSQL)<a hidden class=anchor aria-hidden=true href=#version-based-locking-nodejs--postgresql>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>updateWithVersion</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>newName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s1>&#39;SELECT name, version FROM items WHERE id = $1&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>id</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>version</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>rows</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>updated</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>        UPDATE items SET name = $1, version = $2 WHERE id = $3 AND version = $4
</span></span></span><span class=line><span class=cl><span class=sb>    `</span><span class=p>,</span> <span class=p>[</span><span class=nx>newName</span><span class=p>,</span> <span class=nx>version</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>version</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>updated</span><span class=p>.</span><span class=nx>rowCount</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s2>&#34;Version conflict detected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=timestamp-based-locking-python--sqlalchemy>Timestamp-Based Locking (Python + SQLAlchemy)<a hidden class=anchor aria-hidden=true href=#timestamp-based-locking-python--sqlalchemy>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a class=lnlinks href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a class=lnlinks href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a class=lnlinks href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a class=lnlinks href=#hl-15-15>15</a>
</span><span class=lnt id=hl-15-16><a class=lnlinks href=#hl-15-16>16</a>
</span><span class=lnt id=hl-15-17><a class=lnlinks href=#hl-15-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_with_timestamp</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>item_id</span><span class=p>,</span> <span class=n>new_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>entity</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>model</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>item_id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>original_ts</span> <span class=o>=</span> <span class=n>entity</span><span class=o>.</span><span class=n>updated_at</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>new_data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>entity</span><span class=o>.</span><span class=n>updated_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>updated</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>model</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>item_id</span><span class=p>,</span> <span class=n>updated_at</span><span class=o>=</span><span class=n>original_ts</span><span class=p>)</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>new_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>updated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Timestamp conflict detected&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=pessimistic-vs-optimistic-locking-비교>Pessimistic vs. Optimistic Locking 비교<a hidden class=anchor aria-hidden=true href=#pessimistic-vs-optimistic-locking-비교>#</a></h3><p><strong>비관적 락</strong>은 락을 통한 선제 보호에 무게, <strong>낙관적 락</strong>은 병행성과 성능에 무게를 둔다.<br>데이터 충돌 가능성 예측과 도메인 특성을 토대로 선택·조합.</p><table><thead><tr><th>비교 항목</th><th>비관적 락 (Pessimistic Locking)</th><th>낙관적 락 (Optimistic Locking)</th></tr></thead><tbody><tr><td>데이터 락 획득 시점</td><td>작업 전락 선점</td><td>작업 완료 (커밋 직전) 충돌 검사</td></tr><tr><td>성능 (Throughput)</td><td>병행성 낮음, Lock 대기 시간 발생</td><td>병행성 높음, 재시도 비용 발생</td></tr><tr><td>충돌 대처</td><td>충돌 발생 전 차단</td><td>충돌 발생시 롤백 후 재시도</td></tr><tr><td>구현 복잡성</td><td>상대적으로 단순, 관리 필요</td><td>충돌 처리 및 버전 관리 필요</td></tr><tr><td>Deadlock(교착상태) 위험</td><td>있음</td><td>없음</td></tr><tr><td>활용 적합 환경</td><td>트랜잭션 충돌 빈번, 데이터 무결성이 중요한 곳</td><td>읽기 많고, 충돌 적은 곳, 대규모 분산 시스템</td></tr></tbody></table><h3 id=공통점과-차이점>공통점과 차이점<a hidden class=anchor aria-hidden=true href=#공통점과-차이점>#</a></h3><ul><li><p><strong>공통점:</strong> 두 방식 모두 데이터 정합성과 동시성 제어를 목적으로 하며, 트랜잭션 기반 시스템에서 충돌을 방지하거나 감지하는 구조이다.</p></li><li><p><strong>차이점:</strong></p><ul><li>Pessimistic 은 <strong>선점 기반의 충돌 회피</strong>로 강한 일관성과 예측 가능한 동작을 제공하지만, 락 경합과 데드락 관리 이슈가 있다.</li><li>Optimistic 은 <strong>후처리 기반 충돌 감지</strong>로 처리량과 확장성은 뛰어나지만, 충돌 복구 로직과 재시도 정책이 중요하다.</li></ul></li><li><p><strong>적용 가이드라인:</strong></p><ul><li>충돌이 자주 발생하고 결과가 치명적인 경우에는 <strong>Pessimistic Locking</strong>.</li><li>충돌 빈도가 낮고 고성능을 요구하는 경우에는 <strong>Optimistic Locking</strong>이 적합하다.</li></ul></li></ul><h4 id=목적-및-적용-대상>목적 및 적용 대상<a hidden class=anchor aria-hidden=true href=#목적-및-적용-대상>#</a></h4><table><thead><tr><th>항목</th><th>공통점</th><th>차이점</th></tr></thead><tbody><tr><td>적용 목적</td><td>데이터 정합성 유지, 동시성 제어</td><td>Pessimistic: 충돌 사전 차단 Optimistic: 충돌 발생 시 감지 및 처리</td></tr><tr><td>적용 환경</td><td>DB, ORM, Application 모두에서 구현 가능</td><td>Pessimistic: 충돌 빈도 높은 환경 Optimistic: 충돌이 드문 환경에 적합</td></tr><tr><td>트랜잭션 성격</td><td>ACID 보장</td><td>Pessimistic: Isolation 우선 Optimistic: Consistency/Availability 우선</td></tr></tbody></table><p>두 방식 모두 데이터 무결성과 동시성 보장을 목적으로 하지만, Pessimistic 은 " 충돌 회피 " 에, Optimistic 은 " 성능 최적화와 사후 회복 " 에 초점이 맞춰져 있음.</p><h4 id=동작-원리-및-트랜잭션-처리>동작 원리 및 트랜잭션 처리<a hidden class=anchor aria-hidden=true href=#동작-원리-및-트랜잭션-처리>#</a></h4><table><thead><tr><th>항목</th><th>공통점</th><th>차이점</th></tr></thead><tbody><tr><td>동작 구조</td><td>트랜잭션 단위로 충돌 방지 또는 감지 처리 수행</td><td>Pessimistic: 작업 전 락 선점 → 수행 → 커밋<br>Optimistic: 수행 → 커밋 시점에 충돌 감지 및 롤백</td></tr><tr><td>Isolation 수준</td><td>기본적으로 ACID 트랜잭션 모델 지원</td><td>Pessimistic: 높은 격리 수준 가능<br>Optimistic: 낮은 격리 수준에서도 활용 가능</td></tr><tr><td>롤백 처리</td><td>충돌 발생 시 트랜잭션 롤백 처리 가능</td><td>Pessimistic: 거의 발생하지 않음<br>Optimistic: 자주 발생 가능 (재시도 포함)</td></tr></tbody></table><p>Pessimistic 은 사전 락 확보로 충돌 가능성을 원천 차단하는 반면, Optimistic 은 커밋 단계의 충돌 감지를 통해 처리량을 높이고 유연한 트랜잭션 구성을 가능하게 한다.</p><h4 id=구현-복잡성-및-예외-처리>구현 복잡성 및 예외 처리<a hidden class=anchor aria-hidden=true href=#구현-복잡성-및-예외-처리>#</a></h4><table><thead><tr><th>항목</th><th>공통점</th><th>차이점</th></tr></thead><tbody><tr><td>예외 처리</td><td>충돌/타임아웃/무결성 위반 등 예외 상황 대비 필요</td><td>Pessimistic: 데드락, 락 타임아웃<br>Optimistic: 버전 불일치 예외 및 재시도 처리 필요</td></tr><tr><td>구현 난이도</td><td>애플리케이션 또는 DB 설정 필요</td><td>Pessimistic: 락 관리 로직 복잡<br>Optimistic: 버전 관리 및 충돌 복구 로직 필요</td></tr><tr><td>장애 대응</td><td>충돌 또는 병목 발생 시 복구 전략 필요</td><td>Pessimistic: 병목 발생시 처리량 급감 가능<br>Optimistic: 충돌 빈도 증가 시 무한 재시도 위험</td></tr></tbody></table><p>Optimistic 은 구현이 유연하지만 충돌 복구 로직이 필요하며, Pessimistic 은 안정적이나 데드락 예방 및 락 해제 정책 관리가 핵심 과제가 된다.</p><h4 id=성능-및-확장성-관점>성능 및 확장성 관점<a hidden class=anchor aria-hidden=true href=#성능-및-확장성-관점>#</a></h4><table><thead><tr><th>항목</th><th>공통점</th><th>차이점</th></tr></thead><tbody><tr><td>성능 병목 가능성</td><td>동시성 제어 실패 시 전체 처리량 저하 유발 가능</td><td>Pessimistic: 락 경쟁으로 병목 발생 Optimistic: 재시도 비용 증가 가능</td></tr><tr><td>확장성</td><td>적절히 구성되면 스케일 아웃 가능한 구조</td><td>Optimistic 은 비블로킹 구조로 확장성 우수 Pessimistic 은 락 서버 병목 위험</td></tr><tr><td>분산 환경 대응</td><td>동시성 보장 메커니즘 요구</td><td>Pessimistic: 락 관리자 필요 (ZK, etcd)Optimistic: 버전 기반 처리로 네트워크 지연 내성 우수</td></tr></tbody></table><h3 id=장점과-단점>장점과 단점<a hidden class=anchor aria-hidden=true href=#장점과-단점>#</a></h3><ul><li>Pessimistic Locking 은 강력한 데이터 정합성과 충돌 회피가 강점이며, 데이터 중심 트랜잭션에 적합하다. 그러나 성능 저하와 데드락 리스크, 확장성 한계가 단점이다.</li><li>Optimistic Locking 은 충돌 가능성이 낮고 병렬성 높은 환경에 유리하며, 웹 API 나 분산 시스템에서 적합하다. 다만, 충돌 발생 시 높은 재시도 비용과 복잡한 오류 처리가 필요하다.</li><li>실무에서는 사용 환경, 충돌 빈도, DB/프레임워크 지원 등을 고려하여 두 접근법을 선택하거나 혼용하는 것이 효과적이다.</li></ul><h4 id=공통-장점>공통 장점<a hidden class=anchor aria-hidden=true href=#공통-장점>#</a></h4><ul><li>데이터 무결성을 보장하고 트랜잭션 충돌 방지 혹은 감지 능력을 제공함</li><li>환경에 따라 선택적으로 도입하여 트랜잭션 오류를 줄일 수 있음</li></ul><h4 id=pessimistic-locking-4>Pessimistic Locking<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-4>#</a></h4><ul><li>장점: 충돌을 사전 방지하여 정합성 보장, 구현 단순, 예측 가능한 동작</li><li>단점: 데드락 위험, 커넥션 점유, 확장성 낮음</li></ul><h4 id=optimistic-locking-4>Optimistic Locking<a hidden class=anchor aria-hidden=true href=#optimistic-locking-4>#</a></h4><ul><li>장점: 락 비용 없음, HTTP 및 분산 환경에 적합, 병행성 우수</li><li>단점: 충돌 시 재시도 비용 증가, 복잡한 오류 처리, 충돌 감지 시점 지연</li></ul><h4 id=카테고리별-비교>카테고리별 비교<a hidden class=anchor aria-hidden=true href=#카테고리별-비교>#</a></h4><h5 id=데이터-정합성>데이터 정합성<a hidden class=anchor aria-hidden=true href=#데이터-정합성>#</a></h5><table><thead><tr><th>항목</th><th>Pessimistic Locking</th><th>Optimistic Locking</th></tr></thead><tbody><tr><td>보장 수준</td><td>실시간 강력한 정합성 보장</td><td>결과적 정합성 보장 (커밋 시점까지 미확정)</td></tr><tr><td>오류 감지</td><td>충돌 발생 전에 차단</td><td>커밋 시점에만 감지</td></tr><tr><td>상태 관리</td><td>트랜잭션 상태 지속 필요</td><td>Stateless 구조 가능</td></tr></tbody></table><h5 id=성능-및-확장성>성능 및 확장성<a hidden class=anchor aria-hidden=true href=#성능-및-확장성>#</a></h5><table><thead><tr><th>항목</th><th>Pessimistic Locking</th><th>Optimistic Locking</th></tr></thead><tbody><tr><td>성능</td><td>락 처리로 오버헤드 존재</td><td>락 없음으로 처리 속도 우수 (충돌 적을 시)</td></tr><tr><td>확장성</td><td>낮음, 락으로 인해 병목 발생 가능</td><td>높음, 병렬 처리 유리</td></tr><tr><td>커넥션</td><td>연결 유지 필요 (DB 세션 지속)</td><td>비연결 환경에 적합 (웹 API 등)</td></tr></tbody></table><h5 id=충돌-및-오류-처리>충돌 및 오류 처리<a hidden class=anchor aria-hidden=true href=#충돌-및-오류-처리>#</a></h5><table><thead><tr><th>항목</th><th>Pessimistic Locking</th><th>Optimistic Locking</th></tr></thead><tbody><tr><td>충돌 처리</td><td>충돌 자체가 거의 발생하지 않음</td><td>충돌 감지 후 전체 작업 재시도 필요</td></tr><tr><td>재시도 비용</td><td>낮음</td><td>높음 (전체 트랜잭션 롤백 및 재시작)</td></tr><tr><td>복잡도</td><td>단순 (DB 기능으로 구현 가능)</td><td>충돌 감지 로직, 버전 관리 필요</td></tr></tbody></table><h5 id=환경-적합성>환경 적합성<a hidden class=anchor aria-hidden=true href=#환경-적합성>#</a></h5><table><thead><tr><th>항목</th><th>Pessimistic Locking</th><th>Optimistic Locking</th></tr></thead><tbody><tr><td>웹/HTTP</td><td>부적합 (상태 지속 필요)</td><td>적합 (Stateless 구조 적합)</td></tr><tr><td>분산 시스템</td><td>동기 락 확장성 낮음</td><td>분산 환경에 적합, 스케일 아웃 용이</td></tr><tr><td>클라우드</td><td>락 서버 병목 및 장애 위험 있음</td><td>서버리스, 클라우드에 적합</td></tr></tbody></table><h3 id=도전-과제>도전 과제<a hidden class=anchor aria-hidden=true href=#도전-과제>#</a></h3><h4 id=공통-도전-과제>공통 도전 과제<a hidden class=anchor aria-hidden=true href=#공통-도전-과제>#</a></h4><table><thead><tr><th>도전 과제</th><th>원인</th><th>영향</th><th>대응 전략 및 해결 방법</th></tr></thead><tbody><tr><td>성능 병목</td><td>락 경합, 트랜잭션 길이</td><td>응답 지연, 처리량 저하</td><td>트랜잭션 분리, 락 세분화, 캐시 활용</td></tr><tr><td>확장성 한계</td><td>단일 노드 의존, 수직 확장 한계</td><td>사용자 증가 시 성능 저하</td><td>수평 확장, 마이크로서비스, 샤딩</td></tr><tr><td>오류 복잡성</td><td>동시성 예외, 예측 불가한 경합</td><td>사용성 저하, 롤백 증가</td><td>예외 전파 설계, 사용자 메시지 보완</td></tr><tr><td>스레드 풀 고갈</td><td>락 대기 중 스레드 블로킹</td><td>스레드 자원 부족, 시스템 정지 위험</td><td>비동기 처리, 워커 수 튜닝</td></tr><tr><td>분산 트랜잭션 통합 어려움</td><td>락과 분산 트랜잭션 (SAGA/2PC) 병행 시 복잡성</td><td>장애 복구 및 충돌 처리 어려움</td><td>트랜잭션 경계 최소화, 보상 트랜잭션 설계</td></tr></tbody></table><p>락 전략과 무관하게 발생할 수 있는 시스템/운영 이슈로서, 확장성, 자원 한계, 복잡한 예외 흐름 등을 다룬다. 특히 멀티노드 환경에서는 스레드 풀 고갈, 트랜잭션 경계 불명확성으로 인해 예기치 않은 병목이 발생할 수 있다.</p><h4 id=pessimistic-locking-특화-도전-과제>Pessimistic Locking 특화 도전 과제<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-특화-도전-과제>#</a></h4><table><thead><tr><th>도전 과제</th><th>원인</th><th>영향</th><th>대응 전략 및 해결 방법</th></tr></thead><tbody><tr><td>데드락</td><td>락 순서 충돌, 교착 상태 발생</td><td>트랜잭션 정지, 성능 저하</td><td>락 획득 순서 정형화, 타임아웃 설정, 감지 도구 도입</td></tr><tr><td>락 타임아웃</td><td>긴 락 대기, 부하 집중</td><td>트랜잭션 실패, 오류 발생</td><td>트랜잭션 시간 제한, 처리 분리</td></tr><tr><td>락 에스컬레이션</td><td>다량의 행 락이 테이블 락으로 확대</td><td>동시성 급감, 전체 시스템 지연</td><td>배치 분할, 인덱스 최적화</td></tr><tr><td>락 해제 누락</td><td>예외 처리 누락, 명시적 해제 실패</td><td>리소스 장기 점유, 서비스 장애</td><td><code>try-finally</code> 구조, 자동 해제 도입</td></tr></tbody></table><p><code>락의 존재 자체가 시스템 리스크</code> 로 작용하는 상황에 초점을 맞춘다. 데드락이나 타임아웃, 락 점유 누락은 실시간 서비스에서 치명적인 영향을 미치며, 락 정책의 정교함이 요구된다.</p><h4 id=optimistic-locking-특화-도전-과제>Optimistic Locking 특화 도전 과제<a hidden class=anchor aria-hidden=true href=#optimistic-locking-특화-도전-과제>#</a></h4><table><thead><tr><th>도전 과제</th><th>원인</th><th>영향</th><th>대응 전략 및 해결 방법</th></tr></thead><tbody><tr><td>재시도 스톰</td><td>충돌 다발 시 재시도 폭발</td><td>부하 집중, 처리량 감소</td><td>지수 백오프, 최대 재시도 제한</td></tr><tr><td>버전 불일치</td><td>분산 노드 간 버전 불균형</td><td>데이터 불일치, 충돌</td><td>글로벌 버전 관리, CQRS</td></tr><tr><td>ABA 문제</td><td>값 변경 후 동일 값 복원 상황</td><td>변경 탐지 실패, 무결성 오류</td><td>체크섬/버전 해시, 단조 증가 번호 사용</td></tr><tr><td>세밀한 버전 추적 어려움</td><td>필드 수준 변경 탐지 어려움</td><td>false conflict, 충돌 오탐</td><td>변경 이력 관리, 필드별 검증 로직 설계</td></tr></tbody></table><p><code>충돌 감지 및 재시도 처리</code> 에 초점을 둔다. 충돌 빈도에 따라 재시도 폭발 (Replay Storm), 논리적 충돌 미감지 (ABA), 불필요한 충돌 감지 (False Conflict) 등이 발생하며, 이를 해결하기 위해 충돌 완화 설계와 히스토리 기반의 정합성 검증이 요구된다.</p><h3 id=실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h3><h4 id=공통-고려사항>공통 고려사항<a hidden class=anchor aria-hidden=true href=#공통-고려사항>#</a></h4><ul><li><strong>충돌 가능성 및 트래픽 패턴 분석</strong> 필요</li><li><strong>모니터링과 지표 수집, 실시간 알림 연동</strong> 필수</li><li><strong>테스트 환경에서의 사전 검증 및 시나리오 테스트</strong> 수행</li><li><strong>성능/안정성/비즈니스 중요도</strong>를 고려한 전략적 선택 요구</li></ul><h4 id=비교>비교<a hidden class=anchor aria-hidden=true href=#비교>#</a></h4><table><thead><tr><th>카테고리</th><th>고려사항</th><th>Pessimistic Locking</th><th>Optimistic Locking</th><th>권장 사항 요약</th></tr></thead><tbody><tr><td>트랜잭션 지속 시간</td><td>락 보유 시간</td><td>짧게 유지하여 데드락 및 병목 방지</td><td>상대적으로 유연함, 충돌 시 재시도 필요</td><td>비즈니스 로직은 트랜잭션 외부로 이동</td></tr><tr><td>데드락 예방 전략</td><td>락 순서, 타임아웃</td><td>자원 획득 순서 보장 및 타임아웃 필수</td><td>해당 없음</td><td>자원 ID 기준 정렬된 획득 순서 사용</td></tr><tr><td>타임아웃 및 오류 처리</td><td>실패 복구 로직</td><td>타임아웃 시 즉시 실패 또는 빠른 재시도 적용</td><td>충돌 시 재시도 백오프 전략 필요</td><td>공통적으로 재시도 횟수 제한, 사용자 친화적 오류 메시지 필요</td></tr><tr><td>트래픽 충돌 빈도</td><td>동시성 처리</td><td>충돌 빈도 높을수록 효과적</td><td>충돌 적은 환경에서 유리</td><td>사전 로그 분석 및 통계 기반 충돌 예측 후 선택</td></tr><tr><td>성능 요구사항</td><td>응답 시간/속도</td><td>짧은 응답 보장 어려움, 강한 일관성 중심</td><td>빠른 응답 가능, 결과적 일관성에 가까움</td><td>성능 민감 시스템은 Optimistic 우선 고려</td></tr><tr><td>기술 지원 및 DB 호환성</td><td>락/버전 지원 여부</td><td>대부분의 DB 에서 FOR UPDATE 지원</td><td>버전 필드 필수, ORM 에서 지원 여부 확인</td><td>ORM 환경에선 Optimistic, SQL 직접 사용 가능 시엔 Pessimistic 적용 용이</td></tr><tr><td>시스템 환경 특성</td><td>클라우드, MSA 환경</td><td>락 집중 시 병목 우려, 노드 간 일관성 보장 어려움</td><td>분산 환경 적합, 스케일 아웃 구조에 유리</td><td>분산 시스템 및 MSA 에서는 Optimistic 선호</td></tr><tr><td>운영 모니터링 및 테스트 전략</td><td>충돌/락 추적, 부하 테스트</td><td>락 대기 시간, 데드락 모니터링 필요</td><td>충돌 재시도 로그 및 패턴 수집</td><td>충돌 패턴, 락 대기시간, 성능 지표 수집 → 경고 및 대시보드 통합 필요</td></tr></tbody></table><ul><li><p><strong>Pessimistic Locking</strong>은 충돌 방지에 효과적이나, 락 보유 시간이 길고 데드락에 취약하며 응답 지연이 있을 수 있다. 락 순서를 명확히 정의하고 타임아웃 및 빠른 실패 처리를 설계해야 한다.</p></li><li><p><strong>Optimistic Locking</strong>은 높은 동시성과 낮은 락 비용을 제공하지만, 충돌 발생 시 재시도 로직과 백오프 전략이 필수이다. 트래픽이 많거나 클라우드 분산 환경에서 적합하다.</p></li><li><p><strong>공통적으로</strong> 성능 지표, 충돌 로그, 트랜잭션 모니터링을 기반으로 사전 테스트 및 실시간 추적 체계를 갖추는 것이 중요하다.</p></li></ul><h4 id=실무-도입-가이드>실무 도입 가이드<a hidden class=anchor aria-hidden=true href=#실무-도입-가이드>#</a></h4><h5 id=도입-절차>도입 절차<a hidden class=anchor aria-hidden=true href=#도입-절차>#</a></h5><ol><li><strong>트랜잭션 경합 분석</strong><ul><li>주요 테이블/기능의 쓰기 충돌 빈도, 동시성 수준 측정</li></ul></li><li><strong>전략 선택</strong><ul><li>충돌 빈도 높음: Pessimistic</li><li>충돌 빈도 낮음: Optimistic</li></ul></li><li><strong>프레임워크 지원 여부 확인</strong><ul><li>ORM, DBMS 기능 확인 (e.g., JPA, Sequelize, SQLAlchemy)</li></ul></li><li><strong>락 정책 구현</strong><ul><li>버전 관리, with_for_update 등 적용</li></ul></li><li><strong>테스트 및 롤백 전략 수립</strong><ul><li>낙관적 충돌 검출 및 재시도 전략 포함</li></ul></li></ol><h5 id=적용-체크리스트>적용 체크리스트<a hidden class=anchor aria-hidden=true href=#적용-체크리스트>#</a></h5><table><thead><tr><th>항목</th><th>설명</th><th>확인 여부</th></tr></thead><tbody><tr><td>트랜잭션 시간 최소화</td><td>락 지속 시간 단축 필수</td><td>✅</td></tr><tr><td>충돌 검출 후 재시도 정책</td><td>백오프 및 횟수 제한 포함</td><td>✅</td></tr><tr><td>재시도 불가 시 fallback</td><td>대체 로직 존재 여부</td><td>✅</td></tr><tr><td>롤백 감지</td><td>예외 발생 시 트랜잭션 롤백 처리</td><td>✅</td></tr><tr><td>관찰 및 경고</td><td>락 대기/충돌 경고 모니터링</td><td>✅</td></tr></tbody></table><h4 id=실무-검증운영-팁>실무 검증/운영 팁<a hidden class=anchor aria-hidden=true href=#실무-검증운영-팁>#</a></h4><ul><li><strong>공통</strong>:<ul><li>스트레스 테스트 (동시성 테스트), 실제 사용자 트래픽 패턴 반영해 검증</li><li>시스템 모니터링 도구 (예: Prometheus, Grafana) 와 연계</li></ul></li><li><strong>비관적 락</strong>:<ul><li>트랜잭션/쿼리 로그를 통해 락 대기, Deadlock, Timeout 빈도 모니터링</li><li>DBMS Lock Table 상태 주기적 점검, 락 그레뉼러리티 (행/테이블 등) 조정</li></ul></li><li><strong>낙관적 락</strong>:<ul><li>충돌률, 롤백률, 재시도 성공률 등 메트릭 수집</li><li>Version 관리 및 재시도 정책 (Backoff, 최대 재시도 횟수) 주기적 조정</li></ul></li></ul><h4 id=락-전략의-테스트-및-검증-방법>락 전략의 테스트 및 검증 방법<a hidden class=anchor aria-hidden=true href=#락-전략의-테스트-및-검증-방법>#</a></h4><h5 id=비관적-락-pessimistic-locking>비관적 락 (Pessimistic Locking)<a hidden class=anchor aria-hidden=true href=#비관적-락-pessimistic-locking>#</a></h5><ul><li><strong>테스트 포인트</strong><ul><li>동시성 충돌 발생 시 트랜잭션이 적절히 대기하거나 차단되는지 확인</li><li>데드락 (Deadlock) 발생 상황 시 시스템이 자동 감지 및 회복되는지 검증</li></ul></li><li><strong>검증 시나리오</strong><ul><li>두 개 이상의 클라이언트가 동일 데이터를 동시에 쓰기 시도 → 한쪽만 성공, 다른 쪽은 대기 또는 실패</li><li>트랜잭션이 오래 대기하면 타임아웃 후 적절히 롤백되는지 확인</li></ul></li><li><strong>테스트 예시 (Python, SQLite 사용)</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sqlite3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_pessimistic</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;test.db&#39;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>isolation_level</span><span class=o>=</span><span class=s1>&#39;EXCLUSIVE&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;BEGIN EXCLUSIVE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 테스트를 위해 긴 시간 작업 시뮬레이션</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE products SET stock = stock - 1 WHERE id = 1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Lock Error:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>설명: 두 명 이상이 동시에 실행하면 한 쪽만 진입, 나머지는 타임아웃 혹은 대기.</p><h5 id=낙관적-락-optimistic-locking>낙관적 락 (Optimistic Locking)<a hidden class=anchor aria-hidden=true href=#낙관적-락-optimistic-locking>#</a></h5><ul><li><strong>테스트 포인트</strong><ul><li>동시 커밋 시 버전 불일치 (충돌) 가 감지되고, 트랜잭션이 적절히 롤백 및 재시도 되는지 확인</li><li>재시도 정책 및 알림 로직 정상 동작 확인</li></ul></li><li><strong>검증 시나리오</strong><ul><li>실제 버전 정보를 변경하지 않고 여러 쓰기 트랜잭션 동시 실행 → 일부만 업데이트, 나머지 롤백/재시도</li><li>빈번한 충돌 환경에서 성능 및 충돌 발생률 관찰</li></ul></li><li><strong>테스트 예시 (Python, SQLAlchemy)</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_optimistic</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>order_qty</span><span class=p>,</span> <span class=n>cur_version</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>product</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>product_id</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=n>cur_version</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>product</span> <span class=ow>and</span> <span class=n>product</span><span class=o>.</span><span class=n>stock</span> <span class=o>&gt;=</span> <span class=n>order_qty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>stock</span> <span class=o>-=</span> <span class=n>order_qty</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>  <span class=c1># 버전 충돌 발생 시 롤백</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p>설명: 데이터베이스 테이블에 version 필드 필수. 버전이 다르면 commit 실패 (충돌).</p><h4 id=트랜잭션-격리-수준과의-연계-분석>트랜잭션 격리 수준과의 연계 분석<a hidden class=anchor aria-hidden=true href=#트랜잭션-격리-수준과의-연계-분석>#</a></h4><table><thead><tr><th>트랜잭션 격리 수준</th><th>동작 방식 및 락킹 전략 연계</th><th>Pessimistic 과 Optimistic 연계 분석</th></tr></thead><tbody><tr><td>Read Uncommitted</td><td>커밋되지 않은 변경 읽기 허용 (Dirty Read)</td><td>일반적으로 Locking 불필요 (둘 다 위험)</td></tr><tr><td>Read Committed</td><td>커밋된 데이터만 읽기 허용, 읽을 때 공유락 (S-lock) 사용</td><td>Pessimistic → SELECT FOR UPDATE<br>Optimistic → 가능하나 낮은 보장</td></tr><tr><td>Repeatable Read</td><td>동일 트랜잭션 내 동일 쿼리 결과 일관 보장, Phantom Read 는 차단 안 됨</td><td>Pessimistic → S-lock 지속<br>Optimistic → 버전 충돌 가능 대비 필요</td></tr><tr><td>Serializable</td><td>가장 강력한 격리, 트랜잭션 직렬화 수준으로 처리</td><td>Pessimistic → 거의 완벽하게 일관성 유지<br>Optimistic → 재시도 빈번</td></tr></tbody></table><ul><li><strong>트랜잭션 격리 수준</strong>은 Pessimistic Locking 과 더 밀접하게 연동되며, 높은 격리 수준일수록 낙관적 락의 재시도 및 충돌 가능성이 높아진다. 반면 비관적 락은 트랜잭션 격리 수준의 효과를 보강하거나 대체하는 역할도 가능하다.</li></ul><h3 id=최적화하기-위한-고려사항-및-주의할-점>최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#최적화하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>카테고리</th><th>고려 항목</th><th>Pessimistic Locking</th><th>Optimistic Locking</th><th>공통 권장사항 및 주의점</th></tr></thead><tbody><tr><td><strong>1. Lock 범위 최적화</strong></td><td>Granularity, 에스컬레이션</td><td>행 락 사용, 자동 승격 조정</td><td>필드 기반 버전 관리</td><td>필요 최소 범위로 제어, 설정 임계 검토</td></tr><tr><td><strong>2. 트랜잭션 최적화</strong></td><td>트랜잭션 시간, 커밋 빈도</td><td>짧은 트랜잭션 유지, 커밋 전 자원 해제</td><td>커밋 시 충돌 검증 최적화</td><td>트랜잭션 최소화, 병렬성/정합성 균형</td></tr><tr><td><strong>3. 재시도/백오프 전략</strong></td><td>충돌 복구, 반복 요청 제한</td><td>락 충돌 시 대기 큐 활용</td><td>Exponential Backoff, 재시도 제한 설정</td><td>반복 재시도 시 타임아웃 및 우선순위 고려</td></tr><tr><td><strong>4. 읽기/쓰기 전략</strong></td><td>복제본, 분리 처리</td><td>읽기 복제본 활용하여 쓰기 병목 분산</td><td>읽기 중심 시 낙관적 활용, 쓰기는 동기 처리</td><td>읽기/쓰기 트래픽 특성 기반 전략 분리</td></tr><tr><td><strong>5. 버전 관리 최적화</strong></td><td>인덱스, 캐시, 압축</td><td>관련 없음</td><td>버전 필드 인덱스, TTL 캐시 적용</td><td>캐시 - 저장소 간 TTL/일관성 동기화 주의</td></tr><tr><td><strong>6. 비동기/비차단 처리</strong></td><td>메시지 큐, 비동기 트랜잭션</td><td>락 이후 후속 작업 비동기화</td><td>충돌 시 비동기 재처리 큐 활용</td><td>Kafka, RabbitMQ 등 연계 고려</td></tr><tr><td><strong>7. 분산 환경 최적화</strong></td><td>노드 간 동기화, 글로벌 버전 관리</td><td>Zookeeper 기반 분산 락</td><td>Vector Clock 기반 버전 관리</td><td>Global 상태 지연 최소화 설계 필요</td></tr><tr><td><strong>8. 모니터링 및 분석</strong></td><td>락 상태, 충돌 지표 수집</td><td>Lock Manager 상태 추적, Deadlock Graph 분석</td><td>충돌율, 재시도 비율 분석, 실패 로그 추적</td><td>실시간 지표 대시보드 및 Alert 정책 설정 필요</td></tr></tbody></table><ol><li><p><strong>Lock 범위 최적화</strong><br>락이 지나치게 넓거나 세밀할 경우 모두 성능 병목으로 이어질 수 있다. 락 단위 조정과 자동 에스컬레이션 정책은 DB 벤더별로 튜닝 필요.</p></li><li><p><strong>트랜잭션 최적화</strong><br>트랜잭션을 작게 유지하는 것이 락 유지 시간을 줄이고 교착상태를 방지하며, 전체 시스템 처리량을 향상시킨다.</p></li><li><p><strong>재시도/백오프 전략</strong><br>낙관적 락에서는 충돌 시 재시도가 핵심 전략이 되므로, 재시도 횟수 제한과 백오프 전략은 성능 유지에 필수적이다.</p></li><li><p><strong>읽기/쓰기 전략</strong><br>읽기와 쓰기 트래픽이 혼합된 경우에는 락 방식도 혼합 적용하는 것이 효과적이다. 읽기 복제본 활용은 Pessimistic 에서도 유효하다.</p></li><li><p><strong>버전 관리 최적화</strong><br>낙관적 락은 버전 필드가 핵심이므로, 캐싱, 인덱싱, TTL 관리로 성능 병목을 예방해야 한다.</p></li><li><p><strong>비동기/비차단 처리</strong><br>락 또는 충돌 이후의 후처리를 비동기로 분리하면 응답 지연을 줄이고 시스템 유연성을 높일 수 있다.</p></li><li><p><strong>분산 환경 최적화</strong><br>분산 락 및 글로벌 버전 정보는 네트워크 지연 및 장애 대응 능력이 중요한데, Redis/Zookeeper/etcd 각각의 특성을 고려해 설계해야 한다.</p></li><li><p><strong>모니터링 및 분석</strong><br>락 충돌, 대기 시간, 트랜잭션 충돌률을 정량적으로 측정하고 분석하는 것은 성능 최적화뿐 아니라 문제 조기 발견에 결정적이다.</p></li></ol><h4 id=공통적으로-고려해야-할-사항>공통적으로 고려해야 할 사항<a hidden class=anchor aria-hidden=true href=#공통적으로-고려해야-할-사항>#</a></h4><ul><li><strong>락 범위와 트랜잭션 시간</strong>은 성능과 정합성의 균형을 결정짓는 핵심.</li><li><strong>모니터링과 지표 기반 튜닝</strong>은 락 충돌, 재시도 비율, 대기 시간 등을 실시간으로 확인해 최적화에 반영해야 함.</li></ul><h4 id=pessimistic-locking-특화-고려사항>Pessimistic Locking 특화 고려사항<a hidden class=anchor aria-hidden=true href=#pessimistic-locking-특화-고려사항>#</a></h4><ul><li><strong>락 에스컬레이션</strong>은 필요 이상으로 큰 범위에 락이 걸리지 않도록 튜닝해야 하며, <strong>데이터 밀집도</strong>에 따라 조절해야 함.</li><li><strong>데드락 방지</strong>를 위한 순서 보장, 타임아웃 설정, 우선순위 기반 정책도 고려 필요.</li></ul><h4 id=optimistic-locking-특화-고려사항>Optimistic Locking 특화 고려사항<a hidden class=anchor aria-hidden=true href=#optimistic-locking-특화-고려사항>#</a></h4><ul><li><strong>버전 충돌 시 복구 전략</strong>이 명확해야 하고, 과도한 재시도를 방지하는 <strong>백오프 알고리즘</strong>이 필요함.</li><li><strong>버전 필드 캐싱, 압축, 인덱싱 최적화</strong>를 통해 성능 병목 최소화.</li></ul><h3 id=실무-사용-예시>실무 사용 예시<a hidden class=anchor aria-hidden=true href=#실무-사용-예시>#</a></h3><h4 id=금융-및-트랜잭션-시스템>금융 및 트랜잭션 시스템<a hidden class=anchor aria-hidden=true href=#금융-및-트랜잭션-시스템>#</a></h4><table><thead><tr><th>시나리오</th><th>락 타입</th><th>적용 이유</th><th>특징 및 고려사항</th></tr></thead><tbody><tr><td>은행 계좌 이체</td><td>Pessimistic</td><td>이중 인출 방지, 원자성 보장</td><td>락 순서 정의, 트랜잭션 타임아웃 필요</td></tr><tr><td>송금 처리</td><td>Pessimistic</td><td>복수 계좌 잔액 동시 정합성 요구</td><td>데드락 가능성 존재, 분산 트랜잭션과 연계</td></tr></tbody></table><h4 id=전자상거래-및-예약-시스템>전자상거래 및 예약 시스템<a hidden class=anchor aria-hidden=true href=#전자상거래-및-예약-시스템>#</a></h4><table><thead><tr><th>시나리오</th><th>락 타입</th><th>적용 이유</th><th>특징 및 고려사항</th></tr></thead><tbody><tr><td>재고 수량 관리</td><td>혼합형</td><td>조회는 성능 중심, 결제는 정확성 중심</td><td>Optimistic → Pessimistic 전환 구조</td></tr><tr><td>좌석 예약</td><td>혼합형</td><td>조회는 낙관적 처리, 예약 확정은 락 필요</td><td>중복 방지, 트랜잭션 분리 필수</td></tr></tbody></table><hr><h3 id=-협업-및-콘텐츠-편집>🔹 협업 및 콘텐츠 편집<a hidden class=anchor aria-hidden=true href=#-협업-및-콘텐츠-편집>#</a></h3><table><thead><tr><th>시나리오</th><th>락 타입</th><th>적용 이유</th><th>특징 및 고려사항</th></tr></thead><tbody><tr><td>문서 동시 편집</td><td>Pessimistic</td><td>변경 충돌 방지</td><td>편집 락, 사용자 인터페이스와의 연계 필요</td></tr><tr><td>댓글/알림/이력 저장</td><td>Optimistic</td><td>드문 충돌, 실시간 처리 우선</td><td>버전 충돌 시 재시도</td></tr><tr><td>SaaS 기반 문서 편집기</td><td>Optimistic + CRDT</td><td>병합 기반 협업 기능 제공</td><td>Conflict-free 구조 필요, 병합 로직 중요</td></tr></tbody></table><hr><h3 id=-로그통계iot게임-등-실시간-데이터>🔹 로그/통계/IoT/게임 등 실시간 데이터<a hidden class=anchor aria-hidden=true href=#-로그통계iot게임-등-실시간-데이터>#</a></h3><table><thead><tr><th>시나리오</th><th>락 타입</th><th>적용 이유</th><th>특징 및 고려사항</th></tr></thead><tbody><tr><td>통계 로그 저장</td><td>Optimistic</td><td>유실 감내 가능, 이벤트 중심 설계</td><td>일시적 실패 허용, 큐 기반 처리 적합</td></tr><tr><td>IoT 알람 트리거</td><td>혼합형</td><td>알람은 정합성 필요, 센싱은 실시간성 중시</td><td>알람 트리거만 락 적용, 데이터 수집은 낙관적 처리</td></tr><tr><td>랭킹, 게임 입찰 처리</td><td>Pessimistic</td><td>일관성 필수 (입찰, 아이템 거래 등)</td><td>성능 보장 위해 분산 락 또는 캐시 필요</td></tr></tbody></table><hr><h2 id=-6-요약-정리-카테고리별-핵심-내용>✅ 6. 요약 정리 (카테고리별 핵심 내용)<a hidden class=anchor aria-hidden=true href=#-6-요약-정리-카테고리별-핵심-내용>#</a></h2><ul><li><p><strong>금융/트랜잭션</strong>: 모든 상태 변경에 대해 정합성이 핵심이므로 <strong>Pessimistic Locking</strong>이 권장되며, 트랜잭션 중 데드락이나 락 타임아웃 대응이 필요함.</p></li><li><p><strong>전자상거래/예약 시스템</strong>: 조회는 Optimistic, 결제나 확정 단계에서는 정확성이 중요해 <strong>혼합 전략</strong>이 일반적임.</p></li><li><p><strong>협업 도구/콘텐츠 편집</strong>: 사용자 경험과 병합 편의성을 위해 <strong>Optimistic Locking</strong> 또는 <strong>CRDT 기반</strong> 처리로 전환됨.</p></li><li><p><strong>로그/통계/IoT/게임 처리</strong>: 실시간성 우선 환경에서는 대부분 <strong>Optimistic Locking</strong>을 적용하며, 중요 트리거나 리소스에는 제한적으로 락을 적용함.</p></li></ul><p>필요하다면 각 시나리오별로 실제 구현 코드 예시, 락 전략 전환 조건, 트랜잭션 경계 설정 방식 등도 추가 분석해줄 수 있어. 다음 단계로 확장하고 싶은 부분이 있다면 알려줘.</p><h3 id=활용-사례>활용 사례<a hidden class=anchor aria-hidden=true href=#활용-사례>#</a></h3><h4 id=사례-1-대형-온라인-쇼핑몰에서-재고-부족으로-인한-결제-실패-방지>사례 1: 대형 온라인 쇼핑몰에서 재고 부족으로 인한 결제 실패 방지<a hidden class=anchor aria-hidden=true href=#사례-1-대형-온라인-쇼핑몰에서-재고-부족으로-인한-결제-실패-방지>#</a></h4><p><strong>시나리오</strong>: 대형 온라인 쇼핑몰에서 상품 재고 수량 관리 시 재고 부족으로 인한 결제 실패 방지</p><p><strong>시스템 구성</strong>:</p><ul><li>사용자 → 주문 시스템 → 재고 관리 서비스 → DB</li></ul><pre class=mermaid>graph TD
  User --&gt; OrderSystem
  OrderSystem --&gt; InventoryService
  InventoryService --&gt; DB[Inventory DB]
</pre><p><strong>Workflow</strong>:</p><ul><li>주문 요청 → 재고 확인 → Pessimistic Lock → 재고 차감 → 주문 처리 → Lock 해제</li></ul><p><strong>역할</strong>:</p><ul><li>재고 수량 정확성 보장</li><li>동시 결제 충돌 방지</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>적용 시: 주문 충돌 없음, 정확한 재고 유지</li><li>미적용 시: 동시에 결제 시 재고 초과 주문 가능</li></ul><p><strong>구현 예시 (Python + SQLAlchemy)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>select</span><span class=p>,</span> <span class=n>update</span><span class=p>,</span> <span class=n>and_</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>models</span> <span class=kn>import</span> <span class=n>Inventory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reserve_stock</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>session</span><span class=o>.</span><span class=n>begin</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>select</span><span class=p>(</span><span class=n>Inventory</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>Inventory</span><span class=o>.</span><span class=n>product_id</span> <span class=o>==</span> <span class=n>product_id</span><span class=p>)</span><span class=o>.</span><span class=n>with_for_update</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>scalar_one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>item</span><span class=o>.</span><span class=n>stock</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Out of stock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>item</span><span class=o>.</span><span class=n>stock</span> <span class=o>-=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-2-전자상거래-플랫폼의-플래시-세일-이벤트-시스템>사례 2: 전자상거래 플랫폼의 플래시 세일 이벤트 시스템<a hidden class=anchor aria-hidden=true href=#사례-2-전자상거래-플랫폼의-플래시-세일-이벤트-시스템>#</a></h4><p><strong>시나리오</strong>: 대규모 전자상거래 플랫폼의 플래시 세일 이벤트 시스템</p><p><strong>시스템 구성</strong>:</p><ul><li><strong>웹 서버</strong>: Load Balancer 뒤의 다중 인스턴스</li><li><strong>데이터베이스</strong>: PostgreSQL 클러스터 (Master-Slave)</li><li><strong>캐시</strong>: Redis 클러스터</li><li><strong>메시지 큐</strong>: RabbitMQ</li><li><strong>모니터링</strong>: Prometheus + Grafana</li></ul><pre class=mermaid>graph TB
    subgraph &#34;사용자 요청&#34;
        U1[User 1]
        U2[User 2]
        U3[User N]
    end
    
    subgraph &#34;웹 계층&#34;
        LB[Load Balancer]
        W1[Web Server 1]
        W2[Web Server 2]
        W3[Web Server N]
    end
    
    subgraph &#34;서비스 계층&#34;
        OS[Order Service]
        IS[Inventory Service]
        PS[Payment Service]
    end
    
    subgraph &#34;데이터 계층&#34;
        RC[Redis Cache]
        MQ[Message Queue]
        DB[(PostgreSQL)]
        DBR[(Read Replica)]
    end
    
    subgraph &#34;모니터링&#34;
        MON[Monitoring System]
    end
    
    U1 --&gt; LB
    U2 --&gt; LB
    U3 --&gt; LB
    
    LB --&gt; W1
    LB --&gt; W2
    LB --&gt; W3
    
    W1 --&gt; OS
    W2 --&gt; OS
    W3 --&gt; OS
    
    OS --&gt; IS
    OS --&gt; PS
    OS --&gt; MQ
    
    IS --&gt; RC
    IS --&gt; DB
    PS --&gt; DB
    
    DB --&gt; DBR
    
    OS --&gt; MON
    IS --&gt; MON
    PS --&gt; MON
</pre><p><strong>Workflow</strong>:</p><ol><li><strong>상품 조회 단계</strong>: Redis 캐시에서 상품 정보 조회 (Optimistic)</li><li><strong>장바구니 담기</strong>: 버전 기반 Optimistic Locking 으로 장바구니 업데이트</li><li><strong>재고 확인</strong>: Read Replica 에서 재고 조회 (성능 최적화)</li><li><strong>주문 생성</strong>: Pessimistic Locking 으로 재고 차감 및 주문 생성</li><li><strong>결제 처리</strong>: 외부 PG 연동 시 타임아웃 고려한 락 관리</li><li><strong>주문 완료</strong>: 비동기 메시지로 후속 처리 (배송, 알림 등)</li></ol><p><strong>역할</strong>:</p><ul><li><strong>Pessimistic Locking</strong>: 재고 차감, 결제 처리에서 데이터 정확성 보장</li><li><strong>Optimistic Locking</strong>: 장바구니, 사용자 프로필 업데이트에서 성능 최적화</li><li><strong>Redis Cache</strong>: 상품 정보 캐싱으로 DB 부하 감소</li><li><strong>Message Queue</strong>: 비동기 처리로 사용자 응답 시간 단축</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>락킹 메커니즘 없는 경우</strong>:<ul><li>재고 오버셀링 발생 (100 개 재고에 150 개 주문 접수)</li><li>결제 중복 처리로 인한 고객 불만 및 환불 비용</li><li>데이터 불일치로 인한 운영 복잡성 증가</li></ul></li><li><strong>Pessimistic Locking 만 사용하는 경우</strong>:<ul><li>안전하지만 동시 접속자 증가 시 심각한 성능 저하</li><li>평균 응답 시간 3-5 초 증가</li><li>데드락 발생으로 인한 시스템 불안정</li></ul></li><li><strong>Optimistic Locking 만 사용하는 경우</strong>:<ul><li>높은 성능이지만 플래시 세일 시 대량 충돌 발생</li><li>재시도 스톰으로 인한 서버 부하 급증</li><li>사용자 경험 저하 (반복적인 " 다시 시도 " 메시지)</li></ul></li><li><strong>하이브리드 접근법 (권장)</strong>:<ul><li>상황별 최적 락킹 전략 적용</li><li>평균 응답 시간 1 초 이내 유지</li><li>99.9% 데이터 정확성 보장</li></ul></li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>  1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>  2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3>  3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4>  4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5>  5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6>  6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7>  7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8>  8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9>  9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10> 10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11> 11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12> 12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13> 13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14> 14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15> 15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16> 16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17> 17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18> 18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19> 19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20> 20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21> 21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22> 22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23> 23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24> 24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25> 25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26> 26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27> 27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28> 28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29> 29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30> 30</a>
</span><span class=lnt id=hl-21-31><a class=lnlinks href=#hl-21-31> 31</a>
</span><span class=lnt id=hl-21-32><a class=lnlinks href=#hl-21-32> 32</a>
</span><span class=lnt id=hl-21-33><a class=lnlinks href=#hl-21-33> 33</a>
</span><span class=lnt id=hl-21-34><a class=lnlinks href=#hl-21-34> 34</a>
</span><span class=lnt id=hl-21-35><a class=lnlinks href=#hl-21-35> 35</a>
</span><span class=lnt id=hl-21-36><a class=lnlinks href=#hl-21-36> 36</a>
</span><span class=lnt id=hl-21-37><a class=lnlinks href=#hl-21-37> 37</a>
</span><span class=lnt id=hl-21-38><a class=lnlinks href=#hl-21-38> 38</a>
</span><span class=lnt id=hl-21-39><a class=lnlinks href=#hl-21-39> 39</a>
</span><span class=lnt id=hl-21-40><a class=lnlinks href=#hl-21-40> 40</a>
</span><span class=lnt id=hl-21-41><a class=lnlinks href=#hl-21-41> 41</a>
</span><span class=lnt id=hl-21-42><a class=lnlinks href=#hl-21-42> 42</a>
</span><span class=lnt id=hl-21-43><a class=lnlinks href=#hl-21-43> 43</a>
</span><span class=lnt id=hl-21-44><a class=lnlinks href=#hl-21-44> 44</a>
</span><span class=lnt id=hl-21-45><a class=lnlinks href=#hl-21-45> 45</a>
</span><span class=lnt id=hl-21-46><a class=lnlinks href=#hl-21-46> 46</a>
</span><span class=lnt id=hl-21-47><a class=lnlinks href=#hl-21-47> 47</a>
</span><span class=lnt id=hl-21-48><a class=lnlinks href=#hl-21-48> 48</a>
</span><span class=lnt id=hl-21-49><a class=lnlinks href=#hl-21-49> 49</a>
</span><span class=lnt id=hl-21-50><a class=lnlinks href=#hl-21-50> 50</a>
</span><span class=lnt id=hl-21-51><a class=lnlinks href=#hl-21-51> 51</a>
</span><span class=lnt id=hl-21-52><a class=lnlinks href=#hl-21-52> 52</a>
</span><span class=lnt id=hl-21-53><a class=lnlinks href=#hl-21-53> 53</a>
</span><span class=lnt id=hl-21-54><a class=lnlinks href=#hl-21-54> 54</a>
</span><span class=lnt id=hl-21-55><a class=lnlinks href=#hl-21-55> 55</a>
</span><span class=lnt id=hl-21-56><a class=lnlinks href=#hl-21-56> 56</a>
</span><span class=lnt id=hl-21-57><a class=lnlinks href=#hl-21-57> 57</a>
</span><span class=lnt id=hl-21-58><a class=lnlinks href=#hl-21-58> 58</a>
</span><span class=lnt id=hl-21-59><a class=lnlinks href=#hl-21-59> 59</a>
</span><span class=lnt id=hl-21-60><a class=lnlinks href=#hl-21-60> 60</a>
</span><span class=lnt id=hl-21-61><a class=lnlinks href=#hl-21-61> 61</a>
</span><span class=lnt id=hl-21-62><a class=lnlinks href=#hl-21-62> 62</a>
</span><span class=lnt id=hl-21-63><a class=lnlinks href=#hl-21-63> 63</a>
</span><span class=lnt id=hl-21-64><a class=lnlinks href=#hl-21-64> 64</a>
</span><span class=lnt id=hl-21-65><a class=lnlinks href=#hl-21-65> 65</a>
</span><span class=lnt id=hl-21-66><a class=lnlinks href=#hl-21-66> 66</a>
</span><span class=lnt id=hl-21-67><a class=lnlinks href=#hl-21-67> 67</a>
</span><span class=lnt id=hl-21-68><a class=lnlinks href=#hl-21-68> 68</a>
</span><span class=lnt id=hl-21-69><a class=lnlinks href=#hl-21-69> 69</a>
</span><span class=lnt id=hl-21-70><a class=lnlinks href=#hl-21-70> 70</a>
</span><span class=lnt id=hl-21-71><a class=lnlinks href=#hl-21-71> 71</a>
</span><span class=lnt id=hl-21-72><a class=lnlinks href=#hl-21-72> 72</a>
</span><span class=lnt id=hl-21-73><a class=lnlinks href=#hl-21-73> 73</a>
</span><span class=lnt id=hl-21-74><a class=lnlinks href=#hl-21-74> 74</a>
</span><span class=lnt id=hl-21-75><a class=lnlinks href=#hl-21-75> 75</a>
</span><span class=lnt id=hl-21-76><a class=lnlinks href=#hl-21-76> 76</a>
</span><span class=lnt id=hl-21-77><a class=lnlinks href=#hl-21-77> 77</a>
</span><span class=lnt id=hl-21-78><a class=lnlinks href=#hl-21-78> 78</a>
</span><span class=lnt id=hl-21-79><a class=lnlinks href=#hl-21-79> 79</a>
</span><span class=lnt id=hl-21-80><a class=lnlinks href=#hl-21-80> 80</a>
</span><span class=lnt id=hl-21-81><a class=lnlinks href=#hl-21-81> 81</a>
</span><span class=lnt id=hl-21-82><a class=lnlinks href=#hl-21-82> 82</a>
</span><span class=lnt id=hl-21-83><a class=lnlinks href=#hl-21-83> 83</a>
</span><span class=lnt id=hl-21-84><a class=lnlinks href=#hl-21-84> 84</a>
</span><span class=lnt id=hl-21-85><a class=lnlinks href=#hl-21-85> 85</a>
</span><span class=lnt id=hl-21-86><a class=lnlinks href=#hl-21-86> 86</a>
</span><span class=lnt id=hl-21-87><a class=lnlinks href=#hl-21-87> 87</a>
</span><span class=lnt id=hl-21-88><a class=lnlinks href=#hl-21-88> 88</a>
</span><span class=lnt id=hl-21-89><a class=lnlinks href=#hl-21-89> 89</a>
</span><span class=lnt id=hl-21-90><a class=lnlinks href=#hl-21-90> 90</a>
</span><span class=lnt id=hl-21-91><a class=lnlinks href=#hl-21-91> 91</a>
</span><span class=lnt id=hl-21-92><a class=lnlinks href=#hl-21-92> 92</a>
</span><span class=lnt id=hl-21-93><a class=lnlinks href=#hl-21-93> 93</a>
</span><span class=lnt id=hl-21-94><a class=lnlinks href=#hl-21-94> 94</a>
</span><span class=lnt id=hl-21-95><a class=lnlinks href=#hl-21-95> 95</a>
</span><span class=lnt id=hl-21-96><a class=lnlinks href=#hl-21-96> 96</a>
</span><span class=lnt id=hl-21-97><a class=lnlinks href=#hl-21-97> 97</a>
</span><span class=lnt id=hl-21-98><a class=lnlinks href=#hl-21-98> 98</a>
</span><span class=lnt id=hl-21-99><a class=lnlinks href=#hl-21-99> 99</a>
</span><span class=lnt id=hl-21-100><a class=lnlinks href=#hl-21-100>100</a>
</span><span class=lnt id=hl-21-101><a class=lnlinks href=#hl-21-101>101</a>
</span><span class=lnt id=hl-21-102><a class=lnlinks href=#hl-21-102>102</a>
</span><span class=lnt id=hl-21-103><a class=lnlinks href=#hl-21-103>103</a>
</span><span class=lnt id=hl-21-104><a class=lnlinks href=#hl-21-104>104</a>
</span><span class=lnt id=hl-21-105><a class=lnlinks href=#hl-21-105>105</a>
</span><span class=lnt id=hl-21-106><a class=lnlinks href=#hl-21-106>106</a>
</span><span class=lnt id=hl-21-107><a class=lnlinks href=#hl-21-107>107</a>
</span><span class=lnt id=hl-21-108><a class=lnlinks href=#hl-21-108>108</a>
</span><span class=lnt id=hl-21-109><a class=lnlinks href=#hl-21-109>109</a>
</span><span class=lnt id=hl-21-110><a class=lnlinks href=#hl-21-110>110</a>
</span><span class=lnt id=hl-21-111><a class=lnlinks href=#hl-21-111>111</a>
</span><span class=lnt id=hl-21-112><a class=lnlinks href=#hl-21-112>112</a>
</span><span class=lnt id=hl-21-113><a class=lnlinks href=#hl-21-113>113</a>
</span><span class=lnt id=hl-21-114><a class=lnlinks href=#hl-21-114>114</a>
</span><span class=lnt id=hl-21-115><a class=lnlinks href=#hl-21-115>115</a>
</span><span class=lnt id=hl-21-116><a class=lnlinks href=#hl-21-116>116</a>
</span><span class=lnt id=hl-21-117><a class=lnlinks href=#hl-21-117>117</a>
</span><span class=lnt id=hl-21-118><a class=lnlinks href=#hl-21-118>118</a>
</span><span class=lnt id=hl-21-119><a class=lnlinks href=#hl-21-119>119</a>
</span><span class=lnt id=hl-21-120><a class=lnlinks href=#hl-21-120>120</a>
</span><span class=lnt id=hl-21-121><a class=lnlinks href=#hl-21-121>121</a>
</span><span class=lnt id=hl-21-122><a class=lnlinks href=#hl-21-122>122</a>
</span><span class=lnt id=hl-21-123><a class=lnlinks href=#hl-21-123>123</a>
</span><span class=lnt id=hl-21-124><a class=lnlinks href=#hl-21-124>124</a>
</span><span class=lnt id=hl-21-125><a class=lnlinks href=#hl-21-125>125</a>
</span><span class=lnt id=hl-21-126><a class=lnlinks href=#hl-21-126>126</a>
</span><span class=lnt id=hl-21-127><a class=lnlinks href=#hl-21-127>127</a>
</span><span class=lnt id=hl-21-128><a class=lnlinks href=#hl-21-128>128</a>
</span><span class=lnt id=hl-21-129><a class=lnlinks href=#hl-21-129>129</a>
</span><span class=lnt id=hl-21-130><a class=lnlinks href=#hl-21-130>130</a>
</span><span class=lnt id=hl-21-131><a class=lnlinks href=#hl-21-131>131</a>
</span><span class=lnt id=hl-21-132><a class=lnlinks href=#hl-21-132>132</a>
</span><span class=lnt id=hl-21-133><a class=lnlinks href=#hl-21-133>133</a>
</span><span class=lnt id=hl-21-134><a class=lnlinks href=#hl-21-134>134</a>
</span><span class=lnt id=hl-21-135><a class=lnlinks href=#hl-21-135>135</a>
</span><span class=lnt id=hl-21-136><a class=lnlinks href=#hl-21-136>136</a>
</span><span class=lnt id=hl-21-137><a class=lnlinks href=#hl-21-137>137</a>
</span><span class=lnt id=hl-21-138><a class=lnlinks href=#hl-21-138>138</a>
</span><span class=lnt id=hl-21-139><a class=lnlinks href=#hl-21-139>139</a>
</span><span class=lnt id=hl-21-140><a class=lnlinks href=#hl-21-140>140</a>
</span><span class=lnt id=hl-21-141><a class=lnlinks href=#hl-21-141>141</a>
</span><span class=lnt id=hl-21-142><a class=lnlinks href=#hl-21-142>142</a>
</span><span class=lnt id=hl-21-143><a class=lnlinks href=#hl-21-143>143</a>
</span><span class=lnt id=hl-21-144><a class=lnlinks href=#hl-21-144>144</a>
</span><span class=lnt id=hl-21-145><a class=lnlinks href=#hl-21-145>145</a>
</span><span class=lnt id=hl-21-146><a class=lnlinks href=#hl-21-146>146</a>
</span><span class=lnt id=hl-21-147><a class=lnlinks href=#hl-21-147>147</a>
</span><span class=lnt id=hl-21-148><a class=lnlinks href=#hl-21-148>148</a>
</span><span class=lnt id=hl-21-149><a class=lnlinks href=#hl-21-149>149</a>
</span><span class=lnt id=hl-21-150><a class=lnlinks href=#hl-21-150>150</a>
</span><span class=lnt id=hl-21-151><a class=lnlinks href=#hl-21-151>151</a>
</span><span class=lnt id=hl-21-152><a class=lnlinks href=#hl-21-152>152</a>
</span><span class=lnt id=hl-21-153><a class=lnlinks href=#hl-21-153>153</a>
</span><span class=lnt id=hl-21-154><a class=lnlinks href=#hl-21-154>154</a>
</span><span class=lnt id=hl-21-155><a class=lnlinks href=#hl-21-155>155</a>
</span><span class=lnt id=hl-21-156><a class=lnlinks href=#hl-21-156>156</a>
</span><span class=lnt id=hl-21-157><a class=lnlinks href=#hl-21-157>157</a>
</span><span class=lnt id=hl-21-158><a class=lnlinks href=#hl-21-158>158</a>
</span><span class=lnt id=hl-21-159><a class=lnlinks href=#hl-21-159>159</a>
</span><span class=lnt id=hl-21-160><a class=lnlinks href=#hl-21-160>160</a>
</span><span class=lnt id=hl-21-161><a class=lnlinks href=#hl-21-161>161</a>
</span><span class=lnt id=hl-21-162><a class=lnlinks href=#hl-21-162>162</a>
</span><span class=lnt id=hl-21-163><a class=lnlinks href=#hl-21-163>163</a>
</span><span class=lnt id=hl-21-164><a class=lnlinks href=#hl-21-164>164</a>
</span><span class=lnt id=hl-21-165><a class=lnlinks href=#hl-21-165>165</a>
</span><span class=lnt id=hl-21-166><a class=lnlinks href=#hl-21-166>166</a>
</span><span class=lnt id=hl-21-167><a class=lnlinks href=#hl-21-167>167</a>
</span><span class=lnt id=hl-21-168><a class=lnlinks href=#hl-21-168>168</a>
</span><span class=lnt id=hl-21-169><a class=lnlinks href=#hl-21-169>169</a>
</span><span class=lnt id=hl-21-170><a class=lnlinks href=#hl-21-170>170</a>
</span><span class=lnt id=hl-21-171><a class=lnlinks href=#hl-21-171>171</a>
</span><span class=lnt id=hl-21-172><a class=lnlinks href=#hl-21-172>172</a>
</span><span class=lnt id=hl-21-173><a class=lnlinks href=#hl-21-173>173</a>
</span><span class=lnt id=hl-21-174><a class=lnlinks href=#hl-21-174>174</a>
</span><span class=lnt id=hl-21-175><a class=lnlinks href=#hl-21-175>175</a>
</span><span class=lnt id=hl-21-176><a class=lnlinks href=#hl-21-176>176</a>
</span><span class=lnt id=hl-21-177><a class=lnlinks href=#hl-21-177>177</a>
</span><span class=lnt id=hl-21-178><a class=lnlinks href=#hl-21-178>178</a>
</span><span class=lnt id=hl-21-179><a class=lnlinks href=#hl-21-179>179</a>
</span><span class=lnt id=hl-21-180><a class=lnlinks href=#hl-21-180>180</a>
</span><span class=lnt id=hl-21-181><a class=lnlinks href=#hl-21-181>181</a>
</span><span class=lnt id=hl-21-182><a class=lnlinks href=#hl-21-182>182</a>
</span><span class=lnt id=hl-21-183><a class=lnlinks href=#hl-21-183>183</a>
</span><span class=lnt id=hl-21-184><a class=lnlinks href=#hl-21-184>184</a>
</span><span class=lnt id=hl-21-185><a class=lnlinks href=#hl-21-185>185</a>
</span><span class=lnt id=hl-21-186><a class=lnlinks href=#hl-21-186>186</a>
</span><span class=lnt id=hl-21-187><a class=lnlinks href=#hl-21-187>187</a>
</span><span class=lnt id=hl-21-188><a class=lnlinks href=#hl-21-188>188</a>
</span><span class=lnt id=hl-21-189><a class=lnlinks href=#hl-21-189>189</a>
</span><span class=lnt id=hl-21-190><a class=lnlinks href=#hl-21-190>190</a>
</span><span class=lnt id=hl-21-191><a class=lnlinks href=#hl-21-191>191</a>
</span><span class=lnt id=hl-21-192><a class=lnlinks href=#hl-21-192>192</a>
</span><span class=lnt id=hl-21-193><a class=lnlinks href=#hl-21-193>193</a>
</span><span class=lnt id=hl-21-194><a class=lnlinks href=#hl-21-194>194</a>
</span><span class=lnt id=hl-21-195><a class=lnlinks href=#hl-21-195>195</a>
</span><span class=lnt id=hl-21-196><a class=lnlinks href=#hl-21-196>196</a>
</span><span class=lnt id=hl-21-197><a class=lnlinks href=#hl-21-197>197</a>
</span><span class=lnt id=hl-21-198><a class=lnlinks href=#hl-21-198>198</a>
</span><span class=lnt id=hl-21-199><a class=lnlinks href=#hl-21-199>199</a>
</span><span class=lnt id=hl-21-200><a class=lnlinks href=#hl-21-200>200</a>
</span><span class=lnt id=hl-21-201><a class=lnlinks href=#hl-21-201>201</a>
</span><span class=lnt id=hl-21-202><a class=lnlinks href=#hl-21-202>202</a>
</span><span class=lnt id=hl-21-203><a class=lnlinks href=#hl-21-203>203</a>
</span><span class=lnt id=hl-21-204><a class=lnlinks href=#hl-21-204>204</a>
</span><span class=lnt id=hl-21-205><a class=lnlinks href=#hl-21-205>205</a>
</span><span class=lnt id=hl-21-206><a class=lnlinks href=#hl-21-206>206</a>
</span><span class=lnt id=hl-21-207><a class=lnlinks href=#hl-21-207>207</a>
</span><span class=lnt id=hl-21-208><a class=lnlinks href=#hl-21-208>208</a>
</span><span class=lnt id=hl-21-209><a class=lnlinks href=#hl-21-209>209</a>
</span><span class=lnt id=hl-21-210><a class=lnlinks href=#hl-21-210>210</a>
</span><span class=lnt id=hl-21-211><a class=lnlinks href=#hl-21-211>211</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Python Flask + SQLAlchemy 구현</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span> <span class=n>DateTime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Database 설정</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;postgresql://user:pass@localhost/ecommerce&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>SessionLocal</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis 설정</span>
</span></span><span class=line><span class=cl><span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Product</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;products&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>price</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>stock_quantity</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>updated_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;orders&#39;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>product_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>total_amount</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;pending&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>DateTime</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/api/products/&lt;int:product_id&gt;&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_product</span><span class=p>(</span><span class=n>product_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;상품 정보 조회 - Redis 캐시 + Optimistic 접근&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 1. Redis 캐시 확인</span>
</span></span><span class=line><span class=cl>    <span class=n>cached_product</span> <span class=o>=</span> <span class=n>redis_client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;product:</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cached_product</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cached_product</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 2. DB에서 조회 (Read Replica 사용)</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>SessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>product_id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>product</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=s1>&#39;Product not found&#39;</span><span class=p>}),</span> <span class=mi>404</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>product_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>product</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>product</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;price&#39;</span><span class=p>:</span> <span class=n>product</span><span class=o>.</span><span class=n>price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stock_quantity&#39;</span><span class=p>:</span> <span class=n>product</span><span class=o>.</span><span class=n>stock_quantity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=n>product</span><span class=o>.</span><span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. Redis에 캐시 저장 (5분 TTL)</span>
</span></span><span class=line><span class=cl>        <span class=n>redis_client</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s1>&#39;product:</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=mi>300</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>product_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>product_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/api/orders&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 생성 - Pessimistic Locking 적용&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>product_id</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;product_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;quantity&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>SessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 1. Pessimistic Lock으로 재고 확인 및 차감</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>product_id</span><span class=p>)</span><span class=o>.</span><span class=n>with_for_update</span><span class=p>()</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>product</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=s1>&#39;Product not found&#39;</span><span class=p>}),</span> <span class=mi>404</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>product</span><span class=o>.</span><span class=n>stock_quantity</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=s1>&#39;Insufficient stock&#39;</span><span class=p>}),</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. 재고 차감</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>stock_quantity</span> <span class=o>-=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>updated_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. 주문 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>product_id</span><span class=o>=</span><span class=n>product_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>quantity</span><span class=o>=</span><span class=n>quantity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>total_amount</span><span class=o>=</span><span class=n>product</span><span class=o>.</span><span class=n>price</span> <span class=o>*</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 4. 트랜잭션 커밋</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 5. 캐시 무효화</span>
</span></span><span class=line><span class=cl>        <span class=n>redis_client</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;product:</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;remaining_stock&#39;</span><span class=p>:</span> <span class=n>product</span><span class=o>.</span><span class=n>stock_quantity</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/api/cart&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;PUT&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_cart</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;장바구니 업데이트 - Optimistic Locking 적용&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;items&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span> <span class=o>=</span> <span class=n>SessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 1. 현재 사용자 카트 정보 조회</span>
</span></span><span class=line><span class=cl>            <span class=n>cart_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;cart:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>current_cart</span> <span class=o>=</span> <span class=n>redis_client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cart_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cart_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>current_cart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>original_version</span> <span class=o>=</span> <span class=n>cart_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;version&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cart_data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=p>[],</span> <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>original_version</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 2. 카트 데이터 업데이트</span>
</span></span><span class=line><span class=cl>            <span class=n>new_cart_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=n>original_version</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;updated_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 3. Optimistic Update (Lua 스크립트 사용)</span>
</span></span><span class=line><span class=cl>            <span class=n>lua_script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            local key = KEYS[1]
</span></span></span><span class=line><span class=cl><span class=s2>            local expected_version = tonumber(ARGV[1])
</span></span></span><span class=line><span class=cl><span class=s2>            local new_data = ARGV[2]
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>            local current_data = redis.call(&#39;GET&#39;, key)
</span></span></span><span class=line><span class=cl><span class=s2>            if current_data then
</span></span></span><span class=line><span class=cl><span class=s2>                local current_version = cjson.decode(current_data).version
</span></span></span><span class=line><span class=cl><span class=s2>                if current_version ~= expected_version then
</span></span></span><span class=line><span class=cl><span class=s2>                    return 0  -- 버전 충돌
</span></span></span><span class=line><span class=cl><span class=s2>                end
</span></span></span><span class=line><span class=cl><span class=s2>            end
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>            redis.call(&#39;SET&#39;, key, new_data)
</span></span></span><span class=line><span class=cl><span class=s2>            redis.call(&#39;EXPIRE&#39;, key, 3600)  -- 1시간 TTL
</span></span></span><span class=line><span class=cl><span class=s2>            return 1  -- 성공
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>redis_client</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>lua_script</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=mi>1</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>cart_key</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>original_version</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>new_cart_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>result</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;cart&#39;</span><span class=p>:</span> <span class=n>new_cart_data</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 충돌 발생, 재시도</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span> <span class=o>*</span> <span class=p>(</span><span class=mi>2</span> <span class=o>**</span> <span class=n>attempt</span><span class=p>))</span>  <span class=c1># 지수 백오프</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=s1>&#39;Cart update conflict&#39;</span><span class=p>}),</span> <span class=mi>409</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}),</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=s1>&#39;Max retries exceeded&#39;</span><span class=p>}),</span> <span class=mi>503</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-3-온라인-쇼핑몰에서-재고관리>사례 3: 온라인 쇼핑몰에서 재고관리<a hidden class=anchor aria-hidden=true href=#사례-3-온라인-쇼핑몰에서-재고관리>#</a></h4><p><strong>시나리오</strong>: 온라인 쇼핑몰에서 재고관리 API 에 동시에 다수의 주문 요청이 들어올 때</p><p><strong>시스템 구성</strong>:</p><ul><li>Web API 서버</li><li>데이터베이스 시스템 (DBMS)</li><li>클라이언트 (사용자 및 주문 API)</li></ul><pre class=mermaid>graph TD
    Client1(Client A) --&gt; WebAPI(Web API 서버)
    Client2(Client B) --&gt; WebAPI
    WebAPI --&gt; DB[DB - 상품 테이블]
</pre><p><strong>Workflow</strong>:</p><ul><li>고객이 상품 주문 요청을 보내면 Web API 가 재고를 확인, 감산하여 DB 에 반영</li><li>비관적 락: 주문 처리 중 다른 처리 차단</li><li>낙관적 락: 처리 후 커밋 시점 충돌 검사, 충돌 시 롤백 후 재시도</li></ul><p><strong>역할</strong>:</p><ul><li>비관적 락: 데이터 충돌 선제 차단</li><li>낙관적 락: 빠른 처리와 충돌 발생 시 롤백 대응</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>비관적 락 도입: 주문 동시 처리 불가, 대기 시간 증가. 데이터 충돌 완전 차단</li><li>낙관적 락 도입: 빠른 처리, 동시에 주문할 경우 일부에서는 실패 및 재시도 발생 가능</li></ul><p><strong>구현 예시</strong>: Python, SQLAlchemy ORM 기반</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20>20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21>21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22>22</a>
</span><span class=lnt id=hl-23-23><a class=lnlinks href=#hl-23-23>23</a>
</span><span class=lnt id=hl-23-24><a class=lnlinks href=#hl-23-24>24</a>
</span><span class=lnt id=hl-23-25><a class=lnlinks href=#hl-23-25>25</a>
</span><span class=lnt id=hl-23-26><a class=lnlinks href=#hl-23-26>26</a>
</span><span class=lnt id=hl-23-27><a class=lnlinks href=#hl-23-27>27</a>
</span><span class=lnt id=hl-23-28><a class=lnlinks href=#hl-23-28>28</a>
</span><span class=lnt id=hl-23-29><a class=lnlinks href=#hl-23-29>29</a>
</span><span class=lnt id=hl-23-30><a class=lnlinks href=#hl-23-30>30</a>
</span><span class=lnt id=hl-23-31><a class=lnlinks href=#hl-23-31>31</a>
</span><span class=lnt id=hl-23-32><a class=lnlinks href=#hl-23-32>32</a>
</span><span class=lnt id=hl-23-33><a class=lnlinks href=#hl-23-33>33</a>
</span><span class=lnt id=hl-23-34><a class=lnlinks href=#hl-23-34>34</a>
</span><span class=lnt id=hl-23-35><a class=lnlinks href=#hl-23-35>35</a>
</span><span class=lnt id=hl-23-36><a class=lnlinks href=#hl-23-36>36</a>
</span><span class=lnt id=hl-23-37><a class=lnlinks href=#hl-23-37>37</a>
</span><span class=lnt id=hl-23-38><a class=lnlinks href=#hl-23-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 비관적 락</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>select</span><span class=p>,</span> <span class=n>update</span><span class=p>,</span> <span class=n>and_</span><span class=p>,</span> <span class=n>text</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_order_pessimistic</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>order_qty</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 상품 행을 SELECT FOR UPDATE로 가져옴(락 선점)</span>
</span></span><span class=line><span class=cl>    <span class=n>product</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>select</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>Product</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>product_id</span><span class=p>)</span><span class=o>.</span><span class=n>with_for_update</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>scalar_one_or_none</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>product</span> <span class=ow>and</span> <span class=n>product</span><span class=o>.</span><span class=n>stock</span> <span class=o>&gt;=</span> <span class=n>order_qty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>stock</span> <span class=o>-=</span> <span class=n>order_qty</span>
</span></span><span class=line><span class=cl>        <span class=c1># 변경사항 커밋</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 낙관적 락</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_order_optimistic</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>order_qty</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>version</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>product</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>and_</span><span class=p>(</span><span class=n>Product</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>Product</span><span class=o>.</span><span class=n>version</span> <span class=o>==</span> <span class=n>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>with_for_update</span><span class=p>(</span><span class=n>nowait</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 버전이 일치하면 업데이트</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>product</span> <span class=ow>and</span> <span class=n>product</span><span class=o>.</span><span class=n>stock</span> <span class=o>&gt;=</span> <span class=n>order_qty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>stock</span> <span class=o>-=</span> <span class=n>order_qty</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>version</span> <span class=o>+=</span> <span class=mi>1</span>  <span class=c1># 버전 증가</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-4-클라우드-기반-분산-처리-시스템>사례 4: 클라우드 기반 분산 처리 시스템<a hidden class=anchor aria-hidden=true href=#사례-4-클라우드-기반-분산-처리-시스템>#</a></h4><p><strong>시나리오:</strong> 대형 온라인 상품 검색 시스템에서 수많은 사용자가 동시에 상품 정보를 조회 및 일부 수정</p><p><strong>시스템 구성:</strong></p><ul><li>검색 API 서버 (분산)</li><li>DBMS(예: PostgreSQL, MySQL: MVCC 지원)</li><li>캐시 레이어 (Redis 등)</li></ul><p><strong>Mermaid 다이어그램 (분산 낙관적 락/MVCC 기반)</strong></p><pre class=mermaid>sequenceDiagram
    participant User
    participant APIServer
    participant DBMS as Database (MVCC)
    User-&gt;&gt;APIServer: 상품 수정 요청
    APIServer-&gt;&gt;DBMS: 최신 버전 조회
    DBMS-&gt;&gt;APIServer: 버전 정보와 데이터 반환
    APIServer-&gt;&gt;DBMS: 데이터 변경 요청 (버전 함께 전달)
    alt 충돌 없음
        DBMS-&gt;&gt;APIServer: 변경 성공/커밋
    else 충돌 발생
        DBMS-&gt;&gt;APIServer: 충돌, 롤백 알림
        APIServer-&gt;&gt;User: 재시도 요청 또는 오류 반환
    end
</pre><p><strong>Workflow:</strong></p><ol><li>API 서버가 최신 상품 정보 (버전 포함) 읽기</li><li>사용자 정보로 수정 요청</li><li>DB 는 커밋 시점에 버전 비교하여 충돌 확인</li><li>충돌 없으면 반영, 있으면 롤백 및 오류 알림</li></ol><p><strong>역할:</strong></p><ul><li>DBMS(MVCC/낙관적 락): 동시성 보장/정합성 유지</li><li>API 서버: 재시도/백오프 등 비즈니스 로직</li></ul><p><strong>유무에 따른 차이점:</strong></p><ul><li>MVCC/낙관적 락 없을 때: 일관성 저하, 일시적 데이터 잘못된 접근 가능</li><li>있을 때: lock-free 읽기, 대규모 확장성 및 성능 확보</li></ul><p><strong>구현 예시 (Python, SQLAlchemy, MVCC 기반 PostgreSQL):</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># MVCC 기반으로 Version 필드(예: xmin)을 사용</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.exc</span> <span class=kn>import</span> <span class=n>StaleDataError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_product_mvcc</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>Session</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>new_price</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>expected_version</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>product_id</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=n>expected_version</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>product</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>  <span class=c1># 충돌 발생</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>price</span> <span class=o>=</span> <span class=n>new_price</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span><span class=o>.</span><span class=n>version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>StaleDataError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>설명: 트랜잭션 커밋 시도 전의 version 값이 일치하면 성공, 아니면 충돌 감지 후 롤백.</li></ul><hr><h2 id=정리-및-학습-가이드>정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#정리-및-학습-가이드>#</a></h2><h3 id=내용-정리>내용 정리<a hidden class=anchor aria-hidden=true href=#내용-정리>#</a></h3><p>Pessimistic vs. Optimistic Locking 은 단순한 선택이 아니라, **시스템 요구사항 (정합성 vs 성능 vs 확장성)**에 따라 유연하게 구성되어야 할 전략이다. 특히 현대 분산 시스템에서는 <strong>조합 전략</strong>과 <strong>상황 기반 정책</strong>을 통해 <strong>충돌 회피와 성능 확보</strong>를 동시에 추구하는 방향이 명확히 드러나고 있다.<br>이제 단일 방식보다는 <strong>트래픽 특성, 비즈니스 도메인, 기술 인프라</strong>에 따라 <strong>동적이고 조합적인 락 전략</strong>이 핵심이 된다.</p><table><thead><tr><th>항목</th><th>Pessimistic Locking</th><th>Optimistic Locking</th></tr></thead><tbody><tr><td><strong>기본 철학</strong></td><td>충돌이 일어난다</td><td>충돌은 드물다</td></tr><tr><td><strong>적용 시점</strong></td><td>접근 전 락 획득</td><td>커밋 시 충돌 검증</td></tr><tr><td><strong>장점</strong></td><td>강력한 정합성, 예측 가능성</td><td>높은 성능, 확장성</td></tr><tr><td><strong>단점</strong></td><td>성능 저하, 데드락 위험</td><td>충돌 시 재시도, 오류 처리 복잡</td></tr><tr><td><strong>적합 사례</strong></td><td>금융, 재고, 예약 시스템</td><td>SNS, 로깅, 콘텐츠 시스템</td></tr><tr><td><strong>실무 전략</strong></td><td>핵심 구간에만 적용, 트랜잭션 단위로 관리</td><td>충돌 감지/재시도 논리 포함</td></tr><tr><td><strong>조합 전략</strong></td><td>하이브리드 전략 (읽기 - 낙관적 / 쓰기 - 비관적)</td><td></td></tr><tr><td><strong>기술 트렌드</strong></td><td>Redis Redlock, Zookeeper, etcd 등 분산 락</td><td>CQRS, Event Sourcing 과 연계된 동시성 제어 방식</td></tr></tbody></table><h4 id=트렌드-및-최신-기술-동향-요약>트렌드 및 최신 기술 동향 요약<a hidden class=anchor aria-hidden=true href=#트렌드-및-최신-기술-동향-요약>#</a></h4><ul><li><strong>분산 환경 확산</strong>: 락의 중앙 집중화는 병목이 될 수 있어, 분산 락 시스템 (Redis Redlock, etcd, Zookeeper 등) 이 부상</li><li><strong>CQRS + Event Sourcing</strong>:<ul><li><strong>CQRS</strong>: 커맨드 (Command) 와 쿼리 (Query) 를 분리해 동시성 충돌 가능성 최소화</li><li><strong>Event Sourcing</strong>: 상태 변경을 이벤트 로그로 대체해 트랜잭션 충돌 문제를 완화</li></ul></li><li><strong>Lock Granularity</strong>:<ul><li>Row-level, Column-level, Attribute-level Locking 등으로 세분화 → 경쟁 최소화 + 성능 향상</li></ul></li><li><strong>Adaptive Locking Strategy</strong>:<ul><li>동적 정책 기반 적용: 트래픽 분석 → 충돌 빈도에 따라 전략 자동 전환 (예: optimistic fallback to pessimistic)</li></ul></li></ul><h3 id=학습-항목-정리>학습 항목 정리<a hidden class=anchor aria-hidden=true href=#학습-항목-정리>#</a></h3><table><thead><tr><th>중요도</th><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>기본</td><td>동시성 제어</td><td>트랜잭션 기본 개념</td><td>ACID, 격리 수준</td><td>락 전략과 트랜잭션 일관성 사이의 관계 이해</td></tr><tr><td>기본</td><td>락 전략</td><td>Pessimistic Locking</td><td>SELECT FOR UPDATE, 2PL</td><td>트랜잭션 시작 시점에서 리소스를 선점하여 충돌 방지</td></tr><tr><td>기본</td><td>락 전략</td><td>Optimistic Locking</td><td>버전 관리, 충돌 감지</td><td>커밋 시점에 버전 일치 여부로 충돌 여부 판단</td></tr><tr><td>기본</td><td>트랜잭션 제어</td><td>락 세분화</td><td>Row/Table/DB 수준 락</td><td>과도한 락으로 인한 병목 방지를 위해 적용 수준 조절</td></tr><tr><td>심화</td><td>구현 기법</td><td>충돌 감지 및 해결</td><td>CAS, 재시도, 백오프</td><td>충돌 발생 시 무한 루프를 방지하고 효율적 처리 전략 필요</td></tr><tr><td>심화</td><td>성능 최적화</td><td>Granularity Tuning</td><td>락 범위 및 기간 조절</td><td>성능 병목 최소화를 위한 락 조정 전략</td></tr><tr><td>심화</td><td>분산 환경</td><td>Redis/ZooKeeper 락</td><td>Redlock, ZK 기반 락</td><td>분산 트랜잭션에서의 정합성 보장을 위한 락 매커니즘</td></tr><tr><td>실무</td><td>구현 전략</td><td>MVCC</td><td>다중 버전 일관성 제어</td><td>Oracle/PostgreSQL 등에서 사용하는 논블로킹 동시성 제어 방식</td></tr><tr><td>실무</td><td>실무 적용 전략</td><td>CQRS, 이벤트 소싱</td><td>Command/Query 분리 전략</td><td>락 병목을 아키텍처 수준에서 해소</td></tr><tr><td>실무</td><td>실무 적용 전략</td><td>모니터링 및 테스트</td><td>성능 메트릭, 부하 테스트 도구</td><td>충돌 빈도, 락 대기 시간 측정 및 시뮬레이션 도구 활용</td></tr><tr><td>실무</td><td>장애 대응</td><td>데드락 탐지 및 회피</td><td>Timeout, Wait-for Graph</td><td>Pessimistic 환경에서 반드시 적용해야 할 보호 전략</td></tr></tbody></table><ul><li><p><strong>기본 항목</strong>에서는 락 전략의 선택을 위한 <strong>트랜잭션 이론과 기본 동작</strong> 이해가 중요하며, 격리 수준과 ACID 특성, 그리고 데이터베이스 락 동작 방식은 반드시 선행 학습이 필요함.</p></li><li><p><strong>심화 항목</strong>에서는 충돌 해결 및 최적화 전략에 대한 이해가 중요하다. 특히 낙관적 락에서는 CAS, 재시도, 백오프가 실질적인 핵심이며, 분산 환경에서의 락 일관성은 고급 주제로 분류됨.</p></li><li><p><strong>실무 항목</strong>에서는 CQRS 및 이벤트 소싱 등 아키텍처 차원의 해결 전략과 함께, 락으로 인한 병목을 감지하고 대응하기 위한 모니터링과 테스트 전략이 중요하다.</p></li><li><p>특히 <strong>Pessimistic</strong>은 <strong>데드락 방지와 락 유지 최소화 전략</strong>, <strong>Optimistic</strong>은 <strong>충돌 후 전략적 복구 설계</strong>가 실무의 핵심이다.</p></li></ul><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td><strong>기본 개념</strong></td><td>트랜잭션 격리 수준 (Isolation Level)</td><td>트랜잭션 간 간섭 허용 수준 (RU, RC, RR, Serializable 등)</td></tr><tr><td></td><td>동시성 제어 (Concurrency Control)</td><td>다중 트랜잭션 간 무결성 보장 메커니즘</td></tr><tr><td></td><td>Lost Update</td><td>동시 수정으로 인해 변경사항 손실되는 현상</td></tr><tr><td></td><td>Deadlock (교착 상태)</td><td>서로 자원을 기다리며 무한 대기</td></tr><tr><td><strong>락킹 전략</strong></td><td>Pessimistic Locking</td><td>트랜잭션 시작 시점에 락 획득</td></tr><tr><td></td><td>Optimistic Locking</td><td>커밋 시점 충돌 검증을 통한 병행성 확보</td></tr><tr><td></td><td>2PL (Two-Phase Locking)</td><td>Lock → Unlock 두 단계로 처리</td></tr><tr><td></td><td>Shared / Exclusive Lock</td><td>읽기 공유 / 쓰기 배타 락 구분</td></tr><tr><td></td><td>Lock Escalation</td><td>세부 락을 대범위 락으로 승격</td></tr><tr><td><strong>낙관적 락 핵심 요소</strong></td><td>Version Number</td><td>레코드 변경 이력 기반 충돌 감지용 필드</td></tr><tr><td></td><td>Timestamp</td><td>트랜잭션 시작 시각 기반 충돌 감지</td></tr><tr><td></td><td>CAS (Compare-And-Swap)</td><td>메모리 기반 원자적 갱신 연산</td></tr><tr><td></td><td>ABA 문제</td><td>값이 원래 값으로 복귀해도 변경을 감지하지 못하는 문제</td></tr><tr><td><strong>성능 및 운영 전략</strong></td><td>Lock Timeout</td><td>일정 시간 경과 시 자동 락 해제</td></tr><tr><td></td><td>Backoff Strategy</td><td>실패 후 재시도 간 시간 지연 전략</td></tr><tr><td></td><td>Granularity Tuning</td><td>락 단위 조절로 병목 완화</td></tr><tr><td><strong>분산 락 및 고급 기술</strong></td><td>Distributed Lock</td><td>다중 노드 락 제어 기법</td></tr><tr><td></td><td>Redlock (Redis 기반)</td><td>Redis 인스턴스 기반 분산 락</td></tr><tr><td></td><td>MVCC</td><td>멀티 버전 데이터로 충돌 최소화</td></tr><tr><td></td><td>Event Sourcing</td><td>상태 변경을 이벤트 로그로 관리</td></tr><tr><td><strong>SQL/구현 도구</strong></td><td>SELECT FOR UPDATE</td><td>락을 동반하는 SQL 명령</td></tr><tr><td></td><td>Lock Table</td><td>현재 락 상태를 저장하는 DB 내부 구조</td></tr><tr><td></td><td>Stress Test</td><td>극한 상황에서 시스템 동시성 검증</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://martinfowler.com/articles/patterns-of-distributed-systems/pessimistic-vs-optimistic-locking.html>Pessimistic vs. Optimistic Locking – Martin Fowler</a></li><li><a href=https://www.baeldung.com/java-jpa-pessimistic-locking>Pessimistic Locking in JPA – Baeldung</a></li><li><a href=https://www.baeldung.com/java-jpa-optimistic-locking>Optimistic Locking in JPA – Baeldung</a></li><li><a href=https://www.mongodb.com/docs/manual/core/write-conflicts/#optimistic-concurrency-control>Optimistic Concurrency Control – MongoDB Docs</a></li><li><a href=https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/package-summary.html>java.util.concurrent.locks – Oracle Java Docs</a></li><li><a href=https://redis.io/docs/latest/develop/design-patterns/distributed-locks/>Redlock Algorithm – Redis Docs</a></li><li><a href=https://medium.com/@abhirup.acharya009/managing-concurrent-access-optimistic-locking-vs-pessimistic-locking-0f6a64294db7>Optimistic Locking vs Pessimistic Locking – Medium</a></li><li><a href=https://stackoverflow.com/questions/129329/optimistic-vs-pessimistic-locking>Optimistic vs. Pessimistic Locking – Stack Overflow</a></li><li><a href=https://www.freecodecamp.org/news/how-databases-guarantee-isolation/>How Databases Guarantee Isolation – FreeCodeCamp</a></li><li><a href=https://vladmihalcea.com/optimistic-vs-pessimistic-locking/>Optimistic vs. Pessimistic Locking – Vlad Mihalcea</a></li><li><a href=https://learning-notes.mistermicheels.com/data/sql/optimistic-pessimistic-locking-sql/>Optimistic and Pessimistic Locking in SQL – Learning Notes</a></li><li><a href=https://sleekflow.io/blog/message-processing-optimistic-concurrency-control>Concurrency Control and Optimistic Locking – SleekFlow</a></li><li><a href=https://dev.to/jszutkowski/pessimistic-vs-optimistic-locking-in-mysql-3hgc>Pessimistic vs. Optimistic Locking in MySQL – DEV Community</a></li><li><a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>Optimistic Concurrency Control – Wikipedia</a></li><li><a href=https://en.wikipedia.org/wiki/Pessimistic_concurrency_control>Pessimistic Locking – Wikipedia</a></li><li><a href=https://en.wikipedia.org/wiki/Multiversion_concurrency_control>Multi-Version Concurrency Control (MVCC) – Wikipedia</a></li><li><a href=https://www.linkedin.com/pulse/optimistic-locking-vs-pessimistic-guide-system-designers-yeshwanth-n-19goc>Optimistic Locking vs. Pessimistic: A Guide for System Designers – LinkedIn</a></li><li><a href=https://www.linkedin.com/advice/0/what-pros-cons-optimistic-pessimistic-locking-1c>Pros and Cons of Locking in SQL Transactions – LinkedIn</a></li><li><a href=https://en.wikipedia.org/wiki/Non-blocking_algorithm>Lock-Free Programming – Wikipedia</a></li><li><a href=https://docs.sqlalchemy.org/en/20/orm/versioning.html>Optimistic Locking in SQLAlchemy Docs</a></li><li><a href=https://martinfowler.com/eaaCatalog/pessimisticOfflineLock.html>Pessimistic Locking Pattern – Martin Fowler</a></li><li><a href=https://cybertec-postgresql.com/en/pessimistic-vs-optimistic-locking-in-postgresql/>Pessimistic vs. Optimistic Locking in PostgreSQL – Cybertec</a></li><li><a href=https://www.postgresql.org/docs/current/mvcc.html>Transaction Concurrency Control – PostgreSQL Docs</a></li><li><a href=https://www.baeldung.com/cs/pessimistic-vs-optimistic-locking>Pessimistic vs Optimistic Locking in Database Systems – Baeldung</a></li><li><a href=https://web.stanford.edu/class/cs345d-01/optimistic.html>Optimistic and Pessimistic Concurrency Control in Distributed Databases – Stanford</a></li><li><a href=https://redis.io/docs/interact/lock/>Distributed Lock with Redis: Redlock – Redis Docs</a></li></ul><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://buenhyden.github.io/tags/computer-science-fundamentals/>Computer-Science-Fundamentals</a></li><li><a href=https://buenhyden.github.io/tags/concurrency-and-parallelism/>Concurrency-and-Parallelism</a></li><li><a href=https://buenhyden.github.io/tags/lock/>Lock</a></li><li><a href=https://buenhyden.github.io/tags/pessimistic-vs-optimistic-locking/>Pessimistic-vs-Optimistic-Locking</a></li><li><a href=https://buenhyden.github.io/tags/pessimistic-locking/>Pessimistic-Locking</a></li><li><a href=https://buenhyden.github.io/tags/optimistic-locking/>Optimistic-Locking</a></li><li><a href=https://buenhyden.github.io/tags/concurrency-control/>Concurrency-Control</a></li><li><a href=https://buenhyden.github.io/tags/transaction-management/>Transaction-Management</a></li><li><a href=https://buenhyden.github.io/tags/data-consistency/>Data-Consistency</a></li></ul><nav class=paginav><a class=prev href=https://buenhyden.github.io/posts/software-development--engineering/development-practices/testing--quality/testing-fundamentals/quality-assurance-vs-quality-control-vs-testing/><span class=title>« Prev</span><br><span>QA vs QC vs Testing</span>
</a><a class=next href=https://buenhyden.github.io/posts/networking--protocols/communication-patterns/message-infrastructure/message-brokers-vs-event-brokers/event-broker/><span class=title>Next »</span><br><span>Event Broker</span></a></nav></footer><div class=comments><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const n={src:"https://giscus.app/client.js","data-repo":"buenhyden/buenhyden.github.io","data-repo-id":"R_kgDONsSnFQ","data-category":"General","data-category-id":"DIC_kwDONsSnFc4CmK-R","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"en","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(n).forEach(([t,n])=>e.setAttribute(t,n)),console.log(e),document.querySelector(".comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme)})</script></div></article></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>