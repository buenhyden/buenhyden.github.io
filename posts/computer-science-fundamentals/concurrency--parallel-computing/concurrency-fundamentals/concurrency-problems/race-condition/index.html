<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Race Condition | hyunyoun's Blog</title><meta name=keywords content="Computer-Science-Fundamentals,Concurrency-and-Parallelism,Concurrency-Problems,Race-Condition,Thread-Safety,Critical-Section"><meta name=description content="**Race Condition(경쟁 상태)**은 두 개 이상의 프로세스나 스레드가 동시에 공유 자원에 접근할 때, 실행 순서나 타이밍에 따라 결과가 달라지는 동시성 문제. 이는 동기화 부족으로 인해 발생하며, 데이터 불일치, 보안 취약성, 시스템 오류를 유발할 수 있다. 락, 세마포어, 동기화 블록 등으로 예방할 수 있다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency--parallel-computing/concurrency-fundamentals/concurrency-problems/race-condition/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.a9863521b3bd3c240bc506f46b95e3c06ccef2ae37f529d5f99bdaef442bccce.css integrity="sha256-qYY1IbO9PCQLxQb0a5XjwGzO8q439SnV+Zva70QrzM4=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency--parallel-computing/concurrency-fundamentals/concurrency-problems/race-condition/index.xml><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency--parallel-computing/concurrency-fundamentals/concurrency-problems/race-condition/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency--parallel-computing/concurrency-fundamentals/concurrency-problems/race-condition/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Race Condition"><meta property="og:description" content="**Race Condition(경쟁 상태)**은 두 개 이상의 프로세스나 스레드가 동시에 공유 자원에 접근할 때, 실행 순서나 타이밍에 따라 결과가 달라지는 동시성 문제. 이는 동기화 부족으로 인해 발생하며, 데이터 불일치, 보안 취약성, 시스템 오류를 유발할 수 있다. 락, 세마포어, 동기화 블록 등으로 예방할 수 있다."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Race Condition"><meta name=twitter:description content="**Race Condition(경쟁 상태)**은 두 개 이상의 프로세스나 스레드가 동시에 공유 자원에 접근할 때, 실행 순서나 타이밍에 따라 결과가 달라지는 동시성 문제. 이는 동기화 부족으로 인해 발생하며, 데이터 불일치, 보안 취약성, 시스템 오류를 유발할 수 있다. 락, 세마포어, 동기화 블록 등으로 예방할 수 있다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HY's Blog","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Computer Science Fundamentals","item":"https://buenhyden.github.io/posts/computer-science-fundamentals/"},{"@type":"ListItem","position":6,"name":"Race Condition","item":"https://buenhyden.github.io/posts/computer-science-fundamentals/concurrency--parallel-computing/concurrency-fundamentals/concurrency-problems/race-condition/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>HY's Blog</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/computer-science-fundamentals/>Computer Science Fundamentals</a></div><h1>Race Condition</h1><div class=post-description>**Race Condition(경쟁 상태)**은 두 개 이상의 프로세스나 스레드가 동시에 공유 자원에 접근할 때, 실행 순서나 타이밍에 따라 결과가 달라지는 동시성 문제. 이는 동기화 부족으로 인해 발생하며, 데이터 불일치, 보안 취약성, 시스템 오류를 유발할 수 있다. 락, 세마포어, 동기화 블록 등으로 예방할 수 있다.</div></header><div class=post-content><h2 id=race-condition>Race Condition<a hidden class=anchor aria-hidden=true href=#race-condition>#</a></h2><p>Race Condition(경쟁 상태) 은 멀티스레드나 분산 시스템에서 여러 실행 흐름이 공유 자원에 동시에 접근할 때, 실행 순서나 타이밍에 따라 결과가 달라지는 예측 불가능한 상태다.<br>동기화 미비, 비원자적 연산, TOCTOU 와 같은 패턴에서 자주 발생하며, 데이터 손상, 시스템 오류, 보안 취약점의 원인이 된다. 이를 예방하기 위해 뮤텍스, 세마포어, 원자 연산, 트랜잭션, 불변 객체 등이 사용되며, 실시간 시스템, 마이크로서비스, OS 커널 등 고신뢰 환경에서는 철저한 사전 방지 및 테스트가 필수적이다.</p><h3 id=핵심-개념>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념>#</a></h3><ul><li><p><strong>정의</strong>: 여러 흐름이 공유 자원에 동시 접근 시, 실행 순서에 따라 결과가 달라지는 비결정적 상태.</p></li><li><p><strong>필수 조건</strong>: 병렬 실행 흐름 + 공유 자원 + 동기화 부재</p></li><li><p><strong>대표 패턴</strong>:</p><ul><li><code>Read-Modify-Write</code></li><li><code>Check-Then-Act (TOCTOU)</code></li></ul></li><li><p><strong>중요 개념</strong>:</p><ul><li><strong>임계 구역 (Critical Section)</strong>: 자원 접근 코드 영역</li><li><strong>상호 배제 (Mutual Exclusion)</strong>: 하나의 흐름만 접근 허용</li><li><strong>원자성 (Atomicity)</strong>: 연산 단위 보장</li><li><strong>가시성 (Visibility)</strong>: 한 스레드의 변경이 다른 스레드에 반영됨</li><li><strong>순서성 (Ordering)</strong>: 명령 실행 순서 일관성</li></ul></li><li><p><strong>구현 수단</strong>:</p><ul><li><code>Lock</code></li><li><code>Semaphore</code></li><li><code>Atomic Operation</code></li><li><code>Transactional Memory</code></li><li><code>Event Loop</code></li><li><code>Queueing</code></li></ul></li></ul><h4 id=이론--실무--기본--심화-관점-정리>이론 / 실무 / 기본 / 심화 관점 정리<a hidden class=anchor aria-hidden=true href=#이론--실무--기본--심화-관점-정리>#</a></h4><table><thead><tr><th>구분</th><th>핵심 개념</th><th>설명</th></tr></thead><tbody><tr><td><strong>기본</strong></td><td>공유 자원, 임계 구역</td><td>문제 발생의 전제 조건 이해</td></tr><tr><td><strong>이론</strong></td><td>상호 배제, 원자성, 메모리 모델</td><td>시스템/언어 수준의 일관성 보장 개념</td></tr><tr><td><strong>실무</strong></td><td>동기화, 락, 트랜잭션</td><td>코드, 시스템 단에서 구현하는 방어 방식</td></tr><tr><td><strong>심화</strong></td><td>Lock-Free, Happens-Before</td><td>고성능 시스템에서 성능과 안정성의 균형 기법</td></tr></tbody></table><h4 id=핵심-개념의-실무-구현-연관성-및-적용-방식>핵심 개념의 실무 구현 연관성 및 적용 방식<a hidden class=anchor aria-hidden=true href=#핵심-개념의-실무-구현-연관성-및-적용-방식>#</a></h4><ol><li><p><strong>임계 구역 (Critical Section)</strong></p><ul><li>적용: 사용자 인증, 결제 처리, 세션 업데이트</li><li>방식: <code>Lock</code>, <code>synchronized</code> 키워드 (Java), <code>with</code> 문 (Python Lock)</li></ul></li><li><p><strong>상호 배제 (Mutual Exclusion)</strong></p><ul><li>적용: 파일 쓰기, 로그 기록</li><li>방식: <code>Mutex</code>, <code>Read-Write Lock</code>, <code>Semaphore</code></li></ul></li><li><p><strong>원자성 (Atomicity)</strong></p><ul><li>적용: 카운터 증가, 재고 감소, 은행 잔액 변경</li><li>방식: <code>std::atomic</code>, <code>sync/atomic</code>(Go), <code>compareAndSwap</code></li></ul></li><li><p><strong>가시성 (Visibility)</strong></p><ul><li>적용: 캐시 업데이트, 스레드 간 플래그 공유</li><li>방식: <code>volatile</code>(Java), 메모리 배리어, CPU 캐시 플러시</li></ul></li><li><p><strong>순서성 (Ordering)</strong></p><ul><li>적용: 이벤트 처리 순서 보장, 메시지 큐</li><li>방식: <code>happens-before</code>, <code>Memory Fence</code>, 순차적 일관성 모델 적용</li></ul></li><li><p><strong>Lock-Free Programming</strong></p><ul><li>적용: 고성능 큐, 로그 구조 저장소</li><li>방식: <code>CAS</code>, <code>ABA 방지</code>, <code>Hazard Pointer</code>, <code>Ring Buffer</code></li></ul></li><li><p><strong>TOCTOU, RMW 방지</strong></p><ul><li>적용: 인증, 결제 시 타이밍 공격 방지</li><li>방식: 트랜잭션, 임시 Lock 후 작업 수행</li></ul></li></ol><table><thead><tr><th>핵심 개념</th><th>적용 영역</th><th>구현 방식/도구 예시</th><th>실무 활용 예시</th></tr></thead><tbody><tr><td>임계 구역</td><td>웹 서버, 세션 관리</td><td>Python <code>with Lock</code>, Java <code>synchronized</code></td><td>사용자 세션 동시 갱신 방지</td></tr><tr><td>상호 배제</td><td>파일 시스템, 로그 기록</td><td><code>Mutex</code>, <code>ReadWriteLock</code>, <code>Semaphore</code></td><td>파일 동시 접근 방지</td></tr><tr><td>원자성</td><td>통계 집계, 재고 관리</td><td><code>AtomicInteger</code>, <code>sync/atomic</code>, CAS</td><td>실시간 카운터 증가 처리</td></tr><tr><td>가시성</td><td>캐시 동기화, 공유 변수 갱신</td><td><code>volatile</code>, Memory Barrier</td><td>분산 캐시 갱신 전파</td></tr><tr><td>순서성</td><td>이벤트 처리, 메시지 큐</td><td>Memory Fence, happens-before 모델</td><td>Kafka/AMQP 메시지 처리 순서 보장</td></tr><tr><td>Lock-Free Programming</td><td>로그 저장소, 고성능 큐</td><td>RingBuffer, CAS, ABA 방지 기법</td><td>Non-blocking 큐 사용</td></tr><tr><td>TOCTOU 방지</td><td>인증 로직, 결제 프로세스</td><td>트랜잭션, 검증 - 수행 단일 연산</td><td>중복 인증 요청 처리, 재시도 방지</td></tr></tbody></table><h3 id=기초-이해-foundation-understanding>기초 이해 (Foundation Understanding)<a hidden class=anchor aria-hidden=true href=#기초-이해-foundation-understanding>#</a></h3><h4 id=개념-정의-및-본질>개념 정의 및 본질<a hidden class=anchor aria-hidden=true href=#개념-정의-및-본질>#</a></h4><p><strong>Race Condition(경쟁 상태)</strong> 은 두 개 이상의 실행 흐름 (스레드, 프로세스, 코루틴 등) 이 <strong>공유 자원</strong>에 <strong>동시에 접근</strong>할 때, <strong>실행 순서나 타이밍의 미세한 차이</strong>에 따라 프로그램의 결과가 달라지는 <strong>비결정적 상태</strong>를 의미한다.<br>이러한 상태는 시스템에 따라 발생 여부와 결과가 달라지며, <strong>디버깅이 어렵고 간헐적으로 발생</strong>하기 때문에 심각한 <strong>논리 오류나 데이터 손실</strong>로 이어질 수 있다.<br>대표적인 패턴으로는 <strong>Read-Modify-Write</strong>와 <strong>TOCTOU(Time Of Check To Time Of Use)</strong> 가 있으며, 주로 <strong>동기화가 부재한 임계 구역 (Critical Section)</strong> 에서 발생한다.</p><pre class=mermaid>sequenceDiagram
    participant Thread A
    participant Thread B
    participant Shared Resource

    Thread A-&gt;&gt;Shared Resource: Read(X)
    Thread B-&gt;&gt;Shared Resource: Read(X)
    Thread A-&gt;&gt;Shared Resource: X + 1 → Write
    Thread B-&gt;&gt;Shared Resource: X + 1 → Write
</pre><blockquote><p>위의 시나리오에서 두 스레드는 모두 같은 값을 읽고 증가시켜 썼지만, 실제 반영된 값은 1 회만 증가되어 <strong>데이터 손실</strong>이 발생한다.</p></blockquote><ul><li>Race Condition 은 " 순서가 중요하지만 그 순서를 제어하지 않은 채 공유 자원에 접근했을 때 " 발생하는 대표적인 동시성 오류이다.</li><li>대부분의 버그는 <strong>비결정성 + 동기화 부재</strong>의 조합으로 발생한다.</li><li>이를 해결하려면 동기화뿐 아니라, <strong>정확한 설계 관점</strong>에서 조건을 분석하고, <strong>순서 보장, 가시성 확보, 원자 연산, 불변 객체 설계</strong>까지 고려해야 한다.</li></ul><h5 id=구조적-조건-발생-조건-3-요소>구조적 조건: <strong>발생 조건 3 요소</strong><a hidden class=anchor aria-hidden=true href=#구조적-조건-발생-조건-3-요소>#</a></h5><p>Race Condition 은 다음 세 가지가 모두 만족될 때 발생한다:</p><table><thead><tr><th>요소</th><th>설명</th></tr></thead><tbody><tr><td><strong>병렬 실행 흐름</strong></td><td>둘 이상의 스레드, 프로세스, 코루틴 등 동시 실행</td></tr><tr><td><strong>공유 자원 존재</strong></td><td>메모리, 파일, DB 트랜잭션, 전역 변수 등</td></tr><tr><td><strong>적절한 동기화 부재</strong></td><td>임계 구역을 보호할 락, 세마포어, 원자 연산 등이 누락되었거나 실패</td></tr></tbody></table><h5 id=내부-작동-원리-비결정성과-순서-의존성>내부 작동 원리: <strong>비결정성과 순서 의존성</strong><a hidden class=anchor aria-hidden=true href=#내부-작동-원리-비결정성과-순서-의존성>#</a></h5><ul><li><p><strong>비결정성 (Non-determinism)</strong><br>실행 시점마다 결과가 달라지는 특성. 재현이 어렵고 디버깅이 매우 힘듦.</p></li><li><p><strong>순서 의존성 (Ordering Dependency)</strong><br>실행 순서가 다르면 결과도 달라짐 → 프로그램 논리가 깨짐</p></li></ul><blockquote><p>이 특성은 특히 <strong>멀티코어 CPU</strong>, <strong>비동기 I/O</strong>, <strong>스케줄러 개입</strong>으로 인해 더욱 불안정하게 작동한다.</p></blockquote><h5 id=대표적-발생-패턴>대표적 발생 패턴<a hidden class=anchor aria-hidden=true href=#대표적-발생-패턴>#</a></h5><table><thead><tr><th>패턴 유형</th><th>설명</th><th>예시</th></tr></thead><tbody><tr><td><strong>Read‑Modify‑Write</strong></td><td>변수 읽기 → 수정 → 쓰기 과정이 원자적이지 않음</td><td><code>counter++</code></td></tr><tr><td><strong>TOCTOU</strong> (Time-Of-Check-To-Time-Of-Use)</td><td>검사 → 사용 사이에 값이 변경됨</td><td>파일 존재 확인 후 열기</td></tr><tr><td><strong>Check‑Then‑Act</strong></td><td>조건 확인 후 행동 수행 → 중간 상태 변화 가능</td><td>로그인 상태 확인 후 세션 처리</td></tr><tr><td><strong>Lock-Free 공유 자원 접근</strong></td><td>락 없이 접근할 경우 캐시/버스 충돌</td><td>원자적 CAS 실패 또는 데이터 오염</td></tr></tbody></table><h5 id=race-condition-vs-data-race-차이>Race Condition Vs Data Race 차이<a hidden class=anchor aria-hidden=true href=#race-condition-vs-data-race-차이>#</a></h5><table><thead><tr><th>구분</th><th>Race Condition</th><th>Data Race</th></tr></thead><tbody><tr><td>범위</td><td>논리적 버그 전체를 포함하는 개념</td><td>메모리 수준의 쓰기/읽기 충돌</td></tr><tr><td>발생 조건</td><td>실행 순서 의존성, 검사 - 사용 간 틈 등</td><td>두 스레드가 동시에 동일한 변수 접근 (한 쪽 이상이 쓰기)</td></tr><tr><td>해결 방식</td><td>락, 트랜잭션, 순서 보장, TOCTOU 방지 등</td><td>원자 연산, 뮤텍스, volatile, 메모리 배리어 등</td></tr></tbody></table><h5 id=메모리-모델과-가시성-문제-memory-visibility>메모리 모델과 가시성 문제 (Memory Visibility)<a hidden class=anchor aria-hidden=true href=#메모리-모델과-가시성-문제-memory-visibility>#</a></h5><p>멀티코어 환경에서는 Race Condition 이 <strong>CPU 캐시</strong>와 <strong>메모리 정합성 모델</strong>과도 관련된다.</p><ul><li>각 코어가 자체 캐시에 데이터를 저장하기 때문에, <strong>스레드 A 가 쓴 값이 스레드 B 에게 보이지 않을 수 있음</strong></li><li>이를 해결하기 위해:<ul><li>Java: <code>volatile</code>, <code>synchronized</code></li><li>C++: <code>std::atomic</code>, <code>memory_order_seq_cst</code></li><li>Go: 채널 및 atomic 연산</li></ul></li></ul><h5 id=시스템별-특이점>시스템별 특이점<a hidden class=anchor aria-hidden=true href=#시스템별-특이점>#</a></h5><table><thead><tr><th>시스템 환경</th><th>주요 이슈 및 예시</th></tr></thead><tbody><tr><td><strong>멀티스레드 서버</strong></td><td>로그인 세션 중복 생성, 사용자 데이터 덮어쓰기</td></tr><tr><td><strong>분산 시스템</strong></td><td>트랜잭션 중복 처리, 캐시 무결성 손상</td></tr><tr><td><strong>웹 애플리케이션</strong></td><td>중복 결제 요청, race-based privilege escalation</td></tr><tr><td><strong>IoT/임베디드</strong></td><td>센서 상태 이상, 인터럽트 간 데이터 경합</td></tr></tbody></table><h5 id=race-condition-이-어려운-이유>Race Condition 이 어려운 이유<a hidden class=anchor aria-hidden=true href=#race-condition-이-어려운-이유>#</a></h5><ul><li>발생 빈도가 낮고 조건이 복합적 → <strong>재현이 거의 불가능한 간헐적 버그</strong></li><li>단위 테스트에서 쉽게 포착되지 않음</li><li>타이밍, 스케줄링, 아키텍처에 민감함</li><li><strong>성능 개선</strong>을 위해 락을 제거하거나 완화하는 설계에서 자주 발생</li></ul><h5 id=시각화-예시-check-then-act>시각화 예시 (Check-Then-Act)<a hidden class=anchor aria-hidden=true href=#시각화-예시-check-then-act>#</a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 예: 로그인 세션 중복 생성</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>session_exists</span><span class=p>(</span><span class=n>user_id</span><span class=p>):</span>  <span class=c1># 스레드 A, B 모두 false로 판단</span>
</span></span><span class=line><span class=cl>    <span class=n>create_session</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>     <span class=c1># 스레드 A, B 모두 세션 생성 → 중복</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=등장-배경-및-발전-과정>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정>#</a></h4><p>Race Condition 은 처음엔 전자 회로의 물리적 신호 간섭 문제에서 출발했지만, 이후 운영체제와 병렬 시스템의 등장으로 소프트웨어 동기화 문제로 전환되었다. 특히 세마포어와 임계 구역 개념의 도입이 실질적인 문제 정의의 시작점이었다.</p><p>멀티코어, 분산 시스템, 서버리스, IoT 등 기술 환경이 복잡해질수록 Race Condition 의 양상도 다양화되고 있다. 따라서 최근에는 단순 락이 아닌, 관측성 (Observability), AI 기반 동적 제어, 자동 탐지 시스템 등 고도화된 해결책이 함께 연구되고 있는 상황이다. 이건 단순한 병렬 프로그래밍 문제가 아니라, 아키텍처 설계 전반에 영향을 미치는 핵심 이슈라고 볼 수 있다.</p><h5 id=등장-배경>등장 배경<a hidden class=anchor aria-hidden=true href=#등장-배경>#</a></h5><p>Race Condition 은 <strong>1950 년대 전자 회로 분야</strong>에서 시작되었으며, <strong>1960 년대 컴퓨터 운영체제의 멀티태스킹 개념 도입</strong>과 함께 <strong>소프트웨어 문제로 본격 부각</strong>되었다.</p><p>Dijkstra 가 제안한 <strong>세마포어와 임계 구역 (Critical Section)</strong> 개념은 동기화 문제 해결의 초석이 되었으며, 이후 <strong>멀티프로세싱 환경</strong>과 <strong>동시성 프로그래밍 모델</strong>의 발전과 함께 중요성이 높아졌다.</p><table><thead><tr><th>시기</th><th>주요 사건 및 배경</th><th>설명</th></tr></thead><tbody><tr><td>1950s</td><td>전자 회로 분야에서 Race Condition 용어 최초 등장</td><td>Huffman 의 논문에서 신호 충돌 문제로 언급</td></tr><tr><td>1960s</td><td>운영체제의 병렬 처리 개념 도입</td><td>UNIX, Multics 개발에서 동시성 문제 발생</td></tr><tr><td>1965</td><td>Edsger Dijkstra 의 세마포어 제안</td><td>동기화 및 자원 제어의 핵심 개념 정립</td></tr><tr><td>1970s-1980s</td><td>멀티스레드 OS 개발, POSIX 스레드 모델 정립</td><td>Critical Section 이론 정착</td></tr></tbody></table><h5 id=발전-과정>발전 과정<a hidden class=anchor aria-hidden=true href=#발전-과정>#</a></h5><p>멀티스레딩, 멀티코어 아키텍처의 확산을 거쳐, Race Condition 은 단일 머신을 넘어 <strong>분산 시스템</strong>으로 확장되었고, 최근에는 <strong>마이크로서비스</strong>, <strong>서버리스</strong>, <strong>IoT</strong>, <strong>클라우드 환경</strong> 등에서도 <strong>핵심 동시성 장애 요인</strong>으로 주목받고 있다. 이에 따라 <strong>Lock-Free 알고리즘</strong>, <strong>AI 기반 동기화 예측</strong>, <strong>관측성 도구</strong> 등이 주요 대응 전략으로 발전해 왔다.</p><table><thead><tr><th>시기</th><th>기술적 진화</th><th>주요 내용</th></tr></thead><tbody><tr><td>1990s-2000s</td><td>멀티코어 CPU, Thread 라이브러리 확산</td><td>Java/POSIX 등 멀티스레딩 표준 확립</td></tr><tr><td>2010s</td><td>클라우드, 분산 시스템 등장</td><td>CAP 정리, 일관성 문제와 Race 연결 강화</td></tr><tr><td>2015~현재</td><td>서버리스, 마이크로서비스, IoT 의 보편화</td><td>경량 환경에서도 동기화 문제 지속</td></tr><tr><td>2020s 이후</td><td>AI 기반 관측성, 자동 진단 도구 발전</td><td>Race Condition 대응 자동화 시도</td></tr></tbody></table><pre class=mermaid>timeline
    title Race Condition 문제 발전사
    
    1960s-1970s : 초기 멀티태스킹 시스템
                : Dijkstra의 세마포어 개념
                : Critical Section 문제 정의
    
    1980s-1990s : 개인용 컴퓨터 확산
                : 멀티스레딩 프로그래밍 모델
                : POSIX 표준화
    
    2000s-2010s : 멀티코어 시대
                : Memory Model 정립
                : Lock-free 알고리즘 발전
    
    2010s-현재  : 분산 시스템 시대
                : CAP 이론과 일관성 문제
                : 마이크로서비스 아키텍처
</pre><h4 id=발생-원인-및-문제-상황>발생 원인 및 문제 상황<a hidden class=anchor aria-hidden=true href=#발생-원인-및-문제-상황>#</a></h4><p>Race Condition 은 주로 <strong>비원자적 연산</strong>, <strong>명령어 재배열</strong>, <strong>메모리 가시성 지연</strong> 같은 기술적 요인과 <strong>멀티코어/멀티스레딩 환경</strong>, <strong>동기화 누락</strong>, <strong>순서 조건 위반</strong> 등의 설계적 오류에서 비롯된다.<br>이러한 원인은 예측 불가능한 <strong>데이터 불일치</strong>, <strong>운영 오류</strong>, <strong>보안 취약점</strong>을 초래하고, 재현이 어려워 실무에서 가장 까다로운 문제 중 하나로 여겨진다.<br>따라서 Race Condition 방지는 단순 락 구현을 넘어서 <strong>메모리 모델 이해</strong>, <strong>동기화 설계</strong>, <strong>프로그램 실행 흐름 전체에 대한 예측 가능성 확보</strong>가 핵심이다.</p><h5 id=발생-원인>발생 원인<a hidden class=anchor aria-hidden=true href=#발생-원인>#</a></h5><p>Race Condition 은 주로 <strong>비결정적인 실행 순서</strong>와 <strong>불완전한 동기화</strong>에서 발생한다.</p><p>주요 원인은 다음과 같이 분류된다:</p><ul><li><strong>기술적 원인</strong>: 비원자적 연산, 메모리 가시성, 명령어 재배열, 컴파일러/CPU 최적화</li><li><strong>환경적 요인</strong>: 멀티코어 시스템, 분산 환경, 비동기 I/O 처리, 선점형 스케줄링</li><li><strong>코드 패턴 문제</strong>: 조건문 체크와 상태 변경 사이의 틈, 복수 자원 락 순서 불일치</li></ul><table><thead><tr><th>유형</th><th>세부 원인</th><th>설명</th></tr></thead><tbody><tr><td>기술적 원인</td><td>비원자 연산</td><td><code>x = x + 1</code> 은 읽기 - 연산 - 쓰기 분리됨</td></tr><tr><td></td><td>메모리 가시성 문제</td><td>캐시 반영 지연으로 인해 다른 스레드가 옛 값 참조</td></tr><tr><td></td><td>명령어 재배열</td><td>컴파일러 또는 CPU 가 실행 순서 변경</td></tr><tr><td></td><td>False Sharing</td><td>캐시 라인 공유로 인한 간접 경합</td></tr><tr><td>환경적 요인</td><td>멀티코어/멀티프로세서 구조</td><td>병렬 실행에 따른 동시 접근 증가</td></tr><tr><td></td><td>선점형 OS 스케줄링</td><td>중간에 컨텍스트 스위치 발생 가능성</td></tr><tr><td></td><td>분산 시스템의 비동기 메시지 처리</td><td>순서 보장 없이 이벤트 도착</td></tr><tr><td>패턴 기반 프로그래밍</td><td>동기화 누락</td><td>락, 세마포어 없이 공유 변수 접근</td></tr><tr><td></td><td>if-then 레이스</td><td>체크 후 상태 변경 사이의 경합 발생</td></tr><tr><td></td><td>교차 락 (Lock Order Inversion)</td><td>여러 자원에 순서 다른 락 시도</td></tr></tbody></table><h5 id=문제-상황>문제 상황<a hidden class=anchor aria-hidden=true href=#문제-상황>#</a></h5><p>Race Condition 이 발생하면 다음과 같은 실질적인 문제가 발생한다:</p><ul><li><strong>데이터 무결성 손상</strong>: 잘못된 값이 저장되거나 연산 결과가 꼬임</li><li><strong>재현 어려운 버그</strong>: 타이밍에 따라 간헐적으로 발생해 디버깅 어려움</li><li><strong>시스템 불안정</strong>: 예기치 않은 예외, 서비스 중단, 응답 지연</li><li><strong>보안 취약점</strong>: 권한 상승, 세션 충돌, 상태 노출 등</li></ul><table><thead><tr><th>문제 유형</th><th>설명</th><th>예시</th></tr></thead><tbody><tr><td>데이터 불일치</td><td>공유 자원의 상태가 예측 불가하게 변형됨</td><td>중복 처리, 잘못된 총합</td></tr><tr><td>재현 불가 오류</td><td>특정 타이밍에서만 발생해 디버깅 어려움</td><td>테스트에서 잡히지 않음</td></tr><tr><td>서비스 불안정</td><td>시스템이 예기치 않게 멈추거나 응답 지연</td><td>API timeout, 상태 꼬임</td></tr><tr><td>보안 문제</td><td>권한 문제, 세션 혼동 등</td><td>세션 탈취, 승인 우회</td></tr></tbody></table><h4 id=주요-특징>주요 특징<a hidden class=anchor aria-hidden=true href=#주요-특징>#</a></h4><blockquote><p>Race Condition 은 다음과 같은 기술적 특징을 가지며, 각각은 시스템 실행 시 발생 조건과 구조적 제약에서 유래된다.</p></blockquote><table><thead><tr><th>구분</th><th>특징</th><th>설명</th><th>기술적 도출 근거</th></tr></thead><tbody><tr><td>실행 비결정성</td><td>비결정성 (Nondeterminism)</td><td>동일 입력에 대해 실행 순서 및 타이밍에 따라 결과 상이</td><td>병렬 처리 환경의 스케줄링 및 타이밍 차이</td></tr><tr><td>디버깅 난이도</td><td>재현 어려움 (Difficult to Reproduce)</td><td>간헐적으로 발생하며, 재현이 어려워 디버깅 난이도 높음</td><td>타이밍 조건 민감성, 환경 (코어 수, OS) 에 따라 재현 실패</td></tr><tr><td>상태 일관성</td><td>상태 불일치, 데이터 오염</td><td>동기화 실패 시 공유 자원의 상태가 충돌하여 무결성 손상</td><td>원자적 연산 누락, 동기화 누락</td></tr><tr><td>시스템 안정성</td><td>시스템 불안정성</td><td>Race Condition 으로 인해 시스템 오작동, 다운, 무한 루프 발생 가능</td><td>상태 전이 충돌, 동시 접근 실패</td></tr><tr><td>성능/확장성 문제</td><td>성능 저하, 확장성 한계</td><td>동기화 및 경합 해결을 위한 오버헤드 증가로 인해 시스템 처리량 제한</td><td>락, 세마포어 경쟁, 임계 구역 병목 발생</td></tr><tr><td>실행 환경 의존</td><td>스케줄러 및 환경 의존성</td><td>동일 코드라도 OS, 하드웨어 환경, 코어 수에 따라 전혀 다른 결과를 나타냄</td><td>OS 의 스레드/프로세스 스케줄링, 캐시 정책, 인터럽트 우선순위 등</td></tr></tbody></table><p>Race Condition 은 멀티스레드 환경에서 가장 까다로운 문제 중 하나로, 실행 결과가 타이밍과 순서에 따라 달라지는 <strong>비결정적 특성</strong>을 가지고 있어 <strong>재현과 디버깅이 어렵고</strong>, <strong>상태 불일치와 시스템 불안정성</strong>을 초래한다.<br>또한 락 기반 동기화가 필요하나, 이는 <strong>성능 저하 및 확장성 제한</strong>으로 이어질 수 있으며, 환경적 요인 (코어 수, OS 스케줄링 정책 등) 에 따라 문제 발생 여부가 달라진다는 점에서 <strong>테스트의 완전성을 확보하기 어렵다</strong>는 특징도 가진다.</p><h3 id=핵심-이론-core-theory>핵심 이론 (Core Theory)<a hidden class=anchor aria-hidden=true href=#핵심-이론-core-theory>#</a></h3><h4 id=핵심-설계-원칙>핵심 설계 원칙<a hidden class=anchor aria-hidden=true href=#핵심-설계-원칙>#</a></h4><ul><li><p><strong>원자성 보장</strong>:<br>모든 공유 자원에 대한 연산은 중간에 중단 없이 한 번에 수행되어야 하며, 실패 시 상태를 복구할 수 있어야 한다.</p></li><li><p><strong>상호 배제</strong>:<br>공유 자원에는 반드시 하나의 실행 흐름만 접근할 수 있도록 보장되어야 한다. Mutex, Lock 이 대표적 수단이다.</p></li><li><p><strong>임계 구역 최소화</strong>:<br>임계 구역은 가능한 한 짧고 명확하게 정의해야 한다. 동기화 범위가 넓을수록 경합과 성능 저하 발생 가능성 증가.</p></li><li><p><strong>가시성 확보</strong>:<br>연산 결과는 모든 스레드가 동일하게 관찰할 수 있어야 하며, 이는 메모리 배리어나 volatile 변수 등을 통해 보장된다.</p></li><li><p><strong>순서 보존</strong>:<br>연산 간 순서를 변경하지 않아야 하며, happens-before 관계를 유지하기 위해 메모리 배리어를 활용한다.</p></li><li><p><strong>진전성 (Progress)</strong>:<br>하나의 스레드가 자원 점유로 전체 시스템이 멈추지 않도록 보장되어야 한다. Deadlock 및 Livelock 방지 필요.</p></li><li><p><strong>공정성 (Fairness) 및 한정 대기 (Bounded Waiting)</strong>:<br>어떤 실행 흐름도 무한히 기다리지 않도록 해야 하며, 우선순위 기반 접근이 필요할 수 있다.</p></li></ul><table><thead><tr><th>설계 원칙</th><th>설명</th><th>관련 기술/개념</th></tr></thead><tbody><tr><td>원자성 보장</td><td>연산 단위를 나누지 않고 한 번에 실행 또는 실패로 처리</td><td>Compare-And-Swap, Atomic Operation</td></tr><tr><td>상호 배제</td><td>공유 자원에 하나의 실행 흐름만 접근하도록 제어</td><td>Mutex, Semaphore, Lock</td></tr><tr><td>임계 구역 최소화</td><td>동기화 영역을 최소화해 성능 병목과 Deadlock 가능성 축소</td><td><code>synchronized</code> block 최소화, fine-grained lock</td></tr><tr><td>가시성 확보</td><td>연산 결과가 다른 스레드에 즉시 반영되도록 보장</td><td>Memory Barrier, volatile, flush cache</td></tr><tr><td>순서 보존</td><td>명령 실행 순서가 컴파일러/CPU 최적화로 변경되지 않도록 보장</td><td>Happens-before, memory ordering</td></tr><tr><td>진전성 확보 (Progress)</td><td>어떤 실행 흐름도 무한 대기 상태에 빠지지 않도록 보장</td><td>Deadlock 회피, Spin lock 시간 제한</td></tr><tr><td>공정성 및 대기 한정</td><td>무기한 대기를 방지하고 스레드 간 자원 접근에 공정성을 유지</td><td>Round-Robin, Priority Queue</td></tr></tbody></table><p>Race Condition 을 방지하기 위한 설계는 단순히 락을 사용하는 수준이 아니라, <strong>원자성, 가시성, 순서 보존, 상호 배제</strong> 같은 이론적 기초 위에, **실무적 성능 고려 (임계 구역 최소화, 경합 완화, 공정성 보장)**를 결합해야 한다.<br>락 기반이든, lock-free 기반이든 간에, <strong>타이밍 문제와 상태 경쟁을 제어하는 총체적 설계 전략</strong>이 필요하며, 이는 시스템의 안정성과 신뢰성 확보의 근간이 된다.</p><h4 id=기본-원리-및-동작-메커니즘>기본 원리 및 동작 메커니즘<a hidden class=anchor aria-hidden=true href=#기본-원리-및-동작-메커니즘>#</a></h4><h5 id=기본-원리>기본 원리<a hidden class=anchor aria-hidden=true href=#기본-원리>#</a></h5><table><thead><tr><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>공유 자원 (Shared Resource)</strong></td><td>둘 이상의 스레드/프로세스가 동시에 접근하는 대상 (변수, 파일 등)</td></tr><tr><td><strong>비원자적 연산 (Non-atomic)</strong></td><td><code>Read → Modify → Write</code> 단계가 분리되어 경합 발생 가능</td></tr><tr><td><strong>동기화 누락</strong></td><td>락, 세마포어, 원자 연산 등의 보호 장치 없이 접근</td></tr><tr><td><strong>실행 순서 미보장</strong></td><td>실행 흐름 간 순서가 불확실하여 예측 불가 결과 초래</td></tr><tr><td><strong>결과 영향</strong></td><td>데이터 손상, 논리 오류, 보안 취약성, 재현 어려움 등</td></tr></tbody></table><h5 id=동작-메커니즘>동작 메커니즘<a hidden class=anchor aria-hidden=true href=#동작-메커니즘>#</a></h5><pre class=mermaid>sequenceDiagram
    participant T1 as Thread 1
    participant T2 as Thread 2
    participant R as Shared Resource
    participant L as Lock System

    T1-&gt;&gt;R: Read counter (100)
    T2-&gt;&gt;R: Read counter (100)
    T1-&gt;&gt;R: Compute +1 → 101
    T2-&gt;&gt;R: Compute +1 → 101
    T1-&gt;&gt;R: Write 101
    T2-&gt;&gt;R: Write 101 (overwrite)
    Note over R: 예상 결과: 102 / 실제 결과: 101 (손실 발생)

    alt With Synchronization
        T1-&gt;&gt;L: Acquire Lock
        L--&gt;&gt;T1: Granted
        T1-&gt;&gt;R: Read/Write
        T1-&gt;&gt;L: Release Lock
        T2-&gt;&gt;L: Acquire Lock
        L--&gt;&gt;T2: Granted
        T2-&gt;&gt;R: Read/Write
    end
</pre><p>Race Condition 은 여러 실행 흐름이 공유 자원에 동시에 접근할 때, 순서와 타이밍의 불확실성으로 인해 예기치 않은 결과가 발생하는 문제이다. 이는 대개 <strong>비원자적 연산</strong>과 <strong>동기화 누락</strong>에서 비롯되며, 결과적으로 데이터 손상, 예외 동작, 보안 취약성을 유발할 수 있다. 이런 문제를 방지하기 위해선 <strong>Mutex, 세마포어, 원자 연산, 메모리 장벽</strong> 등 동기화 메커니즘을 설계 초기부터 체계적으로 적용해야 한다. Race Condition 은 단순한 기술적 실수가 아니라, 시스템 신뢰성과 안정성을 위한 핵심 구조적 고려사항이다.</p><h4 id=race-condition-방지를-위한-아키텍처-및-구성-요소>Race Condition 방지를 위한 아키텍처 및 구성 요소<a hidden class=anchor aria-hidden=true href=#race-condition-방지를-위한-아키텍처-및-구성-요소>#</a></h4><pre class=mermaid>graph TD

    subgraph Application Layer
        A1[Thread / Process]
        A2[Shared Resource Access Code]
    end

    subgraph Synchronization Layer
        B1[Critical Section Manager]
        B2[Mutex / Semaphore / Atomic]
        B3[&#34;Memory Model (Ordering)&#34;]
    end

    subgraph Runtime Layer
        C1[Thread Scheduler]
        C2[Lock Manager]
        C3[Memory Visibility Controller]
    end

    subgraph Monitoring Layer
        D1[Race Detector]
        D2[Performance Profiler]
    end

    A1 --&gt; A2
    A2 --&gt; B1
    B1 --&gt; B2
    B2 --&gt; B3
    B1 --&gt; C1
    B2 --&gt; C2
    B3 --&gt; C3

    A1 --&gt; D1
    C1 --&gt; D2
</pre><h5 id=구성-요소>구성 요소<a hidden class=anchor aria-hidden=true href=#구성-요소>#</a></h5><table><thead><tr><th>구성 요소</th><th>필수 여부</th><th>설명</th><th>역할</th><th>기능 및 특징</th></tr></thead><tbody><tr><td><strong>임계 구역</strong> (Critical Section)</td><td>✅ 필수</td><td>공유 자원에 접근하는 코드 블록</td><td>경합 대상 보호</td><td>비원자적 연산이 발생하는 핵심 구간</td></tr><tr><td><strong>동기화 객체</strong> (Mutex, Semaphore, Atomic)</td><td>✅ 필수</td><td>임계구역 진입 제어 수단</td><td>상호 배제, 자원 동기화</td><td>락/세마포어/원자 연산 기반 보호</td></tr><tr><td><strong>실행 흐름</strong> (Thread, Process)</td><td>✅ 필수</td><td>동시 실행되는 주체</td><td>공유 자원 접근</td><td>OS 스케줄링 대상, 병렬 처리 흐름 구성</td></tr><tr><td><strong>공유 자원</strong> (Memory, File 등)</td><td>✅ 필수</td><td>다수 흐름이 접근하는 데이터 또는 객체</td><td>보호 대상</td><td>일관성 보장이 필요한 접근 지점</td></tr><tr><td><strong>메모리 모델</strong> (Memory Order)</td><td>✅ 필수</td><td>CPU/컴파일러 재정렬 방지 규칙 설정</td><td>순서 일관성 보장</td><td><code>volatile</code>, memory barriers 등으로 구현 가능</td></tr><tr><td><strong>락 관리자</strong> (Lock Manager)</td><td>선택</td><td>락 획득/해제의 상태 추적 및 제어</td><td>경합 상태 진단, 락 충돌 방지</td><td>대기 큐/우선순위 기반 락 정책 지원</td></tr><tr><td><strong>성능 진단기</strong> (Profiler, Tracer)</td><td>선택</td><td>시스템 경합 감지 및 병목 파악</td><td>병목 탐지, 성능 최적화</td><td>eBPF, tracing 도구로 경합 지점 시각화</td></tr><tr><td><strong>이벤트 기반 큐</strong> (Message Queue)</td><td>선택</td><td>직접 접근 대신 이벤트 흐름으로 구성</td><td>경합 분산, 병렬 처리</td><td>Kafka, RabbitMQ, Go Channel 등 비동기 처리 지원</td></tr><tr><td><strong>Deadlock/Race Detector</strong></td><td>선택</td><td>경합/교착 상태 탐지 도구</td><td>이상 상태 조기 탐지</td><td>ThreadSanitizer, Helgrind 등 도구 존재</td></tr></tbody></table><p>Race Condition 방지를 위한 아키텍처는 크게 네 계층으로 구성된다:</p><ul><li>실행 주체 (스레드/프로세스)</li><li>임계 구역 및 동기화 메커니즘</li><li>런타임 제어 및 메모리 일관성</li><li>경합 감지와 성능 분석을 위한 진단 도구</li></ul><p>이 구성 요소들은 단순히 경합을 막는 기능을 넘어서 시스템의 신뢰성과 확장성에 직접적인 영향을 미치며, 선택적 요소로는 메시지 큐 기반 처리나 성능 프로파일링 시스템을 통해 Race Condition 을 우회하거나 사전 탐지할 수 있는 현대적 방식들이 활용되고 있다.</p><h4 id=주요-기능과-역할>주요 기능과 역할<a hidden class=anchor aria-hidden=true href=#주요-기능과-역할>#</a></h4><ul><li><strong>프로세스/스레드 관리</strong>: 병행 실행 단위가 자원에 접근하는 주체로, 이들의 실행 순서를 제어함으로써 경쟁 조건을 방지함</li><li><strong>공유 자원 관리</strong>: 읽기/쓰기 충돌이 발생하는 대상으로, 접근 제한과 제어가 필요함</li><li><strong>동기화 프리미티브 (락, 세마포어 등)</strong>: 자원 접근에 대한 규칙을 제공하고, 하나의 실행 흐름만 접근하게 보장</li><li><strong>임계 구역 설정</strong>: 공유 자원을 수정하는 중요한 코드 영역으로, 보호되지 않으면 데이터 무결성 손상 위험</li><li><strong>상태 추적 메커니즘</strong>: 데이터의 변경 이력 및 시점 간 동기화 기능 (예: 로그, 트랜잭션 ID, 타임스탬프)</li><li><strong>경쟁 조건 감지 및 예외 처리</strong>: Race Condition 을 실시간 혹은 사후에 식별하여 대응 가능해야 함</li></ul><table><thead><tr><th>기능</th><th>역할</th><th>발생 시점</th><th>관련 컴포넌트</th></tr></thead><tbody><tr><td>프로세스/스레드 제어</td><td>실행 흐름 순서 보장</td><td>실행 전/중</td><td>OS, 런타임 스케줄러</td></tr><tr><td>공유 자원 보호</td><td>충돌 방지, 데이터 무결성 유지</td><td>실행 중</td><td>메모리, DB, 캐시</td></tr><tr><td>동기화 프리미티브 적용</td><td>상호 배제 보장, Race Condition 방지</td><td>접근 직전</td><td>Lock, Mutex, Semaphore</td></tr><tr><td>임계 구역 정의 및 보호</td><td>중요한 연산 단위 구획화, 병목 최소화</td><td>코드 설계 시</td><td>애플리케이션 로직</td></tr><tr><td>상태 추적 및 기록</td><td>디버깅, 장애 분석, 이벤트 인과 관계 확인</td><td>실행 중/후</td><td>로그 시스템, APM, 트레이싱</td></tr><tr><td>Race Condition 감지/대응</td><td>비정상 흐름 탐지 및 시스템 보호</td><td>사후 분석 또는 실시간 탐지</td><td>ELK, Jaeger, Prometheus, Datadog</td></tr></tbody></table><p>Race Condition 의 주요 기능과 역할은 단순한 락 처리나 코드 보호에 그치지 않고, 실행 흐름 제어, 자원 보호, 타이밍 조정, 예외 감지까지 전방위적으로 이루어진다.<br>각 기능은 시스템의 신뢰성과 일관성을 확보하기 위해 유기적으로 연결되며, 실시간 또는 사후 분석을 위한 상태 추적 기능까지 포함되어야 한다.<br>즉, Race Condition 방지는 단일 메커니즘이 아닌 <strong>통합적 실행 흐름 관리 체계</strong>를 설계하는 과정이다.</p><h3 id=특성-분석-characteristics-analysis>특성 분석 (Characteristics Analysis)<a hidden class=anchor aria-hidden=true href=#특성-분석-characteristics-analysis>#</a></h3><h4 id=예방-및-해결-방안>예방 및 해결 방안<a hidden class=anchor aria-hidden=true href=#예방-및-해결-방안>#</a></h4><table><thead><tr><th>구분</th><th>해결 방안</th><th>설명</th><th>적용 사례 / 기술</th></tr></thead><tbody><tr><td><strong>전통적 동기화</strong></td><td>Mutex / Lock</td><td>상호 배제를 통한 임계구역 보호</td><td>Java <code>synchronized</code>, POSIX mutex</td></tr><tr><td></td><td>Atomic Operation</td><td>단일 연산으로 경쟁 상태 제거</td><td>C++ <code>std::atomic</code>, Go <code>sync/atomic</code></td></tr><tr><td></td><td>Memory Barrier</td><td>명령어 재배열 및 가시성 문제 방지</td><td>C/C++ <code>std::atomic_thread_fence</code></td></tr><tr><td><strong>비동기 설계</strong></td><td>Message Queue</td><td>직접 자원 접근 대신 메시지 전달</td><td>Kafka, RabbitMQ, Go Channel</td></tr><tr><td></td><td>Event-Driven / Loop</td><td>순차 실행으로 동시성 제어</td><td>Node.js Event Loop, Reactor Pattern</td></tr><tr><td></td><td>Actor Model</td><td>캡슐화된 상태 + 메시지 기반 처리</td><td>Akka, Erlang, Microsoft Orleans</td></tr><tr><td><strong>함수형 방식</strong></td><td>Immutable Object</td><td>변경 불가 구조로 공유 상태 자체 제거</td><td>Clojure, Scala, Java Record, Rust 구조체</td></tr><tr><td></td><td>Thread Local Storage</td><td>독립 데이터 공간으로 공유자원 회피</td><td><code>ThreadLocal&lt;T></code> in Java</td></tr><tr><td><strong>트랜잭션 기반</strong></td><td>데이터베이스 트랜잭션</td><td>ACID 보장으로 일관성 확보</td><td>SQL, ORM <code>@Transactional</code></td></tr><tr><td></td><td>소프트웨어 트랜잭셔널 메모리</td><td>변수 접근을 트랜잭션처럼 처리</td><td>Clojure STM, Haskell STM</td></tr><tr><td><strong>자동화 기술</strong></td><td>Race Detector</td><td>경합 탐지 도구로 사전 대응</td><td>ThreadSanitizer, Helgrind, Intel Inspector</td></tr><tr><td></td><td>형식 검증</td><td>실행 전 상태 전이 모델 분석</td><td>TLA+, SPIN, Alloy</td></tr></tbody></table><p>Race Condition 을 예방하기 위한 전략은 크게 <strong>전통적 동기화 방식</strong>, <strong>비공유/비동기 아키텍처</strong>, <strong>트랜잭션 처리 기반 설계</strong>, 그리고 <strong>자동화된 탐지 및 검증 기술</strong>로 나뉜다. 각 기술은 시스템 성격과 요구 성능에 따라 선택적으로 적용되며, 최근에는 Actor Model, Immutable Object, Race Detector 등의 비동기 및 자동화 접근법이 점점 주류를 이루고 있다. 특히 고성능 시스템이나 클라우드 환경에선 락 없는 알고리즘과 메시지 기반 구조가 Race Condition 방지에 효과적인 해법으로 자리잡고 있다.</p><h4 id=발생-시-영향-및-피해>발생 시 영향 및 피해<a hidden class=anchor aria-hidden=true href=#발생-시-영향-및-피해>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지/진단 기법</th><th>예방 방법</th><th>해결 기법</th></tr></thead><tbody><tr><td>무결성 손상</td><td>데이터 오염 / 손상</td><td>동기화 실패, 비원자적 연산</td><td>계산 오류, 로그 불일치, 서비스 오류</td><td>유닛 테스트, 로그 분석, 체크섬</td><td>원자적 연산, 임계 구역 최소화</td><td>트랜잭션 처리, CAS, Mutex</td></tr><tr><td>예외 및 장애</td><td>예외 발생, 상태 불일치</td><td>경쟁 조건 누적, 리소스 상태 변경</td><td>Null, Index 오류, 프로세스 크래시</td><td>트레이스 로그, Alert 시스템</td><td>동기화 설계 강화, 예외 처리 체계화</td><td>재시도 로직, 장애 복구 루틴 포함</td></tr><tr><td>보안 위협</td><td>인증 우회, 정보 유출</td><td>검사 - 사용 사이 시간차 (TOCTOU), 접근 통제 실패</td><td>권한 상승, 민감 데이터 노출</td><td>정적 분석, 동적 침투 테스트</td><td>민감 자원에 대한 동기화, 역할 기반 접근 제어</td><td>메모리 격리, 보안 토큰 동기화</td></tr><tr><td>성능 불안정</td><td>지연 증가, 병목</td><td>동시성 충돌, 스핀락, 재시도 충돌</td><td>응답 지연, 서버 과부하</td><td>분산 트레이싱, APM, 히트맵 분석</td><td>락 최소화, 백오프 전략</td><td>락 분해, 동적 우선순위 부여</td></tr><tr><td>진단 불가</td><td>간헐적 오류, 시차 발생</td><td>타이밍 민감성, 동기화 간극</td><td>재현 어려움, QA 실패</td><td>Chaos 테스트, 히스토리 리플레이</td><td>시나리오 기반 회귀 테스트</td><td>실행 순서 기록, 자동화 경합 탐지 도구 사용</td></tr><tr><td>중복 실행 문제</td><td>이중 처리, 중복 결제</td><td>상태 비일관성, 멱등성 부족</td><td>서비스 비용 낭비, 사용자 혼란</td><td>API 호출 이력 추적, DB 로그 분석</td><td>Idempotent 설계, 키 기반 중복 방지</td><td>UUID 키, 타임스탬프 체크, 메시지 큐 사용</td></tr></tbody></table><p>Race Condition 이 발생하면 <strong>데이터 무결성 훼손, 시스템 오류, 보안 위협, 성능 저하, 재현 어려움</strong> 등 실질적이고 심각한 문제가 발생한다. 특히 이슈가 간헐적이고 예측이 어려운 경우가 많아, 탐지와 진단이 어렵고 QA 단계에서 놓치기 쉽다. 이를 방지하기 위해서는 설계 단계에서부터 동기화 정책, 접근 제어, 트랜잭션 처리, Idempotent 처리 등을 철저히 해야 하며, 운영 중에는 APM, 분산 트레이싱, 경합 탐지 도구 등을 활용해 실시간 감시 및 대응 체계를 마련하는 것이 중요하다.</p><h4 id=트레이드오프-관계-분석>트레이드오프 관계 분석<a hidden class=anchor aria-hidden=true href=#트레이드오프-관계-분석>#</a></h4><ul><li><p><strong>안정성 vs 성능</strong><br>동기화 로직이 많아질수록 데이터 일관성은 높아지지만, 그만큼 시스템 처리량과 응답 시간이 저하됨.</p></li><li><p><strong>정확성 vs 확장성</strong><br>분산 시스템에서 Strong Consistency 를 보장하면 글로벌 락이나 트랜잭션 비용이 커져 확장성이 제한됨.</p></li><li><p><strong>간결성 vs 복잡성</strong><br>단순한 코드 구조는 이해하기 쉬우나 경쟁 조건에 대한 세밀한 제어가 어렵고, 동시성 버그를 놓칠 수 있음.</p></li><li><p><strong>비동기 메시징 vs 동기적 제어</strong><br>메시지 큐 기반 설계는 Race Condition 회피에 유리하지만, 처리 지연 (latency) 과 복잡도 증가 초래.</p></li><li><p><strong>Lock-Free 설계 vs 유지보수성</strong><br>Lock-Free 는 성능에 유리하나 로직이 복잡해 디버깅과 테스트가 어려움.</p></li></ul><table><thead><tr><th>트레이드오프 항목</th><th>선택 시 장점</th><th>단점 또는 고려사항</th><th>대표 적용 사례</th></tr></thead><tbody><tr><td><strong>동기화 강화 vs 성능 저하</strong></td><td>데이터 정합성 보장, 오류 예방</td><td>락 충돌, 응답 지연</td><td>뱅킹 시스템, 결제 처리</td></tr><tr><td><strong>정확성 vs 확장성</strong></td><td>글로벌 일관성 보장</td><td>글로벌 락/트랜잭션 비용 증가</td><td>분산 데이터베이스, Paxos, Raft</td></tr><tr><td><strong>간결한 구조 vs Race 회피</strong></td><td>코드 가독성, 빠른 개발</td><td>Race Condition 제어 누락 위험</td><td>초기 MVP 개발, 간단한 API 서버</td></tr><tr><td><strong>비동기 처리 vs 지연 증가</strong></td><td>경합 완화, 비차단 구조로 확장성 우수</td><td>메시지 순서 문제, 지연 시간 발생</td><td>Kafka, RabbitMQ 기반 비동기 아키텍처</td></tr><tr><td><strong>Lock-Free vs Lock 기반 설계</strong></td><td>병렬 처리 극대화, 데드락 회피</td><td>복잡한 상태 관리, CAS 실패 반복 시 오히려 비효율적</td><td>고성능 게임 엔진, 실시간 트레이딩 시스템</td></tr><tr><td><strong>이벤트 기반 설계 vs 디버깅 난이도</strong></td><td>Race Condition 발생 확률 감소</td><td>흐름 추적 복잡, 예외 처리가 어려움</td><td>Node.js 백엔드, 게임 서버</td></tr><tr><td><strong>Consistency vs Availability</strong></td><td>강한 일관성 (Serializable 트랜잭션 등) 보장</td><td>가용성 포기, 네트워크 파티션 시 서비스 불능</td><td>금융/보안 시스템, ACID 기반 트랜잭션 시스템</td></tr></tbody></table><p>Race Condition 대응은 단일 해법이 아닌 <strong>복수의 설계 기준 간 균형</strong>이 필요한 문제이다.<br>동기화 강도, 일관성 모델, 아키텍처 구조를 어떻게 선택하느냐에 따라 성능, 확장성, 유지보수성이 서로 영향을 주고받는다.<br>따라서 설계자는 <strong>어떤 특성을 최우선으로 둘 것인가</strong>를 먼저 정의하고, 그에 따른 트레이드오프를 인식하며 선택해야 한다.</p><p>예를 들어, 금융 시스템에서는 정합성을 우선하지만 IoT 시스템은 지연과 확장성이 중요할 수 있다.<br>결국 모든 요소는 <strong>목표 도메인과 시스템 특성에 따라 맞춤형으로 조정</strong>되어야 한다.</p><pre class=mermaid>graph TB
    A[Performance 성능] &lt;--&gt; B[Safety 안전성]
    C[Scalability 확장성] &lt;--&gt; D[Consistency 일관성]
    E[Complexity 복잡성] &lt;--&gt; F[Maintainability 유지보수성]
    
    A -.-&gt;|동기화 오버헤드| B
    C -.-&gt;|분산 일관성 비용| D
    E -.-&gt;|정교한 동기화 설계| F
    
    subgraph &#34;최적화 전략&#34;
        G[Fine-grained Locking]
        H[Lock-free Programming]
        I[Eventual Consistency]
    end
</pre><h3 id=구현-및-분류-implementation--classification>구현 및 분류 (Implementation & Classification)<a hidden class=anchor aria-hidden=true href=#구현-및-분류-implementation--classification>#</a></h3><h4 id=시스템-설계-시-race-condition-예방-전략>시스템 설계 시 Race Condition 예방 전략<a hidden class=anchor aria-hidden=true href=#시스템-설계-시-race-condition-예방-전략>#</a></h4><p>Race Condition 은 코드 수준에서만 해결할 문제가 아니라, <strong>아키텍처 설계 단계</strong>에서부터 구조적으로 고려해야 하는 문제이다.</p><table><thead><tr><th>전략</th><th>설명</th><th>적용 사례 / 기술</th></tr></thead><tbody><tr><td><strong>상태 비공유 (State Isolation)</strong></td><td>공유 자원을 아예 피하는 구조. 각 요청 또는 작업마다 상태 복제 후 병합</td><td>CQRS, 이벤트 소싱</td></tr><tr><td><strong>Idempotency 보장</strong></td><td>재시도되거나 중복된 요청이라도 결과가 동일해야 Race 영향을 피할 수 있음</td><td>결제 API, 이메일 전송</td></tr><tr><td><strong>비동기 처리 및 큐 활용</strong></td><td>작업 순서를 보장하기 위해 메시지 큐 또는 이벤트 버스를 활용하여 직렬화 수행</td><td>Kafka, RabbitMQ</td></tr><tr><td><strong>원자성 보장</strong></td><td>여러 작업을 하나의 트랜잭션 또는 원자 연산으로 묶어서 처리</td><td>DB 트랜잭션, Redis Lua</td></tr><tr><td><strong>락 분산 전략</strong></td><td>하나의 자원에 대한 접근을 락 또는 CAS 연산으로 제한</td><td>Redlock, ZooKeeper</td></tr><tr><td><strong>작업 분할 (Sharding)</strong></td><td>자원을 분산시켜 병렬 처리를 수행하면서도 공유 상태 충돌을 줄임</td><td>사용자 ID 기반 샤딩</td></tr><tr><td><strong>불변 구조 설계</strong></td><td>상태를 수정하지 않고 새 객체 생성 방식으로 변경 → 공유 불가 구조</td><td>Functional Programming</td></tr></tbody></table><h4 id=경쟁-상태-탐지-및-대응-기법>경쟁 상태 탐지 및 대응 기법<a hidden class=anchor aria-hidden=true href=#경쟁-상태-탐지-및-대응-기법>#</a></h4><p>각 대응 전략은 목적과 상황에 따라 다르게 선택되어야 한다:</p><ul><li>성능 우선: Lock-free, 메시지 기반 처리</li><li>정합성 우선: 트랜잭션 기반, 동기화 프리미티브</li><li>디버깅/품질 확보: 동적 분석, 테스트 전략</li><li>개발 초기 위험 차단: 정적 분석 도구</li></ul><h5 id=탐지진단>탐지/진단<a hidden class=anchor aria-hidden=true href=#탐지진단>#</a></h5><table><thead><tr><th>분류</th><th>정의</th><th>구성 요소 / 기술</th><th>원리</th><th>목적</th><th>사용 상황</th><th>특징</th></tr></thead><tbody><tr><td>정적 분석 도구</td><td>코드 분석을 통해 잠재적 경합 조건을 탐색</td><td>Clang Static Analyzer, SpotBugs, Rust 소유권 시스템</td><td>AST, 데이터 흐름, 락 순서 분석</td><td>사전 Race 방지</td><td>빌드/CI 단계 코드 리뷰</td><td>빠름, false-positive 가능성 있음</td></tr><tr><td>동적 분석 도구</td><td>실행 중 메모리 접근이나 스레드 상호작용을 기반으로 Race 감지</td><td>ThreadSanitizer, Intel Inspector, Helgrind</td><td>런타임 메모리/스레드 추적</td><td>실제 Race 탐지</td><td>테스트, 디버깅 환경</td><td>고정밀, 실행 오버헤드 있음</td></tr><tr><td>테스트 전략</td><td>다양한 실행 시나리오로 Race 재현 및 검증</td><td>Chaos Engineering, Property‑based, Model Checking</td><td>실행 경로 직접 유도</td><td>Race 조건 재현 및 검증</td><td>복잡한 비동기/분산 구조 검증</td><td>재연 가능성 확보, 자동화 어려움</td></tr></tbody></table><ol><li><p><strong>정적 분석 도구</strong></p><ul><li><strong>실제 사례</strong>:<ul><li><strong>Google Chrome</strong> 팀은 <code>Clang Thread Safety Analysis</code> 를 활용하여 C++ 코드에서 어노테이션 기반 경쟁 상태 검사를 적용.</li><li><strong>Rust</strong> 언어 자체는 정적 분석 기반의 소유권 시스템을 컴파일 타임에 적용해 Race 를 원천적으로 방지.</li></ul></li><li><strong>심화 설명</strong>:<ul><li>AST(Abstract Syntax Tree) 기반으로 락 사용 여부, 변수 공유 여부 등을 추적</li><li><code>@GuardedBy</code>, <code>@ThreadSafe</code> 같은 어노테이션을 통해 의도를 명시하고 검출</li><li>한계: false-positive 많고, 런타임 경합은 놓침 → 반드시 보완용으로만 활용해야 함</li></ul></li></ul></li><li><p><strong>동적 분석 도구</strong>:</p><ul><li><strong>실제 사례</strong>:<ul><li><strong>LLVM 의 ThreadSanitizer (TSan)</strong> 은 Go 및 C/C++ 에서 가장 많이 쓰이며, Go 에서 <code>go test -race</code> 는 TSan 기반.</li><li><strong>Valgrind 의 Helgrind</strong> 는 멀티스레드 C 코드에서 락 경쟁을 탐지.</li></ul></li><li><strong>심화 설명</strong>:<ul><li>메모리 접근을 shadow memory 로 추적해 인터리빙 상태 분석</li><li>TSan 은 false-negative 는 적지만 성능 오버헤드가 큼 (2~10 배 느려짐)</li><li>실제 발생 가능한 Race 를 탐지해 정확도가 높음 → CI/CD 에 selective 하게 포함 추천</li></ul></li></ul></li><li><p><strong>테스트 전략 (Chaos / Property-based / 모델 기반)</strong>:</p><ul><li><strong>실제 사례</strong>:<ul><li><strong>Netflix</strong>는 Chaos Monkey 를 통해 실시간 장애 및 경쟁 상황을 의도적으로 유도</li><li><strong>Quviq QuickCheck</strong>(Erlang/Elixir) 는 상태 모델 기반으로 병행 로직을 무작위 테스트함</li></ul></li><li><strong>심화 설명</strong>:<ul><li>Property-based Testing 은 invariant(불변 조건) 를 정의하고 수천 개 입력으로 탐색</li><li>모델 기반 검증은 상태 전이를 명세 → 실제 시스템 동작과 비교</li><li>한계: 복잡한 시스템에서는 Coverage 보장이 어렵고, 설계 비용이 큼</li></ul></li></ul></li></ol><h5 id=race-condition-대응-구현-기법>Race Condition 대응 구현 기법<a hidden class=anchor aria-hidden=true href=#race-condition-대응-구현-기법>#</a></h5><table><thead><tr><th>분류</th><th>정의</th><th>구성 요소 / 기술</th><th>원리</th><th>목적</th><th>사용 상황</th><th>특징</th></tr></thead><tbody><tr><td>동기화 프리미티브 적용</td><td>공유 자원 접근 시 락 기반 통제 적용</td><td>Mutex, Semaphore, Monitor</td><td>상호 배제, 락 제어</td><td>Race Condition 차단</td><td>멀티스레드 환경</td><td>단순하지만 성능 오버헤드 있음</td></tr><tr><td>Lock‑free 설계</td><td>락 없이 원자 연산 기반 경쟁 회피 구조 설계</td><td>CAS, Atomic 유형, Ring Buffer</td><td>낙관적 동시성 (Optimistic Concurrency)</td><td>고성능 처리 중 충돌 최소화</td><td>실시간 처리, 병목 없는 큐 구조</td><td>설계 복잡, 테스트/디버깅 어려움</td></tr><tr><td>메시지 기반 비동기</td><td>공유 자원 사용 대신 메시지 전달 통한 비동기 처리 방식</td><td>Message Queue, Actor Model (Event Loop)</td><td>메시지 순차 처리</td><td>데이터 경합 제거, 시스템 분리</td><td>분산 시스템, 마이크로서비스 아키텍처</td><td>지연 가능성, 흐름 추적 어려움</td></tr><tr><td>트랜잭션 기반 처리</td><td>데이터베이스 트랜잭션 격리를 통한 상태 무결성 보장</td><td>DB 트랜잭션, 격리 레벨, ACID 보장 프로토콜</td><td>원자 트랜잭션, Rollback 기능</td><td>데이터 무결성 확보</td><td>금융, 데이터 중심 시스템</td><td>비용 높음, 분산 환경에서 복잡도 증가</td></tr></tbody></table><ol><li><p><strong>동기화 프리미티브 적용 (Mutex, Semaphore 등)</strong>:</p><ul><li><strong>실제 사례</strong>:<ul><li><strong>Python</strong>의 GIL 은 내부적으로 하나의 스레드만 Python 바이트코드를 실행하게 함</li><li><strong>Java</strong>는 <code>synchronized</code>, <code>ReentrantLock</code>, <code>Semaphore</code> 등을 제공</li></ul></li><li><strong>심화 설명</strong>:<ul><li>뮤텍스는 상호 배제, 세마포어는 접근량 제어 목적</li><li>설계 시 고려 요소: Lock Contention, Deadlock, Starvation</li><li>한계: 동기화가 많아질수록 Throughput 급격히 저하 → 병렬성 감소</li></ul></li></ul></li><li><p><strong>Lock-free 설계 (CAS, Atomic 연산 등)</strong></p><ul><li><strong>실제 사례</strong>:<ul><li><strong>Java 의 ConcurrentLinkedQueue</strong>, <strong>Go 의 sync/atomic</strong></li><li><strong>Apache Cassandra</strong>의 memtable flush queue 는 lock-free 구조</li></ul></li><li><strong>심화 설명</strong>:<ul><li>Compare-And-Swap(CAS) 기반으로 충돌 발생 시 retry (낙관적 동시성 제어)</li><li>Lock-free 는 Blocking 을 피할 수 있어 지연시간 줄이기 유리</li><li>단점: 구현 난이도 매우 높음, ABA 문제, starvation 발생 가능</li></ul></li></ul></li><li><p><strong>메시지 기반 처리 (Message Queue, Actor Model)</strong></p><ul><li><strong>실제 사례</strong>:<ul><li><strong>Akka (Scala)</strong>, <strong>Elixir</strong>, <strong>Erlang</strong> 은 Actor 모델로 경쟁 조건을 피함</li><li><strong>RabbitMQ</strong>, <strong>Kafka</strong>, <strong>Redis Stream</strong> 기반 아키텍처는 자원 공유 없이 메시지로 통신</li></ul></li><li><strong>심화 설명</strong>:<ul><li>공유 상태 없이 메시지를 통해 상태 전이 → Race 발생 원인 제거</li><li>메시지 순서와 중복 수신 처리, QoS 등 비즈니스 로직이 복잡해질 수 있음</li><li>Scaling 에는 유리하나 모니터링/트레이싱이 어려움 (비동기이기 때문)</li></ul></li></ul></li><li><p><strong>트랜잭션 기반 처리 (DBMS, ACID, 분산 트랜잭션)</strong></p><ul><li><strong>실제 사례</strong>:<ul><li><strong>PostgreSQL, MySQL</strong>의 트랜잭션 격리 수준을 통해 Race 방지</li><li><strong>Spanner</strong>, <strong>CockroachDB</strong>는 글로벌 트랜잭션에서 TrueTime/Hybrid Time 활용</li></ul></li><li><strong>심화 설명</strong>:<ul><li>Snapshot Isolation, Serializable, Repeatable Read 등 격리 수준에 따라 경쟁 방지 수준 결정</li><li>분산 트랜잭션에서는 2PC, 3PC 또는 Paxos 기반 합의 필요 → 복잡도 급증</li><li>금융/회계 등 정합성 최우선 영역에서 필수 → 성능 비용 큼</li></ul></li></ul></li></ol><h6 id=python-lockfree-스타일-원자-카운터-cas-유사-구조>Python: Lock‑free 스타일 원자 카운터 (CAS 유사 구조)<a hidden class=anchor aria-hidden=true href=#python-lockfree-스타일-원자-카운터-cas-유사-구조>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AtomicCounter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_value</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>increment_and_get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_value</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>counter</span> <span class=o>=</span> <span class=n>AtomicCounter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>worker</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>counter</span><span class=o>.</span><span class=n>increment_and_get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;최종 값:&#34;</span><span class=p>,</span> <span class=n>counter</span><span class=o>.</span><span class=n>_value</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=javascript-비동기-메시지-큐-기반-처리>JavaScript: 비동기 메시지 큐 기반 처리<a hidden class=anchor aria-hidden=true href=#javascript-비동기-메시지-큐-기반-처리>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20>20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21>21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22>22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23>23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24>24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25>25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26>26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27>27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28>28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29>29</a>
</span><span class=lnt id=hl-7-30><a class=lnlinks href=#hl-7-30>30</a>
</span><span class=lnt id=hl-7-31><a class=lnlinks href=#hl-7-31>31</a>
</span><span class=lnt id=hl-7-32><a class=lnlinks href=#hl-7-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MessageQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>queue</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>enqueue</span><span class=p>(</span><span class=nx>task</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>task</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>process</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>process</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>processing</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>task</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>task</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 예시 사용
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>mq</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MessageQueue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;=</span> <span class=mi>5</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mq</span><span class=p>.</span><span class=nx>enqueue</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;작업 시작:&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>r</span> <span class=p>=&gt;</span> <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=mi>1000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;작업 완료:&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=분류-기준에-따른-유형>분류 기준에 따른 유형<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-유형>#</a></h4><ul><li><p><strong>시점 기반 분류</strong></p><ul><li><em>Check-Then-Act</em> / <em>Read-Modify-Write</em> / <em>TOCTOU</em></li><li>연산 시점 사이의 간극에서 발생하는 논리적 불일치</li></ul></li><li><p><strong>실행 환경 기반 분류</strong></p><ul><li>단일 스레드 vs 멀티스레드 vs 멀티프로세스 vs 분산 시스템</li><li>환경에 따라 동기화 기술 및 탐지 방식이 달라짐</li></ul></li><li><p><strong>자원 접근 패턴 분류</strong></p><ul><li>메모리 기반 / I/O 기반 / 상태 기반</li><li>처리 대상에 따라 Race 발생 위치 및 영향 범위가 다름</li></ul></li><li><p><strong>연산 원자성 기준</strong></p><ul><li>단일 연산 / 복합 연산 / 조건 기반 연산</li><li>원자적이지 않은 복합 연산에서 더 자주 발생</li></ul></li><li><p><strong>탐지 및 대응 방식 기준</strong></p><ul><li>정적 분석 / 동적 분석 / 컴파일 타임 검출 / 런타임 탐지</li><li>실무에서는 여러 기법을 병합하여 탐지 정밀도를 향상시킴</li></ul></li></ul><table><thead><tr><th>분류 기준</th><th>유형</th><th>설명 및 예시</th><th>주된 대응 방식</th></tr></thead><tbody><tr><td><strong>시점 기반</strong></td><td>Check-Then-Act / TOCTOU</td><td>파일 존재 여부 확인 후 생성 / 로그인 상태 확인 후 처리</td><td>Atomic 연산, Lock, 트랜잭션</td></tr><tr><td><strong>자원 접근 패턴</strong></td><td>메모리 / I/O / 상태 기반</td><td>변수 증가, 파일 쓰기, 장바구니 상태 갱신 등</td><td>Mutex, 세마포어, 파일 락</td></tr><tr><td><strong>실행 환경</strong></td><td>스레드 / 프로세스 / 분산 시스템</td><td>Thread 간 변수 경합 / 공유 메모리 충돌 / 노드 간 상태 불일치 등</td><td>Thread-safe 구조, 분산 락, Paxos 등</td></tr><tr><td><strong>연산 원자성</strong></td><td>단일 연산 / 복합 연산 / 조건 분기형</td><td>x++, 조건 검사 후 상태 변경 등 복합 연산에서 빈번</td><td>CAS, Compare-And-Swap, 트랜잭션 격리수준</td></tr><tr><td><strong>탐지 방식</strong></td><td>정적 분석 / 동적 분석 / 런타임 검출</td><td>코드 정적 검사 / 테스트 중 탐지 / 실행 중 Race Logger 활용 등</td><td>정적 분석 도구, Race Detector</td></tr><tr><td><strong>논리적 유형</strong></td><td>논리 Race / 물리 Race</td><td>상태 전이가 논리적으로 모순되는 경우 / 실제 자원 충돌 발생</td><td>비즈니스 검증 로직 강화, 불변 객체 설계</td></tr></tbody></table><p>Race Condition 은 <strong>발생하는 환경</strong>, <strong>접근하는 자원의 종류</strong>, <strong>연산의 타이밍</strong>, <strong>탐지 방식</strong>에 따라 매우 다양한 유형으로 분류될 수 있다.<br>이러한 분류는 실무에서 문제 발생 원인을 빠르게 식별하고, 최적의 해결 방식을 적용하는 데 필수적인 기준이된다.</p><p>예를 들어, 분산 환경의 상태 Race 는 Paxos 같은 합의 알고리즘이 필요하고, 메모리 기반 Race 는 CAS 나 Atomic 연산으로 해결할 수 있다.<br>이처럼 유형별 특성과 대응 기술을 매핑하는 것이 <strong>Race Condition 예방 및 대응의 핵심 전략</strong>이다.</p><h3 id=실무-적용-practical-application>실무 적용 (Practical Application)<a hidden class=anchor aria-hidden=true href=#실무-적용-practical-application>#</a></h3><h4 id=실제-도입-사례>실제 도입 사례<a hidden class=anchor aria-hidden=true href=#실제-도입-사례>#</a></h4><table><thead><tr><th>도메인</th><th>문제 유형</th><th>실제 사례</th><th>대응 전략</th></tr></thead><tbody><tr><td>전자상거래</td><td>재고 초과 판매 (경합)</td><td>동시 주문으로 재고 오류</td><td>낙관적/비관적 락, Redis 분산락</td></tr><tr><td>금융 서비스</td><td>계좌 잔액 동시 업데이트 오류</td><td>동시 인출 시 변동 생략 또는 중복 승인</td><td>트랜잭션 + 레코드 락, lock_version 기반 락</td></tr><tr><td>이벤트 기반 시스템</td><td>상태 불일치 (이벤트 병렬 처리)</td><td>병렬 이벤트로 재고 검증 타이밍 충돌</td><td>이벤트 순서 보장, 분산 락 적용</td></tr><tr><td>Rails 어드민 UI</td><td>동시 편집 충돌</td><td>Admin A/B 동일 객체 편집 중 덮어쓰기</td><td>Optimistic / Pessimistic Lock 도입</td></tr></tbody></table><ul><li><strong>재고 관리</strong>: 낙관적 락은 빈번한 실패를 자동 재시도로 최소화하면서 성능 유지. 비관적 락은 높은 충돌 환경에 적합.</li><li><strong>금융 처리</strong>: 데이터 정합성이 가장 중요하므로 강력한 트랜잭션 보장이 필수이며, lock_version 방식은 버전 충돌 감지에 유리.</li><li><strong>이벤트 기반 시스템</strong>: 비동기 특성상 이벤트 순서가 다를 수 있으므로, 별도의 순서 보정 또는 locking 계층 필요.</li><li><strong>UI 동시 편집</strong>: 사용자 경험 고려 시 낙관적 락으로 간결한 충돌 처리 (StaleObjectError) 제공. 비관적 락은 잠금 대기 UI 가 필요.</li></ul><h4 id=실습-예제-및-코드-구현>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현>#</a></h4><h5 id=사례-은행-계좌의-잔액을-두-스레드가-동시에-출금하려는-상황>사례: 은행 계좌의 잔액을 두 스레드가 동시에 출금하려는 상황<a hidden class=anchor aria-hidden=true href=#사례-은행-계좌의-잔액을-두-스레드가-동시에-출금하려는-상황>#</a></h5><p><strong>시나리오</strong>: 은행 계좌의 잔액을 두 스레드가 동시에 출금하려는 상황</p><p><strong>시스템 구성</strong>:</p><ul><li>계좌 잔액 (공유 자원)</li><li>출금 스레드 2 개 (ThreadA, ThreadB)</li></ul><pre class=mermaid>flowchart TB
    A[계좌 잔액 = 1000원]
    subgraph 스레드A
        B[잔액 읽기]
        C[1000원에서 800원 빼기]
        D[200원 저장]
    end
    subgraph 스레드B
        E[잔액 읽기]
        F[1000원에서 900원 빼기]
        G[100원 저장]
    end
    B &amp; E --&gt; A
    D &amp; G --&gt; A
</pre><p><strong>Workflow</strong>:</p><ol><li>두 스레드가 동시에 <code>잔액</code> 을 읽음 (둘 다 1,000 원)</li><li>각각 800 원, 900 원을 빼서 로컬에 저장</li><li>각각 200 원, 100 원을 저장하려 함</li><li>최종적으로 200 원이나 100 원 중 하나만 남음</li></ol><p><strong>도입 전/후 차이</strong></p><ul><li><strong>도입 전</strong>: 잔액이 -1,700 원 (비정상, 데이터 오염)</li><li><strong>도입 후</strong>: 잔액이 100 원 (정상, 동기화 적용)</li></ul><p><strong>구현 예시 (Python)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span><span class=lnt id=hl-9-23><a class=lnlinks href=#hl-9-23>23</a>
</span><span class=lnt id=hl-9-24><a class=lnlinks href=#hl-9-24>24</a>
</span><span class=lnt id=hl-9-25><a class=lnlinks href=#hl-9-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 공유 자원</span>
</span></span><span class=line><span class=cl><span class=n>balance</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># synchronized access를 위한 락</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>withdraw</span><span class=p>(</span><span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>balance</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>lock</span><span class=p>:</span>  <span class=c1># 임계구역 보호</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>balance</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>balance</span> <span class=o>-=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;잔액 </span><span class=si>{</span><span class=n>balance</span><span class=si>}</span><span class=s2>원 남음 (인출: </span><span class=si>{</span><span class=n>amount</span><span class=si>}</span><span class=s2>원)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;잔액 부족&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 두 스레드에서 동시 출금</span>
</span></span><span class=line><span class=cl><span class=n>thread1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>withdraw</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>800</span><span class=p>,))</span>
</span></span><span class=line><span class=cl><span class=n>thread2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>withdraw</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>900</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>thread1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>thread2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>thread1</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>thread2</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-온라인-티켓-예매-시스템에서-동시-예약-처리>사례: 온라인 티켓 예매 시스템에서 동시 예약 처리<a hidden class=anchor aria-hidden=true href=#사례-온라인-티켓-예매-시스템에서-동시-예약-처리>#</a></h5><p><strong>시나리오</strong>: 온라인 티켓 예매 시스템에서 동시 예약 처리</p><p><strong>시스템 구성</strong>:</p><ul><li>웹 서버 (다중 스레드)</li><li>데이터베이스 (좌석 정보)</li><li>캐시 레이어 (Redis)</li><li>메시지 큐 (예약 확정 처리)</li></ul><pre class=mermaid>graph TB
    A[User Request] --&gt; B[Load Balancer]
    B --&gt; C[Web Server 1]
    B --&gt; D[Web Server 2]
    B --&gt; E[Web Server N]
    
    C --&gt; F[Application Logic]
    D --&gt; F
    E --&gt; F
    
    F --&gt; G[Cache Layer Redis]
    F --&gt; H[Database]
    F --&gt; I[Message Queue]
    
    G &lt;--&gt; H
    I --&gt; J[Confirmation Service]
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 좌석 선택 및 예약 요청</li><li>애플리케이션이 좌석 가용성 확인 (캐시 우선)</li><li>데이터베이스에서 원자적 예약 처리</li><li>캐시 업데이트 및 확정 메시지 전송</li><li>비동기 확정 처리 및 알림 발송</li></ol><p><strong>핵심 역할</strong>: Race Condition 방지를 통한 중복 예약 차단</p><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 동일 좌석 중복 예약 발생, 고객 불만, 수동 취소 처리 필요</li><li><strong>도입 후</strong>: 원자적 예약 보장, 고객 신뢰도 향상, 운영 효율성 개선</li></ul><p><strong>구현 예시</strong> (Python):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>  1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>  2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>  3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4>  4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5>  5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6>  6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7>  7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8>  8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9>  9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10> 10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11> 11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12> 12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13> 13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14> 14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15> 15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16> 16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17> 17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18> 18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19> 19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20> 20</a>
</span><span class=lnt id=hl-11-21><a class=lnlinks href=#hl-11-21> 21</a>
</span><span class=lnt id=hl-11-22><a class=lnlinks href=#hl-11-22> 22</a>
</span><span class=lnt id=hl-11-23><a class=lnlinks href=#hl-11-23> 23</a>
</span><span class=lnt id=hl-11-24><a class=lnlinks href=#hl-11-24> 24</a>
</span><span class=lnt id=hl-11-25><a class=lnlinks href=#hl-11-25> 25</a>
</span><span class=lnt id=hl-11-26><a class=lnlinks href=#hl-11-26> 26</a>
</span><span class=lnt id=hl-11-27><a class=lnlinks href=#hl-11-27> 27</a>
</span><span class=lnt id=hl-11-28><a class=lnlinks href=#hl-11-28> 28</a>
</span><span class=lnt id=hl-11-29><a class=lnlinks href=#hl-11-29> 29</a>
</span><span class=lnt id=hl-11-30><a class=lnlinks href=#hl-11-30> 30</a>
</span><span class=lnt id=hl-11-31><a class=lnlinks href=#hl-11-31> 31</a>
</span><span class=lnt id=hl-11-32><a class=lnlinks href=#hl-11-32> 32</a>
</span><span class=lnt id=hl-11-33><a class=lnlinks href=#hl-11-33> 33</a>
</span><span class=lnt id=hl-11-34><a class=lnlinks href=#hl-11-34> 34</a>
</span><span class=lnt id=hl-11-35><a class=lnlinks href=#hl-11-35> 35</a>
</span><span class=lnt id=hl-11-36><a class=lnlinks href=#hl-11-36> 36</a>
</span><span class=lnt id=hl-11-37><a class=lnlinks href=#hl-11-37> 37</a>
</span><span class=lnt id=hl-11-38><a class=lnlinks href=#hl-11-38> 38</a>
</span><span class=lnt id=hl-11-39><a class=lnlinks href=#hl-11-39> 39</a>
</span><span class=lnt id=hl-11-40><a class=lnlinks href=#hl-11-40> 40</a>
</span><span class=lnt id=hl-11-41><a class=lnlinks href=#hl-11-41> 41</a>
</span><span class=lnt id=hl-11-42><a class=lnlinks href=#hl-11-42> 42</a>
</span><span class=lnt id=hl-11-43><a class=lnlinks href=#hl-11-43> 43</a>
</span><span class=lnt id=hl-11-44><a class=lnlinks href=#hl-11-44> 44</a>
</span><span class=lnt id=hl-11-45><a class=lnlinks href=#hl-11-45> 45</a>
</span><span class=lnt id=hl-11-46><a class=lnlinks href=#hl-11-46> 46</a>
</span><span class=lnt id=hl-11-47><a class=lnlinks href=#hl-11-47> 47</a>
</span><span class=lnt id=hl-11-48><a class=lnlinks href=#hl-11-48> 48</a>
</span><span class=lnt id=hl-11-49><a class=lnlinks href=#hl-11-49> 49</a>
</span><span class=lnt id=hl-11-50><a class=lnlinks href=#hl-11-50> 50</a>
</span><span class=lnt id=hl-11-51><a class=lnlinks href=#hl-11-51> 51</a>
</span><span class=lnt id=hl-11-52><a class=lnlinks href=#hl-11-52> 52</a>
</span><span class=lnt id=hl-11-53><a class=lnlinks href=#hl-11-53> 53</a>
</span><span class=lnt id=hl-11-54><a class=lnlinks href=#hl-11-54> 54</a>
</span><span class=lnt id=hl-11-55><a class=lnlinks href=#hl-11-55> 55</a>
</span><span class=lnt id=hl-11-56><a class=lnlinks href=#hl-11-56> 56</a>
</span><span class=lnt id=hl-11-57><a class=lnlinks href=#hl-11-57> 57</a>
</span><span class=lnt id=hl-11-58><a class=lnlinks href=#hl-11-58> 58</a>
</span><span class=lnt id=hl-11-59><a class=lnlinks href=#hl-11-59> 59</a>
</span><span class=lnt id=hl-11-60><a class=lnlinks href=#hl-11-60> 60</a>
</span><span class=lnt id=hl-11-61><a class=lnlinks href=#hl-11-61> 61</a>
</span><span class=lnt id=hl-11-62><a class=lnlinks href=#hl-11-62> 62</a>
</span><span class=lnt id=hl-11-63><a class=lnlinks href=#hl-11-63> 63</a>
</span><span class=lnt id=hl-11-64><a class=lnlinks href=#hl-11-64> 64</a>
</span><span class=lnt id=hl-11-65><a class=lnlinks href=#hl-11-65> 65</a>
</span><span class=lnt id=hl-11-66><a class=lnlinks href=#hl-11-66> 66</a>
</span><span class=lnt id=hl-11-67><a class=lnlinks href=#hl-11-67> 67</a>
</span><span class=lnt id=hl-11-68><a class=lnlinks href=#hl-11-68> 68</a>
</span><span class=lnt id=hl-11-69><a class=lnlinks href=#hl-11-69> 69</a>
</span><span class=lnt id=hl-11-70><a class=lnlinks href=#hl-11-70> 70</a>
</span><span class=lnt id=hl-11-71><a class=lnlinks href=#hl-11-71> 71</a>
</span><span class=lnt id=hl-11-72><a class=lnlinks href=#hl-11-72> 72</a>
</span><span class=lnt id=hl-11-73><a class=lnlinks href=#hl-11-73> 73</a>
</span><span class=lnt id=hl-11-74><a class=lnlinks href=#hl-11-74> 74</a>
</span><span class=lnt id=hl-11-75><a class=lnlinks href=#hl-11-75> 75</a>
</span><span class=lnt id=hl-11-76><a class=lnlinks href=#hl-11-76> 76</a>
</span><span class=lnt id=hl-11-77><a class=lnlinks href=#hl-11-77> 77</a>
</span><span class=lnt id=hl-11-78><a class=lnlinks href=#hl-11-78> 78</a>
</span><span class=lnt id=hl-11-79><a class=lnlinks href=#hl-11-79> 79</a>
</span><span class=lnt id=hl-11-80><a class=lnlinks href=#hl-11-80> 80</a>
</span><span class=lnt id=hl-11-81><a class=lnlinks href=#hl-11-81> 81</a>
</span><span class=lnt id=hl-11-82><a class=lnlinks href=#hl-11-82> 82</a>
</span><span class=lnt id=hl-11-83><a class=lnlinks href=#hl-11-83> 83</a>
</span><span class=lnt id=hl-11-84><a class=lnlinks href=#hl-11-84> 84</a>
</span><span class=lnt id=hl-11-85><a class=lnlinks href=#hl-11-85> 85</a>
</span><span class=lnt id=hl-11-86><a class=lnlinks href=#hl-11-86> 86</a>
</span><span class=lnt id=hl-11-87><a class=lnlinks href=#hl-11-87> 87</a>
</span><span class=lnt id=hl-11-88><a class=lnlinks href=#hl-11-88> 88</a>
</span><span class=lnt id=hl-11-89><a class=lnlinks href=#hl-11-89> 89</a>
</span><span class=lnt id=hl-11-90><a class=lnlinks href=#hl-11-90> 90</a>
</span><span class=lnt id=hl-11-91><a class=lnlinks href=#hl-11-91> 91</a>
</span><span class=lnt id=hl-11-92><a class=lnlinks href=#hl-11-92> 92</a>
</span><span class=lnt id=hl-11-93><a class=lnlinks href=#hl-11-93> 93</a>
</span><span class=lnt id=hl-11-94><a class=lnlinks href=#hl-11-94> 94</a>
</span><span class=lnt id=hl-11-95><a class=lnlinks href=#hl-11-95> 95</a>
</span><span class=lnt id=hl-11-96><a class=lnlinks href=#hl-11-96> 96</a>
</span><span class=lnt id=hl-11-97><a class=lnlinks href=#hl-11-97> 97</a>
</span><span class=lnt id=hl-11-98><a class=lnlinks href=#hl-11-98> 98</a>
</span><span class=lnt id=hl-11-99><a class=lnlinks href=#hl-11-99> 99</a>
</span><span class=lnt id=hl-11-100><a class=lnlinks href=#hl-11-100>100</a>
</span><span class=lnt id=hl-11-101><a class=lnlinks href=#hl-11-101>101</a>
</span><span class=lnt id=hl-11-102><a class=lnlinks href=#hl-11-102>102</a>
</span><span class=lnt id=hl-11-103><a class=lnlinks href=#hl-11-103>103</a>
</span><span class=lnt id=hl-11-104><a class=lnlinks href=#hl-11-104>104</a>
</span><span class=lnt id=hl-11-105><a class=lnlinks href=#hl-11-105>105</a>
</span><span class=lnt id=hl-11-106><a class=lnlinks href=#hl-11-106>106</a>
</span><span class=lnt id=hl-11-107><a class=lnlinks href=#hl-11-107>107</a>
</span><span class=lnt id=hl-11-108><a class=lnlinks href=#hl-11-108>108</a>
</span><span class=lnt id=hl-11-109><a class=lnlinks href=#hl-11-109>109</a>
</span><span class=lnt id=hl-11-110><a class=lnlinks href=#hl-11-110>110</a>
</span><span class=lnt id=hl-11-111><a class=lnlinks href=#hl-11-111>111</a>
</span><span class=lnt id=hl-11-112><a class=lnlinks href=#hl-11-112>112</a>
</span><span class=lnt id=hl-11-113><a class=lnlinks href=#hl-11-113>113</a>
</span><span class=lnt id=hl-11-114><a class=lnlinks href=#hl-11-114>114</a>
</span><span class=lnt id=hl-11-115><a class=lnlinks href=#hl-11-115>115</a>
</span><span class=lnt id=hl-11-116><a class=lnlinks href=#hl-11-116>116</a>
</span><span class=lnt id=hl-11-117><a class=lnlinks href=#hl-11-117>117</a>
</span><span class=lnt id=hl-11-118><a class=lnlinks href=#hl-11-118>118</a>
</span><span class=lnt id=hl-11-119><a class=lnlinks href=#hl-11-119>119</a>
</span><span class=lnt id=hl-11-120><a class=lnlinks href=#hl-11-120>120</a>
</span><span class=lnt id=hl-11-121><a class=lnlinks href=#hl-11-121>121</a>
</span><span class=lnt id=hl-11-122><a class=lnlinks href=#hl-11-122>122</a>
</span><span class=lnt id=hl-11-123><a class=lnlinks href=#hl-11-123>123</a>
</span><span class=lnt id=hl-11-124><a class=lnlinks href=#hl-11-124>124</a>
</span><span class=lnt id=hl-11-125><a class=lnlinks href=#hl-11-125>125</a>
</span><span class=lnt id=hl-11-126><a class=lnlinks href=#hl-11-126>126</a>
</span><span class=lnt id=hl-11-127><a class=lnlinks href=#hl-11-127>127</a>
</span><span class=lnt id=hl-11-128><a class=lnlinks href=#hl-11-128>128</a>
</span><span class=lnt id=hl-11-129><a class=lnlinks href=#hl-11-129>129</a>
</span><span class=lnt id=hl-11-130><a class=lnlinks href=#hl-11-130>130</a>
</span><span class=lnt id=hl-11-131><a class=lnlinks href=#hl-11-131>131</a>
</span><span class=lnt id=hl-11-132><a class=lnlinks href=#hl-11-132>132</a>
</span><span class=lnt id=hl-11-133><a class=lnlinks href=#hl-11-133>133</a>
</span><span class=lnt id=hl-11-134><a class=lnlinks href=#hl-11-134>134</a>
</span><span class=lnt id=hl-11-135><a class=lnlinks href=#hl-11-135>135</a>
</span><span class=lnt id=hl-11-136><a class=lnlinks href=#hl-11-136>136</a>
</span><span class=lnt id=hl-11-137><a class=lnlinks href=#hl-11-137>137</a>
</span><span class=lnt id=hl-11-138><a class=lnlinks href=#hl-11-138>138</a>
</span><span class=lnt id=hl-11-139><a class=lnlinks href=#hl-11-139>139</a>
</span><span class=lnt id=hl-11-140><a class=lnlinks href=#hl-11-140>140</a>
</span><span class=lnt id=hl-11-141><a class=lnlinks href=#hl-11-141>141</a>
</span><span class=lnt id=hl-11-142><a class=lnlinks href=#hl-11-142>142</a>
</span><span class=lnt id=hl-11-143><a class=lnlinks href=#hl-11-143>143</a>
</span><span class=lnt id=hl-11-144><a class=lnlinks href=#hl-11-144>144</a>
</span><span class=lnt id=hl-11-145><a class=lnlinks href=#hl-11-145>145</a>
</span><span class=lnt id=hl-11-146><a class=lnlinks href=#hl-11-146>146</a>
</span><span class=lnt id=hl-11-147><a class=lnlinks href=#hl-11-147>147</a>
</span><span class=lnt id=hl-11-148><a class=lnlinks href=#hl-11-148>148</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Seat</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;좌석 정보를 나타내는 데이터 클래스&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>seat_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>is_available</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>reserved_by</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TicketBookingSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Race Condition을 방지하는 티켓 예매 시스템&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 좌석 정보 저장 (실제로는 데이터베이스)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>seats</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Seat</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;A</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>:</span> <span class=n>Seat</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;A</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 좌석별 락 사용 (Fine-grained locking)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>seat_locks</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>seat_id</span><span class=p>:</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span> <span class=k>for</span> <span class=n>seat_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>seats</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 전체 시스템 통계용 락</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stats_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;total_attempts&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;successful_bookings&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire_seat_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>seat_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;좌석별 락을 안전하게 획득하고 해제하는 컨텍스트 매니저&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>seat_locks</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>seat_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Invalid seat ID: </span><span class=si>{</span><span class=n>seat_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>book_seat</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>seat_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        좌석 예약 메서드 - Race Condition 방지 적용
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            seat_id: 예약할 좌석 ID
</span></span></span><span class=line><span class=cl><span class=s2>            user_id: 예약하는 사용자 ID
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            bool: 예약 성공 여부
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>stats_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span><span class=p>[</span><span class=s2>&#34;total_attempts&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 좌석별 락 사용으로 동시 접근 제어</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>acquire_seat_lock</span><span class=p>(</span><span class=n>seat_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>seat</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>seats</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>seat_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>seat</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;❌ </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>: 존재하지 않는 좌석 </span><span class=si>{</span><span class=n>seat_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Check-Then-Act 패턴에서 원자성 보장</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>seat</span><span class=o>.</span><span class=n>is_available</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 실제 환경에서는 데이터베이스 트랜잭션 처리</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;🔄 </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>: 좌석 </span><span class=si>{</span><span class=n>seat_id</span><span class=si>}</span><span class=s2> 예약 처리 중...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 네트워크 지연 시뮬레이션</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 원자적 업데이트</span>
</span></span><span class=line><span class=cl>                <span class=n>seat</span><span class=o>.</span><span class=n>is_available</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=n>seat</span><span class=o>.</span><span class=n>reserved_by</span> <span class=o>=</span> <span class=n>user_id</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>stats_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span><span class=p>[</span><span class=s2>&#34;successful_bookings&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>: 좌석 </span><span class=si>{</span><span class=n>seat_id</span><span class=si>}</span><span class=s2> 예약 완료!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;❌ </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>: 좌석 </span><span class=si>{</span><span class=n>seat_id</span><span class=si>}</span><span class=s2>는 이미 예약됨 (예약자: </span><span class=si>{</span><span class=n>seat</span><span class=o>.</span><span class=n>reserved_by</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_available_seats</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;현재 예약 가능한 좌석 목록 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>available</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 모든 좌석 락을 순서대로 획득하여 데드락 방지</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>seat_id</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>seats</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>acquire_seat_lock</span><span class=p>(</span><span class=n>seat_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>seats</span><span class=p>[</span><span class=n>seat_id</span><span class=p>]</span><span class=o>.</span><span class=n>is_available</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>available</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>seat_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>available</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print_booking_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;예약 통계 출력&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>stats_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>📊 예약 통계:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   총 시도: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span><span class=p>[</span><span class=s1>&#39;total_attempts&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   성공: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span><span class=p>[</span><span class=s1>&#39;successful_bookings&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   실패: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span><span class=p>[</span><span class=s1>&#39;total_attempts&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>booking_stats</span><span class=p>[</span><span class=s1>&#39;successful_bookings&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Race Condition 테스트 시나리오</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>simulate_concurrent_booking</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;동시 예약 시뮬레이션 - Race Condition 테스트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>booking_system</span> <span class=o>=</span> <span class=n>TicketBookingSystem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 여러 사용자가 동시에 같은 좌석 예약 시도</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;User</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>6</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>target_seats</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;A1&#34;</span><span class=p>,</span> <span class=s2>&#34;A2&#34;</span><span class=p>,</span> <span class=s2>&#34;A1&#34;</span><span class=p>,</span> <span class=s2>&#34;A1&#34;</span><span class=p>,</span> <span class=s2>&#34;A2&#34;</span><span class=p>]</span>  <span class=c1># 의도적으로 중복</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🎫 동시 티켓 예약 시뮬레이션 시작&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📍 예약 가능한 좌석: </span><span class=si>{</span><span class=n>booking_system</span><span class=o>.</span><span class=n>get_available_seats</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 동시 예약 스레드 생성</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>user</span><span class=p>,</span> <span class=n>seat</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>users</span><span class=p>,</span> <span class=n>target_seats</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=o>=</span><span class=n>booking_system</span><span class=o>.</span><span class=n>book_seat</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>seat</span><span class=p>,</span> <span class=n>user</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;BookingThread-</span><span class=si>{</span><span class=n>user</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>thread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 모든 스레드 동시 시작</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 모든 스레드 완료 대기</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>⏱️ 처리 시간: </span><span class=si>{</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📍 예약 완료 후 가능한 좌석: </span><span class=si>{</span><span class=n>booking_system</span><span class=o>.</span><span class=n>get_available_seats</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>booking_system</span><span class=o>.</span><span class=n>print_booking_stats</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>simulate_concurrent_booking</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>실행 결과 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16>16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>🎫 동시 티켓 예약 시뮬레이션 시작
</span></span><span class=line><span class=cl>📍 예약 가능한 좌석: [&#39;A1&#39;, &#39;A2&#39;, &#39;A3&#39;, &#39;A4&#39;, &#39;A5&#39;, &#39;A6&#39;, &#39;A7&#39;, &#39;A8&#39;, &#39;A9&#39;, &#39;A10&#39;]
</span></span><span class=line><span class=cl>🔄 User1: 좌석 A1 예약 처리 중...
</span></span><span class=line><span class=cl>🔄 User2: 좌석 A2 예약 처리 중...
</span></span><span class=line><span class=cl>✅ User1: 좌석 A1 예약 완료!
</span></span><span class=line><span class=cl>✅ User2: 좌석 A2 예약 완료!
</span></span><span class=line><span class=cl>❌ User3: 좌석 A1는 이미 예약됨 (예약자: User1)
</span></span><span class=line><span class=cl>❌ User4: 좌석 A1는 이미 예약됨 (예약자: User1)
</span></span><span class=line><span class=cl>❌ User5: 좌석 A2는 이미 예약됨 (예약자: User2)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>⏱️ 처리 시간: 0.52초
</span></span><span class=line><span class=cl>📍 예약 완료 후 가능한 좌석: [&#39;A3&#39;, &#39;A4&#39;, &#39;A5&#39;, &#39;A6&#39;, &#39;A7&#39;, &#39;A8&#39;, &#39;A9&#39;, &#39;A10&#39;]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>📊 예약 통계:
</span></span><span class=line><span class=cl>   총 시도: 5
</span></span><span class=line><span class=cl>   성공: 2
</span></span><span class=line><span class=cl>   실패: 3
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-다중-사용자-요청으로-인해-중복-결제가-발생하는-상황-방지>사례: 다중 사용자 요청으로 인해 중복 결제가 발생하는 상황 방지<a hidden class=anchor aria-hidden=true href=#사례-다중-사용자-요청으로-인해-중복-결제가-발생하는-상황-방지>#</a></h5><p><strong>시나리오</strong>: 다중 사용자 요청으로 인해 <strong>중복 결제</strong>가 발생하는 상황 방지</p><p><strong>시스템 구성</strong></p><ul><li><strong>Web Server</strong> (FastAPI)</li><li><strong>Database</strong> (PostgreSQL)</li><li><strong>Redis</strong> (Distributed Lock)</li><li><strong>Payment Gateway</strong><br>**</li></ul><pre class=mermaid>graph TB
    Client --&gt; API[Web API 서버]
    API --&gt; Redis[Redis Lock]
    API --&gt; DB[(PostgreSQL)]
    API --&gt; PG[결제 게이트웨이]
    Redis --&gt; DB
</pre><p><strong>Workflow</strong></p><ol><li>클라이언트가 주문 요청</li><li>서버는 Redis 기반 Lock 획득 시도</li><li>Lock 성공 시 결제 처리 진행</li><li>DB 에 트랜잭션 기반 주문 저장</li><li>Lock 해제 후 응답 반환</li></ol><p><strong>핵심 역할</strong></p><ul><li><strong>Race Condition 방지</strong>: Redis Lock 을 통한 중복 요청 방지</li><li><strong>데이터 무결성 보장</strong>: DB 트랜잭션으로 상태 정합성 유지</li><li><strong>실시간성 확보</strong>: Redis 로 빠른 동시성 제어</li></ul><p><strong>유무에 따른 차이점</strong></p><table><thead><tr><th>구분</th><th>도입 전</th><th>도입 후</th></tr></thead><tbody><tr><td>중복 결제</td><td>다수 요청 시 중복 처리 발생</td><td>첫 요청만 유효, 나머지 차단</td></tr><tr><td>데이터 정합성</td><td>주문 중복, 잔액 오류 발생</td><td>단일 트랜잭션으로 정합성 보장</td></tr><tr><td>장애 처리</td><td>복구 어려움, 환불 요청 증가</td><td>오류 가능성 최소화</td></tr></tbody></table><p><strong>구현 예시</strong>: (Python + FastAPI + Aioredis + SQLAlchemy)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a class=lnlinks href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a class=lnlinks href=#hl-14-24>24</a>
</span><span class=lnt id=hl-14-25><a class=lnlinks href=#hl-14-25>25</a>
</span><span class=lnt id=hl-14-26><a class=lnlinks href=#hl-14-26>26</a>
</span><span class=lnt id=hl-14-27><a class=lnlinks href=#hl-14-27>27</a>
</span><span class=lnt id=hl-14-28><a class=lnlinks href=#hl-14-28>28</a>
</span><span class=lnt id=hl-14-29><a class=lnlinks href=#hl-14-29>29</a>
</span><span class=lnt id=hl-14-30><a class=lnlinks href=#hl-14-30>30</a>
</span><span class=lnt id=hl-14-31><a class=lnlinks href=#hl-14-31>31</a>
</span><span class=lnt id=hl-14-32><a class=lnlinks href=#hl-14-32>32</a>
</span><span class=lnt id=hl-14-33><a class=lnlinks href=#hl-14-33>33</a>
</span><span class=lnt id=hl-14-34><a class=lnlinks href=#hl-14-34>34</a>
</span><span class=lnt id=hl-14-35><a class=lnlinks href=#hl-14-35>35</a>
</span><span class=lnt id=hl-14-36><a class=lnlinks href=#hl-14-36>36</a>
</span><span class=lnt id=hl-14-37><a class=lnlinks href=#hl-14-37>37</a>
</span><span class=lnt id=hl-14-38><a class=lnlinks href=#hl-14-38>38</a>
</span><span class=lnt id=hl-14-39><a class=lnlinks href=#hl-14-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 주문 처리 API - Redis Lock으로 Race Condition 방지</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>aioredis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>asynccontextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>redis</span> <span class=o>=</span> <span class=n>aioredis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=s2>&#34;redis://localhost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>redis_lock</span><span class=p>(</span><span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>acquired</span> <span class=o>=</span> <span class=k>await</span> <span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=n>timeout</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>429</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;중복 요청 발생&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=k>await</span> <span class=n>redis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>val</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>==</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>redis</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/order/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>process_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;lock:order:</span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>redis_lock</span><span class=p>(</span><span class=n>lock_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 기존 주문 여부 확인</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Order</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>Order</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>order_id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;이미 처리된 주문입니다.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 결제 처리 로직 (생략)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 3. DB 저장 (트랜잭션)</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>order_id</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s2>&#34;paid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>redis.set(…, nx=True)</code> → 기존 키가 없을 경우에만 Lock 획득</li><li><code>uuid</code> 기반 토큰으로 Lock 소유자 확인 및 해제</li></ul><h5 id=사례-온라인-전자상거래-플랫폼의-재고-관리-시스템>사례: 온라인 전자상거래 플랫폼의 재고 관리 시스템<a hidden class=anchor aria-hidden=true href=#사례-온라인-전자상거래-플랫폼의-재고-관리-시스템>#</a></h5><p><strong>시나리오</strong>: 온라인 전자상거래 플랫폼의 재고 관리 시스템</p><p><strong>시스템 구성</strong>:</p><ul><li>웹 애플리케이션 서버 (3 대)</li><li>Redis 클러스터 (분산 락)</li><li>PostgreSQL 데이터베이스 (재고 데이터)</li><li>로드 밸런서 (트래픽 분산)</li></ul><pre class=mermaid>graph TB
    LB[Load Balancer] --&gt; WS1[Web Server 1]
    LB --&gt; WS2[Web Server 2]
    LB --&gt; WS3[Web Server 3]
    
    WS1 --&gt; RC[Redis Cluster]
    WS2 --&gt; RC
    WS3 --&gt; RC
    
    WS1 --&gt; DB[(PostgreSQL)]
    WS2 --&gt; DB
    WS3 --&gt; DB
    
    RC --&gt; R1[Redis Node 1]
    RC --&gt; R2[Redis Node 2]
    RC --&gt; R3[Redis Node 3]
    
    subgraph &#34;Race Condition Control&#34;
        RC --&gt; DL[Distributed Lock]
        DB --&gt; TX[Transaction Lock]
    end
</pre><p><strong>Workflow</strong>:</p><ul><li>사용자가 상품 주문 요청</li><li>웹 서버가 Redis 분산 락 획득 시도</li><li>락 획득 후 데이터베이스에서 재고 확인</li><li>재고 충분 시 주문 처리 및 재고 차감</li><li>트랜잭션 커밋 후 Redis 락 해제</li><li>재고 부족 시 주문 거부 및 락 해제</li></ul><p><strong>역할</strong>:</p><ul><li>Redis 분산 락: 동시 주문 시 재고 확인 순서 보장</li><li>PostgreSQL 트랜잭션: 데이터베이스 수준 일관성 유지</li><li>로드 밸런서: 트래픽 분산으로 성능 최적화</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>Race Condition 제어 없음</strong>: 재고보다 많은 주문 접수, 마이너스 재고 발생</li><li><strong>Race Condition 제어 있음</strong>: 정확한 재고 관리, 고객 신뢰도 향상</li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>  1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>  2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>  3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>  4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5>  5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6>  6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7>  7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8>  8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9>  9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10> 10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11> 11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12> 12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13> 13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14> 14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15> 15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16> 16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17> 17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18> 18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19> 19</a>
</span><span class=lnt id=hl-16-20><a class=lnlinks href=#hl-16-20> 20</a>
</span><span class=lnt id=hl-16-21><a class=lnlinks href=#hl-16-21> 21</a>
</span><span class=lnt id=hl-16-22><a class=lnlinks href=#hl-16-22> 22</a>
</span><span class=lnt id=hl-16-23><a class=lnlinks href=#hl-16-23> 23</a>
</span><span class=lnt id=hl-16-24><a class=lnlinks href=#hl-16-24> 24</a>
</span><span class=lnt id=hl-16-25><a class=lnlinks href=#hl-16-25> 25</a>
</span><span class=lnt id=hl-16-26><a class=lnlinks href=#hl-16-26> 26</a>
</span><span class=lnt id=hl-16-27><a class=lnlinks href=#hl-16-27> 27</a>
</span><span class=lnt id=hl-16-28><a class=lnlinks href=#hl-16-28> 28</a>
</span><span class=lnt id=hl-16-29><a class=lnlinks href=#hl-16-29> 29</a>
</span><span class=lnt id=hl-16-30><a class=lnlinks href=#hl-16-30> 30</a>
</span><span class=lnt id=hl-16-31><a class=lnlinks href=#hl-16-31> 31</a>
</span><span class=lnt id=hl-16-32><a class=lnlinks href=#hl-16-32> 32</a>
</span><span class=lnt id=hl-16-33><a class=lnlinks href=#hl-16-33> 33</a>
</span><span class=lnt id=hl-16-34><a class=lnlinks href=#hl-16-34> 34</a>
</span><span class=lnt id=hl-16-35><a class=lnlinks href=#hl-16-35> 35</a>
</span><span class=lnt id=hl-16-36><a class=lnlinks href=#hl-16-36> 36</a>
</span><span class=lnt id=hl-16-37><a class=lnlinks href=#hl-16-37> 37</a>
</span><span class=lnt id=hl-16-38><a class=lnlinks href=#hl-16-38> 38</a>
</span><span class=lnt id=hl-16-39><a class=lnlinks href=#hl-16-39> 39</a>
</span><span class=lnt id=hl-16-40><a class=lnlinks href=#hl-16-40> 40</a>
</span><span class=lnt id=hl-16-41><a class=lnlinks href=#hl-16-41> 41</a>
</span><span class=lnt id=hl-16-42><a class=lnlinks href=#hl-16-42> 42</a>
</span><span class=lnt id=hl-16-43><a class=lnlinks href=#hl-16-43> 43</a>
</span><span class=lnt id=hl-16-44><a class=lnlinks href=#hl-16-44> 44</a>
</span><span class=lnt id=hl-16-45><a class=lnlinks href=#hl-16-45> 45</a>
</span><span class=lnt id=hl-16-46><a class=lnlinks href=#hl-16-46> 46</a>
</span><span class=lnt id=hl-16-47><a class=lnlinks href=#hl-16-47> 47</a>
</span><span class=lnt id=hl-16-48><a class=lnlinks href=#hl-16-48> 48</a>
</span><span class=lnt id=hl-16-49><a class=lnlinks href=#hl-16-49> 49</a>
</span><span class=lnt id=hl-16-50><a class=lnlinks href=#hl-16-50> 50</a>
</span><span class=lnt id=hl-16-51><a class=lnlinks href=#hl-16-51> 51</a>
</span><span class=lnt id=hl-16-52><a class=lnlinks href=#hl-16-52> 52</a>
</span><span class=lnt id=hl-16-53><a class=lnlinks href=#hl-16-53> 53</a>
</span><span class=lnt id=hl-16-54><a class=lnlinks href=#hl-16-54> 54</a>
</span><span class=lnt id=hl-16-55><a class=lnlinks href=#hl-16-55> 55</a>
</span><span class=lnt id=hl-16-56><a class=lnlinks href=#hl-16-56> 56</a>
</span><span class=lnt id=hl-16-57><a class=lnlinks href=#hl-16-57> 57</a>
</span><span class=lnt id=hl-16-58><a class=lnlinks href=#hl-16-58> 58</a>
</span><span class=lnt id=hl-16-59><a class=lnlinks href=#hl-16-59> 59</a>
</span><span class=lnt id=hl-16-60><a class=lnlinks href=#hl-16-60> 60</a>
</span><span class=lnt id=hl-16-61><a class=lnlinks href=#hl-16-61> 61</a>
</span><span class=lnt id=hl-16-62><a class=lnlinks href=#hl-16-62> 62</a>
</span><span class=lnt id=hl-16-63><a class=lnlinks href=#hl-16-63> 63</a>
</span><span class=lnt id=hl-16-64><a class=lnlinks href=#hl-16-64> 64</a>
</span><span class=lnt id=hl-16-65><a class=lnlinks href=#hl-16-65> 65</a>
</span><span class=lnt id=hl-16-66><a class=lnlinks href=#hl-16-66> 66</a>
</span><span class=lnt id=hl-16-67><a class=lnlinks href=#hl-16-67> 67</a>
</span><span class=lnt id=hl-16-68><a class=lnlinks href=#hl-16-68> 68</a>
</span><span class=lnt id=hl-16-69><a class=lnlinks href=#hl-16-69> 69</a>
</span><span class=lnt id=hl-16-70><a class=lnlinks href=#hl-16-70> 70</a>
</span><span class=lnt id=hl-16-71><a class=lnlinks href=#hl-16-71> 71</a>
</span><span class=lnt id=hl-16-72><a class=lnlinks href=#hl-16-72> 72</a>
</span><span class=lnt id=hl-16-73><a class=lnlinks href=#hl-16-73> 73</a>
</span><span class=lnt id=hl-16-74><a class=lnlinks href=#hl-16-74> 74</a>
</span><span class=lnt id=hl-16-75><a class=lnlinks href=#hl-16-75> 75</a>
</span><span class=lnt id=hl-16-76><a class=lnlinks href=#hl-16-76> 76</a>
</span><span class=lnt id=hl-16-77><a class=lnlinks href=#hl-16-77> 77</a>
</span><span class=lnt id=hl-16-78><a class=lnlinks href=#hl-16-78> 78</a>
</span><span class=lnt id=hl-16-79><a class=lnlinks href=#hl-16-79> 79</a>
</span><span class=lnt id=hl-16-80><a class=lnlinks href=#hl-16-80> 80</a>
</span><span class=lnt id=hl-16-81><a class=lnlinks href=#hl-16-81> 81</a>
</span><span class=lnt id=hl-16-82><a class=lnlinks href=#hl-16-82> 82</a>
</span><span class=lnt id=hl-16-83><a class=lnlinks href=#hl-16-83> 83</a>
</span><span class=lnt id=hl-16-84><a class=lnlinks href=#hl-16-84> 84</a>
</span><span class=lnt id=hl-16-85><a class=lnlinks href=#hl-16-85> 85</a>
</span><span class=lnt id=hl-16-86><a class=lnlinks href=#hl-16-86> 86</a>
</span><span class=lnt id=hl-16-87><a class=lnlinks href=#hl-16-87> 87</a>
</span><span class=lnt id=hl-16-88><a class=lnlinks href=#hl-16-88> 88</a>
</span><span class=lnt id=hl-16-89><a class=lnlinks href=#hl-16-89> 89</a>
</span><span class=lnt id=hl-16-90><a class=lnlinks href=#hl-16-90> 90</a>
</span><span class=lnt id=hl-16-91><a class=lnlinks href=#hl-16-91> 91</a>
</span><span class=lnt id=hl-16-92><a class=lnlinks href=#hl-16-92> 92</a>
</span><span class=lnt id=hl-16-93><a class=lnlinks href=#hl-16-93> 93</a>
</span><span class=lnt id=hl-16-94><a class=lnlinks href=#hl-16-94> 94</a>
</span><span class=lnt id=hl-16-95><a class=lnlinks href=#hl-16-95> 95</a>
</span><span class=lnt id=hl-16-96><a class=lnlinks href=#hl-16-96> 96</a>
</span><span class=lnt id=hl-16-97><a class=lnlinks href=#hl-16-97> 97</a>
</span><span class=lnt id=hl-16-98><a class=lnlinks href=#hl-16-98> 98</a>
</span><span class=lnt id=hl-16-99><a class=lnlinks href=#hl-16-99> 99</a>
</span><span class=lnt id=hl-16-100><a class=lnlinks href=#hl-16-100>100</a>
</span><span class=lnt id=hl-16-101><a class=lnlinks href=#hl-16-101>101</a>
</span><span class=lnt id=hl-16-102><a class=lnlinks href=#hl-16-102>102</a>
</span><span class=lnt id=hl-16-103><a class=lnlinks href=#hl-16-103>103</a>
</span><span class=lnt id=hl-16-104><a class=lnlinks href=#hl-16-104>104</a>
</span><span class=lnt id=hl-16-105><a class=lnlinks href=#hl-16-105>105</a>
</span><span class=lnt id=hl-16-106><a class=lnlinks href=#hl-16-106>106</a>
</span><span class=lnt id=hl-16-107><a class=lnlinks href=#hl-16-107>107</a>
</span><span class=lnt id=hl-16-108><a class=lnlinks href=#hl-16-108>108</a>
</span><span class=lnt id=hl-16-109><a class=lnlinks href=#hl-16-109>109</a>
</span><span class=lnt id=hl-16-110><a class=lnlinks href=#hl-16-110>110</a>
</span><span class=lnt id=hl-16-111><a class=lnlinks href=#hl-16-111>111</a>
</span><span class=lnt id=hl-16-112><a class=lnlinks href=#hl-16-112>112</a>
</span><span class=lnt id=hl-16-113><a class=lnlinks href=#hl-16-113>113</a>
</span><span class=lnt id=hl-16-114><a class=lnlinks href=#hl-16-114>114</a>
</span><span class=lnt id=hl-16-115><a class=lnlinks href=#hl-16-115>115</a>
</span><span class=lnt id=hl-16-116><a class=lnlinks href=#hl-16-116>116</a>
</span><span class=lnt id=hl-16-117><a class=lnlinks href=#hl-16-117>117</a>
</span><span class=lnt id=hl-16-118><a class=lnlinks href=#hl-16-118>118</a>
</span><span class=lnt id=hl-16-119><a class=lnlinks href=#hl-16-119>119</a>
</span><span class=lnt id=hl-16-120><a class=lnlinks href=#hl-16-120>120</a>
</span><span class=lnt id=hl-16-121><a class=lnlinks href=#hl-16-121>121</a>
</span><span class=lnt id=hl-16-122><a class=lnlinks href=#hl-16-122>122</a>
</span><span class=lnt id=hl-16-123><a class=lnlinks href=#hl-16-123>123</a>
</span><span class=lnt id=hl-16-124><a class=lnlinks href=#hl-16-124>124</a>
</span><span class=lnt id=hl-16-125><a class=lnlinks href=#hl-16-125>125</a>
</span><span class=lnt id=hl-16-126><a class=lnlinks href=#hl-16-126>126</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>InventoryManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>db_connection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db_connection</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>distributed_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Redis 분산 락 컨텍스트 매니저&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_acquired</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 락 획득 시도 (timeout 내에서)</span>
</span></span><span class=line><span class=cl>            <span class=n>lock_acquired</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>lock_key</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=s2>&#34;locked&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># 키가 존재하지 않을 때만 설정</span>
</span></span><span class=line><span class=cl>                <span class=n>ex</span><span class=o>=</span><span class=n>timeout</span>  <span class=c1># 만료 시간 설정</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>lock_acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Failed to acquire distributed lock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>yield</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>lock_acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 락 해제</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>user_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 처리 (Race Condition 안전)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;inventory_lock:</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>distributed_lock</span><span class=p>(</span><span class=n>lock_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 데이터베이스 트랜잭션 시작</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span> <span class=k>as</span> <span class=n>cursor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 현재 재고 조회 (FOR UPDATE로 행 락)</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                        SELECT stock_quantity 
</span></span></span><span class=line><span class=cl><span class=s2>                        FROM products 
</span></span></span><span class=line><span class=cl><span class=s2>                        WHERE product_id = </span><span class=si>%s</span><span class=s2> 
</span></span></span><span class=line><span class=cl><span class=s2>                        FOR UPDATE
</span></span></span><span class=line><span class=cl><span class=s2>                    &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>product_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=ow>not</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Product not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>current_stock</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 재고 확인</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>current_stock</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Insufficient stock&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;available&#34;</span><span class=p>:</span> <span class=n>current_stock</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 재고 차감</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                        UPDATE products 
</span></span></span><span class=line><span class=cl><span class=s2>                        SET stock_quantity = stock_quantity - </span><span class=si>%s</span><span class=s2>,
</span></span></span><span class=line><span class=cl><span class=s2>                            updated_at = NOW()
</span></span></span><span class=line><span class=cl><span class=s2>                        WHERE product_id = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>                    &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>quantity</span><span class=p>,</span> <span class=n>product_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 주문 기록 생성</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                        INSERT INTO orders (user_id, product_id, quantity, order_date)
</span></span></span><span class=line><span class=cl><span class=s2>                        VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, NOW())
</span></span></span><span class=line><span class=cl><span class=s2>                    &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 트랜잭션 커밋</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Order processed successfully&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;remaining_stock&#34;</span><span class=p>:</span> <span class=n>current_stock</span> <span class=o>-</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Order processing failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db_connection</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>database</span><span class=o>=</span><span class=s2>&#34;ecommerce&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=o>=</span><span class=s2>&#34;postgres&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=o>=</span><span class=s2>&#34;password&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inventory_manager</span> <span class=o>=</span> <span class=n>InventoryManager</span><span class=p>(</span><span class=n>redis_client</span><span class=p>,</span> <span class=n>db_connection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 동시 주문 시뮬레이션</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>simulate_order</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>user_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>inventory_manager</span><span class=o>.</span><span class=n>process_order</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;User </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 같은 상품에 대한 동시 주문</span>
</span></span><span class=line><span class=cl><span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span><span class=o>=</span><span class=n>simulate_order</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;user_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>thread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-멀티스레드-환경에서-은행-계좌-잔액-업데이트-처리>사례: 멀티스레드 환경에서 은행 계좌 잔액 업데이트 처리<a hidden class=anchor aria-hidden=true href=#사례-멀티스레드-환경에서-은행-계좌-잔액-업데이트-처리>#</a></h5><p><strong>시나리오</strong>: 멀티스레드 환경에서 은행 계좌 잔액 업데이트 처리</p><p><strong>시스템 구성</strong>:</p><ul><li>애플리케이션 서버</li><li>데이터베이스 서버</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>sequenceDiagram
  participant Client
  participant AppServer
  participant DB
  Client-&gt;&gt;AppServer: 잔액 출금 요청
  AppServer-&gt;&gt;DB: SELECT 잔액 FROM 계좌
  AppServer-&gt;&gt;DB: UPDATE 계좌 SET 잔액=잔액-요청금액
</pre><p><strong>Workflow</strong>:</p><ul><li>두 사용자가 거의 동시에 인출을 요청</li><li>동기화 없이 처리 시, 잔액이 잘못 계산됨</li></ul><p><strong>역할</strong>:</p><ul><li>동기화 객체 (락/트랜잭션) 는 임계구역 진입 제어</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>없음: 두 인출 요청이 동시에 반영되어 잔고 마이너스 또는 데이터 손실</li><li>있음: 하나의 인출 완료 후 다른 요청 처리되어 무결성 유지</li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16>16</a>
</span><span class=lnt id=hl-18-17><a class=lnlinks href=#hl-18-17>17</a>
</span><span class=lnt id=hl-18-18><a class=lnlinks href=#hl-18-18>18</a>
</span><span class=lnt id=hl-18-19><a class=lnlinks href=#hl-18-19>19</a>
</span><span class=lnt id=hl-18-20><a class=lnlinks href=#hl-18-20>20</a>
</span><span class=lnt id=hl-18-21><a class=lnlinks href=#hl-18-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># threading 모듈 사용한 계좌 잔액 처리 예시</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>balance</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>withdraw</span><span class=p>(</span><span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>balance</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>lock</span><span class=p>:</span>  <span class=c1># 락으로 임계구역 보호</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>balance</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>balance</span> <span class=o>-=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;출금: </span><span class=si>{</span><span class=n>amount</span><span class=si>}</span><span class=s2>, 남은 잔액: </span><span class=si>{</span><span class=n>balance</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;잔액 부족!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 여러 스레드가 동시에 접근해도 안전</span>
</span></span><span class=line><span class=cl><span class=n>thread1</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>withdraw</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>600</span><span class=p>,))</span>
</span></span><span class=line><span class=cl><span class=n>thread2</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>withdraw</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>500</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>thread1</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>thread2</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-금융-시스템---계좌-이체-중-동시-접근-문제>사례: 금융 시스템 - 계좌 이체 중 동시 접근 문제<a hidden class=anchor aria-hidden=true href=#사례-금융-시스템---계좌-이체-중-동시-접근-문제>#</a></h5><p><strong>시나리오</strong>:</p><ul><li>고객 A 가 A 계좌 → B 계좌로 이체 요청</li><li>동시에 고객 B 가 A 계좌 → C 계좌로 이체 요청</li></ul><p><strong>문제 발생 가능성</strong>:</p><ul><li>A 계좌 잔액 체크 및 출금이 두 요청에서 동시에 발생</li><li>Race Condition 으로 인해 <strong>한 번만 인출되어야 할 잔액이 두 번 인출</strong>됨</li></ul><p><strong>해결 전략</strong>:</p><table><thead><tr><th>전략</th><th>적용 방식</th></tr></thead><tbody><tr><td>트랜잭션 처리</td><td>DB 레벨에서 BEGIN → UPDATE → COMMIT</td></tr><tr><td>행 레벨 락</td><td><code>SELECT … FOR UPDATE</code></td></tr><tr><td>Idempotent 키</td><td>이체 요청에 고유 식별자 부여</td></tr><tr><td>분산 락</td><td>Redis Redlock 으로 계좌별 Lock 제어</td></tr></tbody></table><p><strong>구현 예시</strong>: Python + SQLAlchemy + PostgreSQL</p><ul><li><code>FOR UPDATE</code> 기반 트랜잭션으로 Race Condition 방지</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17>17</a>
</span><span class=lnt id=hl-19-18><a class=lnlinks href=#hl-19-18>18</a>
</span><span class=lnt id=hl-19-19><a class=lnlinks href=#hl-19-19>19</a>
</span><span class=lnt id=hl-19-20><a class=lnlinks href=#hl-19-20>20</a>
</span><span class=lnt id=hl-19-21><a class=lnlinks href=#hl-19-21>21</a>
</span><span class=lnt id=hl-19-22><a class=lnlinks href=#hl-19-22>22</a>
</span><span class=lnt id=hl-19-23><a class=lnlinks href=#hl-19-23>23</a>
</span><span class=lnt id=hl-19-24><a class=lnlinks href=#hl-19-24>24</a>
</span><span class=lnt id=hl-19-25><a class=lnlinks href=#hl-19-25>25</a>
</span><span class=lnt id=hl-19-26><a class=lnlinks href=#hl-19-26>26</a>
</span><span class=lnt id=hl-19-27><a class=lnlinks href=#hl-19-27>27</a>
</span><span class=lnt id=hl-19-28><a class=lnlinks href=#hl-19-28>28</a>
</span><span class=lnt id=hl-19-29><a class=lnlinks href=#hl-19-29>29</a>
</span><span class=lnt id=hl-19-30><a class=lnlinks href=#hl-19-30>30</a>
</span><span class=lnt id=hl-19-31><a class=lnlinks href=#hl-19-31>31</a>
</span><span class=lnt id=hl-19-32><a class=lnlinks href=#hl-19-32>32</a>
</span><span class=lnt id=hl-19-33><a class=lnlinks href=#hl-19-33>33</a>
</span><span class=lnt id=hl-19-34><a class=lnlinks href=#hl-19-34>34</a>
</span><span class=lnt id=hl-19-35><a class=lnlinks href=#hl-19-35>35</a>
</span><span class=lnt id=hl-19-36><a class=lnlinks href=#hl-19-36>36</a>
</span><span class=lnt id=hl-19-37><a class=lnlinks href=#hl-19-37>37</a>
</span><span class=lnt id=hl-19-38><a class=lnlinks href=#hl-19-38>38</a>
</span><span class=lnt id=hl-19-39><a class=lnlinks href=#hl-19-39>39</a>
</span><span class=lnt id=hl-19-40><a class=lnlinks href=#hl-19-40>40</a>
</span><span class=lnt id=hl-19-41><a class=lnlinks href=#hl-19-41>41</a>
</span><span class=lnt id=hl-19-42><a class=lnlinks href=#hl-19-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># account_transfer.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span><span class=p>,</span> <span class=n>text</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s2>&#34;postgresql://user:pass@localhost/bank&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transfer</span><span class=p>(</span><span class=n>from_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>to_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 락 획득: 계좌 2개 모두 잠금</span>
</span></span><span class=line><span class=cl>        <span class=n>from_acc</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM accounts WHERE id = :id FOR UPDATE&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>from_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>to_acc</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM accounts WHERE id = :id FOR UPDATE&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>to_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>from_acc</span><span class=o>.</span><span class=n>balance</span> <span class=o>&lt;</span> <span class=n>amount</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Insufficient funds&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 이체 수행</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance - :amount WHERE id = :id&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=n>amount</span><span class=p>,</span> <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>from_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance + :amount WHERE id = :id&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=n>amount</span><span class=p>,</span> <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>to_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ Transfer complete&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;❌ Transfer failed:&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-게임-서버---보상-중복-지급>사례: <strong>게임 서버 - 보상 중복 지급</strong><a hidden class=anchor aria-hidden=true href=#사례-게임-서버---보상-중복-지급>#</a></h5><p><strong>시나리오</strong>:</p><ul><li>유저가 특정 퀘스트 완료 후 보상을 수령</li><li>UI 를 빠르게 여러 번 클릭하면 동시에 요청 전송</li></ul><p><strong>문제 발생 가능성</strong>:</p><ul><li>보상 지급 함수가 동시에 호출되어 <strong>중복 보상 지급</strong></li></ul><p><strong>해결 전략</strong>:</p><table><thead><tr><th>전략</th><th>적용 방식</th></tr></thead><tbody><tr><td>Atomic Flag</td><td>Redis 에 " 보상 수령 여부 " 저장, setnx 사용</td></tr><tr><td>DB 트랜잭션</td><td>보상 지급 기록 존재 여부 확인 후 Insert</td></tr><tr><td>Queue 처리</td><td>요청을 비동기 큐에 넣고 순차 처리</td></tr><tr><td>API Rate Limit</td><td>보상 수령 요청 단시간 내 1 회 제한</td></tr></tbody></table><p><strong>구현 예시</strong>: Python + FastAPI + Redis</p><ul><li>보상을 중복으로 수령하지 않도록 Redis + Idempotent 키 사용</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># reward_claim.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>aioredis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>redis</span> <span class=o>=</span> <span class=n>aioredis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=s2>&#34;redis://localhost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/claim/</span><span class=si>{user_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>claim_reward</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>reward_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;reward:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>was_set</span> <span class=o>=</span> <span class=k>await</span> <span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>reward_key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span>  <span class=c1># 1시간 동안 재수령 금지</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>was_set</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;이미 보상을 수령하셨습니다.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 보상 지급 로직</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=s2>&#34;reward&#34;</span><span class=p>:</span> <span class=s2>&#34;100 Gold&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-분산-시스템---마이크로서비스-상태-동기화-실패>사례: 분산 시스템 - 마이크로서비스 상태 동기화 실패<a hidden class=anchor aria-hidden=true href=#사례-분산-시스템---마이크로서비스-상태-동기화-실패>#</a></h5><p><strong>시나리오</strong>:</p><ul><li>두 개의 마이크로서비스 (MS-A, MS-B) 가 동일한 자원 (User Profile) 을 수정</li><li>각각 독립적으로 처리하므로 Race 발생 가능</li></ul><p><strong>문제 발생 가능성</strong>:</p><ul><li>프로필 수정 충돌 → <strong>최종 상태가 덮어씌워짐 (Lost Update)</strong></li></ul><p><strong>해결 전략</strong>:</p><table><thead><tr><th>전략</th><th>적용 방식</th></tr></thead><tbody><tr><td>Optimistic Locking</td><td><code>version</code> 컬럼 기반 CAS</td></tr><tr><td>이벤트 소싱</td><td>상태 변경을 명령 기반으로 처리</td></tr><tr><td>중앙 Lock 서비스</td><td>Redis, Zookeeper 등 외부 락 관리</td></tr><tr><td>Outbox 패턴</td><td>변경 사항을 메시지 큐로 전달 후 처리</td></tr></tbody></table><p><strong>구현 예시</strong>: Python + SQLAlchemy</p><ul><li>버전 번호를 활용하여 상태 갱신 중 충돌 방지</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># optimistic_update.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Table</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>MetaData</span><span class=p>,</span> <span class=n>select</span><span class=p>,</span> <span class=n>update</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>metadata</span> <span class=o>=</span> <span class=n>MetaData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>profile</span> <span class=o>=</span> <span class=n>Table</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;profiles&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Column</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>Column</span><span class=p>(</span><span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>Column</span><span class=p>(</span><span class=s2>&#34;version&#34;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_profile</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=nb>id</span><span class=p>,</span> <span class=n>new_name</span><span class=p>,</span> <span class=n>version</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=p>(</span><span class=n>profile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>profile</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>profile</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>version</span> <span class=o>==</span> <span class=n>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>values</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>new_name</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=n>version</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;🔁 Update conflict detected (Race Condition)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ Profile updated&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=사례-안전한-결제-처리-시스템-설계>사례: 안전한 결제 처리 시스템 설계<a hidden class=anchor aria-hidden=true href=#사례-안전한-결제-처리-시스템-설계>#</a></h5><p>다음은 Race Condition 을 방지하기 위한 <strong>안전한 결제 처리 시스템 설계 예시</strong>이다.<br>핵심은 **직렬화 (serialization), 분산 락 (distributed lock), 상태 동기화 (state sync)**이다.</p><p><strong>시나리오</strong></p><ul><li>사용자 A 가 결제 요청을 동시에 2 번 보내도, 중복 결제가 발생하지 않도록 보장</li></ul><p><strong>시스템 구성 요소</strong></p><table><thead><tr><th>구성 요소</th><th>역할</th></tr></thead><tbody><tr><td>API Gateway</td><td>모든 요청을 라우팅 및 rate-limit</td></tr><tr><td>Web API 서버</td><td>사용자 요청 처리</td></tr><tr><td>Redis</td><td>분산 락 + 캐시 (잔액, 처리 상태)</td></tr><tr><td>MySQL</td><td>트랜잭션 및 이력 저장</td></tr><tr><td>메시지 큐 (Kafka)</td><td>결제 결과 및 후속 처리 이벤트 발행</td></tr><tr><td>락 매니저</td><td>사용자별 락 획득 및 해제 관리</td></tr></tbody></table><pre class=mermaid>flowchart TD
  A[&#34;사용자 요청 (결제)&#34;] --&gt; B[API Gateway]
  B --&gt; C[Web API 서버]
  C --&gt; D[Redis: 사용자 락 획득]
  D --&gt; E{락 성공?}
  E -- Yes --&gt; F[잔액 확인 및 감소]
  F --&gt; G[MySQL 트랜잭션 처리]
  G --&gt; H[Kafka로 결제 이벤트 발행]
  H --&gt; I[Redis: 잔액 캐시 갱신 후 락 해제]
  E -- No --&gt; Z[429 Too Many Requests]
</pre><p><strong>설계 워크플로우</strong>:</p><ol><li><strong>요청 수신</strong>: 사용자 요청이 API Gateway 를 통해 도착</li><li><strong>락 획득</strong>: Redis 를 사용하여 사용자 고유 Key 기반 분산 락 획득 시도</li><li><strong>락 성공 여부 판단</strong><ul><li>성공: 다음 단계 진행</li><li>실패: 요청 거부 (HTTP 429)</li></ul></li><li><strong>비즈니스 처리</strong><ul><li>잔액 조회 → 차감</li><li>MySQL 에 트랜잭션 저장</li></ul></li><li><strong>이벤트 발행</strong>: Kafka 등 메시지 큐에 결제 결과 발행</li><li><strong>락 해제 및 응답 반환</strong><ul><li>Redis 락 해제</li><li>응답 처리 (200 OK 또는 400/429 등)</li></ul></li></ol><p><strong>설계 전략의 핵심 포인트</strong>:</p><table><thead><tr><th>전략</th><th>설명</th></tr></thead><tbody><tr><td>분산 락</td><td>사용자 단위의 결제 처리를 직렬화 (Redis, Redlock)</td></tr><tr><td>상태 동기화</td><td>Redis 캐시와 MySQL 상태 불일치 방지</td></tr><tr><td>트랜잭션 일관성 유지</td><td>DB 트랜잭션을 통해 double spending 방지</td></tr><tr><td>이벤트 기반 후속 처리</td><td>Kafka 발행을 통해 비동기적 후처리 가능</td></tr><tr><td>요청 단일화 (Idempotency)</td><td>동일 요청이면 동일 결과 반환 → 중복 방지</td></tr></tbody></table><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20>20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21>21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22>22</a>
</span><span class=lnt id=hl-23-23><a class=lnlinks href=#hl-23-23>23</a>
</span><span class=lnt id=hl-23-24><a class=lnlinks href=#hl-23-24>24</a>
</span><span class=lnt id=hl-23-25><a class=lnlinks href=#hl-23-25>25</a>
</span><span class=lnt id=hl-23-26><a class=lnlinks href=#hl-23-26>26</a>
</span><span class=lnt id=hl-23-27><a class=lnlinks href=#hl-23-27>27</a>
</span><span class=lnt id=hl-23-28><a class=lnlinks href=#hl-23-28>28</a>
</span><span class=lnt id=hl-23-29><a class=lnlinks href=#hl-23-29>29</a>
</span><span class=lnt id=hl-23-30><a class=lnlinks href=#hl-23-30>30</a>
</span><span class=lnt id=hl-23-31><a class=lnlinks href=#hl-23-31>31</a>
</span><span class=lnt id=hl-23-32><a class=lnlinks href=#hl-23-32>32</a>
</span><span class=lnt id=hl-23-33><a class=lnlinks href=#hl-23-33>33</a>
</span><span class=lnt id=hl-23-34><a class=lnlinks href=#hl-23-34>34</a>
</span><span class=lnt id=hl-23-35><a class=lnlinks href=#hl-23-35>35</a>
</span><span class=lnt id=hl-23-36><a class=lnlinks href=#hl-23-36>36</a>
</span><span class=lnt id=hl-23-37><a class=lnlinks href=#hl-23-37>37</a>
</span><span class=lnt id=hl-23-38><a class=lnlinks href=#hl-23-38>38</a>
</span><span class=lnt id=hl-23-39><a class=lnlinks href=#hl-23-39>39</a>
</span><span class=lnt id=hl-23-40><a class=lnlinks href=#hl-23-40>40</a>
</span><span class=lnt id=hl-23-41><a class=lnlinks href=#hl-23-41>41</a>
</span><span class=lnt id=hl-23-42><a class=lnlinks href=#hl-23-42>42</a>
</span><span class=lnt id=hl-23-43><a class=lnlinks href=#hl-23-43>43</a>
</span><span class=lnt id=hl-23-44><a class=lnlinks href=#hl-23-44>44</a>
</span><span class=lnt id=hl-23-45><a class=lnlinks href=#hl-23-45>45</a>
</span><span class=lnt id=hl-23-46><a class=lnlinks href=#hl-23-46>46</a>
</span><span class=lnt id=hl-23-47><a class=lnlinks href=#hl-23-47>47</a>
</span><span class=lnt id=hl-23-48><a class=lnlinks href=#hl-23-48>48</a>
</span><span class=lnt id=hl-23-49><a class=lnlinks href=#hl-23-49>49</a>
</span><span class=lnt id=hl-23-50><a class=lnlinks href=#hl-23-50>50</a>
</span><span class=lnt id=hl-23-51><a class=lnlinks href=#hl-23-51>51</a>
</span><span class=lnt id=hl-23-52><a class=lnlinks href=#hl-23-52>52</a>
</span><span class=lnt id=hl-23-53><a class=lnlinks href=#hl-23-53>53</a>
</span><span class=lnt id=hl-23-54><a class=lnlinks href=#hl-23-54>54</a>
</span><span class=lnt id=hl-23-55><a class=lnlinks href=#hl-23-55>55</a>
</span><span class=lnt id=hl-23-56><a class=lnlinks href=#hl-23-56>56</a>
</span><span class=lnt id=hl-23-57><a class=lnlinks href=#hl-23-57>57</a>
</span><span class=lnt id=hl-23-58><a class=lnlinks href=#hl-23-58>58</a>
</span><span class=lnt id=hl-23-59><a class=lnlinks href=#hl-23-59>59</a>
</span><span class=lnt id=hl-23-60><a class=lnlinks href=#hl-23-60>60</a>
</span><span class=lnt id=hl-23-61><a class=lnlinks href=#hl-23-61>61</a>
</span><span class=lnt id=hl-23-62><a class=lnlinks href=#hl-23-62>62</a>
</span><span class=lnt id=hl-23-63><a class=lnlinks href=#hl-23-63>63</a>
</span><span class=lnt id=hl-23-64><a class=lnlinks href=#hl-23-64>64</a>
</span><span class=lnt id=hl-23-65><a class=lnlinks href=#hl-23-65>65</a>
</span><span class=lnt id=hl-23-66><a class=lnlinks href=#hl-23-66>66</a>
</span><span class=lnt id=hl-23-67><a class=lnlinks href=#hl-23-67>67</a>
</span><span class=lnt id=hl-23-68><a class=lnlinks href=#hl-23-68>68</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Kafka/Redis 기반 분산 트랜잭션 예시</span>
</span></span><span class=line><span class=cl><span class=c1># 시나리오: 사용자 결제 요청 시 Redis 분산 락 획득 후 Kafka로 이벤트 발행 + MySQL 트랜잭션 처리</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaProducer</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pymysql</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis 분산 락 구성</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>acquire_lock</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s2>&#34;locked&#34;</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=n>ttl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>release_lock</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kafka 프로듀서 초기화</span>
</span></span><span class=line><span class=cl><span class=n>producer</span> <span class=o>=</span> <span class=n>KafkaProducer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap_servers</span><span class=o>=</span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value_serializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>v</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># MySQL 연결</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>user</span><span class=o>=</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=s1>&#39;pass&#39;</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=s1>&#39;payments&#39;</span><span class=p>,</span> <span class=n>autocommit</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 결제 처리 함수</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_payment</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>StrictRedis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;lock:user:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>acquire_lock</span><span class=p>(</span><span class=n>redis_client</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[LOCK FAIL] Retry later.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># DB 조회 및 트랜잭션 처리</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT balance FROM accounts WHERE user_id=</span><span class=si>%s</span><span class=s2> FOR UPDATE&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>balance</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>balance</span> <span class=o>&lt;</span> <span class=n>amount</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[FAIL] Insufficient balance.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance=balance - </span><span class=si>%s</span><span class=s2> WHERE user_id=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>amount</span><span class=p>,</span> <span class=n>user_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO logs (user_id, amount, status) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>,</span> <span class=s1>&#39;PAID&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Kafka 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=n>producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;payment-events&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;amount&#39;</span><span class=p>:</span> <span class=n>amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;PAID&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[SUCCESS] Payment processed.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[ERROR] Transaction failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>release_lock</span><span class=p>(</span><span class=n>redis_client</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 예시 실행</span>
</span></span><span class=line><span class=cl><span class=n>process_payment</span><span class=p>(</span><span class=n>user_id</span><span class=o>=</span><span class=mi>123</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>우선 위에 작성된 것은 <strong>Kafka/Redis 기반 분산 트랜잭션 예시 코드</strong>.</p><p>주요 특징은 다음과 같다:</p><ul><li><strong>Redis 기반 분산 락</strong>으로 사용자별 임계 구역 보호</li><li><strong>MySQL 트랜잭션</strong>을 통해 일관성 있는 결제 처리</li><li><strong>Kafka 프로듀서</strong>를 통한 비동기 이벤트 발행</li></ul><h5 id=사례-redis-redlock-구현---멀티-인스턴스-기반-안전한-분산-락>사례: Redis Redlock 구현 - 멀티 인스턴스 기반 안전한 분산 락<a hidden class=anchor aria-hidden=true href=#사례-redis-redlock-구현---멀티-인스턴스-기반-안전한-분산-락>#</a></h5><p>Redis Redlock 은 Redis 의 단일 인스턴스 락보다 더 안전하게 분산 환경에서 <strong>동시에 여러 노드에서 동일 자원에 대한 동기화 제어</strong>를 할 수 있도록 하는 <strong>분산 락 알고리즘</strong>이다.</p><p>원리는 다음과 같다:</p><ul><li>5 개 Redis 노드 중 3 개 이상에서 락을 동일 키로 동시에 성공했을 경우만 유효한 락으로 간주한다.</li></ul><p><strong>Redlock 작동 원리</strong>:</p><pre class=mermaid>sequenceDiagram
    participant NodeA
    participant NodeB
    participant NodeC
    participant NodeD
    participant NodeE

    Client-&gt;&gt;NodeA: SET lock:key NX PX 3000
    Client-&gt;&gt;NodeB: SET lock:key NX PX 3000
    Client-&gt;&gt;NodeC: SET lock:key NX PX 3000
    Client-&gt;&gt;NodeD: SET lock:key NX PX 3000
    Client-&gt;&gt;NodeE: SET lock:key NX PX 3000

    Note over Client: 3/5 이상 성공 시 유효한 락으로 간주
</pre><p><strong>Python 구현 예시</strong>: redlock-py 사용</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install redis redlock-py
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1> 1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2> 2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3> 3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4> 4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5> 5</a>
</span><span class=lnt id=hl-26-6><a class=lnlinks href=#hl-26-6> 6</a>
</span><span class=lnt id=hl-26-7><a class=lnlinks href=#hl-26-7> 7</a>
</span><span class=lnt id=hl-26-8><a class=lnlinks href=#hl-26-8> 8</a>
</span><span class=lnt id=hl-26-9><a class=lnlinks href=#hl-26-9> 9</a>
</span><span class=lnt id=hl-26-10><a class=lnlinks href=#hl-26-10>10</a>
</span><span class=lnt id=hl-26-11><a class=lnlinks href=#hl-26-11>11</a>
</span><span class=lnt id=hl-26-12><a class=lnlinks href=#hl-26-12>12</a>
</span><span class=lnt id=hl-26-13><a class=lnlinks href=#hl-26-13>13</a>
</span><span class=lnt id=hl-26-14><a class=lnlinks href=#hl-26-14>14</a>
</span><span class=lnt id=hl-26-15><a class=lnlinks href=#hl-26-15>15</a>
</span><span class=lnt id=hl-26-16><a class=lnlinks href=#hl-26-16>16</a>
</span><span class=lnt id=hl-26-17><a class=lnlinks href=#hl-26-17>17</a>
</span><span class=lnt id=hl-26-18><a class=lnlinks href=#hl-26-18>18</a>
</span><span class=lnt id=hl-26-19><a class=lnlinks href=#hl-26-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>redlock</span> <span class=kn>import</span> <span class=n>Redlock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dlm</span> <span class=o>=</span> <span class=n>Redlock</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;redis-1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=mi>6379</span><span class=p>,</span> <span class=s2>&#34;db&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;redis-2&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=mi>6379</span><span class=p>,</span> <span class=s2>&#34;db&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;redis-3&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=mi>6379</span><span class=p>,</span> <span class=s2>&#34;db&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 락 시도</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>dlm</span><span class=o>.</span><span class=n>lock</span><span class=p>(</span><span class=s2>&#34;resource-key&#34;</span><span class=p>,</span> <span class=mi>3000</span><span class=p>)</span>  <span class=c1># 3초 유효</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;락 획득 성공. 작업 진행 중…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># critical section</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dlm</span><span class=o>.</span><span class=n>unlock</span><span class=p>(</span><span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;락 실패. 다른 프로세스에서 선점 중.&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Redlock 적용 시 주의사항</strong>:</p><table><thead><tr><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>락 유효 시간 설정</td><td>작업 시간이 락 TTL 안에 끝나도록 보장해야 함</td></tr><tr><td>클럭 동기화</td><td>모든 Redis 노드와 클라이언트는 시간 동기화 (NTP 등) 필수</td></tr><tr><td>노드 5 개 권장</td><td>quorum 계산 시 3/5 보장, 가용성과 안전성 균형</td></tr><tr><td>fallback 처리</td><td>락 실패 시 지연 재시도 (backoff), 작업 건너뛰기 등의 정책 설계 필요</td></tr></tbody></table><h3 id=운영-및-최적화-operations--optimization>운영 및 최적화 (Operations & Optimization)<a hidden class=anchor aria-hidden=true href=#운영-및-최적화-operations--optimization>#</a></h3><h4 id=운영에서의-핵심-체크리스트->운영에서의 핵심 체크리스트 ✅<a hidden class=anchor aria-hidden=true href=#운영에서의-핵심-체크리스트->#</a></h4><ul><li>✅ 동기화 범위는 꼭 <strong>최소화</strong>하되, <strong>일관성</strong>은 포기하지 말 것</li><li>✅ <strong>Lock Timeout</strong>, <strong>Retry 제한</strong>, <strong>중복 방지 키</strong>는 반드시 포함할 것</li><li>✅ ** 관측 지표 (Log + Metric)** 로 Race Condition 징후를 실시간 감지할 수 있도록 구성</li><li>✅ <strong>인증 및 결제</strong> 등 <strong>보안 임계 흐름</strong>에는 트랜잭션과 락을 결합하여 설계할 것</li></ul><h4 id=보안-및-거버넌스>보안 및 거버넌스<a hidden class=anchor aria-hidden=true href=#보안-및-거버넌스>#</a></h4><p>Race Condition 은 단순한 병렬 처리 오류를 넘어, <strong>보안 취약점 (Security Vulnerability)</strong> 으로도 이어질 수 있다.<br>특히, <strong>권한 상승 (Privilege Escalation), TOCTOU(Time-Of-Check to Time-Of-Use), 파일 오염, 인증 우회 등</strong>에서 치명적이다.</p><table><thead><tr><th>분류</th><th>위협 또는 이슈</th><th>원인 설명</th><th>대응 전략</th><th>구현 기법 또는 예시</th></tr></thead><tbody><tr><td><strong>권한 검증 실패</strong></td><td>인증과 자원 접근 분리, 권한 체크 누락</td><td>Race 중 우선 접근한 요청이 권한 없이 자원 사용</td><td>인증 - 접근 동시 처리, Same Block Execution</td><td>JWT 발급 시 Redis Lock, Session Stickiness</td></tr><tr><td><strong>시점 불일치 공격</strong></td><td>TOCTOU 패턴: 체크와 실행 간 타이밍 간극</td><td>검사 후 대상 변경 가능 (파일, 권한 등)</td><td>파일 기술자 기반 접근, 파일 락</td><td><code>open() + fstat()</code> 조합, Capabilities 적용</td></tr><tr><td><strong>리소스 경합</strong></td><td>과도한 동시 요청으로 자원 고갈</td><td>임계 자원 (스레드/DB 커넥션 등) 의 경쟁으로 응답 지연 or 마비</td><td>Rate Limiting, Circuit Breaker, Fair Scheduling</td><td>토큰 버킷 알고리즘, <code>PromiseQueue</code>, <code>nginx limit_conn</code></td></tr><tr><td><strong>정보 유출</strong></td><td>공유 메모리 접근 순서 문제로 인해 민감 정보 노출 가능</td><td>메모리 경합 중 미정리 데이터 접근</td><td>메모리 격리, 사용 후 초기화</td><td>TLS, Private Heap, Zeroization</td></tr><tr><td><strong>규정 위반 리스크</strong></td><td>GDPR/PCI-DSS 요구사항 불충족</td><td>Race 로 인해 일관성/무결성 불보장</td><td>상태 이력 추적, 중복 검출 ID, 변경 로그 기록</td><td>Event Sourcing, Immutable Log Store</td></tr></tbody></table><ul><li><p><strong>보안과 동시성 제어는 결합되어야 한다</strong>: 단순 락 제어만으로는 보안 위협을 막기 어렵고, 권한 검증이 동기화된 방식으로 설계되어야 한다.</p></li><li><p><strong>컴플라이언스와 Race Condition 은 분리된 개념이 아니다</strong>: 금융/결제 시스템의 일관성은 법적 요건이며, 잘못된 트랜잭션 처리로 인한 벌금 및 신뢰 손실로 직결된다.</p></li><li><p><strong>동시성 버그는 악용 가능성을 고려해야 한다</strong>: 이는 단순한 기술적 결함이 아닌 보안 이슈로 간주되어야 하며, 대응 전략 역시 <code>보안 설계 원칙</code> 에 포함되어야 한다.</p></li></ul><h5 id=실-사례-및-cve-기반-분석>실 사례 및 CVE 기반 분석<a hidden class=anchor aria-hidden=true href=#실-사례-및-cve-기반-분석>#</a></h5><h6 id=linux-kernelcve-2016-5195-dirty-cow>Linux Kernel–CVE-2016-5195 (&ldquo;Dirty COW&rdquo;)<a hidden class=anchor aria-hidden=true href=#linux-kernelcve-2016-5195-dirty-cow>#</a></h6><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>시스템</strong></td><td>Linux Kernel (모든 배포판 영향)</td></tr><tr><td><strong>CVE</strong></td><td><a href=https://nvd.nist.gov/vuln/detail/CVE-2016-5195>CVE-2016-5195</a></td></tr><tr><td><strong>유형</strong></td><td>권한 상승 (Privilege Escalation)</td></tr><tr><td><strong>원인</strong></td><td><code>copy-on-write</code> 메커니즘에서 Race Condition 발생</td></tr><tr><td><strong>공격 시나리오</strong></td><td>비권한 사용자가 <code>read-only</code> 파일을 메모리 맵핑한 뒤, write 경합을 유도하여 내용 덮어씀</td></tr><tr><td><strong>대응</strong></td><td><code>COW</code> 경합 구간에 mutex 도입 → 원자적 쓰기 보장</td></tr></tbody></table><p><strong>요약</strong>: 사용자 권한에서 루트 권한으로 승격 가능한 치명적 race condition 사례.</p><h6 id=android-bindercve-2014-3153>Android Binder–CVE-2014-3153<a hidden class=anchor aria-hidden=true href=#android-bindercve-2014-3153>#</a></h6><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>시스템</strong></td><td>Android 커널</td></tr><tr><td><strong>CVE</strong></td><td><a href=https://nvd.nist.gov/vuln/detail/CVE-2014-3153>CVE-2014-3153</a></td></tr><tr><td><strong>유형</strong></td><td>권한 상승</td></tr><tr><td><strong>원인</strong></td><td><code>futex_wait</code> 함수에서 레이스 발생하여 커널 권한을 임의로 조작 가능</td></tr><tr><td><strong>공격 시나리오</strong></td><td>공격자가 futex 사용 시 커널 락 획득 타이밍 조작으로 커널 함수 포인터 덮어쓰기 가능</td></tr><tr><td><strong>대응</strong></td><td>경합 발생 조건 제거 및 세분화된 락 구조 재설계</td></tr></tbody></table><p><strong>요약</strong>: 단일 쓰레드 기반 모바일 환경에서도 Race Condition 은 권한 탈취 수단이 될 수 있음.</p><h6 id=opensslcve-2014-0160-heartbleed>OpenSSL–CVE-2014-0160 (&ldquo;Heartbleed&rdquo;)<a hidden class=anchor aria-hidden=true href=#opensslcve-2014-0160-heartbleed>#</a></h6><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>시스템</strong></td><td>OpenSSL (v1.0.1~1.0.1f)</td></tr><tr><td><strong>CVE</strong></td><td><a href=https://nvd.nist.gov/vuln/detail/CVE-2014-0160>CVE-2014-0160</a></td></tr><tr><td><strong>유형</strong></td><td>정보 유출 (Memory Leak)</td></tr><tr><td><strong>원인</strong></td><td>경합 자체는 아니지만, 동기화 및 경계 검사 누락 → 비동기 요청 시 메모리 과도 반환</td></tr><tr><td><strong>공격 시나리오</strong></td><td>클라이언트가 Heartbeat 요청 시 요청 길이 조작 → 64KB 메모리 덤프 가능</td></tr><tr><td><strong>대응</strong></td><td>버퍼 길이 체크 도입, 비동기 API 에 검증 절차 추가</td></tr></tbody></table><p><strong>요약</strong>: 동기화보다 경계 체크가 미흡할 경우 Race 의 영향을 더 크게 받을 수 있다는 사례.</p><h6 id=apache-tomcatcve-2017-12617>Apache Tomcat–CVE-2017-12617<a hidden class=anchor aria-hidden=true href=#apache-tomcatcve-2017-12617>#</a></h6><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>시스템</strong></td><td>Apache Tomcat (v7.0~9.0)</td></tr><tr><td><strong>CVE</strong></td><td><a href=https://nvd.nist.gov/vuln/detail/CVE-2017-12617>CVE-2017-12617</a></td></tr><tr><td><strong>유형</strong></td><td>권한 우회 (Unauthorized Upload)</td></tr><tr><td><strong>원인</strong></td><td>비동기 요청 처리 중 PUT 요청을 허용하고 상태 체크가 Race 에 노출</td></tr><tr><td><strong>공격 시나리오</strong></td><td>권한이 없는 사용자가 파일 업로드를 반복 시도 → 임시 파일이 실제 경로로 전환됨</td></tr><tr><td><strong>대응</strong></td><td>PUT 요청 제한, 쓰기 타이밍 동기화, 서버 설정 강화</td></tr></tbody></table><p><strong>요약</strong>: TOCTOU 성격이 강하며, 요청 - 검사 - 저장 간의 분리된 흐름이 Race 취약점으로 연결된 사례.</p><h6 id=firefoxcve-2022-38472>Firefox–CVE-2022-38472<a hidden class=anchor aria-hidden=true href=#firefoxcve-2022-38472>#</a></h6><table><thead><tr><th>항목</th><th>내용</th></tr></thead><tbody><tr><td><strong>시스템</strong></td><td>Mozilla Firefox</td></tr><tr><td><strong>CVE</strong></td><td><a href=https://nvd.nist.gov/vuln/detail/CVE-2022-38472>CVE-2022-38472</a></td></tr><tr><td><strong>유형</strong></td><td>Use-after-Free, 메모리 경합</td></tr><tr><td><strong>원인</strong></td><td>GC(Garbage Collection) 중 객체 해제 시점이 다른 스레드의 사용 시점과 경합</td></tr><tr><td><strong>공격 시나리오</strong></td><td>공격자가 고의적으로 객체 해제를 유도하고, 해당 메모리 영역을 재사용</td></tr><tr><td><strong>대응</strong></td><td>객체 수명 관리를 개선하고, 접근 전 객체 유효성 검증 추가</td></tr></tbody></table><p><strong>요약</strong>: UI 쓰레드, JS 엔진, GC 간 경합은 메모리 오염과 보안 이슈로 직결됨.</p><h5 id=owasp-기반-race-condition-보안-점검-체크리스트>OWASP 기반 Race Condition 보안 점검 체크리스트<a hidden class=anchor aria-hidden=true href=#owasp-기반-race-condition-보안-점검-체크리스트>#</a></h5><ul><li>Race Condition 은 단일 코드 문제가 아니라 <strong>시스템 설계 전반의 동기화 부족</strong>에서 발생.</li><li>OWASP 항목 대부분은 <strong>직접 Race 언급은 없지만</strong>, 내부적으로 경합 상황을 전제로 취약점이 발생함.</li><li>특히 <strong>TOCTOU 시나리오</strong>와 <strong>인증/권한 상승 흐름</strong>은 Race Condition 을 공격자가 활용하는 주요 경로.</li><li>체크리스트는 <strong>개발 단계 → 배포 전 테스트 → 운영 모니터링</strong>까지 전 주기 적용이 필요함.</li></ul><table><thead><tr><th>항목 코드</th><th>항목 이름</th><th>관련성 요약</th></tr></thead><tbody><tr><td><strong>A01:2021</strong></td><td>Broken Access Control</td><td>권한 상승 Race, 인증 우회</td></tr><tr><td><strong>A05:2021</strong></td><td>Security Misconfiguration</td><td>비정상 요청 시 Race 유발 설정 오류</td></tr><tr><td><strong>A07:2021</strong></td><td>Identification and Authentication Failures</td><td>인증 과정 Race 취약성</td></tr><tr><td><strong>A09:2021</strong></td><td>Security Logging and Monitoring Failures</td><td>Race Condition 탐지 실패</td></tr></tbody></table><h6 id=race-condition-보안-점검-체크리스트>Race Condition 보안 점검 체크리스트<a hidden class=anchor aria-hidden=true href=#race-condition-보안-점검-체크리스트>#</a></h6><table><thead><tr><th>항목 분류</th><th>점검 항목 내용</th><th>점검 방식</th><th>비고</th></tr></thead><tbody><tr><td><strong>인증/권한 검증</strong></td><td>인증 검증과 자원 접근이 <strong>동일 트랜잭션 내에서 처리</strong>되는가?</td><td>코드리뷰 / 테스트</td><td>Same-block Enforcement</td></tr><tr><td></td><td>동시 로그인 또는 중복 요청에 대해 <strong>동기화 제어</strong>가 존재하는가?</td><td>부하 테스트</td><td>Redis Lock 등</td></tr><tr><td><strong>TOCTOU 방지</strong></td><td>" 검사 후 사용 " 흐름이 존재하는 경우, 검사 결과가 <strong>무효화될 가능성</strong>이 있는가?</td><td>코드 분석</td><td>파일 시스템, 캐시, 메모리</td></tr><tr><td></td><td>TOCTOU 경로에 <strong>락 또는 atomic 연산</strong>이 적용되었는가?</td><td>코드 분석</td><td>atomicity 필요</td></tr><tr><td><strong>트랜잭션 무결성</strong></td><td>동시에 발생 가능한 작업들이 **직렬화 (Serializable)**되도록 보장하는가?</td><td>DB 트랜잭션 점검</td><td>격리 수준 설정</td></tr><tr><td></td><td>메시지 큐 처리 시 <strong>중복 메시지 처리 방어</strong>가 있는가?</td><td>메시지 재처리 테스트</td><td>Idempotency Key</td></tr><tr><td><strong>자원 경합 제어</strong></td><td>임계 구역에서 공유 자원 접근이 <strong>뮤텍스/세마포어/원자 연산</strong>으로 보호되는가?</td><td>코드 리뷰</td><td>Thread-safe 구조 여부</td></tr><tr><td></td><td>동일한 자원을 병렬로 처리할 경우, <strong>타임아웃 혹은 우선순위</strong> 제어가 있는가?</td><td>실행 시나리오 테스트</td><td>Deadlock 대응</td></tr><tr><td><strong>모니터링/탐지 체계</strong></td><td>인증, 자원 접근 등 민감 흐름에 대해 <strong>Trace ID / Structured Logging</strong>이 있는가?</td><td>로그 확인</td><td>관측 가능성 확보</td></tr><tr><td></td><td>Race 의심 상황에 대해 <strong>모니터링 알람/시각화 대시보드</strong>가 존재하는가?</td><td>운영 환경 점검</td><td>APM 도구 연계</td></tr><tr><td><strong>프레임워크 설정</strong></td><td>Web/App 서버에서 <strong>PUT/POST 재처리 요청</strong>에 대한 재검증이 활성화되어 있는가?</td><td>HTTP 시나리오 점검</td><td>Tomcat, Spring 등</td></tr><tr><td></td><td>세션 저장소 (Redis 등) 에 대해 <strong>동시 쓰기 제어</strong>가 적용되어 있는가?</td><td>Redis 명령 분석</td><td><code>SETNX</code>, <code>Redlock</code> 등</td></tr></tbody></table><h4 id=모니터링-및-관측성>모니터링 및 관측성<a hidden class=anchor aria-hidden=true href=#모니터링-및-관측성>#</a></h4><table><thead><tr><th>항목 분류</th><th>항목 명</th><th>설명</th><th>활용 기술 예시</th></tr></thead><tbody><tr><td>지표 수집</td><td>Lock 경합 시간</td><td>임계 구역 접근 시 대기 시간 측정</td><td>Prometheus, Grafana, OpenTelemetry</td></tr><tr><td>지표 수집</td><td>처리량 (TPS)</td><td>초당 처리 요청 수 (Transactions Per Second)</td><td>Datadog, CloudWatch</td></tr><tr><td>지표 수집</td><td>평균 응답 지연</td><td>응답 속도 지표 (P95, P99 레이턴시)</td><td>New Relic, Sentry</td></tr><tr><td>장애 탐지</td><td>데드락 비율</td><td>락 순서 오류로 인한 시스템 정지 감지</td><td>JVM Thread Dump, Lock Analyzer</td></tr><tr><td>장애 탐지</td><td>경쟁 조건 로그</td><td>동일 자원 동시 접근 시의 오류 탐지 로그 수집</td><td>ELK, Loki, Structured Logging</td></tr><tr><td>트레이싱 및 로깅</td><td>요청 흐름 추적</td><td>비동기/동기 요청 간의 흐름 추적</td><td>OpenTelemetry, Jaeger, Zipkin</td></tr><tr><td>트레이싱 및 로깅</td><td>Thread/Request 로그</td><td>요청 단위의 실행 컨텍스트, 쓰레드 및 요청 ID 식별 정보 포함</td><td>Python Logging, ContextVar 기반 로그 구조화</td></tr><tr><td>트레이싱 및 로깅</td><td>재시도/오류 추적</td><td>반복 요청, 시간 초과, 예외 발생 시도 횟수 기록</td><td>APM, SLO 경고 시스템</td></tr><tr><td>이상 탐지</td><td>임계값 이상 감지</td><td>Latency, TPS 등 메트릭이 기준치를 벗어날 경우 자동 경고</td><td>AlertManager, Datadog Watchdog</td></tr><tr><td>이상 탐지</td><td>ML 기반 이상 탐지</td><td>정상/비정상 패턴을 학습하여 자동 탐지 (e.g. 반복 재시도 등)</td><td>Amazon DevOps Guru, Azure Monitor AI Analysis</td></tr></tbody></table><p>모니터링과 관측성은 단순한 로그 수집이 아닌 <strong>시스템 내부의 동시성 문제를 실시간으로 감지하고 재현 가능한 형태로 추적</strong>하는 것이 핵심이다.<br>Lock 경합, 데드락, 처리량 저하 같은 문제를 지표 기반으로 조기 탐지하고, 트레이싱과 로그를 통해 그 원인을 재현할 수 있어야 한다.<br>또한 이상 감지를 위한 정적 임계값 외에도 머신러닝 기반 경고 체계를 통해 더 정밀한 대응이 가능하며, 모든 관측은 <strong>요청/스레드 단위의 컨텍스트</strong>를 포함한 구조화된 형태로 수집되어야 한다.</p><p><strong>로깅 전략</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a class=lnlinks href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a class=lnlinks href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a class=lnlinks href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a class=lnlinks href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a class=lnlinks href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a class=lnlinks href=#hl-27-18>18</a>
</span><span class=lnt id=hl-27-19><a class=lnlinks href=#hl-27-19>19</a>
</span><span class=lnt id=hl-27-20><a class=lnlinks href=#hl-27-20>20</a>
</span><span class=lnt id=hl-27-21><a class=lnlinks href=#hl-27-21>21</a>
</span><span class=lnt id=hl-27-22><a class=lnlinks href=#hl-27-22>22</a>
</span><span class=lnt id=hl-27-23><a class=lnlinks href=#hl-27-23>23</a>
</span><span class=lnt id=hl-27-24><a class=lnlinks href=#hl-27-24>24</a>
</span><span class=lnt id=hl-27-25><a class=lnlinks href=#hl-27-25>25</a>
</span><span class=lnt id=hl-27-26><a class=lnlinks href=#hl-27-26>26</a>
</span><span class=lnt id=hl-27-27><a class=lnlinks href=#hl-27-27>27</a>
</span><span class=lnt id=hl-27-28><a class=lnlinks href=#hl-27-28>28</a>
</span><span class=lnt id=hl-27-29><a class=lnlinks href=#hl-27-29>29</a>
</span><span class=lnt id=hl-27-30><a class=lnlinks href=#hl-27-30>30</a>
</span><span class=lnt id=hl-27-31><a class=lnlinks href=#hl-27-31>31</a>
</span><span class=lnt id=hl-27-32><a class=lnlinks href=#hl-27-32>32</a>
</span><span class=lnt id=hl-27-33><a class=lnlinks href=#hl-27-33>33</a>
</span><span class=lnt id=hl-27-34><a class=lnlinks href=#hl-27-34>34</a>
</span><span class=lnt id=hl-27-35><a class=lnlinks href=#hl-27-35>35</a>
</span><span class=lnt id=hl-27-36><a class=lnlinks href=#hl-27-36>36</a>
</span><span class=lnt id=hl-27-37><a class=lnlinks href=#hl-27-37>37</a>
</span><span class=lnt id=hl-27-38><a class=lnlinks href=#hl-27-38>38</a>
</span><span class=lnt id=hl-27-39><a class=lnlinks href=#hl-27-39>39</a>
</span><span class=lnt id=hl-27-40><a class=lnlinks href=#hl-27-40>40</a>
</span><span class=lnt id=hl-27-41><a class=lnlinks href=#hl-27-41>41</a>
</span><span class=lnt id=hl-27-42><a class=lnlinks href=#hl-27-42>42</a>
</span><span class=lnt id=hl-27-43><a class=lnlinks href=#hl-27-43>43</a>
</span><span class=lnt id=hl-27-44><a class=lnlinks href=#hl-27-44>44</a>
</span><span class=lnt id=hl-27-45><a class=lnlinks href=#hl-27-45>45</a>
</span><span class=lnt id=hl-27-46><a class=lnlinks href=#hl-27-46>46</a>
</span><span class=lnt id=hl-27-47><a class=lnlinks href=#hl-27-47>47</a>
</span><span class=lnt id=hl-27-48><a class=lnlinks href=#hl-27-48>48</a>
</span><span class=lnt id=hl-27-49><a class=lnlinks href=#hl-27-49>49</a>
</span><span class=lnt id=hl-27-50><a class=lnlinks href=#hl-27-50>50</a>
</span><span class=lnt id=hl-27-51><a class=lnlinks href=#hl-27-51>51</a>
</span><span class=lnt id=hl-27-52><a class=lnlinks href=#hl-27-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextvars</span> <span class=kn>import</span> <span class=n>ContextVar</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 컨텍스트 변수로 요청별 추적 정보 관리</span>
</span></span><span class=line><span class=cl><span class=n>request_id</span><span class=p>:</span> <span class=n>ContextVar</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>ContextVar</span><span class=p>(</span><span class=s1>&#39;request_id&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;unknown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>thread_id</span><span class=p>:</span> <span class=n>ContextVar</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>ContextVar</span><span class=p>(</span><span class=s1>&#39;thread_id&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;unknown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConcurrencyLogger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;동시성 이슈 전용 로거&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s1>&#39;concurrency&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 구조화된 로깅 포맷</span>
</span></span><span class=line><span class=cl>        <span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> | </span><span class=si>%(levelname)s</span><span class=s1> | </span><span class=si>%(name)s</span><span class=s1> | &#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;REQ:</span><span class=si>%(request_id)s</span><span class=s1> | THREAD:</span><span class=si>%(thread_id)s</span><span class=s1> | &#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;</span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_lock_acquisition</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lock_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>wait_time</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;락 획득 로깅&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>extra</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;request_id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=o>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;thread_id&#39;</span><span class=p>:</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lock_name&#39;</span><span class=p>:</span> <span class=n>lock_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;wait_time&#39;</span><span class=p>:</span> <span class=n>wait_time</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>wait_time</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>  <span class=c1># 100ms 이상 대기 시 경고</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock contention detected: </span><span class=si>{</span><span class=n>lock_name</span><span class=si>}</span><span class=s2> waited </span><span class=si>{</span><span class=n>wait_time</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=n>extra</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock acquired: </span><span class=si>{</span><span class=n>lock_name</span><span class=si>}</span><span class=s2> waited </span><span class=si>{</span><span class=n>wait_time</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=n>extra</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_race_condition_detected</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>resource_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>details</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;경쟁 조건 탐지 로깅&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>extra</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;request_id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=o>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;thread_id&#39;</span><span class=p>:</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;resource_name&#39;</span><span class=p>:</span> <span class=n>resource_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>**</span><span class=n>details</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Race condition detected on </span><span class=si>{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=n>extra</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=실무-적용-고려사항-및-주의점>실무 적용 고려사항 및 주의점<a hidden class=anchor aria-hidden=true href=#실무-적용-고려사항-및-주의점>#</a></h4><table><thead><tr><th>카테고리</th><th>고려사항</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>설계</td><td>공유 자원 관리</td><td>Race Condition 은 공유 상태에서 발생</td><td>불변 객체 사용, 상태 최소화, 명시적 자원 문서화</td></tr><tr><td>설계</td><td>락 순서 일관성</td><td>서로 다른 순서로 락 획득 시 데드락 유발 가능</td><td>전역 락 순서 정의, 계층 구조 적용</td></tr><tr><td>설계</td><td>동시성 요구 정의</td><td>동시 사용량, 트랜잭션 수 예측 필요</td><td>부하 기준선 설정, 성능 요구사항 명시</td></tr><tr><td>구현</td><td>Lock 최소화 및 세분화</td><td>긴 임계 구역은 성능 저하 및 교착 위험</td><td>최소 범위로 분리, lock-free 구조 고려</td></tr><tr><td>구현</td><td>원자적 연산 활용</td><td>낮은 수준의 락 없이 일관성 유지</td><td>CAS, atomic 변수 활용</td></tr><tr><td>구현</td><td>예외 처리 및 락 해제</td><td>예외 발생 시 락 미해제는 데드락 유발</td><td>try-finally 사용, 예외 상황에서도 릴리즈 보장</td></tr><tr><td>테스트</td><td>병행성 스트레스 테스트</td><td>Race 는 환경에 따라 재현이 어려움</td><td>chaos 테스트, 타이밍 변조 기반 부하 테스트</td></tr><tr><td>테스트</td><td>정적/동적 분석 도구 활용</td><td>수작업 검토는 경쟁 상태 탐지에 한계</td><td>ThreadSanitizer, Coverity, TLA+</td></tr><tr><td>운영/모니터링</td><td>실시간 경합 추적</td><td>락 경합/대기 시간 등의 지표 수집</td><td>Grafana, OpenTelemetry</td></tr><tr><td>운영/모니터링</td><td>트레이싱 및 로깅</td><td>문제 발생 시 흐름 추적 필요</td><td>구조화 로그, Request ID 기반 트레이싱 적용</td></tr><tr><td>복원력</td><td>자동 복구 설계</td><td>데드락 또는 실패 시 서비스 정지 방지</td><td>Circuit Breaker, 재시도 백오프 적용</td></tr><tr><td>복원력</td><td>Idempotent 처리</td><td>재시도 시 중복 실행 방지 필요</td><td>고유 키 처리, 상태 기반 Idempotency 설계</td></tr><tr><td>분산 환경</td><td>분산 락 적용</td><td>여러 노드 간 자원 접근 시 동기화 필요</td><td>Redis, Zookeeper, ETCD 기반 분산 락 적용</td></tr><tr><td>분산 환경</td><td>데이터 일관성</td><td>분산 환경에서 트랜잭션/락의 적용 범위 복잡</td><td>SAGA, Eventual Consistency, Two-Phase Commit 활용</td></tr></tbody></table><p>실무에서 경쟁 조건이나 라이브락을 방지하기 위한 동시성 설계는 단순히 락을 거는 수준을 넘어선다.</p><ul><li><strong>설계 단계</strong>에서는 공유 자원을 명확히 식별하고, 락 획득 순서를 통일하는 등 구조적인 기준이 마련돼야 한다.</li><li><strong>구현 단계</strong>에서는 락의 범위를 최소화하고 가능하다면 lock-free 기법을 적용해야 한다.</li><li><strong>테스트</strong>는 병행성 문제의 특성상 재현이 어려우므로, 스트레스 테스트 및 자동화된 분석 도구를 활용하는 것이 효과적이다.</li><li><strong>운영 중</strong>에는 메트릭과 로그, 트레이싱을 통해 문제가 발생한 시점과 원인을 파악할 수 있도록 시스템을 구성해야 하며, 장애 발생 시 자동 복구 메커니즘과 Idempotent 설계가 시스템의 신뢰성을 높인다. 특히 분산 환경에서는 단일 시스템보다 훨씬 복잡한 조건들이 얽히므로, 분산 락 및 데이터 일관성 전략이 필수적으로 적용돼야 한다.</li></ul><h4 id=성능-최적화-전략-및-고려사항>성능 최적화 전략 및 고려사항<a hidden class=anchor aria-hidden=true href=#성능-최적화-전략-및-고려사항>#</a></h4><table><thead><tr><th>카테고리</th><th>항목</th><th>설명</th><th>권장사항 / 기법</th></tr></thead><tbody><tr><td>락 최적화</td><td>락 세분화</td><td>공유 자원을 자원별로 분리하여 락 경쟁 최소화</td><td>Fine-grained Lock, 샤딩</td></tr><tr><td></td><td>락 대기 시간 제어</td><td>장시간 대기를 방지</td><td>타임아웃, 지수 백오프</td></tr><tr><td></td><td>락 계층 설계</td><td>데드락 방지 위한 순서 고정</td><td>계층화된 락, 정해진 순서의 획득</td></tr><tr><td></td><td>우선순위 역전 방지</td><td>낮은 우선순위 스레드가 고우선 작업 블로킹 방지</td><td>Priority Inheritance</td></tr><tr><td>동시성 구조</td><td>Lock-free 연산</td><td>CAS 기반 논블로킹 처리</td><td>Compare-And-Swap, 원자 연산</td></tr><tr><td></td><td>Atomic 연산</td><td>경량 동기화를 위한 CPU 수준 연산</td><td><code>AtomicInteger</code>, <code>fetch-and-add</code></td></tr><tr><td></td><td>읽기 - 쓰기 분리</td><td>동기화 오버헤드 줄이고 성능 극대화</td><td>CQRS, MVCC, Reader-Writer Lock</td></tr><tr><td></td><td>스레드 로컬 캐싱</td><td>공유 자원 대신 개별 스레드 전용 자원 사용</td><td>Thread-local storage</td></tr><tr><td>메모리/하드웨어</td><td>캐시 라인 최적화</td><td>False Sharing 방지</td><td>캐시 패딩, 정렬</td></tr><tr><td></td><td>NUMA 인식 스케줄링</td><td>멀티코어 환경에서 메모리 지역성 최적화</td><td>CPU 코어별 메모리 바인딩</td></tr><tr><td></td><td>메모리 배리어 최소화</td><td>불필요한 메모리 장벽으로 인한 성능 저하 방지</td><td>필요한 지점에만 barrier 삽입</td></tr><tr><td>아키텍처 설계</td><td>이벤트 기반 처리</td><td>동기 작업을 메시지 큐로 대체, 비동기화</td><td>Kafka, EventLoop, async/await</td></tr><tr><td></td><td>배치 처리</td><td>연산을 묶어서 처리하여 락 횟수 감소</td><td>Batch Queue, 작업 집계</td></tr><tr><td></td><td>읽기 전용 경로 분리</td><td>읽기 성능 최적화</td><td>읽기 복제본, 읽기 캐시</td></tr><tr><td>운영 최적화</td><td>실시간 경합 추적</td><td>락 대기 시간, 경합 횟수 등을 지표로 수집</td><td>Prometheus, Grafana, APM 도구</td></tr><tr><td></td><td>적응형 동시성 조정</td><td>트래픽에 따라 동시 작업 수 자동 조절</td><td>Thread pool resizing, queue tuning</td></tr></tbody></table><p>성능 최적화를 위한 전략은 단순히 락을 줄이는 것에서 끝나지 않는다.<br>시스템 구조 전반을 고려해 동기화 범위, 메모리 구조, 작업 흐름, 그리고 실행 환경까지 통합적으로 설계해야 한다. 특히 락 경합을 최소화하고, 동기화 대신 비동기/이벤트 기반 구조를 도입하면 병렬성을 극대화할 수 있다. 하지만 동시에 복잡도와 디버깅 난이도도 증가하므로, **관찰 가능성 (Observability)**과 <strong>성능 측정 기반의 반복적 개선</strong>이 반드시 병행되어야 한다.</p><h5 id=최적화-전략-적용-시-성능-벤치마크-도출법>최적화 전략 적용 시 성능 벤치마크 도출법<a hidden class=anchor aria-hidden=true href=#최적화-전략-적용-시-성능-벤치마크-도출법>#</a></h5><h6 id=벤치마크-도출-전-준비-단계>벤치마크 도출 전 준비 단계<a hidden class=anchor aria-hidden=true href=#벤치마크-도출-전-준비-단계>#</a></h6><ol><li><p>측정 목표 정의</p><ul><li>단순 성능 비교 → 최적화 전후 <strong>응답 시간, 처리량, CPU 사용률</strong> 변화 측정</li><li>병목 구간 파악 → <strong>락 경합률, 스레드 대기 시간, GC 지연</strong> 등 병렬성/메모리 지표 중심</li><li>실제 환경 근사 → 실제 트래픽 패턴 기반 <strong>프로파일링 시나리오</strong> 설계</li></ul></li><li><p>측정 환경 통제</p><ul><li>동일한 하드웨어/네트워크/프로세스 조건에서 실행</li><li>외부 간섭 방지 (다른 백그라운드 프로세스 종료 등)</li><li>커널 설정 (Linux: <code>isolcpus</code>, <code>taskset</code>) 으로 CPU 고정 가능</li></ul></li></ol><h6 id=측정-지표-설계>측정 지표 설계<a hidden class=anchor aria-hidden=true href=#측정-지표-설계>#</a></h6><table><thead><tr><th>지표 항목</th><th>설명</th><th>측정 도구 예시</th></tr></thead><tbody><tr><td><strong>Latency (지연)</strong></td><td>평균/최대/99% 응답 시간</td><td><code>wrk</code>, <code>ApacheBench</code>, <code>k6</code></td></tr><tr><td><strong>Throughput (처리량)</strong></td><td>초당 처리 가능한 요청 수</td><td><code>wrk</code>, <code>JMeter</code>, <code>Locust</code></td></tr><tr><td><strong>락 경합률</strong></td><td>락 획득 대기 시간 비율</td><td><code>perf</code>, <code>bpftrace</code>, <code>Go pprof</code></td></tr><tr><td><strong>Context Switch</strong></td><td>커널 모드 ↔ 유저 모드 전환 횟수</td><td><code>vmstat</code>, <code>pidstat</code>, <code>perf stat</code></td></tr><tr><td><strong>CPU Utilization</strong></td><td>스레드별 CPU 사용량</td><td><code>top</code>, <code>htop</code>, <code>mpstat</code></td></tr><tr><td><strong>메모리 사용량</strong></td><td>힙/스택/캐시 등 전체 메모리 구조 분석</td><td><code>valgrind</code>, <code>ps</code>, <code>memory_profiler</code></td></tr><tr><td><strong>GC/메모리 지연</strong></td><td>GC pause time, 메모리 할당/해제 빈도 분석</td><td><code>GC logs</code>, <code>gctrace</code>, <code>VisualVM</code>, <code>Py-spy</code></td></tr><tr><td><strong>락 시간 분포</strong></td><td>락 획득 - 해제 간 시간 분포 분석</td><td><code>SystemTap</code>, <code>bpftrace</code>, Flame Graph</td></tr></tbody></table><h6 id=벤치마크-실행-전략>벤치마크 실행 전략<a hidden class=anchor aria-hidden=true href=#벤치마크-실행-전략>#</a></h6><ol><li><p>단위별 벤치마크 (Microbenchmark)</p><ul><li>특정 연산 단위의 성능 변화 측정 (예: 락, CAS, 큐 삽입)</li><li>Python: <code>timeit</code></li><li>Java: <code>JMH</code></li><li>Go: <code>testing.Benchmark</code></li></ul></li><li><p>시나리오 기반 부하 테스트</p><ul><li>실제 워크로드 반영: 로그인, 결제, 조회 등의 시나리오 구성</li><li>사용자 수/요청 간격 조절로 TPS 와 Latency 확인</li><li>예시: <code>Locust</code> (Python 기반 사용자 시나리오 작성)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>locust</span> <span class=kn>import</span> <span class=n>HttpUser</span><span class=p>,</span> <span class=n>task</span><span class=p>,</span> <span class=n>between</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyUser</span><span class=p>(</span><span class=n>HttpUser</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>wait_time</span> <span class=o>=</span> <span class=n>between</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@task</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_main_page</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@task</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>post_order</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;/order&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;item&#34;</span><span class=p>:</span> <span class=s2>&#34;abc&#34;</span><span class=p>,</span> <span class=s2>&#34;qty&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>A/B 테스트 (Before vs After)</p><ul><li>같은 조건에서 성능 개선 전/후 실행 → 지표 수치 비교</li><li>가능하면 5~10 회 반복 → <strong>중앙값 (Median) + 표준편차</strong>로 해석</li></ul></li></ol><h6 id=결과-분석-방법>결과 분석 방법<a hidden class=anchor aria-hidden=true href=#결과-분석-방법>#</a></h6><p><strong>시각화 + 비교 기준</strong></p><table><thead><tr><th>항목</th><th>최적화 전</th><th>최적화 후</th><th>개선 비율</th></tr></thead><tbody><tr><td>평균 응답 시간</td><td>230ms</td><td>140ms</td><td><strong>↓39%</strong></td></tr><tr><td>처리량 (req/s)</td><td>3,500</td><td>5,200</td><td><strong>↑48%</strong></td></tr><tr><td>락 경합률</td><td>12.3%</td><td>3.4%</td><td><strong>↓72%</strong></td></tr><tr><td>GC 지연 평균</td><td>45ms</td><td>18ms</td><td><strong>↓60%</strong></td></tr></tbody></table><blockquote><p>시각화 도구 예시:</p><ul><li><code>Grafana</code> + <code>Prometheus</code></li><li><code>Flamegraph</code> (스택 프로파일링)</li><li><code>Jupyter Notebook</code> + <code>matplotlib</code> 로 결과 그래프화</li></ul></blockquote><h6 id=실제-적용-예시>실제 적용 예시<a hidden class=anchor aria-hidden=true href=#실제-적용-예시>#</a></h6><p>예: Python 락 → Atomic 구조 최적화 전후</p><table><thead><tr><th>항목</th><th>락 기반 구조</th><th>Atomic 구조</th><th>개선 효과</th></tr></thead><tbody><tr><td>응답 시간 평균</td><td>190ms</td><td>130ms</td><td>31.5% 감소</td></tr><tr><td>처리량 (TPS)</td><td>4,100</td><td>6,200</td><td>51.2% 증가</td></tr><tr><td>락 경합률</td><td>11.8%</td><td>0.3%</td><td>경합 제거</td></tr><tr><td>CPU 사용률</td><td>80%</td><td>92%</td><td>리소스 활용 증가</td></tr><tr><td>코드 복잡도</td><td>낮음</td><td>중간</td><td>CAS 로직 추가됨</td></tr></tbody></table><h5 id=성능-최적화-의사결정-트리>성능 최적화 의사결정 트리<a hidden class=anchor aria-hidden=true href=#성능-최적화-의사결정-트리>#</a></h5><pre class=mermaid>graph TD
    A[성능 요구사항 분석] --&gt; B{읽기 vs 쓰기 비율}
    
    B --&gt;|읽기 &gt; 90%| C[Reader-Writer Lock]
    B --&gt;|쓰기 &gt; 50%| D{동시성 수준}
    
    D --&gt;|낮음 &lt; 10 스레드| E[Simple Mutex]
    D --&gt;|보통 10-100 스레드| F[Fine-grained Lock]
    D --&gt;|높음 &gt; 100 스레드| G{성능 요구사항}
    
    G --&gt;|극도 성능 필요| H[Lock-free Algorithm]
    G --&gt;|일반 성능| I[Atomic Operations]
    
    C --&gt; J[구현 및 테스트]
    E --&gt; J
    F --&gt; J
    H --&gt; J
    I --&gt; J
    
    J --&gt; K[성능 측정]
    K --&gt; L{목표 달성?}
    L --&gt;|예| M[배포]
    L --&gt;|아니오| N[최적화 재검토]
    N --&gt; A
</pre><h3 id=고급-주제-advanced-topics>고급 주제 (Advanced Topics)<a hidden class=anchor aria-hidden=true href=#고급-주제-advanced-topics>#</a></h3><h4 id=현재-도전-과제>현재 도전 과제<a hidden class=anchor aria-hidden=true href=#현재-도전-과제>#</a></h4><table><thead><tr><th>카테고리</th><th>도전 과제</th><th>원인</th><th>영향</th><th>해결 방안</th></tr></thead><tbody><tr><td>성능 vs 일관성 트레이드오프</td><td>성능과 데이터 정합성의 균형 어려움</td><td>락 적용 시 병목 발생, 제거 시 Race 가능성 존재</td><td>시스템 성능 저하 또는 데이터 오염 위험</td><td>Lock-Free, CQRS, 캐시 일관성 전략 도입</td></tr><tr><td>분산 환경의 Race 및 일관성 문제</td><td>다중 노드 간 자원 접근 경합</td><td>분산 락 부재, 시계 동기화 실패, 네트워크 분할 등</td><td>중복 처리, 자원 오염, 장애 전파</td><td>Redis/Zookeeper 기반 락, Vector Clock, Raft/Saga 패턴</td></tr><tr><td>비동기 및 상태 동기화 복잡성</td><td>콜백/이벤트 기반 구조에서 상태 추적 난이도</td><td>복잡한 상태 전파 체계, 트랜잭션 간 결합도 증가</td><td>디버깅 난이도 증가, 장애 발생 시 추적 어려움</td><td>Context 전파 도구, Event Sourcing, 비동기 트랜잭션 추적 시스템 적용</td></tr><tr><td>비결정성과 테스트 재현성 부족</td><td>타이밍 기반 Race 상황의 재현 어려움</td><td>환경 의존적 문제 발생 조건, 실행 순서에 따라 상이</td><td>QA 환경에서 오류 발생 누락 → 운영 중 장애로 연결</td><td>Thread Fuzzing, Time Travel Debugger, Deterministic Scheduler 도입</td></tr><tr><td>도구 및 알고리즘의 한계</td><td>Lock-Free 자료구조의 복잡성과 비용 문제</td><td>CAS 반복 실패, CPU 낭비, 아키텍처별 동작 차이</td><td>예상 성능 이득보다 비용 커지는 경우 있음</td><td>상황에 맞는 혼합 전략 채택, 플랫폼에 맞는 메모리 모델 대응, 메모리 패딩 등</td></tr><tr><td>Race Condition 자동 탐지</td><td>정적 분석 도구의 탐지 한계</td><td>타이밍 기반 버그 탐지 어려움</td><td>운영 중 발생 전 사전 탐지 실패 가능성</td><td>AI 기반 분석 툴, ThreadSanitizer, 실시간 프로파일링 기반 탐지 시스템 도입</td></tr></tbody></table><p>현재 병행성 및 Livelock 대응과 관련한 실무 기술 난제는 고도화된 시스템 구조와 밀접하게 맞물려 있다.</p><ul><li>강한 일관성을 유지하면서도 성능을 확보하려는 트레이드오프가 가장 대표적인 도전 과제이며, 특히 분산 환경에서는 노드 간 락 공유, 장애 전파, 클럭 동기화 등의 문제가 Race Condition 을 더욱 복잡하게 만든다.</li><li>비동기 처리와 상태 추적은 디버깅을 어렵게 만들고, 테스트 환경에서의 재현 불가능성은 QA 한계를 야기한다.</li><li>기존의 락프리 자료구조나 정적 분석 도구 역시 특정 조건에 따라 성능 저하 또는 탐지 실패 가능성이 존재하며, 이러한 문제를 해결하기 위해서는 Event Sourcing, AI 기반 탐지, 고수준 추상화 등 신기술과 전통적 접근 방식의 균형 잡힌 혼합이 필요하다.</li></ul><h4 id=생태계-및-관련-기술>생태계 및 관련 기술<a hidden class=anchor aria-hidden=true href=#생태계-및-관련-기술>#</a></h4><table><thead><tr><th>카테고리</th><th>기술/표준</th><th>주요 기능/설명</th><th>Race Condition 대응 방식</th></tr></thead><tbody><tr><td>언어별 동시성 모델</td><td>Java, Go, Rust, JavaScript 등</td><td>각각의 언어가 제공하는 동기화 API 및 메모리 모델</td><td>Mutex, Channel, Ownership, Event Loop 기반 처리</td></tr><tr><td>분산 시스템 동기화</td><td>Redis Redlock, Zookeeper, etcd</td><td>노드 간 락 공유, 상태 합의, 리더 선출 등</td><td>분산 락, Raft 기반 합의로 중복/경합 방지</td></tr><tr><td>메시지 기반 비동기 시스템</td><td>Kafka, RabbitMQ</td><td>메시지 큐 기반 비동기 아키텍처로 직접 접근 최소화</td><td>이벤트 중심 아키텍처, 메시지 기반 상태 동기화</td></tr><tr><td>데이터베이스 동시성 제어</td><td>MVCC, 2PC, Saga, Optimistic Lock</td><td>데이터 일관성 유지, 충돌 감지 및 복구</td><td>버전 비교, 롤백, 최종 일관성 보장</td></tr><tr><td>동기화 프리미티브</td><td>Mutex, Semaphore, R/W Lock</td><td>임계구역 보호용 원초적 동기화 수단</td><td>접근 제한을 통한 상태 동기화</td></tr><tr><td>분산 트레이싱 및 관측성</td><td>OpenTelemetry, gRPC, Context Propagation</td><td>상태 흐름 추적, 분산 환경에서의 경합 및 지연 진단</td><td>병렬 처리 흐름 추적, 타이밍 이슈 시각화</td></tr><tr><td>정적 분석 및 모델 검증 도구</td><td>TLA+, Promela, ThreadSanitizer</td><td>상태 기반의 프로그램 정적 모델링 및 동적 런타임 감시</td><td>Race 상황을 사전에 탐지하거나 시뮬레이션</td></tr><tr><td>Lock-Free 기술</td><td>STM, Compare-And-Swap, RCU</td><td>공유 자원 접근 없이 병렬성 확보</td><td>충돌 회피 및 고성능 처리 구조, ABA 문제 대응</td></tr><tr><td>분산 객체 공유</td><td>Hazelcast, Consul</td><td>분산 캐시 및 상태 동기화</td><td>동일 자원의 다중 접근 방지</td></tr><tr><td>OS/플랫폼 수준 표준</td><td>POSIX Threads, Java Memory Model</td><td>스레드 API, 메모리 일관성 모델 정의</td><td>일관된 메모리 접근 보장, 플랫폼 간 이식성 확보</td></tr></tbody></table><p>" 생태계 및 관련 기술 " 은 Race Condition 이나 Livelock 같은 병행성 문제를 다룰 때 시스템 구조, 프로그래밍 언어, 실행 환경, 운영 인프라 등 전 계층에서 대응 가능한 다양한 기술 스택을 포함한다.</p><ul><li>언어 차원에서는 동기화 API 및 메모리 모델이 핵심.</li><li>분산 시스템에서는 Redis/Zookeeper 같은 분산 락 시스템과 Kafka, RabbitMQ 같은 비동기 메시지 시스템이 주축이 된다.</li><li>데이터베이스에서는 MVCC, 2PC, Saga 패턴 등을 통해 동시성 문제를 해결.</li><li>정적 분석 도구와 상태 검증 모델 (TLA+, Promela 등) 은 사전 탐지에 효과적이다.</li><li>gRPC 와 OpenTelemetry 기반의 분산 트레이싱, eBPF 기반 커널 관측 기술은 운영 환경에서의 실시간 감지와 추적을 가능하게 해준다.<br>이런 기술들은 단독보다는 연계 및 조합을 통해 실질적인 병행성 문제 해결에 기여하게 되며, 설계부터 운영까지 전주기적 고려가 필수다.</li></ul><h4 id=최신-기술-트렌드와-미래-방향>최신 기술 트렌드와 미래 방향<a hidden class=anchor aria-hidden=true href=#최신-기술-트렌드와-미래-방향>#</a></h4><table><thead><tr><th>카테고리</th><th>최신 기술/연구 (2025 기준)</th><th>Race Condition 대응 관점</th></tr></thead><tbody><tr><td><strong>Concurrency Testing</strong></td><td>Fray: JVM 용 push-button 테스트 플랫폼</td><td>실환경 동시성 버그 탐지 및 재현 효율성 향상</td></tr><tr><td><strong>High Contention Locking</strong></td><td>TXSQL: 경합 최적화된 락 메커니즘</td><td>핫스팟 경합 최소화 → 성능 대폭 향상</td></tr><tr><td><strong>분산 시스템</strong></td><td>블록체인 Smart Contracts 동시성 연구</td><td>분산 환경에서의 Race 종류 분류 및 대응 전략 제시</td></tr><tr><td><strong>Formal Verification</strong></td><td>TLA+, Alloy, SPIN 기반 설계 및 검증</td><td>모델링을 통한 Race 사전 제거</td></tr><tr><td><strong>WebAssembly 동시성</strong></td><td>Wasmtime Race CVE, WASM Threads 발전</td><td>브라우저 기반 멀티스레드 환경에서 Race 제어</td></tr></tbody></table><ul><li><p><strong>Concurrency Testing</strong>: Fray 는 JVM 기반으로, 실무 수준에서 동시성 오류를 " 푸시 버튼 " 식으로 탐색하는 최초의 플랫폼 중 하나로 평가된다.</p></li><li><p><strong>Lock 최적화</strong>: TXSQL 이 제안한 락 구조는 고경합 트랜잭션 처리 시 최대 6.5 배 성능 향상을 보여주며, Race 및 락 경합 완화에 혁신적 접근을 제공한다.</p></li><li><p><strong>분산 시스템 (블록체인)</strong>: Smart Contracts 와 블록 간 동시처리를 체계적으로 분류하고, 기존 연구의 오해를 바로잡는 문헌 리뷰로 미래 방향성을 제시.</p></li><li><p><strong>Formal Verification</strong>: 수학적 모델 기반의 사전 검증은 Race 발생 가능성을 구조적으로 줄이는 핵심 전략으로 계속 확산 중.</p></li><li><p><strong>WebAssembly</strong>: Wasmtime 에서 발생한 멀티스레드 내부 Race(CFI 및 타입 안정성 위반) 사례는, WASM 환경에서도 Race 대응이 필수임을 보여준다. 또한, SharedArrayBuffer 와 Atomics 기반 동시성은 웹에서도 현실적인 구성 요소로 자리 잡고 있다.</p></li></ul><h4 id=기타-고급-사항>기타 고급 사항<a hidden class=anchor aria-hidden=true href=#기타-고급-사항>#</a></h4><h5 id=race-condition-탐지용-시뮬레이션-도구>Race Condition 탐지용 시뮬레이션 도구<a hidden class=anchor aria-hidden=true href=#race-condition-탐지용-시뮬레이션-도구>#</a></h5><ul><li><strong>ThreadSanitizer (C/C++/Go)</strong>: 런타임 중 Race 발생 여부 탐지</li><li><strong>Intel Inspector</strong>: 메모리 경합 분석</li><li><strong>Helgrind (Valgrind)</strong>: POSIX 쓰레드 경합 탐지</li><li><strong>Go Race Detector</strong>: <code>go run -race</code> 로 Race 감지</li><li><strong>Stress-ng</strong>: CPU/메모리/IO Race 유발을 위한 부하 테스트 도구</li></ul><h5 id=race-condition-이-중요한-분야>Race Condition 이 중요한 분야<a hidden class=anchor aria-hidden=true href=#race-condition-이-중요한-분야>#</a></h5><table><thead><tr><th>분야</th><th>설명</th></tr></thead><tbody><tr><td><strong>금융 시스템</strong></td><td>거래 상태 정확성 요구. 동시 처리 시 Race 방지 필수</td></tr><tr><td><strong>운영체제 (OS)</strong></td><td>스케줄러, 메모리 접근 등 동시성 핵심</td></tr><tr><td><strong>멀티스레드 서버/웹 프레임워크</strong></td><td>높은 TPS 환경에서 동시성 결함 발생 가능</td></tr><tr><td><strong>IoT & Edge Computing</strong></td><td>센서, 디바이스 간 Race 발생 시 물리적 손해 가능</td></tr><tr><td><strong>게임 서버</strong></td><td>캐릭터 상태, 보상 처리 등 비결정성 치명적</td></tr></tbody></table><h5 id=race-condition-vs-deadlock-vs-livelock-vs-starvation>Race Condition vs. Deadlock vs. Livelock vs. Starvation<a hidden class=anchor aria-hidden=true href=#race-condition-vs-deadlock-vs-livelock-vs-starvation>#</a></h5><ul><li><strong>공통점</strong>: 모두 동시성/병렬성 문제에서 비롯되며, 시스템 자원의 제어 실패가 핵심</li><li><strong>차이점</strong>:<ul><li>Race Condition: 결과가 <strong>틀어짐</strong></li><li>Deadlock: 시스템이 <strong>멈춤</strong></li><li>Livelock: 계속 <strong>움직이지만 진전 없음</strong></li><li>Starvation: 특정 주체가 <strong>기회를 받지 못함</strong></li></ul></li></ul><table><thead><tr><th>항목</th><th>Race Condition</th><th>Deadlock</th><th>Livelock</th><th>Starvation</th></tr></thead><tbody><tr><td><strong>정의</strong></td><td>순서/타이밍에 따라 결과가 달라지는 상태</td><td>서로가 자원을 점유한 채 무한 대기</td><td>서로를 피해 반복 동작만 하고 작업이 진행되지 않음</td><td>특정 작업이 지속적으로 리소스를 얻지 못함</td></tr><tr><td><strong>원인</strong></td><td>동기화 누락, 임계 구역 미보호</td><td>자원 획득 순서 꼬임, 순환 대기</td><td>지나친 양보, 충돌 회피 반복</td><td>비공정 스케줄링, 우선순위 역전</td></tr><tr><td><strong>결과</strong></td><td>데이터 손상, 보안 결함</td><td>시스템 멈춤, 트랜잭션 정지</td><td>자원 사용률 증가, 실질 처리 없음</td><td>응답 지연, 낮은 우선순위 요청 무한 대기</td></tr><tr><td><strong>진행 여부</strong></td><td>진행은 되나 결과가 일관되지 않음</td><td>전혀 진행되지 않음</td><td>계속 실행되지만 진전 없음</td><td>일부만 계속 실행되고 특정 대상은 차단됨</td></tr><tr><td><strong>탐지 난이도</strong></td><td>어려움 (불규칙적, 비결정적)</td><td>비교적 쉬움 (Thread Dump, 자원 그래프 등)</td><td>어려움 (지속되는 상태 변화 추적 필요)</td><td>추적 가능 (대기 시간 기반 분석)</td></tr><tr><td><strong>해결 전략</strong></td><td>락, 트랜잭션, 원자 연산, 이벤트 큐</td><td>자원 요청 순서 통일, 타임아웃, 탐지 알고리즘 적용</td><td>Backoff, Retry 제한, 큐 기반 접근</td><td>공정한 스케줄러, Priority Aging</td></tr><tr><td><strong>실무 예시</strong></td><td>중복 결제, TOCTOU 보안 취약성</td><td>트랜잭션 교착, API 간 상호 의존</td><td>두 서비스가 양보만 반복해 요청 처리 불가</td><td>낮은 우선순위 요청이 고우선 반복으로 무한 대기</td></tr></tbody></table><p>동시성 문제는 시스템의 <strong>정확성, 안정성, 성능, 공정성</strong>을 모두 위협할 수 있다.<br>각 문제 유형은 <strong>구조적으로 다르며</strong>, 증상도 <strong>명확히 구분</strong>된다.</p><ul><li><strong>Race Condition</strong>은 결과 왜곡의 문제로, 설계에서 동기화 방식이나 구조를 고려해 예방해야 한다.</li><li><strong>Deadlock</strong>은 시스템 자체가 멈추는 치명적 상태로, 자원 요청 순서와 탐지 메커니즘이 중요하다.</li><li><strong>Livelock</strong>은 진전 없는 무한 재시도로 인해 자원 낭비가 발생하며, backoff 나 큐잉 전략으로 해결할 수 있다.</li><li><strong>Starvation</strong>은 공정성 문제로, 스케줄러 설계와 리소스 분배 정책에서 반드시 고려되어야 한다.</li></ul><p>실무에서는 <strong>네 가지 유형이 혼합적으로 발생</strong>하는 경우도 많기 때문에, <strong>복합 탐지·예방 전략</strong>이 요구된다. 특히 분산 시스템, 마이크로서비스, 클라우드 환경에서는 이들 문제에 대한 <strong>다층적 설계</strong>가 필수적이다.</p><hr><h2 id=정리-및-학습-가이드>정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#정리-및-학습-가이드>#</a></h2><h3 id=내용-정리>내용 정리<a hidden class=anchor aria-hidden=true href=#내용-정리>#</a></h3><p><strong>Race Condition</strong>은 병렬 환경에서 공유 자원 접근 시 실행 순서나 타이밍에 따라 결과가 달라지는 대표적인 병행성 문제로, 데이터 손상, 시스템 불안정, 보안 취약성을 유발한다. 이러한 문제는 단일 노드 내 병렬 처리뿐 아니라, 분산 시스템·비동기 환경·실시간 처리 등 다양한 현대 아키텍처 전반에서 발생할 수 있다.</p><p><strong>핵심 대응 전략</strong>은 다음과 같다:</p><ul><li><strong>임계 구역 보호</strong>: 뮤텍스, 세마포어, 락 등으로 경쟁 접근 차단</li><li><strong>원자 연산 활용</strong>: CAS, Atomic 객체 등으로 락 없는 병행 처리</li><li><strong>이벤트 기반 처리</strong>: 메시지 큐, Actor Model 로 공유 상태 제거</li><li><strong>분산 환경 보호</strong>: Redis Redlock, Zookeeper 로 분산 락 구현</li><li><strong>정적·동적 분석 도구 활용</strong>: ThreadSanitizer, TLA+, Race Detector 등</li><li><strong>설계 원칙 준수</strong>: 불변성, 순수 함수, 캡슐화 등</li></ul><p><strong>현대적인 접근은 다음과 같은 흐름을 반영해야 한다</strong>:</p><ul><li>WebAssembly 기반 멀티스레딩</li><li>AI/ML 워크로드에서 대규모 병렬 처리</li><li>엣지 컴퓨팅과 분산 환경에서의 시간 동기화 문제</li><li>Cloud-native 환경에서의 네이티브 동시성 지원 서비스</li></ul><h3 id=학습-로드맵>학습 로드맵<a hidden class=anchor aria-hidden=true href=#학습-로드맵>#</a></h3><table><thead><tr><th>단계</th><th>기간</th><th>핵심 주제</th><th>주요 내용</th><th>권장 도구/언어</th></tr></thead><tbody><tr><td>1 단계</td><td>2~3 주</td><td>기초 개념과 동기화 이해</td><td>병렬성 vs 동시성, 공유 자원, 임계구역, Lock/Semaphore 개념</td><td>Python, Golang, JS</td></tr><tr><td>2 단계</td><td>3~4 주</td><td>이론 심화 및 구조적 문제 분석</td><td>데드락/라이브락/기아, 메모리 모델, 메모리 배리어, 원자 연산 등 이해</td><td>Java, Rust, C/C++</td></tr><tr><td>3 단계</td><td>4~6 주</td><td>실무 구현 및 문제 탐지</td><td>Race 탐지 도구, Lock-Free 실습, 동시성 테스트 및 벤치마크</td><td>TSan, Helgrind, Redis</td></tr><tr><td>4 단계</td><td>6~8 주</td><td>고급 최적화 및 구조 전환</td><td>CQRS/EventSourcing, WASM 동시성, 분산 락, Formal Verification</td><td>Akka, TLA+, Zookeeper</td></tr></tbody></table><h3 id=학습-항목-매트릭스>학습 항목 매트릭스<a hidden class=anchor aria-hidden=true href=#학습-항목-매트릭스>#</a></h3><table><thead><tr><th>카테고리</th><th>Phase</th><th>항목</th><th>중요도</th><th>설명</th></tr></thead><tbody><tr><td><strong>기초 이론</strong></td><td>1</td><td>Concurrency 모델 및 개념 이해</td><td>필수</td><td>동시성, 병행성, CSP, Actor 등 이론 기반</td></tr><tr><td><strong>이론 · 패턴</strong></td><td>2</td><td>동기화 기법 및 설계 패턴 학습</td><td>필수</td><td>Lock, Atomic, Reactor, Thread Pool 등 실무 패턴</td></tr><tr><td><strong>구현 실습</strong></td><td>5</td><td>동시성 코드 구현 및 분석 도구 활용</td><td>필수</td><td>Mutex, Lock-Free, ThreadSafe 정적 분석 도구 등</td></tr><tr><td><strong>운영·교육</strong></td><td>6–7</td><td>모니터링/벤치마크 및 교육 체계 강화</td><td>권장</td><td>성능 측정, 교육 커리큘럼 구성 전략 포함</td></tr></tbody></table><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th><th>관련 개념</th></tr></thead><tbody><tr><td>기본 개념</td><td>병행성 (Concurrency)</td><td>여러 작업을 동시에 처리 가능한 성질</td><td>병렬 처리, 스레드</td></tr><tr><td></td><td>임계 구역 (Critical Section)</td><td>공유 자원에 접근하는 코드 블록</td><td>상호 배제</td></tr><tr><td></td><td>상호 배제 (Mutual Exclusion)</td><td>임계 구역에 하나만 진입 허용</td><td>뮤텍스, 세마포어</td></tr><tr><td>동기화</td><td>뮤텍스 (Mutex)</td><td>상호 배제를 구현하는 동기화 객체</td><td>락, Monitor</td></tr><tr><td></td><td>세마포어 (Semaphore)</td><td>일정 수의 접근을 제어하는 동기화 도구</td><td>Counting, Binary</td></tr><tr><td></td><td>읽기 - 쓰기 락 (RWLock)</td><td>읽기는 다수, 쓰기는 단일 접근만 허용</td><td>Reader Preference</td></tr><tr><td></td><td>Spinlock</td><td>락이 풀릴 때까지 루프 대기</td><td>Busy Waiting</td></tr><tr><td></td><td>Distributed Lock</td><td>분산 환경에서의 자원 동기화</td><td>Redlock, Zookeeper</td></tr><tr><td>Race 유형</td><td>Race Condition</td><td>실행 순서에 따라 결과가 달라지는 현상</td><td>Data Race, TOCTOU</td></tr><tr><td></td><td>Data Race</td><td>하나 이상이 쓰기 작업일 때 동시에 접근</td><td>Atomicity 위반</td></tr><tr><td></td><td>TOCTOU</td><td>검사 후 사용 사이의 Race Condition</td><td>파일 접근 취약점</td></tr><tr><td>원자성/일관성</td><td>원자 연산 (Atomic Operation)</td><td>더 이상 나눌 수 없는 불가분 연산</td><td>CAS, Atomic 변수</td></tr><tr><td></td><td>CAS (Compare-and-Swap)</td><td>예상값과 현재값을 비교해 교체</td><td>ABA 문제</td></tr><tr><td></td><td>Memory Barrier</td><td>메모리 명령 순서 보장</td><td>Fence, CPU 최적화</td></tr><tr><td>테스트/도구</td><td>ThreadSanitizer</td><td>런타임에서 Data Race 탐지 도구</td><td>Clang, Go</td></tr><tr><td></td><td>Helgrind</td><td>멀티스레드 Race Condition 진단 도구</td><td>Valgrind</td></tr><tr><td></td><td>동시성 테스트</td><td>병렬 실행 흐름을 테스트하는 방법</td><td>Parallel Unit Test</td></tr><tr><td>분산 시스템</td><td>MVCC</td><td>다중 버전으로 동시성 제어</td><td>Snapshot Isolation</td></tr><tr><td></td><td>Eventual Consistency</td><td>시간이 지나면 일관성 수렴</td><td>BASE, CAP</td></tr><tr><td></td><td>Vector Clock</td><td>분산 인과관계 추적을 위한 시계</td><td>Lamport Clock</td></tr><tr><td></td><td>분산 트랜잭션</td><td>여러 노드에서의 트랜잭션 일관성 보장</td><td>2PC, Saga</td></tr><tr><td>고급 패턴</td><td>Lock-Free / Wait-Free</td><td>외부 락 없이 병행성 보장</td><td>Non-blocking</td></tr><tr><td></td><td>Actor Model</td><td>상태를 격리된 Actor 로 관리</td><td>Akka, Erlang</td></tr><tr><td></td><td>Event Sourcing</td><td>상태를 이벤트 기록으로 재구성</td><td>CQRS, Snapshot</td></tr><tr><td>운영/관측</td><td>Observability (관측성)</td><td>시스템 내부 상태 외부에서 추적 가능</td><td>메트릭, 트레이스</td></tr><tr><td></td><td>Lock Contention</td><td>여러 스레드가 락 경쟁</td><td>성능 저하 원인</td></tr><tr><td></td><td>Livelock</td><td>계속 상태 변경은 하나 진전 없는 상태</td><td>동기화 실패 패턴</td></tr><tr><td>성능/병목</td><td>False Sharing</td><td>다른 데이터가 같은 캐시라인에 위치</td><td>캐시 충돌</td></tr><tr><td></td><td>Priority Inversion</td><td>낮은 우선순위가 자원 독점</td><td>Priority Inheritance</td></tr><tr><td></td><td>Throughput</td><td>단위 시간당 처리량</td><td>TPS, QPS</td></tr><tr><td></td><td>Latency</td><td>요청~응답 사이의 시간</td><td>P95, P99 지표</td></tr><tr><td></td><td>Idempotency</td><td>여러 번 호출해도 같은 결과</td><td>API 안정성 설계</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://en.wikipedia.org/wiki/Race_condition>Race condition – Wikipedia</a></li><li><a href=https://clang.llvm.org/docs/ThreadSanitizer.html>ThreadSanitizer — Clang Documentation</a></li><li><a href=https://www.baeldung.com/cs/race-conditions>What Is a Race Condition? | Baeldung on Computer Science</a></li><li><a href=https://www.geeksforgeeks.org/race-condition-in-operating-system/>Race Condition in Operating System – GeeksforGeeks</a></li><li><a href=https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use>Time-of-check to Time-of-use – Wikipedia</a></li></ul><hr></div></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>