<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Event Sourcing | hyunyoun's Blog</title><meta name=keywords content="Software-Engineering,Design-and-Architecture,Architecture-Styles-and-Patterns,Architecture-Patterns,Data-Management-Patterns,Event-Sourcing"><meta name=description content="이 패턴은 시스템의 상태 변화를 일련의 이벤트로 저장하고 관리하는 방식을 말한다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/event-patterns/event-sourcing/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.a9863521b3bd3c240bc506f46b95e3c06ccef2ae37f529d5f99bdaef442bccce.css integrity="sha256-qYY1IbO9PCQLxQb0a5XjwGzO8q439SnV+Zva70QrzM4=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/event-patterns/event-sourcing/index.xml><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/event-patterns/event-sourcing/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/event-patterns/event-sourcing/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Event Sourcing"><meta property="og:description" content="이 패턴은 시스템의 상태 변화를 일련의 이벤트로 저장하고 관리하는 방식을 말한다."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Event Sourcing"><meta name=twitter:description content="이 패턴은 시스템의 상태 변화를 일련의 이벤트로 저장하고 관리하는 방식을 말한다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"기록하고 기억하고 활용하자.","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Software Engineering","item":"https://buenhyden.github.io/posts/software-engineering/"},{"@type":"ListItem","position":3,"name":"Design and Architecture","item":""},{"@type":"ListItem","position":4,"name":"Architecture Styles","item":""},{"@type":"ListItem","position":5,"name":"Messaging-Oriented Architecture","item":"https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/"},{"@type":"ListItem","position":6,"name":"Event-Driven Architecture","item":"https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/"},{"@type":"ListItem","position":7,"name":"Event Sourcing","item":"https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/event-patterns/event-sourcing/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>기록하고 기억하고 활용하자.</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/software-engineering/>Software Engineering</a>&nbsp;»&nbsp;<a href>Design and Architecture</a>&nbsp;»&nbsp;<a href>Architecture Styles</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/>Messaging-Oriented Architecture</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles/messaging-oriented-architecture/event-driven-architecture/>Event-Driven Architecture</a></div><h1>Event Sourcing</h1><div class=post-description>이 패턴은 시스템의 상태 변화를 일련의 이벤트로 저장하고 관리하는 방식을 말한다.</div></header><div class=post-content><h2 id=event-sourcing>Event Sourcing<a hidden class=anchor aria-hidden=true href=#event-sourcing>#</a></h2><hr><h1 id=event-sourcing-심층-분석-및-실무-가이드>Event Sourcing 심층 분석 및 실무 가이드<a hidden class=anchor aria-hidden=true href=#event-sourcing-심층-분석-및-실무-가이드>#</a></h1><hr><h2 id=1단계-기본-분석>1단계: 기본 분석<a hidden class=anchor aria-hidden=true href=#1단계-기본-분석>#</a></h2><h3 id=1-대표-태그-생성>1. 대표 태그 생성<a hidden class=anchor aria-hidden=true href=#1-대표-태그-생성>#</a></h3><ul><li>Event-Sourcing, Event-Driven-Architecture, CQRS-패턴, 데이터-이력관리</li></ul><h3 id=2-분류-체계-검증>2. 분류 체계 검증<a hidden class=anchor aria-hidden=true href=#2-분류-체계-검증>#</a></h3><p>현재 분류 [Software Engineering > Architecture Styles > Messaging-Oriented Architecture > Event-Driven Architecture > Event Patterns]는 이벤트 소싱(Event Sourcing)의 본질과 핵심 역할을 잘 반영하고 있습니다. 하지만, &ldquo;데이터 관리 패턴(Data Management Patterns)&rdquo;, &ldquo;시스템 로깅 및 트랜잭션(Logging & Transaction Patterns)&rdquo;, &ldquo;분산 시스템 관리(Distributed Data Patterns)&rdquo; 분류와의 연결도 강조할 필요가 있습니다.<br>→ 추천: &ldquo;Event Patterns"는 &ldquo;Data Management Patterns"와 교차 링크 필요.<br>(이유: 이벤트 소싱은 데이터 저장 및 상태 복구 패턴으로도 핵심적 역할 수행)</p><h3 id=3-핵심-요약>3. 핵심 요약<a hidden class=anchor aria-hidden=true href=#3-핵심-요약>#</a></h3><p>Event Sourcing(이벤트 소싱)은 시스템의 상태 변화를 불변(Event)을 순차적으로 저장하면서, 전체 이력을 관리하고 복원하는 아키텍처 패턴이다. 상태 대신 이벤트 스트림을 저장하여 추적성, 감사, 비즈니스 로직 명확화, 복구성 등에서 탁월한 효과를 갖는다.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">1</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">3</a></p><h3 id=4-전체-개요>4. 전체 개요<a hidden class=anchor aria-hidden=true href=#4-전체-개요>#</a></h3><p>이벤트 소싱(Event Sourcing)은 데이터베이스(DB)에 최종 상태만 저장하는 전통적 방식과 달리, 모든 상태 변화를 이벤트로 기록하여 이벤트 스토어(Event Store)에 누적한다. 이를 통해 실시간 상태 및 과거상태 복원이 가능하며, 이벤트 로그의 불변성(Immutability)으로 투명한 감사(Audit), 장애 복구(Recovery), 비즈니스 프로세스 추적성이 뛰어나다. 복잡성과 성능 부담이 있으나, Snapshot, CQRS, Microservices 등과 연계 시 실전 활용도가 높은 패턴이다.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">4</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">5</a></p><hr><h2 id=2단계-핵심-분석>2단계: 핵심 분석<a hidden class=anchor aria-hidden=true href=#2단계-핵심-분석>#</a></h2><h3 id=5-핵심-개념-정리-이론실무-중심>5. 핵심 개념 정리 (이론/실무 중심)<a hidden class=anchor aria-hidden=true href=#5-핵심-개념-정리-이론실무-중심>#</a></h3><ul><li>이벤트(Event): 상태 변화의 불변(immutable) 기록. 주요 비즈니스 행위의 축적.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">2</a></li><li>이벤트 스토어(Event Store): 이벤트를 순차적으로 보관하는 데이터 저장소. RDBMS, NoSQL, 전문 EventStore 사용.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">3</a></li><li>상태 재구성(State Reconstruction): 이벤트 연속(replay)으로 현재 상태 계산. Snapshot 병행 가능.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">6</a></li><li>CQRS(Command Query Responsibility Segregation): 변경 명령과 조회 구조를 분리하는 동반 패턴.<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">5</a></li><li>불변성(Immutability): 이벤트는 한 번 기록되면 변경/삭제 불가.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">8</a></li><li>분산/비동기화(Distributed/Async): 시스템 확장에 유리하며, 이벤트 브로커(예: Kafka, RabbitMQ)와 함께 사용됨.<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">9</a></li><li>적용 도메인: 금융, 커머스, 복잡한 비즈니스 프로세스 등.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">7</a><a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">9</a></li></ul><h3 id=6-실무-연관성-분석>6. 실무 연관성 분석<a hidden class=anchor aria-hidden=true href=#6-실무-연관성-분석>#</a></h3><ul><li>Microservices Architecture(마이크로서비스 아키텍처)에서 서비스 간 데이터 동기화와 감사에 실질적 요구 해결.<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">9</a></li><li>운영 감사, 장애 복구, 데이터 무결성 확보에 직접적 기여.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">4</a></li><li>높은 확장성과 동시성 처리: 이벤트 기반 비동기 환경에서 활용.<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">7</a></li><li>Snapshot, CQRS 연계: 성능 및 조회 최적화에 필요.<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">6</a></li><li>예: 결제 시스템(포트원), 은행 트랜잭션, 이커머스 주문 관리.<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">2</a><a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">7</a></li></ul><hr><h2 id=3단계-상세-조사-phase별-분류>3단계: 상세 조사 (Phase별 분류)<a hidden class=anchor aria-hidden=true href=#3단계-상세-조사-phase별-분류>#</a></h2><h3 id=phase-1-기초-이해>Phase 1: 기초 이해<a hidden class=anchor aria-hidden=true href=#phase-1-기초-이해>#</a></h3><ul><li><strong>개념 정의 및 본질</strong><ul><li>Event Sourcing(이벤트 소싱): 시스템의 모든 상태 변화(변경사항)를 이벤트로 기록하고, 이벤트 스트림을 순차적으로 재생하여 현재 혹은 과거의 상태를 확인하는 소프트웨어 패턴.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">1</a></li></ul></li><li><strong>등장 배경 및 발전 과정</strong><ul><li>회계(복식부기)와 버전관리(Git, SVN 등)에서 기원. Martin Fowler, Greg Young 등 소프트웨어 설계자들이 패턴화.<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">10</a></li></ul></li><li><strong>핵심 동기 및 가치 제안</strong><ul><li>변경이력 추적, 감사와 투명성, 장애 복구, 복잡한 데이터 흐름에 대한 제어력 강화.<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">3</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">2</a></li></ul></li><li><strong>주요 특징</strong><ul><li>불변 이벤트 저장, 모든 상태 변화의 추적 가능성, 복원 가능성, CQRS와의 뛰어난 궁합.<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">5</a><a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">9</a></li></ul></li></ul><hr><h3 id=phase-2-핵심-이론>Phase 2: 핵심 이론<a hidden class=anchor aria-hidden=true href=#phase-2-핵심-이론>#</a></h3><ul><li><strong>핵심 설계 원칙</strong><ul><li>데이터 변경시 최종 상태가 아니라, 불변의 이벤트를 순차 기록</li><li>모든 이벤트 불변(immutable) 저장 및 롤백 불가</li></ul></li><li><strong>기본 원리 및 동작 메커니즘</strong></li></ul><pre class=mermaid>sequenceDiagram
    participant UI
    participant CommandHandler
    participant EventStore
    participant ReadModelDB
    UI-&gt;&gt;CommandHandler: Command(예: 주문 요청)
    CommandHandler-&gt;&gt;EventStore: Event 기록(예: 주문 생성 이벤트)
    EventStore-&gt;&gt;ReadModelDB: 이벤트 Replay 후 상태 갱신
    ReadModelDB-&gt;&gt;UI: 상태 조회
</pre><ul><li><strong>아키텍처 및 구성 요소</strong><ul><li>필수: 이벤트(Event), 이벤트 스토어(Event Store), 상태(State), 이벤트 핸들러(Event Handler)</li><li>선택: Snapshot, CQRS, 이벤트 브로커(Kafka, RabbitMQ 등), 조회용 DB(Read Model)</li></ul></li><li><strong>주요 기능과 역할</strong><ul><li>이벤트: 상태변화의 불변 기록</li><li>이벤트 스토어: 이벤트 저장/관리</li><li>핸들러: 이벤트 처리 및 상태 재생</li><li>Snapshot: 성능 개선용 전체 상태 저장</li><li>CQRS: 데이터 변경과 조회 분리</li></ul></li></ul><hr><h3 id=phase-3-특성-분석>Phase 3: 특성 분석<a hidden class=anchor aria-hidden=true href=#phase-3-특성-분석>#</a></h3><h4 id=장점-분석표>장점 분석표<a hidden class=anchor aria-hidden=true href=#장점-분석표>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>기술적 근거</th></tr></thead><tbody><tr><td>장점</td><td>변경이력 추적</td><td>모든 상태 변경 사항을 이벤트로 기록, 과거 상태 복구 가능</td><td>불변 이벤트 저장</td></tr><tr><td>장점</td><td>감사/투명성</td><td>데이터 변경 내역 전체 확인 가능, Audit 요구 충족</td><td>이벤트 로그 기반 감사/법적 검토 강화</td></tr><tr><td>장점</td><td>복구성</td><td>장애 발생 시 이벤트 재생으로 신속 복구</td><td>이벤트 스트림 Replay</td></tr><tr><td>장점</td><td>비즈니스 로직 명확성</td><td>이벤트 중심 설계로 변화 흐름 파악 용이</td><td>비즈니스 도메인 이벤트 명확화</td></tr></tbody></table><h4 id=단점-및-문제점-분석표>단점 및 문제점 분석표<a hidden class=anchor aria-hidden=true href=#단점-및-문제점-분석표>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th><th>대안 기술</th></tr></thead><tbody><tr><td>단점</td><td>복잡성</td><td>이벤트 처리/저장/관리 로직 추가</td><td>표준 프레임워크, 이벤트 핸들러 활용</td><td>전통적 CRUD, Audit Log</td></tr><tr><td>단점</td><td>스토리지 요구</td><td>모든 이벤트 저장으로 데이터 증가</td><td>이벤트 만료/압축, Storage 확장</td><td>로그축소, Snapshot</td></tr><tr><td>단점</td><td>성능 이슈</td><td>이벤트 재생(replay)로 현재 상태 계산 부담</td><td>Snapshot 적용, CQRS 분리</td><td>상태 기반 저장 방식</td></tr><tr><td>단점</td><td>모델 설계 난이도</td><td>이벤트 모델링, 도메인 이벤트 설계 어려움</td><td>DDD(도메인 주도 설계) 도입</td><td>CRUD/단순 트랜잭션</td></tr></tbody></table><h4 id=문제점>문제점<a hidden class=anchor aria-hidden=true href=#문제점>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지/진단</th><th>예방 방법</th><th>해결 기법</th></tr></thead><tbody><tr><td>문제점</td><td>설계 난이도</td><td>이벤트/도메인 모델 복잡성</td><td>초기 설계 오류, 데이터 혼선</td><td>이벤트 테스트, 도메인 검토</td><td>DDD, TDD 도입</td><td>문서화/모듈화</td></tr></tbody></table><h4 id=트레이드오프-분석>트레이드오프 분석<a hidden class=anchor aria-hidden=true href=#트레이드오프-분석>#</a></h4><ul><li>감사/추적성 ↔ 높은 저장/관리 복잡성</li><li>복구성 강화 ↔ 실시간 상태 계산 성능 이슈 발생</li></ul><hr><h3 id=phase-4-구현-및-분류>Phase 4: 구현 및 분류<a hidden class=anchor aria-hidden=true href=#phase-4-구현-및-분류>#</a></h3><h4 id=구현-기법-및-방법>구현 기법 및 방법<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법>#</a></h4><ul><li>도메인 이벤트 설계: 주요 상태 변화를 이벤트 객체로 정의</li><li>이벤트 스토어 구현: MongoDB, PostgreSQL, EventStore 등 사용</li><li>CQRS 패턴 적용: Command와 Query 구조 분리</li><li>Snapshot 적용: 주기적 전체 상태 저장으로 성능 최적화</li></ul><h4 id=분류-기준에-따른-유형-구분>분류 기준에 따른 유형 구분<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-유형-구분>#</a></h4><table><thead><tr><th>기준</th><th>유형</th><th>설명</th></tr></thead><tbody><tr><td>이벤트 저장 방식</td><td>Event Sourcing Only</td><td>이벤트만 저장, 현재 상태는 이벤트 Replay로만 도출</td></tr><tr><td>이벤트+Snapshot</td><td>Event Sourcing + Snapshot</td><td>주기적 전체상태 저장, Replay 성능 최적화</td></tr><tr><td>CQRS 적용</td><td>Event Sourcing+CQRS</td><td>변경/조회 분리, 이벤트 소싱과 별도 Read Model 운영</td></tr></tbody></table><hr><h3 id=phase-5-실무-적용>Phase 5: 실무 적용<a hidden class=anchor aria-hidden=true href=#phase-5-실무-적용>#</a></h3><h4 id=실제-도입-사례>실제 도입 사례<a hidden class=anchor aria-hidden=true href=#실제-도입-사례>#</a></h4><ul><li>포트원 결제 시스템: 결제건 모든 변경 내역 이벤트로 저장, 정확한 상태 복원 및 감사 대응 강화.<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">4</a></li><li>금융, 이커머스, 게임 등 감사 및 트랜잭션 기록 요구 높은 분야.<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">2</a><a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">7</a></li><li>Microservices, 이벤트 기반 시스템에서 데이터 무결성과 동시성 확보.<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">5</a></li></ul><h4 id=실습-예제-및-코드-구현>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현>#</a></h4><p><strong>시나리오</strong>: 사용자가 장바구니에 상품을 추가/삭제하는 과정을 이벤트로 기록
<strong>시스템 구성</strong>:</p><ul><li>사용자 서비스, 이벤트 스토어, 조회용 DB</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    A[User Service] --&gt; B[Event Store]
    B --&gt; C[Read Model DB]
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 장바구니에 상품 추가/삭제</li><li>각 액션을 이벤트로 기록(카트 생성, 상품 추가/제거)</li><li>이벤트 스토어에 저장</li><li>이벤트를 순서대로 Replay하여 장바구니 현재 상태 도출</li></ol><p><strong>핵심 역할</strong>: 이벤트로 모든 상태 변경 이력 관리 및 복원</p><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 단순 CRUD 방식, 변경 이력 추적 불가</li><li>도입 후: 모든 변경 사항 이벤트 기반 관리, 과거 상태 복원 및 감사 가능</li></ul><p><strong>구현 예시 (Python)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36>36</a>
</span><span class=lnt id=hl-2-37><a class=lnlinks href=#hl-2-37>37</a>
</span><span class=lnt id=hl-2-38><a class=lnlinks href=#hl-2-38>38</a>
</span><span class=lnt id=hl-2-39><a class=lnlinks href=#hl-2-39>39</a>
</span><span class=lnt id=hl-2-40><a class=lnlinks href=#hl-2-40>40</a>
</span><span class=lnt id=hl-2-41><a class=lnlinks href=#hl-2-41>41</a>
</span><span class=lnt id=hl-2-42><a class=lnlinks href=#hl-2-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 카트에 대한 이벤트 생성과 처리 예제</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 소싱의 핵심: 상태 변화를 기록하는 이벤트 객체&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AddItemEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;상품 추가 이벤트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>item</span> <span class=o>=</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RemoveItemEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;상품 제거 이벤트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>item</span> <span class=o>=</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;카트 상태는 이벤트 Replay로 도출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Event</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 적용하여 상태 변경&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>AddItemEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>RemoveItemEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>replay</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Event</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;저장된 모든 이벤트를 순서대로 적용&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=n>cart</span> <span class=o>=</span> <span class=n>Cart</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cart</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s1>&#39;Kimchi&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>cart</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>RemoveItemEvent</span><span class=p>(</span><span class=s1>&#39;Kimchi&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>cart</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>  <span class=c1># 이벤트 Replay 후 현재 상태</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=실제-도입-사례의-코드-구현-포트원-예시>실제 도입 사례의 코드 구현 (포트원 예시)<a hidden class=anchor aria-hidden=true href=#실제-도입-사례의-코드-구현-포트원-예시>#</a></h4><p><strong>시나리오</strong>: 결제 주문에 대한 모든 변경 이력을 이벤트로 저장
<strong>시스템 구성</strong>:</p><ul><li>결제 서비스, 이벤트 스토어, 조회용 DB, 이벤트 핸들러</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    A[Payment Service] --&gt; B[Event Store]
    B --&gt; C[Read Model DB]
    B --&gt; D[Snapshot Service]
</pre><p><strong>Workflow</strong>:</p><ol><li>결제 생성/승인/환불 등의 각 단계 이벤트 기록</li><li>이벤트 스토어에 저장</li><li>문의/장애 시 이벤트 Replay 또는 조회용 DB에서 상태 확인</li></ol><p><strong>핵심 역할</strong>: 모든 결제 상태 변경의 추적/복원/감사 기능 강화</p><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 변경 내역 로그 불명확, 감사/복구 곤란</li><li>도입 후: 이벤트 기반 이력 추적, 장애 복구 및 고객 문의 신속 대응</li></ul><p><strong>구현 예시 (Python)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a class=lnlinks href=#hl-4-31>31</a>
</span><span class=lnt id=hl-4-32><a class=lnlinks href=#hl-4-32>32</a>
</span><span class=lnt id=hl-4-33><a class=lnlinks href=#hl-4-33>33</a>
</span><span class=lnt id=hl-4-34><a class=lnlinks href=#hl-4-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 결제 시스템 핵심 상태 변화를 이벤트로 관리</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제 이벤트 기본 클래스&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentCreated</span><span class=p>(</span><span class=n>PaymentEvent</span><span class=p>):</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentApproved</span><span class=p>(</span><span class=n>PaymentEvent</span><span class=p>):</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentRefunded</span><span class=p>(</span><span class=n>PaymentEvent</span><span class=p>):</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentOrder</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제건 상태를 이벤트로 관리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;Created&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>PaymentEvent</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>PaymentEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>PaymentCreated</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;Created&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>PaymentApproved</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;Approved&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>PaymentRefunded</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;Refunded&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>replay</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>PaymentEvent</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 예시 적용</span>
</span></span><span class=line><span class=cl><span class=n>order</span> <span class=o>=</span> <span class=n>PaymentOrder</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>PaymentCreated</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>PaymentApproved</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>order</span><span class=o>.</span><span class=n>state</span><span class=p>)</span>  <span class=c1># &#34;Approved&#34;</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=phase-6-운영-및-최적화>Phase 6: 운영 및 최적화<a hidden class=anchor aria-hidden=true href=#phase-6-운영-및-최적화>#</a></h3><h4 id=보안-및-거버넌스>보안 및 거버넌스<a hidden class=anchor aria-hidden=true href=#보안-및-거버넌스>#</a></h4><ul><li>이벤트 불변성(Immutable)으로 데이터 변경/삭제 방지</li><li>감사(Audit) 목적에 적합</li><li>보안: DB 접근 제어, 이벤트 스토어 암호화/백업<a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf?utm_source=chatgpt.com" title="[PDF] CQRS Documents by Greg Young">11</a></li></ul><h4 id=모니터링-및-관측성>모니터링 및 관측성<a hidden class=anchor aria-hidden=true href=#모니터링-및-관측성>#</a></h4><ul><li>이벤트 흐름 및 이벤트 핸들러 상태 모니터링</li><li>이벤트 로그 기반 장애 탐지 및 복구 지원</li><li>메트릭: 이벤트 처리 속도, Stream 지연 등</li></ul><h4 id=실무-적용-고려사항-및-주의점>실무 적용 고려사항 및 주의점<a hidden class=anchor aria-hidden=true href=#실무-적용-고려사항-및-주의점>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>권장</th></tr></thead><tbody><tr><td>운영</td><td>이벤트 복잡성</td><td>이벤트모델 과다/과소 설계 방지</td><td>DDD(도메인 주도 설계) 적용</td></tr><tr><td>운영</td><td>Storage 증설</td><td>장기간 용량/성능 고려</td><td>클라우드 기반 자동 확장</td></tr></tbody></table><h4 id=성능-최적화-전략>성능 최적화 전략<a hidden class=anchor aria-hidden=true href=#성능-최적화-전략>#</a></h4><table><thead><tr><th>구분</th><th>전략</th><th>설명</th><th>권장</th></tr></thead><tbody><tr><td>성능</td><td>Snapshot 적용</td><td>주기적 상태 저장</td><td>주기적 (&amp;n > 1000)</td></tr><tr><td>성능</td><td>CQRS</td><td>읽기/쓰기를 분리</td><td>복잡한 도메인 추천</td></tr><tr><td>성능</td><td>이벤트 압축</td><td>불필요 이벤트 만료/압축</td><td>장기 운영 시 필수</td></tr></tbody></table><hr><h3 id=phase-7-고급-주제>Phase 7: 고급 주제<a hidden class=anchor aria-hidden=true href=#phase-7-고급-주제>#</a></h3><h4 id=현재-도전-과제>현재 도전 과제<a hidden class=anchor aria-hidden=true href=#현재-도전-과제>#</a></h4><ul><li>이벤트 데이터 증대 → 저장소 확장, 효율적 관리 필요<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">4</a></li><li>모델링 난이도, 실무 시스템 통합 문제<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">7</a></li><li>이벤트 순서 불일치 및 데이터 일관성 관리</li><li>장애 발생시 Aggregate별 복구 전략</li></ul><h4 id=생태계-및-관련-기술>생태계 및 관련 기술<a hidden class=anchor aria-hidden=true href=#생태계-및-관련-기술>#</a></h4><table><thead><tr><th>기술</th><th>통합 생태계</th><th>표준/프로토콜</th></tr></thead><tbody><tr><td>Kafka, EventStore, RabbitMQ</td><td>이벤트 브로커, 마이크로서비스와 연동</td><td>클라우드(CloudEvents), 오픈표준(AWS, Azure)</td></tr></tbody></table><h4 id=최신-트렌드와-미래-방향>최신 트렌드와 미래 방향<a hidden class=anchor aria-hidden=true href=#최신-트렌드와-미래-방향>#</a></h4><ul><li>AI/ML 기반 이벤트 분석 및 최적화</li><li>마이크로서비스 연동에서 표준화, Observability 강조</li><li>Serverless, EventBridge, EventStoreDB 등 신기술 적용 증가</li></ul><h4 id=기타-고급-사항>기타 고급 사항<a hidden class=anchor aria-hidden=true href=#기타-고급-사항>#</a></h4><ul><li>멱등성, 이벤트 순서 보장, 롤백 처리, GDPR 등 데이터 거버넌스 필요</li></ul><hr><h2 id=4단계-종합-정리-및-학습-가이드>4단계: 종합 정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#4단계-종합-정리-및-학습-가이드>#</a></h2><h3 id=내용-종합>내용 종합<a hidden class=anchor aria-hidden=true href=#내용-종합>#</a></h3><p>이벤트 소싱(Event Sourcing)은 데이터 상태의 모든 변경을 이벤트로 순차적으로 저장함으로써 복원력, 감사, 비즈니스 및 운영 투명성을 획기적으로 개선하는 아키텍처 패턴이다. 실무 현장에서는 CQRS, Snapshot 등과 결합하여 확장성과 성능을 동시에 달성하며, Microservices 및 클라우드 생태계에서 활용도와 미래 전망이 높다.</p><h3 id=학습-로드맵-및-우선순위>학습 로드맵 및 우선순위<a hidden class=anchor aria-hidden=true href=#학습-로드맵-및-우선순위>#</a></h3><ol><li>이벤트 소싱 기본 개념/원리 습득</li><li>아키텍처 구조 및 CQRS/Snapshot 연계 패턴 실습</li><li>실무 적용 사례 및 코드 예제 분석</li><li>운영/최적화, 모니터링/거버넌스 심화 학습</li><li>고급 패턴(분산, 멱등성, 이벤트 연계 microservices) 확장 학습</li></ol><h3 id=학습-항목-매트릭스>학습 항목 매트릭스<a hidden class=anchor aria-hidden=true href=#학습-항목-매트릭스>#</a></h3><table><thead><tr><th>카테고리</th><th>Phase</th><th>항목</th><th>중요도</th><th>설명</th></tr></thead><tbody><tr><td>기초</td><td>1</td><td>용어·기초</td><td>필수</td><td>이벤트, 스토어, 불변성 등</td></tr><tr><td>이론</td><td>2</td><td>아키텍처 원리</td><td>필수</td><td>구성요소, CQRS, 동작 메커니즘</td></tr><tr><td>구현</td><td>5</td><td>예제 실습</td><td>권장</td><td>실무 사용 예시, 코드/워크플로우</td></tr><tr><td>특성분석</td><td>3</td><td>장·단점 분석</td><td>필수</td><td>장점/제약 및 해결 전략</td></tr><tr><td>고급</td><td>7</td><td>생태계/확장</td><td>선택</td><td>최신 기술 트렌드, 클라우드 연계</td></tr><tr><td>운영</td><td>6</td><td>보안/관측성</td><td>권장</td><td>운영/최적화, 거버넌스, 모니터링</td></tr></tbody></table><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>정의</th><th>관련 개념</th></tr></thead><tbody><tr><td>핵심</td><td>이벤트(Event)</td><td>상태 변화 기록</td><td>불변성, 이벤트 스토어</td></tr><tr><td>구현</td><td>이벤트 스토어(Store)</td><td>이벤트 저장소</td><td>순차적 기록, Replay</td></tr><tr><td>운영</td><td>Snapshot(스냅샷)</td><td>전체상태 임시저장</td><td>성능 개선, 복구</td></tr><tr><td>구현</td><td>CQRS</td><td>명령/조회 분리</td><td>성능/확장성</td></tr><tr><td>운영</td><td>Audit</td><td>변경이력 감사</td><td>감사, 추적성</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://learn.microsoft.com/ko-kr/azure/architecture/patterns/event-sourcing>마이크로소프트 공식 문서: 이벤트 소싱 패턴</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">11</a></li><li><a href=https://developers.portone.io/blog/posts/2024-07/v2-event-sourcing-basic>포트원 V2 결제 시스템 Event Sourcing 사례</a><a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">4</a></li><li><a href=https://cajava.tistory.com/85>기술 블로그: 이벤트 소싱의 기본 개념/구성</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">1</a></li><li><a href=https://andrew75313.tistory.com/197>Genie의 개발노트: Event Sourcing FLOW</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">3</a></li><li><a href=https://notypie.dev/design-eda%EC%9D%98-%EA%B0%9C%EB%85%90-2-event-sourcing/>기록하는 개발자: EDA와 Event Sourcing</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a></li><li><a href=https://puddingcamp.com/topics/event-sourcing-cqrs-summary>CQRS 연계 실무 설명</a><a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">7</a></li><li><a href=https://unclekevin.tistory.com/entry/Event-Sourcing>엉클케빈의 세상: 장점/단점/사용사례 정리</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">2</a></li></ul><hr><p>좋습니다. 앞서 <strong>Event Sourcing</strong>에 대해 Phase 1~7까지 정리와 학습 로드맵까지 마쳤으니, 이어서 <strong>추가 심화·실무 관점 보완</strong>과 <strong>확장 학습 자료</strong>, 그리고 <strong>연습 문제</strong>까지 포함해드리겠습니다.<br>이렇게 하면, 학습과 실무 적용 사이의 간극을 바로 메꿀 수 있을 겁니다.</p><hr><h2 id=-phase-8-심화-확장-및-실무-보완>🔍 Phase 8: 심화 확장 및 실무 보완<a hidden class=anchor aria-hidden=true href=#-phase-8-심화-확장-및-실무-보완>#</a></h2><h3 id=81-이벤트-소싱에서-자주-겪는-실무-문제와-해결-전략>8.1 이벤트 소싱에서 자주 겪는 실무 문제와 해결 전략<a hidden class=anchor aria-hidden=true href=#81-이벤트-소싱에서-자주-겪는-실무-문제와-해결-전략>#</a></h3><table><thead><tr><th>구분</th><th>문제 현상</th><th>주요 원인</th><th>실무 영향</th><th>해결 전략</th></tr></thead><tbody><tr><td>이벤트 재생 속도 저하</td><td>대량의 이벤트 재생 시 오래 걸림</td><td>장기간 스냅샷 미적용, 이벤트 크기 증가</td><td>시스템 기동 지연</td><td>스냅샷 주기 단축, 이벤트 아카이빙</td></tr><tr><td>이벤트 순서 불일치</td><td>분산 환경에서 순서 어김</td><td>네트워크 지연, 멀티 스레드 처리</td><td>데이터 불일치</td><td>글로벌 타임스탬프, 카프카 파티션 관리</td></tr><tr><td>이벤트 스키마 변경</td><td>기존 이벤트 형식과 충돌</td><td>버전 미관리</td><td>재생 오류 발생</td><td>스키마 버전 관리(Avro, Protobuf)</td></tr><tr><td>멱등성(Idempotency) 미비</td><td>동일 이벤트 중복 처리</td><td>리트라이 로직 불완전</td><td>데이터 중복</td><td>이벤트 ID 관리, 멱등성 키 적용</td></tr><tr><td>GDPR 등 규제 준수</td><td>데이터 삭제 요구 충돌</td><td>불변성 특성</td><td>법적 컴플라이언스 문제</td><td>이벤트 마스킹, 암호화 키 폐기 방식</td></tr></tbody></table><hr><h3 id=82-실무에서의-성능-최적화-패턴>8.2 실무에서의 성능 최적화 패턴<a hidden class=anchor aria-hidden=true href=#82-실무에서의-성능-최적화-패턴>#</a></h3><ol><li><p><strong>스냅샷(Snapshot) 주기 최적화</strong></p><ul><li>이벤트 수가 1,000개를 넘으면 스냅샷을 저장하는 방식 적용.</li><li>최신 기술: 증분 스냅샷(Incremental Snapshot).</li></ul></li><li><p><strong>CQRS + Read Model Cache</strong></p><ul><li>읽기 전용 DB(Read Model)를 In-memory 캐시(Redis)에 두어 조회 속도를 높임.</li></ul></li><li><p><strong>Parallel Event Processing</strong></p><ul><li>병렬 이벤트 처리 시 이벤트 <strong>순서를 보장할 파티션 키</strong> 사용.</li></ul></li><li><p><strong>이벤트 압축(Event Compaction)</strong></p><ul><li>카프카(Kafka)의 log compaction 기능 활용해 오래된 중복 상태 이벤트 제거.</li></ul></li></ol><hr><h3 id=83-아키텍처-확장-예시>8.3 아키텍처 확장 예시<a hidden class=anchor aria-hidden=true href=#83-아키텍처-확장-예시>#</a></h3><p><strong>Event Sourcing + Microservices + Kafka 조합 다이어그램</strong></p><pre class=mermaid>graph TB
    subgraph ServiceA[주문 서비스]
        A1[Command Handler] --&gt; A2[Event Store]
    end
    subgraph ServiceB[결제 서비스]
        B1[Command Handler] --&gt; B2[Event Store]
    end
    A2 -- 이벤트 발행 --&gt; K[Kafka Topic]
    B2 -- 이벤트 발행 --&gt; K
    K -- 구독 --&gt; R1[Read Model for Dashboard]
    K -- 구독 --&gt; R2[Analytics Service]
</pre><p>💡 이렇게 구성하면, 각 서비스가 <strong>독립적으로 Event Sourcing</strong>을 하고, 메시지 브로커(카프카)를 통해 데이터 흐름이 연결됩니다.</p><hr><h2 id=-phase-9-학습-심화-로드맵>📌 Phase 9: 학습 심화 로드맵<a hidden class=anchor aria-hidden=true href=#-phase-9-학습-심화-로드맵>#</a></h2><table><thead><tr><th>단계</th><th>학습 내용</th><th>실습 예제</th><th>참고 기술</th></tr></thead><tbody><tr><td>1단계</td><td>기본 이벤트 소싱 개념과 CQRS 구조 학습</td><td>장바구니 예제</td><td>Python, SQLite</td></tr><tr><td>2단계</td><td>이벤트 스토어 구현 + 스냅샷 적용</td><td>주문 서비스</td><td>PostgreSQL, EventStoreDB</td></tr><tr><td>3단계</td><td>이벤트 브로커 연계</td><td>주문-결제 마이크로서비스</td><td>Kafka, RabbitMQ</td></tr><tr><td>4단계</td><td>운영 모니터링 & 장애 복구 실습</td><td>장애 복구 시뮬레이션</td><td>Prometheus, Grafana</td></tr><tr><td>5단계</td><td>고급 주제 적용</td><td>이벤트 압축, 멱등성 보장</td><td>Kafka log compaction</td></tr></tbody></table><hr><h2 id=-연습-문제-학습-점검>🧠 연습 문제 (학습 점검)<a hidden class=anchor aria-hidden=true href=#-연습-문제-학습-점검>#</a></h2><ol><li>Event Sourcing과 단순 <strong>Change Data Capture (CDC)</strong> 패턴의 차이를 설명하세요.</li><li>CQRS와 Event Sourcing을 함께 적용할 때 성능 상 이점과 단점을 2가지씩 기술하세요.</li><li>다음 상황에서 발생할 수 있는 문제와 해결책을 제안하세요.<ul><li>&ldquo;카프카 파티션 키를 잘못 설정해 동일 Aggregate 이벤트가 다른 파티션으로 배치&rdquo;</li></ul></li><li>Python을 이용하여 <strong>스냅샷을 활용하는 Cart 시스템</strong>을 구현하세요.<ul><li>조건: 5개의 이벤트 이상이 쌓이면 자동 스냅샷 저장</li></ul></li></ol><hr><h2 id=-다음-심화-주제-제안>📍 다음 심화 주제 제안<a hidden class=anchor aria-hidden=true href=#-다음-심화-주제-제안>#</a></h2><ul><li><strong>Event Sourcing + Saga 패턴</strong>: 분산 트랜잭션 관리</li><li><strong>Event Sourcing의 GDPR 대응 방안</strong></li><li><strong>AI 기반 이벤트 로그 분석</strong>으로 장애 예측</li></ul><hr><p>좋습니다. 이전에 Phase 8~9와 심화 로드맵까지 확장했으니, 이번에는 예고했던 <strong>스냅샷(Snapshot) 적용 버전의 Event Sourcing 구현 예제</strong>를 완성해 드리겠습니다.<br>이 예제는 특히 실무 환경에서 <strong>기동 시간 단축</strong>과 <strong>대량 이벤트 재생 시 성능 보완</strong>에 핵심적인 역할을 합니다.</p><hr><h2 id=-실습-예제-스냅샷-적용-cart-시스템-python>🚀 실습 예제: 스냅샷 적용 Cart 시스템 (Python)<a hidden class=anchor aria-hidden=true href=#-실습-예제-스냅샷-적용-cart-시스템-python>#</a></h2><p><strong>시나리오</strong></p><ul><li>사용자의 장바구니(Cart) 변경 내역을 이벤트로 기록</li><li>이벤트 개수가 일정 기준(N) 이상이 되면 <strong>스냅샷</strong> 저장</li><li>시스템 재시작 시 스냅샷부터 상태를 복원 후 남은 이벤트만 재생</li></ul><p><strong>시스템 구성</strong></p><ul><li>Event Store (이벤트 저장소)</li><li>Snapshot Store (스냅샷 저장소)</li><li>Cart Aggregate (비즈니스 상태 객체)</li></ul><hr><h3 id=시스템-구성-다이어그램><strong>시스템 구성 다이어그램</strong><a hidden class=anchor aria-hidden=true href=#시스템-구성-다이어그램>#</a></h3><pre class=mermaid>graph TB
    User[사용자 요청] --&gt; CommandHandler[명령 처리기]
    CommandHandler --&gt; EventStore[Event Store]
    EventStore --&gt; SnapshotStore[Snapshot Store]
    SnapshotStore --&gt; Cart[Cart Aggregate]
    EventStore --&gt; Cart
</pre><hr><h3 id=workflow><strong>Workflow</strong><a hidden class=anchor aria-hidden=true href=#workflow>#</a></h3><ol><li>사용자가 장바구니에 상품 추가/삭제 요청</li><li>이벤트 생성 후 Event Store에 저장</li><li>누적 이벤트 개수가 설정된 임계값에 도달하면 Snapshot Store에 전체 상태 저장</li><li>복구 시 Snapshot 불러오고, 이후 이벤트만 Replay</li></ol><hr><h3 id=유무-차이><strong>유무 차이</strong><a hidden class=anchor aria-hidden=true href=#유무-차이>#</a></h3><ul><li><strong>스냅샷 미도입</strong>: 재시작 시 모든 이벤트를 처음부터 재생 → 느림</li><li><strong>스냅샷 도입</strong>: 스냅샷에서 복원 후 남은 이벤트만 재생 → 빠름</li></ul><hr><h3 id=구현-예시-python><strong>구현 예시 (Python)</strong><a hidden class=anchor aria-hidden=true href=#구현-예시-python>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>  1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>  2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>  3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>  4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>  5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>  6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>  7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8>  8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9>  9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10> 10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11> 11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12> 12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13> 13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14> 14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15> 15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16> 16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17> 17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18> 18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19> 19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20> 20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21> 21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22> 22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23> 23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24> 24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25> 25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26> 26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27> 27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28> 28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29> 29</a>
</span><span class=lnt id=hl-7-30><a class=lnlinks href=#hl-7-30> 30</a>
</span><span class=lnt id=hl-7-31><a class=lnlinks href=#hl-7-31> 31</a>
</span><span class=lnt id=hl-7-32><a class=lnlinks href=#hl-7-32> 32</a>
</span><span class=lnt id=hl-7-33><a class=lnlinks href=#hl-7-33> 33</a>
</span><span class=lnt id=hl-7-34><a class=lnlinks href=#hl-7-34> 34</a>
</span><span class=lnt id=hl-7-35><a class=lnlinks href=#hl-7-35> 35</a>
</span><span class=lnt id=hl-7-36><a class=lnlinks href=#hl-7-36> 36</a>
</span><span class=lnt id=hl-7-37><a class=lnlinks href=#hl-7-37> 37</a>
</span><span class=lnt id=hl-7-38><a class=lnlinks href=#hl-7-38> 38</a>
</span><span class=lnt id=hl-7-39><a class=lnlinks href=#hl-7-39> 39</a>
</span><span class=lnt id=hl-7-40><a class=lnlinks href=#hl-7-40> 40</a>
</span><span class=lnt id=hl-7-41><a class=lnlinks href=#hl-7-41> 41</a>
</span><span class=lnt id=hl-7-42><a class=lnlinks href=#hl-7-42> 42</a>
</span><span class=lnt id=hl-7-43><a class=lnlinks href=#hl-7-43> 43</a>
</span><span class=lnt id=hl-7-44><a class=lnlinks href=#hl-7-44> 44</a>
</span><span class=lnt id=hl-7-45><a class=lnlinks href=#hl-7-45> 45</a>
</span><span class=lnt id=hl-7-46><a class=lnlinks href=#hl-7-46> 46</a>
</span><span class=lnt id=hl-7-47><a class=lnlinks href=#hl-7-47> 47</a>
</span><span class=lnt id=hl-7-48><a class=lnlinks href=#hl-7-48> 48</a>
</span><span class=lnt id=hl-7-49><a class=lnlinks href=#hl-7-49> 49</a>
</span><span class=lnt id=hl-7-50><a class=lnlinks href=#hl-7-50> 50</a>
</span><span class=lnt id=hl-7-51><a class=lnlinks href=#hl-7-51> 51</a>
</span><span class=lnt id=hl-7-52><a class=lnlinks href=#hl-7-52> 52</a>
</span><span class=lnt id=hl-7-53><a class=lnlinks href=#hl-7-53> 53</a>
</span><span class=lnt id=hl-7-54><a class=lnlinks href=#hl-7-54> 54</a>
</span><span class=lnt id=hl-7-55><a class=lnlinks href=#hl-7-55> 55</a>
</span><span class=lnt id=hl-7-56><a class=lnlinks href=#hl-7-56> 56</a>
</span><span class=lnt id=hl-7-57><a class=lnlinks href=#hl-7-57> 57</a>
</span><span class=lnt id=hl-7-58><a class=lnlinks href=#hl-7-58> 58</a>
</span><span class=lnt id=hl-7-59><a class=lnlinks href=#hl-7-59> 59</a>
</span><span class=lnt id=hl-7-60><a class=lnlinks href=#hl-7-60> 60</a>
</span><span class=lnt id=hl-7-61><a class=lnlinks href=#hl-7-61> 61</a>
</span><span class=lnt id=hl-7-62><a class=lnlinks href=#hl-7-62> 62</a>
</span><span class=lnt id=hl-7-63><a class=lnlinks href=#hl-7-63> 63</a>
</span><span class=lnt id=hl-7-64><a class=lnlinks href=#hl-7-64> 64</a>
</span><span class=lnt id=hl-7-65><a class=lnlinks href=#hl-7-65> 65</a>
</span><span class=lnt id=hl-7-66><a class=lnlinks href=#hl-7-66> 66</a>
</span><span class=lnt id=hl-7-67><a class=lnlinks href=#hl-7-67> 67</a>
</span><span class=lnt id=hl-7-68><a class=lnlinks href=#hl-7-68> 68</a>
</span><span class=lnt id=hl-7-69><a class=lnlinks href=#hl-7-69> 69</a>
</span><span class=lnt id=hl-7-70><a class=lnlinks href=#hl-7-70> 70</a>
</span><span class=lnt id=hl-7-71><a class=lnlinks href=#hl-7-71> 71</a>
</span><span class=lnt id=hl-7-72><a class=lnlinks href=#hl-7-72> 72</a>
</span><span class=lnt id=hl-7-73><a class=lnlinks href=#hl-7-73> 73</a>
</span><span class=lnt id=hl-7-74><a class=lnlinks href=#hl-7-74> 74</a>
</span><span class=lnt id=hl-7-75><a class=lnlinks href=#hl-7-75> 75</a>
</span><span class=lnt id=hl-7-76><a class=lnlinks href=#hl-7-76> 76</a>
</span><span class=lnt id=hl-7-77><a class=lnlinks href=#hl-7-77> 77</a>
</span><span class=lnt id=hl-7-78><a class=lnlinks href=#hl-7-78> 78</a>
</span><span class=lnt id=hl-7-79><a class=lnlinks href=#hl-7-79> 79</a>
</span><span class=lnt id=hl-7-80><a class=lnlinks href=#hl-7-80> 80</a>
</span><span class=lnt id=hl-7-81><a class=lnlinks href=#hl-7-81> 81</a>
</span><span class=lnt id=hl-7-82><a class=lnlinks href=#hl-7-82> 82</a>
</span><span class=lnt id=hl-7-83><a class=lnlinks href=#hl-7-83> 83</a>
</span><span class=lnt id=hl-7-84><a class=lnlinks href=#hl-7-84> 84</a>
</span><span class=lnt id=hl-7-85><a class=lnlinks href=#hl-7-85> 85</a>
</span><span class=lnt id=hl-7-86><a class=lnlinks href=#hl-7-86> 86</a>
</span><span class=lnt id=hl-7-87><a class=lnlinks href=#hl-7-87> 87</a>
</span><span class=lnt id=hl-7-88><a class=lnlinks href=#hl-7-88> 88</a>
</span><span class=lnt id=hl-7-89><a class=lnlinks href=#hl-7-89> 89</a>
</span><span class=lnt id=hl-7-90><a class=lnlinks href=#hl-7-90> 90</a>
</span><span class=lnt id=hl-7-91><a class=lnlinks href=#hl-7-91> 91</a>
</span><span class=lnt id=hl-7-92><a class=lnlinks href=#hl-7-92> 92</a>
</span><span class=lnt id=hl-7-93><a class=lnlinks href=#hl-7-93> 93</a>
</span><span class=lnt id=hl-7-94><a class=lnlinks href=#hl-7-94> 94</a>
</span><span class=lnt id=hl-7-95><a class=lnlinks href=#hl-7-95> 95</a>
</span><span class=lnt id=hl-7-96><a class=lnlinks href=#hl-7-96> 96</a>
</span><span class=lnt id=hl-7-97><a class=lnlinks href=#hl-7-97> 97</a>
</span><span class=lnt id=hl-7-98><a class=lnlinks href=#hl-7-98> 98</a>
</span><span class=lnt id=hl-7-99><a class=lnlinks href=#hl-7-99> 99</a>
</span><span class=lnt id=hl-7-100><a class=lnlinks href=#hl-7-100>100</a>
</span><span class=lnt id=hl-7-101><a class=lnlinks href=#hl-7-101>101</a>
</span><span class=lnt id=hl-7-102><a class=lnlinks href=#hl-7-102>102</a>
</span><span class=lnt id=hl-7-103><a class=lnlinks href=#hl-7-103>103</a>
</span><span class=lnt id=hl-7-104><a class=lnlinks href=#hl-7-104>104</a>
</span><span class=lnt id=hl-7-105><a class=lnlinks href=#hl-7-105>105</a>
</span><span class=lnt id=hl-7-106><a class=lnlinks href=#hl-7-106>106</a>
</span><span class=lnt id=hl-7-107><a class=lnlinks href=#hl-7-107>107</a>
</span><span class=lnt id=hl-7-108><a class=lnlinks href=#hl-7-108>108</a>
</span><span class=lnt id=hl-7-109><a class=lnlinks href=#hl-7-109>109</a>
</span><span class=lnt id=hl-7-110><a class=lnlinks href=#hl-7-110>110</a>
</span><span class=lnt id=hl-7-111><a class=lnlinks href=#hl-7-111>111</a>
</span><span class=lnt id=hl-7-112><a class=lnlinks href=#hl-7-112>112</a>
</span><span class=lnt id=hl-7-113><a class=lnlinks href=#hl-7-113>113</a>
</span><span class=lnt id=hl-7-114><a class=lnlinks href=#hl-7-114>114</a>
</span><span class=lnt id=hl-7-115><a class=lnlinks href=#hl-7-115>115</a>
</span><span class=lnt id=hl-7-116><a class=lnlinks href=#hl-7-116>116</a>
</span><span class=lnt id=hl-7-117><a class=lnlinks href=#hl-7-117>117</a>
</span><span class=lnt id=hl-7-118><a class=lnlinks href=#hl-7-118>118</a>
</span><span class=lnt id=hl-7-119><a class=lnlinks href=#hl-7-119>119</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 이벤트 정의 -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 소싱의 핵심: 상태 변화를 기록하는 불변 객체&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>to_dict</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AddItemEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;ADD_ITEM&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>item</span> <span class=o>=</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RemoveItemEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;REMOVE_ITEM&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>item</span> <span class=o>=</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 저장소 구현 -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 저장소 - 모든 상태 변화를 기록&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Event</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events_since</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>index</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Event</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;지정 인덱스 이후의 이벤트 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>index</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SnapshotStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;스냅샷 저장소 - 특정 시점의 전체 상태 저장&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># key: 이벤트 인덱스</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>index</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>Any</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>  <span class=c1># JSON 직렬화 저장</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_latest_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>latest_index</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>latest_index</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>[</span><span class=n>latest_index</span><span class=p>])</span>  <span class=c1># JSON 역직렬화 반환</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- Cart Aggregate -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Cart 상태는 이벤트 Replay 또는 Snapshot + Replay로 복원&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 적용하여 상태 변경&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&#34;ADD_ITEM&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&#34;REMOVE_ITEM&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_state</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set_state</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;items&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 서비스 로직 (핵심 비즈니스 + 스냅샷) -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CartService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>SNAPSHOT_THRESHOLD</span> <span class=o>=</span> <span class=mi>5</span>  <span class=c1># N개 이벤트마다 스냅샷 저장</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>:</span> <span class=n>EventStore</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>:</span> <span class=n>SnapshotStore</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span> <span class=o>=</span> <span class=n>snapshot_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cart</span> <span class=o>=</span> <span class=n>Cart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 스냅샷 조건 충족 시 저장</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>events</span><span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>SNAPSHOT_THRESHOLD</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span><span class=o>.</span><span class=n>save_snapshot</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>events</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>get_state</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[스냅샷 저장] </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>events</span><span class=p>)</span><span class=si>}</span><span class=s2>개 이벤트 시점&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>restore_state</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;스냅샷 + 남은 이벤트로 상태 복원&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>last_snapshot_index</span><span class=p>,</span> <span class=n>snapshot_state</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span><span class=o>.</span><span class=n>get_latest_snapshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>snapshot_state</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>set_state</span><span class=p>(</span><span class=n>snapshot_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>start_index</span> <span class=o>=</span> <span class=n>last_snapshot_index</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>start_index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>remaining_events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events_since</span><span class=p>(</span><span class=n>start_index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>ev</span> <span class=ow>in</span> <span class=n>remaining_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>ev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[복원 완료] 총 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>remaining_events</span><span class=p>)</span><span class=si>}</span><span class=s2>개의 이벤트 재생&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 테스트 시나리오 -----</span>
</span></span><span class=line><span class=cl><span class=n>event_store</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>snapshot_store</span> <span class=o>=</span> <span class=n>SnapshotStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>service</span> <span class=o>=</span> <span class=n>CartService</span><span class=p>(</span><span class=n>event_store</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 이벤트 발생</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;사과&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;바나나&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>RemoveItemEvent</span><span class=p>(</span><span class=s2>&#34;사과&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;키위&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;포도&#34;</span><span class=p>))</span>  <span class=c1># 여기서 스냅샷 저장</span>
</span></span><span class=line><span class=cl><span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;수박&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 상태 확인</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[현재 상태]&#34;</span><span class=p>,</span> <span class=n>service</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 복구 테스트</span>
</span></span><span class=line><span class=cl><span class=n>new_service</span> <span class=o>=</span> <span class=n>CartService</span><span class=p>(</span><span class=n>event_store</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_service</span><span class=o>.</span><span class=n>restore_state</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[복구된 상태]&#34;</span><span class=p>,</span> <span class=n>new_service</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=-코드-동작-설명>🔍 코드 동작 설명<a hidden class=anchor aria-hidden=true href=#-코드-동작-설명>#</a></h3><ol><li><strong>EventStore</strong>는 모든 이벤트를 순차 저장</li><li><strong>SnapshotStore</strong>는 설정한 개수(N)에 도달할 때마다 Cart 상태를 저장</li><li><strong>복원 시</strong><ul><li>가장 최근 스냅샷 불러옴</li><li>이후 이벤트만 재적용(Replaying)</li></ul></li><li>이렇게 하면 <strong>시스템 재기동이나 장애 복구가 훨씬 빨라짐</strong></li></ol><hr><h3 id=-실무-적용-팁>💡 실무 적용 팁<a hidden class=anchor aria-hidden=true href=#-실무-적용-팁>#</a></h3><ul><li>스냅샷 저장 주기는 <strong>도메인별 퍼포먼스 테스트를 통해 조율</strong>해야 함</li><li>장기적으로는 스냅샷 데이터를 파일/클라우드 객체 스토리지에 보관 가능</li><li>이벤트와 스냅샷은 항상 <strong>같은 트랜잭션 단위</strong>로 저장하는 것이 안정적</li></ul><hr><p>좋습니다. 이전 단계에서 <strong>스냅샷(Snapshot) 적용 단일 서비스 Cart 예제</strong>까지 완성했으니, 이번에는 그것을 한 단계 확장해 <strong>분산 환경에서 동작하는 Event Sourcing + Kafka 연계 예제</strong>를 구현해 드리겠습니다.<br>이렇게 하면 로컬에서만 동작하는 구조를 **마이크로서비스 기반(Event-Driven Architecture)**으로 확장하는 실무 감각을 잡을 수 있습니다.</p><hr><h2 id=-실습-예제-event-sourcing--kafka-연계-장바구니-서비스-확장>🚀 실습 예제: Event Sourcing + Kafka 연계 (장바구니 서비스 확장)<a hidden class=anchor aria-hidden=true href=#-실습-예제-event-sourcing--kafka-연계-장바구니-서비스-확장>#</a></h2><h3 id=시나리오><strong>시나리오</strong><a hidden class=anchor aria-hidden=true href=#시나리오>#</a></h3><ul><li>장바구니(Cart) 서비스에서 발생한 모든 이벤트를 Kafka 토픽으로 발행(Publish)</li><li>다른 서비스(예: Analytics 서비스, Notification 서비스)가 이를 구독(Subscribe)하여 실시간 반응</li><li>Cart 서비스 자체도 스냅샷을 적용해 성능 최적화</li></ul><hr><h3 id=시스템-구성><strong>시스템 구성</strong><a hidden class=anchor aria-hidden=true href=#시스템-구성>#</a></h3><ul><li>Cart Service (Event Sourcing + Snapshot + Kafka Producer)</li><li>Kafka Broker (메시지 브로커)</li><li>Analytics Service (Kafka Consumer → 통계 작성)</li><li>Event Store + Snapshot Store (저장소)</li></ul><hr><h3 id=구성-다이어그램><strong>구성 다이어그램</strong><a hidden class=anchor aria-hidden=true href=#구성-다이어그램>#</a></h3><pre class=mermaid>graph TB
    User[사용자 요청] --&gt; CartService[Cart Service]
    CartService --&gt; EventStore[Event Store]
    CartService --&gt; SnapshotStore[Snapshot Store]
    CartService -- 발행 --&gt; Kafka[(Kafka Broker)]
    Kafka -- 구독 --&gt; AnalyticsService[Analytics Service]
    Kafka -- 구독 --&gt; NotificationService[알림 서비스]
</pre><hr><h3 id=workflow-단계별-흐름><strong>Workflow (단계별 흐름)</strong><a hidden class=anchor aria-hidden=true href=#workflow-단계별-흐름>#</a></h3><ol><li>사용자가 Cart Service에 요청 → 이벤트 생성</li><li>이벤트를 Event Store에 저장 → 스냅샷 조건 충족 시 Snapshot Store에 저장</li><li>이벤트를 Kafka Topic으로 발행</li><li>Analytics Service가 Kafka 토픽을 구독하여 통계 데이터 생성</li><li>Notification Service가 Kafka 토픽을 구독하여 알림 전송</li></ol><hr><h3 id=구현-예시-python-kafka-python-라이브러리-사용><strong>구현 예시 (Python, kafka-python 라이브러리 사용)</strong><a hidden class=anchor aria-hidden=true href=#구현-예시-python-kafka-python-라이브러리-사용>#</a></h3><blockquote><p>이 예시는 <code>kafka-python</code>을 사용하므로, 실행 전 <code>pip install kafka-python</code> 필요<br>Kafka 로컬 실행(또는 Docker 환경)이 준비되어 있어야 합니다.</p></blockquote><h4 id=cart_servicepy-producer>cart_service.py (Producer)<a hidden class=anchor aria-hidden=true href=#cart_servicepy-producer>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span><span class=lnt id=hl-9-23><a class=lnlinks href=#hl-9-23>23</a>
</span><span class=lnt id=hl-9-24><a class=lnlinks href=#hl-9-24>24</a>
</span><span class=lnt id=hl-9-25><a class=lnlinks href=#hl-9-25>25</a>
</span><span class=lnt id=hl-9-26><a class=lnlinks href=#hl-9-26>26</a>
</span><span class=lnt id=hl-9-27><a class=lnlinks href=#hl-9-27>27</a>
</span><span class=lnt id=hl-9-28><a class=lnlinks href=#hl-9-28>28</a>
</span><span class=lnt id=hl-9-29><a class=lnlinks href=#hl-9-29>29</a>
</span><span class=lnt id=hl-9-30><a class=lnlinks href=#hl-9-30>30</a>
</span><span class=lnt id=hl-9-31><a class=lnlinks href=#hl-9-31>31</a>
</span><span class=lnt id=hl-9-32><a class=lnlinks href=#hl-9-32>32</a>
</span><span class=lnt id=hl-9-33><a class=lnlinks href=#hl-9-33>33</a>
</span><span class=lnt id=hl-9-34><a class=lnlinks href=#hl-9-34>34</a>
</span><span class=lnt id=hl-9-35><a class=lnlinks href=#hl-9-35>35</a>
</span><span class=lnt id=hl-9-36><a class=lnlinks href=#hl-9-36>36</a>
</span><span class=lnt id=hl-9-37><a class=lnlinks href=#hl-9-37>37</a>
</span><span class=lnt id=hl-9-38><a class=lnlinks href=#hl-9-38>38</a>
</span><span class=lnt id=hl-9-39><a class=lnlinks href=#hl-9-39>39</a>
</span><span class=lnt id=hl-9-40><a class=lnlinks href=#hl-9-40>40</a>
</span><span class=lnt id=hl-9-41><a class=lnlinks href=#hl-9-41>41</a>
</span><span class=lnt id=hl-9-42><a class=lnlinks href=#hl-9-42>42</a>
</span><span class=lnt id=hl-9-43><a class=lnlinks href=#hl-9-43>43</a>
</span><span class=lnt id=hl-9-44><a class=lnlinks href=#hl-9-44>44</a>
</span><span class=lnt id=hl-9-45><a class=lnlinks href=#hl-9-45>45</a>
</span><span class=lnt id=hl-9-46><a class=lnlinks href=#hl-9-46>46</a>
</span><span class=lnt id=hl-9-47><a class=lnlinks href=#hl-9-47>47</a>
</span><span class=lnt id=hl-9-48><a class=lnlinks href=#hl-9-48>48</a>
</span><span class=lnt id=hl-9-49><a class=lnlinks href=#hl-9-49>49</a>
</span><span class=lnt id=hl-9-50><a class=lnlinks href=#hl-9-50>50</a>
</span><span class=lnt id=hl-9-51><a class=lnlinks href=#hl-9-51>51</a>
</span><span class=lnt id=hl-9-52><a class=lnlinks href=#hl-9-52>52</a>
</span><span class=lnt id=hl-9-53><a class=lnlinks href=#hl-9-53>53</a>
</span><span class=lnt id=hl-9-54><a class=lnlinks href=#hl-9-54>54</a>
</span><span class=lnt id=hl-9-55><a class=lnlinks href=#hl-9-55>55</a>
</span><span class=lnt id=hl-9-56><a class=lnlinks href=#hl-9-56>56</a>
</span><span class=lnt id=hl-9-57><a class=lnlinks href=#hl-9-57>57</a>
</span><span class=lnt id=hl-9-58><a class=lnlinks href=#hl-9-58>58</a>
</span><span class=lnt id=hl-9-59><a class=lnlinks href=#hl-9-59>59</a>
</span><span class=lnt id=hl-9-60><a class=lnlinks href=#hl-9-60>60</a>
</span><span class=lnt id=hl-9-61><a class=lnlinks href=#hl-9-61>61</a>
</span><span class=lnt id=hl-9-62><a class=lnlinks href=#hl-9-62>62</a>
</span><span class=lnt id=hl-9-63><a class=lnlinks href=#hl-9-63>63</a>
</span><span class=lnt id=hl-9-64><a class=lnlinks href=#hl-9-64>64</a>
</span><span class=lnt id=hl-9-65><a class=lnlinks href=#hl-9-65>65</a>
</span><span class=lnt id=hl-9-66><a class=lnlinks href=#hl-9-66>66</a>
</span><span class=lnt id=hl-9-67><a class=lnlinks href=#hl-9-67>67</a>
</span><span class=lnt id=hl-9-68><a class=lnlinks href=#hl-9-68>68</a>
</span><span class=lnt id=hl-9-69><a class=lnlinks href=#hl-9-69>69</a>
</span><span class=lnt id=hl-9-70><a class=lnlinks href=#hl-9-70>70</a>
</span><span class=lnt id=hl-9-71><a class=lnlinks href=#hl-9-71>71</a>
</span><span class=lnt id=hl-9-72><a class=lnlinks href=#hl-9-72>72</a>
</span><span class=lnt id=hl-9-73><a class=lnlinks href=#hl-9-73>73</a>
</span><span class=lnt id=hl-9-74><a class=lnlinks href=#hl-9-74>74</a>
</span><span class=lnt id=hl-9-75><a class=lnlinks href=#hl-9-75>75</a>
</span><span class=lnt id=hl-9-76><a class=lnlinks href=#hl-9-76>76</a>
</span><span class=lnt id=hl-9-77><a class=lnlinks href=#hl-9-77>77</a>
</span><span class=lnt id=hl-9-78><a class=lnlinks href=#hl-9-78>78</a>
</span><span class=lnt id=hl-9-79><a class=lnlinks href=#hl-9-79>79</a>
</span><span class=lnt id=hl-9-80><a class=lnlinks href=#hl-9-80>80</a>
</span><span class=lnt id=hl-9-81><a class=lnlinks href=#hl-9-81>81</a>
</span><span class=lnt id=hl-9-82><a class=lnlinks href=#hl-9-82>82</a>
</span><span class=lnt id=hl-9-83><a class=lnlinks href=#hl-9-83>83</a>
</span><span class=lnt id=hl-9-84><a class=lnlinks href=#hl-9-84>84</a>
</span><span class=lnt id=hl-9-85><a class=lnlinks href=#hl-9-85>85</a>
</span><span class=lnt id=hl-9-86><a class=lnlinks href=#hl-9-86>86</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaProducer</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 이벤트 정의 -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>to_dict</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AddItemEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;ADD_ITEM&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>item</span> <span class=o>=</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RemoveItemEvent</span><span class=p>(</span><span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;REMOVE_ITEM&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>item</span> <span class=o>=</span> <span class=n>item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- 저장소 -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Event</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SnapshotStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>index</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=n>state</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_latest_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>idx</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- Cart Aggregate -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Cart</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&#34;ADD_ITEM&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&#34;REMOVE_ITEM&#34;</span> <span class=ow>and</span> <span class=n>event</span><span class=o>.</span><span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_state</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set_state</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;items&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ----- Cart Service -----</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CartService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>SNAPSHOT_THRESHOLD</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cart</span> <span class=o>=</span> <span class=n>Cart</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span> <span class=o>=</span> <span class=n>snapshot_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span> <span class=o>=</span> <span class=n>KafkaProducer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap_servers</span><span class=o>=</span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>value_serializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>v</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>Event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Kafka 발행</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;cart-events&#39;</span><span class=p>,</span> <span class=n>event</span><span class=o>.</span><span class=n>to_dict</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Kafka 발행] </span><span class=si>{</span><span class=n>event</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 스냅샷 조건 검사</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>events</span><span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>SNAPSHOT_THRESHOLD</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span><span class=o>.</span><span class=n>save_snapshot</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>events</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>get_state</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[스냅샷 저장] </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>cart</span><span class=o>.</span><span class=n>get_state</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 테스트 실행</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>event_store</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>snapshot_store</span> <span class=o>=</span> <span class=n>SnapshotStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>service</span> <span class=o>=</span> <span class=n>CartService</span><span class=p>(</span><span class=n>event_store</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;사과&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;바나나&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>RemoveItemEvent</span><span class=p>(</span><span class=s2>&#34;사과&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;키위&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>service</span><span class=o>.</span><span class=n>handle_event</span><span class=p>(</span><span class=n>AddItemEvent</span><span class=p>(</span><span class=s2>&#34;포도&#34;</span><span class=p>))</span>   <span class=c1># 스냅샷 저장 시점</span>
</span></span></code></pre></td></tr></table></div></div><hr><h4 id=analytics_servicepy-consumer>analytics_service.py (Consumer)<a hidden class=anchor aria-hidden=true href=#analytics_servicepy-consumer>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span><span class=lnt id=hl-10-24><a class=lnlinks href=#hl-10-24>24</a>
</span><span class=lnt id=hl-10-25><a class=lnlinks href=#hl-10-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaConsumer</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>consumer</span> <span class=o>=</span> <span class=n>KafkaConsumer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;cart-events&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap_servers</span><span class=o>=</span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value_deserializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>m</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=n>group_id</span><span class=o>=</span><span class=s1>&#39;analytics-service&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[Analytics] Kafka 구독 시작&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>item_counts</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>consumer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>event</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;ADD_ITEM&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;item&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>item_counts</span><span class=p>[</span><span class=n>item</span><span class=p>]</span> <span class=o>=</span> <span class=n>item_counts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;REMOVE_ITEM&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;item&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>item_counts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>item_counts</span><span class=p>[</span><span class=n>item</span><span class=p>]</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item_counts</span><span class=p>[</span><span class=n>item</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>del</span> <span class=n>item_counts</span><span class=p>[</span><span class=n>item</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[Analytics] 현재 집계:&#34;</span><span class=p>,</span> <span class=n>item_counts</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=포인트><strong>포인트</strong><a hidden class=anchor aria-hidden=true href=#포인트>#</a></h3><ul><li>Cart Service는 이벤트를 <strong>Event Store + Snapshot Store + Kafka</strong>에 동시에 반영</li><li>Kafka Producer → 다른 서비스가 실시간 반응 가능</li><li>Consumer 서비스(Analytics, Notification 등)가 비즈니스 확장 가능</li><li>운영 환경에서는 <strong>Kafka 파티션 키</strong>를 Aggregate ID로 설정하여 이벤트 순서 보장</li></ul><hr><h3 id=실무-적용-시-고려사항><strong>실무 적용 시 고려사항</strong><a hidden class=anchor aria-hidden=true href=#실무-적용-시-고려사항>#</a></h3><ol><li><strong>이벤트 순서 보장</strong> → Kafka 파티션 사용 & Aggregate ID 기반 Key 설정</li><li><strong>장애 복구</strong> → Kafka Consumer 오프셋(Offset) 관리 필수</li><li><strong>보안</strong> → Kafka 통신 SSL/TLS 적용, SASL 인증 적용 가능</li><li><strong>확장성</strong> → 마이크로서비스별 독립 토픽 설계, Backpressure 처리 전략 필요</li></ol><hr><p>이제 우리는<br>① <strong>순수 Event Sourcing 구현</strong> →<br>② <strong>스냅샷 적용 버전</strong> →<br>③ <strong>Kafka 기반 분산 Event-Driven Architecture</strong> 까지<br>단계적으로 확장했습니다.</p><p>원한다면 다음 단계로 <strong>CQRS(Command Query Responsibility Segregation) 패턴을 결합한 마이크로서비스 구조</strong>를 설계해 드릴 수 있습니다.<br>그렇게 하면 조회 성능과 확장성까지 최적화된 완전한 <strong>실무용 이벤트 소싱 아키텍처</strong>가 완성됩니다.</p><p>다음 단계로 <strong>CQRS 결합 설계</strong>까지 진행할까요?</p><h2 id=event-sourcing-종합-기술-분석>Event Sourcing 종합 기술 분석<a hidden class=anchor aria-hidden=true href=#event-sourcing-종합-기술-분석>#</a></h2><hr><h2 id=1단계-기본-분석-1>1단계: 기본 분석<a hidden class=anchor aria-hidden=true href=#1단계-기본-분석-1>#</a></h2><h3 id=대표-태그>대표 태그<a hidden class=anchor aria-hidden=true href=#대표-태그>#</a></h3><ul><li><strong>Event-Driven-Architecture</strong> (이벤트 중심 아키텍처)</li><li><strong>Immutable-Event-Log</strong> (불변 이벤트 로그)</li><li><strong>State-Reconstruction</strong> (상태 재구성)</li><li><strong>CQRS-Pattern</strong> (명령-쿼리 분리 패턴)</li></ul><h3 id=분류-체계-검증>분류 체계 검증<a hidden class=anchor aria-hidden=true href=#분류-체계-검증>#</a></h3><p><strong>현재 분류</strong>: Software Engineering > Design and Architecture > Architecture Styles > Messaging-Oriented Architecture > Event-Driven Architecture > Event Patterns</p><p><strong>개선 제안</strong>: 현재 분류가 적절합니다. Event Sourcing은 Event-Driven Architecture의 핵심 패턴이며, 메시징 기반 아키텍처의 특수한 형태로 정확히 분류되어 있습니다. 다만 다음과 같은 교차 연결도 고려할 수 있습니다:</p><ul><li>System Design > Data Management > Data Persistence Patterns</li><li>Software Engineering > Design Patterns > Behavioral Patterns</li></ul><p><strong>근거</strong>: Event Sourcing은 데이터 지속성 전략이자 행동 패턴의 성격을 동시에 가지고 있어 다각도로 접근 가능한 주제입니다.</p><h3 id=핵심-요약-250자-이내>핵심 요약 (250자 이내)<a hidden class=anchor aria-hidden=true href=#핵심-요약-250자-이내>#</a></h3><p>Event Sourcing은 애플리케이션의 상태 변화를 불변(Immutable) 이벤트 시퀀스로 저장하는 아키텍처 패턴입니다. 현재 상태가 아닌 모든 변경 사항을 이벤트로 기록하여 완전한 감사 추적(Audit Trail)을 제공하고, 언제든 과거 시점의 상태를 재구성할 수 있습니다. 주로 CQRS (Command Query Responsibility Segregation)와 함께 사용되어 분산 시스템의 확장성과 일관성을 향상시킵니다.</p><h3 id=전체-개요-400자-이내>전체 개요 (400자 이내)<a hidden class=anchor aria-hidden=true href=#전체-개요-400자-이내>#</a></h3><p>Event Sourcing은 전통적인 CRUD (Create, Read, Update, Delete) 방식 대신 모든 상태 변화를 순차적인 이벤트로 저장하는 데이터 아키텍처 패턴입니다. 이벤트 스토어(Event Store)에 append-only 방식으로 저장된 이벤트들을 재생(Replay)하여 현재 상태를 재구성합니다.</p><p>핵심 특징으로는 완벽한 감사 로그, 시점별 상태 복원, 확장성 향상이 있으며, 금융, 전자상거래, IoT 등 높은 투명성과 추적성이 요구되는 도메인에서 활용됩니다. Apache Kafka, EventStore, AWS EventBridge 등의 기술 스택과 함께 구현되며, 마이크로서비스 아키텍처에서 서비스 간 일관성을 보장하는 핵심 패턴으로 자리잡고 있습니다.</p><hr><h2 id=2단계-핵심-분석-1>2단계: 핵심 분석<a hidden class=anchor aria-hidden=true href=#2단계-핵심-분석-1>#</a></h2><h3 id=핵심-개념-정리>핵심 개념 정리<a hidden class=anchor aria-hidden=true href=#핵심-개념-정리>#</a></h3><h4 id=이론적-관점>이론적 관점<a hidden class=anchor aria-hidden=true href=#이론적-관점>#</a></h4><ol><li><strong>Event Store (이벤트 스토어)</strong>: 모든 이벤트를 저장하는 append-only 데이터베이스</li><li><strong>Event Replay (이벤트 재생)</strong>: 저장된 이벤트를 순차적으로 재생하여 상태를 재구성하는 과정</li><li><strong>Aggregate (집계)</strong>: 비즈니스 로직의 일관성 경계를 나타내는 도메인 객체</li><li><strong>Projection (프로젝션)</strong>: 이벤트로부터 생성되는 읽기 전용 뷰</li></ol><h4 id=실무적-관점>실무적 관점<a hidden class=anchor aria-hidden=true href=#실무적-관점>#</a></h4><ol><li><strong>Snapshot (스냅샷)</strong>: 성능 최적화를 위한 특정 시점의 상태 저장</li><li><strong>Compensating Event (보상 이벤트)</strong>: 이전 이벤트의 효과를 상쇄하는 새로운 이벤트</li><li><strong>Event Schema Evolution (이벤트 스키마 진화)</strong>: 이벤트 구조 변경에 대한 하위 호환성 관리</li><li><strong>Event Sourcing Gateway</strong>: 외부 시스템과의 통합을 위한 인터페이스 레이어</li></ol><h4 id=기본-수준>기본 수준<a hidden class=anchor aria-hidden=true href=#기본-수준>#</a></h4><ul><li>이벤트의 불변성(Immutability) 이해</li><li>상태 재구성 메커니즘 파악</li><li>Event Store의 기본 구조 학습</li></ul><h4 id=심화-수준>심화 수준<a hidden class=anchor aria-hidden=true href=#심화-수준>#</a></h4><ul><li>분산 환경에서의 이벤트 일관성 보장</li><li>성능 최적화 전략 (샤딩, 파티셔닝)</li><li>복잡한 도메인에서의 이벤트 모델링</li></ul><h3 id=실무-연관성-분석>실무 연관성 분석<a hidden class=anchor aria-hidden=true href=#실무-연관성-분석>#</a></h3><h4 id=마이크로서비스-아키텍처>마이크로서비스 아키텍처<a hidden class=anchor aria-hidden=true href=#마이크로서비스-아키텍처>#</a></h4><ul><li><strong>서비스 간 데이터 일관성</strong>: 이벤트를 통한 최종 일관성(Eventual Consistency) 달성</li><li><strong>서비스 분리</strong>: 각 서비스가 독립적인 이벤트 스토어를 가져 loose coupling 실현</li><li><strong>통합 복잡성 감소</strong>: 이벤트 기반 통신으로 서비스 간 의존성 최소화</li></ul><h4 id=클라우드-네이티브-구현>클라우드 네이티브 구현<a hidden class=anchor aria-hidden=true href=#클라우드-네이티브-구현>#</a></h4><ul><li><strong>확장성</strong>: 이벤트 스트림의 수평적 확장과 부하 분산</li><li><strong>장애 복구</strong>: 이벤트 재생을 통한 시스템 복구 능력</li><li><strong>관측성</strong>: 모든 변경 사항의 추적 및 모니터링</li></ul><h4 id=devops-및-운영>DevOps 및 운영<a hidden class=anchor aria-hidden=true href=#devops-및-운영>#</a></h4><ul><li><strong>배포 전략</strong>: 블루-그린 배포 시 이벤트 재생을 통한 상태 동기화</li><li><strong>테스팅</strong>: 이벤트 재생을 활용한 시나리오 기반 테스트</li><li><strong>문제 해결</strong>: 이벤트 로그를 통한 디버깅 및 근본 원인 분석</li></ul><hr><h2 id=3단계-상세-조사>3단계: 상세 조사<a hidden class=anchor aria-hidden=true href=#3단계-상세-조사>#</a></h2><h2 id=phase-1-기초-이해-foundation-understanding>Phase 1: 기초 이해 (Foundation Understanding)<a hidden class=anchor aria-hidden=true href=#phase-1-기초-이해-foundation-understanding>#</a></h2><h3 id=개념-정의-및-본질>개념 정의 및 본질<a hidden class=anchor aria-hidden=true href=#개념-정의-및-본질>#</a></h3><p>Event Sourcing(이벤트 소싱)은 애플리케이션의 상태를 직접 저장하는 대신, 상태를 변경하는 모든 이벤트를 순차적으로 저장하는 소프트웨어 아키텍처 패턴입니다. 이는 &ldquo;모든 변화는 이벤트의 결과"라는 철학을 기반으로 합니다.</p><p><strong>핵심 정의</strong>:</p><ul><li>상태(State) 대신 변화(Change)를 저장</li><li>이벤트는 불변(Immutable)하며 순서가 보장됨</li><li>현재 상태는 이벤트 재생을 통해 재구성</li><li>시스템의 완전한 히스토리 보존</li></ul><h3 id=등장-배경-및-발전-과정>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정>#</a></h3><p><strong>등장 배경</strong>:</p><ol><li><strong>전통적 CRUD의 한계</strong>: 상태 덮어쓰기로 인한 정보 손실</li><li><strong>감사 요구사항 증가</strong>: 규제 산업에서의 완전한 추적성 필요</li><li><strong>분산 시스템의 복잡성</strong>: 마이크로서비스 간 데이터 일관성 문제</li><li><strong>실시간 분석 요구</strong>: 비즈니스 인텔리전스와 실시간 의사결정 지원</li></ol><p><strong>발전 과정</strong>:</p><ul><li><strong>2005년</strong>: Martin Fowler의 초기 개념 정의</li><li><strong>2010년대 초</strong>: Greg Young의 Event Store 개발</li><li><strong>2010년대 중반</strong>: CQRS와의 결합으로 실용성 증대</li><li><strong>2020년대</strong>: 클라우드 네이티브 환경에서의 표준 패턴으로 자리매김</li></ul><h3 id=핵심-동기-및-가치-제안>핵심 동기 및 가치 제안<a hidden class=anchor aria-hidden=true href=#핵심-동기-및-가치-제안>#</a></h3><p><strong>주요 동기</strong>:</p><ol><li><strong>완전한 감사 추적</strong>: 모든 변경사항의 불변 기록</li><li><strong>시점별 상태 복원</strong>: 임의의 시점으로 되돌리기 가능</li><li><strong>확장성 향상</strong>: 읽기와 쓰기의 독립적 최적화</li><li><strong>장애 복구</strong>: 이벤트 재생을 통한 시스템 복구</li></ol><p><strong>가치 제안</strong>:</p><ul><li><strong>규정 준수</strong>: 금융, 의료 등 규제 산업의 요구사항 충족</li><li><strong>비즈니스 인사이트</strong>: 이벤트 분석을 통한 비즈니스 패턴 발견</li><li><strong>시스템 투명성</strong>: 모든 변경 과정의 완전한 가시성</li><li><strong>미래 확장성</strong>: 새로운 읽기 모델을 언제든 추가 가능</li></ul><h3 id=주요-특징>주요 특징<a hidden class=anchor aria-hidden=true href=#주요-특징>#</a></h3><table><thead><tr><th>특징</th><th>설명</th><th>기술적 근거</th></tr></thead><tbody><tr><td><strong>불변성</strong></td><td>이벤트는 한 번 저장되면 변경되지 않음</td><td>Append-only 저장 구조로 데이터 무결성 보장</td></tr><tr><td><strong>순서 보장</strong></td><td>이벤트는 발생 순서대로 저장</td><td>타임스탬프와 시퀀스 번호를 통한 순서 관리</td></tr><tr><td><strong>재생 가능성</strong></td><td>이벤트 재생으로 상태 재구성</td><td>순수 함수를 통한 결정론적 상태 계산</td></tr><tr><td><strong>확장성</strong></td><td>읽기와 쓰기의 독립적 스케일링</td><td>CQRS 패턴과의 결합으로 성능 최적화</td></tr><tr><td><strong>추적성</strong></td><td>모든 변경사항의 완전한 히스토리</td><td>각 이벤트의 메타데이터 포함 저장</td></tr></tbody></table><hr><h2 id=phase-2-핵심-이론-core-theory>Phase 2: 핵심 이론 (Core Theory)<a hidden class=anchor aria-hidden=true href=#phase-2-핵심-이론-core-theory>#</a></h2><h3 id=핵심-설계-원칙>핵심 설계 원칙<a hidden class=anchor aria-hidden=true href=#핵심-설계-원칙>#</a></h3><ol><li><strong>이벤트 불변성 원칙</strong>: 한 번 저장된 이벤트는 절대 수정하지 않음</li><li><strong>단일 진실 원천 원칙</strong>: Event Store가 시스템의 유일한 진실 원천</li><li><strong>이벤트 순서 보장 원칙</strong>: 같은 집계(Aggregate) 내 이벤트는 순서 보장</li><li><strong>보상 이벤트 원칙</strong>: 취소나 수정은 새로운 보상 이벤트로 처리</li><li><strong>도메인 이벤트 원칙</strong>: 비즈니스적으로 의미 있는 이벤트만 저장</li></ol><h3 id=기본-원리-및-동작-메커니즘>기본 원리 및 동작 메커니즘<a hidden class=anchor aria-hidden=true href=#기본-원리-및-동작-메커니즘>#</a></h3><pre class=mermaid>graph TB
    A[비즈니스 명령] --&gt; B[도메인 로직 처리]
    B --&gt; C[이벤트 생성]
    C --&gt; D[Event Store 저장]
    D --&gt; E[이벤트 발행]
    E --&gt; F[프로젝션 업데이트]
    E --&gt; G[외부 시스템 통지]
    
    H[쿼리 요청] --&gt; I[프로젝션 조회]
    I --&gt; J[읽기 모델 반환]
    
    K[상태 재구성] --&gt; L[이벤트 로드]
    L --&gt; M[이벤트 재생]
    M --&gt; N[현재 상태 계산]
</pre><p><strong>동작 원리</strong>:</p><ol><li><strong>Command 처리</strong>: 비즈니스 명령을 도메인 객체에서 처리</li><li><strong>Event 생성</strong>: 상태 변화를 이벤트로 모델링</li><li><strong>Event 저장</strong>: Event Store에 순차적으로 저장</li><li><strong>Event 발행</strong>: 관심 있는 구독자들에게 이벤트 전파</li><li><strong>Projection 업데이트</strong>: 읽기 모델 갱신</li><li><strong>State 재구성</strong>: 필요시 이벤트 재생으로 상태 복원</li></ol><h3 id=아키텍처-및-구성-요소>아키텍처 및 구성 요소<a hidden class=anchor aria-hidden=true href=#아키텍처-및-구성-요소>#</a></h3><pre class=mermaid>graph TB
    subgraph &#34;Command Side (Write)&#34;
        A[Command Handler] --&gt; B[Aggregate Root]
        B --&gt; C[Domain Events]
        C --&gt; D[Event Store]
    end
    
    subgraph &#34;Query Side (Read)&#34;
        E[Event Handler] --&gt; F[Projection]
        F --&gt; G[Read Model DB]
        G --&gt; H[Query Handler]
    end
    
    subgraph &#34;Event Infrastructure&#34;
        I[Event Bus] --&gt; E
        D --&gt; I
        J[Event Catalog] --&gt; K[Schema Registry]
    end
    
    D -.-&gt;|Event Replay| L[State Reconstruction]
    F -.-&gt;|Snapshot| M[Snapshot Store]
</pre><p><strong>필수 구성 요소</strong>:</p><ol><li><strong>Event Store</strong>: 이벤트를 영구 저장하는 데이터베이스</li><li><strong>Command Handler</strong>: 비즈니스 명령을 처리하는 컴포넌트</li><li><strong>Event Handler</strong>: 이벤트를 수신하고 처리하는 컴포넌트</li><li><strong>Projection Engine</strong>: 읽기 모델을 생성하고 유지하는 엔진</li></ol><p><strong>선택적 구성 요소</strong>:</p><ol><li><strong>Snapshot Store</strong>: 성능 최적화를 위한 스냅샷 저장소</li><li><strong>Event Bus</strong>: 이벤트 라우팅 및 배포 인프라</li><li><strong>Schema Registry</strong>: 이벤트 스키마 버전 관리</li><li><strong>Event Catalog</strong>: 이벤트 메타데이터 관리</li></ol><h3 id=주요-기능과-역할>주요 기능과 역할<a hidden class=anchor aria-hidden=true href=#주요-기능과-역할>#</a></h3><h4 id=event-store-기능>Event Store 기능<a hidden class=anchor aria-hidden=true href=#event-store-기능>#</a></h4><ul><li><strong>이벤트 저장</strong>: Append-only 방식으로 이벤트 영구 저장</li><li><strong>이벤트 조회</strong>: 집계 ID별 이벤트 시퀀스 조회</li><li><strong>스트리밍</strong>: 실시간 이벤트 스트림 제공</li><li><strong>스냅샷 관리</strong>: 성능 최적화를 위한 스냅샷 생성/관리</li></ul><h4 id=projection-engine-기능>Projection Engine 기능<a hidden class=anchor aria-hidden=true href=#projection-engine-기능>#</a></h4><ul><li><strong>이벤트 구독</strong>: Event Store로부터 이벤트 수신</li><li><strong>상태 계산</strong>: 이벤트 기반 읽기 모델 생성</li><li><strong>뷰 최적화</strong>: 쿼리 패턴에 맞춘 데이터 구조 생성</li><li><strong>일관성 관리</strong>: 최종 일관성 보장</li></ul><h4 id=commandquery-분리>Command/Query 분리<a hidden class=anchor aria-hidden=true href=#commandquery-분리>#</a></h4><ul><li><strong>Command 책임</strong>: 비즈니스 로직 실행, 이벤트 생성</li><li><strong>Query 책임</strong>: 읽기 최적화된 뷰 제공</li><li><strong>독립적 확장</strong>: 읽기/쓰기 워크로드별 최적화</li><li><strong>기술 스택 분리</strong>: 각각 다른 기술 스택 사용 가능</li></ul><hr><h2 id=phase-3-특성-분석-characteristics-analysis>Phase 3: 특성 분석 (Characteristics Analysis)<a hidden class=anchor aria-hidden=true href=#phase-3-특성-분석-characteristics-analysis>#</a></h2><h3 id=장점-및-이점>장점 및 이점<a hidden class=anchor aria-hidden=true href=#장점-및-이점>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>기술적 근거</th></tr></thead><tbody><tr><td>장점</td><td><strong>완벽한 감사 추적</strong></td><td>모든 상태 변화의 불변 기록 유지</td><td>Append-only 저장 구조로 데이터 변조 방지</td></tr><tr><td>장점</td><td><strong>시점별 상태 복원</strong></td><td>과거 임의 시점의 상태 재구성 가능</td><td>이벤트 재생을 통한 결정론적 상태 계산</td></tr><tr><td>장점</td><td><strong>확장성</strong></td><td>읽기와 쓰기의 독립적 스케일링</td><td>CQRS 패턴과 결합하여 각각 최적화</td></tr><tr><td>장점</td><td><strong>장애 복구</strong></td><td>이벤트 재생을 통한 시스템 복구</td><td>이벤트 스토어를 단일 진실 원천으로 활용</td></tr><tr><td>장점</td><td><strong>비즈니스 인사이트</strong></td><td>이벤트 분석을 통한 패턴 발견</td><td>모든 비즈니스 이벤트의 풍부한 메타데이터</td></tr><tr><td>장점</td><td><strong>미래 확장성</strong></td><td>새로운 읽기 모델을 언제든 추가</td><td>기존 이벤트로부터 새로운 프로젝션 생성</td></tr><tr><td>장점</td><td><strong>동시성 문제 해결</strong></td><td>낙관적 동시성 제어로 성능 향상</td><td>이벤트 append 방식으로 락 경합 최소화</td></tr></tbody></table><h3 id=단점-및-제약사항과-해결방안>단점 및 제약사항과 해결방안<a hidden class=anchor aria-hidden=true href=#단점-및-제약사항과-해결방안>#</a></h3><p><strong>단점</strong></p><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th><th>대안 기술</th></tr></thead><tbody><tr><td>단점</td><td><strong>복잡성 증가</strong></td><td>전통적 CRUD 대비 구현 복잡도 상승</td><td>단계적 도입, 교육 투자</td><td>하이브리드 접근법</td></tr><tr><td>단점</td><td><strong>쿼리 복잡성</strong></td><td>이벤트 재생으로 인한 쿼리 성능 저하</td><td>CQRS 패턴, 프로젝션 활용</td><td>전용 쿼리 DB</td></tr><tr><td>단점</td><td><strong>스토리지 증가</strong></td><td>모든 이벤트 보관으로 저장 공간 증가</td><td>스냅샷, 아카이빙 전략</td><td>압축, 파티셔닝</td></tr><tr><td>단점</td><td><strong>최종 일관성</strong></td><td>읽기 모델의 최종 일관성으로 인한 지연</td><td>이벤트 버스 최적화</td><td>동기식 프로젝션</td></tr><tr><td>단점</td><td><strong>학습 곡선</strong></td><td>새로운 패러다임으로 인한 학습 부담</td><td>점진적 교육, 멘토링</td><td>기존 패턴과 혼용</td></tr></tbody></table><p><strong>문제점</strong></p><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지/진단</th><th>예방 방법</th><th>해결 기법</th></tr></thead><tbody><tr><td>문제점</td><td><strong>이벤트 스키마 진화</strong></td><td>비즈니스 요구사항 변화</td><td>하위 호환성 문제</td><td>버전 추적 도구</td><td>스키마 설계 가이드라인</td><td>다중 버전 핸들러</td></tr><tr><td>문제점</td><td><strong>이벤트 재생 성능</strong></td><td>대량 이벤트 누적</td><td>상태 재구성 지연</td><td>성능 모니터링</td><td>스냅샷 전략</td><td>병렬 처리, 캐싱</td></tr><tr><td>문제점</td><td><strong>이벤트 중복</strong></td><td>네트워크 장애, 재시도</td><td>데이터 불일치</td><td>중복 검사 도구</td><td>멱등성 설계</td><td>이벤트 ID 기반 중복 제거</td></tr><tr><td>문제점</td><td><strong>투영 지연</strong></td><td>이벤트 처리 병목</td><td>읽기 모델 지연</td><td>지연 메트릭</td><td>처리 용량 계획</td><td>배치 처리, 우선순위 큐</td></tr></tbody></table><h3 id=트레이드오프-관계-분석>트레이드오프 관계 분석<a hidden class=anchor aria-hidden=true href=#트레이드오프-관계-분석>#</a></h3><p><strong>성능 vs 일관성</strong>:</p><ul><li>이벤트 소싱은 쓰기 성능을 높이지만 읽기 일관성을 희생</li><li>CQRS와 결합하여 각각 최적화하지만 최종 일관성 수용 필요</li></ul><p><strong>단순성 vs 유연성</strong>:</p><ul><li>전통적 CRUD보다 복잡하지만 미래 변화에 대한 높은 적응력 제공</li><li>초기 개발 비용이 높지만 장기적 유지보수성 향상</li></ul><p><strong>저장 공간 vs 정보 보존</strong>:</p><ul><li>모든 이벤트 저장으로 공간 사용량 증가</li><li>대신 완전한 히스토리와 감사 추적 능력 확보</li></ul><p><strong>학습 곡선 vs 장기 이익</strong>:</p><ul><li>팀의 초기 학습 부담 증가</li><li>숙련도 향상 시 개발 생산성과 시스템 안정성 크게 개선</li></ul><hr><h2 id=phase-4-구현-및-분류-implementation--classification>Phase 4: 구현 및 분류 (Implementation & Classification)<a hidden class=anchor aria-hidden=true href=#phase-4-구현-및-분류-implementation--classification>#</a></h2><h3 id=구현-기법-및-방법-1>구현 기법 및 방법<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법-1>#</a></h3><h4 id=1-이벤트-모델링-기법>1. 이벤트 모델링 기법<a hidden class=anchor aria-hidden=true href=#1-이벤트-모델링-기법>#</a></h4><p><strong>정의</strong>: 비즈니스 도메인의 상태 변화를 이벤트로 표현하는 방법론</p><p><strong>구성</strong>:</p><ul><li>이벤트 식별: 도메인 전문가와 협업하여 비즈니스 이벤트 발굴</li><li>이벤트 설계: 이벤트 구조, 속성, 메타데이터 정의</li><li>이벤트 명명: 과거형 동사로 명명 (예: OrderPlaced, PaymentProcessed)</li></ul><p><strong>목적</strong>: 비즈니스 프로세스를 이벤트 중심으로 재구성하여 도메인 모델 명확화</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span><span class=lnt id=hl-13-17><a class=lnlinks href=#hl-13-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 주문 도메인의 이벤트 모델링</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>user_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=o>=</span> <span class=n>aggregate_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>=</span> <span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>user_id</span> <span class=o>=</span> <span class=n>user_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderPlaced</span><span class=p>(</span><span class=n>OrderEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>items</span><span class=p>,</span> <span class=n>total_amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>items</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total_amount</span> <span class=o>=</span> <span class=n>total_amount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderShipped</span><span class=p>(</span><span class=n>OrderEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>tracking_number</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tracking_number</span> <span class=o>=</span> <span class=n>tracking_number</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-이벤트-스토어-구현-기법>2. 이벤트 스토어 구현 기법<a hidden class=anchor aria-hidden=true href=#2-이벤트-스토어-구현-기법>#</a></h4><p><strong>정의</strong>: 이벤트를 영구 저장하고 조회할 수 있는 저장소 구현 방법</p><p><strong>구성</strong>:</p><ul><li>저장 스키마: 이벤트 ID, 집계 ID, 이벤트 타입, 버전, 데이터, 타임스탬프</li><li>인덱싱: 집계 ID별 빠른 조회를 위한 인덱스 설계</li><li>파티셔닝: 대용량 처리를 위한 데이터 분산 전략</li></ul><p><strong>목적</strong>: 이벤트의 안전한 저장과 효율적인 조회 보장</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a class=lnlinks href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a class=lnlinks href=#hl-14-24>24</a>
</span><span class=lnt id=hl-14-25><a class=lnlinks href=#hl-14-25>25</a>
</span><span class=lnt id=hl-14-26><a class=lnlinks href=#hl-14-26>26</a>
</span><span class=lnt id=hl-14-27><a class=lnlinks href=#hl-14-27>27</a>
</span><span class=lnt id=hl-14-28><a class=lnlinks href=#hl-14-28>28</a>
</span><span class=lnt id=hl-14-29><a class=lnlinks href=#hl-14-29>29</a>
</span><span class=lnt id=hl-14-30><a class=lnlinks href=#hl-14-30>30</a>
</span><span class=lnt id=hl-14-31><a class=lnlinks href=#hl-14-31>31</a>
</span><span class=lnt id=hl-14-32><a class=lnlinks href=#hl-14-32>32</a>
</span><span class=lnt id=hl-14-33><a class=lnlinks href=#hl-14-33>33</a>
</span><span class=lnt id=hl-14-34><a class=lnlinks href=#hl-14-34>34</a>
</span><span class=lnt id=hl-14-35><a class=lnlinks href=#hl-14-35>35</a>
</span><span class=lnt id=hl-14-36><a class=lnlinks href=#hl-14-36>36</a>
</span><span class=lnt id=hl-14-37><a class=lnlinks href=#hl-14-37>37</a>
</span><span class=lnt id=hl-14-38><a class=lnlinks href=#hl-14-38>38</a>
</span><span class=lnt id=hl-14-39><a class=lnlinks href=#hl-14-39>39</a>
</span><span class=lnt id=hl-14-40><a class=lnlinks href=#hl-14-40>40</a>
</span><span class=lnt id=hl-14-41><a class=lnlinks href=#hl-14-41>41</a>
</span><span class=lnt id=hl-14-42><a class=lnlinks href=#hl-14-42>42</a>
</span><span class=lnt id=hl-14-43><a class=lnlinks href=#hl-14-43>43</a>
</span><span class=lnt id=hl-14-44><a class=lnlinks href=#hl-14-44>44</a>
</span><span class=lnt id=hl-14-45><a class=lnlinks href=#hl-14-45>45</a>
</span><span class=lnt id=hl-14-46><a class=lnlinks href=#hl-14-46>46</a>
</span><span class=lnt id=hl-14-47><a class=lnlinks href=#hl-14-47>47</a>
</span><span class=lnt id=hl-14-48><a class=lnlinks href=#hl-14-48>48</a>
</span><span class=lnt id=hl-14-49><a class=lnlinks href=#hl-14-49>49</a>
</span><span class=lnt id=hl-14-50><a class=lnlinks href=#hl-14-50>50</a>
</span><span class=lnt id=hl-14-51><a class=lnlinks href=#hl-14-51>51</a>
</span><span class=lnt id=hl-14-52><a class=lnlinks href=#hl-14-52>52</a>
</span><span class=lnt id=hl-14-53><a class=lnlinks href=#hl-14-53>53</a>
</span><span class=lnt id=hl-14-54><a class=lnlinks href=#hl-14-54>54</a>
</span><span class=lnt id=hl-14-55><a class=lnlinks href=#hl-14-55>55</a>
</span><span class=lnt id=hl-14-56><a class=lnlinks href=#hl-14-56>56</a>
</span><span class=lnt id=hl-14-57><a class=lnlinks href=#hl-14-57>57</a>
</span><span class=lnt id=hl-14-58><a class=lnlinks href=#hl-14-58>58</a>
</span><span class=lnt id=hl-14-59><a class=lnlinks href=#hl-14-59>59</a>
</span><span class=lnt id=hl-14-60><a class=lnlinks href=#hl-14-60>60</a>
</span><span class=lnt id=hl-14-61><a class=lnlinks href=#hl-14-61>61</a>
</span><span class=lnt id=hl-14-62><a class=lnlinks href=#hl-14-62>62</a>
</span><span class=lnt id=hl-14-63><a class=lnlinks href=#hl-14-63>63</a>
</span><span class=lnt id=hl-14-64><a class=lnlinks href=#hl-14-64>64</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># PostgreSQL 기반 이벤트 스토어 구현</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PostgreSQLEventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=n>connection</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>expected_version</span><span class=p>,</span> <span class=n>events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 append-only 방식으로 저장&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 낙관적 동시성 제어</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;SELECT version FROM aggregates WHERE id = </span><span class=si>%s</span><span class=s2> FOR UPDATE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>aggregate_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_version</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_version</span> <span class=ow>and</span> <span class=n>current_version</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=n>expected_version</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>ConcurrencyError</span><span class=p>(</span><span class=s2>&#34;Aggregate version mismatch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 이벤트 저장</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>event</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                    INSERT INTO events (aggregate_id, version, event_type, event_data, timestamp)
</span></span></span><span class=line><span class=cl><span class=s2>                    VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>expected_version</span> <span class=o>+</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>event</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 집계 버전 업데이트</span>
</span></span><span class=line><span class=cl>            <span class=n>new_version</span> <span class=o>=</span> <span class=n>expected_version</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                INSERT INTO aggregates (id, version) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)
</span></span></span><span class=line><span class=cl><span class=s2>                ON CONFLICT (id) DO UPDATE SET version = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>new_version</span><span class=p>,</span> <span class=n>new_version</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>from_version</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;집계의 이벤트 시퀀스 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            SELECT event_type, event_data, version, timestamp
</span></span></span><span class=line><span class=cl><span class=s2>            FROM events
</span></span></span><span class=line><span class=cl><span class=s2>            WHERE aggregate_id = </span><span class=si>%s</span><span class=s2> AND version &gt; </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>            ORDER BY version
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>from_version</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span><span class=p>,</span> <span class=n>event_data</span><span class=p>,</span> <span class=n>version</span><span class=p>,</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=n>row</span>
</span></span><span class=line><span class=cl>            <span class=c1># 이벤트 객체 재구성 (event_type을 통한 동적 생성)</span>
</span></span><span class=line><span class=cl>            <span class=n>event_class</span> <span class=o>=</span> <span class=nb>globals</span><span class=p>()[</span><span class=n>event_type</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>event_dict</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span> <span class=o>=</span> <span class=n>event_class</span><span class=p>(</span><span class=o>**</span><span class=n>event_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>events</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-프로젝션-구현-기법>3. 프로젝션 구현 기법<a hidden class=anchor aria-hidden=true href=#3-프로젝션-구현-기법>#</a></h4><p><strong>정의</strong>: 이벤트로부터 읽기 최적화된 뷰를 생성하는 방법</p><p><strong>구성</strong>:</p><ul><li>이벤트 핸들러: 특정 이벤트 타입을 처리하는 핸들러</li><li>상태 빌더: 이벤트 시퀀스로부터 집계 상태 구성</li><li>뷰 업데이트: 읽기 모델 데이터베이스 갱신</li></ul><p><strong>목적</strong>: 쿼리 성능 최적화와 다양한 읽기 모델 지원</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a class=lnlinks href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a class=lnlinks href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a class=lnlinks href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a class=lnlinks href=#hl-15-15>15</a>
</span><span class=lnt id=hl-15-16><a class=lnlinks href=#hl-15-16>16</a>
</span><span class=lnt id=hl-15-17><a class=lnlinks href=#hl-15-17>17</a>
</span><span class=lnt id=hl-15-18><a class=lnlinks href=#hl-15-18>18</a>
</span><span class=lnt id=hl-15-19><a class=lnlinks href=#hl-15-19>19</a>
</span><span class=lnt id=hl-15-20><a class=lnlinks href=#hl-15-20>20</a>
</span><span class=lnt id=hl-15-21><a class=lnlinks href=#hl-15-21>21</a>
</span><span class=lnt id=hl-15-22><a class=lnlinks href=#hl-15-22>22</a>
</span><span class=lnt id=hl-15-23><a class=lnlinks href=#hl-15-23>23</a>
</span><span class=lnt id=hl-15-24><a class=lnlinks href=#hl-15-24>24</a>
</span><span class=lnt id=hl-15-25><a class=lnlinks href=#hl-15-25>25</a>
</span><span class=lnt id=hl-15-26><a class=lnlinks href=#hl-15-26>26</a>
</span><span class=lnt id=hl-15-27><a class=lnlinks href=#hl-15-27>27</a>
</span><span class=lnt id=hl-15-28><a class=lnlinks href=#hl-15-28>28</a>
</span><span class=lnt id=hl-15-29><a class=lnlinks href=#hl-15-29>29</a>
</span><span class=lnt id=hl-15-30><a class=lnlinks href=#hl-15-30>30</a>
</span><span class=lnt id=hl-15-31><a class=lnlinks href=#hl-15-31>31</a>
</span><span class=lnt id=hl-15-32><a class=lnlinks href=#hl-15-32>32</a>
</span><span class=lnt id=hl-15-33><a class=lnlinks href=#hl-15-33>33</a>
</span><span class=lnt id=hl-15-34><a class=lnlinks href=#hl-15-34>34</a>
</span><span class=lnt id=hl-15-35><a class=lnlinks href=#hl-15-35>35</a>
</span><span class=lnt id=hl-15-36><a class=lnlinks href=#hl-15-36>36</a>
</span><span class=lnt id=hl-15-37><a class=lnlinks href=#hl-15-37>37</a>
</span><span class=lnt id=hl-15-38><a class=lnlinks href=#hl-15-38>38</a>
</span><span class=lnt id=hl-15-39><a class=lnlinks href=#hl-15-39>39</a>
</span><span class=lnt id=hl-15-40><a class=lnlinks href=#hl-15-40>40</a>
</span><span class=lnt id=hl-15-41><a class=lnlinks href=#hl-15-41>41</a>
</span><span class=lnt id=hl-15-42><a class=lnlinks href=#hl-15-42>42</a>
</span><span class=lnt id=hl-15-43><a class=lnlinks href=#hl-15-43>43</a>
</span><span class=lnt id=hl-15-44><a class=lnlinks href=#hl-15-44>44</a>
</span><span class=lnt id=hl-15-45><a class=lnlinks href=#hl-15-45>45</a>
</span><span class=lnt id=hl-15-46><a class=lnlinks href=#hl-15-46>46</a>
</span><span class=lnt id=hl-15-47><a class=lnlinks href=#hl-15-47>47</a>
</span><span class=lnt id=hl-15-48><a class=lnlinks href=#hl-15-48>48</a>
</span><span class=lnt id=hl-15-49><a class=lnlinks href=#hl-15-49>49</a>
</span><span class=lnt id=hl-15-50><a class=lnlinks href=#hl-15-50>50</a>
</span><span class=lnt id=hl-15-51><a class=lnlinks href=#hl-15-51>51</a>
</span><span class=lnt id=hl-15-52><a class=lnlinks href=#hl-15-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 주문 프로젝션 구현</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderProjection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>read_db</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>read_db</span> <span class=o>=</span> <span class=n>read_db</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_handlers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;OrderPlaced&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_order_placed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;OrderShipped&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_order_shipped</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;OrderCancelled&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_order_cancelled</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트 타입에 따른 적절한 핸들러 호출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_handlers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>handler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>handler</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_placed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 이벤트 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>read_db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            INSERT INTO order_summary (
</span></span></span><span class=line><span class=cl><span class=s2>                order_id, user_id, status, total_amount, created_at
</span></span></span><span class=line><span class=cl><span class=s2>            ) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PLACED&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>total_amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 주문 항목 저장</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>read_db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                INSERT INTO order_items (order_id, product_id, quantity, price)
</span></span></span><span class=line><span class=cl><span class=s2>                VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>item</span><span class=o>.</span><span class=n>product_id</span><span class=p>,</span> <span class=n>item</span><span class=o>.</span><span class=n>quantity</span><span class=p>,</span> <span class=n>item</span><span class=o>.</span><span class=n>price</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_shipped</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 배송 이벤트 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>read_db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            UPDATE order_summary 
</span></span></span><span class=line><span class=cl><span class=s2>            SET status = &#39;SHIPPED&#39;, tracking_number = </span><span class=si>%s</span><span class=s2>, shipped_at = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>            WHERE order_id = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>tracking_number</span><span class=p>,</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_cancelled</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 취소 이벤트 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>read_db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            UPDATE order_summary 
</span></span></span><span class=line><span class=cl><span class=s2>            SET status = &#39;CANCELLED&#39;, cancelled_at = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>            WHERE order_id = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=4-스냅샷-구현-기법>4. 스냅샷 구현 기법<a hidden class=anchor aria-hidden=true href=#4-스냅샷-구현-기법>#</a></h4><p><strong>정의</strong>: 성능 최적화를 위해 특정 시점의 집계 상태를 저장하는 방법</p><p><strong>구성</strong>:</p><ul><li>스냅샷 정책: 스냅샷 생성 시점과 빈도 결정</li><li>스냅샷 저장: 집계 상태의 직렬화된 형태 저장</li><li>스냅샷 로딩: 스냅샷 기반 빠른 상태 복원</li></ul><p><strong>목적</strong>: 대량 이벤트 재생으로 인한 성능 문제 해결</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19>19</a>
</span><span class=lnt id=hl-16-20><a class=lnlinks href=#hl-16-20>20</a>
</span><span class=lnt id=hl-16-21><a class=lnlinks href=#hl-16-21>21</a>
</span><span class=lnt id=hl-16-22><a class=lnlinks href=#hl-16-22>22</a>
</span><span class=lnt id=hl-16-23><a class=lnlinks href=#hl-16-23>23</a>
</span><span class=lnt id=hl-16-24><a class=lnlinks href=#hl-16-24>24</a>
</span><span class=lnt id=hl-16-25><a class=lnlinks href=#hl-16-25>25</a>
</span><span class=lnt id=hl-16-26><a class=lnlinks href=#hl-16-26>26</a>
</span><span class=lnt id=hl-16-27><a class=lnlinks href=#hl-16-27>27</a>
</span><span class=lnt id=hl-16-28><a class=lnlinks href=#hl-16-28>28</a>
</span><span class=lnt id=hl-16-29><a class=lnlinks href=#hl-16-29>29</a>
</span><span class=lnt id=hl-16-30><a class=lnlinks href=#hl-16-30>30</a>
</span><span class=lnt id=hl-16-31><a class=lnlinks href=#hl-16-31>31</a>
</span><span class=lnt id=hl-16-32><a class=lnlinks href=#hl-16-32>32</a>
</span><span class=lnt id=hl-16-33><a class=lnlinks href=#hl-16-33>33</a>
</span><span class=lnt id=hl-16-34><a class=lnlinks href=#hl-16-34>34</a>
</span><span class=lnt id=hl-16-35><a class=lnlinks href=#hl-16-35>35</a>
</span><span class=lnt id=hl-16-36><a class=lnlinks href=#hl-16-36>36</a>
</span><span class=lnt id=hl-16-37><a class=lnlinks href=#hl-16-37>37</a>
</span><span class=lnt id=hl-16-38><a class=lnlinks href=#hl-16-38>38</a>
</span><span class=lnt id=hl-16-39><a class=lnlinks href=#hl-16-39>39</a>
</span><span class=lnt id=hl-16-40><a class=lnlinks href=#hl-16-40>40</a>
</span><span class=lnt id=hl-16-41><a class=lnlinks href=#hl-16-41>41</a>
</span><span class=lnt id=hl-16-42><a class=lnlinks href=#hl-16-42>42</a>
</span><span class=lnt id=hl-16-43><a class=lnlinks href=#hl-16-43>43</a>
</span><span class=lnt id=hl-16-44><a class=lnlinks href=#hl-16-44>44</a>
</span><span class=lnt id=hl-16-45><a class=lnlinks href=#hl-16-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 스냅샷 기반 집계 로딩</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SnapshotRepository</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>,</span> <span class=n>event_store</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span> <span class=o>=</span> <span class=n>snapshot_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_aggregate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;스냅샷과 이후 이벤트를 결합하여 집계 로딩&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 최신 스냅샷 로드</span>
</span></span><span class=line><span class=cl>        <span class=n>snapshot</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span><span class=o>.</span><span class=n>get_latest_snapshot</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>snapshot</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>deserialize_aggregate</span><span class=p>(</span><span class=n>snapshot</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>from_version</span> <span class=o>=</span> <span class=n>snapshot</span><span class=o>.</span><span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>)</span>  <span class=c1># 새 집계 생성</span>
</span></span><span class=line><span class=cl>            <span class=n>from_version</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 스냅샷 이후 이벤트 적용</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>from_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span><span class=o>.</span><span class=n>apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>aggregate</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_aggregate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;집계 저장 및 스냅샷 생성 결정&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 새 이벤트 저장</span>
</span></span><span class=line><span class=cl>        <span class=n>new_events</span> <span class=o>=</span> <span class=n>aggregate</span><span class=o>.</span><span class=n>get_uncommitted_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>append_events</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span><span class=o>.</span><span class=n>version</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>new_events</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>new_events</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 스냅샷 생성 조건 확인 (예: 100개 이벤트마다)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>aggregate</span><span class=o>.</span><span class=n>version</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>snapshot_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>serialize_aggregate</span><span class=p>(</span><span class=n>aggregate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span><span class=o>.</span><span class=n>save_snapshot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>aggregate</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>aggregate</span><span class=o>.</span><span class=n>version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>snapshot_data</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>aggregate</span><span class=o>.</span><span class=n>mark_events_as_committed</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=분류-기준에-따른-유형-구분-1>분류 기준에 따른 유형 구분<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-유형-구분-1>#</a></h3><table><thead><tr><th>분류 기준</th><th>유형</th><th>설명</th><th>적용 사례</th><th>장점</th><th>단점</th></tr></thead><tbody><tr><td><strong>저장 방식</strong></td><td><strong>단일 스트림</strong></td><td>모든 이벤트를 하나의 글로벌 스트림에 저장</td><td>간단한 도메인, 이벤트 순서가 중요한 시스템</td><td>구현 단순, 전역 순서 보장</td><td>확장성 제한, 동시성 문제</td></tr><tr><td></td><td><strong>집계별 스트림</strong></td><td>집계(Aggregate) 단위로 별도 스트림 관리</td><td>마이크로서비스, 복잡한 도메인</td><td>높은 동시성, 독립적 확장</td><td>글로벌 순서 보장 어려움</td></tr><tr><td><strong>일관성 모델</strong></td><td><strong>강한 일관성</strong></td><td>동기식 프로젝션 업데이트</td><td>금융 거래, 재고 관리</td><td>즉시 일관성, 단순한 에러 처리</td><td>성능 저하, 가용성 제한</td></tr><tr><td></td><td><strong>최종 일관성</strong></td><td>비동기식 프로젝션 업데이트</td><td>소셜 미디어, 콘텐츠 관리</td><td>높은 성능, 높은 가용성</td><td>복잡한 에러 처리, 일시적 불일치</td></tr><tr><td><strong>기술 스택</strong></td><td><strong>관계형 DB</strong></td><td>PostgreSQL, MySQL 등 활용</td><td>기존 인프라 활용, 중소 규모</td><td>기존 운영 노하우 활용, 트랜잭션 지원</td><td>확장성 제한, 스키마 경직성</td></tr><tr><td></td><td><strong>NoSQL DB</strong></td><td>MongoDB, Cassandra 등 활용</td><td>대규모 분산 시스템</td><td>높은 확장성, 유연한 스키마</td><td>일관성 모델 복잡, 새로운 운영 지식 필요</td></tr><tr><td></td><td><strong>전용 Event Store</strong></td><td>EventStore, Apache Kafka 활용</td><td>이벤트 중심 아키텍처</td><td>최적화된 성능, 풍부한 기능</td><td>새로운 기술 스택, 운영 복잡성</td></tr><tr><td><strong>도메인 적용 범위</strong></td><td><strong>전체 시스템</strong></td><td>시스템 전체를 이벤트 소싱으로 구축</td><td>새로운 프로젝트, 이벤트 중심 도메인</td><td>일관된 아키텍처, 최대 이익</td><td>높은 복잡성, 큰 변화</td></tr><tr><td></td><td><strong>부분 적용</strong></td><td>특정 도메인만 이벤트 소싱 적용</td><td>기존 시스템 확장, 점진적 도입</td><td>점진적 도입, 위험 최소화</td><td>하이브리드 복잡성, 제한적 이익</td></tr></tbody></table><hr><h2 id=phase-5-실무-적용-practical-application>Phase 5: 실무 적용 (Practical Application)<a hidden class=anchor aria-hidden=true href=#phase-5-실무-적용-practical-application>#</a></h2><h3 id=실제-도입-사례-1>실제 도입 사례<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-1>#</a></h3><h4 id=1-netflix의-분산-카운터-시스템>1. Netflix의 분산 카운터 시스템<a hidden class=anchor aria-hidden=true href=#1-netflix의-분산-카운터-시스템>#</a></h4><p><strong>조합 기술</strong>: Apache Kafka + Cassandra + 마이크로서비스
<strong>효과 분석</strong>:</p><ul><li>수십억 개의 이벤트 실시간 처리</li><li>99.99% 가용성 달성</li><li>지연 시간 10ms 이하 유지</li></ul><h4 id=2-은행의-거래-처리-시스템>2. 은행의 거래 처리 시스템<a hidden class=anchor aria-hidden=true href=#2-은행의-거래-처리-시스템>#</a></h4><p><strong>조합 기술</strong>: EventStore + .NET Core + SQL Server
<strong>효과 분석</strong>:</p><ul><li>100% 감사 추적 능력 확보</li><li>규제 요구사항 완벽 준수</li><li>사기 탐지 정확도 40% 향상</li></ul><h4 id=3-전자상거래의-주문-관리-시스템>3. 전자상거래의 주문 관리 시스템<a hidden class=anchor aria-hidden=true href=#3-전자상거래의-주문-관리-시스템>#</a></h4><p><strong>조합 기술</strong>: Kafka + Spring Boot + MongoDB
<strong>효과 분석</strong>:</p><ul><li>주문 처리 성능 3배 향상</li><li>재고 일관성 문제 90% 감소</li><li>새로운 기능 개발 시간 50% 단축</li></ul><h3 id=실습-예제-및-코드-구현-1>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현-1>#</a></h3><p><strong>시나리오</strong>: 온라인 쇼핑몰의 주문 관리 시스템
<strong>시스템 구성</strong>:</p><ul><li>Command Handler (주문 처리)</li><li>Event Store (PostgreSQL)</li><li>Projection Engine (주문 요약 뷰)</li><li>Event Bus (Redis Pub/Sub)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    A[웹 애플리케이션] --&gt; B[Order Command Handler]
    B --&gt; C[Order Aggregate]
    C --&gt; D[PostgreSQL Event Store]
    D --&gt; E[Redis Event Bus]
    E --&gt; F[Order Projection Handler]
    F --&gt; G[MongoDB Read Model]
    
    H[조회 API] --&gt; I[Query Handler]
    I --&gt; G
    
    D -.-&gt;|Event Replay| J[State Reconstruction]
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 주문 생성 요청</li><li>Command Handler가 비즈니스 로직 검증</li><li>Order Aggregate에서 OrderPlaced 이벤트 생성</li><li>Event Store에 이벤트 저장</li><li>Event Bus를 통해 이벤트 발행</li><li>Projection Handler가 읽기 모델 업데이트</li><li>조회 API가 최적화된 뷰 제공</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>주문 상태의 모든 변경사항을 이벤트로 추적</li><li>읽기와 쓰기 성능을 독립적으로 최적화</li><li>감사 추적과 디버깅 지원</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 주문 상태 변경 시 기존 데이터 덮어쓰기, 변경 이력 추적 불가</li><li><strong>도입 후</strong>: 모든 변경사항 보존, 시점별 상태 복원, 완벽한 감사 추적</li></ul><p><strong>구현 예시</strong> (Python):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>  1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>  2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>  3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>  4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>  5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6>  6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7>  7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8>  8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9>  9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10> 10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11> 11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12> 12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13> 13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14> 14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15> 15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16> 16</a>
</span><span class=lnt id=hl-18-17><a class=lnlinks href=#hl-18-17> 17</a>
</span><span class=lnt id=hl-18-18><a class=lnlinks href=#hl-18-18> 18</a>
</span><span class=lnt id=hl-18-19><a class=lnlinks href=#hl-18-19> 19</a>
</span><span class=lnt id=hl-18-20><a class=lnlinks href=#hl-18-20> 20</a>
</span><span class=lnt id=hl-18-21><a class=lnlinks href=#hl-18-21> 21</a>
</span><span class=lnt id=hl-18-22><a class=lnlinks href=#hl-18-22> 22</a>
</span><span class=lnt id=hl-18-23><a class=lnlinks href=#hl-18-23> 23</a>
</span><span class=lnt id=hl-18-24><a class=lnlinks href=#hl-18-24> 24</a>
</span><span class=lnt id=hl-18-25><a class=lnlinks href=#hl-18-25> 25</a>
</span><span class=lnt id=hl-18-26><a class=lnlinks href=#hl-18-26> 26</a>
</span><span class=lnt id=hl-18-27><a class=lnlinks href=#hl-18-27> 27</a>
</span><span class=lnt id=hl-18-28><a class=lnlinks href=#hl-18-28> 28</a>
</span><span class=lnt id=hl-18-29><a class=lnlinks href=#hl-18-29> 29</a>
</span><span class=lnt id=hl-18-30><a class=lnlinks href=#hl-18-30> 30</a>
</span><span class=lnt id=hl-18-31><a class=lnlinks href=#hl-18-31> 31</a>
</span><span class=lnt id=hl-18-32><a class=lnlinks href=#hl-18-32> 32</a>
</span><span class=lnt id=hl-18-33><a class=lnlinks href=#hl-18-33> 33</a>
</span><span class=lnt id=hl-18-34><a class=lnlinks href=#hl-18-34> 34</a>
</span><span class=lnt id=hl-18-35><a class=lnlinks href=#hl-18-35> 35</a>
</span><span class=lnt id=hl-18-36><a class=lnlinks href=#hl-18-36> 36</a>
</span><span class=lnt id=hl-18-37><a class=lnlinks href=#hl-18-37> 37</a>
</span><span class=lnt id=hl-18-38><a class=lnlinks href=#hl-18-38> 38</a>
</span><span class=lnt id=hl-18-39><a class=lnlinks href=#hl-18-39> 39</a>
</span><span class=lnt id=hl-18-40><a class=lnlinks href=#hl-18-40> 40</a>
</span><span class=lnt id=hl-18-41><a class=lnlinks href=#hl-18-41> 41</a>
</span><span class=lnt id=hl-18-42><a class=lnlinks href=#hl-18-42> 42</a>
</span><span class=lnt id=hl-18-43><a class=lnlinks href=#hl-18-43> 43</a>
</span><span class=lnt id=hl-18-44><a class=lnlinks href=#hl-18-44> 44</a>
</span><span class=lnt id=hl-18-45><a class=lnlinks href=#hl-18-45> 45</a>
</span><span class=lnt id=hl-18-46><a class=lnlinks href=#hl-18-46> 46</a>
</span><span class=lnt id=hl-18-47><a class=lnlinks href=#hl-18-47> 47</a>
</span><span class=lnt id=hl-18-48><a class=lnlinks href=#hl-18-48> 48</a>
</span><span class=lnt id=hl-18-49><a class=lnlinks href=#hl-18-49> 49</a>
</span><span class=lnt id=hl-18-50><a class=lnlinks href=#hl-18-50> 50</a>
</span><span class=lnt id=hl-18-51><a class=lnlinks href=#hl-18-51> 51</a>
</span><span class=lnt id=hl-18-52><a class=lnlinks href=#hl-18-52> 52</a>
</span><span class=lnt id=hl-18-53><a class=lnlinks href=#hl-18-53> 53</a>
</span><span class=lnt id=hl-18-54><a class=lnlinks href=#hl-18-54> 54</a>
</span><span class=lnt id=hl-18-55><a class=lnlinks href=#hl-18-55> 55</a>
</span><span class=lnt id=hl-18-56><a class=lnlinks href=#hl-18-56> 56</a>
</span><span class=lnt id=hl-18-57><a class=lnlinks href=#hl-18-57> 57</a>
</span><span class=lnt id=hl-18-58><a class=lnlinks href=#hl-18-58> 58</a>
</span><span class=lnt id=hl-18-59><a class=lnlinks href=#hl-18-59> 59</a>
</span><span class=lnt id=hl-18-60><a class=lnlinks href=#hl-18-60> 60</a>
</span><span class=lnt id=hl-18-61><a class=lnlinks href=#hl-18-61> 61</a>
</span><span class=lnt id=hl-18-62><a class=lnlinks href=#hl-18-62> 62</a>
</span><span class=lnt id=hl-18-63><a class=lnlinks href=#hl-18-63> 63</a>
</span><span class=lnt id=hl-18-64><a class=lnlinks href=#hl-18-64> 64</a>
</span><span class=lnt id=hl-18-65><a class=lnlinks href=#hl-18-65> 65</a>
</span><span class=lnt id=hl-18-66><a class=lnlinks href=#hl-18-66> 66</a>
</span><span class=lnt id=hl-18-67><a class=lnlinks href=#hl-18-67> 67</a>
</span><span class=lnt id=hl-18-68><a class=lnlinks href=#hl-18-68> 68</a>
</span><span class=lnt id=hl-18-69><a class=lnlinks href=#hl-18-69> 69</a>
</span><span class=lnt id=hl-18-70><a class=lnlinks href=#hl-18-70> 70</a>
</span><span class=lnt id=hl-18-71><a class=lnlinks href=#hl-18-71> 71</a>
</span><span class=lnt id=hl-18-72><a class=lnlinks href=#hl-18-72> 72</a>
</span><span class=lnt id=hl-18-73><a class=lnlinks href=#hl-18-73> 73</a>
</span><span class=lnt id=hl-18-74><a class=lnlinks href=#hl-18-74> 74</a>
</span><span class=lnt id=hl-18-75><a class=lnlinks href=#hl-18-75> 75</a>
</span><span class=lnt id=hl-18-76><a class=lnlinks href=#hl-18-76> 76</a>
</span><span class=lnt id=hl-18-77><a class=lnlinks href=#hl-18-77> 77</a>
</span><span class=lnt id=hl-18-78><a class=lnlinks href=#hl-18-78> 78</a>
</span><span class=lnt id=hl-18-79><a class=lnlinks href=#hl-18-79> 79</a>
</span><span class=lnt id=hl-18-80><a class=lnlinks href=#hl-18-80> 80</a>
</span><span class=lnt id=hl-18-81><a class=lnlinks href=#hl-18-81> 81</a>
</span><span class=lnt id=hl-18-82><a class=lnlinks href=#hl-18-82> 82</a>
</span><span class=lnt id=hl-18-83><a class=lnlinks href=#hl-18-83> 83</a>
</span><span class=lnt id=hl-18-84><a class=lnlinks href=#hl-18-84> 84</a>
</span><span class=lnt id=hl-18-85><a class=lnlinks href=#hl-18-85> 85</a>
</span><span class=lnt id=hl-18-86><a class=lnlinks href=#hl-18-86> 86</a>
</span><span class=lnt id=hl-18-87><a class=lnlinks href=#hl-18-87> 87</a>
</span><span class=lnt id=hl-18-88><a class=lnlinks href=#hl-18-88> 88</a>
</span><span class=lnt id=hl-18-89><a class=lnlinks href=#hl-18-89> 89</a>
</span><span class=lnt id=hl-18-90><a class=lnlinks href=#hl-18-90> 90</a>
</span><span class=lnt id=hl-18-91><a class=lnlinks href=#hl-18-91> 91</a>
</span><span class=lnt id=hl-18-92><a class=lnlinks href=#hl-18-92> 92</a>
</span><span class=lnt id=hl-18-93><a class=lnlinks href=#hl-18-93> 93</a>
</span><span class=lnt id=hl-18-94><a class=lnlinks href=#hl-18-94> 94</a>
</span><span class=lnt id=hl-18-95><a class=lnlinks href=#hl-18-95> 95</a>
</span><span class=lnt id=hl-18-96><a class=lnlinks href=#hl-18-96> 96</a>
</span><span class=lnt id=hl-18-97><a class=lnlinks href=#hl-18-97> 97</a>
</span><span class=lnt id=hl-18-98><a class=lnlinks href=#hl-18-98> 98</a>
</span><span class=lnt id=hl-18-99><a class=lnlinks href=#hl-18-99> 99</a>
</span><span class=lnt id=hl-18-100><a class=lnlinks href=#hl-18-100>100</a>
</span><span class=lnt id=hl-18-101><a class=lnlinks href=#hl-18-101>101</a>
</span><span class=lnt id=hl-18-102><a class=lnlinks href=#hl-18-102>102</a>
</span><span class=lnt id=hl-18-103><a class=lnlinks href=#hl-18-103>103</a>
</span><span class=lnt id=hl-18-104><a class=lnlinks href=#hl-18-104>104</a>
</span><span class=lnt id=hl-18-105><a class=lnlinks href=#hl-18-105>105</a>
</span><span class=lnt id=hl-18-106><a class=lnlinks href=#hl-18-106>106</a>
</span><span class=lnt id=hl-18-107><a class=lnlinks href=#hl-18-107>107</a>
</span><span class=lnt id=hl-18-108><a class=lnlinks href=#hl-18-108>108</a>
</span><span class=lnt id=hl-18-109><a class=lnlinks href=#hl-18-109>109</a>
</span><span class=lnt id=hl-18-110><a class=lnlinks href=#hl-18-110>110</a>
</span><span class=lnt id=hl-18-111><a class=lnlinks href=#hl-18-111>111</a>
</span><span class=lnt id=hl-18-112><a class=lnlinks href=#hl-18-112>112</a>
</span><span class=lnt id=hl-18-113><a class=lnlinks href=#hl-18-113>113</a>
</span><span class=lnt id=hl-18-114><a class=lnlinks href=#hl-18-114>114</a>
</span><span class=lnt id=hl-18-115><a class=lnlinks href=#hl-18-115>115</a>
</span><span class=lnt id=hl-18-116><a class=lnlinks href=#hl-18-116>116</a>
</span><span class=lnt id=hl-18-117><a class=lnlinks href=#hl-18-117>117</a>
</span><span class=lnt id=hl-18-118><a class=lnlinks href=#hl-18-118>118</a>
</span><span class=lnt id=hl-18-119><a class=lnlinks href=#hl-18-119>119</a>
</span><span class=lnt id=hl-18-120><a class=lnlinks href=#hl-18-120>120</a>
</span><span class=lnt id=hl-18-121><a class=lnlinks href=#hl-18-121>121</a>
</span><span class=lnt id=hl-18-122><a class=lnlinks href=#hl-18-122>122</a>
</span><span class=lnt id=hl-18-123><a class=lnlinks href=#hl-18-123>123</a>
</span><span class=lnt id=hl-18-124><a class=lnlinks href=#hl-18-124>124</a>
</span><span class=lnt id=hl-18-125><a class=lnlinks href=#hl-18-125>125</a>
</span><span class=lnt id=hl-18-126><a class=lnlinks href=#hl-18-126>126</a>
</span><span class=lnt id=hl-18-127><a class=lnlinks href=#hl-18-127>127</a>
</span><span class=lnt id=hl-18-128><a class=lnlinks href=#hl-18-128>128</a>
</span><span class=lnt id=hl-18-129><a class=lnlinks href=#hl-18-129>129</a>
</span><span class=lnt id=hl-18-130><a class=lnlinks href=#hl-18-130>130</a>
</span><span class=lnt id=hl-18-131><a class=lnlinks href=#hl-18-131>131</a>
</span><span class=lnt id=hl-18-132><a class=lnlinks href=#hl-18-132>132</a>
</span><span class=lnt id=hl-18-133><a class=lnlinks href=#hl-18-133>133</a>
</span><span class=lnt id=hl-18-134><a class=lnlinks href=#hl-18-134>134</a>
</span><span class=lnt id=hl-18-135><a class=lnlinks href=#hl-18-135>135</a>
</span><span class=lnt id=hl-18-136><a class=lnlinks href=#hl-18-136>136</a>
</span><span class=lnt id=hl-18-137><a class=lnlinks href=#hl-18-137>137</a>
</span><span class=lnt id=hl-18-138><a class=lnlinks href=#hl-18-138>138</a>
</span><span class=lnt id=hl-18-139><a class=lnlinks href=#hl-18-139>139</a>
</span><span class=lnt id=hl-18-140><a class=lnlinks href=#hl-18-140>140</a>
</span><span class=lnt id=hl-18-141><a class=lnlinks href=#hl-18-141>141</a>
</span><span class=lnt id=hl-18-142><a class=lnlinks href=#hl-18-142>142</a>
</span><span class=lnt id=hl-18-143><a class=lnlinks href=#hl-18-143>143</a>
</span><span class=lnt id=hl-18-144><a class=lnlinks href=#hl-18-144>144</a>
</span><span class=lnt id=hl-18-145><a class=lnlinks href=#hl-18-145>145</a>
</span><span class=lnt id=hl-18-146><a class=lnlinks href=#hl-18-146>146</a>
</span><span class=lnt id=hl-18-147><a class=lnlinks href=#hl-18-147>147</a>
</span><span class=lnt id=hl-18-148><a class=lnlinks href=#hl-18-148>148</a>
</span><span class=lnt id=hl-18-149><a class=lnlinks href=#hl-18-149>149</a>
</span><span class=lnt id=hl-18-150><a class=lnlinks href=#hl-18-150>150</a>
</span><span class=lnt id=hl-18-151><a class=lnlinks href=#hl-18-151>151</a>
</span><span class=lnt id=hl-18-152><a class=lnlinks href=#hl-18-152>152</a>
</span><span class=lnt id=hl-18-153><a class=lnlinks href=#hl-18-153>153</a>
</span><span class=lnt id=hl-18-154><a class=lnlinks href=#hl-18-154>154</a>
</span><span class=lnt id=hl-18-155><a class=lnlinks href=#hl-18-155>155</a>
</span><span class=lnt id=hl-18-156><a class=lnlinks href=#hl-18-156>156</a>
</span><span class=lnt id=hl-18-157><a class=lnlinks href=#hl-18-157>157</a>
</span><span class=lnt id=hl-18-158><a class=lnlinks href=#hl-18-158>158</a>
</span><span class=lnt id=hl-18-159><a class=lnlinks href=#hl-18-159>159</a>
</span><span class=lnt id=hl-18-160><a class=lnlinks href=#hl-18-160>160</a>
</span><span class=lnt id=hl-18-161><a class=lnlinks href=#hl-18-161>161</a>
</span><span class=lnt id=hl-18-162><a class=lnlinks href=#hl-18-162>162</a>
</span><span class=lnt id=hl-18-163><a class=lnlinks href=#hl-18-163>163</a>
</span><span class=lnt id=hl-18-164><a class=lnlinks href=#hl-18-164>164</a>
</span><span class=lnt id=hl-18-165><a class=lnlinks href=#hl-18-165>165</a>
</span><span class=lnt id=hl-18-166><a class=lnlinks href=#hl-18-166>166</a>
</span><span class=lnt id=hl-18-167><a class=lnlinks href=#hl-18-167>167</a>
</span><span class=lnt id=hl-18-168><a class=lnlinks href=#hl-18-168>168</a>
</span><span class=lnt id=hl-18-169><a class=lnlinks href=#hl-18-169>169</a>
</span><span class=lnt id=hl-18-170><a class=lnlinks href=#hl-18-170>170</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 주문 집계 (Order Aggregate)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>order_id</span>  <span class=c1># 집계 식별자</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=mi>0</span>    <span class=c1># 낙관적 동시성 제어를 위한 버전</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total_amount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 저장되지 않은 이벤트 목록</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>place_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>items</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 비즈니스 로직&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Order already exists&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 비즈니스 규칙 검증</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>items</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>items</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Order must have at least one item&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>price</span> <span class=o>*</span> <span class=n>item</span><span class=o>.</span><span class=n>quantity</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 도메인 이벤트 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>OrderPlaced</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>items</span><span class=o>=</span><span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>total_amount</span><span class=o>=</span><span class=n>total</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 적용 및 미커밋 목록에 추가</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ship_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tracking_number</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 배송 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=s1>&#39;PLACED&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Cannot ship order in current status&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>OrderShipped</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tracking_number</span><span class=o>=</span><span class=n>tracking_number</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 집계에 적용하여 상태 변경&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderPlaced</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s1>&#39;PLACED&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>user_id</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>user_id</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>items</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>total_amount</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>total_amount</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderShipped</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s1>&#39;SHIPPED&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>tracking_number</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>tracking_number</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderCancelled</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s1>&#39;CANCELLED&#39;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_uncommitted_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;저장되지 않은 이벤트 목록 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mark_events_as_committed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트가 저장되었음을 표시&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Command Handler 구현</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderCommandHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>repository</span><span class=p>,</span> <span class=n>event_bus</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>repository</span> <span class=o>=</span> <span class=n>repository</span>  <span class=c1># Order Repository</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span> <span class=o>=</span> <span class=n>event_bus</span>    <span class=c1># Event Bus for publishing</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_place_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 명령 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 새로운 주문 집계 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 비즈니스 로직 실행</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>place_order</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span> <span class=n>command</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 집계 저장 (이벤트 저장소에 이벤트 저장)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>repository</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>get_uncommitted_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>mark_events_as_committed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span><span class=o>.</span><span class=n>id</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_ship_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 배송 명령 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 기존 주문 로드</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>repository</span><span class=o>.</span><span class=n>get_by_id</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 비즈니스 로직 실행</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>ship_order</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>tracking_number</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 변경사항 저장</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>repository</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>get_uncommitted_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>mark_events_as_committed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Repository 구현 (Event Store 인터페이스)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderRepository</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_by_id</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 ID로 집계 로드 (이벤트 재생)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Order </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order</span><span class=o>.</span><span class=n>apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;집계의 미커밋 이벤트를 저장&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>uncommitted_events</span> <span class=o>=</span> <span class=n>order</span><span class=o>.</span><span class=n>get_uncommitted_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uncommitted_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>expected_version</span> <span class=o>=</span> <span class=n>order</span><span class=o>.</span><span class=n>version</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>uncommitted_events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>append_events</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>expected_version</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>uncommitted_events</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Event Bus 구현 (Redis 기반)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RedisEventBus</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>publish</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 Redis 채널에 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;events.</span><span class=si>{</span><span class=n>event</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>event_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;event_type&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;aggregate_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=vm>__dict__</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;특정 이벤트 타입에 대한 핸들러 등록&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;events.</span><span class=si>{</span><span class=n>event_type</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>pubsub</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>pubsub</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>pubsub</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>pubsub</span><span class=o>.</span><span class=n>listen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>message</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;message&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>event_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>handler</span><span class=p>(</span><span class=n>event_data</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=실제-도입-사례의-코드-구현>실제 도입 사례의 코드 구현<a hidden class=anchor aria-hidden=true href=#실제-도입-사례의-코드-구현>#</a></h3><p><strong>시나리오</strong>: Netflix의 실시간 시청 데이터 처리 시스템
<strong>시스템 구성</strong>:</p><ul><li>Kafka Event Streams</li><li>Cassandra Event Store</li><li>실시간 집계 서비스</li><li>사용자 추천 엔진</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    A[Video Player] --&gt; B[Viewing Event Producer]
    B --&gt; C[Kafka Topics]
    C --&gt; D[Stream Processing]
    D --&gt; E[Cassandra Rollup Store]
    C --&gt; F[Real-time Analytics]
    F --&gt; G[Recommendation Engine]
    
    H[User Query] --&gt; I[Aggregation Service]
    I --&gt; E
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자 비디오 시청 이벤트 발생</li><li>Kafka로 실시간 스트리밍</li><li>스트림 처리를 통한 실시간 집계</li><li>Cassandra에 시간 윈도우별 롤업 데이터 저장</li><li>추천 엔진이 실시간 데이터 소비</li><li>사용자별 맞춤 추천 제공</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>초당 수백만 개의 시청 이벤트 처리</li><li>실시간 사용자 행동 분석</li><li>개인화된 콘텐츠 추천</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 배치 처리로 인한 24시간 지연, 부정확한 추천</li><li><strong>도입 후</strong>: 실시간 추천, 사용자 경험 개선, 시청률 20% 증가</li></ul><p><strong>구현 예시</strong> (Java + Kafka Streams):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>  1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>  2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>  3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>  4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5>  5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6>  6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7>  7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8>  8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9>  9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10> 10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11> 11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12> 12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13> 13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14> 14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15> 15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16> 16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17> 17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18> 18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19> 19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20> 20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21> 21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22> 22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23> 23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24> 24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25> 25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26> 26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27> 27</a>
</span><span class=lnt id=hl-20-28><a class=lnlinks href=#hl-20-28> 28</a>
</span><span class=lnt id=hl-20-29><a class=lnlinks href=#hl-20-29> 29</a>
</span><span class=lnt id=hl-20-30><a class=lnlinks href=#hl-20-30> 30</a>
</span><span class=lnt id=hl-20-31><a class=lnlinks href=#hl-20-31> 31</a>
</span><span class=lnt id=hl-20-32><a class=lnlinks href=#hl-20-32> 32</a>
</span><span class=lnt id=hl-20-33><a class=lnlinks href=#hl-20-33> 33</a>
</span><span class=lnt id=hl-20-34><a class=lnlinks href=#hl-20-34> 34</a>
</span><span class=lnt id=hl-20-35><a class=lnlinks href=#hl-20-35> 35</a>
</span><span class=lnt id=hl-20-36><a class=lnlinks href=#hl-20-36> 36</a>
</span><span class=lnt id=hl-20-37><a class=lnlinks href=#hl-20-37> 37</a>
</span><span class=lnt id=hl-20-38><a class=lnlinks href=#hl-20-38> 38</a>
</span><span class=lnt id=hl-20-39><a class=lnlinks href=#hl-20-39> 39</a>
</span><span class=lnt id=hl-20-40><a class=lnlinks href=#hl-20-40> 40</a>
</span><span class=lnt id=hl-20-41><a class=lnlinks href=#hl-20-41> 41</a>
</span><span class=lnt id=hl-20-42><a class=lnlinks href=#hl-20-42> 42</a>
</span><span class=lnt id=hl-20-43><a class=lnlinks href=#hl-20-43> 43</a>
</span><span class=lnt id=hl-20-44><a class=lnlinks href=#hl-20-44> 44</a>
</span><span class=lnt id=hl-20-45><a class=lnlinks href=#hl-20-45> 45</a>
</span><span class=lnt id=hl-20-46><a class=lnlinks href=#hl-20-46> 46</a>
</span><span class=lnt id=hl-20-47><a class=lnlinks href=#hl-20-47> 47</a>
</span><span class=lnt id=hl-20-48><a class=lnlinks href=#hl-20-48> 48</a>
</span><span class=lnt id=hl-20-49><a class=lnlinks href=#hl-20-49> 49</a>
</span><span class=lnt id=hl-20-50><a class=lnlinks href=#hl-20-50> 50</a>
</span><span class=lnt id=hl-20-51><a class=lnlinks href=#hl-20-51> 51</a>
</span><span class=lnt id=hl-20-52><a class=lnlinks href=#hl-20-52> 52</a>
</span><span class=lnt id=hl-20-53><a class=lnlinks href=#hl-20-53> 53</a>
</span><span class=lnt id=hl-20-54><a class=lnlinks href=#hl-20-54> 54</a>
</span><span class=lnt id=hl-20-55><a class=lnlinks href=#hl-20-55> 55</a>
</span><span class=lnt id=hl-20-56><a class=lnlinks href=#hl-20-56> 56</a>
</span><span class=lnt id=hl-20-57><a class=lnlinks href=#hl-20-57> 57</a>
</span><span class=lnt id=hl-20-58><a class=lnlinks href=#hl-20-58> 58</a>
</span><span class=lnt id=hl-20-59><a class=lnlinks href=#hl-20-59> 59</a>
</span><span class=lnt id=hl-20-60><a class=lnlinks href=#hl-20-60> 60</a>
</span><span class=lnt id=hl-20-61><a class=lnlinks href=#hl-20-61> 61</a>
</span><span class=lnt id=hl-20-62><a class=lnlinks href=#hl-20-62> 62</a>
</span><span class=lnt id=hl-20-63><a class=lnlinks href=#hl-20-63> 63</a>
</span><span class=lnt id=hl-20-64><a class=lnlinks href=#hl-20-64> 64</a>
</span><span class=lnt id=hl-20-65><a class=lnlinks href=#hl-20-65> 65</a>
</span><span class=lnt id=hl-20-66><a class=lnlinks href=#hl-20-66> 66</a>
</span><span class=lnt id=hl-20-67><a class=lnlinks href=#hl-20-67> 67</a>
</span><span class=lnt id=hl-20-68><a class=lnlinks href=#hl-20-68> 68</a>
</span><span class=lnt id=hl-20-69><a class=lnlinks href=#hl-20-69> 69</a>
</span><span class=lnt id=hl-20-70><a class=lnlinks href=#hl-20-70> 70</a>
</span><span class=lnt id=hl-20-71><a class=lnlinks href=#hl-20-71> 71</a>
</span><span class=lnt id=hl-20-72><a class=lnlinks href=#hl-20-72> 72</a>
</span><span class=lnt id=hl-20-73><a class=lnlinks href=#hl-20-73> 73</a>
</span><span class=lnt id=hl-20-74><a class=lnlinks href=#hl-20-74> 74</a>
</span><span class=lnt id=hl-20-75><a class=lnlinks href=#hl-20-75> 75</a>
</span><span class=lnt id=hl-20-76><a class=lnlinks href=#hl-20-76> 76</a>
</span><span class=lnt id=hl-20-77><a class=lnlinks href=#hl-20-77> 77</a>
</span><span class=lnt id=hl-20-78><a class=lnlinks href=#hl-20-78> 78</a>
</span><span class=lnt id=hl-20-79><a class=lnlinks href=#hl-20-79> 79</a>
</span><span class=lnt id=hl-20-80><a class=lnlinks href=#hl-20-80> 80</a>
</span><span class=lnt id=hl-20-81><a class=lnlinks href=#hl-20-81> 81</a>
</span><span class=lnt id=hl-20-82><a class=lnlinks href=#hl-20-82> 82</a>
</span><span class=lnt id=hl-20-83><a class=lnlinks href=#hl-20-83> 83</a>
</span><span class=lnt id=hl-20-84><a class=lnlinks href=#hl-20-84> 84</a>
</span><span class=lnt id=hl-20-85><a class=lnlinks href=#hl-20-85> 85</a>
</span><span class=lnt id=hl-20-86><a class=lnlinks href=#hl-20-86> 86</a>
</span><span class=lnt id=hl-20-87><a class=lnlinks href=#hl-20-87> 87</a>
</span><span class=lnt id=hl-20-88><a class=lnlinks href=#hl-20-88> 88</a>
</span><span class=lnt id=hl-20-89><a class=lnlinks href=#hl-20-89> 89</a>
</span><span class=lnt id=hl-20-90><a class=lnlinks href=#hl-20-90> 90</a>
</span><span class=lnt id=hl-20-91><a class=lnlinks href=#hl-20-91> 91</a>
</span><span class=lnt id=hl-20-92><a class=lnlinks href=#hl-20-92> 92</a>
</span><span class=lnt id=hl-20-93><a class=lnlinks href=#hl-20-93> 93</a>
</span><span class=lnt id=hl-20-94><a class=lnlinks href=#hl-20-94> 94</a>
</span><span class=lnt id=hl-20-95><a class=lnlinks href=#hl-20-95> 95</a>
</span><span class=lnt id=hl-20-96><a class=lnlinks href=#hl-20-96> 96</a>
</span><span class=lnt id=hl-20-97><a class=lnlinks href=#hl-20-97> 97</a>
</span><span class=lnt id=hl-20-98><a class=lnlinks href=#hl-20-98> 98</a>
</span><span class=lnt id=hl-20-99><a class=lnlinks href=#hl-20-99> 99</a>
</span><span class=lnt id=hl-20-100><a class=lnlinks href=#hl-20-100>100</a>
</span><span class=lnt id=hl-20-101><a class=lnlinks href=#hl-20-101>101</a>
</span><span class=lnt id=hl-20-102><a class=lnlinks href=#hl-20-102>102</a>
</span><span class=lnt id=hl-20-103><a class=lnlinks href=#hl-20-103>103</a>
</span><span class=lnt id=hl-20-104><a class=lnlinks href=#hl-20-104>104</a>
</span><span class=lnt id=hl-20-105><a class=lnlinks href=#hl-20-105>105</a>
</span><span class=lnt id=hl-20-106><a class=lnlinks href=#hl-20-106>106</a>
</span><span class=lnt id=hl-20-107><a class=lnlinks href=#hl-20-107>107</a>
</span><span class=lnt id=hl-20-108><a class=lnlinks href=#hl-20-108>108</a>
</span><span class=lnt id=hl-20-109><a class=lnlinks href=#hl-20-109>109</a>
</span><span class=lnt id=hl-20-110><a class=lnlinks href=#hl-20-110>110</a>
</span><span class=lnt id=hl-20-111><a class=lnlinks href=#hl-20-111>111</a>
</span><span class=lnt id=hl-20-112><a class=lnlinks href=#hl-20-112>112</a>
</span><span class=lnt id=hl-20-113><a class=lnlinks href=#hl-20-113>113</a>
</span><span class=lnt id=hl-20-114><a class=lnlinks href=#hl-20-114>114</a>
</span><span class=lnt id=hl-20-115><a class=lnlinks href=#hl-20-115>115</a>
</span><span class=lnt id=hl-20-116><a class=lnlinks href=#hl-20-116>116</a>
</span><span class=lnt id=hl-20-117><a class=lnlinks href=#hl-20-117>117</a>
</span><span class=lnt id=hl-20-118><a class=lnlinks href=#hl-20-118>118</a>
</span><span class=lnt id=hl-20-119><a class=lnlinks href=#hl-20-119>119</a>
</span><span class=lnt id=hl-20-120><a class=lnlinks href=#hl-20-120>120</a>
</span><span class=lnt id=hl-20-121><a class=lnlinks href=#hl-20-121>121</a>
</span><span class=lnt id=hl-20-122><a class=lnlinks href=#hl-20-122>122</a>
</span><span class=lnt id=hl-20-123><a class=lnlinks href=#hl-20-123>123</a>
</span><span class=lnt id=hl-20-124><a class=lnlinks href=#hl-20-124>124</a>
</span><span class=lnt id=hl-20-125><a class=lnlinks href=#hl-20-125>125</a>
</span><span class=lnt id=hl-20-126><a class=lnlinks href=#hl-20-126>126</a>
</span><span class=lnt id=hl-20-127><a class=lnlinks href=#hl-20-127>127</a>
</span><span class=lnt id=hl-20-128><a class=lnlinks href=#hl-20-128>128</a>
</span><span class=lnt id=hl-20-129><a class=lnlinks href=#hl-20-129>129</a>
</span><span class=lnt id=hl-20-130><a class=lnlinks href=#hl-20-130>130</a>
</span><span class=lnt id=hl-20-131><a class=lnlinks href=#hl-20-131>131</a>
</span><span class=lnt id=hl-20-132><a class=lnlinks href=#hl-20-132>132</a>
</span><span class=lnt id=hl-20-133><a class=lnlinks href=#hl-20-133>133</a>
</span><span class=lnt id=hl-20-134><a class=lnlinks href=#hl-20-134>134</a>
</span><span class=lnt id=hl-20-135><a class=lnlinks href=#hl-20-135>135</a>
</span><span class=lnt id=hl-20-136><a class=lnlinks href=#hl-20-136>136</a>
</span><span class=lnt id=hl-20-137><a class=lnlinks href=#hl-20-137>137</a>
</span><span class=lnt id=hl-20-138><a class=lnlinks href=#hl-20-138>138</a>
</span><span class=lnt id=hl-20-139><a class=lnlinks href=#hl-20-139>139</a>
</span><span class=lnt id=hl-20-140><a class=lnlinks href=#hl-20-140>140</a>
</span><span class=lnt id=hl-20-141><a class=lnlinks href=#hl-20-141>141</a>
</span><span class=lnt id=hl-20-142><a class=lnlinks href=#hl-20-142>142</a>
</span><span class=lnt id=hl-20-143><a class=lnlinks href=#hl-20-143>143</a>
</span><span class=lnt id=hl-20-144><a class=lnlinks href=#hl-20-144>144</a>
</span><span class=lnt id=hl-20-145><a class=lnlinks href=#hl-20-145>145</a>
</span><span class=lnt id=hl-20-146><a class=lnlinks href=#hl-20-146>146</a>
</span><span class=lnt id=hl-20-147><a class=lnlinks href=#hl-20-147>147</a>
</span><span class=lnt id=hl-20-148><a class=lnlinks href=#hl-20-148>148</a>
</span><span class=lnt id=hl-20-149><a class=lnlinks href=#hl-20-149>149</a>
</span><span class=lnt id=hl-20-150><a class=lnlinks href=#hl-20-150>150</a>
</span><span class=lnt id=hl-20-151><a class=lnlinks href=#hl-20-151>151</a>
</span><span class=lnt id=hl-20-152><a class=lnlinks href=#hl-20-152>152</a>
</span><span class=lnt id=hl-20-153><a class=lnlinks href=#hl-20-153>153</a>
</span><span class=lnt id=hl-20-154><a class=lnlinks href=#hl-20-154>154</a>
</span><span class=lnt id=hl-20-155><a class=lnlinks href=#hl-20-155>155</a>
</span><span class=lnt id=hl-20-156><a class=lnlinks href=#hl-20-156>156</a>
</span><span class=lnt id=hl-20-157><a class=lnlinks href=#hl-20-157>157</a>
</span><span class=lnt id=hl-20-158><a class=lnlinks href=#hl-20-158>158</a>
</span><span class=lnt id=hl-20-159><a class=lnlinks href=#hl-20-159>159</a>
</span><span class=lnt id=hl-20-160><a class=lnlinks href=#hl-20-160>160</a>
</span><span class=lnt id=hl-20-161><a class=lnlinks href=#hl-20-161>161</a>
</span><span class=lnt id=hl-20-162><a class=lnlinks href=#hl-20-162>162</a>
</span><span class=lnt id=hl-20-163><a class=lnlinks href=#hl-20-163>163</a>
</span><span class=lnt id=hl-20-164><a class=lnlinks href=#hl-20-164>164</a>
</span><span class=lnt id=hl-20-165><a class=lnlinks href=#hl-20-165>165</a>
</span><span class=lnt id=hl-20-166><a class=lnlinks href=#hl-20-166>166</a>
</span><span class=lnt id=hl-20-167><a class=lnlinks href=#hl-20-167>167</a>
</span><span class=lnt id=hl-20-168><a class=lnlinks href=#hl-20-168>168</a>
</span><span class=lnt id=hl-20-169><a class=lnlinks href=#hl-20-169>169</a>
</span><span class=lnt id=hl-20-170><a class=lnlinks href=#hl-20-170>170</a>
</span><span class=lnt id=hl-20-171><a class=lnlinks href=#hl-20-171>171</a>
</span><span class=lnt id=hl-20-172><a class=lnlinks href=#hl-20-172>172</a>
</span><span class=lnt id=hl-20-173><a class=lnlinks href=#hl-20-173>173</a>
</span><span class=lnt id=hl-20-174><a class=lnlinks href=#hl-20-174>174</a>
</span><span class=lnt id=hl-20-175><a class=lnlinks href=#hl-20-175>175</a>
</span><span class=lnt id=hl-20-176><a class=lnlinks href=#hl-20-176>176</a>
</span><span class=lnt id=hl-20-177><a class=lnlinks href=#hl-20-177>177</a>
</span><span class=lnt id=hl-20-178><a class=lnlinks href=#hl-20-178>178</a>
</span><span class=lnt id=hl-20-179><a class=lnlinks href=#hl-20-179>179</a>
</span><span class=lnt id=hl-20-180><a class=lnlinks href=#hl-20-180>180</a>
</span><span class=lnt id=hl-20-181><a class=lnlinks href=#hl-20-181>181</a>
</span><span class=lnt id=hl-20-182><a class=lnlinks href=#hl-20-182>182</a>
</span><span class=lnt id=hl-20-183><a class=lnlinks href=#hl-20-183>183</a>
</span><span class=lnt id=hl-20-184><a class=lnlinks href=#hl-20-184>184</a>
</span><span class=lnt id=hl-20-185><a class=lnlinks href=#hl-20-185>185</a>
</span><span class=lnt id=hl-20-186><a class=lnlinks href=#hl-20-186>186</a>
</span><span class=lnt id=hl-20-187><a class=lnlinks href=#hl-20-187>187</a>
</span><span class=lnt id=hl-20-188><a class=lnlinks href=#hl-20-188>188</a>
</span><span class=lnt id=hl-20-189><a class=lnlinks href=#hl-20-189>189</a>
</span><span class=lnt id=hl-20-190><a class=lnlinks href=#hl-20-190>190</a>
</span><span class=lnt id=hl-20-191><a class=lnlinks href=#hl-20-191>191</a>
</span><span class=lnt id=hl-20-192><a class=lnlinks href=#hl-20-192>192</a>
</span><span class=lnt id=hl-20-193><a class=lnlinks href=#hl-20-193>193</a>
</span><span class=lnt id=hl-20-194><a class=lnlinks href=#hl-20-194>194</a>
</span><span class=lnt id=hl-20-195><a class=lnlinks href=#hl-20-195>195</a>
</span><span class=lnt id=hl-20-196><a class=lnlinks href=#hl-20-196>196</a>
</span><span class=lnt id=hl-20-197><a class=lnlinks href=#hl-20-197>197</a>
</span><span class=lnt id=hl-20-198><a class=lnlinks href=#hl-20-198>198</a>
</span><span class=lnt id=hl-20-199><a class=lnlinks href=#hl-20-199>199</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 시청 이벤트 정의</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ViewingEvent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>contentId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timestamp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>watchDurationSeconds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>deviceType</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Netflix 특화: 시청 품질 메트릭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=n>bufferingRatio</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>videoQuality</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 생성자, getter/setter 생략</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Kafka Streams를 활용한 실시간 집계</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ViewingAnalyticsProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>StreamsBuilder</span><span class=w> </span><span class=n>streamsBuilder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostConstruct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>buildTopology</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 시청 이벤트 스트림 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>ViewingEvent</span><span class=o>&gt;</span><span class=w> </span><span class=n>viewingEvents</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>streamsBuilder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=s>&#34;viewing-events&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 사용자별 실시간 집계</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KTable</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>UserViewingStats</span><span class=o>&gt;</span><span class=w> </span><span class=n>userStats</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>viewingEvents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getWatchDurationSeconds</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>30</span><span class=p>)</span><span class=w> </span><span class=c1>// 30초 이상 시청만</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>groupBy</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getUserId</span><span class=p>())</span><span class=w> </span><span class=c1>// 사용자별 그룹화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>aggregate</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>UserViewingStats</span><span class=p>::</span><span class=k>new</span><span class=p>,</span><span class=w> </span><span class=c1>// 초기값</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>stats</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 시청 통계 업데이트</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>stats</span><span class=p>.</span><span class=na>addWatchTime</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getWatchDurationSeconds</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>stats</span><span class=p>.</span><span class=na>addContentView</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getContentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>stats</span><span class=p>.</span><span class=na>updateLastActivity</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getTimestamp</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Netflix 특화: 시청 품질 추적</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>stats</span><span class=p>.</span><span class=na>updateQualityMetrics</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>event</span><span class=p>.</span><span class=na>getBufferingRatio</span><span class=p>(),</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>event</span><span class=p>.</span><span class=na>getVideoQuality</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>stats</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Materialized</span><span class=p>.</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>UserViewingStats</span><span class=p>,</span><span class=w> </span><span class=n>KeyValueStore</span><span class=o>&lt;</span><span class=n>Bytes</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]&gt;&gt;</span><span class=n>as</span><span class=p>(</span><span class=s>&#34;user-stats-store&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>withValueSerde</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>serdeFrom</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>JsonSerializer</span><span class=o>&lt;&gt;</span><span class=p>(),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JsonDeserializer</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>UserViewingStats</span><span class=p>.</span><span class=na>class</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 콘텐츠별 인기도 실시간 계산</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KTable</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>ContentPopularity</span><span class=o>&gt;</span><span class=w> </span><span class=n>contentPopularity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>viewingEvents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getWatchDurationSeconds</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>60</span><span class=p>)</span><span class=w> </span><span class=c1>// 1분 이상 시청</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>groupBy</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getContentId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>windowedBy</span><span class=p>(</span><span class=n>TimeWindows</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMinutes</span><span class=p>(</span><span class=n>5</span><span class=p>)))</span><span class=w> </span><span class=c1>// 5분 윈도우</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>aggregate</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ContentPopularity</span><span class=p>::</span><span class=k>new</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>contentId</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>popularity</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>popularity</span><span class=p>.</span><span class=na>incrementViewCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>popularity</span><span class=p>.</span><span class=na>addWatchTime</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getWatchDurationSeconds</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Netflix 특화: 디바이스별 시청 패턴</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>popularity</span><span class=p>.</span><span class=na>trackDeviceUsage</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getDeviceType</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>popularity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Materialized</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&#34;content-popularity-store&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 실시간 추천을 위한 이벤트 발행</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userStats</span><span class=p>.</span><span class=na>toStream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>stats</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>stats</span><span class=p>.</span><span class=na>shouldUpdateRecommendations</span><span class=p>())</span><span class=w> </span><span class=c1>// 추천 업데이트 조건</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=s>&#34;recommendation-updates&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 이상 패턴 감지 (사기 탐지)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>viewingEvents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=k>this</span><span class=p>::</span><span class=n>detectAnomalousViewing</span><span class=p>)</span><span class=w> </span><span class=c1>// 비정상 시청 패턴 감지</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=s>&#34;fraud-detection&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>detectAnomalousViewing</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>ViewingEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Netflix 특화: 비정상 시청 패턴 감지 로직</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 예: 짧은 시간에 다수 콘텐츠 시청, 비정상적인 시청 시간 등</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getWatchDurationSeconds</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>86400</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=c1>// 24시간 초과 시청</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>event</span><span class=p>.</span><span class=na>getBufferingRatio</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>8</span><span class=p>;</span><span class=w> </span><span class=c1>// 버퍼링이 80% 이상</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 사용자 시청 통계 집계 객체</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserViewingStats</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>totalWatchTimeSeconds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>uniqueContent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>lastActivityTimestamp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>totalViews</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Netflix 특화 메트릭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=n>averageBufferingRatio</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>qualityPreferences</span><span class=p>;</span><span class=w> </span><span class=c1>// 화질별 시청 횟수</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>deviceUsage</span><span class=p>;</span><span class=w> </span><span class=c1>// 디바이스별 사용 패턴</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>genrePreferences</span><span class=p>;</span><span class=w> </span><span class=c1>// 장르 선호도</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addWatchTime</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>seconds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>totalWatchTimeSeconds</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>seconds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>totalViews</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addContentView</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>contentId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>uniqueContent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>uniqueContent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>uniqueContent</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>contentId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateQualityMetrics</span><span class=p>(</span><span class=kt>double</span><span class=w> </span><span class=n>bufferingRatio</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>quality</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 버퍼링 비율 평균 계산</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>averageBufferingRatio</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>averageBufferingRatio</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>totalViews</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>bufferingRatio</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>totalViews</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 화질 선호도 추적</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>qualityPreferences</span><span class=p>.</span><span class=na>merge</span><span class=p>(</span><span class=n>quality</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>::</span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldUpdateRecommendations</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 추천 업데이트가 필요한 조건</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 예: 새로운 콘텐츠 5개 이상 시청, 1시간 이상 시청 등</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>uniqueContent</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>5</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lastActivityTimestamp</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>3600000</span><span class=p>;</span><span class=w> </span><span class=c1>// 1시간</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Cassandra 기반 이벤트 저장소</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CassandraEventStore</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>CassandraTemplate</span><span class=w> </span><span class=n>cassandraTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>saveEvent</span><span class=p>(</span><span class=n>ViewingEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 시간 기반 파티셔닝으로 확장성 확보</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>partitionKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generatePartitionKey</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getTimestamp</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>            INSERT INTO events.viewing_events (
</span></span></span><span class=line><span class=cl><span class=s>                partition_key, event_id, user_id, content_id, 
</span></span></span><span class=line><span class=cl><span class=s>                timestamp, watch_duration, device_type, 
</span></span></span><span class=line><span class=cl><span class=s>                buffering_ratio, video_quality, event_data
</span></span></span><span class=line><span class=cl><span class=s>            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
</span></span></span><span class=line><span class=cl><span class=s>            &#34;&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cassandraTemplate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>cql</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>partitionKey</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span><span class=p>.</span><span class=na>getContentId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getTimestamp</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span><span class=p>.</span><span class=na>getWatchDurationSeconds</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span><span class=p>.</span><span class=na>getDeviceType</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span><span class=p>.</span><span class=na>getBufferingRatio</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span><span class=p>.</span><span class=na>getVideoQuality</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>JsonUtils</span><span class=p>.</span><span class=na>toJson</span><span class=p>(</span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=c1>// 전체 이벤트 데이터 JSON 저장</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ViewingEvent</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getEventsForUser</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>fromTimestamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 사용자의 특정 시점 이후 이벤트 조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>            SELECT * FROM events.viewing_events 
</span></span></span><span class=line><span class=cl><span class=s>            WHERE user_id = ? AND timestamp &gt;= ?
</span></span></span><span class=line><span class=cl><span class=s>            ORDER BY timestamp ASC
</span></span></span><span class=line><span class=cl><span class=s>            &#34;&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>cassandraTemplate</span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>cql</span><span class=p>,</span><span class=w> </span><span class=n>ViewingEvent</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>fromTimestamp</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>generatePartitionKey</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>timestamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 시간 기반 파티셔닝 (예: 일별)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LocalDate</span><span class=w> </span><span class=n>date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocalDate</span><span class=p>.</span><span class=na>ofEpochSecond</span><span class=p>(</span><span class=n>timestamp</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>ZoneOffset</span><span class=p>.</span><span class=na>UTC</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>date</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>DateTimeFormatter</span><span class=p>.</span><span class=na>ofPattern</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Netflix 특화: 롤업 데이터 저장</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>saveRollupData</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>timeWindow</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>aggregationType</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>            INSERT INTO events.rollup_data (
</span></span></span><span class=line><span class=cl><span class=s>                time_window, aggregation_type, data, created_at
</span></span></span><span class=line><span class=cl><span class=s>            ) VALUES (?, ?, ?, ?)
</span></span></span><span class=line><span class=cl><span class=s>            &#34;&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cassandraTemplate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>cql</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>timeWindow</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>aggregationType</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>JsonUtils</span><span class=p>.</span><span class=na>toJson</span><span class=p>(</span><span class=n>data</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=phase-6-운영-및-최적화-operations--optimization>Phase 6: 운영 및 최적화 (Operations & Optimization)<a hidden class=anchor aria-hidden=true href=#phase-6-운영-및-최적화-operations--optimization>#</a></h2><h3 id=보안-및-거버넌스-1>보안 및 거버넌스<a hidden class=anchor aria-hidden=true href=#보안-및-거버넌스-1>#</a></h3><h4 id=보안-고려사항>보안 고려사항<a hidden class=anchor aria-hidden=true href=#보안-고려사항>#</a></h4><table><thead><tr><th>보안 영역</th><th>고려사항</th><th>구현 방법</th><th>모니터링 지표</th></tr></thead><tbody><tr><td><strong>이벤트 무결성</strong></td><td>이벤트 변조 방지</td><td>디지털 서명, 해시 체인</td><td>해시 불일치 건수</td></tr><tr><td><strong>접근 제어</strong></td><td>이벤트 스토어 접근 권한</td><td>RBAC, API 게이트웨이</td><td>권한 위반 시도 횟수</td></tr><tr><td><strong>데이터 암호화</strong></td><td>민감 정보 보호</td><td>필드 레벨 암호화</td><td>암호화되지 않은 이벤트 비율</td></tr><tr><td><strong>감사 로그</strong></td><td>시스템 접근 추적</td><td>별도 감사 시스템</td><td>감사 로그 누락 건수</td></tr><tr><td><strong>개인정보 보호</strong></td><td>GDPR, CCPA 준수</td><td>암호화 샤딩, 삭제 가능한 구조</td><td>개인정보 삭제 요청 처리 시간</td></tr></tbody></table><p><strong>구현 예시 (암호화된 이벤트 저장)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26>26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27>27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28>28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29>29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30>30</a>
</span><span class=lnt id=hl-21-31><a class=lnlinks href=#hl-21-31>31</a>
</span><span class=lnt id=hl-21-32><a class=lnlinks href=#hl-21-32>32</a>
</span><span class=lnt id=hl-21-33><a class=lnlinks href=#hl-21-33>33</a>
</span><span class=lnt id=hl-21-34><a class=lnlinks href=#hl-21-34>34</a>
</span><span class=lnt id=hl-21-35><a class=lnlinks href=#hl-21-35>35</a>
</span><span class=lnt id=hl-21-36><a class=lnlinks href=#hl-21-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 개인정보를 포함한 이벤트의 암호화 처리</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SecureEventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>encryption_service</span><span class=p>,</span> <span class=n>key_management</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>encryption_service</span> <span class=o>=</span> <span class=n>encryption_service</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>key_management</span> <span class=o>=</span> <span class=n>key_management</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;개인정보가 포함된 이벤트의 안전한 저장&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 개인정보 필드 식별</span>
</span></span><span class=line><span class=cl>        <span class=n>pii_fields</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>identify_pii_fields</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 각 사용자별 암호화 키 생성/조회</span>
</span></span><span class=line><span class=cl>        <span class=n>encryption_key</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>key_management</span><span class=o>.</span><span class=n>get_user_key</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 복사 및 민감 정보 암호화</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_event</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>pii_fields</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>original_value</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>encrypted_event</span><span class=p>,</span> <span class=n>field</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>encrypted_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>encryption_service</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>original_value</span><span class=p>,</span> <span class=n>encryption_key</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>setattr</span><span class=p>(</span><span class=n>encrypted_event</span><span class=p>,</span> <span class=n>field</span><span class=p>,</span> <span class=n>encrypted_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 디지털 서명 추가</span>
</span></span><span class=line><span class=cl>        <span class=n>signature</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_digital_signature</span><span class=p>(</span><span class=n>encrypted_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_event</span><span class=o>.</span><span class=n>signature</span> <span class=o>=</span> <span class=n>signature</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>store</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>encrypted_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>delete_user_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;GDPR 준수를 위한 사용자 데이터 삭제&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 암호화 키 삭제 (crypto-shredding)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>key_management</span><span class=o>.</span><span class=n>delete_user_key</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 메타데이터에서 사용자 연결 정보 제거</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>store</span><span class=o>.</span><span class=n>anonymize_user_events</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=규정-준수>규정 준수<a hidden class=anchor aria-hidden=true href=#규정-준수>#</a></h4><p><strong>금융 서비스 규정 (SOX, PCI-DSS)</strong>:</p><ul><li>이벤트의 불변성으로 완벽한 감사 추적 제공</li><li>접근 로그와 변경 이력의 완전한 기록</li><li>정기적인 무결성 검증 및 백업</li></ul><p><strong>개인정보 보호 규정 (GDPR, CCPA)</strong>:</p><ul><li>암호화 샤딩을 통한 개인정보 삭제</li><li>동의 철회 시 관련 이벤트 처리</li><li>개인정보 처리 목적과 보존 기간 명시</li></ul><h3 id=모니터링-및-관측성-1>모니터링 및 관측성<a hidden class=anchor aria-hidden=true href=#모니터링-및-관측성-1>#</a></h3><h4 id=핵심-메트릭>핵심 메트릭<a hidden class=anchor aria-hidden=true href=#핵심-메트릭>#</a></h4><table><thead><tr><th>카테고리</th><th>메트릭</th><th>임계값</th><th>알림 조건</th><th>대응 방안</th></tr></thead><tbody><tr><td><strong>처리량</strong></td><td>초당 이벤트 처리 수</td><td>> 10,000 TPS</td><td>처리량 50% 감소</td><td>인스턴스 스케일 아웃</td></tr><tr><td><strong>지연시간</strong></td><td>이벤트 저장 지연시간</td><td>&lt; 100ms</td><td>평균 500ms 초과</td><td>데이터베이스 최적화</td></tr><tr><td><strong>가용성</strong></td><td>Event Store 가용성</td><td>99.9%</td><td>5분간 응답 없음</td><td>페일오버 실행</td></tr><tr><td><strong>일관성</strong></td><td>프로젝션 지연시간</td><td>&lt; 1초</td><td>10초 초과 지연</td><td>프로젝션 재시작</td></tr><tr><td><strong>저장소</strong></td><td>이벤트 스토어 사용량</td><td>&lt; 80%</td><td>85% 초과</td><td>아카이빙 실행</td></tr></tbody></table><p><strong>모니터링 구현 예시 (Prometheus + Grafana)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1> 1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2> 2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3> 3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4> 4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5> 5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6> 6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7> 7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8> 8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9> 9</a>
</span><span class=lnt id=hl-22-10><a class=lnlinks href=#hl-22-10>10</a>
</span><span class=lnt id=hl-22-11><a class=lnlinks href=#hl-22-11>11</a>
</span><span class=lnt id=hl-22-12><a class=lnlinks href=#hl-22-12>12</a>
</span><span class=lnt id=hl-22-13><a class=lnlinks href=#hl-22-13>13</a>
</span><span class=lnt id=hl-22-14><a class=lnlinks href=#hl-22-14>14</a>
</span><span class=lnt id=hl-22-15><a class=lnlinks href=#hl-22-15>15</a>
</span><span class=lnt id=hl-22-16><a class=lnlinks href=#hl-22-16>16</a>
</span><span class=lnt id=hl-22-17><a class=lnlinks href=#hl-22-17>17</a>
</span><span class=lnt id=hl-22-18><a class=lnlinks href=#hl-22-18>18</a>
</span><span class=lnt id=hl-22-19><a class=lnlinks href=#hl-22-19>19</a>
</span><span class=lnt id=hl-22-20><a class=lnlinks href=#hl-22-20>20</a>
</span><span class=lnt id=hl-22-21><a class=lnlinks href=#hl-22-21>21</a>
</span><span class=lnt id=hl-22-22><a class=lnlinks href=#hl-22-22>22</a>
</span><span class=lnt id=hl-22-23><a class=lnlinks href=#hl-22-23>23</a>
</span><span class=lnt id=hl-22-24><a class=lnlinks href=#hl-22-24>24</a>
</span><span class=lnt id=hl-22-25><a class=lnlinks href=#hl-22-25>25</a>
</span><span class=lnt id=hl-22-26><a class=lnlinks href=#hl-22-26>26</a>
</span><span class=lnt id=hl-22-27><a class=lnlinks href=#hl-22-27>27</a>
</span><span class=lnt id=hl-22-28><a class=lnlinks href=#hl-22-28>28</a>
</span><span class=lnt id=hl-22-29><a class=lnlinks href=#hl-22-29>29</a>
</span><span class=lnt id=hl-22-30><a class=lnlinks href=#hl-22-30>30</a>
</span><span class=lnt id=hl-22-31><a class=lnlinks href=#hl-22-31>31</a>
</span><span class=lnt id=hl-22-32><a class=lnlinks href=#hl-22-32>32</a>
</span><span class=lnt id=hl-22-33><a class=lnlinks href=#hl-22-33>33</a>
</span><span class=lnt id=hl-22-34><a class=lnlinks href=#hl-22-34>34</a>
</span><span class=lnt id=hl-22-35><a class=lnlinks href=#hl-22-35>35</a>
</span><span class=lnt id=hl-22-36><a class=lnlinks href=#hl-22-36>36</a>
</span><span class=lnt id=hl-22-37><a class=lnlinks href=#hl-22-37>37</a>
</span><span class=lnt id=hl-22-38><a class=lnlinks href=#hl-22-38>38</a>
</span><span class=lnt id=hl-22-39><a class=lnlinks href=#hl-22-39>39</a>
</span><span class=lnt id=hl-22-40><a class=lnlinks href=#hl-22-40>40</a>
</span><span class=lnt id=hl-22-41><a class=lnlinks href=#hl-22-41>41</a>
</span><span class=lnt id=hl-22-42><a class=lnlinks href=#hl-22-42>42</a>
</span><span class=lnt id=hl-22-43><a class=lnlinks href=#hl-22-43>43</a>
</span><span class=lnt id=hl-22-44><a class=lnlinks href=#hl-22-44>44</a>
</span><span class=lnt id=hl-22-45><a class=lnlinks href=#hl-22-45>45</a>
</span><span class=lnt id=hl-22-46><a class=lnlinks href=#hl-22-46>46</a>
</span><span class=lnt id=hl-22-47><a class=lnlinks href=#hl-22-47>47</a>
</span><span class=lnt id=hl-22-48><a class=lnlinks href=#hl-22-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Prometheus 메트릭 수집</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>Gauge</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStoreMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 처리 카운터</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events_processed</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;events_processed_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Total number of events processed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s1>&#39;event_type&#39;</span><span class=p>,</span> <span class=s1>&#39;status&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 저장 지연시간</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_save_duration</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;event_save_duration_seconds&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Time spent saving events&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>buckets</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 프로젝션 지연</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>projection_lag</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;projection_lag_seconds&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Lag between event creation and projection update&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s1>&#39;projection_name&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 스토어 크기</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store_size</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;event_store_size_bytes&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Size of the event store&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_event_processed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=s1>&#39;success&#39;</span> <span class=k>if</span> <span class=n>success</span> <span class=k>else</span> <span class=s1>&#39;failure&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events_processed</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span><span class=o>=</span><span class=n>event_type</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=o>=</span><span class=n>status</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>time_event_save</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_save_duration</span><span class=o>.</span><span class=n>time</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_projection_lag</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>projection_name</span><span class=p>,</span> <span class=n>lag_seconds</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>projection_lag</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>projection_name</span><span class=o>=</span><span class=n>projection_name</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lag_seconds</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=로깅-전략>로깅 전략<a hidden class=anchor aria-hidden=true href=#로깅-전략>#</a></h4><p><strong>구조화된 로깅</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=s2>&#34;2024-01-15T10:30:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=s2>&#34;INFO&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;event-store&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;event_type&#34;</span><span class=p>:</span> <span class=s2>&#34;OrderPlaced&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;aggregate_id&#34;</span><span class=p>:</span> <span class=s2>&#34;order-12345&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-789&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;correlation_id&#34;</span><span class=p>:</span> <span class=s2>&#34;req-abc123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;duration_ms&#34;</span><span class=p>:</span> <span class=mi>45</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>분산 추적 (Distributed Tracing)</strong>:</p><ul><li>OpenTelemetry를 활용한 이벤트 플로우 추적</li><li>마이크로서비스 간 이벤트 전파 경로 시각화</li><li>성능 병목 구간 식별</li></ul><h3 id=실무-적용-고려사항-및-주의점-1>실무 적용 고려사항 및 주의점<a hidden class=anchor aria-hidden=true href=#실무-적용-고려사항-및-주의점-1>#</a></h3><table><thead><tr><th>구분</th><th>고려사항</th><th>권장사항</th><th>주의점</th></tr></thead><tbody><tr><td><strong>팀 준비도</strong></td><td>새로운 패러다임 학습</td><td>점진적 교육, 전문가 멘토링</td><td>전체 시스템을 한번에 전환하지 말 것</td></tr><tr><td><strong>인프라 준비</strong></td><td>이벤트 저장소 용량 계획</td><td>성장률 분석 후 3배 여유분 확보</td><td>저장소 부족으로 인한 서비스 중단</td></tr><tr><td><strong>데이터 모델링</strong></td><td>이벤트 스키마 설계</td><td>변경에 유연한 스키마 구조</td><td>초기 설계 오류로 인한 마이그레이션 비용</td></tr><tr><td><strong>성능 최적화</strong></td><td>읽기 성능 저하</td><td>CQRS 패턴 필수 적용</td><td>단순 이벤트 재생으로는 실용성 제한</td></tr><tr><td><strong>운영 복잡성</strong></td><td>모니터링 시스템 구축</td><td>전용 관측성 도구 도입</td><td>디버깅 복잡성으로 인한 장애 대응 지연</td></tr><tr><td><strong>비즈니스 연속성</strong></td><td>기존 시스템과의 호환성</td><td>단계적 마이그레이션 계획</td><td>비즈니스 중단 없는 전환 전략 필수</td></tr></tbody></table><h3 id=성능-최적화-전략-및-고려사항>성능 최적화 전략 및 고려사항<a hidden class=anchor aria-hidden=true href=#성능-최적화-전략-및-고려사항>#</a></h3><table><thead><tr><th>최적화 영역</th><th>전략</th><th>구현 방법</th><th>기대 효과</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>쓰기 성능</strong></td><td>배치 처리</td><td>이벤트 묶음 저장</td><td>처리량 5-10배 향상</td><td>트랜잭션 크기 조절</td></tr><tr><td><strong>읽기 성능</strong></td><td>프로젝션 최적화</td><td>쿼리별 맞춤형 뷰</td><td>응답 시간 90% 단축</td><td>비정규화 적극 활용</td></tr><tr><td><strong>저장소 성능</strong></td><td>파티셔닝</td><td>시간/집계 기반 분할</td><td>쿼리 성능 70% 향상</td><td>핫 파티션 방지</td></tr><tr><td><strong>네트워크 성능</strong></td><td>이벤트 압축</td><td>gzip, snappy 압축</td><td>대역폭 60% 절약</td><td>CPU vs 대역폭 트레이드오프 고려</td></tr><tr><td><strong>메모리 성능</strong></td><td>스냅샷 전략</td><td>적응형 스냅샷 생성</td><td>메모리 사용량 40% 감소</td><td>스냅샷 빈도 최적화</td></tr><tr><td><strong>동시성 성능</strong></td><td>샤딩</td><td>집계별 분산 처리</td><td>동시 처리량 3-5배 증가</td><td>핫스팟 집계 식별 및 분산</td></tr></tbody></table><p><strong>성능 최적화 구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1> 1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2> 2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3> 3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4> 4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5> 5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6> 6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7> 7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8> 8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9> 9</a>
</span><span class=lnt id=hl-24-10><a class=lnlinks href=#hl-24-10>10</a>
</span><span class=lnt id=hl-24-11><a class=lnlinks href=#hl-24-11>11</a>
</span><span class=lnt id=hl-24-12><a class=lnlinks href=#hl-24-12>12</a>
</span><span class=lnt id=hl-24-13><a class=lnlinks href=#hl-24-13>13</a>
</span><span class=lnt id=hl-24-14><a class=lnlinks href=#hl-24-14>14</a>
</span><span class=lnt id=hl-24-15><a class=lnlinks href=#hl-24-15>15</a>
</span><span class=lnt id=hl-24-16><a class=lnlinks href=#hl-24-16>16</a>
</span><span class=lnt id=hl-24-17><a class=lnlinks href=#hl-24-17>17</a>
</span><span class=lnt id=hl-24-18><a class=lnlinks href=#hl-24-18>18</a>
</span><span class=lnt id=hl-24-19><a class=lnlinks href=#hl-24-19>19</a>
</span><span class=lnt id=hl-24-20><a class=lnlinks href=#hl-24-20>20</a>
</span><span class=lnt id=hl-24-21><a class=lnlinks href=#hl-24-21>21</a>
</span><span class=lnt id=hl-24-22><a class=lnlinks href=#hl-24-22>22</a>
</span><span class=lnt id=hl-24-23><a class=lnlinks href=#hl-24-23>23</a>
</span><span class=lnt id=hl-24-24><a class=lnlinks href=#hl-24-24>24</a>
</span><span class=lnt id=hl-24-25><a class=lnlinks href=#hl-24-25>25</a>
</span><span class=lnt id=hl-24-26><a class=lnlinks href=#hl-24-26>26</a>
</span><span class=lnt id=hl-24-27><a class=lnlinks href=#hl-24-27>27</a>
</span><span class=lnt id=hl-24-28><a class=lnlinks href=#hl-24-28>28</a>
</span><span class=lnt id=hl-24-29><a class=lnlinks href=#hl-24-29>29</a>
</span><span class=lnt id=hl-24-30><a class=lnlinks href=#hl-24-30>30</a>
</span><span class=lnt id=hl-24-31><a class=lnlinks href=#hl-24-31>31</a>
</span><span class=lnt id=hl-24-32><a class=lnlinks href=#hl-24-32>32</a>
</span><span class=lnt id=hl-24-33><a class=lnlinks href=#hl-24-33>33</a>
</span><span class=lnt id=hl-24-34><a class=lnlinks href=#hl-24-34>34</a>
</span><span class=lnt id=hl-24-35><a class=lnlinks href=#hl-24-35>35</a>
</span><span class=lnt id=hl-24-36><a class=lnlinks href=#hl-24-36>36</a>
</span><span class=lnt id=hl-24-37><a class=lnlinks href=#hl-24-37>37</a>
</span><span class=lnt id=hl-24-38><a class=lnlinks href=#hl-24-38>38</a>
</span><span class=lnt id=hl-24-39><a class=lnlinks href=#hl-24-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 적응형 스냅샷 전략</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdaptiveSnapshotStrategy</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_thresholds</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 집계별 스냅샷 임계값</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_history</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 성능 이력</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>should_create_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>event_count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;동적 스냅샷 생성 판단&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 해당 집계의 이벤트 재생 성능 분석</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_replay_time</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_average_replay_time</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 성능 기반 동적 임계값 조정</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>avg_replay_time</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>  <span class=c1># 1초 초과</span>
</span></span><span class=line><span class=cl>            <span class=n>threshold</span> <span class=o>=</span> <span class=mi>50</span>  <span class=c1># 더 자주 스냅샷</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>avg_replay_time</span> <span class=o>&gt;</span> <span class=mi>500</span><span class=p>:</span>  <span class=c1># 0.5초 초과</span>
</span></span><span class=line><span class=cl>            <span class=n>threshold</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>threshold</span> <span class=o>=</span> <span class=mi>200</span>  <span class=c1># 덜 자주 스냅샷</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_thresholds</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event_count</span> <span class=o>&gt;=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>optimize_projection_update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;프로젝션 업데이트 최적화&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 타입별 배치 처리</span>
</span></span><span class=line><span class=cl>        <span class=n>events_by_type</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>event_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>events_by_type</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>events_by_type</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>events_by_type</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 타입별 최적화된 배치 처리</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>event_list</span> <span class=ow>in</span> <span class=n>events_by_type</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;OrderPlaced&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>batch_update_order_summary</span><span class=p>(</span><span class=n>event_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;PaymentProcessed&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>batch_update_payment_status</span><span class=p>(</span><span class=n>event_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># ... 다른 이벤트 타입 처리</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=phase-7-고급-주제-advanced-topics>Phase 7: 고급 주제 (Advanced Topics)<a hidden class=anchor aria-hidden=true href=#phase-7-고급-주제-advanced-topics>#</a></h2><h3 id=현재-도전-과제-1>현재 도전 과제<a hidden class=anchor aria-hidden=true href=#현재-도전-과제-1>#</a></h3><table><thead><tr><th>도전 과제</th><th>원인</th><th>영향</th><th>해결방안</th></tr></thead><tbody><tr><td><strong>이벤트 스키마 진화</strong></td><td>비즈니스 요구사항 변화, 도메인 모델 발전</td><td>하위 호환성 문제, 이벤트 재생 실패</td><td>스키마 버전 관리, 멀티 버전 핸들러, 이벤트 업캐스팅</td></tr><tr><td><strong>대용량 이벤트 스트림</strong></td><td>사업 성장, 실시간 요구사항 증가</td><td>성능 저하, 저장 비용 증가</td><td>계층형 저장소, 지능형 아카이빙, 병렬 처리</td></tr><tr><td><strong>복합 비즈니스 트랜잭션</strong></td><td>마이크로서비스 간 데이터 일관성</td><td>부분 실패, 데이터 불일치</td><td>Saga 패턴, 프로세스 매니저, 보상 트랜잭션</td></tr><tr><td><strong>실시간 이벤트 처리</strong></td><td>낮은 지연시간 요구, 높은 처리량</td><td>시스템 복잡성 증가, 운영 부담</td><td>스트림 처리 플랫폼, 인메모리 계산, 엣지 컴퓨팅</td></tr><tr><td><strong>다중 클라우드 환경</strong></td><td>클라우드 중립성, 재해 복구</td><td>일관성 관리, 네트워크 지연</td><td>글로벌 이벤트 복제, 충돌 해결 알고리즘</td></tr></tbody></table><p><strong>해결방안 구현 예시 (이벤트 업캐스팅)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19>19</a>
</span><span class=lnt id=hl-25-20><a class=lnlinks href=#hl-25-20>20</a>
</span><span class=lnt id=hl-25-21><a class=lnlinks href=#hl-25-21>21</a>
</span><span class=lnt id=hl-25-22><a class=lnlinks href=#hl-25-22>22</a>
</span><span class=lnt id=hl-25-23><a class=lnlinks href=#hl-25-23>23</a>
</span><span class=lnt id=hl-25-24><a class=lnlinks href=#hl-25-24>24</a>
</span><span class=lnt id=hl-25-25><a class=lnlinks href=#hl-25-25>25</a>
</span><span class=lnt id=hl-25-26><a class=lnlinks href=#hl-25-26>26</a>
</span><span class=lnt id=hl-25-27><a class=lnlinks href=#hl-25-27>27</a>
</span><span class=lnt id=hl-25-28><a class=lnlinks href=#hl-25-28>28</a>
</span><span class=lnt id=hl-25-29><a class=lnlinks href=#hl-25-29>29</a>
</span><span class=lnt id=hl-25-30><a class=lnlinks href=#hl-25-30>30</a>
</span><span class=lnt id=hl-25-31><a class=lnlinks href=#hl-25-31>31</a>
</span><span class=lnt id=hl-25-32><a class=lnlinks href=#hl-25-32>32</a>
</span><span class=lnt id=hl-25-33><a class=lnlinks href=#hl-25-33>33</a>
</span><span class=lnt id=hl-25-34><a class=lnlinks href=#hl-25-34>34</a>
</span><span class=lnt id=hl-25-35><a class=lnlinks href=#hl-25-35>35</a>
</span><span class=lnt id=hl-25-36><a class=lnlinks href=#hl-25-36>36</a>
</span><span class=lnt id=hl-25-37><a class=lnlinks href=#hl-25-37>37</a>
</span><span class=lnt id=hl-25-38><a class=lnlinks href=#hl-25-38>38</a>
</span><span class=lnt id=hl-25-39><a class=lnlinks href=#hl-25-39>39</a>
</span><span class=lnt id=hl-25-40><a class=lnlinks href=#hl-25-40>40</a>
</span><span class=lnt id=hl-25-41><a class=lnlinks href=#hl-25-41>41</a>
</span><span class=lnt id=hl-25-42><a class=lnlinks href=#hl-25-42>42</a>
</span><span class=lnt id=hl-25-43><a class=lnlinks href=#hl-25-43>43</a>
</span><span class=lnt id=hl-25-44><a class=lnlinks href=#hl-25-44>44</a>
</span><span class=lnt id=hl-25-45><a class=lnlinks href=#hl-25-45>45</a>
</span><span class=lnt id=hl-25-46><a class=lnlinks href=#hl-25-46>46</a>
</span><span class=lnt id=hl-25-47><a class=lnlinks href=#hl-25-47>47</a>
</span><span class=lnt id=hl-25-48><a class=lnlinks href=#hl-25-48>48</a>
</span><span class=lnt id=hl-25-49><a class=lnlinks href=#hl-25-49>49</a>
</span><span class=lnt id=hl-25-50><a class=lnlinks href=#hl-25-50>50</a>
</span><span class=lnt id=hl-25-51><a class=lnlinks href=#hl-25-51>51</a>
</span><span class=lnt id=hl-25-52><a class=lnlinks href=#hl-25-52>52</a>
</span><span class=lnt id=hl-25-53><a class=lnlinks href=#hl-25-53>53</a>
</span><span class=lnt id=hl-25-54><a class=lnlinks href=#hl-25-54>54</a>
</span><span class=lnt id=hl-25-55><a class=lnlinks href=#hl-25-55>55</a>
</span><span class=lnt id=hl-25-56><a class=lnlinks href=#hl-25-56>56</a>
</span><span class=lnt id=hl-25-57><a class=lnlinks href=#hl-25-57>57</a>
</span><span class=lnt id=hl-25-58><a class=lnlinks href=#hl-25-58>58</a>
</span><span class=lnt id=hl-25-59><a class=lnlinks href=#hl-25-59>59</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 이벤트 스키마 진화를 위한 업캐스팅 시스템</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventUpcaster</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upcasters</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>register_upcasters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_upcasters</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;버전별 업캐스터 등록&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># OrderPlaced v1 -&gt; v2 업캐스터</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upcasters</span><span class=p>[(</span><span class=s1>&#39;OrderPlaced&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upcast_order_placed_v1_to_v2</span>
</span></span><span class=line><span class=cl>        <span class=c1># OrderPlaced v2 -&gt; v3 업캐스터  </span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upcasters</span><span class=p>[(</span><span class=s1>&#39;OrderPlaced&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upcast_order_placed_v2_to_v3</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>upcast_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_data</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>from_version</span><span class=p>,</span> <span class=n>to_version</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 대상 버전으로 업캐스트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_version</span> <span class=o>=</span> <span class=n>from_version</span>
</span></span><span class=line><span class=cl>        <span class=n>current_data</span> <span class=o>=</span> <span class=n>event_data</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 단계별 업캐스팅</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>current_version</span> <span class=o>&lt;</span> <span class=n>to_version</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>next_version</span> <span class=o>=</span> <span class=n>current_version</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>upcaster_key</span> <span class=o>=</span> <span class=p>(</span><span class=n>event_type</span><span class=p>,</span> <span class=n>current_version</span><span class=p>,</span> <span class=n>next_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>upcaster_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>upcasters</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>current_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upcasters</span><span class=p>[</span><span class=n>upcaster_key</span><span class=p>](</span><span class=n>current_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>current_version</span> <span class=o>=</span> <span class=n>next_version</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;No upcaster found for </span><span class=si>{</span><span class=n>upcaster_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>current_data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>upcast_order_placed_v1_to_v2</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>v1_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;OrderPlaced v1 -&gt; v2 변환 (배송 정보 추가)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>v2_data</span> <span class=o>=</span> <span class=n>v1_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># v2에서 추가된 shipping_address 필드</span>
</span></span><span class=line><span class=cl>        <span class=c1># v1에서는 billing_address를 shipping_address로 복사</span>
</span></span><span class=line><span class=cl>        <span class=n>v2_data</span><span class=p>[</span><span class=s1>&#39;shipping_address&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>v1_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;billing_address&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># v2에서 추가된 delivery_preference 필드 (기본값)</span>
</span></span><span class=line><span class=cl>        <span class=n>v2_data</span><span class=p>[</span><span class=s1>&#39;delivery_preference&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;standard&#39;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v2_data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>upcast_order_placed_v2_to_v3</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>v2_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;OrderPlaced v2 -&gt; v3 변환 (다중 통화 지원)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>v3_data</span> <span class=o>=</span> <span class=n>v2_data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># v3에서 통화 정보 추가 (기본값: USD)</span>
</span></span><span class=line><span class=cl>        <span class=n>v3_data</span><span class=p>[</span><span class=s1>&#39;currency&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;USD&#39;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 기존 금액 필드를 currency_amounts 구조로 변환</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;total_amount&#39;</span> <span class=ow>in</span> <span class=n>v2_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>v3_data</span><span class=p>[</span><span class=s1>&#39;currency_amounts&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;USD&#39;</span><span class=p>:</span> <span class=n>v2_data</span><span class=p>[</span><span class=s1>&#39;total_amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1># 하위 호환성을 위해 total_amount 유지</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v3_data</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=생태계-및-관련-기술-1>생태계 및 관련 기술<a hidden class=anchor aria-hidden=true href=#생태계-및-관련-기술-1>#</a></h3><h4 id=메시지-브로커-및-스트리밍-플랫폼>메시지 브로커 및 스트리밍 플랫폼<a hidden class=anchor aria-hidden=true href=#메시지-브로커-및-스트리밍-플랫폼>#</a></h4><table><thead><tr><th>기술</th><th>특징</th><th>적용 분야</th><th>Event Sourcing 연계</th></tr></thead><tbody><tr><td><strong>Apache Kafka</strong></td><td>높은 처리량, 분산 복제</td><td>대규모 실시간 처리</td><td>이벤트 스토어, 이벤트 버스</td></tr><tr><td><strong>Amazon Kinesis</strong></td><td>완전 관리형, AWS 통합</td><td>클라우드 네이티브</td><td>스트림 처리, 실시간 분석</td></tr><tr><td><strong>EventStore DB</strong></td><td>이벤트 소싱 전용</td><td>금융, 도메인 복잡성 높은 시스템</td><td>네이티브 Event Store</td></tr><tr><td><strong>Redis Streams</strong></td><td>인메모리, 빠른 처리</td><td>실시간 알림, 세션 관리</td><td>경량 이벤트 버스</td></tr><tr><td><strong>Apache Pulsar</strong></td><td>멀티 테넌트, 지리적 복제</td><td>글로벌 분산 시스템</td><td>다중 클라우드 이벤트 복제</td></tr></tbody></table><h4 id=프로젝션-및-뷰-생성-도구>프로젝션 및 뷰 생성 도구<a hidden class=anchor aria-hidden=true href=#프로젝션-및-뷰-생성-도구>#</a></h4><table><thead><tr><th>도구</th><th>목적</th><th>핵심 기능</th><th>통합 방법</th></tr></thead><tbody><tr><td><strong>Kafka Streams</strong></td><td>스트림 처리</td><td>실시간 집계, 윈도우 연산</td><td>이벤트 스트림으로부터 프로젝션 생성</td></tr><tr><td><strong>Apache Flink</strong></td><td>복잡한 이벤트 처리</td><td>상태 관리, 정확히 한 번 처리</td><td>고급 비즈니스 로직 프로젝션</td></tr><tr><td><strong>ksqlDB</strong></td><td>SQL 기반 스트림 처리</td><td>선언적 쿼리</td><td>비개발자도 쉽게 뷰 생성</td></tr><tr><td><strong>Materialize</strong></td><td>실시간 SQL 뷰</td><td>증분 뷰 유지</td><td>복잡한 조인 프로젝션</td></tr></tbody></table><h4 id=표준-및-프로토콜>표준 및 프로토콜<a hidden class=anchor aria-hidden=true href=#표준-및-프로토콜>#</a></h4><p><strong>CloudEvents 표준</strong>:</p><ul><li>CNCF (Cloud Native Computing Foundation) 표준</li><li>이벤트 메타데이터 표준화</li><li>클라우드 간 상호 운용성 보장</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1> 1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2> 2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3> 3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4> 4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5> 5</a>
</span><span class=lnt id=hl-26-6><a class=lnlinks href=#hl-26-6> 6</a>
</span><span class=lnt id=hl-26-7><a class=lnlinks href=#hl-26-7> 7</a>
</span><span class=lnt id=hl-26-8><a class=lnlinks href=#hl-26-8> 8</a>
</span><span class=lnt id=hl-26-9><a class=lnlinks href=#hl-26-9> 9</a>
</span><span class=lnt id=hl-26-10><a class=lnlinks href=#hl-26-10>10</a>
</span><span class=lnt id=hl-26-11><a class=lnlinks href=#hl-26-11>11</a>
</span><span class=lnt id=hl-26-12><a class=lnlinks href=#hl-26-12>12</a>
</span><span class=lnt id=hl-26-13><a class=lnlinks href=#hl-26-13>13</a>
</span><span class=lnt id=hl-26-14><a class=lnlinks href=#hl-26-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;specversion&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;com.example.order.placed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;order-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;a234-1234-1234&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=s2>&#34;2024-01-15T10:30:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;datacontenttype&#34;</span><span class=p>:</span> <span class=s2>&#34;application/json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;subject&#34;</span><span class=p>:</span> <span class=s2>&#34;order/12345&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;data&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;orderId&#34;</span><span class=p>:</span> <span class=s2>&#34;12345&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;customerId&#34;</span><span class=p>:</span> <span class=s2>&#34;customer-789&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;amount&#34;</span><span class=p>:</span> <span class=mf>99.99</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>AsyncAPI 명세</strong>:</p><ul><li>이벤트 기반 API 문서화</li><li>이벤트 스키마 정의 및 관리</li><li>개발자 경험 향상</li></ul><h3 id=최신-기술-트렌드와-미래-방향>최신 기술 트렌드와 미래 방향<a hidden class=anchor aria-hidden=true href=#최신-기술-트렌드와-미래-방향>#</a></h3><h4 id=1-서버리스-event-sourcing>1. 서버리스 Event Sourcing<a hidden class=anchor aria-hidden=true href=#1-서버리스-event-sourcing>#</a></h4><p><strong>트렌드</strong>: FaaS(Function as a Service) 환경에서의 이벤트 소싱
<strong>기술</strong>: AWS Lambda, Azure Functions, Google Cloud Functions
<strong>장점</strong>:</p><ul><li>운영 부담 최소화</li><li>자동 스케일링</li><li>비용 효율성</li></ul><p><strong>구현 예시 (AWS Lambda)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a class=lnlinks href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a class=lnlinks href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a class=lnlinks href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a class=lnlinks href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a class=lnlinks href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a class=lnlinks href=#hl-27-18>18</a>
</span><span class=lnt id=hl-27-19><a class=lnlinks href=#hl-27-19>19</a>
</span><span class=lnt id=hl-27-20><a class=lnlinks href=#hl-27-20>20</a>
</span><span class=lnt id=hl-27-21><a class=lnlinks href=#hl-27-21>21</a>
</span><span class=lnt id=hl-27-22><a class=lnlinks href=#hl-27-22>22</a>
</span><span class=lnt id=hl-27-23><a class=lnlinks href=#hl-27-23>23</a>
</span><span class=lnt id=hl-27-24><a class=lnlinks href=#hl-27-24>24</a>
</span><span class=lnt id=hl-27-25><a class=lnlinks href=#hl-27-25>25</a>
</span><span class=lnt id=hl-27-26><a class=lnlinks href=#hl-27-26>26</a>
</span><span class=lnt id=hl-27-27><a class=lnlinks href=#hl-27-27>27</a>
</span><span class=lnt id=hl-27-28><a class=lnlinks href=#hl-27-28>28</a>
</span><span class=lnt id=hl-27-29><a class=lnlinks href=#hl-27-29>29</a>
</span><span class=lnt id=hl-27-30><a class=lnlinks href=#hl-27-30>30</a>
</span><span class=lnt id=hl-27-31><a class=lnlinks href=#hl-27-31>31</a>
</span><span class=lnt id=hl-27-32><a class=lnlinks href=#hl-27-32>32</a>
</span><span class=lnt id=hl-27-33><a class=lnlinks href=#hl-27-33>33</a>
</span><span class=lnt id=hl-27-34><a class=lnlinks href=#hl-27-34>34</a>
</span><span class=lnt id=hl-27-35><a class=lnlinks href=#hl-27-35>35</a>
</span><span class=lnt id=hl-27-36><a class=lnlinks href=#hl-27-36>36</a>
</span><span class=lnt id=hl-27-37><a class=lnlinks href=#hl-27-37>37</a>
</span><span class=lnt id=hl-27-38><a class=lnlinks href=#hl-27-38>38</a>
</span><span class=lnt id=hl-27-39><a class=lnlinks href=#hl-27-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 서버리스 이벤트 핸들러</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>aws_lambda_powertools</span> <span class=kn>import</span> <span class=n>Logger</span><span class=p>,</span> <span class=n>Tracer</span><span class=p>,</span> <span class=n>Metrics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>Logger</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>tracer</span> <span class=o>=</span> <span class=n>Tracer</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>metrics</span> <span class=o>=</span> <span class=n>Metrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tracer.capture_lambda_handler</span>
</span></span><span class=line><span class=cl><span class=nd>@logger.inject_lambda_context</span>
</span></span><span class=line><span class=cl><span class=nd>@metrics.log_metrics</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;DynamoDB Streams에서 이벤트를 수신하여 프로젝션 업데이트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;Records&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;eventName&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;INSERT&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 새 이벤트 처리</span>
</span></span><span class=line><span class=cl>            <span class=n>event_data</span> <span class=o>=</span> <span class=n>record</span><span class=p>[</span><span class=s1>&#39;dynamodb&#39;</span><span class=p>][</span><span class=s1>&#39;NewImage&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>process_new_event</span><span class=p>(</span><span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 메트릭 기록</span>
</span></span><span class=line><span class=cl>            <span class=n>metrics</span><span class=o>.</span><span class=n>add_metric</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;EventsProcessed&#34;</span><span class=p>,</span> <span class=n>unit</span><span class=o>=</span><span class=s2>&#34;Count&#34;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;statusCode&#39;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=s1>&#39;Events processed successfully&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_new_event</span><span class=p>(</span><span class=n>event_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 기반 프로젝션 업데이트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>event_type</span> <span class=o>=</span> <span class=n>event_data</span><span class=p>[</span><span class=s1>&#39;event_type&#39;</span><span class=p>][</span><span class=s1>&#39;S&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;OrderPlaced&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update_order_summary_projection</span><span class=p>(</span><span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;PaymentProcessed&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update_payment_status_projection</span><span class=p>(</span><span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processed event: </span><span class=si>{</span><span class=n>event_type</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-edge-computing과-event-sourcing>2. Edge Computing과 Event Sourcing<a hidden class=anchor aria-hidden=true href=#2-edge-computing과-event-sourcing>#</a></h4><p><strong>트렌드</strong>: IoT와 엣지 환경에서의 이벤트 처리
<strong>도전과제</strong>: 네트워크 제약, 오프라인 시나리오
<strong>해결책</strong>: 로컬 이벤트 스토어, 지능형 동기화</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a class=lnlinks href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a class=lnlinks href=#hl-28-18>18</a>
</span><span class=lnt id=hl-28-19><a class=lnlinks href=#hl-28-19>19</a>
</span><span class=lnt id=hl-28-20><a class=lnlinks href=#hl-28-20>20</a>
</span><span class=lnt id=hl-28-21><a class=lnlinks href=#hl-28-21>21</a>
</span><span class=lnt id=hl-28-22><a class=lnlinks href=#hl-28-22>22</a>
</span><span class=lnt id=hl-28-23><a class=lnlinks href=#hl-28-23>23</a>
</span><span class=lnt id=hl-28-24><a class=lnlinks href=#hl-28-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 엣지 디바이스용 경량 이벤트 스토어</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EdgeEventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sync_service</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>local_store</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 로컬 메모리 저장</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sync_service</span> <span class=o>=</span> <span class=n>sync_service</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_sync</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;로컬에 이벤트 저장&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span><span class=o>.</span><span class=n>local_timestamp</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>local_store</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 네트워크 가용시 백그라운드 동기화</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_online</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>background_sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>background_sync</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;클라우드와 비동기 동기화&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>unsync_events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>local_store</span> 
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>local_timestamp</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_sync</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>unsync_events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>sync_service</span><span class=o>.</span><span class=n>sync_to_cloud</span><span class=p>(</span><span class=n>unsync_events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>last_sync</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-aiml과-event-sourcing-통합>3. AI/ML과 Event Sourcing 통합<a hidden class=anchor aria-hidden=true href=#3-aiml과-event-sourcing-통합>#</a></h4><p><strong>트렌드</strong>: 이벤트 데이터를 활용한 실시간 머신러닝
<strong>응용 분야</strong>: 이상 탐지, 추천 시스템, 예측 분석</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17>17</a>
</span><span class=lnt id=hl-29-18><a class=lnlinks href=#hl-29-18>18</a>
</span><span class=lnt id=hl-29-19><a class=lnlinks href=#hl-29-19>19</a>
</span><span class=lnt id=hl-29-20><a class=lnlinks href=#hl-29-20>20</a>
</span><span class=lnt id=hl-29-21><a class=lnlinks href=#hl-29-21>21</a>
</span><span class=lnt id=hl-29-22><a class=lnlinks href=#hl-29-22>22</a>
</span><span class=lnt id=hl-29-23><a class=lnlinks href=#hl-29-23>23</a>
</span><span class=lnt id=hl-29-24><a class=lnlinks href=#hl-29-24>24</a>
</span><span class=lnt id=hl-29-25><a class=lnlinks href=#hl-29-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 실시간 ML 파이프라인과 Event Sourcing 통합</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MLEventProcessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_service</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model_service</span> <span class=o>=</span> <span class=n>model_service</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>feature_store</span> <span class=o>=</span> <span class=n>FeatureStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트 기반 실시간 ML 추론&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트로부터 피처 추출</span>
</span></span><span class=line><span class=cl>        <span class=n>features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>extract_features</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 실시간 추론</span>
</span></span><span class=line><span class=cl>        <span class=n>prediction</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_service</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>features</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이상 탐지 결과를 새로운 이벤트로 발행</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>prediction</span><span class=o>.</span><span class=n>is_anomaly</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>anomaly_event</span> <span class=o>=</span> <span class=n>AnomalyDetected</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>original_event_id</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>anomaly_score</span><span class=o>=</span><span class=n>prediction</span><span class=o>.</span><span class=n>score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>detected_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>publish_event</span><span class=p>(</span><span class=n>anomaly_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 피처 스토어 업데이트 (모델 재학습용)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>feature_store</span><span class=o>.</span><span class=n>update_features</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span> <span class=n>features</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=4-양자-컴퓨팅-시대의-event-sourcing>4. 양자 컴퓨팅 시대의 Event Sourcing<a hidden class=anchor aria-hidden=true href=#4-양자-컴퓨팅-시대의-event-sourcing>#</a></h4><p><strong>미래 전망</strong>: 양자 컴퓨팅 환경에서의 이벤트 암호화
<strong>고려사항</strong>: 양자 내성 암호화, 새로운 보안 패러다임</p><h3 id=기타-고급-사항-1>기타 고급 사항<a hidden class=anchor aria-hidden=true href=#기타-고급-사항-1>#</a></h3><h4 id=멀티-테넌트-event-sourcing>멀티 테넌트 Event Sourcing<a hidden class=anchor aria-hidden=true href=#멀티-테넌트-event-sourcing>#</a></h4><p><strong>도전과제</strong>: 테넌트 간 격리, 성능 분리, 데이터 주권</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a>
</span><span class=lnt id=hl-30-11><a class=lnlinks href=#hl-30-11>11</a>
</span><span class=lnt id=hl-30-12><a class=lnlinks href=#hl-30-12>12</a>
</span><span class=lnt id=hl-30-13><a class=lnlinks href=#hl-30-13>13</a>
</span><span class=lnt id=hl-30-14><a class=lnlinks href=#hl-30-14>14</a>
</span><span class=lnt id=hl-30-15><a class=lnlinks href=#hl-30-15>15</a>
</span><span class=lnt id=hl-30-16><a class=lnlinks href=#hl-30-16>16</a>
</span><span class=lnt id=hl-30-17><a class=lnlinks href=#hl-30-17>17</a>
</span><span class=lnt id=hl-30-18><a class=lnlinks href=#hl-30-18>18</a>
</span><span class=lnt id=hl-30-19><a class=lnlinks href=#hl-30-19>19</a>
</span><span class=lnt id=hl-30-20><a class=lnlinks href=#hl-30-20>20</a>
</span><span class=lnt id=hl-30-21><a class=lnlinks href=#hl-30-21>21</a>
</span><span class=lnt id=hl-30-22><a class=lnlinks href=#hl-30-22>22</a>
</span><span class=lnt id=hl-30-23><a class=lnlinks href=#hl-30-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 멀티 테넌트 이벤트 스토어</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiTenantEventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>partitioning_strategy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>partitioning_strategy</span> <span class=o>=</span> <span class=n>partitioning_strategy</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_stores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_tenant_store</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;테넌트별 전용 스토어 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tenant_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_stores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 테넌트별 별도 파티션/DB</span>
</span></span><span class=line><span class=cl>            <span class=n>partition_key</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>partitioning_strategy</span><span class=o>.</span><span class=n>get_partition</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>tenant_stores</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>(</span><span class=n>partition_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_stores</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;테넌트 격리된 이벤트 저장&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 테넌트 ID 검증</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>validate_tenant_access</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>UnauthorizedError</span><span class=p>(</span><span class=s2>&#34;Tenant access denied&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>store</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_tenant_store</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>store</span><span class=o>.</span><span class=n>append_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=지리적-분산-event-sourcing>지리적 분산 Event Sourcing<a hidden class=anchor aria-hidden=true href=#지리적-분산-event-sourcing>#</a></h4><p><strong>패턴</strong>: Active-Active 복제, 충돌 해결
<strong>기술</strong>: CRDT (Conflict-free Replicated Data Types), Vector Clocks</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1> 1</a>
</span><span class=lnt id=hl-31-2><a class=lnlinks href=#hl-31-2> 2</a>
</span><span class=lnt id=hl-31-3><a class=lnlinks href=#hl-31-3> 3</a>
</span><span class=lnt id=hl-31-4><a class=lnlinks href=#hl-31-4> 4</a>
</span><span class=lnt id=hl-31-5><a class=lnlinks href=#hl-31-5> 5</a>
</span><span class=lnt id=hl-31-6><a class=lnlinks href=#hl-31-6> 6</a>
</span><span class=lnt id=hl-31-7><a class=lnlinks href=#hl-31-7> 7</a>
</span><span class=lnt id=hl-31-8><a class=lnlinks href=#hl-31-8> 8</a>
</span><span class=lnt id=hl-31-9><a class=lnlinks href=#hl-31-9> 9</a>
</span><span class=lnt id=hl-31-10><a class=lnlinks href=#hl-31-10>10</a>
</span><span class=lnt id=hl-31-11><a class=lnlinks href=#hl-31-11>11</a>
</span><span class=lnt id=hl-31-12><a class=lnlinks href=#hl-31-12>12</a>
</span><span class=lnt id=hl-31-13><a class=lnlinks href=#hl-31-13>13</a>
</span><span class=lnt id=hl-31-14><a class=lnlinks href=#hl-31-14>14</a>
</span><span class=lnt id=hl-31-15><a class=lnlinks href=#hl-31-15>15</a>
</span><span class=lnt id=hl-31-16><a class=lnlinks href=#hl-31-16>16</a>
</span><span class=lnt id=hl-31-17><a class=lnlinks href=#hl-31-17>17</a>
</span><span class=lnt id=hl-31-18><a class=lnlinks href=#hl-31-18>18</a>
</span><span class=lnt id=hl-31-19><a class=lnlinks href=#hl-31-19>19</a>
</span><span class=lnt id=hl-31-20><a class=lnlinks href=#hl-31-20>20</a>
</span><span class=lnt id=hl-31-21><a class=lnlinks href=#hl-31-21>21</a>
</span><span class=lnt id=hl-31-22><a class=lnlinks href=#hl-31-22>22</a>
</span><span class=lnt id=hl-31-23><a class=lnlinks href=#hl-31-23>23</a>
</span><span class=lnt id=hl-31-24><a class=lnlinks href=#hl-31-24>24</a>
</span><span class=lnt id=hl-31-25><a class=lnlinks href=#hl-31-25>25</a>
</span><span class=lnt id=hl-31-26><a class=lnlinks href=#hl-31-26>26</a>
</span><span class=lnt id=hl-31-27><a class=lnlinks href=#hl-31-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 지리적 분산 이벤트 복제</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GeographicallyDistributedEventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>region</span><span class=p>,</span> <span class=n>peer_regions</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>region</span> <span class=o>=</span> <span class=n>region</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>peer_regions</span> <span class=o>=</span> <span class=n>peer_regions</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_clock</span> <span class=o>=</span> <span class=n>VectorClock</span><span class=p>(</span><span class=n>region</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>replicate_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;다중 리전에 이벤트 복제&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 벡터 클록으로 인과관계 추적</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span><span class=o>.</span><span class=n>vector_clock</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_clock</span><span class=o>.</span><span class=n>tick</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 로컬 저장</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>local_store</span><span class=o>.</span><span class=n>append_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 비동기 복제</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>region</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>peer_regions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>async_replicate_to_region</span><span class=p>(</span><span class=n>region</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>resolve_conflict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>local_event</span><span class=p>,</span> <span class=n>remote_event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;충돌 해결 알고리즘&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 비즈니스 로직 기반 충돌 해결</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_concurrent</span><span class=p>(</span><span class=n>local_event</span><span class=p>,</span> <span class=n>remote_event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>apply_business_rules</span><span class=p>(</span><span class=n>local_event</span><span class=p>,</span> <span class=n>remote_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 인과관계가 있는 경우 늦은 이벤트 선택</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_latest_by_causality</span><span class=p>(</span><span class=n>local_event</span><span class=p>,</span> <span class=n>remote_event</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=4단계-종합-정리>4단계: 종합 정리<a hidden class=anchor aria-hidden=true href=#4단계-종합-정리>#</a></h2><h3 id=내용-종합-1>내용 종합<a hidden class=anchor aria-hidden=true href=#내용-종합-1>#</a></h3><p>Event Sourcing은 단순한 데이터 저장 패턴을 넘어서 현대 분산 시스템의 핵심 아키텍처 패러다임으로 자리잡았습니다. <strong>불변 이벤트 로그</strong>를 통한 <strong>완벽한 감사 추적</strong>, <strong>시점별 상태 복원</strong>, <strong>확장 가능한 읽기 모델</strong>이라는 핵심 가치를 제공하며, 특히 <strong>금융</strong>, <strong>전자상거래</strong>, <strong>IoT</strong> 등 높은 신뢰성과 투명성이 요구되는 도메인에서 필수적인 기술로 인정받고 있습니다.</p><p><strong>최신 트렌드</strong>로는 <strong>서버리스 환경에서의 Event Sourcing</strong>, <strong>AI/ML과의 통합</strong>, <strong>엣지 컴퓨팅 환경에서의 경량화</strong>, <strong>다중 클라우드 환경에서의 일관성 관리</strong> 등이 주목받고 있으며, Apache Kafka, EventStore, AWS Kinesis 등의 기술 생태계가 지속적으로 발전하고 있습니다.</p><p>하지만 <strong>구현 복잡성</strong>, <strong>학습 곡선</strong>, <strong>운영 오버헤드</strong>라는 현실적 도전과제들이 존재하므로, 조직의 성숙도와 비즈니스 요구사항을 면밀히 검토한 후 단계적 도입이 권장됩니다.</p><h3 id=학습-로드맵>학습 로드맵<a hidden class=anchor aria-hidden=true href=#학습-로드맵>#</a></h3><h4 id=1단계-기초-개념-이해-2-3주>1단계: 기초 개념 이해 (2-3주)<a hidden class=anchor aria-hidden=true href=#1단계-기초-개념-이해-2-3주>#</a></h4><ul><li>Event Sourcing 기본 개념과 동기</li><li>CRUD vs Event Sourcing 차이점</li><li>간단한 도메인에서의 이벤트 모델링</li><li>기본적인 이벤트 스토어 구현 (SQLite/PostgreSQL)</li></ul><h4 id=2단계-실무-패턴-학습-4-6주>2단계: 실무 패턴 학습 (4-6주)<a hidden class=anchor aria-hidden=true href=#2단계-실무-패턴-학습-4-6주>#</a></h4><ul><li>CQRS 패턴과의 결합</li><li>프로젝션 설계 및 구현</li><li>스냅샷 전략</li><li>이벤트 버전 관리</li><li>기본적인 성능 최적화</li></ul><h4 id=3단계-분산-시스템-적용-6-8주>3단계: 분산 시스템 적용 (6-8주)<a hidden class=anchor aria-hidden=true href=#3단계-분산-시스템-적용-6-8주>#</a></h4><ul><li>마이크로서비스 아키텍처에서의 Event Sourcing</li><li>Apache Kafka를 활용한 이벤트 스트리밍</li><li>최종 일관성과 Saga 패턴</li><li>모니터링 및 관측성 구축</li></ul><h4 id=4단계-고급-주제-및-운영-8-12주>4단계: 고급 주제 및 운영 (8-12주)<a hidden class=anchor aria-hidden=true href=#4단계-고급-주제-및-운영-8-12주>#</a></h4><ul><li>대규모 이벤트 스트림 처리</li><li>다중 클라우드 환경에서의 이벤트 복제</li><li>보안 및 규정 준수 (GDPR, 금융 규제)</li><li>이벤트 스키마 진화 및 호환성 관리</li><li>프로덕션 환경 운영 노하우</li></ul><h4 id=5단계-전문가-수준-12주>5단계: 전문가 수준 (12주+)<a hidden class=anchor aria-hidden=true href=#5단계-전문가-수준-12주>#</a></h4><ul><li>지리적 분산 Event Sourcing</li><li>AI/ML 파이프라인과의 통합</li><li>서버리스 Event Sourcing 아키텍처</li><li>커스텀 이벤트 스토어 구현</li><li>업계별 특화 솔루션 설계</li></ul><h3 id=학습-항목-매트릭스-1>학습 항목 매트릭스<a hidden class=anchor aria-hidden=true href=#학습-항목-매트릭스-1>#</a></h3><table><thead><tr><th>카테고리</th><th>Phase</th><th>항목</th><th>중요도</th><th>설명</th></tr></thead><tbody><tr><td>기초</td><td>1</td><td>Event Sourcing 개념</td><td>필수</td><td>패턴의 기본 이해와 동기 파악</td></tr><tr><td>기초</td><td>1</td><td>이벤트 모델링</td><td>필수</td><td>비즈니스 이벤트를 코드로 표현하는 방법</td></tr><tr><td>기초</td><td>1</td><td>기본 Event Store 구현</td><td>필수</td><td>간단한 이벤트 저장소 직접 구현</td></tr><tr><td>이론</td><td>2</td><td>CQRS 패턴</td><td>필수</td><td>읽기/쓰기 분리를 통한 성능 최적화</td></tr><tr><td>이론</td><td>2</td><td>집계(Aggregate) 설계</td><td>필수</td><td>도메인 주도 설계의 핵심 개념</td></tr><tr><td>이론</td><td>2</td><td>이벤트 재생 메커니즘</td><td>필수</td><td>상태 재구성의 핵심 원리</td></tr><tr><td>구현</td><td>4</td><td>스냅샷 전략</td><td>권장</td><td>성능 최적화를 위한 필수 기법</td></tr><tr><td>구현</td><td>4</td><td>프로젝션 엔진 구현</td><td>권장</td><td>읽기 모델 생성 자동화</td></tr><tr><td>구현</td><td>5</td><td>Apache Kafka 활용</td><td>권장</td><td>엔터프라이즈급 이벤트 스트리밍</td></tr><tr><td>구현</td><td>5</td><td>마이크로서비스 통합</td><td>권장</td><td>실제 분산 시스템에서의 적용</td></tr><tr><td>운영</td><td>6</td><td>모니터링 시스템 구축</td><td>권장</td><td>프로덕션 환경 안정성 확보</td></tr><tr><td>운영</td><td>6</td><td>보안 및 암호화</td><td>권장</td><td>데이터 보호 및 규정 준수</td></tr><tr><td>운영</td><td>6</td><td>성능 튜닝</td><td>권장</td><td>대용량 처리를 위한 최적화</td></tr><tr><td>고급</td><td>7</td><td>이벤트 스키마 진화</td><td>선택</td><td>장기적 시스템 유지보수성</td></tr><tr><td>고급</td><td>7</td><td>지리적 분산 처리</td><td>선택</td><td>글로벌 서비스를 위한 고급 기법</td></tr><tr><td>고급</td><td>7</td><td>AI/ML 파이프라인 통합</td><td>선택</td><td>차세대 지능형 시스템 구축</td></tr><tr><td>고급</td><td>7</td><td>커스텀 Event Store</td><td>선택</td><td>특수 요구사항을 위한 전문 지식</td></tr></tbody></table><h3 id=우선순위별-학습-가이드>우선순위별 학습 가이드<a hidden class=anchor aria-hidden=true href=#우선순위별-학습-가이드>#</a></h3><p><strong>1순위 (필수 역량)</strong>:</p><ul><li>Event Sourcing 기본 개념과 CQRS 패턴 이해</li><li>간단한 도메인에서의 이벤트 모델링 능력</li><li>기본적인 이벤트 스토어 구현 경험</li><li>프로젝션 설계 및 구현 능력</li></ul><p><strong>2순위 (실무 적용)</strong>:</p><ul><li>Apache Kafka 등 상용 도구 활용 능력</li><li>마이크로서비스 환경에서의 통합 경험</li><li>성능 최적화 및 모니터링 구축</li><li>기본적인 보안 및 운영 지식</li></ul><p><strong>3순위 (전문성 강화)</strong>:</p><ul><li>대규모 시스템에서의 운영 경험</li><li>복잡한 비즈니스 도메인에서의 모델링</li><li>고급 패턴 및 최신 기술 트렌드 이해</li><li>조직 내 Event Sourcing 전파 및 교육</li></ul><hr><h2 id=용어-정리-1>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리-1>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>정의</th><th>관련 개념</th></tr></thead><tbody><tr><td>핵심</td><td><strong>Event Sourcing (이벤트 소싱)</strong></td><td>상태 변화를 이벤트 시퀀스로 저장하는 아키텍처 패턴</td><td>CQRS, DDD, 감사 로그</td></tr><tr><td>핵심</td><td><strong>Event Store (이벤트 스토어)</strong></td><td>이벤트를 영구 저장하는 append-only 데이터베이스</td><td>이벤트 로그, 영속성</td></tr><tr><td>핵심</td><td><strong>Aggregate (집계)</strong></td><td>비즈니스 일관성의 경계를 나타내는 도메인 객체</td><td>DDD, 트랜잭션 경계</td></tr><tr><td>핵심</td><td><strong>Event Replay (이벤트 재생)</strong></td><td>저장된 이벤트를 순차적으로 재생하여 상태를 재구성하는 과정</td><td>상태 복원, 디버깅</td></tr><tr><td>구현</td><td><strong>CQRS (Command Query Responsibility Segregation)</strong></td><td>명령과 쿼리의 책임을 분리하는 패턴</td><td>읽기/쓰기 분리, 성능 최적화</td></tr><tr><td>구현</td><td><strong>Projection (프로젝션)</strong></td><td>이벤트로부터 생성되는 읽기 최적화된 뷰</td><td>구체화된 뷰, 비정규화</td></tr><tr><td>구현</td><td><strong>Snapshot (스냅샷)</strong></td><td>특정 시점의 집계 상태를 저장한 최적화 기법</td><td>성능 튜닝, 메모이제이션</td></tr><tr><td>구현</td><td><strong>Event Handler (이벤트 핸들러)</strong></td><td>특정 이벤트 타입을 처리하는 컴포넌트</td><td>이벤트 리스너, 구독자</td></tr><tr><td>운영</td><td><strong>Event Bus (이벤트 버스)</strong></td><td>이벤트 라우팅 및 배포를 담당하는 메시징 인프라</td><td>메시지 브로커, 발행-구독</td></tr><tr><td>운영</td><td><strong>Compensating Event (보상 이벤트)</strong></td><td>이전 이벤트의 효과를 상쇄하는 새로운 이벤트</td><td>취소, 롤백, Saga 패턴</td></tr><tr><td>운영</td><td><strong>Event Schema Evolution (이벤트 스키마 진화)</strong></td><td>이벤트 구조 변경에 대한 하위 호환성 관리</td><td>버전 관리, 업캐스팅</td></tr><tr><td>운영</td><td><strong>Eventual Consistency (최종 일관성)</strong></td><td>시간이 지나면서 모든 노드가 일관된 상태에 도달하는 특성</td><td>분산 시스템, CAP 정리</td></tr><tr><td>고급</td><td><strong>Saga Pattern (사가 패턴)</strong></td><td>분산 트랜잭션을 여러 단계로 나누어 관리하는 패턴</td><td>분산 트랜잭션, 보상 트랜잭션</td></tr><tr><td>고급</td><td><strong>Event Upcasting (이벤트 업캐스팅)</strong></td><td>오래된 이벤트를 새로운 스키마로 변환하는 과정</td><td>스키마 마이그레이션, 호환성</td></tr><tr><td>고급</td><td><strong>Crypto-shredding (암호 샤딩)</strong></td><td>암호화 키 삭제를 통한 데이터 삭제 기법</td><td>GDPR 준수, 개인정보 보호</td></tr></tbody></table><hr><h2 id=참고-및-출처-1>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-1>#</a></h2><h3 id=공식-문서-및-표준>공식 문서 및 표준<a hidden class=anchor aria-hidden=true href=#공식-문서-및-표준>#</a></h3><ul><li><a href=https://cloudevents.io/>CloudEvents 표준 (CNCF)</a> - 클라우드 이벤트 상호 운용성 표준</li><li><a href=https://kafka.apache.org/documentation/>Apache Kafka 공식 문서</a> - 분산 스트리밍 플랫폼</li><li><a href=https://www.eventstore.com/documentation>EventStore DB 공식 문서</a> - 이벤트 소싱 전용 데이터베이스</li><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing>Microsoft Azure Event Sourcing 패턴</a> - 클라우드 아키텍처 패턴</li></ul><h3 id=기술-블로그-및-실무-사례>기술 블로그 및 실무 사례<a hidden class=anchor aria-hidden=true href=#기술-블로그-및-실무-사례>#</a></h3><ul><li><a href=https://martinfowler.com/eaaDev/EventSourcing.html>Martin Fowler의 Event Sourcing 분석</a> - 패턴의 창시자가 직접 설명</li><li><a href=https://netflixtechblog.com/>Netflix 기술 블로그 - 분산 카운터 시스템</a> - 대규모 실시간 이벤트 처리 사례</li><li><a href=https://www.confluent.io/blog/event-sourcing-cqrs-stream-processing-apache-kafka-whats-connection/>Confluent 블로그 - Kafka Event Sourcing</a> - Kafka와 Event Sourcing 연계</li><li><a href=https://eventuate.io/exampleapps.html>Eventuate 플랫폼 사례</a> - 실제 구현 예제 모음</li></ul><h3 id=학술-자료-및-연구>학술 자료 및 연구<a hidden class=anchor aria-hidden=true href=#학술-자료-및-연구>#</a></h3><ul><li><a href=https://hal.inria.fr/inria-00555588/document>CRDT (Conflict-free Replicated Data Types) 논문</a> - 분산 일관성 이론</li><li><a href=https://people.eecs.berkeley.edu/~brewer/cs262b-2004/PODC-keynote.pdf>CAP 정리와 Event Sourcing</a> - 분산 시스템 이론적 배경</li><li><a href=https://www.domainlanguage.com/ddd/>Domain-Driven Design 원서</a> - Eric Evans의 원서</li></ul><h3 id=기업-기술-사례-및-백서>기업 기술 사례 및 백서<a hidden class=anchor aria-hidden=true href=#기업-기술-사례-및-백서>#</a></h3><ul><li><a href=https://aws.amazon.com/event-driven-architecture/>AWS Event-Driven Architecture 모범 사례</a> - 클라우드 네이티브 구현</li><li><a href=https://cloud.google.com/pubsub/docs/overview>Google Cloud Pub/Sub 아키텍처</a> - 메시징 인프라 설계</li><li><a href=https://engineering.atspotify.com/>Spotify 마이크로서비스 이벤트 아키텍처</a> - 대규모 실무 적용 사례</li></ul><h3 id=오픈소스-프로젝트>오픈소스 프로젝트<a hidden class=anchor aria-hidden=true href=#오픈소스-프로젝트>#</a></h3><ul><li><a href=https://axoniq.io/product-overview/axon-framework>Axon Framework</a> - Java 기반 Event Sourcing 프레임워크</li><li><a href=https://eventsauce.io/>EventSauce</a> - PHP 기반 Event Sourcing 라이브러리</li><li><a href=https://wolverinefx.net/>Wolverine</a> - .NET 기반 메시징 플랫폼</li></ul><h3 id=커뮤니티-및-포럼>커뮤니티 및 포럼<a hidden class=anchor aria-hidden=true href=#커뮤니티-및-포럼>#</a></h3><ul><li><a href=https://github.com/ddd-community>DDD Community</a> - 도메인 주도 설계 커뮤니티</li><li><a href=https://groups.google.com/forum/#!forum/event-store>Event Store Users Google Group</a> - Event Store 사용자 커뮤니티</li><li><a href=https://kafka.apache.org/contact>Apache Kafka Users</a> - Kafka 사용자 지원</li></ul><h3 id=도서-추천>도서 추천<a hidden class=anchor aria-hidden=true href=#도서-추천>#</a></h3><ul><li><strong>&ldquo;Implementing Domain-Driven Design&rdquo;</strong> by Vaughn Vernon - DDD와 Event Sourcing 실무 적용</li><li><strong>&ldquo;Microservices Patterns&rdquo;</strong> by Chris Richardson - 마이크로서비스 아키텍처에서의 Event Sourcing</li><li><strong>&ldquo;Building Event-Driven Microservices&rdquo;</strong> by Adam Bellemare - 이벤트 중심 아키텍처 구축 가이드</li><li><strong>&ldquo;Kafka: The Definitive Guide&rdquo;</strong> by Neha Narkhede - Apache Kafka 완전 정복</li></ul><p>이상으로 Event Sourcing에 대한 종합적인 기술 분석을 완료했습니다. 이 문서는 기초 개념부터 고급 운영 기법까지 체계적으로 다루었으며, 실무 적용을 위한 구체적인 가이드라인과 최신 기술 트렌드를 포함하고 있습니다. 조직의 필요에 따라 단계적으로 학습하고 적용하시기 바랍니다.</p><hr><p>좋습니다. 주어진 작업 순서(## 9. 작업 순서)에 맞춰 <strong>Event Sourcing</strong> 주제를 심층 분석하겠습니다.
우선 <strong>1단계: 기본 분석</strong>부터 진행하겠습니다.</p><hr><h2 id=1단계-기본-분석-2><strong>1단계: 기본 분석</strong><a hidden class=anchor aria-hidden=true href=#1단계-기본-분석-2>#</a></h2><h3 id=1-대표-태그-생성-1>1. 대표 태그 생성<a hidden class=anchor aria-hidden=true href=#1-대표-태그-생성-1>#</a></h3><ul><li>Event-Sourcing</li><li>Event-Driven-Architecture</li><li>CQRS (Command Query Responsibility Segregation)</li><li>Event-Store</li></ul><hr><h3 id=2-분류-체계-검증-1>2. 분류 체계 검증<a hidden class=anchor aria-hidden=true href=#2-분류-체계-검증-1>#</a></h3><p>현재 분류:</p><blockquote><p>Software Engineering > Design and Architecture > Architecture Styles > Messaging-Oriented Architecture > Event-Driven Architecture > Event Patterns</p></blockquote><p><strong>검증 결과:</strong> 적합함.</p><ul><li>Event Sourcing은 Event-Driven Architecture의 <strong>구현 패턴 중 하나</strong>이며, 특히 &ldquo;이벤트 패턴&rdquo; 범주에 속함.</li><li>다만, Event Sourcing은 <strong>데이터 저장 전략</strong>의 성격도 강하므로 &ldquo;Database Systems > Event Store&rdquo; 같은 서브 카테고리와의 교차 분류 가능.</li></ul><p><strong>개선 제안:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1>1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2>2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3>3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4>4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5>5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6>6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7>7</a>
</span><span class=lnt id=hl-32-8><a class=lnlinks href=#hl-32-8>8</a>
</span><span class=lnt id=hl-32-9><a class=lnlinks href=#hl-32-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Software Engineering
</span></span><span class=line><span class=cl> └─ Design and Architecture
</span></span><span class=line><span class=cl>     └─ Architecture Styles
</span></span><span class=line><span class=cl>         └─ Event-Driven Architecture
</span></span><span class=line><span class=cl>             └─ Event Patterns
</span></span><span class=line><span class=cl>                 └─ Event Sourcing
</span></span><span class=line><span class=cl>System Design
</span></span><span class=line><span class=cl> └─ Database Systems
</span></span><span class=line><span class=cl>     └─ Event Store
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=3-핵심-요약-250자-이내>3. 핵심 요약 (250자 이내)<a hidden class=anchor aria-hidden=true href=#3-핵심-요약-250자-이내>#</a></h3><p>Event Sourcing은 애플리케이션 상태를 현재 값으로 저장하는 대신, 모든 상태 변화를 나타내는 이벤트를 순차적으로 저장하는 패턴이다. 이를 통해 이벤트 재생으로 상태 복원, 감사 추적, CQRS와의 결합 등 강력한 이점을 제공한다.</p><hr><h3 id=4-전체-개요-400자-이내>4. 전체 개요 (400자 이내)<a hidden class=anchor aria-hidden=true href=#4-전체-개요-400자-이내>#</a></h3><p>Event Sourcing은 데이터베이스에 현재 상태를 저장하는 대신, 상태 변화 자체를 이벤트로 기록하는 아키텍처 패턴이다. 모든 변경은 불변 이벤트로 저장되며, 시스템 상태는 이벤트 스트림을 재생하여 복원된다. 이 접근 방식은 감사 추적(audit trail), 변경 내역 재구성, 복잡한 비즈니스 로직의 재처리 등에 유리하며, CQRS 패턴과 자주 함께 사용된다. 다만, 이벤트 저장소 설계, 이벤트 스키마 버전 관리, 재생 성능 문제 등이 고려사항이다.</p><hr><p>좋아, <strong>2단계부터 4단계까지</strong> 요구한 형식에 맞춰 깊이 있게 이어가겠다. (도식, 표, 코드, 실무 팁 포함)</p><hr><h2 id=2단계-핵심-분석-2>2단계: 핵심 분석<a hidden class=anchor aria-hidden=true href=#2단계-핵심-분석-2>#</a></h2><h3 id=5-핵심-개념-정리-이론실무기본심화>5. 핵심 개념 정리 (이론/실무/기본/심화)<a hidden class=anchor aria-hidden=true href=#5-핵심-개념-정리-이론실무기본심화>#</a></h3><ul><li><strong>이벤트(Event)</strong>: 도메인에서 발생한 <strong>사실(fact)</strong>. 불변(Immutable)이며 순서가 중요. 예: <code>OrderPlaced</code>, <code>PaymentCaptured</code>. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li><li><strong>이벤트 스트림(Event Stream)</strong>: 특정 Aggregate(집계 루트)의 시간 순 이벤트 목록. Append-only가 원칙. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>이벤트 스토어(Event Store)</strong>: 이벤트를 영속화하는 저장소. 단일 진실 공급원(SSOT). 스냅샷, 버전, 낙관적 잠금(Optimistic Concurrency) 지원이 핵심. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>리플레이(Replay)</strong>: 이벤트를 순서대로 적용하여 현재 상태 재구성. 감사 추적(Audit) 및 재처리에 유용. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li><li><strong>CQRS(Command Query Responsibility Segregation)</strong>: 쓰기(커맨드)와 읽기(쿼리) 모델 분리. ES와 자주 결합. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>업캐스터(Upcaster)</strong>: 과거 이벤트 스키마를 최신 모델로 점진 변환하는 계층. (심화 주제, 실무 필수)</li><li><strong>스냅샷(Snapshot)</strong>: 주기적으로 상태 요약본 저장해 리플레이 비용 절감.</li><li><strong>이벤트 발행/구독(Outbox/충분히 내구적인 발행)</strong>: 트랜잭션 경계에서 메시지 일관성 보장.</li></ul><h3 id=6-실무-연관성-분석-1>6. 실무 연관성 분석<a hidden class=anchor aria-hidden=true href=#6-실무-연관성-분석-1>#</a></h3><ul><li><strong>데이터 모델링</strong>: 상태 저장 대신 “사건을 모델링”. 규제 산업(금융/헬스)에서 <strong>감사 추적</strong> 및 <strong>소급 변경</strong>에 강함. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li><li><strong>확장성/성능</strong>: Append-only 쓰기는 쓰기 경합 적고 파티셔닝 용이. Read 모델은 물질화 뷰(Materialized View)로 독립 확장. Cosmos DB의 Change Feed 등 클라우드 특성 활용 가능. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">Microsoft for Developers</a>)</li><li><strong>복잡성 관리</strong>: 이벤트 버전 관리, 업캐스터/다운스트림 리더(리드 모델) 호환성 전략 필요.</li><li><strong>운영</strong>: 리플레이/리드 모델 리빌드에 대한 <strong>SLO</strong>와 <strong>백필(Backfill) 절차</strong> 정의가 핵심.</li></ul><hr><h2 id=3단계-상세-조사-1>3단계: 상세 조사<a hidden class=anchor aria-hidden=true href=#3단계-상세-조사-1>#</a></h2><h3 id=phase-1-기초-이해-1>Phase 1: 기초 이해<a hidden class=anchor aria-hidden=true href=#phase-1-기초-이해-1>#</a></h3><h4 id=개념-정의-및-본질-1>개념 정의 및 본질<a hidden class=anchor aria-hidden=true href=#개념-정의-및-본질-1>#</a></h4><ul><li><strong>정의</strong>: 현재 상태를 저장하는 대신, <strong>상태 변화를 일으킨 모든 이벤트</strong>를 순차적으로 저장하고, 이 이벤트들을 재적용해 상태를 얻는 패턴. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li></ul><h4 id=등장-배경-및-발전-과정-1>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정-1>#</a></h4><ul><li><strong>배경</strong>: 감사/규제 요구, 고성능 거래 시스템(예: LMAX)에서 <strong>결정적 재현성</strong>과 <strong>저지연</strong> 필요성으로 채택. (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">martinfowler.com</a>)</li><li><strong>발전</strong>: Greg Young이 CQRS와 함께 대중화, EventStoreDB 등 전용 스토어/도구 등장. (<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">InfoQ</a>)</li></ul><h4 id=핵심-동기-및-가치-제안-1>핵심 동기 및 가치 제안<a hidden class=anchor aria-hidden=true href=#핵심-동기-및-가치-제안-1>#</a></h4><ul><li><strong>감사 가능성</strong>: 과거 모든 상태와 경로 재현.</li><li><strong>소급 수정/재처리</strong>: 비즈니스 규칙 변경 시 이벤트 재처리로 재산출 가능.</li><li><strong>확장성</strong>: 읽기/쓰기 분리(CQRS)로 독립 확장. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">Microsoft Learn</a>)</li></ul><h4 id=주요-특징-기술적-특징--근거>주요 특징 (기술적 특징 + 근거)<a hidden class=anchor aria-hidden=true href=#주요-특징-기술적-특징--근거>#</a></h4><ul><li><strong>Append-only 이벤트 로그</strong>: 불변성, 순서성 보장. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>리플레이 가능성</strong>: 상태는 1차 파생물, 이벤트가 1급 데이터. (<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">YouTube</a>)</li><li><strong>모델 진화 가능성</strong>: 업캐스팅/멀티 리드 모델 허용. (실무 관행)</li></ul><hr><h3 id=phase-2-핵심-이론-1>Phase 2: 핵심 이론<a hidden class=anchor aria-hidden=true href=#phase-2-핵심-이론-1>#</a></h3><h4 id=핵심-설계-원칙-1>핵심 설계 원칙<a hidden class=anchor aria-hidden=true href=#핵심-설계-원칙-1>#</a></h4><ul><li><strong>단일 진실 공급원(SSOT)</strong>: 이벤트 스토어가 권위 있는 소스. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>Aggregate 경계 내 불변식 유지</strong>: 커맨드 처리 시 도메인 규칙 검증 후 <strong>도메인 이벤트</strong> 발행.</li><li><strong>낙관적 동시성</strong>: 기대 버전(Expected Version)으로 동시 업데이트 검출.</li><li><strong>Idempotency(멱등성)</strong>: 재시도/중복 소비 대비.</li></ul><h4 id=기본-원리-및-동작-메커니즘-도식>기본 원리 및 동작 메커니즘 (도식)<a hidden class=anchor aria-hidden=true href=#기본-원리-및-동작-메커니즘-도식>#</a></h4><pre class=mermaid>sequenceDiagram
  participant Client
  participant CommandAPI
  participant Aggregate
  participant EventStore
  participant Projector(Read)
  participant QueryAPI

  Client-&gt;&gt;CommandAPI: PlaceOrder(cmd)
  CommandAPI-&gt;&gt;Aggregate: load(events)
  Aggregate-&gt;&gt;Aggregate: validate &amp; decide
  Aggregate--&gt;&gt;CommandAPI: DomainEvent(OrderPlaced)
  CommandAPI-&gt;&gt;EventStore: append(event, expectedVersion)
  EventStore--&gt;&gt;Projector(Read): publish(event)
  Projector(Read)-&gt;&gt;ReadDB: upsert(materialized view)
  Client-&gt;&gt;QueryAPI: GET /orders/{id}
  QueryAPI-&gt;&gt;ReadDB: select
  ReadDB--&gt;&gt;Client: current view
</pre><h4 id=아키텍처-및-구성-요소-1>아키텍처 및 구성 요소<a hidden class=anchor aria-hidden=true href=#아키텍처-및-구성-요소-1>#</a></h4><ul><li><strong>필수</strong>: Command API, Aggregate, Event Store, Projector(리드 모델 빌더), Query API</li><li><strong>선택</strong>: Snapshotter, Upcaster, Outbox, Saga/Process Manager, Schema Registry</li></ul><h4 id=주요-기능과-역할-1>주요 기능과 역할<a hidden class=anchor aria-hidden=true href=#주요-기능과-역할-1>#</a></h4><ul><li><strong>Aggregate</strong>: 명령 검증/의사결정 → 이벤트 산출</li><li><strong>Event Store</strong>: Append, 읽기(스트림), 동시성 제어, 스냅샷</li><li><strong>Projector</strong>: 이벤트→리드 모델 투영</li><li><strong>Upcaster</strong>: 과거 이벤트 포맷을 최신으로 변환</li></ul><hr><h3 id=phase-3-특성-분석-1>Phase 3: 특성 분석<a hidden class=anchor aria-hidden=true href=#phase-3-특성-분석-1>#</a></h3><h4 id=장점-및-이점-표>장점 및 이점 (표)<a hidden class=anchor aria-hidden=true href=#장점-및-이점-표>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>기술적 근거</th></tr></thead><tbody><tr><td>장점</td><td>감사 추적</td><td>모든 상태 변화가 이벤트로 보존</td><td>이벤트 로그 재생과 과거 시점 조회 가능 (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</td></tr><tr><td>장점</td><td>모델 진화</td><td>리드 모델을 자유롭게 재구성</td><td>리플레이로 새 물질화 뷰 생성 (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>)</td></tr><tr><td>장점</td><td>확장성</td><td>읽기/쓰기 독립 확장</td><td>CQRS 결합 시 Read/Write 분리 (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">Microsoft Learn</a>)</td></tr><tr><td>장점</td><td>성능</td><td>Append-only 쓰기 경합↓</td><td>순차 쓰기/파티셔닝 용이(실무 관행), Change Feed 응용 (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">Microsoft for Developers</a>)</td></tr></tbody></table><h4 id=단점-및-제약--해결방안-표>단점 및 제약 + 해결방안 (표)<a hidden class=anchor aria-hidden=true href=#단점-및-제약--해결방안-표>#</a></h4><p>단점</p><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th><th>대안 기술</th></tr></thead><tbody><tr><td>단점</td><td>복잡한 설계</td><td>이벤트 모델링, 업캐스팅 필요</td><td>이벤트 스키마 규율, 계약 테스트, Schema Registry</td><td>단순 CRUD, SCD(Slowly Changing Dimension)</td></tr><tr><td>단점</td><td>리플레이 비용</td><td>대규모 스트림 리플레이 느림</td><td>스냅샷, 체크포인트, 파티션, Batch 리플레이</td><td>CDC(Change Data Capture)</td></tr><tr><td>단점</td><td>데이터 삭제/수정</td><td>GDPR 삭제 요구와 불변 로그 충돌</td><td>토큰화/암호화 키 삭제, 이벤트 보정 이벤트 추가</td><td>소프트 삭제 CRUD</td></tr><tr><td>단점</td><td>운영 난이도</td><td>멱등성/재처리/순서 보장 과제</td><td>멱등키, Exactly-once는 지양·At-least-once+보정</td><td>2PC(비권장), Sagas</td></tr></tbody></table><p>문제점</p><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지/진단</th><th>예방 방법</th><th>해결 기법</th></tr></thead><tbody><tr><td>문제점</td><td>이벤트 중복</td><td>재시도/네트워크 장애</td><td>중복 투영/불일치</td><td>중복율 메트릭, 리드 모델 불일치 탐지</td><td>멱등키 저장</td><td>Upsert with unique constraint</td></tr><tr><td>문제점</td><td>이벤트 순서 역전</td><td>파티션/샤딩 이슈</td><td>불변식 위반 위험</td><td>Lag/Partition skew 모니터</td><td>키 기반 파티셔닝</td><td>Aggregate 단일 파티션 보장</td></tr><tr><td>문제점</td><td>버전 충돌</td><td>동시 업데이트</td><td>쓰기 실패/유실</td><td>ExpectedVersion 오류율</td><td>낙관적 잠금</td><td>재시도+리드 모델 보정</td></tr></tbody></table><h4 id=트레이드오프>트레이드오프<a hidden class=anchor aria-hidden=true href=#트레이드오프>#</a></h4><ul><li><strong>감사/재현성 vs. 복잡성</strong></li><li><strong>At-least-once 처리 vs. Exactly-once 환상</strong>: 현실적으로 멱등성과 재처리 전략이 핵심.</li><li><strong>강한 일관성 vs. 최종 일관성</strong>: 읽기는 최종 일관성이 일반적.</li></ul><hr><h3 id=phase-4-구현-및-분류-1>Phase 4: 구현 및 분류<a hidden class=anchor aria-hidden=true href=#phase-4-구현-및-분류-1>#</a></h3><h4 id=구현-기법-및-방법-정의구성목적예시>구현 기법 및 방법 (정의/구성/목적/예시)<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법-정의구성목적예시>#</a></h4><ul><li><p><strong>스토리지 선택</strong></p><ul><li><strong>전용</strong>: EventStoreDB(스트림·버전·프로젝션 1급 지원). (<a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>GitHub</a>)</li><li><strong>범용 DB</strong>: PostgreSQL(append 테이블+인덱스), NoSQL(파티셔닝).</li><li><strong>클라우드</strong>: Cosmos DB + Change Feed로 투영. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">Microsoft for Developers</a>)</li></ul></li><li><p><strong>스키마 전략</strong></p><ul><li><strong>이벤트 명세</strong>: 타입, 버전, 발생 시각, Aggregate ID, 시퀀스, 페이로드(스키마드 JSON/Avro).</li><li><strong>버전 관리</strong>: <strong>Upcaster</strong>/하위 호환 필드 추가 원칙.</li></ul></li><li><p><strong>동시성/멱등성</strong></p><ul><li>ExpectedVersion로 단일-작성 보장, 멱등키로 중복 커맨드 방지.</li></ul></li><li><p><strong>투영/물질화 뷰</strong></p><ul><li>이벤트 핸들러가 Read 모델을 Upsert. 장애 시 체크포인트 오프셋으로 재처리.</li></ul></li></ul><h4 id=분류-기준에-따른-유형-표>분류 기준에 따른 유형 (표)<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-유형-표>#</a></h4><table><thead><tr><th>기준</th><th>유형</th><th>설명</th><th>사용 맥락</th></tr></thead><tbody><tr><td>저장 형태</td><td>전용 이벤트 스토어</td><td>EventStoreDB 등</td><td>풍부한 스트림/프로젝션, 고도 기능 필요</td></tr><tr><td>저장 형태</td><td>범용 DB 기반</td><td>RDBMS/NoSQL</td><td>팀 기술 적합성, 비용/운영 단순화</td></tr><tr><td>읽기 모델</td><td>동기 투영</td><td>트랜잭션 내 투영</td><td>간단한 시스템, 강한 일관성 선호</td></tr><tr><td>읽기 모델</td><td>비동기 투영</td><td>큐/체인지피드 사용</td><td>확장성/격리</td></tr><tr><td>이벤트 스키마</td><td>진화형(업캐스팅)</td><td>v1→vN</td><td>장기 수명, 점진 이행</td></tr><tr><td>이벤트 스키마</td><td>고정형(교체)</td><td>하위 호환 없이 교체</td><td>내부 도구, 짧은 수명</td></tr></tbody></table><hr><h3 id=phase-5-실무-적용-1>Phase 5: 실무 적용<a hidden class=anchor aria-hidden=true href=#phase-5-실무-적용-1>#</a></h3><h4 id=실제-도입-사례-요약>실제 도입 사례 (요약)<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-요약>#</a></h4><ul><li><strong>금융 트레이딩(LMAX)</strong>: 초저지연 단일 스레드 처리+이벤트 소싱으로 초고성능 달성. (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">martinfowler.com</a>)</li><li><strong>마이크로서비스(CQRS)</strong>: Azure 아키텍처 가이드에서 ES+CQRS 조합 권장 시나리오 제시. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>클라우드 NoSQL(Cosmos DB)</strong>: Change Feed로 리드 모델/머티리얼라이즈드 뷰 실시간 구축. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">Microsoft for Developers</a>)</li></ul><h4 id=실습-예제-및-코드-구현-2>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현-2>#</a></h4><p><strong>시나리오</strong>: 전자상거래의 주문 수명주기(<code>OrderPlaced</code> → <code>ItemAdded</code> → <code>Paid</code> → <code>Shipped</code>)
<strong>시스템 구성</strong>:</p><ul><li>Command API (FastAPI/Express), Event Store(PostgreSQL), Projector(비동기 워커), Read DB(PostgreSQL 별도 스키마)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
  C[Client] --&gt; A[Command API]
  A --&gt; ES[(Event Store)]
  ES --&gt; W[Projector Worker]
  W --&gt; R[(Read DB)]
  C --&gt; Q[Query API]
  Q --&gt; R
</pre><p><strong>Workflow</strong>:</p><ol><li>Command API가 Aggregate 이벤트를 생성 후 Event Store에 Append(낙관적 잠금).</li><li>Projector가 오프셋 체크포인트를 읽고 미투영 이벤트를 읽어 Read DB에 Upsert.</li><li>Query API는 Read DB만 조회.</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>Event Sourcing이 <strong>쓰기 모델</strong>의 단일 진실 공급원.</li><li>Read 모델은 <strong>투영의 결과물</strong>로 최종 일관성.</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 상태만 저장, 과거 경로 추적 어려움, 모델 변경 시 마이그레이션 부담 큼.</li><li>도입 후: 이벤트 재생으로 과거/새 모델 재구성 용이, 감사/디버깅 강화.</li></ul><p><strong>구현 예시 – Python (FastAPI + PostgreSQL)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a class=lnlinks href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a class=lnlinks href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a class=lnlinks href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a class=lnlinks href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a class=lnlinks href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a class=lnlinks href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a class=lnlinks href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a class=lnlinks href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a class=lnlinks href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a class=lnlinks href=#hl-35-10>10</a>
</span><span class=lnt id=hl-35-11><a class=lnlinks href=#hl-35-11>11</a>
</span><span class=lnt id=hl-35-12><a class=lnlinks href=#hl-35-12>12</a>
</span><span class=lnt id=hl-35-13><a class=lnlinks href=#hl-35-13>13</a>
</span><span class=lnt id=hl-35-14><a class=lnlinks href=#hl-35-14>14</a>
</span><span class=lnt id=hl-35-15><a class=lnlinks href=#hl-35-15>15</a>
</span><span class=lnt id=hl-35-16><a class=lnlinks href=#hl-35-16>16</a>
</span><span class=lnt id=hl-35-17><a class=lnlinks href=#hl-35-17>17</a>
</span><span class=lnt id=hl-35-18><a class=lnlinks href=#hl-35-18>18</a>
</span><span class=lnt id=hl-35-19><a class=lnlinks href=#hl-35-19>19</a>
</span><span class=lnt id=hl-35-20><a class=lnlinks href=#hl-35-20>20</a>
</span><span class=lnt id=hl-35-21><a class=lnlinks href=#hl-35-21>21</a>
</span><span class=lnt id=hl-35-22><a class=lnlinks href=#hl-35-22>22</a>
</span><span class=lnt id=hl-35-23><a class=lnlinks href=#hl-35-23>23</a>
</span><span class=lnt id=hl-35-24><a class=lnlinks href=#hl-35-24>24</a>
</span><span class=lnt id=hl-35-25><a class=lnlinks href=#hl-35-25>25</a>
</span><span class=lnt id=hl-35-26><a class=lnlinks href=#hl-35-26>26</a>
</span><span class=lnt id=hl-35-27><a class=lnlinks href=#hl-35-27>27</a>
</span><span class=lnt id=hl-35-28><a class=lnlinks href=#hl-35-28>28</a>
</span><span class=lnt id=hl-35-29><a class=lnlinks href=#hl-35-29>29</a>
</span><span class=lnt id=hl-35-30><a class=lnlinks href=#hl-35-30>30</a>
</span><span class=lnt id=hl-35-31><a class=lnlinks href=#hl-35-31>31</a>
</span><span class=lnt id=hl-35-32><a class=lnlinks href=#hl-35-32>32</a>
</span><span class=lnt id=hl-35-33><a class=lnlinks href=#hl-35-33>33</a>
</span><span class=lnt id=hl-35-34><a class=lnlinks href=#hl-35-34>34</a>
</span><span class=lnt id=hl-35-35><a class=lnlinks href=#hl-35-35>35</a>
</span><span class=lnt id=hl-35-36><a class=lnlinks href=#hl-35-36>36</a>
</span><span class=lnt id=hl-35-37><a class=lnlinks href=#hl-35-37>37</a>
</span><span class=lnt id=hl-35-38><a class=lnlinks href=#hl-35-38>38</a>
</span><span class=lnt id=hl-35-39><a class=lnlinks href=#hl-35-39>39</a>
</span><span class=lnt id=hl-35-40><a class=lnlinks href=#hl-35-40>40</a>
</span><span class=lnt id=hl-35-41><a class=lnlinks href=#hl-35-41>41</a>
</span><span class=lnt id=hl-35-42><a class=lnlinks href=#hl-35-42>42</a>
</span><span class=lnt id=hl-35-43><a class=lnlinks href=#hl-35-43>43</a>
</span><span class=lnt id=hl-35-44><a class=lnlinks href=#hl-35-44>44</a>
</span><span class=lnt id=hl-35-45><a class=lnlinks href=#hl-35-45>45</a>
</span><span class=lnt id=hl-35-46><a class=lnlinks href=#hl-35-46>46</a>
</span><span class=lnt id=hl-35-47><a class=lnlinks href=#hl-35-47>47</a>
</span><span class=lnt id=hl-35-48><a class=lnlinks href=#hl-35-48>48</a>
</span><span class=lnt id=hl-35-49><a class=lnlinks href=#hl-35-49>49</a>
</span><span class=lnt id=hl-35-50><a class=lnlinks href=#hl-35-50>50</a>
</span><span class=lnt id=hl-35-51><a class=lnlinks href=#hl-35-51>51</a>
</span><span class=lnt id=hl-35-52><a class=lnlinks href=#hl-35-52>52</a>
</span><span class=lnt id=hl-35-53><a class=lnlinks href=#hl-35-53>53</a>
</span><span class=lnt id=hl-35-54><a class=lnlinks href=#hl-35-54>54</a>
</span><span class=lnt id=hl-35-55><a class=lnlinks href=#hl-35-55>55</a>
</span><span class=lnt id=hl-35-56><a class=lnlinks href=#hl-35-56>56</a>
</span><span class=lnt id=hl-35-57><a class=lnlinks href=#hl-35-57>57</a>
</span><span class=lnt id=hl-35-58><a class=lnlinks href=#hl-35-58>58</a>
</span><span class=lnt id=hl-35-59><a class=lnlinks href=#hl-35-59>59</a>
</span><span class=lnt id=hl-35-60><a class=lnlinks href=#hl-35-60>60</a>
</span><span class=lnt id=hl-35-61><a class=lnlinks href=#hl-35-61>61</a>
</span><span class=lnt id=hl-35-62><a class=lnlinks href=#hl-35-62>62</a>
</span><span class=lnt id=hl-35-63><a class=lnlinks href=#hl-35-63>63</a>
</span><span class=lnt id=hl-35-64><a class=lnlinks href=#hl-35-64>64</a>
</span><span class=lnt id=hl-35-65><a class=lnlinks href=#hl-35-65>65</a>
</span><span class=lnt id=hl-35-66><a class=lnlinks href=#hl-35-66>66</a>
</span><span class=lnt id=hl-35-67><a class=lnlinks href=#hl-35-67>67</a>
</span><span class=lnt id=hl-35-68><a class=lnlinks href=#hl-35-68>68</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 핵심: 이벤트 Append, 리플레이, 낙관적 잠금, 멱등성</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>uuid</span><span class=o>,</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Command</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span><span class=p>:</span> <span class=nb>dict</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_version</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>idempotency_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 멱등성 보장용</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;dbname=es user=es password=es host=localhost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 테이블 (예시):</span>
</span></span><span class=line><span class=cl><span class=c1># events(stream_id text, seq int, type text, data jsonb, ts timestamptz, idempotency_key text, primary key(stream_id, seq))</span>
</span></span><span class=line><span class=cl><span class=c1># unique(stream_id, idempotency_key)</span>
</span></span><span class=line><span class=cl><span class=c1># projections.orders(order_id text primary key, status text, total numeric, updated_at timestamptz)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders/place&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>place_order</span><span class=p>(</span><span class=n>cmd</span><span class=p>:</span> <span class=n>Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>event</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;OrderPlaced&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=o>.</span><span class=n>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>stream_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;order-</span><span class=si>{</span><span class=n>cmd</span><span class=o>.</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>conn</span><span class=p>()</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 멱등성 검사 (같은 idempotency_key로 재시도 시 중복 방지)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cmd</span><span class=o>.</span><span class=n>idempotency_key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;select 1 from events where stream_id=</span><span class=si>%s</span><span class=s2> and idempotency_key=</span><span class=si>%s</span><span class=s2>&#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>stream_id</span><span class=p>,</span> <span class=n>cmd</span><span class=o>.</span><span class=n>idempotency_key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ok&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;idempotent&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 현재 버전 읽기</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;select coalesce(max(seq),0) from events where stream_id=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>stream_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>current_version</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 낙관적 잠금</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cmd</span><span class=o>.</span><span class=n>expected_version</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>cmd</span><span class=o>.</span><span class=n>expected_version</span> <span class=o>!=</span> <span class=n>current_version</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>409</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;version conflict: expected </span><span class=si>{</span><span class=n>cmd</span><span class=o>.</span><span class=n>expected_version</span><span class=si>}</span><span class=s2>, got </span><span class=si>{</span><span class=n>current_version</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>next_seq</span> <span class=o>=</span> <span class=n>current_version</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;insert into events(stream_id, seq, type, data, ts, idempotency_key)
</span></span></span><span class=line><span class=cl><span class=s2>                       values(</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,now(),</span><span class=si>%s</span><span class=s2>)&#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>stream_id</span><span class=p>,</span> <span class=n>next_seq</span><span class=p>,</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>],</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>]),</span> <span class=n>cmd</span><span class=o>.</span><span class=n>idempotency_key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ok&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;version&#34;</span><span class=p>:</span> <span class=n>next_seq</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>replay_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 핵심: 이벤트 리플레이로 Aggregate/상태 복원</span>
</span></span><span class=line><span class=cl>    <span class=n>stream_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;order-</span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;NEW&#34;</span><span class=p>,</span> <span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>conn</span><span class=p>()</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;select type, data from events where stream_id=</span><span class=si>%s</span><span class=s2> order by seq asc&#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>stream_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>etype</span><span class=p>,</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>etype</span> <span class=o>==</span> <span class=s2>&#34;OrderPlaced&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>state</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;PLACED&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>etype</span> <span class=o>==</span> <span class=s2>&#34;ItemAdded&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>state</span><span class=p>[</span><span class=s2>&#34;items&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;sku&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>state</span><span class=p>[</span><span class=s2>&#34;total&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>]</span> <span class=o>*</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;qty&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>etype</span> <span class=o>==</span> <span class=s2>&#34;Paid&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>state</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;PAID&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>etype</span> <span class=o>==</span> <span class=s2>&#34;Shipped&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>state</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;SHIPPED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>state</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>구현 예시 – Node.js (Express + Upcaster 스케치)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a class=lnlinks href=#hl-36-1> 1</a>
</span><span class=lnt id=hl-36-2><a class=lnlinks href=#hl-36-2> 2</a>
</span><span class=lnt id=hl-36-3><a class=lnlinks href=#hl-36-3> 3</a>
</span><span class=lnt id=hl-36-4><a class=lnlinks href=#hl-36-4> 4</a>
</span><span class=lnt id=hl-36-5><a class=lnlinks href=#hl-36-5> 5</a>
</span><span class=lnt id=hl-36-6><a class=lnlinks href=#hl-36-6> 6</a>
</span><span class=lnt id=hl-36-7><a class=lnlinks href=#hl-36-7> 7</a>
</span><span class=lnt id=hl-36-8><a class=lnlinks href=#hl-36-8> 8</a>
</span><span class=lnt id=hl-36-9><a class=lnlinks href=#hl-36-9> 9</a>
</span><span class=lnt id=hl-36-10><a class=lnlinks href=#hl-36-10>10</a>
</span><span class=lnt id=hl-36-11><a class=lnlinks href=#hl-36-11>11</a>
</span><span class=lnt id=hl-36-12><a class=lnlinks href=#hl-36-12>12</a>
</span><span class=lnt id=hl-36-13><a class=lnlinks href=#hl-36-13>13</a>
</span><span class=lnt id=hl-36-14><a class=lnlinks href=#hl-36-14>14</a>
</span><span class=lnt id=hl-36-15><a class=lnlinks href=#hl-36-15>15</a>
</span><span class=lnt id=hl-36-16><a class=lnlinks href=#hl-36-16>16</a>
</span><span class=lnt id=hl-36-17><a class=lnlinks href=#hl-36-17>17</a>
</span><span class=lnt id=hl-36-18><a class=lnlinks href=#hl-36-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 핵심: 업캐스터 체인으로 과거 이벤트를 최신 모델로 승격
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>upcast</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s2>&#34;ItemAdded&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>event</span><span class=p>.</span><span class=nx>version</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// v1 -&gt; v2: qty 필드 기본값 추가
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>{</span> <span class=p>...</span><span class=nx>event</span><span class=p>,</span> <span class=nx>version</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=p>...</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>,</span> <span class=nx>qty</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>qty</span> <span class=o>??</span> <span class=mi>1</span> <span class=p>}</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Projector 예시: 멱등 upsert
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=kd>function</span> <span class=nx>projectItemAdded</span><span class=p>(</span><span class=nx>ev</span><span class=p>,</span> <span class=nx>db</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ev</span> <span class=o>=</span> <span class=nx>upcast</span><span class=p>(</span><span class=nx>ev</span><span class=p>);</span> <span class=c1>// 이벤트 진화 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>    insert into order_items(order_id, sku, qty, price)
</span></span></span><span class=line><span class=cl><span class=sb>    values($1,$2,$3,$4)
</span></span></span><span class=line><span class=cl><span class=sb>    on conflict(order_id, sku) do update set qty = order_items.qty + EXCLUDED.qty
</span></span></span><span class=line><span class=cl><span class=sb>  `</span><span class=p>,</span> <span class=p>[</span><span class=nx>ev</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>orderId</span><span class=p>,</span> <span class=nx>ev</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>sku</span><span class=p>,</span> <span class=nx>ev</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>qty</span><span class=p>,</span> <span class=nx>ev</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>price</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=실제-도입-사례의-코드-구현-1>실제 도입 사례의 코드 구현<a hidden class=anchor aria-hidden=true href=#실제-도입-사례의-코드-구현-1>#</a></h4><p><strong>시나리오</strong>: <strong>EventStoreDB</strong>를 쓰는 주문 서비스의 쓰기 모델(append) + 읽기 모델(프로젝션) 최소 구현. EventStoreDB는 이벤트 스트림/버전/프로젝션을 1급 기능으로 제공. (<a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>GitHub</a>)</p><p><strong>시스템 구성</strong>:</p><ul><li>Command API(C# 또는 Node), EventStoreDB, Projection(ESDB 내장 또는 외부 워커), Read DB</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
  API[Command API] --&gt; ESDB[(EventStoreDB)]
  ESDB -- subscriptions --&gt; PROJ[Projection Worker]
  PROJ --&gt; R[(Read DB)]
  QAPI[Query API] --&gt; R
</pre><p><strong>Workflow</strong>:</p><ol><li>API가 <code>AppendToStream(streamId, expectedRevision, eventData)</code> 호출</li><li>Projection Worker가 Subscription으로 이벤트 수신</li><li>Upsert로 Read DB 갱신</li></ol><p><strong>구현 예시 – Node.js + EventStoreDB gRPC SDK</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a class=lnlinks href=#hl-38-1> 1</a>
</span><span class=lnt id=hl-38-2><a class=lnlinks href=#hl-38-2> 2</a>
</span><span class=lnt id=hl-38-3><a class=lnlinks href=#hl-38-3> 3</a>
</span><span class=lnt id=hl-38-4><a class=lnlinks href=#hl-38-4> 4</a>
</span><span class=lnt id=hl-38-5><a class=lnlinks href=#hl-38-5> 5</a>
</span><span class=lnt id=hl-38-6><a class=lnlinks href=#hl-38-6> 6</a>
</span><span class=lnt id=hl-38-7><a class=lnlinks href=#hl-38-7> 7</a>
</span><span class=lnt id=hl-38-8><a class=lnlinks href=#hl-38-8> 8</a>
</span><span class=lnt id=hl-38-9><a class=lnlinks href=#hl-38-9> 9</a>
</span><span class=lnt id=hl-38-10><a class=lnlinks href=#hl-38-10>10</a>
</span><span class=lnt id=hl-38-11><a class=lnlinks href=#hl-38-11>11</a>
</span><span class=lnt id=hl-38-12><a class=lnlinks href=#hl-38-12>12</a>
</span><span class=lnt id=hl-38-13><a class=lnlinks href=#hl-38-13>13</a>
</span><span class=lnt id=hl-38-14><a class=lnlinks href=#hl-38-14>14</a>
</span><span class=lnt id=hl-38-15><a class=lnlinks href=#hl-38-15>15</a>
</span><span class=lnt id=hl-38-16><a class=lnlinks href=#hl-38-16>16</a>
</span><span class=lnt id=hl-38-17><a class=lnlinks href=#hl-38-17>17</a>
</span><span class=lnt id=hl-38-18><a class=lnlinks href=#hl-38-18>18</a>
</span><span class=lnt id=hl-38-19><a class=lnlinks href=#hl-38-19>19</a>
</span><span class=lnt id=hl-38-20><a class=lnlinks href=#hl-38-20>20</a>
</span><span class=lnt id=hl-38-21><a class=lnlinks href=#hl-38-21>21</a>
</span><span class=lnt id=hl-38-22><a class=lnlinks href=#hl-38-22>22</a>
</span><span class=lnt id=hl-38-23><a class=lnlinks href=#hl-38-23>23</a>
</span><span class=lnt id=hl-38-24><a class=lnlinks href=#hl-38-24>24</a>
</span><span class=lnt id=hl-38-25><a class=lnlinks href=#hl-38-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 주석: EventStoreDB에 Append, ExpectedRevision으로 낙관적 잠금
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>EventStoreDBClient</span><span class=p>,</span> <span class=nx>jsonEvent</span><span class=p>,</span> <span class=nx>FORWARDS</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@eventstore/db-client&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>EventStoreDBClient</span><span class=p>({</span> <span class=nx>endpoint</span><span class=o>:</span> <span class=s2>&#34;esdb://localhost:2113?tls=false&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>placeOrder</span><span class=p>(</span><span class=nx>orderId</span><span class=p>,</span> <span class=nx>payload</span><span class=p>,</span> <span class=nx>expectedRevision</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>event</span> <span class=o>=</span> <span class=nx>jsonEvent</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;OrderPlaced&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>orderId</span><span class=p>,</span> <span class=p>...</span><span class=nx>payload</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>client</span><span class=p>.</span><span class=nx>appendToStream</span><span class=p>(</span><span class=sb>`order-</span><span class=si>${</span><span class=nx>orderId</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>[</span><span class=nx>event</span><span class=p>],</span> <span class=p>{</span> <span class=nx>expectedRevision</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>replay</span><span class=p>(</span><span class=nx>orderId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>events</span> <span class=o>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>readStream</span><span class=p>(</span><span class=sb>`order-</span><span class=si>${</span><span class=nx>orderId</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>{</span> <span class=nx>direction</span><span class=o>:</span> <span class=nx>FORWARDS</span><span class=p>,</span> <span class=nx>fromRevision</span><span class=o>:</span> <span class=mi>0</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;NEW&#34;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=kr>await</span> <span class=p>(</span><span class=kr>const</span> <span class=p>{</span> <span class=nx>event</span> <span class=p>}</span> <span class=k>of</span> <span class=nx>events</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>event</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;OrderPlaced&#34;</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=s2>&#34;PLACED&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;Paid&#34;</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=s2>&#34;PAID&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=phase-6-운영-및-최적화-1>Phase 6: 운영 및 최적화<a hidden class=anchor aria-hidden=true href=#phase-6-운영-및-최적화-1>#</a></h3><h4 id=보안-및-거버넌스-2>보안 및 거버넌스<a hidden class=anchor aria-hidden=true href=#보안-및-거버넌스-2>#</a></h4><ul><li><strong>GDPR(잊힐 권리)</strong>: 이벤트 페이로드 암호화+키 폐기, PII 분리 저장, 삭제 이벤트(보정 이벤트)로 처리.</li><li><strong>규정 준수</strong>: 모든 변경은 이벤트로 기록하여 감사 로그 일관성 확보. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li><li><strong>권한/접근 제어</strong>: Stream 단위 ACL, API 레벨 스코프 기반 접근.</li></ul><h4 id=모니터링-및-관측성-2>모니터링 및 관측성<a hidden class=anchor aria-hidden=true href=#모니터링-및-관측성-2>#</a></h4><ul><li><strong>핵심 메트릭</strong>: Append 지연, ExpectedVersion 충돌률, Projector lag(오프셋 차), 중복 처리율, 리플레이 시간.</li><li><strong>로그/트레이싱</strong>: 이벤트 ID·상관관계 ID, 커맨드→이벤트→프로젝션 체인 추적(OpenTelemetry 권장).</li></ul><h4 id=실무-적용-고려사항-및-주의점-표>실무 적용 고려사항 및 주의점 (표)<a hidden class=anchor aria-hidden=true href=#실무-적용-고려사항-및-주의점-표>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>내용</th><th>권장사항</th></tr></thead><tbody><tr><td>설계</td><td>이벤트 명세</td><td>타입/버전/ID/발생시각/Producer</td><td>스키마 레지스트리/명확한 네이밍</td></tr><tr><td>스토리지</td><td>파티셔닝</td><td>Aggregate 키 기반 파티션</td><td>순서 보장/핫 파티션 모니터링</td></tr><tr><td>성능</td><td>스냅샷</td><td>N 이벤트마다 저장</td><td>읽기 지연 목표로 주기 조정</td></tr><tr><td>진화</td><td>업캐스터</td><td>코드/파이프라인으로 관리</td><td>회귀 테스트·계약 테스트</td></tr><tr><td>복구</td><td>리플레이</td><td>체크포인트 기반 재처리</td><td>백필 전 전략·리밸런싱 계획</td></tr></tbody></table><h4 id=성능-최적화-전략-표>성능 최적화 전략 (표)<a hidden class=anchor aria-hidden=true href=#성능-최적화-전략-표>#</a></h4><table><thead><tr><th>영역</th><th>전략</th><th>설명</th><th>비고</th></tr></thead><tbody><tr><td>쓰기</td><td>배치 Append</td><td>Nagle 유사 효과로 TPS↑</td><td>지연-처리량 균형</td></tr><tr><td>읽기</td><td>스냅샷+증분</td><td>스냅샷 이후만 리플레이</td><td>큰 Aggregate에 유효</td></tr><tr><td>투영</td><td>병렬 파티션</td><td>키 파티션 병렬 소비</td><td>순서 보장 주의</td></tr><tr><td>스키마</td><td>Lean 이벤트</td><td>최소 필드+레퍼런스</td><td>PII 분리</td></tr></tbody></table><hr><h3 id=phase-7-고급-주제-1>Phase 7: 고급 주제<a hidden class=anchor aria-hidden=true href=#phase-7-고급-주제-1>#</a></h3><h4 id=현재-도전-과제-2>현재 도전 과제<a hidden class=anchor aria-hidden=true href=#현재-도전-과제-2>#</a></h4><table><thead><tr><th>과제</th><th>원인</th><th>영향</th><th>해결방안</th></tr></thead><tbody><tr><td>장기 스키마 진화</td><td>비즈니스 변화</td><td>업캐스터 난이도↑</td><td>버전 정책, 계약 테스트, 점진적 마이그레이션</td></tr><tr><td>대규모 리플레이</td><td>수십억 이벤트</td><td>리빌드 시간↑</td><td>스냅샷 계층화, 백필 파이프라인, 임시 고성능 클러스터</td></tr><tr><td>데이터 거버넌스</td><td>PII 불변 로그</td><td>규제 충돌</td><td>암호화 키 폐기, PII 외부화</td></tr></tbody></table><h4 id=생태계-및-관련-기술-2>생태계 및 관련 기술<a hidden class=anchor aria-hidden=true href=#생태계-및-관련-기술-2>#</a></h4><ul><li><strong>CQRS, DDD(Domain-Driven Design)</strong>: ES와 상호 보완. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li><strong>클라우드 파편</strong>: Cosmos DB Change Feed, Kafka(이벤트 스트림 인프라 – <em>ES 자체는 아님</em>), Outbox 패턴. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">Microsoft for Developers</a>)</li></ul><h4 id=최신-트렌드와-미래-방향-1>최신 트렌드와 미래 방향<a hidden class=anchor aria-hidden=true href=#최신-트렌드와-미래-방향-1>#</a></h4><ul><li><strong>Serverless 투영</strong>(Functions + Change Feed/Triggers)</li><li><strong>스키마 레지스트리/계약 주도 개발</strong> 보편화</li><li><strong>감사/리스크</strong> 요구로 금융·헬스 도입 지속</li></ul><hr><h2 id=4단계-종합-정리-1>4단계: 종합 정리<a hidden class=anchor aria-hidden=true href=#4단계-종합-정리-1>#</a></h2><h3 id=10-최종-정리-및-학습-가이드>10. 최종 정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#10-최종-정리-및-학습-가이드>#</a></h3><ul><li><p><strong>내용 종합</strong>: Event Sourcing은 <strong>사실 기반 데이터 모델</strong>로, Event Store를 SSOT로 삼아 리플레이/투영으로 다양한 리드 모델을 만든다. CQRS와 결합 시 확장성과 감사성이 탁월하지만, <strong>스키마 진화·리플레이 비용·운영 복잡성</strong>이 따른다. Microsoft 아키텍처 센터·Fowler 글·EventStoreDB 문서가 실무 표준 지침으로 유용하다. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>, <a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</p></li><li><p><strong>학습 로드맵</strong></p><ol><li>기본 개념(Fowler 글) → 2) CQRS 결합(MS Docs) → 3) 샘플 구현(PostgreSQL/ESDB) → 4) 업캐스터/스냅샷 운용 → 5) 모니터링·거버넌스 → 6) 대규모 리플레이/마이그레이션 전략</li></ol></li></ul><h3 id=학습-항목-매트릭스-2>학습 항목 매트릭스<a hidden class=anchor aria-hidden=true href=#학습-항목-매트릭스-2>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a class=lnlinks href=#hl-39-1>1</a>
</span><span class=lnt id=hl-39-2><a class=lnlinks href=#hl-39-2>2</a>
</span><span class=lnt id=hl-39-3><a class=lnlinks href=#hl-39-3>3</a>
</span><span class=lnt id=hl-39-4><a class=lnlinks href=#hl-39-4>4</a>
</span><span class=lnt id=hl-39-5><a class=lnlinks href=#hl-39-5>5</a>
</span><span class=lnt id=hl-39-6><a class=lnlinks href=#hl-39-6>6</a>
</span><span class=lnt id=hl-39-7><a class=lnlinks href=#hl-39-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>| 카테고리 | Phase | 항목 | 중요도 | 설명 |
</span></span><span class=line><span class=cl>|----------|-------|------|--------|------|
</span></span><span class=line><span class=cl>| 기초     | 1     | 개념/가치 | 필수   | 이벤트로 상태를 저장하고 재생 |
</span></span><span class=line><span class=cl>| 이론     | 2     | SSOT/동시성/투영 | 필수 | ExpectedVersion, 멱등성, 리드 모델 |
</span></span><span class=line><span class=cl>| 구현     | 5     | ESDB/PG 구현 | 권장   | Append/Replay/Projection 코드 |
</span></span><span class=line><span class=cl>| 운영     | 6     | 모니터링/거버넌스 | 필수   | Lag, 충돌률, GDPR 전략 |
</span></span><span class=line><span class=cl>| 고급     | 7     | 업캐스터/대규모 리플레이 | 선택   | 스키마 진화·백필 최적화 |
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=용어-정리-2>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리-2>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>정의</th><th>관련 개념</th></tr></thead><tbody><tr><td>핵심</td><td>이벤트(Event)</td><td>도메인에서 일어난 불변의 사실</td><td>도메인 이벤트, 커맨드</td></tr><tr><td>핵심</td><td>이벤트 스토어</td><td>Append-only 이벤트 저장소</td><td>SSOT, 스냅샷</td></tr><tr><td>구현</td><td>투영(Projection)</td><td>이벤트→리드 모델 변환</td><td>물질화 뷰, Change Feed</td></tr><tr><td>구현</td><td>업캐스터(Upcaster)</td><td>과거 이벤트를 최신 스키마로 승격</td><td>스키마 진화</td></tr><tr><td>운영</td><td>리플레이</td><td>이벤트 재적용으로 상태 복원</td><td>백필, 체크포인트</td></tr><tr><td>운영</td><td>ExpectedVersion</td><td>낙관적 잠금용 기대 버전</td><td>동시성 제어</td></tr></tbody></table><hr><h2 id=참고-및-출처-2>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-2>#</a></h2><ul><li>Martin Fowler, <strong>Event Sourcing</strong>. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li><li>Microsoft Azure Architecture Center, <strong>Event Sourcing / CQRS</strong>. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li>LMAX 사례(이벤트 소싱/저지연). (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">martinfowler.com</a>)</li><li>Cosmos DB Change Feed와 ES 패턴 응용. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">Microsoft for Developers</a>)</li><li>InfoQ, Greg Young 인터뷰/요약. (<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">InfoQ</a>)</li><li>EventStoreDB 샘플/문서. (<a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>GitHub</a>)</li></ul><hr><p>원하면 <strong>프로덕션 체크리스트(테이블)</strong>, <strong>Kafka/Outbox와의 결합 예시</strong>, <strong>스냅샷 전략 벤치마크 가이드</strong>도 이어서 제공하겠다.</p><p>좋아. 이어서 <strong>프로덕션 관점의 보강 섹션</strong>을 덧붙인다. 체크리스트, Outbox/Kafka 통합, 스냅샷 벤치마크, 마이그레이션, 거버넌스(GDPR), 운영 런북, 관측성, DR/멀티 리전, 테스트 전략까지 한 번에 정리했다.</p><hr><h1 id=프로덕션-체크리스트-production-readiness>프로덕션 체크리스트 (Production Readiness)<a hidden class=anchor aria-hidden=true href=#프로덕션-체크리스트-production-readiness>#</a></h1><table><thead><tr><th>카테고리</th><th>확인 항목</th><th>권장 기준/팁</th></tr></thead><tbody><tr><td>데이터 모델</td><td>이벤트 명세(타입/버전/ID/발생시각/메타)</td><td>스키마 레지스트리 도입, 하위 호환 우선</td></tr><tr><td>동시성</td><td>Expected Version(낙관적 잠금)</td><td>스트림(aggregate) 단위 버전 충돌률 모니터링</td></tr><tr><td>멱등성</td><td>커맨드·프로젝터 멱등키</td><td>DB 유니크 제약 / upsert 패턴</td></tr><tr><td>스냅샷</td><td>주기/임계치</td><td>이벤트 N개/시간 T 기준 혼합, 큰 aggregate만 적용</td></tr><tr><td>투영</td><td>체크포인트 관리</td><td>장애 복구 시 재처리 가능(최소 3일 보존)</td></tr><tr><td>거버넌스</td><td>GDPR/PII 처리</td><td>PII 분리·암호화·키 폐기 시나리오 마련 (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">event-driven.io</a>)</td></tr><tr><td>배포</td><td>리드 모델 재빌드 절차</td><td>백필(Backfill) 작업서·우선순위 큐</td></tr><tr><td>관측성</td><td>핵심 메트릭</td><td>append 지연, projector lag, 중복률, 리플레이 시간</td></tr><tr><td>문서화</td><td>리플레이/보정 정책</td><td>“정오(正誤) 이벤트” 표준화, 운영자 가이드</td></tr><tr><td>교육</td><td>사고 대응 훈련</td><td>순서 역전/중복/버전 충돌 플레이북</td></tr></tbody></table><hr><h1 id=outbox--kafka-통합-exactly-once-착각-대신-멱등-설계>Outbox + Kafka 통합 (Exactly-once 착각 대신 멱등 설계)<a hidden class=anchor aria-hidden=true href=#outbox--kafka-통합-exactly-once-착각-대신-멱등-설계>#</a></h1><p><strong>의도</strong>: 도메인 이벤트를 <strong>DB 트랜잭션과 함께</strong> 안전하게 기록(Outbox)하고, 별도 퍼블리셔가 Kafka로 전달. Dual-write 문제를 제거. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">microservices.io</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">AWS Documentation</a>)</p><pre class=mermaid>flowchart LR
  A[Command Handler] --&gt;|TXN| DB[(OLTP DB)]
  A --&gt;|insert outbox*| DB
  DB --&gt; P[Outbox Publisher]
  P --&gt;|poll &amp; publish| K[(Kafka Topic)]
  K --&gt; C1[Projector A]
  K --&gt; C2[Projector B]
</pre><p>* 동일 트랜잭션에 <strong>도메인 상태 + outbox 레코드</strong> 삽입</p><p><strong>Outbox 테이블 설계 (예: PostgreSQL)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a class=lnlinks href=#hl-41-1> 1</a>
</span><span class=lnt id=hl-41-2><a class=lnlinks href=#hl-41-2> 2</a>
</span><span class=lnt id=hl-41-3><a class=lnlinks href=#hl-41-3> 3</a>
</span><span class=lnt id=hl-41-4><a class=lnlinks href=#hl-41-4> 4</a>
</span><span class=lnt id=hl-41-5><a class=lnlinks href=#hl-41-5> 5</a>
</span><span class=lnt id=hl-41-6><a class=lnlinks href=#hl-41-6> 6</a>
</span><span class=lnt id=hl-41-7><a class=lnlinks href=#hl-41-7> 7</a>
</span><span class=lnt id=hl-41-8><a class=lnlinks href=#hl-41-8> 8</a>
</span><span class=lnt id=hl-41-9><a class=lnlinks href=#hl-41-9> 9</a>
</span><span class=lnt id=hl-41-10><a class=lnlinks href=#hl-41-10>10</a>
</span><span class=lnt id=hl-41-11><a class=lnlinks href=#hl-41-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>outbox</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>aggregate_id</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>type</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>        </span><span class=c1>-- 이벤트 타입
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=n>payload</span><span class=w> </span><span class=n>jsonb</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>    </span><span class=c1>-- 스키마드 페이로드
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=n>occurred_at</span><span class=w> </span><span class=n>timestamptz</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>published</span><span class=w> </span><span class=nb>boolean</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=k>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>headers</span><span class=w> </span><span class=n>jsonb</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;{}&#39;</span><span class=p>::</span><span class=n>jsonb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>outbox</span><span class=p>(</span><span class=n>published</span><span class=p>,</span><span class=w> </span><span class=n>occurred_at</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Publisher(간략, Node.js)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a class=lnlinks href=#hl-42-1> 1</a>
</span><span class=lnt id=hl-42-2><a class=lnlinks href=#hl-42-2> 2</a>
</span><span class=lnt id=hl-42-3><a class=lnlinks href=#hl-42-3> 3</a>
</span><span class=lnt id=hl-42-4><a class=lnlinks href=#hl-42-4> 4</a>
</span><span class=lnt id=hl-42-5><a class=lnlinks href=#hl-42-5> 5</a>
</span><span class=lnt id=hl-42-6><a class=lnlinks href=#hl-42-6> 6</a>
</span><span class=lnt id=hl-42-7><a class=lnlinks href=#hl-42-7> 7</a>
</span><span class=lnt id=hl-42-8><a class=lnlinks href=#hl-42-8> 8</a>
</span><span class=lnt id=hl-42-9><a class=lnlinks href=#hl-42-9> 9</a>
</span><span class=lnt id=hl-42-10><a class=lnlinks href=#hl-42-10>10</a>
</span><span class=lnt id=hl-42-11><a class=lnlinks href=#hl-42-11>11</a>
</span><span class=lnt id=hl-42-12><a class=lnlinks href=#hl-42-12>12</a>
</span><span class=lnt id=hl-42-13><a class=lnlinks href=#hl-42-13>13</a>
</span><span class=lnt id=hl-42-14><a class=lnlinks href=#hl-42-14>14</a>
</span><span class=lnt id=hl-42-15><a class=lnlinks href=#hl-42-15>15</a>
</span><span class=lnt id=hl-42-16><a class=lnlinks href=#hl-42-16>16</a>
</span><span class=lnt id=hl-42-17><a class=lnlinks href=#hl-42-17>17</a>
</span><span class=lnt id=hl-42-18><a class=lnlinks href=#hl-42-18>18</a>
</span><span class=lnt id=hl-42-19><a class=lnlinks href=#hl-42-19>19</a>
</span><span class=lnt id=hl-42-20><a class=lnlinks href=#hl-42-20>20</a>
</span><span class=lnt id=hl-42-21><a class=lnlinks href=#hl-42-21>21</a>
</span><span class=lnt id=hl-42-22><a class=lnlinks href=#hl-42-22>22</a>
</span><span class=lnt id=hl-42-23><a class=lnlinks href=#hl-42-23>23</a>
</span><span class=lnt id=hl-42-24><a class=lnlinks href=#hl-42-24>24</a>
</span><span class=lnt id=hl-42-25><a class=lnlinks href=#hl-42-25>25</a>
</span><span class=lnt id=hl-42-26><a class=lnlinks href=#hl-42-26>26</a>
</span><span class=lnt id=hl-42-27><a class=lnlinks href=#hl-42-27>27</a>
</span><span class=lnt id=hl-42-28><a class=lnlinks href=#hl-42-28>28</a>
</span><span class=lnt id=hl-42-29><a class=lnlinks href=#hl-42-29>29</a>
</span><span class=lnt id=hl-42-30><a class=lnlinks href=#hl-42-30>30</a>
</span><span class=lnt id=hl-42-31><a class=lnlinks href=#hl-42-31>31</a>
</span><span class=lnt id=hl-42-32><a class=lnlinks href=#hl-42-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 트랜잭션 외부에서 outbox의 미발행 레코드를 Kafka로 퍼블리시
</span></span></span><span class=line><span class=cl><span class=c1>// 멱등성: 메시지 키=aggregate_id, consumer는 upsert로 적용
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Kafka</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;kafkajs&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pg</span> <span class=nx>from</span> <span class=s2>&#34;pg&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>kafka</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Kafka</span><span class=p>({</span> <span class=nx>clientId</span><span class=o>:</span> <span class=s2>&#34;outbox-publisher&#34;</span><span class=p>,</span> <span class=nx>brokers</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;kafka:9092&#34;</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>producer</span> <span class=o>=</span> <span class=nx>kafka</span><span class=p>.</span><span class=nx>producer</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>pg</span><span class=p>.</span><span class=nx>Pool</span><span class=p>({</span> <span class=nx>connectionString</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PG_URL</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>publishBatch</span><span class=p>(</span><span class=nx>limit</span> <span class=o>=</span> <span class=mi>500</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>c</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>pool</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>c</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s2>&#34;begin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>rows</span> <span class=p>}</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>c</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;select * from outbox where published=false order by occurred_at asc limit $1 for update skip locked&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=nx>limit</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>r</span> <span class=k>of</span> <span class=nx>rows</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>producer</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>topic</span><span class=o>:</span> <span class=sb>`domain.</span><span class=si>${</span><span class=nx>r</span><span class=p>.</span><span class=nx>type</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>messages</span><span class=o>:</span> <span class=p>[{</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>aggregate_id</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>}],</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>c</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s2>&#34;update outbox set published=true where id=$1&#34;</span><span class=p>,</span> <span class=p>[</span><span class=nx>r</span><span class=p>.</span><span class=nx>id</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>c</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s2>&#34;commit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>c</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s2>&#34;rollback&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>release</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Kafka의 전달 보장 참고</strong>: 카프카는 프로듀서 idempotence/트랜잭션으로 <strong>프로세싱</strong> 관점의 exactly-once를 지원하나, 시스템 전반(외부 DB)에서는 멱등/보정이 필수다. 운영에선 <strong>at-least-once + 멱등 소비자</strong>가 현실적 기본값. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">docs.confluent.io</a>, <a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">Apache Kafka</a>)</p><hr><h1 id=스냅샷-전략--벤치마크-가이드>스냅샷 전략 & 벤치마크 가이드<a hidden class=anchor aria-hidden=true href=#스냅샷-전략--벤치마크-가이드>#</a></h1><p><strong>전략</strong></p><ul><li><strong>임계 기반</strong>: 이벤트 n개(예: 200~1000)마다 스냅샷.</li><li><strong>시간 기반</strong>: 최근 접근이 잦은 aggregate만 주기적 스냅샷.</li><li><strong>계층 스냅샷</strong>: 대형 aggregate는 부분 스냅샷(서브상태) + 최종 스냅샷.</li></ul><p><strong>벤치마크 시나리오</strong></p><ol><li>이벤트 스트림 길이(1e2, 1e3, 1e4) × 스냅샷 주기(없음/200/500/1000)</li><li>재생 지연, CPU, I/O, 캐시 히트율 측정</li><li><strong>목표</strong>: 99p 재생 지연 ≤ SLA(예: 50ms) 충족하는 최소 스냅샷 빈도 채택</li></ol><p><strong>클라우드 연계</strong>: Cosmos DB의 Change Feed로 투영/리빌드 파이프라인을 구성하면, projector lag와 확장성을 쉽게 관리 가능. (<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">Microsoft Learn</a>, <a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">azure.github.io</a>)</p><hr><h1 id=crud--event-sourcing-마이그레이션-로드맵>CRUD → Event Sourcing 마이그레이션 로드맵<a hidden class=anchor aria-hidden=true href=#crud--event-sourcing-마이그레이션-로드맵>#</a></h1><ol><li><strong>도메인 이벤트 정의</strong>: 현재 테이블 변경을 “사실”로 모델링</li><li><strong>분리 배포</strong>: Outbox 패턴 도입(이벤트 생성·발행) → 기존 읽기 기능은 유지 (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">microservices.io</a>)</li><li><strong>투영 구축</strong>: 신규 Read 모델(Materialized View) 증설</li><li><strong>이중 쓰기 차단</strong>: 커맨드는 ES 경유, 조회는 새 Read 모델로 전환</li><li><strong>리플레이 백필</strong>: 과거 변경 이력을 이벤트로 재구성(최소한의 이벤트)</li><li><strong>절체(Cut-over)</strong>: 구(舊) 스키마 Deprecation, 보정 이벤트 체계화</li></ol><hr><h1 id=데이터-거버넌스--gdpr-right-to-be-forgotten>데이터 거버넌스 & GDPR (Right to be Forgotten)<a hidden class=anchor aria-hidden=true href=#데이터-거버넌스--gdpr-right-to-be-forgotten>#</a></h1><ul><li><strong>PII 외부화</strong>: 이벤트 페이로드엔 키만 저장, PII는 별도 보안 스토어(TTL/키회전).</li><li><strong>암호화·키 폐기</strong>: 개인 키로 필드 단위 암호화 → 삭제 요청 시 키 폐기로 사실상 삭제. 토큰화/프록시 조회 조합.</li><li><strong>보정 이벤트(Compensating Event)</strong>: 삭제·정정 요청을 반영하는 “정오 이벤트”로 후행 투영 정합.</li><li><strong>보존 정책(Retention)</strong>: 스트림별 TTL/폐기 정책 문서화, 규정과 정렬. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">event-driven.io</a>, <a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>Google Groups</a>, <a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">DEV Community</a>)</li></ul><hr><h1 id=운영-런북-runbook>운영 런북 (Runbook)<a hidden class=anchor aria-hidden=true href=#운영-런북-runbook>#</a></h1><p><strong>1) Projector Lag 급증</strong></p><ul><li>진단: Lag 메트릭, 파티션 스큐, 소비자 에러율 확인</li><li>대응: 파티션 리밸런스, 소비자 증설, 오프셋 재설정(체크포인트), 장애 이벤트 격리 큐</li></ul><p><strong>2) 버전 충돌 폭증</strong></p><ul><li>진단: ExpectedVersion 충돌률/스트림 상위 N 분석</li><li>대응: aggregate 경계 재검토, 명령 직렬화, 핫 파티션 분리</li></ul><p><strong>3) 대규모 리플레이/리빌드</strong></p><ul><li>절차: 스냅샷 고정 → 백필 전용 워커 확장 → 우선순위(Hot 스트림) 리빌드 → Read 모델 점진 스위칭</li></ul><p><strong>4) GDPR 삭제 요청</strong></p><ul><li>절차: 식별자 확인 → 키 폐기/토큰 폐기 → 보정 이벤트 발행 → 리드 모델 재투영</li></ul><hr><h1 id=관측성observability-대시보드>관측성(Observability) 대시보드<a hidden class=anchor aria-hidden=true href=#관측성observability-대시보드>#</a></h1><ul><li><strong>쓰기 경로</strong>: append TPS, P99 append latency, 버전 충돌률, DB 커밋 지연</li><li><strong>읽기 경로</strong>: projector lag(초/이벤트), 오프셋 지연 분포, 중복 처리율, upsert 충돌률</li><li><strong>리플레이</strong>: 분당 처리량, 체크포인트 속도, 실패율, 재시도 백오프</li><li><strong>거버넌스</strong>: GDPR 처리 건수, 암호화 키 회전 성과, PII 접근 로그</li></ul><hr><h1 id=dr멀티-리전-전략>DR/멀티 리전 전략<a hidden class=anchor aria-hidden=true href=#dr멀티-리전-전략>#</a></h1><ul><li><strong>단일 사실 소스(SSOT) 복제</strong>: 이벤트 스토어는 멀티 AZ(Availability Zone) + 비동기 크로스 리전 복제</li><li><strong>리드 모델 현지화</strong>: 각 리전에서 독립 투영(로컬 읽기 지연 최소화)</li><li><strong>Failover 절차</strong>: 리더 선출·쓰기 금지 구간 최소화, 이벤트 스트림 <strong>단방향 승격</strong> 규칙 문서화</li><li><strong>재동기화</strong>: 분기 발생 시 <strong>승격 리전</strong> 기준으로 리플레이/재투영</li></ul><hr><h1 id=테스트-전략>테스트 전략<a hidden class=anchor aria-hidden=true href=#테스트-전략>#</a></h1><ul><li><strong>Property-based Test</strong>: 이벤트 시퀀스에 대해 불변식(예: 총액 ≥ 0) 항상 성립</li><li><strong>Contract/Consumer Test</strong>: 이벤트 스키마 버전 업 시 다운스트림 호환 검증</li><li><strong>Replay Test</strong>: 임의 시점 스냅샷+증분 이벤트로 동일 상태 재현성 확인</li><li><strong>Chaos/Failure Test</strong>: 중복/순서 역전/부분 실패 주입하여 멱등·보정 검증</li></ul><p>간단 예—<strong>리플레이 동일성 테스트 (Python/pytest)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a class=lnlinks href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a class=lnlinks href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a class=lnlinks href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a class=lnlinks href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a class=lnlinks href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a class=lnlinks href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a class=lnlinks href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a class=lnlinks href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a class=lnlinks href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a class=lnlinks href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a class=lnlinks href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a class=lnlinks href=#hl-43-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 상태 재현성: 전체 리플레이 vs 스냅샷+증분 리플레이 결과가 동일해야 함</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fold</span><span class=p>(</span><span class=n>events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>e</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;ItemAdded&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>state</span><span class=p>[</span><span class=s2>&#34;total&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>e</span><span class=p>[</span><span class=s2>&#34;price&#34;</span><span class=p>]</span> <span class=o>*</span> <span class=n>e</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;qty&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>state</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_replay_equivalence</span><span class=p>(</span><span class=n>full_events</span><span class=p>,</span> <span class=n>snapshot</span><span class=p>,</span> <span class=n>delta_events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>state_full</span> <span class=o>=</span> <span class=n>fold</span><span class=p>(</span><span class=n>full_events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>state_delta</span> <span class=o>=</span> <span class=n>fold</span><span class=p>([</span><span class=n>snapshot</span><span class=p>]</span> <span class=o>+</span> <span class=n>delta_events</span><span class=p>)</span>  <span class=c1># 스냅샷을 이벤트로 취급</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>state_full</span> <span class=o>==</span> <span class=n>state_delta</span>
</span></span></code></pre></td></tr></table></div></div><hr><h1 id=참고-리소스-더-깊게-볼-곳>참고 리소스 (더 깊게 볼 곳)<a hidden class=anchor aria-hidden=true href=#참고-리소스-더-깊게-볼-곳>#</a></h1><ul><li>Martin Fowler, <strong>Event Sourcing</strong> – 개념·가치·스냅샷. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">martinfowler.com</a>)</li><li><strong>Azure Architecture Center – Event Sourcing/CQRS</strong> – 설계·파티셔닝·스냅샷 지침. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">Microsoft Learn</a>)</li><li>Greg Young, <strong>CQRS Documents</strong> – ES/CQRS 기초·RDBMS 기반 구현. (<a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf?utm_source=chatgpt.com" title="[PDF] CQRS Documents by Greg Young">cqrs.files.wordpress.com</a>)</li><li><strong>Transactional Outbox</strong> 패턴 – Microservices.io, AWS 가이드. (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">microservices.io</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">AWS Documentation</a>)</li><li>Kafka <strong>전달/Exactly-once</strong> 문서 – 설계 시 주의점. (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">docs.confluent.io</a>, <a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">Apache Kafka</a>)</li><li>Azure Cosmos DB <strong>Change Feed</strong> – 투영/리빌드 파이프라인. (<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">Microsoft Learn</a>, <a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">azure.github.io</a>)</li><li>GDPR/보존 정책 in Event-driven – 운영 가이드. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">event-driven.io</a>)</li></ul><hr><p>원하면 <strong>운영 대시보드 예시 쿼리(SQL/PromQL)</strong>, <strong>리플레이 백필 파이프라인(워크플로우/YAML)</strong>, <strong>스키마 업캐스터 레이어 샘플</strong>까지 추가로 만들어 주겠다.</p><hr><h2 id=1-태그>1. 태그<a hidden class=anchor aria-hidden=true href=#1-태그>#</a></h2><ul><li><strong>Event-Sourcing</strong></li><li><strong>Architecture-Patterns</strong></li><li><strong>Data-Management-Patterns</strong></li><li><strong>Software-Engineering</strong></li></ul><hr><h2 id=2-분류-구조-적합성-분석>2. 분류 구조 적합성 분석<a hidden class=anchor aria-hidden=true href=#2-분류-구조-적합성-분석>#</a></h2><p><strong>현재 분류 구조</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a class=lnlinks href=#hl-44-1>1</a>
</span><span class=lnt id=hl-44-2><a class=lnlinks href=#hl-44-2>2</a>
</span><span class=lnt id=hl-44-3><a class=lnlinks href=#hl-44-3>3</a>
</span><span class=lnt id=hl-44-4><a class=lnlinks href=#hl-44-4>4</a>
</span><span class=lnt id=hl-44-5><a class=lnlinks href=#hl-44-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Computer Science and Engineering
</span></span><span class=line><span class=cl>└─ Software Engineering
</span></span><span class=line><span class=cl>   └─ Design and Architecture
</span></span><span class=line><span class=cl>      └─ Architecture Patterns
</span></span><span class=line><span class=cl>         └─ Data Management Patterns
</span></span></code></pre></td></tr></table></div></div><p><strong>분석 및 근거</strong><br>이벤트 소싱은 소프트웨어 엔지니어링의 디자인 및 아키텍처 패턴 중 하나로, 데이터 관리 패턴의 대표적 예시입니다.<br>이벤트 소싱은 시스템의 상태 변화를 이벤트로 기록하고, 이벤트 스트림을 통해 상태를 재구성하므로,<br>“Data Management Patterns” 하위에 배치하는 것이 적절합니다.<br>또한, 아키텍처 패턴과 소프트웨어 엔지니어링 분야에 속하므로 현재 분류 구조가 타당합니다.</p><hr><h2 id=3-요약-문장-200자-내외>3. 요약 문장 (200자 내외)<a hidden class=anchor aria-hidden=true href=#3-요약-문장-200자-내외>#</a></h2><p>이벤트 소싱은 시스템의 모든 상태 변화를 이벤트로 기록하고, 필요 시 이벤트 스트림을 재생해 상태를 재구성하는 데이터 관리 아키텍처 패턴이다.</p><hr><h2 id=4-전체-개요-250자-내외>4. 전체 개요 (250자 내외)<a hidden class=anchor aria-hidden=true href=#4-전체-개요-250자-내외>#</a></h2><p>이벤트 소싱은 시스템의 상태 변화를 이벤트로 기록해 저장하며, 이벤트 스트림을 통해 시스템의 현재 상태를 재구성할 수 있는 아키텍처 패턴이다. 이를 통해 데이터 무결성, 감사, 복구, 분석 등 다양한 이점을 얻을 수 있다.</p><hr><h2 id=5-핵심-개념>5. 핵심 개념<a hidden class=anchor aria-hidden=true href=#5-핵심-개념>#</a></h2><ul><li><strong>이벤트 소싱(Event Sourcing)</strong><ul><li>시스템의 모든 상태 변화를 이벤트(불변의 기록)로 저장.</li><li>현재 상태는 이벤트 스트림을 재생(재생산)하여 얻음.</li><li>이벤트는 원본 데이터로 간주, 시스템의 상태 변화 이력이 모두 보존됨.</li><li><strong>실무 구현 연관성</strong><ul><li>이벤트 스트림 저장 및 관리(이벤트 저장소, 스트림 처리)</li><li>이벤트 기반 시스템 설계(이벤트 발행, 구독, 처리)</li><li>상태 재구성(이벤트 재생산, 스냅샷 활용)</li><li>감사, 데이터 무결성, 트랜잭션 로그, 복구 등 다양한 실무 요구에 부합</li></ul></li></ul></li></ul><hr><h2 id=6-조사-및-분석-주제와-관련하여-조사할-내용-중심-정리>6. 조사 및 분석: “주제와 관련하여 조사할 내용” 중심 정리<a hidden class=anchor aria-hidden=true href=#6-조사-및-분석-주제와-관련하여-조사할-내용-중심-정리>#</a></h2><h3 id=1-배경>(1) 배경<a hidden class=anchor aria-hidden=true href=#1-배경>#</a></h3><ul><li>기존 시스템은 현재 상태만 저장, 이력 추적 및 감사, 복구가 어려움.</li><li>복잡한 비즈니스 도메인에서 상태 변화 이력 관리 필요성 증대.</li></ul><h3 id=2-목적-및-필요성>(2) 목적 및 필요성<a hidden class=anchor aria-hidden=true href=#2-목적-및-필요성>#</a></h3><ul><li>상태 변화의 완전한 이력 보존.</li><li>감사, 복구, 분석, 데이터 무결성 보장.</li><li>시스템의 현재 상태를 언제든지 재구성 가능.</li></ul><h3 id=3-주요-기능-및-역할>(3) 주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#3-주요-기능-및-역할>#</a></h3><ul><li><strong>이벤트 저장</strong>: 상태 변화를 이벤트로 저장.</li><li><strong>이벤트 스트림</strong>: 이벤트의 연속된 흐름.</li><li><strong>상태 재구성</strong>: 이벤트 스트림을 재생하여 현재 상태 도출.</li><li><strong>감사 및 복구</strong>: 이벤트 이력 기반 감사, 복구, 분석.</li></ul><h3 id=4-특징>(4) 특징<a hidden class=anchor aria-hidden=true href=#4-특징>#</a></h3><ul><li>상태 변화 이력의 완전한 보존.</li><li>불변 데이터(이벤트) 기반.</li><li>이벤트 기반 아키텍처와 잘 어울림.</li><li>감사, 복구, 분석 등 다양한 활용 가능.</li></ul><h3 id=5-핵심-원칙>(5) 핵심 원칙<a hidden class=anchor aria-hidden=true href=#5-핵심-원칙>#</a></h3><ul><li><strong>상태 변화는 이벤트로 기록</strong><ul><li>모든 상태 변화는 불변의 이벤트로 저장.</li></ul></li><li><strong>상태는 이벤트 스트림에서 재구성</strong><ul><li>현재 상태는 이벤트 스트림을 재생하여 얻음.</li></ul></li><li><strong>이벤트는 원본 데이터</strong><ul><li>이벤트는 시스템의 진실의 원천(Source of Truth).</li></ul></li></ul><h3 id=6-주요-원리>(6) 주요 원리<a hidden class=anchor aria-hidden=true href=#6-주요-원리>#</a></h3><ul><li><strong>이벤트 저장 및 스트림 처리</strong><ul><li>상태 변화를 이벤트로 저장, 스트림으로 관리.</li></ul></li><li><strong>이벤트 기반 상태 재구성</strong><ul><li>이벤트 스트림을 재생하여 현재 상태 도출.</li></ul></li><li><strong>이벤트 발행 및 구독</strong><ul><li>이벤트를 발행하고, 필요한 곳에서 구독하여 처리.</li></ul></li></ul><h3 id=7-작동-원리-및-다이어그램>(7) 작동 원리 및 다이어그램<a hidden class=anchor aria-hidden=true href=#7-작동-원리-및-다이어그램>#</a></h3><pre class=mermaid>flowchart LR
    User --&gt;|Command| CommandHandler
    CommandHandler --&gt;|Generate Event| EventStore
    EventStore --&gt;|Event Stream| EventProcessor
    EventProcessor --&gt;|Update| ReadModel
    User --&gt;|Query| QueryHandler
    QueryHandler --&gt;|Retrieve| ReadModel
</pre><p><strong>설명</strong></p><ul><li><strong>User</strong>: 시스템 사용자.</li><li><strong>CommandHandler</strong>: 명령을 처리하여 이벤트 생성.</li><li><strong>EventStore</strong>: 이벤트를 저장하는 저장소.</li><li><strong>EventProcessor</strong>: 이벤트 스트림을 처리하여 상태(Read Model) 갱신.</li><li><strong>ReadModel</strong>: 현재 상태(비정규화, 캐시 등 활용).</li><li><strong>QueryHandler</strong>: 조회 요청 처리.</li></ul><h3 id=8-구조-및-아키텍처>(8) 구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#8-구조-및-아키텍처>#</a></h3><table><thead><tr><th>구성 요소</th><th>기능 및 역할</th><th>필수/선택</th></tr></thead><tbody><tr><td>Command</td><td>상태 변경 명령</td><td>필수</td></tr><tr><td>Command Handler</td><td>명령 처리 및 이벤트 생성</td><td>필수</td></tr><tr><td>Event</td><td>상태 변화를 나타내는 불변 데이터</td><td>필수</td></tr><tr><td>Event Store</td><td>이벤트 저장 및 관리</td><td>필수</td></tr><tr><td>Event Processor</td><td>이벤트 스트림 처리 및 상태 갱신</td><td>필수</td></tr><tr><td>Read Model</td><td>현재 상태(비정규화, 캐시 등 활용)</td><td>선택(일부 시스템)</td></tr><tr><td>Query Handler</td><td>조회 요청 처리</td><td>선택(일부 시스템)</td></tr></tbody></table><p><strong>설명</strong></p><ul><li><strong>필수 구성요소</strong>: Command, Command Handler, Event, Event Store, Event Processor</li><li><strong>선택 구성요소</strong>: Read Model, Query Handler (CQRS와 연동 시 필요)</li></ul><h3 id=9-구현-기법>(9) 구현 기법<a hidden class=anchor aria-hidden=true href=#9-구현-기법>#</a></h3><ul><li><strong>이벤트 저장소 설계</strong>: 이벤트를 효율적으로 저장 및 조회할 수 있는 저장소 구현.</li><li><strong>이벤트 발행/구독</strong>: 이벤트를 발행하고, 필요한 곳에서 구독하여 처리.</li><li><strong>상태 재구성</strong>: 이벤트 스트림을 재생하여 현재 상태 도출(스냅샷 활용 가능).</li><li><strong>이벤트 기반 시스템 연동</strong>: CQRS, 마이크로서비스 등과 연동.</li></ul><h3 id=10-장점>(10) 장점<a hidden class=anchor aria-hidden=true href=#10-장점>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>특성 발생 원인</th></tr></thead><tbody><tr><td>장점</td><td>데이터 무결성</td><td>상태 변화 이력 완전 보존, 감사 및 복구 가능</td><td>이벤트 기반 기록</td></tr><tr><td></td><td>감사 및 추적</td><td>모든 상태 변화 이력 추적 가능</td><td>이벤트 스트림 보존</td></tr><tr><td></td><td>복구 및 분석</td><td>이벤트 재생을 통한 과거 상태 복구, 분석 가능</td><td>이벤트 재생산</td></tr><tr><td></td><td>유연성</td><td>이벤트 기반 시스템 연동(CQRS, 마이크로서비스 등)에 적합</td><td>이벤트 발행/구독</td></tr></tbody></table><h3 id=11-단점과-문제점-그리고-해결방안>(11) 단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#11-단점과-문제점-그리고-해결방안>#</a></h3><h4 id=단점>단점<a hidden class=anchor aria-hidden=true href=#단점>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>단점</td><td>복잡성</td><td>이벤트 저장, 처리, 재생 등 시스템 복잡도 증가</td><td>명확한 설계, 문서화</td></tr><tr><td></td><td>성능</td><td>대량 이벤트 처리 시 성능 저하 가능성</td><td>스냅샷, 최적화 기법 적용</td></tr><tr><td></td><td>저장소 용량</td><td>이벤트 누적로 저장소 용량 증가</td><td>이벤트 보관 정책, 아카이빙</td></tr></tbody></table><h4 id=문제점-1>문제점<a hidden class=anchor aria-hidden=true href=#문제점-1>#</a></h4><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>문제점</td><td>이벤트 중복</td><td>이벤트 발행 중복</td><td>데이터 일관성 문제</td><td>모니터링, 로그 분석</td><td>이벤트 발행 제어</td><td>중복 제거, 멱등 처리</td></tr><tr><td></td><td>이벤트 손실</td><td>네트워크/장애 등</td><td>상태 재구성 불가</td><td>모니터링, 알림</td><td>신뢰성 확보</td><td>재시도, 복구 프로세스</td></tr></tbody></table><h3 id=12-도전-과제>(12) 도전 과제<a hidden class=anchor aria-hidden=true href=#12-도전-과제>#</a></h3><ul><li><p><strong>대용량 이벤트 처리</strong></p><ul><li><strong>원인</strong>: 이벤트 누적로 인한 저장소 및 처리 부하.</li><li><strong>영향</strong>: 성능 저하, 시스템 장애.</li><li><strong>탐지 및 진단</strong>: 모니터링, 로그 분석.</li><li><strong>예방 방법</strong>: 스냅샷, 이벤트 보관 정책.</li><li><strong>해결 방법</strong>: 아카이빙, 분산 처리.</li></ul></li><li><p><strong>이벤트 기반 시스템 연동</strong></p><ul><li><strong>원인</strong>: 다양한 시스템과의 연동 복잡성.</li><li><strong>영향</strong>: 데이터 일관성, 시스템 통합 난이도 증가.</li><li><strong>탐지 및 진단</strong>: 모니터링, 테스트.</li><li><strong>예방 방법</strong>: 명확한 인터페이스 정의.</li><li><strong>해결 방법</strong>: 이벤트 버스, 마이크로서비스 아키텍처.</li></ul></li></ul><h3 id=13-분류-기준에-따른-종류-및-유형>(13) 분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#13-분류-기준에-따른-종류-및-유형>#</a></h3><table><thead><tr><th>구분</th><th>유형</th><th>설명</th></tr></thead><tbody><tr><td>유형</td><td>단일 이벤트 소싱</td><td>단일 시스템 내 이벤트 소싱 적용</td></tr><tr><td></td><td>분산 이벤트 소싱</td><td>분산 시스템(마이크로서비스 등)에서 이벤트 소싱 적용</td></tr><tr><td></td><td>이벤트 소싱 + CQRS</td><td>이벤트 소싱과 CQRS 패턴 연동</td></tr></tbody></table><h3 id=14-실무-사용-예시>(14) 실무 사용 예시<a hidden class=anchor aria-hidden=true href=#14-실무-사용-예시>#</a></h3><table><thead><tr><th>예시</th><th>목적</th><th>함께 사용되는 기술/패턴</th><th>효과</th></tr></thead><tbody><tr><td>금융 거래 시스템</td><td>거래 이력 관리</td><td>CQRS, 마이크로서비스</td><td>감사, 복구, 분석</td></tr><tr><td>주문 관리 시스템</td><td>주문 상태 변화 추적</td><td>이벤트 버스, NoSQL</td><td>상태 이력 관리, 복구</td></tr></tbody></table><h3 id=15-활용-사례>(15) 활용 사례<a hidden class=anchor aria-hidden=true href=#15-활용-사례>#</a></h3><p><strong>금융 거래 시스템 예시</strong></p><ul><li><strong>시스템 구성</strong>: 거래 명령 → 이벤트 생성 → 이벤트 저장 → 이벤트 처리 → 상태 갱신</li><li><strong>시스템 구성 다이어그램</strong></li></ul><pre class=mermaid>flowchart LR
    User --&gt;|거래 명령| CommandHandler
    CommandHandler --&gt;|이벤트 생성| EventStore
    EventStore --&gt;|이벤트 스트림| EventProcessor
    EventProcessor --&gt;|상태 갱신| ReadModel
    User --&gt;|거래 조회| QueryHandler
    QueryHandler --&gt;|상태 조회| ReadModel
</pre><ul><li><strong>Workflow</strong>:<ol><li>사용자가 거래 명령(Command) 실행.</li><li>Command Handler가 이벤트 생성 및 Event Store에 저장.</li><li>Event Processor가 이벤트 스트림을 처리하여 상태(Read Model) 갱신.</li><li>사용자가 거래 조회(Query) 시 Query Handler가 Read Model에서 상태 반환.</li></ol></li><li><strong>이벤트 소싱 역할</strong>:<ul><li>거래 이력 완전 보존, 감사, 복구, 분석 가능.</li><li>상태 변화 이력 기반 시스템 운영.</li></ul></li><li><strong>이벤트 소싱 유무에 따른 차이점</strong>:<ul><li><strong>적용 시</strong>: 거래 이력 완전 보존, 감사/복구/분석 용이.</li><li><strong>미적용 시</strong>: 현재 상태만 저장, 이력 추적 및 복구 어려움.</li></ul></li></ul><h3 id=16-구현-예시-python>(16) 구현 예시 (Python)<a hidden class=anchor aria-hidden=true href=#16-구현-예시-python>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a class=lnlinks href=#hl-47-1> 1</a>
</span><span class=lnt id=hl-47-2><a class=lnlinks href=#hl-47-2> 2</a>
</span><span class=lnt id=hl-47-3><a class=lnlinks href=#hl-47-3> 3</a>
</span><span class=lnt id=hl-47-4><a class=lnlinks href=#hl-47-4> 4</a>
</span><span class=lnt id=hl-47-5><a class=lnlinks href=#hl-47-5> 5</a>
</span><span class=lnt id=hl-47-6><a class=lnlinks href=#hl-47-6> 6</a>
</span><span class=lnt id=hl-47-7><a class=lnlinks href=#hl-47-7> 7</a>
</span><span class=lnt id=hl-47-8><a class=lnlinks href=#hl-47-8> 8</a>
</span><span class=lnt id=hl-47-9><a class=lnlinks href=#hl-47-9> 9</a>
</span><span class=lnt id=hl-47-10><a class=lnlinks href=#hl-47-10>10</a>
</span><span class=lnt id=hl-47-11><a class=lnlinks href=#hl-47-11>11</a>
</span><span class=lnt id=hl-47-12><a class=lnlinks href=#hl-47-12>12</a>
</span><span class=lnt id=hl-47-13><a class=lnlinks href=#hl-47-13>13</a>
</span><span class=lnt id=hl-47-14><a class=lnlinks href=#hl-47-14>14</a>
</span><span class=lnt id=hl-47-15><a class=lnlinks href=#hl-47-15>15</a>
</span><span class=lnt id=hl-47-16><a class=lnlinks href=#hl-47-16>16</a>
</span><span class=lnt id=hl-47-17><a class=lnlinks href=#hl-47-17>17</a>
</span><span class=lnt id=hl-47-18><a class=lnlinks href=#hl-47-18>18</a>
</span><span class=lnt id=hl-47-19><a class=lnlinks href=#hl-47-19>19</a>
</span><span class=lnt id=hl-47-20><a class=lnlinks href=#hl-47-20>20</a>
</span><span class=lnt id=hl-47-21><a class=lnlinks href=#hl-47-21>21</a>
</span><span class=lnt id=hl-47-22><a class=lnlinks href=#hl-47-22>22</a>
</span><span class=lnt id=hl-47-23><a class=lnlinks href=#hl-47-23>23</a>
</span><span class=lnt id=hl-47-24><a class=lnlinks href=#hl-47-24>24</a>
</span><span class=lnt id=hl-47-25><a class=lnlinks href=#hl-47-25>25</a>
</span><span class=lnt id=hl-47-26><a class=lnlinks href=#hl-47-26>26</a>
</span><span class=lnt id=hl-47-27><a class=lnlinks href=#hl-47-27>27</a>
</span><span class=lnt id=hl-47-28><a class=lnlinks href=#hl-47-28>28</a>
</span><span class=lnt id=hl-47-29><a class=lnlinks href=#hl-47-29>29</a>
</span><span class=lnt id=hl-47-30><a class=lnlinks href=#hl-47-30>30</a>
</span><span class=lnt id=hl-47-31><a class=lnlinks href=#hl-47-31>31</a>
</span><span class=lnt id=hl-47-32><a class=lnlinks href=#hl-47-32>32</a>
</span><span class=lnt id=hl-47-33><a class=lnlinks href=#hl-47-33>33</a>
</span><span class=lnt id=hl-47-34><a class=lnlinks href=#hl-47-34>34</a>
</span><span class=lnt id=hl-47-35><a class=lnlinks href=#hl-47-35>35</a>
</span><span class=lnt id=hl-47-36><a class=lnlinks href=#hl-47-36>36</a>
</span><span class=lnt id=hl-47-37><a class=lnlinks href=#hl-47-37>37</a>
</span><span class=lnt id=hl-47-38><a class=lnlinks href=#hl-47-38>38</a>
</span><span class=lnt id=hl-47-39><a class=lnlinks href=#hl-47-39>39</a>
</span><span class=lnt id=hl-47-40><a class=lnlinks href=#hl-47-40>40</a>
</span><span class=lnt id=hl-47-41><a class=lnlinks href=#hl-47-41>41</a>
</span><span class=lnt id=hl-47-42><a class=lnlinks href=#hl-47-42>42</a>
</span><span class=lnt id=hl-47-43><a class=lnlinks href=#hl-47-43>43</a>
</span><span class=lnt id=hl-47-44><a class=lnlinks href=#hl-47-44>44</a>
</span><span class=lnt id=hl-47-45><a class=lnlinks href=#hl-47-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 이벤트 클래스 예시</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_type</span> <span class=o>=</span> <span class=n>event_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 이벤트 저장소 예시</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Command Handler 예시</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CommandHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_command</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>Event</span><span class=p>(</span><span class=s2>&#34;Transaction&#34;</span><span class=p>,</span> <span class=n>command_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Event Processor 예시</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventProcessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;Transaction&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=n>event_store</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>command_handler</span> <span class=o>=</span> <span class=n>CommandHandler</span><span class=p>(</span><span class=n>event_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>command_handler</span><span class=o>.</span><span class=n>handle_command</span><span class=p>({</span><span class=s2>&#34;account&#34;</span><span class=p>:</span> <span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>event_processor</span> <span class=o>=</span> <span class=n>Event2Processor</span><span class=p>(</span><span class=n>event_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>event_processor</span><span class=o>.</span><span class=n>process_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>event_processor</span><span class=o>.</span><span class=n>state</span><span class=p>)</span>  <span class=c1># {&#39;account&#39;: &#39;A&#39;, &#39;amount&#39;: 100}</span>
</span></span></code></pre></td></tr></table></div></div><p><em>EventProcessor 클래스명은 오타가 있을 수 있습니다. 실제로는 EventProcessor로 통일하는 것이 좋습니다.</em></p><hr><h2 id=7-추가-조사-내용>7. 추가 조사 내용<a hidden class=anchor aria-hidden=true href=#7-추가-조사-내용>#</a></h2><ul><li><strong>이벤트 소싱과 CQRS의 연동</strong>:<ul><li>이벤트 소싱은 명령 처리 결과를 이벤트로 저장하고, CQRS는 읽기/쓰기 모델을 분리하여 각각 최적화.</li><li>두 패턴을 함께 사용하면 시스템의 확장성, 유지보수성, 데이터 무결성, 감사, 복구 등 다양한 이점을 얻을 수 있음.</li></ul></li><li><strong>이벤트 기반 아키텍처의 확장</strong>:<ul><li>이벤트 소싱은 마이크로서비스, 분산 시스템 등에서 상태 변화 이력 관리와 시스템 연동에 매우 효과적.</li></ul></li></ul><hr><h2 id=8-기타-사항>8. 기타 사항<a hidden class=anchor aria-hidden=true href=#8-기타-사항>#</a></h2><ul><li><strong>이벤트 소싱은 모든 시스템에 적합하지 않음</strong>:<ul><li>단순 CRUD 애플리케이션에는 오버엔지니어링이 될 수 있으므로, 복잡한 도메인, 감사/복구/분석 요구가 있는 시스템에 적합.</li></ul></li><li><strong>이벤트 스트림의 장기 보관</strong>:<ul><li>이벤트가 누적되면 저장소 용량 및 처리 부하가 증가하므로, 스냅샷, 아카이빙 등 관리 전략 필요.</li></ul></li></ul><hr><h2 id=9-주제와-관련하여-주목할-내용>9. 주제와 관련하여 주목할 내용<a hidden class=anchor aria-hidden=true href=#9-주제와-관련하여-주목할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>아키텍처</td><td>이벤트 소싱</td><td>이벤트 기반 기록</td><td>상태 변화를 이벤트로 기록, 이력 보존</td></tr><tr><td>데이터 관리</td><td>이벤트 스트림</td><td>상태 재구성</td><td>이벤트 스트림 재생으로 상태 도출</td></tr><tr><td>확장성</td><td>마이크로서비스</td><td>분산 시스템 연동</td><td>이벤트 기반 시스템 연동에 적합</td></tr><tr><td>최적화</td><td>스냅샷</td><td>성능 향상</td><td>대량 이벤트 처리 시 스냅샷 활용</td></tr></tbody></table><hr><h2 id=10-반드시-학습해야할-내용>10. 반드시 학습해야할 내용<a hidden class=anchor aria-hidden=true href=#10-반드시-학습해야할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>아키텍처</td><td>이벤트 소싱</td><td>이벤트 기반 기록</td><td>상태 변화를 이벤트로 기록, 이력 보존</td></tr><tr><td>데이터 관리</td><td>이벤트 스트림</td><td>상태 재구성</td><td>이벤트 스트림 재생으로 상태 도출</td></tr><tr><td>확장성</td><td>마이크로서비스</td><td>분산 시스템 연동</td><td>이벤트 기반 시스템 연동에 적합</td></tr><tr><td>최적화</td><td>스냅샷</td><td>성능 향상</td><td>대량 이벤트 처리 시 스냅샷 활용</td></tr></tbody></table><hr><h2 id=11-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>11. 실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#11-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h2><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>도메인 복잡성</td><td>복잡한 도메인에 적합</td><td>명확한 도메인 경계 정의</td></tr><tr><td>이벤트 저장소</td><td>이벤트 저장 및 관리 필요</td><td>효율적인 저장소 설계, 아카이빙</td></tr><tr><td>이벤트 처리</td><td>대량 이벤트 처리 성능</td><td>스냅샷, 분산 처리</td></tr><tr><td>데이터 일관성</td><td>이벤트 기반 동기화 필요</td><td>이벤트 발행/구독 신뢰성 확보</td></tr></tbody></table><hr><h2 id=12-최적화하기-위한-고려사항-및-주의할-점>12. 최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#12-최적화하기-위한-고려사항-및-주의할-점>#</a></h2><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>이벤트 저장소</td><td>대량 이벤트 저장 효율성</td><td>아카이빙, 스냅샷</td></tr><tr><td>이벤트 처리</td><td>대량 이벤트 처리 성능</td><td>스냅샷, 분산 처리</td></tr><tr><td>상태 재구성</td><td>빠른 상태 재구성 필요</td><td>스냅샷, 캐시</td></tr><tr><td>시스템 연동</td><td>다양한 시스템과의 연동</td><td>명확한 인터페이스, 이벤트 버스</td></tr></tbody></table><hr><h2 id=13-용어-정리>13. 용어 정리<a hidden class=anchor aria-hidden=true href=#13-용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>아키텍처</td><td>이벤트 소싱</td><td>상태 변화를 이벤트로 기록하는 아키텍처 패턴</td></tr><tr><td>데이터 관리</td><td>이벤트 스트림</td><td>상태 변화 이벤트의 연속된 흐름</td></tr><tr><td>확장성</td><td>마이크로서비스</td><td>각 서비스가 독립적으로 동작하는 아키텍처</td></tr><tr><td>최적화</td><td>스냅샷</td><td>특정 시점의 상태를 저장하여 빠른 재구성 지원</td></tr></tbody></table><hr><h2 id=14-참고-및-출처>14. 참고 및 출처<a hidden class=anchor aria-hidden=true href=#14-참고-및-출처>#</a></h2><ul><li><a href=https://martinfowler.com/eaaDev/EventSourcing.html>Event Sourcing - Martin Fowler</a></li><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing>Event Sourcing Pattern - Microsoft Azure Architecture Center</a></li><li><a href=https://www.eventstore.com/event-sourcing>Introducing Event Sourcing - Event Store</a></li><li><a href=https://www.dddcommunity.org/event-sourcing/>Event Sourcing Explained - DDD Community</a></li></ul><hr><h2 id=요약>요약<a hidden class=anchor aria-hidden=true href=#요약>#</a></h2><p>이벤트 소싱은 시스템의 상태 변화를 이벤트로 기록하고, 이벤트 스트림을 재생하여 상태를 재구성하는 아키텍처 패턴으로, 데이터 무결성, 감사, 복구, 분석 등 다양한 이점을 제공하며, 복잡한 도메인이나 분산 시스템에서 특히 효과적입니다.<br>분류 구조는 “Computer Science and Engineering > Software Engineering > Design and Architecture > Architecture Patterns > Data Management Patterns”로 적합하며, 이벤트 소싱은 CQRS, 마이크로서비스 등과 잘 연동됩니다.</p><hr><h2 id=-tags>📌 Tags<a hidden class=anchor aria-hidden=true href=#-tags>#</a></h2><ul><li>Event-Sourcing</li><li>Append-Only-Log</li><li>Temporal-Data</li><li>Audit-Trail</li></ul><hr><h2 id=1-분류-구조-타당성-평가>1. 분류 구조 타당성 평가<a hidden class=anchor aria-hidden=true href=#1-분류-구조-타당성-평가>#</a></h2><p><strong>현재 위치</strong>:
<code>Computer Science and Engineering > Software Engineering > Design and Architecture > Architecture Patterns > Data Management Patterns</code></p><p>✅ <strong>적절</strong>: Event Sourcing은 변경 이력을 이벤트 로그로 보존하는 <strong>데이터 관리 패턴</strong>으로, CQRS와 자주 결합되어 설계상 읽기/쓰기 분리를 지원하기에 현 구조가 타당합니다. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">kurrent.io</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">microservices.io</a>)</p><hr><h2 id=2-200자-내외-요약>2. 200자 내외 요약<a hidden class=anchor aria-hidden=true href=#2-200자-내외-요약>#</a></h2><p>Event Sourcing은 모든 상태 변경을 불변 이벤트(event)로 기록하며, 이러한 이벤트 로그를 통해 현재 상태를 재구성하거나 과거 상태를 조회하는 패턴입니다. 이를 통해 완벽한 감사 로그, 시간 여행 쿼리, 복원 및 이벤트 기반 통합이 가능하며, CQRS와 결합 시 읽기/쓰기 분리를 통한 최적화도 수행할 수 있습니다.</p><hr><h2 id=3-250자-내외-개요>3. 250자 내외 개요<a hidden class=anchor aria-hidden=true href=#3-250자-내외-개요>#</a></h2><p>Event Sourcing은 시스템의 모든 상태 변화를 append-only 로그(Event Store)에 이벤트로 기록하는 아키텍처 패턴입니다. 이러한 이벤트 로그는 현재 상태 재생(replay)을 통해 시스템 상태를 복원하거나 과거 상태를 조회하는 용도로 사용됩니다. 주요 이점은 감사(Auditability), 시간여행(Temporal Queries), 복합 워크플로우 추적, 시스템 복원성 등이 있으며, 읽기 모델과 결합 시 CQRS 패턴의 최적화 효과도 얻을 수 있습니다. 단, 높은 복잡도, 이벤트 스냅샷 등 인프라 체계가 요구됩니다.</p><hr><h2 id=4-핵심-개념>4. 핵심 개념<a hidden class=anchor aria-hidden=true href=#4-핵심-개념>#</a></h2><h3 id=-event-이벤트>🔹 Event (이벤트)<a hidden class=anchor aria-hidden=true href=#-event-이벤트>#</a></h3><ul><li>시스템에서 발생한 불변(Immutable) 상태 변경 단위. (e.g., <code>OrderCreated</code>, <code>BalanceUpdated</code>) (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">geeksforgeeks.org</a>)</li></ul><h3 id=-event-store-이벤트-저장소>🔹 Event Store (이벤트 저장소)<a hidden class=anchor aria-hidden=true href=#-event-store-이벤트-저장소>#</a></h3><ul><li>이벤트를 순차적으로 저장하는 append-only 로그.</li><li>상태 재구성, 이벤트 발행 기능 포함 (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">docs.aws.amazon.com</a>)</li></ul><h3 id=-aggregate>🔹 Aggregate<a hidden class=anchor aria-hidden=true href=#-aggregate>#</a></h3><ul><li>도메인 단위의 변경 로직과 상태 응집체.</li><li>커맨드를 처리하고 이벤트를 생성하는 단일 단위 (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">geeksforgeeks.org</a>, <a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">docs.aws.amazon.com</a>)</li></ul><h3 id=-projection--materialized-view>🔹 Projection / Materialized View<a hidden class=anchor aria-hidden=true href=#-projection--materialized-view>#</a></h3><ul><li>이벤트를 읽기 전용 모델로 변환하여 조회 최적화. CQRS와 결합 시 필수 요소</li></ul><h3 id=-snapshot-스냅샷>🔹 Snapshot (스냅샷)<a hidden class=anchor aria-hidden=true href=#-snapshot-스냅샷>#</a></h3><ul><li>이벤트가 많아질 경우 재생 비용을 줄이기 위한 중간 상태 저장. 이후 이벤트는 이 후로만 재생</li></ul><h3 id=-replay-재생>🔹 Replay (재생)<a hidden class=anchor aria-hidden=true href=#-replay-재생>#</a></h3><ul><li>과거 시점이나 현재 상태를 이벤트 재생으로 복원하거나 분석</li></ul><hr><h3 id=-실무-구현-측면>🔹 실무 구현 측면<a hidden class=anchor aria-hidden=true href=#-실무-구현-측면>#</a></h3><ul><li><strong>감사(Audit)</strong> 요구사항이 있는 금융, 전자상거래, 보건 등에서 주로 도입됨 (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">medium.com</a>)</li><li><strong>분산 시스템 통합 및 Event-Driven 아키텍처</strong>에서 이벤트 발행 및 통합 소스로 사용됨 (<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">arxiv.org</a>)</li></ul><hr><h2 id=5--6-주제와-관련하여-조사할-내용-정리>5. “## 6. 주제와 관련하여 조사할 내용” 정리<a hidden class=anchor aria-hidden=true href=#5--6-주제와-관련하여-조사할-내용-정리>#</a></h2><h3 id=-배경--배경-및-목적로-변경>• 배경 → ‘배경 및 목적’로 변경<a hidden class=anchor aria-hidden=true href=#-배경--배경-및-목적로-변경>#</a></h3><p>이벤트 기반 아키텍처 확산, 감사 기록 및 분산 시스템 요구사항 증가</p><h3 id=-목적-및-필요성>• 목적 및 필요성<a hidden class=anchor aria-hidden=true href=#-목적-및-필요성>#</a></h3><p>감사-추적, 시스템 복원, 시간여행, 이벤트 기반 통합, CQRS 결합 읽기/쓰기 분리 최적화</p><h3 id=-주요-기능-및-역할>• 주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#-주요-기능-및-역할>#</a></h3><p>이벤트 생성, 저장, 발행, 프로젝션, 재생, 스냅샷</p><h3 id=-특징>• 특징<a hidden class=anchor aria-hidden=true href=#-특징>#</a></h3><p>불변성, 시간여행, 감사성, 복원성, Eventual Consistency</p><h3 id=-구성-요소-및-구조구조-및-아키텍처-추가>• 구성 요소 및 구조 (“구조 및 아키텍처” 추가)<a hidden class=anchor aria-hidden=true href=#-구성-요소-및-구조구조-및-아키텍처-추가>#</a></h3><p>이벤트, 이벤트 저장소, 애그리거트, 프로젝션, 스냅샷</p><h3 id=-구현-기법>• 구현 기법<a hidden class=anchor aria-hidden=true href=#-구현-기법>#</a></h3><p>브로커(Kafka/RabbitMQ), EventStoreDB, 라이브러리(eventsourcing, Eventuate 등)</p><h3 id=-장점--단점-분석>• 장점 · 단점 분석<a hidden class=anchor aria-hidden=true href=#-장점--단점-분석>#</a></h3><p>장점: 감사, 시간여행, 복원, 분리 등 | 단점: 복잡성, 스토리지/메모리 증가, 이벤트 버전 관리, 일관성 지연 등</p><h3 id=-도전-과제>• 도전 과제<a hidden class=anchor aria-hidden=true href=#-도전-과제>#</a></h3><p>이벤트 진화, 스냅샷 정책, 테스트/모니터링, 분산 파티셔닝/ordering 문제</p><h3 id=-분류-기준>• 분류 기준<a hidden class=anchor aria-hidden=true href=#-분류-기준>#</a></h3><p>스냅샷 사용여부, 동기/비동기, CQRS 결합 여부, 단일/마이크로서비스 수준 등</p><h3 id=-실무-사용-예시>• 실무 사용 예시<a hidden class=anchor aria-hidden=true href=#-실무-사용-예시>#</a></h3><p>금융․전자상거래 시스템, IoT, 협업툴</p><h3 id=-활용-사례>• 활용 사례<a hidden class=anchor aria-hidden=true href=#-활용-사례>#</a></h3><p>e‑commerce, Ride‑Sharing, 금융원장, Git 버전 관리</p><h3 id=-구현-예시>• 구현 예시<a hidden class=anchor aria-hidden=true href=#-구현-예시>#</a></h3><p>Python eventsourcing 샘플, Java Spring, Node.js등</p><h3 id=-고려-및-최적화-사항>• 고려 및 최적화 사항<a hidden class=anchor aria-hidden=true href=#-고려-및-최적화-사항>#</a></h3><p>모델 크기 관리, 이벤트 payload 설계, idempotency, 모니터링, 테스트 전략, 이벤트 버전 정책</p><h3 id=-기타-사항>• 기타 사항<a hidden class=anchor aria-hidden=true href=#-기타-사항>#</a></h3><p>기밀 데이터 삭제 처리, GDPR 대응, 쿼리 성능 보강</p><hr><h2 id=6-추가-조사-항목-및-요약>6. 추가 조사 항목 및 요약<a hidden class=anchor aria-hidden=true href=#6-추가-조사-항목-및-요약>#</a></h2><h3 id=-주목할-내용-표>📊 “주목할 내용” 표<a hidden class=anchor aria-hidden=true href=#-주목할-내용-표>#</a></h3><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>기본</td><td>Immutable 이벤트</td><td>불변 이벤트 구조와 의미적 중요성</td><td></td></tr><tr><td>인프라</td><td>Event Ordering</td><td>이벤트 순서 보장 아키텍처 필요</td><td></td></tr><tr><td>관리</td><td>Event Versioning</td><td>버전 대응 전략 및 리팩토링 정책</td><td></td></tr><tr><td>성능</td><td>Snapshot 전략</td><td>주기적 상태 저장 및 재생 성능 향상</td><td></td></tr><tr><td>보안</td><td>GDPR·삭제</td><td>이벤트 로그에 개인정보 포함 시 삭제 문제</td><td></td></tr><tr><td>모니터링</td><td>Lag Metrics</td><td>이벤트 발행부터 Projection 동기화 시간 추적</td><td></td></tr><tr><td>테스트</td><td>Replay 테스트</td><td>재생 시나리오 기반 테스트 포함 필요</td><td></td></tr></tbody></table><h3 id=-반드시-학습해야할-내용-표>📘 “반드시 학습해야할 내용” 표<a hidden class=anchor aria-hidden=true href=#-반드시-학습해야할-내용-표>#</a></h3><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>이벤트 모델링</td><td>Event Schema Design</td><td>이벤트 명명, payload 정의, 의미 일관성</td><td></td></tr><tr><td>데이터 관리</td><td>Snapshot & Retention</td><td>저장공간, 성능, GDPR 정책과 조율</td><td></td></tr><tr><td>도구</td><td>Event Store 시스템</td><td>Kafka, EventStoreDB, AWS Kinesis 등 비교</td><td></td></tr><tr><td>패턴</td><td>CQRS 결합</td><td>Projection 설계, 일관성 모델(강/약) 설계</td><td></td></tr><tr><td>버전 관리</td><td>Upcasting</td><td>이벤트 리팩토링, 호환성 유지 전략</td><td></td></tr><tr><td>통합</td><td>Temporal Queries</td><td>과거 시점 상태를 조회하는 쿼리 설계</td><td></td></tr></tbody></table><hr><h2 id=용어-정리-3>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리-3>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>기본</td><td>Aggregate</td><td>도메인 상태 및 이벤트 생성 책임 단위</td></tr><tr><td>기본</td><td>Upcasting</td><td>이벤트 포맷 진화 시 변환 처리</td></tr><tr><td>기본</td><td>Temporal Query</td><td>과거 시점 상태 복원을 위한 재구성 쿼리</td></tr><tr><td>기본</td><td>Snapshot</td><td>이벤트 재생 성능 향상을 위한 중간 상태 저장</td></tr><tr><td>패턴</td><td>Eventual Consistency</td><td>비동기 Projection에 따른 읽기 일관성 지연</td></tr><tr><td>라이브러리</td><td>EventStoreDB</td><td>이벤트 저장 및 구독 기능 제공 DB 시스템</td></tr><tr><td>개발</td><td>Idempotency</td><td>중복 이벤트 처리 시 중복 영향 방지 처리</td></tr><tr><td>기능</td><td>Replay</td><td>이벤트를 순차적으로 다시 실행해 상태 복원</td></tr></tbody></table><hr><h2 id=참고-및-출처-3>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-3>#</a></h2><ul><li>Martin Fowler, <em>Event Sourcing</em> (<a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">docs.aws.amazon.com</a>, <a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>blog.bemi.io</a>, <a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">event-driven.io</a>, <a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">theserverside.com</a>, <a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">medium.com</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">fr.wikipedia.org</a>, <a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf?utm_source=chatgpt.com" title="[PDF] CQRS Documents by Greg Young">martinfowler.com</a>)</li><li>Microservices.io, <em>Event Sourcing Pattern</em> (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">microservices.io</a>)</li><li>AWS Prescriptive Guidance, <em>Event Sourcing Pattern</em> (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">docs.aws.amazon.com</a>)</li><li>Medium, <em>Event Sourcing Explained</em> (<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">event-driven.io</a>)</li><li>StackOverflow, <em>Disadvantages of Event Sourcing</em></li><li>Red Hat blog, <em>Pros & Cons of Event Sourcing</em></li><li>Kurrent.io, <em>10 problems ES helps solve</em> (<a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">kurrent.io</a>)</li><li>Innovecs blog, <em>Event Sourcing Best Practices</em> (<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">innovecs.com</a>)</li><li>Wikipedia, <em>Event-driven architecture</em> (<a href="https://en.wikipedia.org/wiki/Event-driven_architecture?utm_source=chatgpt.com" title="Event-driven architecture">en.wikipedia.org</a>)</li></ul><hr><p>원하시는 세부 항목(예: 구조 다이어그램, 실무 활용 사례, 구현 예시 코드 등)에 맞춰 추가로 작성 가능합니다. 요청 부탁드립니다!</p><p><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing><figure><img alt="Event Sourcing pattern - Azure Architecture Center | Microsoft Learn" loading=lazy src="https://tse4.mm.bing.net/th?id=OIP.o6ZoY5sk83-tDISF-pVNtwHaEM\\&pid=Api"></figure></a></p><hr><h2 id=-구조-및-아키텍처-components--diagram>🔧 구조 및 아키텍처 (Components & Diagram)<a hidden class=anchor aria-hidden=true href=#-구조-및-아키텍처-components--diagram>#</a></h2><pre class=mermaid>flowchart LR
  UI[Presentation Layer] --&gt;|Command| CmdHandler[Command Handler]
  CmdHandler --&gt;|Rebuild from history| EventStore
  CmdHandler --&gt;|Append new event| EventStore
  EventStore --&gt;|Publish events| EventBus[Queue/Topic]
  subgraph Projections
    EventBus --&gt; ProjService[Projection/Event Handler]
    ProjService --&gt; ReadStore[Read-Only DB]
  end
  UI --&gt;|Query| QueryHandler
  QueryHandler --&gt; ReadStore
</pre><ul><li><strong>Command Handler</strong>: 도메인 변경을 이벤트로 생성</li><li><strong>Event Store</strong>: append-only 구조로 이벤트 저장 및 발행 (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">liurunner.blogspot.com</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">learn.microsoft.com</a>)</li><li><strong>Event Bus</strong>: 이벤트를 비동기로 전달 (Kafka, RabbitMQ 등)</li><li><strong>Projections</strong>: 이벤트를 읽어 빠른 조회용 읽기 모델 구성</li><li><strong>Query Handler</strong>: 읽기 모델을 통한 쿼리 응답</li></ul><hr><h2 id=-배경-및-목적-background--purpose>⚙️ 배경 및 목적 (Background & Purpose)<a hidden class=anchor aria-hidden=true href=#-배경-및-목적-background--purpose>#</a></h2><ul><li><strong>감사 & 복원</strong>: 모든 변경을 이력으로 보존 → 추적성 확보 (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">en.paradigmadigital.com</a>)</li><li><strong>시간여행 쿼리</strong>: 과거 상태 재구성 가능 (예: 장바구니 특정 시점) (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">microservices.io</a>)</li><li><strong>분산 시스템 통합</strong>: 이벤트 기반으로 서로 다른 서비스 간 상태 공유 (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">medium.com</a>)</li><li><strong>확장성 및 성능 향상</strong>: 쓰기, 읽기 분리로 리소스 최적화 가능</li></ul><hr><h2 id=-기능-및-역할-key-functions--responsibilities>✅ 기능 및 역할 (Key Functions & Responsibilities)<a hidden class=anchor aria-hidden=true href=#-기능-및-역할-key-functions--responsibilities>#</a></h2><ul><li><strong>이벤트 기록(Event Logging)</strong>: 모든 상태 변경을 이벤트로 저장</li><li><strong>상태 재생(State Reconstruction)</strong>: 이벤트를 순차적으로 재생해 Aggregate 상태 복구 (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">microservices.io</a>, <a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">geeksforgeeks.org</a>)</li><li><strong>Projection 업데이트</strong>: 이벤트를 읽기 모델로 변환하여 효율적인 조회 제공</li><li><strong>이벤트 발행(Event Publishing)</strong>: 외부 시스템/서비스와 통합</li></ul><hr><h2 id=-특징-characteristics>🌟 특징 (Characteristics)<a hidden class=anchor aria-hidden=true href=#-특징-characteristics>#</a></h2><ul><li>Immutable event log (불변성)</li><li>Full audit trail (전체 이력 보존)</li><li>Eventual consistency (최종적 일관성)</li><li>Temporal queries support (시간여행 쿼리)</li><li>Replayability for recovery & testing</li></ul><hr><h2 id=-구현-기법-implementation-techniques>🧩 구현 기법 (Implementation Techniques)<a hidden class=anchor aria-hidden=true href=#-구현-기법-implementation-techniques>#</a></h2><ul><li><strong>Event Store 플랫폼</strong>: EventStoreDB, Apache Kafka, AWS Kinesis 등</li><li><strong>라이브러리 활용</strong>: eventsourcing (Python), Eventuate, Eventuous (.NET), node-eventstore (Node.js) (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">microservices.io</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">en.paradigmadigital.com</a>, <a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">kurrent.io</a>, <a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>c-sharpcorner.com</a>)</li><li><strong>Snapshot 활용</strong>: 이벤트 재생 성능 향상 위해 주기적 상태 저장</li><li><strong>이벤트 버전 관리</strong>: Upcasting, 호환성 레이어 설계 필요</li></ul><hr><h2 id=-장점--단점--해결-방안>🧠 장점 / 단점 & 해결 방안<a hidden class=anchor aria-hidden=true href=#-장점--단점--해결-방안>#</a></h2><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>장점</td><td>감사성 & 이력</td><td>모든 변경 이벤트 기록</td><td>이벤트 이벤트소싱 사용</td></tr><tr><td>장점</td><td>시간여행 쿼리</td><td>특정 시점 상태로 시스템 복원</td><td>Snapshot + 재생</td></tr><tr><td>장점</td><td>EDA 통합</td><td>마이크로·분산 시스템 연동 용이</td><td>Event Bus</td></tr><tr><td>단점</td><td>복잡한 이벤트 설계</td><td>Payload 설계, 버전 관리 필요</td><td>Event schema, Upcasting</td></tr><tr><td>단점</td><td>스토리지 증가</td><td>이벤트 저장소 커짐</td><td>스냅샷, Retention 정책</td></tr><tr><td>단점</td><td>성능 지연</td><td>Replay 비용 발생</td><td>Snapshot, 캐싱, 배치 처리</td></tr></tbody></table><hr><h2 id=-도전-과제-challenges>🚀 도전 과제 (Challenges)<a hidden class=anchor aria-hidden=true href=#-도전-과제-challenges>#</a></h2><ul><li><strong>Event ordering & partitioning</strong>: 동일 Aggregate 내 순서 유지 필수 (<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">upsolver.com</a>, <a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">stackoverflow.com</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">learn.microsoft.com</a>)</li><li><strong>GDPR / PII 삭제</strong>: 이벤트에서 개인정보 삭제 요구 복잡</li><li><strong>모니터링</strong>: 이벤트 지연, 누락, 소비 실패 등 상태 추적 필요</li><li><strong>테스트 / Debug</strong>: Replay, Snapshot, Projection 상태 검증용 테스트 전략 필요</li></ul><hr><h2 id=-분류-기준에-따른-유형-categorization-table>📘 분류 기준에 따른 유형 (Categorization Table)<a hidden class=anchor aria-hidden=true href=#-분류-기준에-따른-유형-categorization-table>#</a></h2><table><thead><tr><th>기준</th><th>유형</th><th>설명</th></tr></thead><tbody><tr><td>Snapshot 사용</td><td>Snapshot + Replay</td><td>이벤트 로그 재생 최적화</td></tr><tr><td>CQRS 결합</td><td>Event Sourcing + CQRS</td><td>읽기/쓰기 분리 최적화</td></tr><tr><td>동기성</td><td>Synchronous ES</td><td>커맨드 즉시 프로젝션 처리</td></tr><tr><td>비동기</td><td>Asynchronous ES</td><td>배치 또는 이벤트 발행 방식</td></tr></tbody></table><hr><h2 id=-실무-사용-예시-use-case-table>📚 실무 사용 예시 (Use Case Table)<a hidden class=anchor aria-hidden=true href=#-실무-사용-예시-use-case-table>#</a></h2><table><thead><tr><th>시스템 유형</th><th>목적</th><th>Event Sourcing 역할</th></tr></thead><tbody><tr><td>금융 트랜잭션</td><td>감사·복원</td><td>모든 거래 이벤트 기록</td></tr><tr><td>전자상거래</td><td>상태 추적</td><td>장바구니, 주문 상태 재생</td></tr><tr><td>협업 도구</td><td>작업 히스토리</td><td>문서 편집 이력 추적</td></tr><tr><td>IoT</td><td>센서 데이터</td><td>이벤트 로그로 시계열 기록</td></tr></tbody></table><hr><h2 id=-활용-사례--전자상거래-사례>✅ 활용 사례 – 전자상거래 사례<a hidden class=anchor aria-hidden=true href=#-활용-사례--전자상거래-사례>#</a></h2><ul><li><p><strong>시스템 구성</strong>
UI → Command Handler → Event Store → Event Bus → OrderProjection → Read DB</p></li><li><p><strong>워크플로우</strong></p><ol><li><code>CreateOrder</code> 커맨드 발행</li><li>이벤트 저장 후 프로젝션 업데이트</li><li>이미지 UI <code>GET /orders/{id}</code></li></ol></li><li><p><strong>비교: Event Sourcing 없을 경우</strong>
|user orders의 현재 상태만 저장 → 이벤트 이력 없음, 재생 불가|
Event Sourcing 적용 시: 이력 완전 기록 가능, 문제 발생 시 rollback 및 진단 가능</p></li></ul><hr><h2 id=-구현-예시-python-코드-개요>🛠 구현 예시 (Python 코드 개요)<a hidden class=anchor aria-hidden=true href=#-구현-예시-python-코드-개요>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a class=lnlinks href=#hl-49-1>1</a>
</span><span class=lnt id=hl-49-2><a class=lnlinks href=#hl-49-2>2</a>
</span><span class=lnt id=hl-49-3><a class=lnlinks href=#hl-49-3>3</a>
</span><span class=lnt id=hl-49-4><a class=lnlinks href=#hl-49-4>4</a>
</span><span class=lnt id=hl-49-5><a class=lnlinks href=#hl-49-5>5</a>
</span><span class=lnt id=hl-49-6><a class=lnlinks href=#hl-49-6>6</a>
</span><span class=lnt id=hl-49-7><a class=lnlinks href=#hl-49-7>7</a>
</span><span class=lnt id=hl-49-8><a class=lnlinks href=#hl-49-8>8</a>
</span><span class=lnt id=hl-49-9><a class=lnlinks href=#hl-49-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>(</span><span class=n>Aggregate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=o>...</span><span class=p>):</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply_OrderCreated</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply_ItemAdded</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># EventStore.save + snapshot + replay 기능 포함</span>
</span></span><span class=line><span class=cl><span class=n>eventlog</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>eventlog</span><span class=o>.</span><span class=n>load_stream</span><span class=p>(</span><span class=n>order_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=o>.</span><span class=n>add_item</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>eventlog</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=-요약>📌 요약<a hidden class=anchor aria-hidden=true href=#-요약>#</a></h2><p>Event Sourcing은 변경 이력을 이벤트 로그로 저장하는 패턴으로, 감사, 시간 여행, 복원 가능 시스템을 구현합니다. CQRS와 결합 시 읽기/쓰기 최적화도 가능하지만, 개발/운영 복잡도 증가, 이벤트 설계·관리와 스토리지 고려가 필요합니다. 도메인 특성과 성숙된 인프라를 갖춘 환경에서 효과적입니다.</p><hr><h2 id=-다음-진도>🔧 다음 진도<a hidden class=anchor aria-hidden=true href=#-다음-진도>#</a></h2><ul><li><strong>Snapshot + Replay 구현 예시 (Python)</strong></li><li><strong>Event versioning (Upcasting) 샘플</strong></li><li><strong>실제 프로젝트 구조 + 테스트 코드 구성</strong> 원하시면 말씀 주세요!</li></ul><p>Event Sourcing에 대한 포괄적인 조사와 분석을 시작하겠습니다. 먼저 최신 정보를 수집하여 체계적으로 정리해드리겠습니다.</p><h1 id=event-sourcing-포괄적-분석-및-조사>Event Sourcing 포괄적 분석 및 조사<a hidden class=anchor aria-hidden=true href=#event-sourcing-포괄적-분석-및-조사>#</a></h1><h2 id=1-기본-정보>1. 기본 정보<a hidden class=anchor aria-hidden=true href=#1-기본-정보>#</a></h2><h3 id=태그>태그<a hidden class=anchor aria-hidden=true href=#태그>#</a></h3><ul><li>Event-Sourcing</li><li>Data-Management</li><li>CQRS-Pattern</li><li>Architecture-Pattern</li></ul><h3 id=카테고리-분류-분석>카테고리 분류 분석<a hidden class=anchor aria-hidden=true href=#카테고리-분류-분석>#</a></h3><p>&ldquo;Computer Science and Engineering > Software Engineering > Design and Architecture > Architecture Patterns > Data Management Patterns"의 계층 구조는 매우 적절합니다.</p><p><strong>근거:</strong></p><ul><li>Event Sourcing은 소프트웨어 설계 아키텍처 패턴의 한 종류임</li><li>데이터 관리와 직접적으로 연관된 패턴임</li><li>애플리케이션 상태를 이벤트 시퀀스로 관리하는 아키텍처 접근법임</li><li>DDD, CQRS와 함께 사용되는 고급 설계 패턴임</li></ul><h3 id=요약-설명-200자-내외>요약 설명 (200자 내외)<a hidden class=anchor aria-hidden=true href=#요약-설명-200자-내외>#</a></h3><p>Event Sourcing은 애플리케이션 상태 변화를 불변의 이벤트 시퀀스로 저장하는 아키텍처 패턴입니다. 현재 상태만 저장하는 전통적 CRUD와 달리, 모든 변경사항을 이벤트로 기록하여 완전한 감사 추적과 시점별 상태 복원을 가능하게 합니다.</p><h3 id=개요-250자-내외>개요 (250자 내외)<a hidden class=anchor aria-hidden=true href=#개요-250자-내외>#</a></h3><p>Event Sourcing은 애플리케이션 상태를 이벤트 스트림으로 관리하는 데이터 아키텍처 패턴입니다. 각 상태 변화를 불변 이벤트로 append-only 저장소에 기록하며, 현재 상태는 이벤트를 순차적으로 재생하여 재구성합니다. CQRS와 함께 사용되어 읽기/쓰기 분리를 통한 성능 최적화와 복잡한 비즈니스 로직 처리에 적합합니다.</p><hr><h2 id=2-핵심-개념>2. 핵심 개념<a hidden class=anchor aria-hidden=true href=#2-핵심-개념>#</a></h2><h3 id=기본-개념>기본 개념<a hidden class=anchor aria-hidden=true href=#기본-개념>#</a></h3><p>Event Sourcing은 애플리케이션의 상태 변화를 순차적인 이벤트 시퀀스로 저장하는 아키텍처 패턴입니다. 전통적인 CRUD 방식이 현재 상태만 저장하는 것과 달리, 상태에 이르기까지의 모든 변화 과정을 불변의 이벤트로 기록합니다.</p><h3 id=핵심-구성-요소>핵심 구성 요소<a hidden class=anchor aria-hidden=true href=#핵심-구성-요소>#</a></h3><ul><li><strong>Event (이벤트)</strong>: 시스템에서 발생한 특정 변화를 나타내는 불변 객체</li><li><strong>Event Store (이벤트 저장소)</strong>: 이벤트를 시간순으로 저장하는 append-only 데이터베이스</li><li><strong>Event Stream (이벤트 스트림)</strong>: 특정 엔티티와 관련된 이벤트들의 순차적 시퀀스</li><li><strong>Aggregate (애그리거트)</strong>: 이벤트를 생성하고 상태를 관리하는 도메인 객체</li><li><strong>Projection (프로젝션)</strong>: 이벤트 스트림으로부터 파생된 읽기 전용 뷰</li></ul><h3 id=실무-구현-연관성>실무 구현 연관성<a hidden class=anchor aria-hidden=true href=#실무-구현-연관성>#</a></h3><p>핵심 개념들은 다음과 같은 측면에서 실무 구현과 밀접하게 연관됩니다:</p><ul><li><strong>이벤트 설계</strong>: 비즈니스 도메인의 중요한 변화를 정확히 캡처하는 이벤트 모델링 필요</li><li><strong>저장소 선택</strong>: 높은 쓰기 처리량과 순차 읽기에 최적화된 데이터베이스 선택 (EventStoreDB, Apache Kafka 등)</li><li><strong>상태 복원</strong>: 이벤트 재생을 통한 효율적인 상태 재구성 메커니즘 구현</li><li><strong>스키마 진화</strong>: 시간이 지나면서 변화하는 이벤트 스키마의 버전 관리</li></ul><hr><h2 id=3-배경-및-목적>3. 배경 및 목적<a hidden class=anchor aria-hidden=true href=#3-배경-및-목적>#</a></h2><h3 id=배경>배경<a hidden class=anchor aria-hidden=true href=#배경>#</a></h3><p>Event Sourcing은 Domain-Driven Design (DDD) 커뮤니티에서 발전된 패턴으로, Greg Young에 의해 2010년경 체계화되었습니다. 전통적인 상태 기반 저장소의 한계점을 해결하기 위해 등장했습니다.</p><h3 id=목적-및-필요성>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성>#</a></h3><ul><li><strong>완전한 감사 추적</strong>: 모든 변경사항의 완전한 히스토리 보존</li><li><strong>시점별 상태 복원</strong>: 과거 특정 시점의 시스템 상태 정확한 재구성</li><li><strong>비즈니스 인사이트</strong>: 상태 변화 패턴 분석을 통한 비즈니스 통찰력 확보</li><li><strong>시스템 복구</strong>: 데이터 손상 시 이벤트 재생을 통한 복구 가능</li><li><strong>확장성</strong>: 읽기와 쓰기 워크로드의 독립적 확장</li></ul><hr><h2 id=4-주요-기능-및-역할>4. 주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#4-주요-기능-및-역할>#</a></h2><h3 id=주요-기능>주요 기능<a hidden class=anchor aria-hidden=true href=#주요-기능>#</a></h3><ol><li><strong>이벤트 기록</strong>: 모든 상태 변화를 불변 이벤트로 순차 저장</li><li><strong>상태 재구성</strong>: 이벤트 재생을 통한 현재 상태 복원</li><li><strong>시간 여행</strong>: 과거 특정 시점의 상태 조회</li><li><strong>이벤트 스트리밍</strong>: 실시간 이벤트 스트림을 통한 다른 시스템과의 통합</li><li><strong>프로젝션 생성</strong>: 다양한 읽기 모델을 위한 뷰 생성</li></ol><h3 id=역할>역할<a hidden class=anchor aria-hidden=true href=#역할>#</a></h3><ul><li><strong>데이터 지속성</strong>: 애플리케이션 상태의 영구 저장</li><li><strong>감사 로그</strong>: 모든 비즈니스 작업의 완전한 추적성 제공</li><li><strong>이벤트 소싱</strong>: 다른 시스템으로의 실시간 이벤트 전파</li><li><strong>분석 기반</strong>: 비즈니스 분석을 위한 풍부한 데이터 소스 제공</li></ul><hr><h2 id=5-특징-및-핵심-원칙>5. 특징 및 핵심 원칙<a hidden class=anchor aria-hidden=true href=#5-특징-및-핵심-원칙>#</a></h2><h3 id=특징>특징<a hidden class=anchor aria-hidden=true href=#특징>#</a></h3><ul><li><strong>불변성</strong>: 저장된 이벤트는 변경되지 않음</li><li><strong>순차성</strong>: 이벤트는 발생 순서대로 저장됨</li><li><strong>완전성</strong>: 모든 상태 변화가 빠짐없이 기록됨</li><li><strong>결정론적</strong>: 동일한 이벤트 시퀀스는 항상 동일한 상태를 만듦</li></ul><h3 id=핵심-원칙>핵심 원칙<a hidden class=anchor aria-hidden=true href=#핵심-원칙>#</a></h3><ol><li><strong>Append-Only</strong>: 이벤트는 추가만 가능하고 수정/삭제 불가</li><li><strong>이벤트 우선</strong>: 이벤트가 시스템의 유일한 진실의 원천</li><li><strong>최종 일관성</strong>: 프로젝션과 뷰는 최종적으로 일관성을 가짐</li><li><strong>멱등성</strong>: 동일한 이벤트의 반복 처리가 안전함</li></ol><hr><h2 id=6-주요-원리-및-작동-원리>6. 주요 원리 및 작동 원리<a hidden class=anchor aria-hidden=true href=#6-주요-원리-및-작동-원리>#</a></h2><h3 id=주요-원리-다이어그램>주요 원리 다이어그램<a hidden class=anchor aria-hidden=true href=#주요-원리-다이어그램>#</a></h3><pre class=mermaid>graph TB
    A[Command] --&gt; B[Aggregate]
    B --&gt; C[Event]
    C --&gt; D[Event Store]
    D --&gt; E[Event Stream]
    E --&gt; F[Projection Engine]
    F --&gt; G[Read Model]
    
    H[Query] --&gt; G
    
    I[Event Replay] --&gt; E
    E --&gt; J[State Reconstruction]
    
    classDef commandFlow fill:#e1f5fe
    classDef eventFlow fill:#f3e5f5
    classDef queryFlow fill:#e8f5e8
    
    class A,B commandFlow
    class C,D,E,F eventFlow
    class H,G,I,J queryFlow
</pre><h3 id=작동-원리>작동 원리<a hidden class=anchor aria-hidden=true href=#작동-원리>#</a></h3><ol><li><p><strong>명령 처리 단계</strong></p><ul><li>사용자 명령이 애그리거트로 전달</li><li>애그리거트가 비즈니스 로직 실행</li><li>상태 변화를 나타내는 이벤트 생성</li></ul></li><li><p><strong>이벤트 저장 단계</strong></p><ul><li>생성된 이벤트를 Event Store에 순차적으로 추가</li><li>이벤트는 타임스탬프와 시퀀스 번호를 포함</li></ul></li><li><p><strong>프로젝션 업데이트 단계</strong></p><ul><li>저장된 이벤트가 프로젝션 엔진으로 전파</li><li>다양한 읽기 모델과 뷰가 업데이트</li></ul></li><li><p><strong>상태 조회 단계</strong></p><ul><li>읽기 요청시 프로젝션에서 데이터 조회</li><li>또는 이벤트 재생을 통한 실시간 상태 구성</li></ul></li></ol><hr><h2 id=7-구조-및-아키텍처>7. 구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#7-구조-및-아키텍처>#</a></h2><h3 id=전체-아키텍처-다이어그램>전체 아키텍처 다이어그램<a hidden class=anchor aria-hidden=true href=#전체-아키텍처-다이어그램>#</a></h3><pre class=mermaid>graph LR
    subgraph &#34;Command Side&#34;
        A[User Interface] --&gt; B[Command Handler]
        B --&gt; C[Aggregate]
        C --&gt; D[Domain Events]
    end
    
    subgraph &#34;Event Store&#34;
        D --&gt; E[Event Store Database]
        E --&gt; F[Event Streams]
    end
    
    subgraph &#34;Query Side&#34;
        F --&gt; G[Event Handlers]
        G --&gt; H[Projections]
        H --&gt; I[Read Database]
        I --&gt; J[Query Handlers]
        J --&gt; K[User Interface Views]
    end
    
    subgraph &#34;Infrastructure&#34;
        L[Message Bus]
        M[Event Publisher]
        N[Snapshots]
    end
    
    D --&gt; M
    M --&gt; L
    L --&gt; G
    E --&gt; N
    N --&gt; C
</pre><h3 id=필수-구성요소>필수 구성요소<a hidden class=anchor aria-hidden=true href=#필수-구성요소>#</a></h3><table><thead><tr><th>구성요소</th><th>기능</th><th>역할</th><th>특징</th></tr></thead><tbody><tr><td><strong>Event Store</strong></td><td>이벤트 영구 저장</td><td>시스템의 진실의 원천</td><td>Append-only, 불변성</td></tr><tr><td><strong>Aggregate</strong></td><td>비즈니스 로직 실행</td><td>이벤트 생성 및 상태 관리</td><td>일관성 경계</td></tr><tr><td><strong>Event</strong></td><td>상태 변화 기록</td><td>도메인 변화 표현</td><td>불변, 직렬화 가능</td></tr><tr><td><strong>Event Handler</strong></td><td>이벤트 처리</td><td>프로젝션 업데이트</td><td>비동기 처리</td></tr></tbody></table><h3 id=선택-구성요소>선택 구성요소<a hidden class=anchor aria-hidden=true href=#선택-구성요소>#</a></h3><table><thead><tr><th>구성요소</th><th>기능</th><th>역할</th><th>특징</th></tr></thead><tbody><tr><td><strong>Snapshot</strong></td><td>성능 최적화</td><td>상태 복원 가속화</td><td>선택적 최적화</td></tr><tr><td><strong>Message Bus</strong></td><td>이벤트 전파</td><td>시스템 간 통신</td><td>확장성 향상</td></tr><tr><td><strong>CQRS</strong></td><td>읽기/쓰기 분리</td><td>성능 최적화</td><td>Event Sourcing과 보완</td></tr><tr><td><strong>Saga</strong></td><td>분산 트랜잭션</td><td>마이크로서비스 조정</td><td>복잡한 워크플로우</td></tr></tbody></table><hr><h2 id=8-구현-기법>8. 구현 기법<a hidden class=anchor aria-hidden=true href=#8-구현-기법>#</a></h2><h3 id=1-기본-event-store-구현>1. 기본 Event Store 구현<a hidden class=anchor aria-hidden=true href=#1-기본-event-store-구현>#</a></h3><p><strong>정의</strong>: 이벤트를 순차적으로 저장하는 데이터베이스 구현
<strong>구성</strong>: 이벤트 테이블, 스트림 관리, 동시성 제어
<strong>목적</strong>: 모든 도메인 이벤트의 안전한 저장과 조회</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a class=lnlinks href=#hl-52-1> 1</a>
</span><span class=lnt id=hl-52-2><a class=lnlinks href=#hl-52-2> 2</a>
</span><span class=lnt id=hl-52-3><a class=lnlinks href=#hl-52-3> 3</a>
</span><span class=lnt id=hl-52-4><a class=lnlinks href=#hl-52-4> 4</a>
</span><span class=lnt id=hl-52-5><a class=lnlinks href=#hl-52-5> 5</a>
</span><span class=lnt id=hl-52-6><a class=lnlinks href=#hl-52-6> 6</a>
</span><span class=lnt id=hl-52-7><a class=lnlinks href=#hl-52-7> 7</a>
</span><span class=lnt id=hl-52-8><a class=lnlinks href=#hl-52-8> 8</a>
</span><span class=lnt id=hl-52-9><a class=lnlinks href=#hl-52-9> 9</a>
</span><span class=lnt id=hl-52-10><a class=lnlinks href=#hl-52-10>10</a>
</span><span class=lnt id=hl-52-11><a class=lnlinks href=#hl-52-11>11</a>
</span><span class=lnt id=hl-52-12><a class=lnlinks href=#hl-52-12>12</a>
</span><span class=lnt id=hl-52-13><a class=lnlinks href=#hl-52-13>13</a>
</span><span class=lnt id=hl-52-14><a class=lnlinks href=#hl-52-14>14</a>
</span><span class=lnt id=hl-52-15><a class=lnlinks href=#hl-52-15>15</a>
</span><span class=lnt id=hl-52-16><a class=lnlinks href=#hl-52-16>16</a>
</span><span class=lnt id=hl-52-17><a class=lnlinks href=#hl-52-17>17</a>
</span><span class=lnt id=hl-52-18><a class=lnlinks href=#hl-52-18>18</a>
</span><span class=lnt id=hl-52-19><a class=lnlinks href=#hl-52-19>19</a>
</span><span class=lnt id=hl-52-20><a class=lnlinks href=#hl-52-20>20</a>
</span><span class=lnt id=hl-52-21><a class=lnlinks href=#hl-52-21>21</a>
</span><span class=lnt id=hl-52-22><a class=lnlinks href=#hl-52-22>22</a>
</span><span class=lnt id=hl-52-23><a class=lnlinks href=#hl-52-23>23</a>
</span><span class=lnt id=hl-52-24><a class=lnlinks href=#hl-52-24>24</a>
</span><span class=lnt id=hl-52-25><a class=lnlinks href=#hl-52-25>25</a>
</span><span class=lnt id=hl-52-26><a class=lnlinks href=#hl-52-26>26</a>
</span><span class=lnt id=hl-52-27><a class=lnlinks href=#hl-52-27>27</a>
</span><span class=lnt id=hl-52-28><a class=lnlinks href=#hl-52-28>28</a>
</span><span class=lnt id=hl-52-29><a class=lnlinks href=#hl-52-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>version</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=o>=</span> <span class=n>aggregate_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_type</span> <span class=o>=</span> <span class=n>event_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>events</span><span class=p>,</span> <span class=n>expected_version</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>aggregate_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>current_version</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_version</span> <span class=o>!=</span> <span class=n>expected_version</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>ConcurrencyException</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=n>current_version</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>from_version</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>aggregate_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>][</span><span class=n>from_version</span><span class=p>:]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-snapshot-구현>2. Snapshot 구현<a hidden class=anchor aria-hidden=true href=#2-snapshot-구현>#</a></h3><p><strong>정의</strong>: 특정 시점의 애그리거트 상태를 저장하는 최적화 기법
<strong>구성</strong>: 스냅샷 저장소, 스냅샷 생성 정책, 복원 로직
<strong>목적</strong>: 많은 이벤트 재생 없이 빠른 상태 복원</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a class=lnlinks href=#hl-53-1> 1</a>
</span><span class=lnt id=hl-53-2><a class=lnlinks href=#hl-53-2> 2</a>
</span><span class=lnt id=hl-53-3><a class=lnlinks href=#hl-53-3> 3</a>
</span><span class=lnt id=hl-53-4><a class=lnlinks href=#hl-53-4> 4</a>
</span><span class=lnt id=hl-53-5><a class=lnlinks href=#hl-53-5> 5</a>
</span><span class=lnt id=hl-53-6><a class=lnlinks href=#hl-53-6> 6</a>
</span><span class=lnt id=hl-53-7><a class=lnlinks href=#hl-53-7> 7</a>
</span><span class=lnt id=hl-53-8><a class=lnlinks href=#hl-53-8> 8</a>
</span><span class=lnt id=hl-53-9><a class=lnlinks href=#hl-53-9> 9</a>
</span><span class=lnt id=hl-53-10><a class=lnlinks href=#hl-53-10>10</a>
</span><span class=lnt id=hl-53-11><a class=lnlinks href=#hl-53-11>11</a>
</span><span class=lnt id=hl-53-12><a class=lnlinks href=#hl-53-12>12</a>
</span><span class=lnt id=hl-53-13><a class=lnlinks href=#hl-53-13>13</a>
</span><span class=lnt id=hl-53-14><a class=lnlinks href=#hl-53-14>14</a>
</span><span class=lnt id=hl-53-15><a class=lnlinks href=#hl-53-15>15</a>
</span><span class=lnt id=hl-53-16><a class=lnlinks href=#hl-53-16>16</a>
</span><span class=lnt id=hl-53-17><a class=lnlinks href=#hl-53-17>17</a>
</span><span class=lnt id=hl-53-18><a class=lnlinks href=#hl-53-18>18</a>
</span><span class=lnt id=hl-53-19><a class=lnlinks href=#hl-53-19>19</a>
</span><span class=lnt id=hl-53-20><a class=lnlinks href=#hl-53-20>20</a>
</span><span class=lnt id=hl-53-21><a class=lnlinks href=#hl-53-21>21</a>
</span><span class=lnt id=hl-53-22><a class=lnlinks href=#hl-53-22>22</a>
</span><span class=lnt id=hl-53-23><a class=lnlinks href=#hl-53-23>23</a>
</span><span class=lnt id=hl-53-24><a class=lnlinks href=#hl-53-24>24</a>
</span><span class=lnt id=hl-53-25><a class=lnlinks href=#hl-53-25>25</a>
</span><span class=lnt id=hl-53-26><a class=lnlinks href=#hl-53-26>26</a>
</span><span class=lnt id=hl-53-27><a class=lnlinks href=#hl-53-27>27</a>
</span><span class=lnt id=hl-53-28><a class=lnlinks href=#hl-53-28>28</a>
</span><span class=lnt id=hl-53-29><a class=lnlinks href=#hl-53-29>29</a>
</span><span class=lnt id=hl-53-30><a class=lnlinks href=#hl-53-30>30</a>
</span><span class=lnt id=hl-53-31><a class=lnlinks href=#hl-53-31>31</a>
</span><span class=lnt id=hl-53-32><a class=lnlinks href=#hl-53-32>32</a>
</span><span class=lnt id=hl-53-33><a class=lnlinks href=#hl-53-33>33</a>
</span><span class=lnt id=hl-53-34><a class=lnlinks href=#hl-53-34>34</a>
</span><span class=lnt id=hl-53-35><a class=lnlinks href=#hl-53-35>35</a>
</span><span class=lnt id=hl-53-36><a class=lnlinks href=#hl-53-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Snapshot</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>version</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=o>=</span> <span class=n>aggregate_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SnapshotStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>snapshot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=p>[</span><span class=n>snapshot</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>snapshot</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshots</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AggregateRepository</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>,</span> <span class=n>snapshot_store</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span> <span class=o>=</span> <span class=n>snapshot_store</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_aggregate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>snapshot</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>snapshot_store</span><span class=o>.</span><span class=n>get_snapshot</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>snapshot</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>,</span> <span class=n>snapshot</span><span class=o>.</span><span class=n>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>restore_from_snapshot</span><span class=p>(</span><span class=n>snapshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=n>aggregate_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_new_aggregate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate</span><span class=o>.</span><span class=n>apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>aggregate</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-cqrs-프로젝션-구현>3. CQRS 프로젝션 구현<a hidden class=anchor aria-hidden=true href=#3-cqrs-프로젝션-구현>#</a></h3><p><strong>정의</strong>: 이벤트로부터 읽기 전용 뷰를 생성하는 메커니즘
<strong>구성</strong>: 이벤트 핸들러, 프로젝션 저장소, 업데이트 로직
<strong>목적</strong>: 쿼리에 최적화된 다양한 뷰 제공</p><p><strong>실제 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a class=lnlinks href=#hl-54-1> 1</a>
</span><span class=lnt id=hl-54-2><a class=lnlinks href=#hl-54-2> 2</a>
</span><span class=lnt id=hl-54-3><a class=lnlinks href=#hl-54-3> 3</a>
</span><span class=lnt id=hl-54-4><a class=lnlinks href=#hl-54-4> 4</a>
</span><span class=lnt id=hl-54-5><a class=lnlinks href=#hl-54-5> 5</a>
</span><span class=lnt id=hl-54-6><a class=lnlinks href=#hl-54-6> 6</a>
</span><span class=lnt id=hl-54-7><a class=lnlinks href=#hl-54-7> 7</a>
</span><span class=lnt id=hl-54-8><a class=lnlinks href=#hl-54-8> 8</a>
</span><span class=lnt id=hl-54-9><a class=lnlinks href=#hl-54-9> 9</a>
</span><span class=lnt id=hl-54-10><a class=lnlinks href=#hl-54-10>10</a>
</span><span class=lnt id=hl-54-11><a class=lnlinks href=#hl-54-11>11</a>
</span><span class=lnt id=hl-54-12><a class=lnlinks href=#hl-54-12>12</a>
</span><span class=lnt id=hl-54-13><a class=lnlinks href=#hl-54-13>13</a>
</span><span class=lnt id=hl-54-14><a class=lnlinks href=#hl-54-14>14</a>
</span><span class=lnt id=hl-54-15><a class=lnlinks href=#hl-54-15>15</a>
</span><span class=lnt id=hl-54-16><a class=lnlinks href=#hl-54-16>16</a>
</span><span class=lnt id=hl-54-17><a class=lnlinks href=#hl-54-17>17</a>
</span><span class=lnt id=hl-54-18><a class=lnlinks href=#hl-54-18>18</a>
</span><span class=lnt id=hl-54-19><a class=lnlinks href=#hl-54-19>19</a>
</span><span class=lnt id=hl-54-20><a class=lnlinks href=#hl-54-20>20</a>
</span><span class=lnt id=hl-54-21><a class=lnlinks href=#hl-54-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderProjection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>orders</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;customer_id&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;created&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_confirmed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;confirmed&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;confirmed_at&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_orders_by_customer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>order</span> <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>values</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s1>&#39;customer_id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>customer_id</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=9-장점>9. 장점<a hidden class=anchor aria-hidden=true href=#9-장점>#</a></h2><table><thead><tr><th>구분</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>장점</td><td><strong>완전한 감사 추적</strong></td><td>모든 상태 변화가 불변 이벤트로 기록되어 완벽한 감사 로그 제공. 규정 준수와 보안 감사에 필수적</td></tr><tr><td></td><td><strong>시점별 상태 복원</strong></td><td>이벤트 재생을 통해 과거 임의 시점의 정확한 상태 재구성 가능. 디버깅과 분석에 강력한 도구 제공</td></tr><tr><td></td><td><strong>높은 쓰기 성능</strong></td><td>Append-only 구조로 락 경합 최소화하여 높은 쓰기 처리량 달성</td></tr><tr><td></td><td><strong>이벤트 기반 통합</strong></td><td>이벤트 스트림을 통한 자연스러운 시스템 간 통합과 마이크로서비스 아키텍처 지원</td></tr><tr><td></td><td><strong>비즈니스 인사이트</strong></td><td>이벤트 히스토리를 통한 풍부한 비즈니스 분석과 패턴 인식 가능</td></tr><tr><td></td><td><strong>확장성</strong></td><td>CQRS와 결합하여 읽기와 쓰기 워크로드의 독립적 확장 지원</td></tr></tbody></table><hr><h2 id=10-단점과-문제점-그리고-해결방안>10. 단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#10-단점과-문제점-그리고-해결방안>#</a></h2><h3 id=단점-1>단점<a hidden class=anchor aria-hidden=true href=#단점-1>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>단점</td><td><strong>복잡성 증가</strong></td><td>전통적 CRUD 대비 시스템 설계와 구현 복잡도 대폭 증가</td><td>단계별 도입, 팀 교육, 프레임워크 활용</td></tr><tr><td></td><td><strong>학습 곡선</strong></td><td>개발팀의 새로운 패러다임 학습 필요, 개발 생산성 초기 저하</td><td>충분한 교육 기간, 멘토링, 점진적 적용</td></tr><tr><td></td><td><strong>저장소 요구사항</strong></td><td>모든 이벤트 저장으로 인한 높은 스토리지 사용량</td><td>이벤트 압축, 아카이빙, 스냅샷 활용</td></tr><tr><td></td><td><strong>최종 일관성</strong></td><td>프로젝션 업데이트 지연으로 인한 읽기 데이터 불일치 가능성</td><td>적절한 캐싱, 사용자 경험 설계, 일관성 모니터링</td></tr></tbody></table><h3 id=문제점-2>문제점<a hidden class=anchor aria-hidden=true href=#문제점-2>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>문제점</td><td><strong>이벤트 재생 성능 저하</strong></td><td>대량의 이벤트 누적으로 상태 복원 시간 증가</td><td>시스템 응답 시간 저하, 사용자 경험 악화</td><td>성능 모니터링, 재생 시간 측정</td><td>스냅샷 정책 수립, 이벤트 스트림 설계 최적화</td><td>스냅샷 구현, 이벤트 압축, 스트림 분할</td></tr><tr><td></td><td><strong>스키마 진화 문제</strong></td><td>시간이 지나면서 이벤트 구조 변경 필요성</td><td>기존 이벤트와 호환성 문제</td><td>스키마 버전 추적, 역직렬화 오류 모니터링</td><td>이벤트 버전 관리, 스키마 레지스트리 사용</td><td>이벤트 업캐스팅, 다중 버전 지원</td></tr><tr><td></td><td><strong>동시성 충돌</strong></td><td>동일 애그리거트에 대한 동시 업데이트</td><td>데이터 일관성 문제, 비즈니스 규칙 위반</td><td>버전 충돌 예외 모니터링</td><td>낙관적 동시성 제어, 적절한 애그리거트 경계 설정</td><td>재시도 메커니즘, 충돌 해결 정책 구현</td></tr><tr><td></td><td><strong>프로젝션 실패</strong></td><td>이벤트 처리 중 오류 발생</td><td>읽기 모델 불일치, 데이터 누락</td><td>프로젝션 상태 모니터링, 이벤트 처리 로그</td><td>멱등한 이벤트 핸들러 설계, 오류 처리 로직</td><td>Dead Letter Queue, 수동 복구 도구, 프로젝션 재구축</td></tr></tbody></table><hr><h2 id=11-도전-과제>11. 도전 과제<a hidden class=anchor aria-hidden=true href=#11-도전-과제>#</a></h2><h3 id=성능-및-확장성-과제>성능 및 확장성 과제<a hidden class=anchor aria-hidden=true href=#성능-및-확장성-과제>#</a></h3><p><strong>원인</strong>: 이벤트 볼륨 증가와 복잡한 프로젝션 처리
<strong>영향</strong>: 시스템 응답 시간 저하와 리소스 사용량 증가
<strong>해결 방법</strong>:</p><ul><li>이벤트 스트림 파티셔닝</li><li>병렬 프로젝션 처리</li><li>캐싱 전략 최적화</li><li>하드웨어 스케일 아웃</li></ul><h3 id=데이터-일관성-과제>데이터 일관성 과제<a hidden class=anchor aria-hidden=true href=#데이터-일관성-과제>#</a></h3><p><strong>원인</strong>: 분산 환경에서의 최종 일관성 모델
<strong>영향</strong>: 일시적 데이터 불일치와 사용자 혼란
<strong>해결 방법</strong>:</p><ul><li>적절한 일관성 경계 설정</li><li>사용자 인터페이스에서 일관성 상태 표시</li><li>보상 트랜잭션 구현</li></ul><h3 id=운영-및-모니터링-과제>운영 및 모니터링 과제<a hidden class=anchor aria-hidden=true href=#운영-및-모니터링-과제>#</a></h3><p><strong>원인</strong>: 복잡한 이벤트 기반 워크플로우
<strong>영향</strong>: 문제 진단 어려움과 운영 복잡성
<strong>해결 방법</strong>:</p><ul><li>포괄적인 이벤트 추적 시스템</li><li>실시간 대시보드와 알림</li><li>자동화된 복구 메커니즘</li></ul><hr><h2 id=12-분류-기준에-따른-종류-및-유형>12. 분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#12-분류-기준에-따른-종류-및-유형>#</a></h2><table><thead><tr><th>분류 기준</th><th>종류/유형</th><th>설명</th><th>특징</th></tr></thead><tbody><tr><td><strong>저장소 타입</strong></td><td>In-Memory</td><td>메모리 내 이벤트 저장</td><td>빠른 성능, 휘발성</td></tr><tr><td></td><td>Relational DB</td><td>관계형 데이터베이스 사용</td><td>ACID 보장, 복잡한 쿼리</td></tr><tr><td></td><td>NoSQL</td><td>문서/키-값 데이터베이스</td><td>수평 확장, 스키마 유연성</td></tr><tr><td></td><td>Specialized</td><td>EventStoreDB 등 전용 저장소</td><td>이벤트 최적화, 고성능</td></tr><tr><td><strong>아키텍처 패턴</strong></td><td>Pure Event Sourcing</td><td>이벤트만으로 상태 관리</td><td>완전한 이벤트 기반</td></tr><tr><td></td><td>CQRS + Event Sourcing</td><td>읽기/쓰기 분리 결합</td><td>성능 최적화</td></tr><tr><td></td><td>Hybrid</td><td>일부 상태는 전통적 저장</td><td>점진적 도입 가능</td></tr><tr><td><strong>동시성 모델</strong></td><td>Single Writer</td><td>단일 작성자 모델</td><td>충돌 방지</td></tr><tr><td></td><td>Optimistic Concurrency</td><td>낙관적 동시성 제어</td><td>높은 처리량</td></tr><tr><td></td><td>Event Collapsing</td><td>이벤트 병합</td><td>중복 제거</td></tr></tbody></table><hr><h2 id=13-실무-사용-예시>13. 실무 사용 예시<a hidden class=anchor aria-hidden=true href=#13-실무-사용-예시>#</a></h2><table><thead><tr><th>활용 영역</th><th>목적</th><th>효과</th><th>동반 기술</th></tr></thead><tbody><tr><td><strong>금융 시스템</strong></td><td>거래 내역 완전 추적, 규정 준수</td><td>완벽한 감사 추적, 사기 탐지 향상</td><td>CQRS, 블록체인</td></tr><tr><td><strong>전자상거래</strong></td><td>주문 상태 관리, 재고 추적</td><td>정확한 재고 관리, 주문 히스토리 분석</td><td>마이크로서비스, API Gateway</td></tr><tr><td><strong>의료 정보 시스템</strong></td><td>환자 진료 기록 관리</td><td>의료 과실 방지, 치료 이력 추적</td><td>HL7 FHIR, 암호화</td></tr><tr><td><strong>게임 플랫폼</strong></td><td>플레이어 행동 분석, 게임 상태 관리</td><td>치트 방지, 게임 밸런싱 개선</td><td>실시간 분석, Machine Learning</td></tr><tr><td><strong>IoT 플랫폼</strong></td><td>센서 데이터 수집, 이벤트 처리</td><td>예측 유지보수, 이상 탐지</td><td>Stream Processing, Edge Computing</td></tr></tbody></table><hr><h2 id=14-활용-사례-전자상거래-주문-관리-시스템>14. 활용 사례: 전자상거래 주문 관리 시스템<a hidden class=anchor aria-hidden=true href=#14-활용-사례-전자상거래-주문-관리-시스템>#</a></h2><h3 id=시스템-구성-1>시스템 구성<a hidden class=anchor aria-hidden=true href=#시스템-구성-1>#</a></h3><pre class=mermaid>graph TB
    subgraph &#34;사용자 인터페이스&#34;
        A[Web Frontend]
        B[Mobile App]
    end
    
    subgraph &#34;API Gateway&#34;
        C[Order API]
        D[Inventory API]
        E[Payment API]
    end
    
    subgraph &#34;Command Side&#34;
        F[Order Service]
        G[Inventory Service]
        H[Payment Service]
    end
    
    subgraph &#34;Event Store&#34;
        I[(EventStoreDB)]
    end
    
    subgraph &#34;Query Side&#34;
        J[Order Projection]
        K[Inventory Projection]
        L[Analytics Projection]
        M[(Read Database)]
    end
    
    subgraph &#34;Message Bus&#34;
        N[Kafka]
    end
    
    A --&gt; C
    B --&gt; C
    C --&gt; F
    F --&gt; I
    I --&gt; N
    N --&gt; J
    J --&gt; M
    M --&gt; A
</pre><h3 id=workflow-1>Workflow<a hidden class=anchor aria-hidden=true href=#workflow-1>#</a></h3><ol><li><p><strong>주문 생성</strong></p><ul><li>고객이 상품을 장바구니에 추가하고 주문 생성</li><li>OrderCreatedEvent 생성 및 저장</li><li>재고 서비스로 이벤트 전파</li></ul></li><li><p><strong>재고 확인 및 예약</strong></p><ul><li>재고 서비스가 주문 이벤트 수신</li><li>재고 확인 후 ItemReservedEvent 생성</li><li>결제 서비스로 이벤트 전파</li></ul></li><li><p><strong>결제 처리</strong></p><ul><li>결제 서비스가 결제 진행</li><li>PaymentProcessedEvent 생성</li><li>주문 확정 처리</li></ul></li></ol><h3 id=event-sourcing의-역할>Event Sourcing의 역할<a hidden class=anchor aria-hidden=true href=#event-sourcing의-역할>#</a></h3><ul><li><strong>상태 추적</strong>: 주문의 모든 상태 변화를 이벤트로 기록</li><li><strong>일관성 보장</strong>: 서비스 간 이벤트 기반 통신으로 최종 일관성 확보</li><li><strong>감사 추적</strong>: 주문 처리 과정의 완전한 추적 가능</li><li><strong>복구 지원</strong>: 시스템 장애 시 이벤트 재생을 통한 상태 복구</li></ul><h3 id=event-sourcing-유무에-따른-차이점>Event Sourcing 유무에 따른 차이점<a hidden class=anchor aria-hidden=true href=#event-sourcing-유무에-따른-차이점>#</a></h3><p><strong>Event Sourcing 사용</strong>:</p><ul><li>주문 상태 변화의 완전한 히스토리 보존</li><li>서비스 간 느슨한 결합</li><li>높은 확장성과 가용성</li><li>복잡한 비즈니스 로직 처리 용이</li></ul><p><strong>전통적 CRUD 사용</strong>:</p><ul><li>현재 상태만 저장하여 히스토리 손실</li><li>서비스 간 강한 결합</li><li>확장성 제한</li><li>동시성 문제와 데이터 일관성 이슈</li></ul><hr><h2 id=15-구현-예시>15. 구현 예시<a hidden class=anchor aria-hidden=true href=#15-구현-예시>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-56-1><a class=lnlinks href=#hl-56-1>  1</a>
</span><span class=lnt id=hl-56-2><a class=lnlinks href=#hl-56-2>  2</a>
</span><span class=lnt id=hl-56-3><a class=lnlinks href=#hl-56-3>  3</a>
</span><span class=lnt id=hl-56-4><a class=lnlinks href=#hl-56-4>  4</a>
</span><span class=lnt id=hl-56-5><a class=lnlinks href=#hl-56-5>  5</a>
</span><span class=lnt id=hl-56-6><a class=lnlinks href=#hl-56-6>  6</a>
</span><span class=lnt id=hl-56-7><a class=lnlinks href=#hl-56-7>  7</a>
</span><span class=lnt id=hl-56-8><a class=lnlinks href=#hl-56-8>  8</a>
</span><span class=lnt id=hl-56-9><a class=lnlinks href=#hl-56-9>  9</a>
</span><span class=lnt id=hl-56-10><a class=lnlinks href=#hl-56-10> 10</a>
</span><span class=lnt id=hl-56-11><a class=lnlinks href=#hl-56-11> 11</a>
</span><span class=lnt id=hl-56-12><a class=lnlinks href=#hl-56-12> 12</a>
</span><span class=lnt id=hl-56-13><a class=lnlinks href=#hl-56-13> 13</a>
</span><span class=lnt id=hl-56-14><a class=lnlinks href=#hl-56-14> 14</a>
</span><span class=lnt id=hl-56-15><a class=lnlinks href=#hl-56-15> 15</a>
</span><span class=lnt id=hl-56-16><a class=lnlinks href=#hl-56-16> 16</a>
</span><span class=lnt id=hl-56-17><a class=lnlinks href=#hl-56-17> 17</a>
</span><span class=lnt id=hl-56-18><a class=lnlinks href=#hl-56-18> 18</a>
</span><span class=lnt id=hl-56-19><a class=lnlinks href=#hl-56-19> 19</a>
</span><span class=lnt id=hl-56-20><a class=lnlinks href=#hl-56-20> 20</a>
</span><span class=lnt id=hl-56-21><a class=lnlinks href=#hl-56-21> 21</a>
</span><span class=lnt id=hl-56-22><a class=lnlinks href=#hl-56-22> 22</a>
</span><span class=lnt id=hl-56-23><a class=lnlinks href=#hl-56-23> 23</a>
</span><span class=lnt id=hl-56-24><a class=lnlinks href=#hl-56-24> 24</a>
</span><span class=lnt id=hl-56-25><a class=lnlinks href=#hl-56-25> 25</a>
</span><span class=lnt id=hl-56-26><a class=lnlinks href=#hl-56-26> 26</a>
</span><span class=lnt id=hl-56-27><a class=lnlinks href=#hl-56-27> 27</a>
</span><span class=lnt id=hl-56-28><a class=lnlinks href=#hl-56-28> 28</a>
</span><span class=lnt id=hl-56-29><a class=lnlinks href=#hl-56-29> 29</a>
</span><span class=lnt id=hl-56-30><a class=lnlinks href=#hl-56-30> 30</a>
</span><span class=lnt id=hl-56-31><a class=lnlinks href=#hl-56-31> 31</a>
</span><span class=lnt id=hl-56-32><a class=lnlinks href=#hl-56-32> 32</a>
</span><span class=lnt id=hl-56-33><a class=lnlinks href=#hl-56-33> 33</a>
</span><span class=lnt id=hl-56-34><a class=lnlinks href=#hl-56-34> 34</a>
</span><span class=lnt id=hl-56-35><a class=lnlinks href=#hl-56-35> 35</a>
</span><span class=lnt id=hl-56-36><a class=lnlinks href=#hl-56-36> 36</a>
</span><span class=lnt id=hl-56-37><a class=lnlinks href=#hl-56-37> 37</a>
</span><span class=lnt id=hl-56-38><a class=lnlinks href=#hl-56-38> 38</a>
</span><span class=lnt id=hl-56-39><a class=lnlinks href=#hl-56-39> 39</a>
</span><span class=lnt id=hl-56-40><a class=lnlinks href=#hl-56-40> 40</a>
</span><span class=lnt id=hl-56-41><a class=lnlinks href=#hl-56-41> 41</a>
</span><span class=lnt id=hl-56-42><a class=lnlinks href=#hl-56-42> 42</a>
</span><span class=lnt id=hl-56-43><a class=lnlinks href=#hl-56-43> 43</a>
</span><span class=lnt id=hl-56-44><a class=lnlinks href=#hl-56-44> 44</a>
</span><span class=lnt id=hl-56-45><a class=lnlinks href=#hl-56-45> 45</a>
</span><span class=lnt id=hl-56-46><a class=lnlinks href=#hl-56-46> 46</a>
</span><span class=lnt id=hl-56-47><a class=lnlinks href=#hl-56-47> 47</a>
</span><span class=lnt id=hl-56-48><a class=lnlinks href=#hl-56-48> 48</a>
</span><span class=lnt id=hl-56-49><a class=lnlinks href=#hl-56-49> 49</a>
</span><span class=lnt id=hl-56-50><a class=lnlinks href=#hl-56-50> 50</a>
</span><span class=lnt id=hl-56-51><a class=lnlinks href=#hl-56-51> 51</a>
</span><span class=lnt id=hl-56-52><a class=lnlinks href=#hl-56-52> 52</a>
</span><span class=lnt id=hl-56-53><a class=lnlinks href=#hl-56-53> 53</a>
</span><span class=lnt id=hl-56-54><a class=lnlinks href=#hl-56-54> 54</a>
</span><span class=lnt id=hl-56-55><a class=lnlinks href=#hl-56-55> 55</a>
</span><span class=lnt id=hl-56-56><a class=lnlinks href=#hl-56-56> 56</a>
</span><span class=lnt id=hl-56-57><a class=lnlinks href=#hl-56-57> 57</a>
</span><span class=lnt id=hl-56-58><a class=lnlinks href=#hl-56-58> 58</a>
</span><span class=lnt id=hl-56-59><a class=lnlinks href=#hl-56-59> 59</a>
</span><span class=lnt id=hl-56-60><a class=lnlinks href=#hl-56-60> 60</a>
</span><span class=lnt id=hl-56-61><a class=lnlinks href=#hl-56-61> 61</a>
</span><span class=lnt id=hl-56-62><a class=lnlinks href=#hl-56-62> 62</a>
</span><span class=lnt id=hl-56-63><a class=lnlinks href=#hl-56-63> 63</a>
</span><span class=lnt id=hl-56-64><a class=lnlinks href=#hl-56-64> 64</a>
</span><span class=lnt id=hl-56-65><a class=lnlinks href=#hl-56-65> 65</a>
</span><span class=lnt id=hl-56-66><a class=lnlinks href=#hl-56-66> 66</a>
</span><span class=lnt id=hl-56-67><a class=lnlinks href=#hl-56-67> 67</a>
</span><span class=lnt id=hl-56-68><a class=lnlinks href=#hl-56-68> 68</a>
</span><span class=lnt id=hl-56-69><a class=lnlinks href=#hl-56-69> 69</a>
</span><span class=lnt id=hl-56-70><a class=lnlinks href=#hl-56-70> 70</a>
</span><span class=lnt id=hl-56-71><a class=lnlinks href=#hl-56-71> 71</a>
</span><span class=lnt id=hl-56-72><a class=lnlinks href=#hl-56-72> 72</a>
</span><span class=lnt id=hl-56-73><a class=lnlinks href=#hl-56-73> 73</a>
</span><span class=lnt id=hl-56-74><a class=lnlinks href=#hl-56-74> 74</a>
</span><span class=lnt id=hl-56-75><a class=lnlinks href=#hl-56-75> 75</a>
</span><span class=lnt id=hl-56-76><a class=lnlinks href=#hl-56-76> 76</a>
</span><span class=lnt id=hl-56-77><a class=lnlinks href=#hl-56-77> 77</a>
</span><span class=lnt id=hl-56-78><a class=lnlinks href=#hl-56-78> 78</a>
</span><span class=lnt id=hl-56-79><a class=lnlinks href=#hl-56-79> 79</a>
</span><span class=lnt id=hl-56-80><a class=lnlinks href=#hl-56-80> 80</a>
</span><span class=lnt id=hl-56-81><a class=lnlinks href=#hl-56-81> 81</a>
</span><span class=lnt id=hl-56-82><a class=lnlinks href=#hl-56-82> 82</a>
</span><span class=lnt id=hl-56-83><a class=lnlinks href=#hl-56-83> 83</a>
</span><span class=lnt id=hl-56-84><a class=lnlinks href=#hl-56-84> 84</a>
</span><span class=lnt id=hl-56-85><a class=lnlinks href=#hl-56-85> 85</a>
</span><span class=lnt id=hl-56-86><a class=lnlinks href=#hl-56-86> 86</a>
</span><span class=lnt id=hl-56-87><a class=lnlinks href=#hl-56-87> 87</a>
</span><span class=lnt id=hl-56-88><a class=lnlinks href=#hl-56-88> 88</a>
</span><span class=lnt id=hl-56-89><a class=lnlinks href=#hl-56-89> 89</a>
</span><span class=lnt id=hl-56-90><a class=lnlinks href=#hl-56-90> 90</a>
</span><span class=lnt id=hl-56-91><a class=lnlinks href=#hl-56-91> 91</a>
</span><span class=lnt id=hl-56-92><a class=lnlinks href=#hl-56-92> 92</a>
</span><span class=lnt id=hl-56-93><a class=lnlinks href=#hl-56-93> 93</a>
</span><span class=lnt id=hl-56-94><a class=lnlinks href=#hl-56-94> 94</a>
</span><span class=lnt id=hl-56-95><a class=lnlinks href=#hl-56-95> 95</a>
</span><span class=lnt id=hl-56-96><a class=lnlinks href=#hl-56-96> 96</a>
</span><span class=lnt id=hl-56-97><a class=lnlinks href=#hl-56-97> 97</a>
</span><span class=lnt id=hl-56-98><a class=lnlinks href=#hl-56-98> 98</a>
</span><span class=lnt id=hl-56-99><a class=lnlinks href=#hl-56-99> 99</a>
</span><span class=lnt id=hl-56-100><a class=lnlinks href=#hl-56-100>100</a>
</span><span class=lnt id=hl-56-101><a class=lnlinks href=#hl-56-101>101</a>
</span><span class=lnt id=hl-56-102><a class=lnlinks href=#hl-56-102>102</a>
</span><span class=lnt id=hl-56-103><a class=lnlinks href=#hl-56-103>103</a>
</span><span class=lnt id=hl-56-104><a class=lnlinks href=#hl-56-104>104</a>
</span><span class=lnt id=hl-56-105><a class=lnlinks href=#hl-56-105>105</a>
</span><span class=lnt id=hl-56-106><a class=lnlinks href=#hl-56-106>106</a>
</span><span class=lnt id=hl-56-107><a class=lnlinks href=#hl-56-107>107</a>
</span><span class=lnt id=hl-56-108><a class=lnlinks href=#hl-56-108>108</a>
</span><span class=lnt id=hl-56-109><a class=lnlinks href=#hl-56-109>109</a>
</span><span class=lnt id=hl-56-110><a class=lnlinks href=#hl-56-110>110</a>
</span><span class=lnt id=hl-56-111><a class=lnlinks href=#hl-56-111>111</a>
</span><span class=lnt id=hl-56-112><a class=lnlinks href=#hl-56-112>112</a>
</span><span class=lnt id=hl-56-113><a class=lnlinks href=#hl-56-113>113</a>
</span><span class=lnt id=hl-56-114><a class=lnlinks href=#hl-56-114>114</a>
</span><span class=lnt id=hl-56-115><a class=lnlinks href=#hl-56-115>115</a>
</span><span class=lnt id=hl-56-116><a class=lnlinks href=#hl-56-116>116</a>
</span><span class=lnt id=hl-56-117><a class=lnlinks href=#hl-56-117>117</a>
</span><span class=lnt id=hl-56-118><a class=lnlinks href=#hl-56-118>118</a>
</span><span class=lnt id=hl-56-119><a class=lnlinks href=#hl-56-119>119</a>
</span><span class=lnt id=hl-56-120><a class=lnlinks href=#hl-56-120>120</a>
</span><span class=lnt id=hl-56-121><a class=lnlinks href=#hl-56-121>121</a>
</span><span class=lnt id=hl-56-122><a class=lnlinks href=#hl-56-122>122</a>
</span><span class=lnt id=hl-56-123><a class=lnlinks href=#hl-56-123>123</a>
</span><span class=lnt id=hl-56-124><a class=lnlinks href=#hl-56-124>124</a>
</span><span class=lnt id=hl-56-125><a class=lnlinks href=#hl-56-125>125</a>
</span><span class=lnt id=hl-56-126><a class=lnlinks href=#hl-56-126>126</a>
</span><span class=lnt id=hl-56-127><a class=lnlinks href=#hl-56-127>127</a>
</span><span class=lnt id=hl-56-128><a class=lnlinks href=#hl-56-128>128</a>
</span><span class=lnt id=hl-56-129><a class=lnlinks href=#hl-56-129>129</a>
</span><span class=lnt id=hl-56-130><a class=lnlinks href=#hl-56-130>130</a>
</span><span class=lnt id=hl-56-131><a class=lnlinks href=#hl-56-131>131</a>
</span><span class=lnt id=hl-56-132><a class=lnlinks href=#hl-56-132>132</a>
</span><span class=lnt id=hl-56-133><a class=lnlinks href=#hl-56-133>133</a>
</span><span class=lnt id=hl-56-134><a class=lnlinks href=#hl-56-134>134</a>
</span><span class=lnt id=hl-56-135><a class=lnlinks href=#hl-56-135>135</a>
</span><span class=lnt id=hl-56-136><a class=lnlinks href=#hl-56-136>136</a>
</span><span class=lnt id=hl-56-137><a class=lnlinks href=#hl-56-137>137</a>
</span><span class=lnt id=hl-56-138><a class=lnlinks href=#hl-56-138>138</a>
</span><span class=lnt id=hl-56-139><a class=lnlinks href=#hl-56-139>139</a>
</span><span class=lnt id=hl-56-140><a class=lnlinks href=#hl-56-140>140</a>
</span><span class=lnt id=hl-56-141><a class=lnlinks href=#hl-56-141>141</a>
</span><span class=lnt id=hl-56-142><a class=lnlinks href=#hl-56-142>142</a>
</span><span class=lnt id=hl-56-143><a class=lnlinks href=#hl-56-143>143</a>
</span><span class=lnt id=hl-56-144><a class=lnlinks href=#hl-56-144>144</a>
</span><span class=lnt id=hl-56-145><a class=lnlinks href=#hl-56-145>145</a>
</span><span class=lnt id=hl-56-146><a class=lnlinks href=#hl-56-146>146</a>
</span><span class=lnt id=hl-56-147><a class=lnlinks href=#hl-56-147>147</a>
</span><span class=lnt id=hl-56-148><a class=lnlinks href=#hl-56-148>148</a>
</span><span class=lnt id=hl-56-149><a class=lnlinks href=#hl-56-149>149</a>
</span><span class=lnt id=hl-56-150><a class=lnlinks href=#hl-56-150>150</a>
</span><span class=lnt id=hl-56-151><a class=lnlinks href=#hl-56-151>151</a>
</span><span class=lnt id=hl-56-152><a class=lnlinks href=#hl-56-152>152</a>
</span><span class=lnt id=hl-56-153><a class=lnlinks href=#hl-56-153>153</a>
</span><span class=lnt id=hl-56-154><a class=lnlinks href=#hl-56-154>154</a>
</span><span class=lnt id=hl-56-155><a class=lnlinks href=#hl-56-155>155</a>
</span><span class=lnt id=hl-56-156><a class=lnlinks href=#hl-56-156>156</a>
</span><span class=lnt id=hl-56-157><a class=lnlinks href=#hl-56-157>157</a>
</span><span class=lnt id=hl-56-158><a class=lnlinks href=#hl-56-158>158</a>
</span><span class=lnt id=hl-56-159><a class=lnlinks href=#hl-56-159>159</a>
</span><span class=lnt id=hl-56-160><a class=lnlinks href=#hl-56-160>160</a>
</span><span class=lnt id=hl-56-161><a class=lnlinks href=#hl-56-161>161</a>
</span><span class=lnt id=hl-56-162><a class=lnlinks href=#hl-56-162>162</a>
</span><span class=lnt id=hl-56-163><a class=lnlinks href=#hl-56-163>163</a>
</span><span class=lnt id=hl-56-164><a class=lnlinks href=#hl-56-164>164</a>
</span><span class=lnt id=hl-56-165><a class=lnlinks href=#hl-56-165>165</a>
</span><span class=lnt id=hl-56-166><a class=lnlinks href=#hl-56-166>166</a>
</span><span class=lnt id=hl-56-167><a class=lnlinks href=#hl-56-167>167</a>
</span><span class=lnt id=hl-56-168><a class=lnlinks href=#hl-56-168>168</a>
</span><span class=lnt id=hl-56-169><a class=lnlinks href=#hl-56-169>169</a>
</span><span class=lnt id=hl-56-170><a class=lnlinks href=#hl-56-170>170</a>
</span><span class=lnt id=hl-56-171><a class=lnlinks href=#hl-56-171>171</a>
</span><span class=lnt id=hl-56-172><a class=lnlinks href=#hl-56-172>172</a>
</span><span class=lnt id=hl-56-173><a class=lnlinks href=#hl-56-173>173</a>
</span><span class=lnt id=hl-56-174><a class=lnlinks href=#hl-56-174>174</a>
</span><span class=lnt id=hl-56-175><a class=lnlinks href=#hl-56-175>175</a>
</span><span class=lnt id=hl-56-176><a class=lnlinks href=#hl-56-176>176</a>
</span><span class=lnt id=hl-56-177><a class=lnlinks href=#hl-56-177>177</a>
</span><span class=lnt id=hl-56-178><a class=lnlinks href=#hl-56-178>178</a>
</span><span class=lnt id=hl-56-179><a class=lnlinks href=#hl-56-179>179</a>
</span><span class=lnt id=hl-56-180><a class=lnlinks href=#hl-56-180>180</a>
</span><span class=lnt id=hl-56-181><a class=lnlinks href=#hl-56-181>181</a>
</span><span class=lnt id=hl-56-182><a class=lnlinks href=#hl-56-182>182</a>
</span><span class=lnt id=hl-56-183><a class=lnlinks href=#hl-56-183>183</a>
</span><span class=lnt id=hl-56-184><a class=lnlinks href=#hl-56-184>184</a>
</span><span class=lnt id=hl-56-185><a class=lnlinks href=#hl-56-185>185</a>
</span><span class=lnt id=hl-56-186><a class=lnlinks href=#hl-56-186>186</a>
</span><span class=lnt id=hl-56-187><a class=lnlinks href=#hl-56-187>187</a>
</span><span class=lnt id=hl-56-188><a class=lnlinks href=#hl-56-188>188</a>
</span><span class=lnt id=hl-56-189><a class=lnlinks href=#hl-56-189>189</a>
</span><span class=lnt id=hl-56-190><a class=lnlinks href=#hl-56-190>190</a>
</span><span class=lnt id=hl-56-191><a class=lnlinks href=#hl-56-191>191</a>
</span><span class=lnt id=hl-56-192><a class=lnlinks href=#hl-56-192>192</a>
</span><span class=lnt id=hl-56-193><a class=lnlinks href=#hl-56-193>193</a>
</span><span class=lnt id=hl-56-194><a class=lnlinks href=#hl-56-194>194</a>
</span><span class=lnt id=hl-56-195><a class=lnlinks href=#hl-56-195>195</a>
</span><span class=lnt id=hl-56-196><a class=lnlinks href=#hl-56-196>196</a>
</span><span class=lnt id=hl-56-197><a class=lnlinks href=#hl-56-197>197</a>
</span><span class=lnt id=hl-56-198><a class=lnlinks href=#hl-56-198>198</a>
</span><span class=lnt id=hl-56-199><a class=lnlinks href=#hl-56-199>199</a>
</span><span class=lnt id=hl-56-200><a class=lnlinks href=#hl-56-200>200</a>
</span><span class=lnt id=hl-56-201><a class=lnlinks href=#hl-56-201>201</a>
</span><span class=lnt id=hl-56-202><a class=lnlinks href=#hl-56-202>202</a>
</span><span class=lnt id=hl-56-203><a class=lnlinks href=#hl-56-203>203</a>
</span><span class=lnt id=hl-56-204><a class=lnlinks href=#hl-56-204>204</a>
</span><span class=lnt id=hl-56-205><a class=lnlinks href=#hl-56-205>205</a>
</span><span class=lnt id=hl-56-206><a class=lnlinks href=#hl-56-206>206</a>
</span><span class=lnt id=hl-56-207><a class=lnlinks href=#hl-56-207>207</a>
</span><span class=lnt id=hl-56-208><a class=lnlinks href=#hl-56-208>208</a>
</span><span class=lnt id=hl-56-209><a class=lnlinks href=#hl-56-209>209</a>
</span><span class=lnt id=hl-56-210><a class=lnlinks href=#hl-56-210>210</a>
</span><span class=lnt id=hl-56-211><a class=lnlinks href=#hl-56-211>211</a>
</span><span class=lnt id=hl-56-212><a class=lnlinks href=#hl-56-212>212</a>
</span><span class=lnt id=hl-56-213><a class=lnlinks href=#hl-56-213>213</a>
</span><span class=lnt id=hl-56-214><a class=lnlinks href=#hl-56-214>214</a>
</span><span class=lnt id=hl-56-215><a class=lnlinks href=#hl-56-215>215</a>
</span><span class=lnt id=hl-56-216><a class=lnlinks href=#hl-56-216>216</a>
</span><span class=lnt id=hl-56-217><a class=lnlinks href=#hl-56-217>217</a>
</span><span class=lnt id=hl-56-218><a class=lnlinks href=#hl-56-218>218</a>
</span><span class=lnt id=hl-56-219><a class=lnlinks href=#hl-56-219>219</a>
</span><span class=lnt id=hl-56-220><a class=lnlinks href=#hl-56-220>220</a>
</span><span class=lnt id=hl-56-221><a class=lnlinks href=#hl-56-221>221</a>
</span><span class=lnt id=hl-56-222><a class=lnlinks href=#hl-56-222>222</a>
</span><span class=lnt id=hl-56-223><a class=lnlinks href=#hl-56-223>223</a>
</span><span class=lnt id=hl-56-224><a class=lnlinks href=#hl-56-224>224</a>
</span><span class=lnt id=hl-56-225><a class=lnlinks href=#hl-56-225>225</a>
</span><span class=lnt id=hl-56-226><a class=lnlinks href=#hl-56-226>226</a>
</span><span class=lnt id=hl-56-227><a class=lnlinks href=#hl-56-227>227</a>
</span><span class=lnt id=hl-56-228><a class=lnlinks href=#hl-56-228>228</a>
</span><span class=lnt id=hl-56-229><a class=lnlinks href=#hl-56-229>229</a>
</span><span class=lnt id=hl-56-230><a class=lnlinks href=#hl-56-230>230</a>
</span><span class=lnt id=hl-56-231><a class=lnlinks href=#hl-56-231>231</a>
</span><span class=lnt id=hl-56-232><a class=lnlinks href=#hl-56-232>232</a>
</span><span class=lnt id=hl-56-233><a class=lnlinks href=#hl-56-233>233</a>
</span><span class=lnt id=hl-56-234><a class=lnlinks href=#hl-56-234>234</a>
</span><span class=lnt id=hl-56-235><a class=lnlinks href=#hl-56-235>235</a>
</span><span class=lnt id=hl-56-236><a class=lnlinks href=#hl-56-236>236</a>
</span><span class=lnt id=hl-56-237><a class=lnlinks href=#hl-56-237>237</a>
</span><span class=lnt id=hl-56-238><a class=lnlinks href=#hl-56-238>238</a>
</span><span class=lnt id=hl-56-239><a class=lnlinks href=#hl-56-239>239</a>
</span><span class=lnt id=hl-56-240><a class=lnlinks href=#hl-56-240>240</a>
</span><span class=lnt id=hl-56-241><a class=lnlinks href=#hl-56-241>241</a>
</span><span class=lnt id=hl-56-242><a class=lnlinks href=#hl-56-242>242</a>
</span><span class=lnt id=hl-56-243><a class=lnlinks href=#hl-56-243>243</a>
</span><span class=lnt id=hl-56-244><a class=lnlinks href=#hl-56-244>244</a>
</span><span class=lnt id=hl-56-245><a class=lnlinks href=#hl-56-245>245</a>
</span><span class=lnt id=hl-56-246><a class=lnlinks href=#hl-56-246>246</a>
</span><span class=lnt id=hl-56-247><a class=lnlinks href=#hl-56-247>247</a>
</span><span class=lnt id=hl-56-248><a class=lnlinks href=#hl-56-248>248</a>
</span><span class=lnt id=hl-56-249><a class=lnlinks href=#hl-56-249>249</a>
</span><span class=lnt id=hl-56-250><a class=lnlinks href=#hl-56-250>250</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 이벤트 기본 클래스</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DomainEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=o>=</span> <span class=n>aggregate_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_type</span> <span class=o>=</span> <span class=n>event_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>to_dict</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;aggregate_id&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;event_type&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>timestamp</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 주문 관련 이벤트들</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderCreatedEvent</span><span class=p>(</span><span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;OrderCreated&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_id&#39;</span><span class=p>:</span> <span class=n>customer_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;quantity&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderConfirmedEvent</span><span class=p>(</span><span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>payment_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;OrderConfirmed&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;payment_id&#39;</span><span class=p>:</span> <span class=n>payment_id</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderShippedEvent</span><span class=p>(</span><span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>tracking_number</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;OrderShipped&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tracking_number&#39;</span><span class=p>:</span> <span class=n>tracking_number</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 주문 상태 열거형</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderStatus</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>CREATED</span> <span class=o>=</span> <span class=s2>&#34;created&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CONFIRMED</span> <span class=o>=</span> <span class=s2>&#34;confirmed&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>SHIPPED</span> <span class=o>=</span> <span class=s2>&#34;shipped&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>DELIVERED</span> <span class=o>=</span> <span class=s2>&#34;delivered&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CANCELLED</span> <span class=o>=</span> <span class=s2>&#34;cancelled&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 주문 애그리거트</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>payment_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tracking_number</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;새 주문 생성&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Order already exists&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>OrderCreatedEvent</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>,</span> <span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>confirm_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payment_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 확정&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=n>OrderStatus</span><span class=o>.</span><span class=n>CREATED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Order cannot be confirmed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>OrderConfirmedEvent</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>payment_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ship_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tracking_number</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 배송&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=n>OrderStatus</span><span class=o>.</span><span class=n>CONFIRMED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Order cannot be shipped&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>OrderShippedEvent</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>tracking_number</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_apply_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 애그리거트에 적용&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;OrderCreated&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;customer_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;items&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>total</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>OrderStatus</span><span class=o>.</span><span class=n>CREATED</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;OrderConfirmed&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>payment_id</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;payment_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>OrderStatus</span><span class=o>.</span><span class=n>CONFIRMED</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s1>&#39;OrderShipped&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>tracking_number</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;tracking_number&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>OrderStatus</span><span class=o>.</span><span class=n>SHIPPED</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_from_history</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>DomainEvent</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트 히스토리로부터 상태 복원&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_apply_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_uncommitted_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;커밋되지 않은 이벤트 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mark_events_committed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 커밋된 것으로 표시&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 이벤트 저장소</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>DomainEvent</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>DomainEvent</span><span class=p>],</span> <span class=n>expected_version</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트를 스트림에 추가&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>aggregate_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>current_version</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_version</span> <span class=o>!=</span> <span class=n>expected_version</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Concurrency conflict. Expected version </span><span class=si>{</span><span class=n>expected_version</span><span class=si>}</span><span class=s2>, but was </span><span class=si>{</span><span class=n>current_version</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=n>current_version</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current_version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>from_version</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>DomainEvent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;이벤트 스트림 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>aggregate_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>[</span><span class=n>aggregate_id</span><span class=p>][</span><span class=n>from_version</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 주문 레포지토리</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderRepository</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>:</span> <span class=n>EventStore</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order</span><span class=p>:</span> <span class=n>Order</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 저장 (이벤트 저장)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=n>order</span><span class=o>.</span><span class=n>get_uncommitted_events</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>expected_version</span> <span class=o>=</span> <span class=n>order</span><span class=o>.</span><span class=n>version</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>append_events</span><span class=p>(</span><span class=n>order</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>events</span><span class=p>,</span> <span class=n>expected_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>order</span><span class=o>.</span><span class=n>mark_events_committed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 로드 (이벤트 재생)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>load_from_history</span><span class=p>(</span><span class=n>events</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 주문 프로젝션 (CQRS 읽기 모델)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderProjection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>OrderCreatedEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 이벤트 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;customer_id&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;items&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;created&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;payment_id&#39;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tracking_number&#39;</span><span class=p>:</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_confirmed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>OrderConfirmedEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 확정 이벤트 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;confirmed&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;payment_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;payment_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;confirmed_at&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_shipped</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>OrderShippedEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 배송 이벤트 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;shipped&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;tracking_number&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;tracking_number&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>][</span><span class=s1>&#39;shipped_at&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_orders_by_customer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;고객별 주문 목록 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>order</span> <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=o>.</span><span class=n>values</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s1>&#39;customer_id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>customer_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 인프라 설정</span>
</span></span><span class=line><span class=cl>    <span class=n>event_store</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>order_repository</span> <span class=o>=</span> <span class=n>OrderRepository</span><span class=p>(</span><span class=n>event_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>order_projection</span> <span class=o>=</span> <span class=n>OrderProjection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 새 주문 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=s2>&#34;order-123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=n>create_order</span><span class=p>(</span><span class=s2>&#34;customer-456&#34;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;product_id&#34;</span><span class=p>:</span> <span class=s2>&#34;p1&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;상품1&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>10000</span><span class=p>,</span> <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;product_id&#34;</span><span class=p>:</span> <span class=s2>&#34;p2&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;상품2&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>5000</span><span class=p>,</span> <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 주문 저장</span>
</span></span><span class=line><span class=cl>    <span class=n>order_repository</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 프로젝션 업데이트 (실제로는 이벤트 버스를 통해 자동화)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=s2>&#34;order-123&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderCreatedEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>order_projection</span><span class=o>.</span><span class=n>handle_order_created</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 주문 확정</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=o>.</span><span class=n>confirm_order</span><span class=p>(</span><span class=s2>&#34;payment-789&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>order_repository</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 프로젝션 업데이트</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>event_store</span><span class=o>.</span><span class=n>get_events</span><span class=p>(</span><span class=s2>&#34;order-123&#34;</span><span class=p>,</span> <span class=n>from_version</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderConfirmedEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>order_projection</span><span class=o>.</span><span class=n>handle_order_confirmed</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 읽기 모델에서 주문 조회</span>
</span></span><span class=line><span class=cl>    <span class=n>order_view</span> <span class=o>=</span> <span class=n>order_projection</span><span class=o>.</span><span class=n>get_order</span><span class=p>(</span><span class=s2>&#34;order-123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 상태: </span><span class=si>{</span><span class=n>order_view</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;총 금액: </span><span class=si>{</span><span class=n>order_view</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 이벤트 히스토리로부터 주문 복원</span>
</span></span><span class=line><span class=cl>    <span class=n>restored_order</span> <span class=o>=</span> <span class=n>order_repository</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;order-123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;복원된 주문 상태: </span><span class=si>{</span><span class=n>restored_order</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=16-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>16. 실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#16-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h2><table><thead><tr><th>카테고리</th><th>고려사항</th><th>주의할 점</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>도메인 모델링</strong></td><td>비즈니스 이벤트 식별</td><td>기술적 이벤트와 비즈니스 이벤트 혼동</td><td>도메인 전문가와 협업하여 의미있는 이벤트 정의</td></tr><tr><td><strong>애그리거트 설계</strong></td><td>적절한 경계 설정</td><td>너무 큰 애그리거트로 인한 성능 저하</td><td>단일 트랜잭션 경계 내에서 일관성 보장 범위 설정</td></tr><tr><td><strong>이벤트 스키마</strong></td><td>진화 가능한 스키마 설계</td><td>하위 호환성 깨짐</td><td>스키마 버전 관리와 업캐스팅 전략 수립</td></tr><tr><td><strong>동시성 제어</strong></td><td>낙관적 동시성 선택</td><td>높은 충돌률 환경에서 성능 저하</td><td>비즈니스 특성에 맞는 동시성 전략 선택</td></tr><tr><td><strong>저장소 선택</strong></td><td>요구사항에 맞는 저장소</td><td>잘못된 저장소 선택으로 인한 성능 문제</td><td>이벤트 처리량, 쿼리 패턴 분석 후 선택</td></tr></tbody></table><hr><h2 id=17-최적화하기-위한-고려사항-및-주의할-점>17. 최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#17-최적화하기-위한-고려사항-및-주의할-점>#</a></h2><table><thead><tr><th>카테고리</th><th>고려사항</th><th>주의할 점</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>성능 최적화</strong></td><td>스냅샷 전략 수립</td><td>너무 빈번한 스냅샷으로 인한 오버헤드</td><td>비즈니스 특성에 맞는 스냅샷 주기 결정</td></tr><tr><td><strong>캐싱 전략</strong></td><td>읽기 성능 향상</td><td>캐시 일관성 문제</td><td>Redis, 메모리 캐시를 활용한 계층화된 캐싱</td></tr><tr><td><strong>이벤트 압축</strong></td><td>저장소 용량 최적화</td><td>중요한 이벤트 손실 위험</td><td>비즈니스 규칙에 따른 압축 정책 수립</td></tr><tr><td><strong>파티셔닝</strong></td><td>수평 확장 지원</td><td>파티션 간 이벤트 순서 보장 문제</td><td>애그리거트 ID 기반 파티셔닝 전략</td></tr><tr><td><strong>배치 처리</strong></td><td>프로젝션 처리 최적화</td><td>실시간성 요구사항과 충돌</td><td>실시간과 배치 처리의 하이브리드 접근</td></tr></tbody></table><hr><h2 id=18-주제와-관련하여-주목할-내용>18. 주제와 관련하여 주목할 내용<a hidden class=anchor aria-hidden=true href=#18-주제와-관련하여-주목할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>아키텍처 패턴</strong></td><td>CQRS</td><td>Command Query Responsibility Segregation</td><td>Event Sourcing과 함께 사용되는 읽기/쓰기 분리 패턴</td></tr><tr><td></td><td>Saga Pattern</td><td>분산 트랜잭션 관리</td><td>마이크로서비스 환경에서 장기 실행 프로세스 조정</td></tr><tr><td><strong>데이터 관리</strong></td><td>Event Store</td><td>전용 이벤트 데이터베이스</td><td>이벤트 저장에 특화된 데이터베이스 솔루션</td></tr><tr><td></td><td>Stream Processing</td><td>실시간 이벤트 처리</td><td>Apache Kafka, Pulsar 등을 활용한 스트리밍 처리</td></tr><tr><td><strong>구현 기술</strong></td><td>Event Versioning</td><td>이벤트 스키마 버전 관리</td><td>시간에 따른 이벤트 구조 변화 대응</td></tr><tr><td></td><td>Projection</td><td>읽기 모델 생성</td><td>이벤트로부터 다양한 뷰 생성 기법</td></tr><tr><td><strong>성능 최적화</strong></td><td>Snapshots</td><td>상태 복원 최적화</td><td>긴 이벤트 스트림의 성능 문제 해결</td></tr><tr><td></td><td>Caching</td><td>캐시 전략</td><td>Redis, 메모리 캐시를 활용한 성능 향상</td></tr></tbody></table><hr><h2 id=19-반드시-학습해야할-내용>19. 반드시 학습해야할 내용<a hidden class=anchor aria-hidden=true href=#19-반드시-학습해야할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>기초 개념</strong></td><td>Domain-Driven Design</td><td>도메인 주도 설계</td><td>Event Sourcing의 이론적 기반이 되는 설계 방법론</td></tr><tr><td></td><td>Aggregate Pattern</td><td>애그리거트 패턴</td><td>일관성 경계를 정의하는 DDD 핵심 패턴</td></tr><tr><td><strong>관련 패턴</strong></td><td>CQRS</td><td>명령 쿼리 책임 분리</td><td>Event Sourcing과 함께 사용되는 핵심 패턴</td></tr><tr><td></td><td>Materialized View</td><td>구체화된 뷰</td><td>이벤트로부터 읽기 최적화 뷰 생성</td></tr><tr><td><strong>기술 스택</strong></td><td>Message Broker</td><td>메시지 브로커</td><td>Apache Kafka, RabbitMQ 등 이벤트 전파 기술</td></tr><tr><td></td><td>Event Store Database</td><td>이벤트 저장소</td><td>EventStoreDB, Apache Kafka 등 전용 데이터베이스</td></tr><tr><td><strong>고급 주제</strong></td><td>Event Sourcing Patterns</td><td>이벤트 소싱 패턴들</td><td>Snapshot, Upcasting, Event Collapsing 등</td></tr><tr><td></td><td>Distributed Systems</td><td>분산 시스템</td><td>CAP 정리, 일관성 모델, 분산 트랜잭션</td></tr></tbody></table><hr><h2 id=용어-정리-4>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리-4>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td><strong>핵심 개념</strong></td><td>Event Store (이벤트 저장소)</td><td>이벤트를 시간순으로 저장하는 append-only 데이터베이스</td></tr><tr><td></td><td>Event Stream (이벤트 스트림)</td><td>특정 애그리거트와 관련된 이벤트들의 순차적 시퀀스</td></tr><tr><td></td><td>Aggregate (애그리거트)</td><td>일관성 경계를 형성하는 도메인 객체들의 집합</td></tr><tr><td></td><td>Projection (프로젝션)</td><td>이벤트 스트림으로부터 생성되는 읽기 전용 뷰</td></tr><tr><td><strong>기술 용어</strong></td><td>Snapshot (스냅샷)</td><td>특정 시점의 애그리거트 상태를 저장한 최적화 기법</td></tr><tr><td></td><td>Upcasting (업캐스팅)</td><td>구버전 이벤트를 신버전 형식으로 변환하는 과정</td></tr><tr><td></td><td>Idempotency (멱등성)</td><td>동일한 연산을 여러 번 수행해도 결과가 같은 성질</td></tr><tr><td></td><td>Optimistic Concurrency (낙관적 동시성)</td><td>충돌이 드물다고 가정하고 충돌 시 재시도하는 제어 방식</td></tr><tr><td><strong>아키텍처</strong></td><td>Command Handler (명령 핸들러)</td><td>사용자 명령을 받아 비즈니스 로직을 실행하는 컴포넌트</td></tr><tr><td></td><td>Event Handler (이벤트 핸들러)</td><td>이벤트를 받아 프로젝션을 업데이트하는 컴포넌트</td></tr><tr><td></td><td>Append-Only (추가 전용)</td><td>데이터 수정이나 삭제 없이 추가만 가능한 저장 방식</td></tr><tr><td></td><td>Eventually Consistent (최종 일관성)</td><td>즉시는 아니지만 결국에는 일관된 상태에 도달하는 일관성 모델</td></tr></tbody></table><hr><h2 id=참고-및-출처-4>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-4>#</a></h2><ul><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing>Event Sourcing pattern - Azure Architecture Center</a></li><li><a href=https://microservices.io/patterns/data/event-sourcing.html>Microservices Pattern: Event sourcing</a></li><li><a href=https://martinfowler.com/eaaDev/EventSourcing.html>Event Sourcing - Martin Fowler</a></li><li><a href=https://www.baeldung.com/cqrs-event-sourcing-java>CQRS and Event Sourcing in Java - Baeldung</a></li><li><a href=https://www.geeksforgeeks.org/dbms/event-sourcing-database-design-patterns/>Event Sourcing Database Design Patterns - GeeksforGeeks</a></li><li><a href=https://www.kurrent.io/event-sourcing>Beginner&rsquo;s Guide to Event Sourcing - Kurrent</a></li><li><a href=https://www.redpanda.com/guides/event-stream-processing-event-sourcing-database>Event sourcing database architecture - Redpanda</a></li><li><a href=https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/event-sourcing.html>Event Sourcing pattern - AWS Prescriptive Guidance</a></li></ul><hr><h2 id=1-태그-1>1. 태그<a hidden class=anchor aria-hidden=true href=#1-태그-1>#</a></h2><ul><li><strong>Event-Sourcing</strong></li><li><strong>Event-Driven-Architecture</strong></li><li><strong>CQRS-Pattern</strong></li><li><strong>Data-Management</strong></li></ul><hr><h2 id=2-분류-구조-분석>2. 분류 구조 분석<a hidden class=anchor aria-hidden=true href=#2-분류-구조-분석>#</a></h2><p><strong>계층 구조:</strong><br>Computer Science and Engineering > Software Engineering > Design and Architecture > Architecture Styles and Patterns > Architecture Patterns > Data Management</p><p><strong>분석 및 근거:</strong><br>이벤트 소싱은 시스템의 모든 상태 변경을 이벤트로 기록하고, 이를 통해 상태를 재구성하는 아키텍처 패턴입니다. 이는 “Architecture Styles and Patterns” 하위의 “Architecture Patterns”에 적합하며, 데이터 관리(Data Management)와도 밀접하게 연관되어 있으므로 하위로 포함하는 것이 타당합니다<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">1</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">3</a>.<br>이벤트 소싱은 이벤트 기반 아키텍처(Event-Driven Architecture), CQRS, 마이크로서비스 등과 함께 사용되어 확장성, 유지보수성, 감사 추적, 장애 복구 등 다양한 이점을 제공합니다.</p><hr><h2 id=3-요약200자-내외>3. 요약(200자 내외)<a hidden class=anchor aria-hidden=true href=#3-요약200자-내외>#</a></h2><p>이벤트 소싱은 시스템의 모든 상태 변화를 불변의 이벤트로 저장하고, 이를 재생하여 언제든지 상태를 재구성할 수 있는 데이터 관리 및 설계 패턴이다<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">5</a>.</p><hr><h2 id=4-개요250자-내외>4. 개요(250자 내외)<a hidden class=anchor aria-hidden=true href=#4-개요250자-내외>#</a></h2><p>이벤트 소싱은 기존 데이터베이스가 최종 상태만 저장하는 방식과 달리, 모든 상태 변화를 불변의 이벤트로 순차적으로 기록하여, 이벤트를 재생하면 시스템의 현재 상태와 과거 이력을 모두 추적할 수 있게 해주는 아키텍처 패턴이다. 감사, 장애 복구, 분석 등에 매우 효과적이다<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">1</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">3</a>.</p><hr><h2 id=5-핵심-개념-1>5. 핵심 개념<a hidden class=anchor aria-hidden=true href=#5-핵심-개념-1>#</a></h2><ul><li><strong>이벤트(Event):</strong> 시스템에서 발생한 상태 변화(예: 계좌 개설, 입금, 출금 등)를 불변의 기록으로 저장<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">4</a><a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">7</a>.</li><li><strong>이벤트 저장소(Event Store):</strong> 모든 이벤트를 순차적으로 저장하는 저장소<a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>3</a><a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">9</a>.</li><li><strong>상태 재구성(Replay):</strong> 저장된 이벤트를 순차적으로 재생하여 현재 상태를 계산<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>불변성(Immutable):</strong> 이벤트는 한 번 기록되면 변경 또는 삭제되지 않음<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">4</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>애그리게이트(Aggregate):</strong> 여러 이벤트를 묶어 하나의 도메인 객체로 관리하는 단위<a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf?utm_source=chatgpt.com" title="[PDF] CQRS Documents by Greg Young">11</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul><p><strong>실무 구현 요소</strong></p><ul><li><strong>이벤트(Event):</strong> 상태 변화 기록(필수)</li><li><strong>이벤트 저장소(Event Store):</strong> 이벤트 저장(필수)</li><li><strong>애그리게이트(Aggregate):</strong> 이벤트를 처리해 상태를 관리(필수)</li><li><strong>이벤트 핸들러(Event Handler):</strong> 이벤트 처리(필수)</li><li><strong>스냅샷(Snapshot):</strong> 주기적으로 상태를 저장해 재생 시간 단축(선택)</li><li><strong>커맨드(Command):</strong> 시스템에 수행 요청(필요 시)</li><li><strong>프로젝션(Projection):</strong> 이벤트를 기반으로 뷰(Read Model) 생성(필요 시, CQRS와 연계)</li></ul><hr><h2 id=6-조사-내용주요-항목별-정리>6. 조사 내용(주요 항목별 정리)<a hidden class=anchor aria-hidden=true href=#6-조사-내용주요-항목별-정리>#</a></h2><h3 id=배경-1>배경<a hidden class=anchor aria-hidden=true href=#배경-1>#</a></h3><p>기존 CRUD 방식은 최종 상태만 저장하므로, 과거 이력 추적이나 장애 복구, 감사, 분석이 어렵고, 동시성 문제 등 한계가 있었음. 이벤트 소싱은 이러한 문제를 해결하기 위해 등장한 패턴<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">14</a>.</p><h3 id=목적-및-필요성-1>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성-1>#</a></h3><ul><li><strong>감사 및 이력 추적:</strong> 모든 상태 변화를 이벤트로 기록해 추적 가능<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">2</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>장애 복구:</strong> 이벤트 재생을 통해 특정 시점으로 복구 가능<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">3</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>분석 및 디버깅:</strong> 이벤트 로그를 통해 시스템 동작 분석 및 디버깅 용이<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">2</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>확장성 및 유지보수성:</strong> 이벤트 기반 아키텍처와 결합해 확장성, 유지보수성 향상<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">2</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul><h3 id=주요-기능-및-역할>주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#주요-기능-및-역할>#</a></h3><ul><li><strong>이벤트 기록:</strong> 모든 상태 변화를 이벤트로 저장<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>상태 재구성:</strong> 이벤트를 재생해 현재 상태 계산<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>감사 및 분석:</strong> 이벤트 로그를 활용한 감사, 분석<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">2</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>장애 복구:</strong> 특정 시점으로 상태 복구<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">3</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li></ul><h3 id=특징-1>특징<a hidden class=anchor aria-hidden=true href=#특징-1>#</a></h3><ul><li><strong>불변성:</strong> 이벤트는 변경, 삭제 불가<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">4</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>순차적 기록:</strong> 이벤트는 시간 순서대로 저장<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>재생 가능:</strong> 이벤트를 재생해 상태 복원<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>감사 및 추적:</strong> 모든 상태 변화 이력 보관<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">2</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li></ul><h3 id=핵심-원칙-1>핵심 원칙<a hidden class=anchor aria-hidden=true href=#핵심-원칙-1>#</a></h3><ul><li><strong>불변성:</strong> 이벤트는 한 번 기록되면 변경 불가<a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">4</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>순차성:</strong> 이벤트는 시간 순서대로 저장<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>재생 가능성:</strong> 이벤트를 재생해 상태 복원<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li><li><strong>감사 가능성:</strong> 모든 상태 변화 이력 보관<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">2</a><a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">10</a>.</li></ul><h3 id=주요-원리-및-작동-원리>주요 원리 및 작동 원리<a hidden class=anchor aria-hidden=true href=#주요-원리-및-작동-원리>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-57-1><a class=lnlinks href=#hl-57-1> 1</a>
</span><span class=lnt id=hl-57-2><a class=lnlinks href=#hl-57-2> 2</a>
</span><span class=lnt id=hl-57-3><a class=lnlinks href=#hl-57-3> 3</a>
</span><span class=lnt id=hl-57-4><a class=lnlinks href=#hl-57-4> 4</a>
</span><span class=lnt id=hl-57-5><a class=lnlinks href=#hl-57-5> 5</a>
</span><span class=lnt id=hl-57-6><a class=lnlinks href=#hl-57-6> 6</a>
</span><span class=lnt id=hl-57-7><a class=lnlinks href=#hl-57-7> 7</a>
</span><span class=lnt id=hl-57-8><a class=lnlinks href=#hl-57-8> 8</a>
</span><span class=lnt id=hl-57-9><a class=lnlinks href=#hl-57-9> 9</a>
</span><span class=lnt id=hl-57-10><a class=lnlinks href=#hl-57-10>10</a>
</span><span class=lnt id=hl-57-11><a class=lnlinks href=#hl-57-11>11</a>
</span><span class=lnt id=hl-57-12><a class=lnlinks href=#hl-57-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Diagram: Event Sourcing Flow]
</span></span><span class=line><span class=cl>┌─────────────┐   ┌─────────────┐   ┌─────────────┐
</span></span><span class=line><span class=cl>│   Command   │ → │  Aggregate  │ → │   Event     │
</span></span><span class=line><span class=cl>└─────────────┘   └─────────────┘   └─────────────┘
</span></span><span class=line><span class=cl>                                      ↓
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                Event Store                      │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>                                      ↓
</span></span><span class=line><span class=cl>┌─────────────┐   ┌─────────────┐   ┌─────────────┐
</span></span><span class=line><span class=cl>│   Replay    │ ← │  Projection │ ← │   Query     │
</span></span><span class=line><span class=cl>└─────────────┘   └─────────────┘   └─────────────┘
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>Command:</strong> 시스템에 상태 변경 요청</li><li><strong>Aggregate:</strong> 이벤트를 생성해 상태 관리</li><li><strong>Event:</strong> 상태 변화 기록</li><li><strong>Event Store:</strong> 이벤트 저장</li><li><strong>Replay:</strong> 이벤트 재생으로 상태 복원</li><li><strong>Projection:</strong> 이벤트를 기반으로 뷰(Read Model) 생성</li></ul><h3 id=구조-및-아키텍처>구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#구조-및-아키텍처>#</a></h3><ul><li><strong>이벤트(Event):</strong> 상태 변화 기록(필수)</li><li><strong>이벤트 저장소(Event Store):</strong> 이벤트 저장(필수)</li><li><strong>애그리게이트(Aggregate):</strong> 이벤트를 처리해 상태 관리(필수)</li><li><strong>이벤트 핸들러(Event Handler):</strong> 이벤트 처리(필수)</li><li><strong>스냅샷(Snapshot):</strong> 주기적으로 상태 저장(선택)</li><li><strong>프로젝션(Projection):</strong> 이벤트를 기반으로 뷰 생성(선택, CQRS와 연계)</li></ul><p><strong>각 구성요소의 기능과 역할</strong></p><ul><li><strong>이벤트:</strong> 상태 변화 기록, 불변, 순차적 저장</li><li><strong>이벤트 저장소:</strong> 이벤트 저장, 재생 가능</li><li><strong>애그리게이트:</strong> 이벤트를 처리해 상태 관리</li><li><strong>이벤트 핸들러:</strong> 이벤트 처리(예: 이벤트 발행, 구독)</li><li><strong>스냅샷:</strong> 상태 저장, 재생 시간 단축</li><li><strong>프로젝션:</strong> 이벤트를 기반으로 뷰 생성</li></ul><h3 id=구현-기법>구현 기법<a hidden class=anchor aria-hidden=true href=#구현-기법>#</a></h3><ul><li><strong>이벤트 저장소:</strong> 이벤트를 순차적으로 저장(필수)</li><li><strong>애그리게이트:</strong> 이벤트를 처리해 상태 관리(필수)</li><li><strong>이벤트 핸들러:</strong> 이벤트 처리(필수)</li><li><strong>스냅샷:</strong> 주기적으로 상태 저장(선택)</li><li><strong>프로젝션:</strong> 이벤트를 기반으로 뷰 생성(선택, CQRS와 연계)</li><li><strong>이벤트 버스:</strong> 이벤트 발행/구독(선택, 분산 환경)</li></ul><p><strong>실제 예시(시나리오):</strong></p><ul><li><strong>은행 계좌 시스템:</strong> 계좌 개설, 입금, 출금 이벤트를 저장하고, 이벤트를 재생해 현재 잔액 계산<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">4</a><a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">7</a>.</li><li><strong>쇼핑몰 카트:</strong> 상품 추가, 제거 이벤트를 저장하고, 이벤트를 재생해 현재 카트 상태 계산<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">9</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul><h3 id=장점>장점<a hidden class=anchor aria-hidden=true href=#장점>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>특성 원인</th></tr></thead><tbody><tr><td>장점</td><td>감사 및 이력 추적</td><td>모든 상태 변화 이력 보관</td><td>이벤트 불변성, 순차적 기록</td></tr><tr><td>장점</td><td>장애 복구</td><td>특정 시점으로 상태 복구</td><td>이벤트 재생 가능성</td></tr><tr><td>장점</td><td>분석 및 디버깅</td><td>이벤트 로그로 동작 분석</td><td>이벤트 로그 보관</td></tr><tr><td>장점</td><td>확장성</td><td>이벤트 기반 아키텍처와 결합</td><td>이벤트 발행/구독 구조</td></tr></tbody></table><h3 id=단점과-문제점-그리고-해결방안>단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#단점과-문제점-그리고-해결방안>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>단점</td><td>복잡성</td><td>기존 CRUD 방식보다 복잡</td><td>도메인 모델링 강화, 문서화</td></tr><tr><td>단점</td><td>성능 저하</td><td>이벤트가 많아질수록 재생 시간 증가</td><td>스냅샷, 프로젝션 활용</td></tr></tbody></table><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>문제점</td><td>이벤트 스키마 변경</td><td>비즈니스 요구사항 변화</td><td>기존 이벤트와 호환성 문제</td><td>코드 리뷰, 테스트</td><td>버전 관리, 이벤트 업캐스팅</td><td>이벤트 업캐스팅, 마이그레이션</td></tr><tr><td>문제점</td><td>데이터 불일치</td><td>프로젝션 지연, 이벤트 처리 실패</td><td>최신 상태 조회 지연</td><td>모니터링, 로그 분석</td><td>이벤트 처리 신뢰성 강화</td><td>이벤트 재처리, 프로젝션 최적화</td></tr></tbody></table><h3 id=도전-과제>도전 과제<a hidden class=anchor aria-hidden=true href=#도전-과제>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>도전 과제</td><td>대규모 시스템 적용</td><td>이벤트 수 증가, 프로젝션 복잡성</td><td>성능 저하, 유지보수 어려움</td><td>모니터링, 프로파일링</td><td>스냅샷, 프로젝션 분리</td><td>스냅샷, 프로젝션 최적화, 분산 처리</td></tr><tr><td>도전 과제</td><td>이벤트 순서 보장</td><td>분산 환경, 네트워크 지연</td><td>데이터 불일치</td><td>분산 추적, 로그 분석</td><td>이벤트 순서 보장 메커니즘</td><td>이벤트 버스, 분산 트랜잭션 관리</td></tr><tr><td>도전 과제</td><td>팀 온보딩 및 코드 관리</td><td>아키텍처 복잡성, 팀원 이해 부족</td><td>개발 비용 증가, 일관성 저하</td><td>코드 리뷰, 문서화</td><td>교육, 예시 코드 제공</td><td>문서화, 코드 리뷰, 멘토링</td></tr></tbody></table><h3 id=분류-기준에-따른-종류-및-유형>분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-종류-및-유형>#</a></h3><table><thead><tr><th>분류 기준</th><th>종류/유형</th><th>설명</th></tr></thead><tbody><tr><td>적용 범위</td><td>전체 시스템</td><td>시스템 전체에 이벤트 소싱 적용</td></tr><tr><td>적용 범위</td><td>도메인 단위</td><td>특정 도메인에만 이벤트 소싱 적용</td></tr><tr><td>저장 방식</td><td>이벤트 저장소</td><td>이벤트를 저장하는 전용 저장소 사용</td></tr><tr><td>저장 방식</td><td>일반 DB</td><td>일반 데이터베이스를 이벤트 저장소로 사용</td></tr><tr><td>연계 패턴</td><td>CQRS</td><td>이벤트 소싱과 CQRS 연계</td></tr></tbody></table><h3 id=실무-사용-예시>실무 사용 예시<a hidden class=anchor aria-hidden=true href=#실무-사용-예시>#</a></h3><table><thead><tr><th>사용 목적</th><th>함께 사용하는 기술</th><th>효과</th></tr></thead><tbody><tr><td>감사 및 이력 추적</td><td>EventStore, MongoDB, Kafka</td><td>모든 상태 변화 이력 보관</td></tr><tr><td>장애 복구</td><td>Spring Boot, PostgreSQL</td><td>특정 시점으로 상태 복구</td></tr><tr><td>분석 및 디버깅</td><td>Elasticsearch, Kibana</td><td>이벤트 로그 분석</td></tr><tr><td>확장성</td><td>RabbitMQ, Kafka</td><td>이벤트 기반 아키텍처와 결합</td></tr></tbody></table><h3 id=활용-사례>활용 사례<a hidden class=anchor aria-hidden=true href=#활용-사례>#</a></h3><p><strong>은행 계좌 시스템:</strong><br>이벤트 소싱을 적용해 계좌 개설, 입금, 출금 이벤트를 저장하고, 이벤트를 재생해 현재 잔액 계산.</p><ul><li><strong>시스템 구성:</strong><ul><li>Command: 계좌 개설, 입금, 출금 요청</li><li>Aggregate: 계좌 상태 관리</li><li>Event: 계좌 개설됨, 입금 완료됨, 출금 처리됨</li><li>Event Store: 이벤트 저장소</li><li>Projection: 현재 잔액 뷰(Read Model)</li></ul></li><li><strong>Workflow:</strong><ul><li>사용자 → Command → Aggregate → Event → Event Store</li><li>Query → Projection(Read Model)</li></ul></li><li><strong>역할:</strong><ul><li>Command: 상태 변경 요청</li><li>Aggregate: 이벤트 생성 및 상태 관리</li><li>Event Store: 이벤트 저장</li><li>Projection: 뷰 생성</li></ul></li><li><strong>차이점:</strong><ul><li>기존 CRUD 방식은 최종 상태만 저장해 과거 이력 추적이 어렵고, 장애 복구, 감사, 분석이 제한적임.</li><li>이벤트 소싱은 모든 상태 변화를 이벤트로 저장해 과거 이력 추적, 장애 복구, 감사, 분석이 용이함.</li></ul></li></ul><h3 id=구현-예시-javascript>구현 예시 (JavaScript)<a hidden class=anchor aria-hidden=true href=#구현-예시-javascript>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-58-1><a class=lnlinks href=#hl-58-1> 1</a>
</span><span class=lnt id=hl-58-2><a class=lnlinks href=#hl-58-2> 2</a>
</span><span class=lnt id=hl-58-3><a class=lnlinks href=#hl-58-3> 3</a>
</span><span class=lnt id=hl-58-4><a class=lnlinks href=#hl-58-4> 4</a>
</span><span class=lnt id=hl-58-5><a class=lnlinks href=#hl-58-5> 5</a>
</span><span class=lnt id=hl-58-6><a class=lnlinks href=#hl-58-6> 6</a>
</span><span class=lnt id=hl-58-7><a class=lnlinks href=#hl-58-7> 7</a>
</span><span class=lnt id=hl-58-8><a class=lnlinks href=#hl-58-8> 8</a>
</span><span class=lnt id=hl-58-9><a class=lnlinks href=#hl-58-9> 9</a>
</span><span class=lnt id=hl-58-10><a class=lnlinks href=#hl-58-10>10</a>
</span><span class=lnt id=hl-58-11><a class=lnlinks href=#hl-58-11>11</a>
</span><span class=lnt id=hl-58-12><a class=lnlinks href=#hl-58-12>12</a>
</span><span class=lnt id=hl-58-13><a class=lnlinks href=#hl-58-13>13</a>
</span><span class=lnt id=hl-58-14><a class=lnlinks href=#hl-58-14>14</a>
</span><span class=lnt id=hl-58-15><a class=lnlinks href=#hl-58-15>15</a>
</span><span class=lnt id=hl-58-16><a class=lnlinks href=#hl-58-16>16</a>
</span><span class=lnt id=hl-58-17><a class=lnlinks href=#hl-58-17>17</a>
</span><span class=lnt id=hl-58-18><a class=lnlinks href=#hl-58-18>18</a>
</span><span class=lnt id=hl-58-19><a class=lnlinks href=#hl-58-19>19</a>
</span><span class=lnt id=hl-58-20><a class=lnlinks href=#hl-58-20>20</a>
</span><span class=lnt id=hl-58-21><a class=lnlinks href=#hl-58-21>21</a>
</span><span class=lnt id=hl-58-22><a class=lnlinks href=#hl-58-22>22</a>
</span><span class=lnt id=hl-58-23><a class=lnlinks href=#hl-58-23>23</a>
</span><span class=lnt id=hl-58-24><a class=lnlinks href=#hl-58-24>24</a>
</span><span class=lnt id=hl-58-25><a class=lnlinks href=#hl-58-25>25</a>
</span><span class=lnt id=hl-58-26><a class=lnlinks href=#hl-58-26>26</a>
</span><span class=lnt id=hl-58-27><a class=lnlinks href=#hl-58-27>27</a>
</span><span class=lnt id=hl-58-28><a class=lnlinks href=#hl-58-28>28</a>
</span><span class=lnt id=hl-58-29><a class=lnlinks href=#hl-58-29>29</a>
</span><span class=lnt id=hl-58-30><a class=lnlinks href=#hl-58-30>30</a>
</span><span class=lnt id=hl-58-31><a class=lnlinks href=#hl-58-31>31</a>
</span><span class=lnt id=hl-58-32><a class=lnlinks href=#hl-58-32>32</a>
</span><span class=lnt id=hl-58-33><a class=lnlinks href=#hl-58-33>33</a>
</span><span class=lnt id=hl-58-34><a class=lnlinks href=#hl-58-34>34</a>
</span><span class=lnt id=hl-58-35><a class=lnlinks href=#hl-58-35>35</a>
</span><span class=lnt id=hl-58-36><a class=lnlinks href=#hl-58-36>36</a>
</span><span class=lnt id=hl-58-37><a class=lnlinks href=#hl-58-37>37</a>
</span><span class=lnt id=hl-58-38><a class=lnlinks href=#hl-58-38>38</a>
</span><span class=lnt id=hl-58-39><a class=lnlinks href=#hl-58-39>39</a>
</span><span class=lnt id=hl-58-40><a class=lnlinks href=#hl-58-40>40</a>
</span><span class=lnt id=hl-58-41><a class=lnlinks href=#hl-58-41>41</a>
</span><span class=lnt id=hl-58-42><a class=lnlinks href=#hl-58-42>42</a>
</span><span class=lnt id=hl-58-43><a class=lnlinks href=#hl-58-43>43</a>
</span><span class=lnt id=hl-58-44><a class=lnlinks href=#hl-58-44>44</a>
</span><span class=lnt id=hl-58-45><a class=lnlinks href=#hl-58-45>45</a>
</span><span class=lnt id=hl-58-46><a class=lnlinks href=#hl-58-46>46</a>
</span><span class=lnt id=hl-58-47><a class=lnlinks href=#hl-58-47>47</a>
</span><span class=lnt id=hl-58-48><a class=lnlinks href=#hl-58-48>48</a>
</span><span class=lnt id=hl-58-49><a class=lnlinks href=#hl-58-49>49</a>
</span><span class=lnt id=hl-58-50><a class=lnlinks href=#hl-58-50>50</a>
</span><span class=lnt id=hl-58-51><a class=lnlinks href=#hl-58-51>51</a>
</span><span class=lnt id=hl-58-52><a class=lnlinks href=#hl-58-52>52</a>
</span><span class=lnt id=hl-58-53><a class=lnlinks href=#hl-58-53>53</a>
</span><span class=lnt id=hl-58-54><a class=lnlinks href=#hl-58-54>54</a>
</span><span class=lnt id=hl-58-55><a class=lnlinks href=#hl-58-55>55</a>
</span><span class=lnt id=hl-58-56><a class=lnlinks href=#hl-58-56>56</a>
</span><span class=lnt id=hl-58-57><a class=lnlinks href=#hl-58-57>57</a>
</span><span class=lnt id=hl-58-58><a class=lnlinks href=#hl-58-58>58</a>
</span><span class=lnt id=hl-58-59><a class=lnlinks href=#hl-58-59>59</a>
</span><span class=lnt id=hl-58-60><a class=lnlinks href=#hl-58-60>60</a>
</span><span class=lnt id=hl-58-61><a class=lnlinks href=#hl-58-61>61</a>
</span><span class=lnt id=hl-58-62><a class=lnlinks href=#hl-58-62>62</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 이벤트 정의
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>AccountCreatedEvent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>owner</span><span class=p>,</span> <span class=nx>initialBalance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>owner</span> <span class=o>=</span> <span class=nx>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>initialBalance</span> <span class=o>=</span> <span class=nx>initialBalance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;AccountCreated&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>DepositMadeEvent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>amount</span> <span class=o>=</span> <span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;DepositMade&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>WithdrawalProcessedEvent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>amount</span> <span class=o>=</span> <span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;WithdrawalProcessed&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 애그리게이트
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>AccountAggregate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>events</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>events</span> <span class=o>=</span> <span class=nx>events</span> <span class=o>||</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>applyEvents</span><span class=p>(</span><span class=nx>events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>applyEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;AccountCreated&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>initialBalance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;DepositMade&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>+=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;WithdrawalProcessed&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>-=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>applyEvents</span><span class=p>(</span><span class=nx>events</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>events</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>e</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>applyEvent</span><span class=p>(</span><span class=nx>e</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>deposit</span><span class=p>(</span><span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>event</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DepositMadeEvent</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>applyEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>withdraw</span><span class=p>(</span><span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>event</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WithdrawalProcessedEvent</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>applyEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 사용 예시
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>account</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AccountAggregate</span><span class=p>([</span><span class=k>new</span> <span class=nx>AccountCreatedEvent</span><span class=p>(</span><span class=s1>&#39;acc1&#39;</span><span class=p>,</span> <span class=s1>&#39;Alice&#39;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)]);</span>
</span></span><span class=line><span class=cl><span class=nx>account</span><span class=p>.</span><span class=nx>deposit</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>account</span><span class=p>.</span><span class=nx>withdraw</span><span class=p>(</span><span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>account</span><span class=p>.</span><span class=nx>balance</span><span class=p>);</span> <span class=c1>// 1300
</span></span></span></code></pre></td></tr></table></div></div><h3 id=실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>도메인 모델링</td><td>명확한 도메인 모델 설계</td><td>도메인 중심 설계 강화</td></tr><tr><td>이벤트 스키마</td><td>이벤트 스키마 변경 계획</td><td>버전 관리, 이벤트 업캐스팅</td></tr><tr><td>테스트</td><td>충분한 테스트</td><td>단위, 통합 테스트 강화</td></tr><tr><td>문서화</td><td>아키텍처 및 코드 문서화</td><td>문서화, 예시 코드 제공</td></tr></tbody></table><h3 id=최적화하기-위한-고려사항-및-주의할-점>최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#최적화하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>스냅샷</td><td>이벤트가 많아질수록 재생 시간 증가</td><td>스냅샷 주기적 저장</td></tr><tr><td>프로젝션</td><td>뷰(Read Model) 생성 지연</td><td>프로젝션 최적화, 분산 처리</td></tr><tr><td>모니터링</td><td>분산 환경, 이벤트 처리 지연</td><td>모니터링, 로그 분석</td></tr></tbody></table><h3 id=기타-사항>기타 사항<a hidden class=anchor aria-hidden=true href=#기타-사항>#</a></h3><ul><li><strong>CQRS와의 연계:</strong> 이벤트 소싱은 CQRS와 함께 사용 시 큰 시너지 효과(읽기/쓰기 분리, 뷰 최적화)<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">15</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li><li><strong>마이크로서비스와의 연계:</strong> 이벤트 기반 아키텍처와 결합해 분산 시스템, 마이크로서비스에 적합<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">5</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li><li><strong>적용 범위:</strong> 모든 도메인에 적용할 필요 없음, 복잡한 도메인, 감사, 분석, 장애 복구가 필요한 곳에 적합<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">17</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul><hr><h2 id=7-추가-조사-내용-1>7. 추가 조사 내용<a hidden class=anchor aria-hidden=true href=#7-추가-조사-내용-1>#</a></h2><ul><li><strong>이벤트 소싱과 CRUD 비교:</strong><ul><li><strong>CRUD:</strong> 최종 상태만 저장, 과거 이력 추적 어려움, 동시성 문제 발생 가능<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">4</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li><li><strong>이벤트 소싱:</strong> 모든 상태 변화를 이벤트로 저장, 과거 이력 추적, 장애 복구, 감사, 분석 용이<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">1</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul></li><li><strong>이벤트 소싱과 CQRS:</strong><ul><li>이벤트 소싱은 CQRS와 함께 사용 시 읽기/쓰기 분리, 뷰 최적화, 성능 향상<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">15</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul></li><li><strong>적용 범위:</strong><ul><li>모든 도메인에 적용할 필요 없음, 복잡한 도메인, 감사, 분석, 장애 복구가 필요한 곳에 적합<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">17</a><a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">13</a>.</li></ul></li></ul><hr><h2 id=8-주목할-내용>8. 주목할 내용<a hidden class=anchor aria-hidden=true href=#8-주목할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>설계 패턴</td><td>Event Sourcing</td><td>불변성</td><td>이벤트는 한 번 기록되면 변경 불가</td></tr><tr><td>설계 패턴</td><td>Event Sourcing</td><td>순차성</td><td>이벤트는 시간 순서대로 저장</td></tr><tr><td>실무 적용</td><td>Event Sourcing</td><td>감사 및 이력 추적</td><td>모든 상태 변화 이력 보관</td></tr><tr><td>실무 적용</td><td>Event Sourcing</td><td>장애 복구</td><td>이벤트 재생으로 특정 시점 복구</td></tr><tr><td>실무 적용</td><td>Event Sourcing</td><td>분석 및 디버깅</td><td>이벤트 로그로 동작 분석</td></tr></tbody></table><hr><h2 id=9-반드시-학습해야-할-내용>9. 반드시 학습해야 할 내용<a hidden class=anchor aria-hidden=true href=#9-반드시-학습해야-할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>설계 원칙</td><td>Event Sourcing</td><td>불변성</td><td>이벤트는 한 번 기록되면 변경 불가</td></tr><tr><td>설계 원칙</td><td>Event Sourcing</td><td>순차성</td><td>이벤트는 시간 순서대로 저장</td></tr><tr><td>실무 적용</td><td>Event Sourcing</td><td>감사 및 이력 추적</td><td>모든 상태 변화 이력 보관</td></tr><tr><td>실무 적용</td><td>Event Sourcing</td><td>장애 복구</td><td>이벤트 재생으로 특정 시점 복구</td></tr><tr><td>실무 적용</td><td>Event Sourcing</td><td>분석 및 디버깅</td><td>이벤트 로그로 동작 분석</td></tr></tbody></table><hr><h2 id=10-용어-정리>10. 용어 정리<a hidden class=anchor aria-hidden=true href=#10-용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>설계 패턴</td><td>Event Sourcing</td><td>시스템의 모든 상태 변화를 불변의 이벤트로 저장하고, 이를 재생하여 상태를 재구성하는 패턴</td></tr><tr><td>설계 원칙</td><td>불변성</td><td>이벤트는 한 번 기록되면 변경 또는 삭제되지 않음</td></tr><tr><td>설계 원칙</td><td>순차성</td><td>이벤트는 시간 순서대로 저장됨</td></tr><tr><td>실무 적용</td><td>이벤트 저장소</td><td>이벤트를 저장하는 저장소</td></tr><tr><td>실무 적용</td><td>애그리게이트</td><td>여러 이벤트를 묶어 하나의 도메인 객체로 관리하는 단위</td></tr><tr><td>실무 적용</td><td>프로젝션</td><td>이벤트를 기반으로 뷰(Read Model) 생성</td></tr></tbody></table><hr><h2 id=11-참고-및-출처>11. 참고 및 출처<a hidden class=anchor aria-hidden=true href=#11-참고-및-출처>#</a></h2><ul><li><a href=https://learn.microsoft.com/ko-kr/azure/architecture/patterns/event-sourcing>이벤트 소싱(Event Sourcing) 패턴 - Microsoft Learn</a></li><li><a href=https://docs.aws.amazon.com/ko_kr/prescriptive-guidance/latest/cloud-design-patterns/event-sourcing.html>이벤트 소싱 패턴 - AWS 권장 가이드</a></li><li><a href=https://sddev.tistory.com/111>이벤트 소싱(Event Sourcing) 개념 - devNote</a></li><li><a href=https://monday9pm.com/event-sourcing%EA%B3%BC-cqrs-1f6505035cbe>이벤트 소싱(Event Sourcing)과 CQRS 패턴 - monday9pm</a></li><li><a href=https://edykim.com/ko/post/event-sourcing-implementing-eventsourcing-patterns-with-javascript/>이벤트 소싱(Event Sourcing) JavaScript로 구현하기 - edykim</a></li><li><a href=https://sarc.io/index.php/cloud/2232-event-sourcing-pattern>이벤트 소싱(Event Sourcing) 패턴 - 삵(sarc.io)</a></li><li><a href=https://sabarada.tistory.com/231>이벤트 소싱(Event Sourcing) 맛보기 - 이론편 - saberada</a></li><li><a href=https://quddkflty.tistory.com/102>이벤트 소싱(Event Sourcing) 개념과 git 비교 - 병아리쇼</a></li><li><a href=https://velog.io/@bighaeil/Event-Sourcing-%EA%B5%AC%ED%98%84-with-Spring-Boot-MongoDB-Kafka>이벤트 소싱(Event Sourcing) 구현 with Spring Boot, MongoDB, Kafka - velog</a></li><li><a href=https://notavoid.tistory.com/218>이벤트 소싱(Event Sourcing)과 CQRS 패턴 심화 구현 - Spring Boot로 고급 이벤트 &mldr; - notavoid</a></li></ul><p><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing><figure><img alt="Event Sourcing pattern - Azure Architecture Center | Microsoft Learn" loading=lazy src="https://tse4.mm.bing.net/th/id/OIP.o6ZoY5sk83-tDISF-pVNtwHaEM?pid=Api"></figure></a></p><p>아래는 <strong>Event Sourcing</strong> 아키텍처에 대한 구조화된 분석입니다.</p><hr><h2 id=1-태그-2>1. 태그<a hidden class=anchor aria-hidden=true href=#1-태그-2>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-59-1><a class=lnlinks href=#hl-59-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Event-Sourcing, Immutable-Events, Audit-Log, Replayable-State
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=2-분류-계층-적절성-분석>2. 분류 계층 적절성 분석<a hidden class=anchor aria-hidden=true href=#2-분류-계층-적절성-분석>#</a></h2><ul><li><p><strong>분류에 대한 평가</strong>:</p><blockquote><p>Computer Science and Engineering → Software Engineering → Design and Architecture → Architecture Styles and Patterns → Architecture Patterns → Data Management</p></blockquote></li><li><p><strong>분석 결과</strong>:</p><ul><li>적절한 계층 구조입니다. Event Sourcing은 변경 이벤트의 <strong>프로젝션</strong> 및 <strong>재생 가능 상태</strong>를 중앙에서 관리하는 데이터 중심 패턴으로, <strong>Data Management</strong> 하위 범주에 올바르게 위치합니다. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">docs.aws.amazon.com</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">stackoverflow.com</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">learn.microsoft.com</a>)</li></ul></li></ul><hr><h2 id=3-200자-요약>3. 200자 요약<a hidden class=anchor aria-hidden=true href=#3-200자-요약>#</a></h2><p>Event Sourcing은 애플리케이션의 상태 변화를 <strong>이벤트</strong>로 불변하게 저장하는 패턴입니다. 현재 상태는 이벤트 스트림을 재생하여 구성되며, 모든 변경 기록이 남아 있어 <strong>감사</strong>, <strong>디버깅</strong>, <strong>시간 여행</strong>, <strong>이력 복원</strong> 등이 가능합니다. CQRS와 함께 쓰이면 읽기 모델 최적화와 확장성도 확보됩니다.</p><hr><h2 id=4-250자-개요>4. 250자 개요<a hidden class=anchor aria-hidden=true href=#4-250자-개요>#</a></h2><p>Event Sourcing은 도메인에서 발생하는 모든 상태 변경을 <strong>불변 이벤트</strong>로 저장하는 아키텍처 패턴입니다. 표준 CRUD 방식과 다르게 이벤트 로그가 **단일 출처(source of truth)**로 사용되며, **이벤트 저장소(Event Store)**에 append-only 방식으로 쌓입니다. 현재 상태는 이벤트 재생(replay)을 통해 계산되며, 이를 활용해 <strong>시점 조회</strong>, <strong>감사 로그</strong>, <strong>이력 복원</strong>, <strong>읽기 모델 프로젝션</strong>이 가능합니다. 특히 CQRS와 결합하면 이벤트는 Command Side에서 저장되고, Read Side에서 Projection을 통해 최적화된 조회용 뷰를 생성합니다. (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">docs.aws.amazon.com</a>)</p><hr><h2 id=5-핵심-개념-및-실무-구현-요소>5. 핵심 개념 및 실무 구현 요소<a hidden class=anchor aria-hidden=true href=#5-핵심-개념-및-실무-구현-요소>#</a></h2><h3 id=핵심-개념>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념>#</a></h3><ul><li><strong>Immutable Events</strong>: 모든 상태 변경은 변경 불가능한 이벤트로 기록됨</li><li><strong>Event Store</strong>: 이벤트를 순차적으로 저장하는 append-only 저장소 (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">docs.aws.amazon.com</a>)</li><li><strong>Event Replay</strong>: 저장된 이벤트를 순차 처리해 현재 상태를 재생산 (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">learn.microsoft.com</a>)</li><li><strong>Projections / Read Models</strong>: 이벤트 소비 후 조회에 최적화된 구조로 가공된 뷰 생성 (<a href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-design-patterns-part-6-event-sourcing/?utm_source=chatgpt.com" title="Azure Cosmos DB design patterns - Part 6: Event Sourcing">learn.microsoft.com</a>)</li><li><strong>Snapshot</strong>: 이벤트 재생 비용을 줄이기 위해 중간 상태를 저장하는 기법</li></ul><h3 id=구현-요소>구현 요소<a hidden class=anchor aria-hidden=true href=#구현-요소>#</a></h3><ul><li><code>Event</code> 클래스 정의 및 버전 관리</li><li><code>EventStore</code> 구성 (Kafka, EventStoreDB, RDBMS 로그 등)</li><li><code>Aggregate</code> 내 command 처리 로직과 이벤트 생성 함수</li><li><code>Projector</code> 구성하여 Read DB 업데이트</li><li><code>Snapshot</code> 저장 전략 및 소비자 구현</li><li>테스트 전략: 이벤트 replay 테스트, projection 검증, 동시성 처리</li></ul><hr><h2 id=6-구조-및-아키텍처--구성-요소>6. 구조 및 아키텍처 + 구성 요소<a hidden class=anchor aria-hidden=true href=#6-구조-및-아키텍처--구성-요소>#</a></h2><pre class=mermaid>flowchart LR
  UI/API --&gt; Cmd[Command Handler]
  Cmd --&gt; Agg[Aggregate] --&gt; EvtStore[Event Store (append-only)]
  EvtStore --&gt; EvtBus[Event Bus / Queue]
  EvtBus --&gt; Proj[Projector] --&gt; ReadDB[(Read Model DB)]
  EvtStore ==&gt; Replay[Snapshot mechanism]
</pre><ul><li><strong>Command Handler</strong>: command 입력 → Aggregate 실행 → 이벤트 생성</li><li><strong>Aggregate</strong>: 도메인 로직 수행 후 Event 반환</li><li><strong>Event Store</strong>: 이벤트 append 저장, 불변성 보장</li><li><strong>Event Bus / Queue</strong>: 이벤트를 비동기 배포</li><li><strong>Projector</strong>: 이벤트 소비 → Read DB 프로젝션 생성</li><li><strong>Read Model DB</strong>: 조회에 최적화된 Materialized View 제공</li><li><strong>Snapshot / Replay</strong>: 이벤트 재생 비용 절감을 위한 상태 저장 및 로딩</li></ul><p><strong>필수 구성요소</strong>: Event, Event Store, Aggregate, Projector, Read DB
<strong>선택 구성요소</strong>: Event Bus, Snapshot, Integration 이벤트 핸들러 등</p><hr><h2 id=7-주요-원리--작동-원리>7. 주요 원리 & 작동 원리<a hidden class=anchor aria-hidden=true href=#7-주요-원리--작동-원리>#</a></h2><ul><li><strong>불변성과 추적 가능성</strong>: 모든 변경을 이벤트로 캡처하여 완전한 이력 보장 (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">geeksforgeeks.org</a>, <a href="https://www.infoq.com/news/2014/09/greg-young-event-sourcing/?utm_source=chatgpt.com" title="The Basics of Event Sourcing and Some CQRS">danielwhittaker.me</a>, <a href="https://www.youtube.com/watch?v=8JKjvY4etTY&amp;utm_source=chatgpt.com" title="Event Sourcing • Greg Young • GOTO 2014">en.wikipedia.org</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs?utm_source=chatgpt.com" title="CQRS Pattern - Azure Architecture Center">learn.microsoft.com</a>, <a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>upsolver.com</a>, <a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">docs.aws.amazon.com</a>)</li><li><strong>이벤트 재생을 통한 상태 복원</strong>: 이벤트 순서대로 처리하면 특정 시점 상태가 재현 가능</li><li><strong>CQRS 결합 구조</strong>: Write 모델은 이벤트 저장, Read 모델은 Projection을 통해 최적화 구조 구축 (<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">docs.aws.amazon.com</a>)</li><li><strong>Snapshot 기반 최적화</strong>: 누적 이벤트 재생 비용 최소화 전략</li></ul><hr><h2 id=8-구현-기법-1>8. 구현 기법<a hidden class=anchor aria-hidden=true href=#8-구현-기법-1>#</a></h2><ul><li><strong>Event 정의 & 버전 관리</strong>: Event 타입과 Payload 정의 후 스키마 변경 대응(version field or upcasting) (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">en.wikipedia.org</a>)</li><li><strong>Event Store 구성</strong>: EventStoreDB, Kafka, RDBMS 이벤트 로그 활용</li><li><strong>Aggregate 클래스</strong>: <code>apply(event)</code> 방식으로 도메인 상태 변경, command 처리</li><li><strong>Projector</strong>: 이벤트 타입별 Subscription 설정 → Read DB 업데이트</li><li><strong>Snapshot 주기화</strong>: N번째 이벤트마다 Snapshot 생성 후 재생 시 Snapshot부터 시작</li><li><strong>백업/아카이빙</strong>: 장기 보존 이벤트 압축 또는 외부 저장소 전환</li></ul><hr><h2 id=9-장점-1>9. 장점<a hidden class=anchor aria-hidden=true href=#9-장점-1>#</a></h2><table><thead><tr><th>구분</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>장점</td><td><strong>감사 및 추적성</strong></td><td>이벤트 불변 저장으로 변경 내역 완전 기록</td></tr><tr><td></td><td><strong>이력 관리</strong></td><td>특정 시점 상태 재현 가능 (time travel)</td></tr><tr><td></td><td><strong>복원력</strong></td><td>롤백 없이 상태 재구성이 가능</td></tr><tr><td></td><td><strong>확장성</strong></td><td>다양한 프로젝션 생성, polyglot persistence 지원</td></tr><tr><td></td><td><strong>도메인 표현 적합성</strong></td><td>이벤트가 도메인 관점의 언어로 표현됨</td></tr></tbody></table><hr><h2 id=10-단점과-문제점--해결방안>10. 단점과 문제점 + 해결방안<a hidden class=anchor aria-hidden=true href=#10-단점과-문제점--해결방안>#</a></h2><h3 id=단점-2>단점<a hidden class=anchor aria-hidden=true href=#단점-2>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>단점</td><td><strong>복잡도 증가</strong></td><td>프로젝트 구조가 일반 CRUD보다 복잡 (<a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">stackoverflow.com</a>)</td><td>단위 모듈 적용, 프레임워크 도입, 단계적 확장</td></tr><tr><td></td><td><strong>쿼리 어려움</strong></td><td>이벤트 로그 직접 쿼리 비효율</td><td>Read Model 구축 및 Projection 활용</td></tr><tr><td></td><td><strong>이벤트 버전 관리 부하</strong></td><td>이벤트 스키마 변경 시 어려움</td><td>upcasting, 버전 필드, backward-compatible 이벤트 설계</td></tr><tr><td></td><td><strong>스토리지 증가</strong></td><td>이벤트 저장 용량이 크게 증가</td><td>아카이빙, TTL, Snapshot 전략 사용</td></tr></tbody></table><h3 id=문제점-상세-분석>문제점 상세 분석<a hidden class=anchor aria-hidden=true href=#문제점-상세-분석>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지</th><th>예방</th><th>해결</th></tr></thead><tbody><tr><td>문제</td><td>Event replay 지연</td><td>누적 이벤트 재생 필요</td><td>시스템 부팅 느려짐, 상태 불확실</td><td>라그 시간 모니터링</td><td>Snapshot 전략, 주기적 미리 계산</td><td>자동 Snapshot, 이벤트 압축</td></tr><tr><td>문제</td><td>동시성 충돌</td><td>동일 도메인 동시 변경</td><td>상태 불일치 및 예외 발생</td><td>충돌 로그, 예외 모니터</td><td>optimistic concurrency, 버전 필드 사용</td><td>롤백/재시도 로직, 충돌 해결 UI</td></tr><tr><td>문제</td><td>과도한 이벤트</td><td>단순 상태 변경도 이벤트화</td><td>소비자 부담 증가, 이벤트 폭증</td><td>이벤트 수 증가 모니터링</td><td>비즈니스 이벤트만, 중요도 기반 선택</td><td>필터링, 청소, 미러링 전략</td></tr></tbody></table><hr><h2 id=11-도전-과제-1>11. 도전 과제<a hidden class=anchor aria-hidden=true href=#11-도전-과제-1>#</a></h2><ul><li><strong>이벤트 스키마 진화</strong>: 스키마 호환성·리팩토링 전략 필요</li><li><strong>모니터링 체계 구축</strong>: 이벤트 처리 지연 및 재시도 자동화</li><li><strong>관리 패턴 표준화</strong>: Event naming, 버전 관리, 필터 정책 가이드라인</li><li><strong>복잡한 도메인 적용</strong>: 미세 이벤트 vs. 복합 이벤트 수준 균형 잡기</li></ul><hr><h2 id=12-실무-사용-예시>12. 실무 사용 예시<a hidden class=anchor aria-hidden=true href=#12-실무-사용-예시>#</a></h2><table><thead><tr><th>스택</th><th>목적</th><th>효과</th></tr></thead><tbody><tr><td>Kafka + EventStoreDB + Spring Boot</td><td>금융 거래 이력 기록 및 감사</td><td>완전한 트랜잭션 추적, 재생 가능 상태 생성</td></tr><tr><td>.NET + Marten</td><td>주문시스템 상태 이력 관리</td><td>DB 롤백 없이 이력 복원, 이벤트 재가공</td></tr><tr><td>Node.js + AWS EventBridge</td><td>IoT 센서 데이터 수집</td><td>시간 기반 분석, 실패 메시지 재처리 지원</td></tr><tr><td>Laravel + spatie/laravel-event-sourcing</td><td>PHP 영역에서 PoC 구현</td><td>이벤트 구조 이해 및 조회 모델 분리</td></tr></tbody></table><hr><h2 id=13-활용-사례-금융-거래-시스템>13. 활용 사례: 금융 거래 시스템<a hidden class=anchor aria-hidden=true href=#13-활용-사례-금융-거래-시스템>#</a></h2><pre class=mermaid>flowchart LR
  subgraph Write
    API --&gt; Cmd
    Cmd --&gt; Agg[Account Aggregate]
    Agg --&gt; ES[Event Store]
    ES --&gt; Bus[Event Bus]
  end
  subgraph Read
    Bus --&gt; Proj[Transaction Projector]
    Proj --&gt; Read[(Read DB)]
      Read --&gt; UI
  end
</pre><ul><li><strong>Account Aggregate</strong>: 입출금 command 처리 후 <code>MoneyDeposited</code> 등 이벤트 생성</li><li><strong>Event Store</strong>: 거래 내역 이벤트만 기록</li><li><strong>Transaction Projector</strong>: 이벤트 소비 후 잔액, 거래 목록 프리젠테이션 뷰 생성</li><li><strong>장점 비교</strong>: CRUD 방식보다 정확한 이력 관리와 분리된 조회 모델로 성능 확보</li></ul><hr><h2 id=14-구현-예시-python--pseudocode>14. 구현 예시 (Python + Pseudocode)<a hidden class=anchor aria-hidden=true href=#14-구현-예시-python--pseudocode>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-62-1><a class=lnlinks href=#hl-62-1> 1</a>
</span><span class=lnt id=hl-62-2><a class=lnlinks href=#hl-62-2> 2</a>
</span><span class=lnt id=hl-62-3><a class=lnlinks href=#hl-62-3> 3</a>
</span><span class=lnt id=hl-62-4><a class=lnlinks href=#hl-62-4> 4</a>
</span><span class=lnt id=hl-62-5><a class=lnlinks href=#hl-62-5> 5</a>
</span><span class=lnt id=hl-62-6><a class=lnlinks href=#hl-62-6> 6</a>
</span><span class=lnt id=hl-62-7><a class=lnlinks href=#hl-62-7> 7</a>
</span><span class=lnt id=hl-62-8><a class=lnlinks href=#hl-62-8> 8</a>
</span><span class=lnt id=hl-62-9><a class=lnlinks href=#hl-62-9> 9</a>
</span><span class=lnt id=hl-62-10><a class=lnlinks href=#hl-62-10>10</a>
</span><span class=lnt id=hl-62-11><a class=lnlinks href=#hl-62-11>11</a>
</span><span class=lnt id=hl-62-12><a class=lnlinks href=#hl-62-12>12</a>
</span><span class=lnt id=hl-62-13><a class=lnlinks href=#hl-62-13>13</a>
</span><span class=lnt id=hl-62-14><a class=lnlinks href=#hl-62-14>14</a>
</span><span class=lnt id=hl-62-15><a class=lnlinks href=#hl-62-15>15</a>
</span><span class=lnt id=hl-62-16><a class=lnlinks href=#hl-62-16>16</a>
</span><span class=lnt id=hl-62-17><a class=lnlinks href=#hl-62-17>17</a>
</span><span class=lnt id=hl-62-18><a class=lnlinks href=#hl-62-18>18</a>
</span><span class=lnt id=hl-62-19><a class=lnlinks href=#hl-62-19>19</a>
</span><span class=lnt id=hl-62-20><a class=lnlinks href=#hl-62-20>20</a>
</span><span class=lnt id=hl-62-21><a class=lnlinks href=#hl-62-21>21</a>
</span><span class=lnt id=hl-62-22><a class=lnlinks href=#hl-62-22>22</a>
</span><span class=lnt id=hl-62-23><a class=lnlinks href=#hl-62-23>23</a>
</span><span class=lnt id=hl-62-24><a class=lnlinks href=#hl-62-24>24</a>
</span><span class=lnt id=hl-62-25><a class=lnlinks href=#hl-62-25>25</a>
</span><span class=lnt id=hl-62-26><a class=lnlinks href=#hl-62-26>26</a>
</span><span class=lnt id=hl-62-27><a class=lnlinks href=#hl-62-27>27</a>
</span><span class=lnt id=hl-62-28><a class=lnlinks href=#hl-62-28>28</a>
</span><span class=lnt id=hl-62-29><a class=lnlinks href=#hl-62-29>29</a>
</span><span class=lnt id=hl-62-30><a class=lnlinks href=#hl-62-30>30</a>
</span><span class=lnt id=hl-62-31><a class=lnlinks href=#hl-62-31>31</a>
</span><span class=lnt id=hl-62-32><a class=lnlinks href=#hl-62-32>32</a>
</span><span class=lnt id=hl-62-33><a class=lnlinks href=#hl-62-33>33</a>
</span><span class=lnt id=hl-62-34><a class=lnlinks href=#hl-62-34>34</a>
</span><span class=lnt id=hl-62-35><a class=lnlinks href=#hl-62-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># events.py</span>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MoneyDeposited</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>account_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># aggregate.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AccountAggregate</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deposit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>evt</span> <span class=o>=</span> <span class=n>MoneyDeposited</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>amount</span><span class=p>,</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>evt</span><span class=p>);</span> <span class=k>return</span> <span class=n>evt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># repository.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>append</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stream</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stream</span><span class=p>):</span> <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># projector.py</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>project_transactions</span><span class=p>(</span><span class=n>events</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>balance</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>MoneyDeposited</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>balance</span> <span class=o>+=</span> <span class=n>e</span><span class=o>.</span><span class=n>amount</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>balance</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># usage</span>
</span></span><span class=line><span class=cl><span class=n>agg</span> <span class=o>=</span> <span class=n>AccountAggregate</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>evt</span> <span class=o>=</span> <span class=n>agg</span><span class=o>.</span><span class=n>deposit</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>store</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>();</span> <span class=n>store</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;acct1&#34;</span><span class=p>,</span> <span class=n>evt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>events</span> <span class=o>=</span> <span class=n>store</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s2>&#34;acct1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>balance</span> <span class=o>=</span> <span class=n>project_transactions</span><span class=p>(</span><span class=n>events</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>balance</span><span class=p>)</span>  <span class=c1># 100</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=15-실무-적용-고려사항-및-최적화-권장-요약>15. 실무 적용 고려사항 및 최적화 권장 요약<a hidden class=anchor aria-hidden=true href=#15-실무-적용-고려사항-및-최적화-권장-요약>#</a></h2><ul><li><strong>적용 고려</strong>: 도메인 복잡도, 팀 역량, 감사지원 요구도 기반 적용 권장</li><li><strong>최적화 전략</strong>: Snapshot 도입, 이벤트(version) 전략, 도메인 이벤트 필터링</li><li><strong>운영 주의</strong>: 이벤트 모니터링, 재처리 환경, 이벤트 청소 정책 필수</li></ul><hr><h2 id=16-용어-정리>16. 용어 정리<a hidden class=anchor aria-hidden=true href=#16-용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>개념</td><td>Event Store</td><td>불변한 이벤트 스트림을 순서대로 저장하는 저장소</td></tr><tr><td></td><td>Snapshot</td><td>이벤트 기반 상태 계산을 최적화하기 위한 중간 상태</td></tr><tr><td></td><td>Replay</td><td>저장된 이벤트들을 다시 실행하여 상태 재구성</td></tr><tr><td></td><td>Projection</td><td>이벤트 소비 후 읽기 모델로 변환하는 동작</td></tr><tr><td></td><td>Immutable Event</td><td>생성 후 변경되지 않는 상태 변경 이벤트</td></tr></tbody></table><hr><h2 id=17-참고-및-출처>17. 참고 및 출처<a hidden class=anchor aria-hidden=true href=#17-참고-및-출처>#</a></h2><ul><li>Microservices.io, <em>Event Sourcing Pattern</em> (<a href="https://dev.to/alex_aslam/event-sourcing-for-gdpr-how-to-forget-data-without-breaking-history-4013?utm_source=chatgpt.com" title="Event Sourcing for GDPR: How to Forget Data Without ...">docs.aws.amazon.com</a>, <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing?utm_source=chatgpt.com" title="Event Sourcing pattern - Azure Architecture Center">theserverside.com</a>, <a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf?utm_source=chatgpt.com" title="[PDF] CQRS Documents by Greg Young">event-driven.io</a>, <a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">microservices.io</a>, <a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">geeksforgeeks.org</a>, <a href="https://github.com/eugene-khyst/eventstoredb-event-sourcing?utm_source=chatgpt.com" title=eugene-khyst/eventstoredb-event-sourcing>upsolver.com</a>)</li><li>AWS Prescriptive Guidance, <em>Event Sourcing pattern</em> (<a href="https://martinfowler.com/eaaDev/EventSourcing.html?utm_source=chatgpt.com" title="Event Sourcing">docs.aws.amazon.com</a>)</li><li>Red Hat, <em>Pros and Cons of Event Sourcing</em> (<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">linkedin.com</a>)</li><li>StackOverflow, <em>Disadvantages of Event Sourcing</em></li><li>GeeksforGeeks, <em>Event Sourcing Pattern</em> (<a href="https://martinfowler.com/tags/event%20architectures.html?utm_source=chatgpt.com" title="tagged by: event architectures">geeksforgeeks.org</a>)</li><li>Martin Fowler, <em>Event Sourcing</em> (<a href="https://www.kurrent.io/blog/10-problems-that-event-sourcing-can-help-solve-for-you?utm_source=chatgpt.com" title="10 problems that Event Sourcing can help solve for you - Kurrent">microservices.io</a>)</li><li>Bemi Blog, <em>Event Sourcing is Hard</em> (<a href="https://en.wikipedia.org/wiki/Event-driven_architecture?utm_source=chatgpt.com" title="Event-driven architecture">chriskiehl.com</a>)</li><li>Innovecs Blog, <em>Event Sourcing 101</em> (<a href="https://innovecs.com/blog/event-sourcing-101-when-to-use-and-how-to-avoid-pitfalls/?utm_source=chatgpt.com" title="Event Sourcing 101: When to Use and How to Avoid Pitfalls - Innovecs">innovecs.com</a>)</li></ul><hr><p>🎯 <strong>정리 완료:</strong> Event Sourcing에 대한 핵심 개념부터 구조, 구현, 장단점, 실무 예시까지 포괄적으로 정리했습니다. 추가 프레임워크별 적용 가이드나 고급 최적화가 필요하면 언제든지 요청 주세요!</p><p>모든 주요 항목을 정리하셨습니다! 🎯
필요하시면 아래의 추가 지원도 제공 가능합니다:</p><ol><li><strong>프레임워크별 적용 가이드</strong> (.NET, Spring Boot, Node.js 등)</li><li><strong>고급 최적화 기법</strong> (e.g. Snapshot 전략, 이벤트 압축, 멀티 테넌시 지원 등)</li><li><strong>도전 과제 심화 분석</strong> (스키마 진화, 장애 대응, 모니터링/CI/CD 통합)</li><li><strong>분류 기준에 따른 종류 및 유형</strong> (예: CRUD vs Event-Sourced 시스템 비교)</li><li><strong>실무 적용 전 체크리스트</strong>, 적용 팁, 트레이드오프 분석 요약</li></ol><p>다음은 <strong>프레임워크별 적용 가이드</strong>입니다. .NET, Spring Boot, Node.js 중심으로 Event Sourcing + CQRS 구조를 실무에 적용하는 방법과 주요 체크포인트를 정리했습니다.</p><hr><h2 id=2-java--spring-boot--axon-framework>2. Java / Spring Boot + Axon Framework<a hidden class=anchor aria-hidden=true href=#2-java--spring-boot--axon-framework>#</a></h2><ul><li><p><strong>Axon 구성</strong>:</p><ul><li><code>@Aggregate</code>, <code>@CommandHandler</code>, <code>@EventSourcingHandler</code>, <code>@EventHandler</code> 등의 어노테이션 사용</li><li>EventStore는 JPA, MongoDB, Kafka 기반으로 설정 가능</li></ul></li><li><p><strong>도메인 모델</strong></p><ul><li><code>Aggregate</code> 클래스에서 <code>@CommandHandler</code> → do business logic → <code>apply()</code> event 호출</li></ul></li><li><p><strong>프로젝션(read model) 구성</strong>:</p><ul><li><code>@EventHandler</code> 클래스에서 <code>ReadRepository</code>에 쓰기</li><li><code>QueryGateway</code> 사용해 Query API 호출</li></ul></li><li><p><strong>Snapshot & 스케일링</strong></p><ul><li><code>@SnapshotTrigger</code> 사용 또는 Snapshot trigger policy 설정</li><li>Saga 패턴을 통한 비동기 장기 프로세스 관리</li></ul></li><li><p><strong>추가 기능</strong></p><ul><li>Event replay / reset via CLI</li><li>EventBus, Serializer, Metrics 자동 지원</li></ul></li></ul><hr><h2 id=3-nodejs--nestjs--typeorm--kafka>3. Node.js + NestJS + TypeORM + Kafka<a hidden class=anchor aria-hidden=true href=#3-nodejs--nestjs--typeorm--kafka>#</a></h2><ul><li><p><strong>Event Store 구현</strong></p><ul><li>Kafka 토픽 중심 저장: partition, offset 활용</li><li>관계형 DB 보조 store로 상태 저장 가능</li></ul></li><li><p><strong>도메인 / Command Handler</strong></p><ul><li>NestJS에서 <code>@CommandHandler()</code> 데코레이터 사용 + <code>CqrsModule</code></li><li><code>@EventPublisher()</code>로 publisher 주입</li></ul></li><li><p><strong>프로젝션</strong></p><ul><li><code>@EventsHandler()</code>에서 <code>ReadRepository.save()</code></li><li>TypeORM 리포지토리 기반 Read DB 테이블 업데이트</li></ul></li><li><p><strong>Snapshot</strong></p><ul><li>QoS 단위로 Kafka offset 관리 및 State 저장</li><li>Redis 등 외부 Key-Value store 활용</li></ul></li><li><p><strong>환경 설정</strong></p><ul><li>Nest Module 내 EventStore, CommandBus, EventBus 등록</li><li>ValidationPipe, Interceptor 통한 Idempotency/Retry 처리</li></ul></li></ul><hr><h2 id=-공통-적용-체크포인트>✅ 공통 적용 체크포인트<a hidden class=anchor aria-hidden=true href=#-공통-적용-체크포인트>#</a></h2><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>이벤트 불변성</td><td>스키마 변경 시 마이그레이션 필요</td><td>Version Field, Upcaster 적용</td></tr><tr><td>중복 처리</td><td>메시지 OO처리</td><td>Idempotent 핸들러 구현</td></tr><tr><td>일관성 보장</td><td>Write 모델/Read 모델 단일 원장 필요</td><td>Outbox 패턴 + 메시지 트랜잭션 구성</td></tr><tr><td>모니터링</td><td>이벤트 처리 흐름 추적 어려움</td><td>Lag, 처리율, 에러 메트릭 모니터링</td></tr><tr><td>장애 대응</td><td>메시지고립 및 장애 발생 가능</td><td>Dead-letter queue, 재시도 전략 구성</td></tr><tr><td>테스트 전략</td><td>CQRS 구조 분리로 테스트 케이스 증가</td><td>Core, Projection, Integration 테스트를 분리하여 구성</td></tr></tbody></table><hr><h3 id=-다음-단계-제안>🧭 다음 단계 제안<a hidden class=anchor aria-hidden=true href=#-다음-단계-제안>#</a></h3><ol><li><strong>고급 최적화 기법</strong> (snapshot 전략, 이벤트 압축, 멀티 테넌시 등)</li><li><strong>실무 도전 과제 심화</strong> (스키마 진화, 장애 대응, CI/CD 통합 전략)</li><li><strong>추가 코드 예시</strong>: Node.js 또는 Java 구현 샘플</li></ol><p>원하시는 항목을 지정해 주세요. 바로 이어서 정리해드리겠습니다!</p><p>다음은 <strong>고급 최적화 기법</strong> 및 <strong>실무에서 마주치는 도전 과제 심화 분석</strong>입니다.</p><hr><h2 id=1-고급-최적화-기법->1. 고급 최적화 기법 🌐<a hidden class=anchor aria-hidden=true href=#1-고급-최적화-기법->#</a></h2><h3 id=-snapshot-전략>• Snapshot 전략<a hidden class=anchor aria-hidden=true href=#-snapshot-전략>#</a></h3><ul><li><p><strong>목적 / 효과</strong>: 이벤트 재생 비용 절감 및 빠른 Aggregate 로딩</p></li><li><p><strong>구현 방법</strong>:</p><ul><li>일정 이벤트 수(예: 500회)마다 <code>Snapshot</code> 저장</li><li>복구 시 마지막 Snapshot부터 이벤트 재생</li></ul></li><li><p><strong>주의 & 권장사항</strong>:</p><ul><li>비즈니스 중요한 시점 기준 스냅샷 생성</li><li>Snapshot 데이터 크기 최소화, 압축 저장</li></ul></li></ul><h3 id=-이벤트-압축-event-compression>• 이벤트 압축 (Event Compression)<a hidden class=anchor aria-hidden=true href=#-이벤트-압축-event-compression>#</a></h3><ul><li><p><strong>목적 / 효과</strong>: 유사 이벤트 병합으로 저장 공간 절감</p></li><li><p><strong>구현 방법</strong>:</p><ul><li>중복/불필요 이벤트 탐지 및 주기적으로 축소</li><li>예: “Qty +5”, “Qty +3” → “Qty +8” 압축</li></ul></li><li><p><strong>주의 & 권장사항</strong>:</p><ul><li>도메인 의미 손상 안 되도록 이벤트 단위 유지</li><li>압축 주기 및 조건 조정 필요</li></ul></li></ul><h3 id=-이벤트-ttl--아카이빙>• 이벤트 TTL / 아카이빙<a hidden class=anchor aria-hidden=true href=#-이벤트-ttl--아카이빙>#</a></h3><ul><li><p><strong>목적 / 효과</strong>: 오래된 이벤트 관리 → 스토리지 비용 절감</p></li><li><p><strong>구현 방법</strong>:</p><ul><li>TTL 설정 후 오래된 이벤트는 외부 저장소로 이동</li></ul></li><li><p><strong>주의 & 권장사항</strong>:</p><ul><li>아카이빙 정책 문서화, 복원 절차 포함</li><li>GDPR/법규 준수 여부 고려</li></ul></li></ul><h3 id=-멀티-테넌시-지원>• 멀티 테넌시 지원<a hidden class=anchor aria-hidden=true href=#-멀티-테넌시-지원>#</a></h3><ul><li><p><strong>목적 / 효과</strong>: SaaS 환경에서 고객 격리 보장</p></li><li><p><strong>구현 방법</strong>:</p><ul><li>네임스페이스별 이벤트 스트림 분리</li><li>테이블 파티셔닝 또는 토픽 분리 활용</li></ul></li><li><p><strong>주의 & 권장사항</strong>:</p><ul><li>추가 모니터링 처리량 분리</li><li>권한 경계(naming scope) 및 검증 로직 보강</li></ul></li></ul><h3 id=-백필링-backfilling>• 백필링 (Backfilling)<a hidden class=anchor aria-hidden=true href=#-백필링-backfilling>#</a></h3><ul><li><p><strong>목적 / 효과</strong>: 기존 이벤트로 오프라인 뷰 재생성, 코드 변경 영향 보강</p></li><li><p><strong>구현 방법</strong>:</p><ul><li>버전 이벤트 upcasting + 롤백부터 신규 코드 반영 재연산</li></ul></li><li><p><strong>주의 & 권장사항</strong>:</p><ul><li>고가용성 환경에서 배칭 처리, pause & resume 기능 필요</li><li>모니터링 및 실패 시 재시도 메커니즘 구축</li></ul></li></ul><hr><h2 id=2-도전-과제-심화-분석->2. 도전 과제 심화 분석 🔍<a hidden class=anchor aria-hidden=true href=#2-도전-과제-심화-분석->#</a></h2><h3 id=-이벤트-스키마-진화>• 이벤트 스키마 진화<a hidden class=anchor aria-hidden=true href=#-이벤트-스키마-진화>#</a></h3><ul><li><p><strong>원인</strong>: 도메인 로직 변화로 이벤트 구조가 변경됨</p></li><li><p><strong>영향</strong>: 오래된 이벤트 디코딩 실패, 재생 오류</p></li><li><p><strong>탐지/진단</strong>: 업스트림 로그 분석, 이벤트 리플레이 실패</p></li><li><p><strong>예방</strong>: 업캐스팅(upcasting) 전략, 버전 필드 포함 설계</p></li><li><p><strong>해결 기법</strong>:</p><ul><li>이벤트 리팩토링 시 새・구 버전 모두 파서 등록</li><li>데이터 마이그레이션 지원 또는 적응형 소비자</li></ul></li></ul><h3 id=-분산-장애-대응>• 분산 장애 대응<a hidden class=anchor aria-hidden=true href=#-분산-장애-대응>#</a></h3><ul><li><p><strong>원인</strong>: 이벤트 송수신 실패, 브로커 장애</p></li><li><p><strong>영향</strong>: Projection 지연/누락, 시스템 불안정</p></li><li><p><strong>탐지/진단</strong>: Dead Letter 큐 알림, 지연 메트릭</p></li><li><p><strong>예방</strong>: Exactly-once, idempotent 설계</p></li><li><p><strong>해결 기술</strong>:</p><ul><li>Dead-letter 큐, 재시도 전략</li><li>모니터링 기반 자동 복구</li><li>Outbox pattern + 브로커 트랜잭션</li></ul></li></ul><h3 id=-모니터링--추적>• 모니터링 & 추적<a hidden class=anchor aria-hidden=true href=#-모니터링--추적>#</a></h3><ul><li><p><strong>원인</strong>: 비동기 이벤트 흐름 복잡성</p></li><li><p><strong>영향</strong>: 장애 원인 분석 어려움</p></li><li><p><strong>탐지/진단</strong>: 분산 트레이싱 미비, 로그 단절</p></li><li><p><strong>예방</strong>: Correlation ID 및 Trace context 포함 설계</p></li><li><p><strong>해결 방법</strong>:</p><ul><li>Zipkin, OpenTelemetry 연동</li><li>Event dispatch / process 메트릭 수집</li></ul></li></ul><h3 id=-테스트--유지보수>• 테스트 & 유지보수<a hidden class=anchor aria-hidden=true href=#-테스트--유지보수>#</a></h3><ul><li><p><strong>원인</strong>: 이벤트 중심 결과 기반 테스트 복잡</p></li><li><p><strong>영향</strong>: 리그레션 위험 & 코드 가시성 감소</p></li><li><p><strong>탐지/진단</strong>: Projection 오류, 핸들러 실패</p></li><li><p><strong>예방</strong>: E2E/Contract 테스트 설계 철저</p></li><li><p><strong>해결 기술</strong>:</p><ul><li>Testcontainers 사용</li><li>모킹 가능한 EventBus, Projection 결과 검증 설정</li></ul></li></ul><hr><h2 id=3--요약-및-권장-가이드>3. ✅ 요약 및 권장 가이드<a hidden class=anchor aria-hidden=true href=#3--요약-및-권장-가이드>#</a></h2><ul><li><strong>최적화 전략</strong>: Snapshot + 이벤트 압축 + TTL 아카이빙 + 테넌시 분리 고려</li><li><strong>장애 대응</strong>: Dead-letter, Trace 모니터링, Outbox 트랜잭션 보강</li><li><strong>테스트 전략</strong>: 리그레션 방지 위한 E2E/Contract 테스트 구조화</li><li><strong>장기 운용 팁</strong>: 이벤트 스키마 진화 정책, 장애 자동 복구, 분산 tracing·metrics 구축</li></ul><hr><p>🎯 추가로 <strong>SAGA 패턴 통합</strong>, 특정 프레임워크 적용 코드 예시(.NET, NestJS), <strong>이벤트 기반 데이터 모델링 전략</strong>, 또는 <strong>보안/가버넌스 구축</strong>이 필요하시면 언제든지 요청해주세요!</p><p>이벤트 기반(Event-Driven) 아키텍처에서의 <strong>데이터 모델링 전략</strong>은 전통적인 CRUD 모델링과 달리 <strong>도메인 이벤트 중심</strong>으로 설계됩니다. 아래는 이벤트 기반 모델링 시 고려할 전략들을 실무 중심으로 정리한 내용입니다.</p><hr><h2 id=1-이벤트-기반-데이터-모델링의-핵심-원칙>1. 이벤트 기반 데이터 모델링의 핵심 원칙<a hidden class=anchor aria-hidden=true href=#1-이벤트-기반-데이터-모델링의-핵심-원칙>#</a></h2><table><thead><tr><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>도메인 중심</td><td>도메인 이벤트(Domain Events)를 기준으로 상태 전이 모델링</td></tr><tr><td>불변성</td><td>이벤트는 변경 불가(immutable) 데이터로 유지</td></tr><tr><td>비정규화</td><td>조회 성능 중심의 Projection 모델 설계 (Read Model)</td></tr><tr><td>일관성 지연</td><td>일관성(consistency)은 즉시가 아닌 이벤트에 의해 Eventually Consistent</td></tr><tr><td>책임 분리</td><td>Command 모델과 Query 모델을 명확히 분리 (CQRS)</td></tr></tbody></table><hr><h2 id=2-모델링-접근-방법>2. 모델링 접근 방법<a hidden class=anchor aria-hidden=true href=#2-모델링-접근-방법>#</a></h2><h3 id=--aggregate-중심-설계>🧩 ① Aggregate 중심 설계<a hidden class=anchor aria-hidden=true href=#--aggregate-중심-설계>#</a></h3><ul><li>한 트랜잭션 내 상태 변경의 단위를 Aggregate 단위로 정의</li><li>상태 변경은 Command → Event → Aggregate 상태 반영 흐름</li></ul><h3 id=--이벤트-유형-정의>🧾 ② 이벤트 유형 정의<a hidden class=anchor aria-hidden=true href=#--이벤트-유형-정의>#</a></h3><ul><li><code>OrderPlaced</code>, <code>PaymentCompleted</code>, <code>InventoryDecreased</code> 등 도메인 상태 전이에 기반한 이벤트 정의</li><li>Event는 과거형으로 명명</li></ul><h3 id=--event-sourcing-기반-상태-재생>🗃️ ③ Event Sourcing 기반 상태 재생<a hidden class=anchor aria-hidden=true href=#--event-sourcing-기반-상태-재생>#</a></h3><ul><li>Entity 상태를 DB에 저장하지 않고 이벤트 스트림 기반으로 복원</li><li>변경 상태 = 이전 상태 + 이벤트 집합</li></ul><h3 id=--projection-모델링-read-model>🗂️ ④ Projection 모델링 (Read Model)<a hidden class=anchor aria-hidden=true href=#--projection-모델링-read-model>#</a></h3><ul><li>각 View 목적에 맞게 다수의 Projection 테이블 설계</li><li>예: <code>CustomerView</code>, <code>OrderSummaryView</code>, <code>PaymentStatsView</code> 등</li></ul><h3 id=--이벤트-스키마-설계>🏷️ ⑤ 이벤트 스키마 설계<a hidden class=anchor aria-hidden=true href=#--이벤트-스키마-설계>#</a></h3><ul><li>이벤트 버전 관리 필수 (<code>event_type</code>, <code>version</code>, <code>timestamp</code>, <code>correlation_id</code> 등)</li><li>JSON 기반의 schema registry(예: Apache Avro, Protobuf) 활용 권장</li></ul><hr><h2 id=3-모델링-예시--쇼핑몰-주문>3. 모델링 예시 – 쇼핑몰 주문<a hidden class=anchor aria-hidden=true href=#3-모델링-예시--쇼핑몰-주문>#</a></h2><h3 id=-도메인-이벤트-예시>▶ 도메인 이벤트 예시<a hidden class=anchor aria-hidden=true href=#-도메인-이벤트-예시>#</a></h3><table><thead><tr><th>이벤트명</th><th>속성 예시</th></tr></thead><tbody><tr><td><code>OrderCreated</code></td><td>order_id, user_id, items, total_price, timestamp</td></tr><tr><td><code>OrderPaid</code></td><td>order_id, payment_id, method, amount, timestamp</td></tr><tr><td><code>OrderShipped</code></td><td>order_id, tracking_number, carrier, timestamp</td></tr></tbody></table><h3 id=-aggregate-상태-재생-event-sourcing-기반>▶ Aggregate 상태 재생 (Event Sourcing 기반)<a hidden class=anchor aria-hidden=true href=#-aggregate-상태-재생-event-sourcing-기반>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-63-1><a class=lnlinks href=#hl-63-1> 1</a>
</span><span class=lnt id=hl-63-2><a class=lnlinks href=#hl-63-2> 2</a>
</span><span class=lnt id=hl-63-3><a class=lnlinks href=#hl-63-3> 3</a>
</span><span class=lnt id=hl-63-4><a class=lnlinks href=#hl-63-4> 4</a>
</span><span class=lnt id=hl-63-5><a class=lnlinks href=#hl-63-5> 5</a>
</span><span class=lnt id=hl-63-6><a class=lnlinks href=#hl-63-6> 6</a>
</span><span class=lnt id=hl-63-7><a class=lnlinks href=#hl-63-7> 7</a>
</span><span class=lnt id=hl-63-8><a class=lnlinks href=#hl-63-8> 8</a>
</span><span class=lnt id=hl-63-9><a class=lnlinks href=#hl-63-9> 9</a>
</span><span class=lnt id=hl-63-10><a class=lnlinks href=#hl-63-10>10</a>
</span><span class=lnt id=hl-63-11><a class=lnlinks href=#hl-63-11>11</a>
</span><span class=lnt id=hl-63-12><a class=lnlinks href=#hl-63-12>12</a>
</span><span class=lnt id=hl-63-13><a class=lnlinks href=#hl-63-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderAggregate</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>apply</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderCreated</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;CREATED&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderPaid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;PAID&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>OrderShipped</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;SHIPPED&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=-projection-설계>▶ Projection 설계<a hidden class=anchor aria-hidden=true href=#-projection-설계>#</a></h3><table><thead><tr><th>Projection Name</th><th>필드 구성</th><th>목적</th></tr></thead><tbody><tr><td><code>OrderSummaryView</code></td><td>order_id, user_id, status, total_price</td><td>사용자 주문 조회용</td></tr><tr><td><code>OrderStatusStats</code></td><td>status, count</td><td>관리자 대시보드 통계</td></tr></tbody></table><hr><h2 id=4-모델링-시-고려사항>4. 모델링 시 고려사항<a hidden class=anchor aria-hidden=true href=#4-모델링-시-고려사항>#</a></h2><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>이벤트 정합성</td><td>이벤트 순서에 따라 상태 달라짐</td><td>Event ordering 보장 (Kafka partition key 기준)</td></tr><tr><td>이벤트 버전</td><td>구조 변경 시 호환성 유지</td><td>Event upcasting 전략, schema registry 도입</td></tr><tr><td>조회 최적화</td><td>Projection은 뷰 최적화 목적</td><td>Index, denormalization, TTL 고려</td></tr><tr><td>GDPR 대응</td><td>이벤트 로그에서 민감 정보 처리</td><td>암호화/익명화, soft delete 이벤트 발행</td></tr><tr><td>오류 복구</td><td>Projection 재생 지원</td><td>이벤트 replay 기능 및 checkpoint 저장</td></tr></tbody></table><hr><h2 id=5-추천-도구-및-기술>5. 추천 도구 및 기술<a hidden class=anchor aria-hidden=true href=#5-추천-도구-및-기술>#</a></h2><table><thead><tr><th>카테고리</th><th>도구 / 기술</th><th>설명</th></tr></thead><tbody><tr><td>Event Store</td><td>EventStoreDB, Kafka, Axon, Marten</td><td>도메인 이벤트 저장소</td></tr><tr><td>Query DB</td><td>Elasticsearch, Redis, PostgreSQL</td><td>Projection 용 Read DB</td></tr><tr><td>Schema 관리</td><td>Avro, Protobuf, AsyncAPI</td><td>이벤트 스키마 정의 및 버전 관리</td></tr><tr><td>프레임워크</td><td>Axon (Java), Eventuous (.NET), NestJS CQRS</td><td>이벤트 기반 설계 지원</td></tr></tbody></table><hr><h2 id=-요약-1>✅ 요약<a hidden class=anchor aria-hidden=true href=#-요약-1>#</a></h2><p>이벤트 기반 데이터 모델링은 이벤트가 곧 데이터의 원천(Log-as-source)이며, 모델은 불변성, 도메인 중심, 읽기/쓰기 책임 분리를 핵심 원칙으로 합니다. 이를 통해 확장성과 추적성을 확보할 수 있지만, 이벤트 순서, 스키마 관리, 비동기 처리 등의 복잡성이 증가하므로 구조적 설계가 필수입니다.</p><hr><h1 id=event-sourcing-분석-보고서>Event Sourcing 분석 보고서<a hidden class=anchor aria-hidden=true href=#event-sourcing-분석-보고서>#</a></h1><h2 id=1-태그-3>1. 태그<a hidden class=anchor aria-hidden=true href=#1-태그-3>#</a></h2><p><strong>Event-Sourcing</strong>, <strong>CQRS-Pattern</strong>, <strong>Data-Management</strong>, <strong>Architecture-Pattern</strong></p><h2 id=2-주제-분류-분석>2. 주제 분류 분석<a hidden class=anchor aria-hidden=true href=#2-주제-분류-분석>#</a></h2><p><strong>지정된 카테고리</strong>: &ldquo;Computer Science and Engineering&rdquo; > &ldquo;Software Engineering&rdquo; > &ldquo;Design and Architecture&rdquo; > &ldquo;Architecture Styles and Patterns&rdquo; > &ldquo;Architecture Patterns&rdquo; > &ldquo;Data Management&rdquo;</p><p><strong>분석 결과</strong>: Event Sourcing은 애플리케이션 상태를 처리하는 데이터 중심 아키텍처 패턴으로, CRUD 모델과는 다른 접근 방식을 취합니다. 제시된 카테고리 계층 구조는 적절하며, 특히 &ldquo;Data Management&rdquo; 하위에 위치하는 것이 타당합니다. Event Sourcing은 비즈니스 엔터티의 상태를 상태 변경 이벤트의 시퀀스로 지속화하는 데이터 관리 패턴이기 때문입니다.</p><h2 id=3-요약-문장-200자-내외-1>3. 요약 문장 (200자 내외)<a hidden class=anchor aria-hidden=true href=#3-요약-문장-200자-내외-1>#</a></h2><p>Event Sourcing은 애플리케이션의 모든 상태 변경을 불변의 이벤트 시퀀스로 저장하는 아키텍처 패턴입니다. 현재 상태를 직접 저장하는 대신 이벤트를 재생하여 상태를 재구성하며, 완전한 감사 추적과 시간 기반 쿼리를 제공하여 복잡한 비즈니스 시스템과 분산 아키텍처에 적합합니다.</p><h2 id=4-전체-개요-250자-내외-1>4. 전체 개요 (250자 내외)<a hidden class=anchor aria-hidden=true href=#4-전체-개요-250자-내외-1>#</a></h2><p>Event Sourcing은 애플리케이션 상태의 모든 변경사항을 이벤트 시퀀스로 저장하는 패턴으로, 전통적인 CRUD 방식과 달리 상태 변경의 전체 이력을 보존합니다. CQRS와 함께 사용되어 읽기와 쓰기 모델을 분리하며, 마이크로서비스 아키텍처에서 데이터 일관성과 확장성을 제공합니다. 금융, 전자상거래, 물류 등 다양한 도메인에서 활용되어 감사 추적, 디버깅, 상태 복구 등의 강력한 기능을 제공합니다.</p><hr><h2 id=5-핵심-개념-2>5. 핵심 개념<a hidden class=anchor aria-hidden=true href=#5-핵심-개념-2>#</a></h2><h3 id=기본-개념-1>기본 개념<a hidden class=anchor aria-hidden=true href=#기본-개념-1>#</a></h3><ul><li><strong>이벤트 (Event)</strong>: 과거에 발생한 상태 변경을 나타내는 불변의 팩트</li><li><strong>이벤트 스토어 (Event Store)</strong>: 이벤트가 지속화되는 추가 전용 저장소로 시스템 기록의 권위 있는 데이터 소스 역할</li><li><strong>애그리게이트 (Aggregate)</strong>: 단일 세밀한 이벤트 스트림에서 재구성되는 도메인 주도 설계의 일관성 경계</li><li><strong>프로젝션 (Projection)</strong>: 이벤트 스트림에서 파생된 현재 상태에 대한 답변으로, 읽기 모델 구성에 사용</li></ul><h3 id=실무-구현-요소>실무 구현 요소<a hidden class=anchor aria-hidden=true href=#실무-구현-요소>#</a></h3><ul><li><strong>이벤트 스키마 설계</strong>: 이벤트 구조와 버전 관리</li><li><strong>스냅샷 (Snapshot)</strong>: 정기적인 간격으로 데이터의 스냅샷을 구현하여 성능 향상</li><li><strong>이벤트 핸들러</strong>: 이벤트를 처리하고 프로젝션을 업데이트하는 컴포넌트</li><li><strong>명령 처리</strong>: 도메인 로직을 통한 이벤트 생성</li><li><strong>동시성 제어</strong>: 이벤트 순서와 일관성 보장 메커니즘</li></ul><hr><h2 id=제1부-이론적-기초>제1부: 이론적 기초<a hidden class=anchor aria-hidden=true href=#제1부-이론적-기초>#</a></h2><h2 id=배경-2>배경<a hidden class=anchor aria-hidden=true href=#배경-2>#</a></h2><p>Event Sourcing은 1970년대와 80년대 데이터베이스 변경 로그와 메시지 기반 아키텍처에서 뿌리를 찾을 수 있지만, Eric Evans의 Domain-Driven Design(2003)과 Greg Young의 영향력 있는 강연을 통해 엔터프라이즈 소프트웨어 패턴으로 공식화되었습니다.</p><h2 id=목적-및-필요성-2>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성-2>#</a></h2><ol><li><strong>완전한 감사 추적</strong>: 시스템에서 발생한 모든 변경사항의 불변 기록 구축</li><li><strong>시간 기반 쿼리</strong>: 어떤 시점에서든 엔터티의 상태를 결정하는 시간적 쿼리 구현 가능</li><li><strong>복잡한 비즈니스 로직 지원</strong>: 변경 기록, 감사 가능성 또는 복잡한 비즈니스 로직이 요구사항을 주도하는 도메인에 적합</li><li><strong>분산 시스템 일관성</strong>: 느슨하게 결합된 비즈니스 엔터티 간 이벤트 교환을 통한 마이크로서비스 아키텍처 지원</li></ol><h2 id=주요-기능-및-역할-1>주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#주요-기능-및-역할-1>#</a></h2><ul><li><strong>상태 재구성</strong>: 이벤트 재생을 통한 현재 상태 복원</li><li><strong>이벤트 발행</strong>: 다른 시스템에 상태 변경 알림</li><li><strong>시간 여행</strong>: 과거 특정 시점의 상태 조회</li><li><strong>디버깅 지원</strong>: 상태 변경 과정 추적 및 분석</li></ul><h2 id=특징-2>특징<a hidden class=anchor aria-hidden=true href=#특징-2>#</a></h2><ol><li><strong>불변성</strong>: 모든 이벤트는 불변이며 추가 전용 방식으로 저장</li><li><strong>순차성</strong>: 이벤트는 발생 순서대로 저장</li><li><strong>원자성</strong>: 이벤트 저장은 단일 연산으로 본질적으로 원자적</li><li><strong>재생 가능성</strong>: 언제든지 이벤트를 재생하여 상태 복원 가능</li></ol><h2 id=핵심-원칙-2>핵심 원칙<a hidden class=anchor aria-hidden=true href=#핵심-원칙-2>#</a></h2><ol><li><strong>이벤트를 사실로 취급</strong>: 이벤트는 발생한 사실의 기록</li><li><strong>추가 전용 저장</strong>: 기존 데이터 수정이나 삭제 금지</li><li><strong>순서 보장</strong>: 이벤트 발생 순서 유지</li><li><strong>단일 소스 진실</strong>: 이벤트 스토어가 유일한 진실의 원천</li></ol><h2 id=주요-원리>주요 원리<a hidden class=anchor aria-hidden=true href=#주요-원리>#</a></h2><pre class=mermaid>graph TD
    A[Command] --&gt; B[Aggregate]
    B --&gt; C[Event Generated]
    C --&gt; D[Event Store]
    D --&gt; E[Event Handler]
    E --&gt; F[Projection Update]
    D --&gt; G[Event Replay]
    G --&gt; H[State Reconstruction]
</pre><p><strong>작동 원리</strong>:</p><ol><li><strong>명령 처리</strong>: 애플리케이션 코드가 객체에 대해 수행된 작업을 명령적으로 설명하는 이벤트를 발생</li><li><strong>이벤트 저장</strong>: 생성된 이벤트를 추가 전용 이벤트 스토어에 저장</li><li><strong>이벤트 발행</strong>: 이벤트 핸들러가 관심 있는 이벤트를 수신하고 적절한 작업 수행</li><li><strong>상태 재구성</strong>: 필요 시 이벤트 재생을 통해 현재 상태 복원</li></ol><hr><h2 id=제2부-구조-및-구현>제2부: 구조 및 구현<a hidden class=anchor aria-hidden=true href=#제2부-구조-및-구현>#</a></h2><h2 id=구조-및-아키텍처-1>구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#구조-및-아키텍처-1>#</a></h2><pre class=mermaid>graph TB
    subgraph &#34;Command Side (Write Model)&#34;
        A[Command Handler] --&gt; B[Aggregate]
        B --&gt; C[Domain Events]
        C --&gt; D[Event Store]
    end
    
    subgraph &#34;Query Side (Read Model)&#34;
        E[Event Handlers] --&gt; F[Projections]
        F --&gt; G[Read Database]
    end
    
    D --&gt; E
    D --&gt; H[Event Bus]
    H --&gt; I[External Systems]
    
    subgraph &#34;Supporting Components&#34;
        J[Snapshots]
        K[Event Schemas]
        L[Version Management]
    end
    
    D -.-&gt; J
    C -.-&gt; K
    K -.-&gt; L
</pre><h3 id=필수-구성요소-1>필수 구성요소<a hidden class=anchor aria-hidden=true href=#필수-구성요소-1>#</a></h3><table><thead><tr><th>구성요소</th><th>기능</th><th>역할</th><th>특징</th></tr></thead><tbody><tr><td><strong>이벤트 스토어</strong></td><td>이벤트 지속화</td><td>시스템 기록의 권위 있는 데이터 소스 역할</td><td>추가 전용, 순서 보장</td></tr><tr><td><strong>애그리게이트</strong></td><td>비즈니스 로직 처리</td><td>명령 검증 및 이벤트 생성</td><td>일관성 경계 제공</td></tr><tr><td><strong>이벤트</strong></td><td>상태 변경 기록</td><td>시스템의 각 변경 사항을 개별 이벤트로 문서화</td><td>불변, 순차 저장</td></tr><tr><td><strong>이벤트 핸들러</strong></td><td>이벤트 처리</td><td>프로젝션 업데이트 및 부가 작업</td><td>비동기 처리</td></tr></tbody></table><h3 id=선택-구성요소-1>선택 구성요소<a hidden class=anchor aria-hidden=true href=#선택-구성요소-1>#</a></h3><table><thead><tr><th>구성요소</th><th>기능</th><th>역할</th><th>특징</th></tr></thead><tbody><tr><td><strong>스냅샷</strong></td><td>성능 최적화</td><td>정기적 간격으로 데이터 스냅샷 구현</td><td>재구성 성능 향상</td></tr><tr><td><strong>이벤트 버스</strong></td><td>이벤트 발행</td><td>외부 시스템 알림</td><td>느슨한 결합 제공</td></tr><tr><td><strong>CQRS 구현</strong></td><td>읽기/쓰기 분리</td><td>명령과 쿼리 책임 분리</td><td>성능 최적화</td></tr></tbody></table><h2 id=구현-기법-1>구현 기법<a hidden class=anchor aria-hidden=true href=#구현-기법-1>#</a></h2><h3 id=1-기본-event-sourcing>1. 기본 Event Sourcing<a hidden class=anchor aria-hidden=true href=#1-기본-event-sourcing>#</a></h3><p><strong>정의</strong>: 이벤트만을 이용한 상태 관리
<strong>구성</strong>: 이벤트 스토어 + 이벤트 재생
<strong>목적</strong>: 완전한 감사 추적 제공
<strong>실제 예시</strong>: 은행 계좌 거래 내역을 모든 입출금 이벤트로 관리</p><h3 id=2-cqrs와-결합된-event-sourcing>2. CQRS와 결합된 Event Sourcing<a hidden class=anchor aria-hidden=true href=#2-cqrs와-결합된-event-sourcing>#</a></h3><p><strong>정의</strong>: 데이터 관리 작업을 이벤트에 대한 응답으로 수행하고 저장된 이벤트에서 뷰를 구체화
<strong>구성</strong>: 명령 모델 + 쿼리 모델 + 이벤트 스토어 + 프로젝션
<strong>목적</strong>: 읽기와 쓰기 성능 최적화
<strong>실제 예시</strong>: 전자상거래에서 주문 처리(쓰기)와 재고 조회(읽기) 분리</p><h3 id=3-snapshot을-활용한-event-sourcing>3. Snapshot을 활용한 Event Sourcing<a hidden class=anchor aria-hidden=true href=#3-snapshot을-활용한-event-sourcing>#</a></h3><p><strong>정의</strong>: 성능 최적화를 위한 상태 스냅샷 저장
<strong>구성</strong>: 이벤트 스토어 + 스냅샷 저장소 + 증분 이벤트 재생
<strong>목적</strong>: 대용량 이벤트에서 재구성 성능 향상
<strong>실제 예시</strong>: 수천 개의 트랜잭션이 있는 계좌에서 주기적 잔액 스냅샷 생성</p><h3 id=4-분산-event-sourcing>4. 분산 Event Sourcing<a hidden class=anchor aria-hidden=true href=#4-분산-event-sourcing>#</a></h3><p><strong>정의</strong>: 마이크로서비스 환경에서의 이벤트 소싱
<strong>구성</strong>: 서비스별 이벤트 스토어 + 이벤트 버스 + Saga 패턴
<strong>목적</strong>: 분산 시스템에서 데이터 일관성 보장
<strong>실제 예시</strong>: MSA에서 서비스별 분리된 DB 간 트랜잭션 관리</p><hr><h2 id=제3부-분석-및-평가>제3부: 분석 및 평가<a hidden class=anchor aria-hidden=true href=#제3부-분석-및-평가>#</a></h2><h2 id=장점-1>장점<a hidden class=anchor aria-hidden=true href=#장점-1>#</a></h2><table><thead><tr><th>구분</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>감사 및 추적성</strong></td><td>완전한 감사 로그</td><td>이벤트 소싱된 시스템은 가장 강력한 감사 로그 옵션 중 하나를 제공</td></tr><tr><td><strong>시간적 분석</strong></td><td>시간 기반 쿼리</td><td>시스템을 시간상 앞뒤로 이동시켜 디버깅과 &ldquo;만약에&rdquo; 분석에 매우 가치 있음</td></tr><tr><td><strong>확장성</strong></td><td>수평적 확장</td><td>이벤트 소싱은 분산 시스템과 수평적 확장에 적합</td></tr><tr><td><strong>복원력</strong></td><td>장애 복구</td><td>다운스트림 프로젝션을 재구축할 수 있는 핵심 &ldquo;기록 소스&rdquo; 데이터만 이벤트 스트림에 작성</td></tr><tr><td><strong>성능</strong></td><td>읽기/쓰기 최적화</td><td>이벤트 소싱된 시스템은 최소한의 동기적 상호작용을 추구하여 반응적, 고성능, 확장 가능한 시스템을 구현</td></tr></tbody></table><h2 id=단점과-문제점-그리고-해결방안-1>단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#단점과-문제점-그리고-해결방안-1>#</a></h2><h3 id=단점-3>단점<a hidden class=anchor aria-hidden=true href=#단점-3>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td><strong>복잡성</strong></td><td>학습 곡선</td><td>다르고 익숙하지 않은 프로그래밍 스타일로 학습 곡선이 존재</td><td>단계적 도입, 교육 프로그램</td></tr><tr><td><strong>쿼리 어려움</strong></td><td>이벤트 스토어 쿼리</td><td>비즈니스 엔터티의 상태를 재구성하는 일반적인 쿼리가 복잡하고 비효율적</td><td>CQRS 패턴 적용</td></tr><tr><td><strong>일관성</strong></td><td>최종 일관성</td><td>구체화된 뷰나 데이터 프로젝션 생성 시 최종적으로만 일관성 유지</td><td>적절한 일관성 경계 설계</td></tr></tbody></table><h3 id=문제점-3>문제점<a hidden class=anchor aria-hidden=true href=#문제점-3>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td><strong>성능 저하</strong></td><td>프로젝션 재구축</td><td>대량 이벤트 누적</td><td>응답 시간 증가</td><td>성능 모니터링 도구</td><td>스냅샷 구현</td><td>정기적 간격으로 데이터 스냅샷 구현</td></tr><tr><td><strong>스키마 변경</strong></td><td>이벤트 구조 변화</td><td>비즈니스 요구사항 변경</td><td>시스템 호환성 문제</td><td>버전 호환성 테스트</td><td>이벤트 버전 관리</td><td>이벤트 업캐스팅/다운캐스팅</td></tr><tr><td><strong>동시성 충돌</strong></td><td>동일 애그리게이트 수정</td><td>동시 명령 처리</td><td>데이터 일관성 위반</td><td>버전 체크</td><td>낙관적 동시성 제어</td><td>충돌하는 업데이트에 대해 멱등성 보장</td></tr></tbody></table><h2 id=도전-과제-1>도전 과제<a hidden class=anchor aria-hidden=true href=#도전-과제-1>#</a></h2><h3 id=기술적-도전>기술적 도전<a hidden class=anchor aria-hidden=true href=#기술적-도전>#</a></h3><ol><li><strong>이벤트 스키마 진화</strong>: 시간이 지남에 따른 이벤트 구조 변경 관리</li><li><strong>대용량 데이터 처리</strong>: 수백만 개의 이벤트를 효율적으로 처리</li><li><strong>분산 시스템 복잡성</strong>: 여러 서비스 간 이벤트 순서 및 일관성 보장</li></ol><h3 id=운영적-도전>운영적 도전<a hidden class=anchor aria-hidden=true href=#운영적-도전>#</a></h3><ol><li><strong>모니터링 및 관찰성</strong>: 이벤트 흐름과 프로젝션 상태 추적</li><li><strong>데이터 아카이빙</strong>: 오래된 이벤트의 효율적 관리</li><li><strong>재해 복구</strong>: 이벤트 스토어 백업 및 복구 전략</li></ol><hr><h2 id=제4부-실무-적용>제4부: 실무 적용<a hidden class=anchor aria-hidden=true href=#제4부-실무-적용>#</a></h2><h2 id=분류-기준에-따른-종류-및-유형-1>분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-종류-및-유형-1>#</a></h2><table><thead><tr><th>분류 기준</th><th>유형</th><th>특징</th><th>사용 사례</th></tr></thead><tbody><tr><td><strong>저장 방식</strong></td><td>단일 스토어</td><td>모든 이벤트를 하나의 저장소에 보관</td><td>소규모 애플리케이션</td></tr><tr><td></td><td>분산 스토어</td><td>도메인별 또는 서비스별 분리 저장</td><td>마이크로서비스 아키텍처</td></tr><tr><td><strong>일관성 모델</strong></td><td>강한 일관성</td><td>즉시 일관성 보장</td><td>금융 시스템</td></tr><tr><td></td><td>최종 일관성</td><td>비동기적 일관성 달성</td><td>소셜 미디어, 전자상거래</td></tr><tr><td><strong>프로젝션 전략</strong></td><td>실시간 프로젝션</td><td>이벤트 발생 시 즉시 업데이트</td><td>실시간 대시보드</td></tr><tr><td></td><td>배치 프로젝션</td><td>주기적 일괄 업데이트</td><td>리포팅 시스템</td></tr></tbody></table><h2 id=실무-사용-예시-1>실무 사용 예시<a hidden class=anchor aria-hidden=true href=#실무-사용-예시-1>#</a></h2><table><thead><tr><th>도메인</th><th>목적</th><th>함께 사용되는 기술</th><th>효과</th></tr></thead><tbody><tr><td><strong>금융 시스템</strong></td><td>거래 추적 및 감사</td><td>CQRS, 블록체인</td><td>규제 준수, 사기 탐지</td></tr><tr><td><strong>전자상거래</strong></td><td>주문 상태 관리</td><td>마이크로서비스, Kafka</td><td>확장성, 주문 추적</td></tr><tr><td><strong>IoT 플랫폼</strong></td><td>센서 데이터 수집</td><td>시계열 DB, 스트림 처리</td><td>실시간 분석, 예측</td></tr><tr><td><strong>게임 시스템</strong></td><td>플레이어 행동 분석</td><td>NoSQL, 분석 플랫폼</td><td>개인화, 치트 탐지</td></tr><tr><td><strong>의료 시스템</strong></td><td>환자 기록 관리</td><td>HL7 FHIR, 프라이버시 보호</td><td>추적성, 의료 감사</td></tr></tbody></table><h2 id=활용-사례-1>활용 사례<a hidden class=anchor aria-hidden=true href=#활용-사례-1>#</a></h2><h3 id=netflix의-마이크로서비스-event-sourcing>Netflix의 마이크로서비스 Event Sourcing<a hidden class=anchor aria-hidden=true href=#netflix의-마이크로서비스-event-sourcing>#</a></h3><p><strong>시스템 구성</strong>:</p><ul><li><strong>이벤트 스토어</strong>: Apache Kafka를 중앙 이벤트 로그로 사용</li><li><strong>마이크로서비스</strong>: 각 서비스별 독립적인 이벤트 스트림</li><li><strong>프로젝션 서비스</strong>: 사용자 추천, 콘텐츠 메타데이터, 시청 이력 관리</li></ul><pre class=mermaid>graph TB
    subgraph &#34;Netflix Event Sourcing Architecture&#34;
        A[User Action] --&gt; B[Content Service]
        A --&gt; C[Recommendation Service]
        A --&gt; D[Billing Service]
        
        B --&gt; E[Kafka Event Stream]
        C --&gt; E
        D --&gt; E
        
        E --&gt; F[Content Projection]
        E --&gt; G[User Preference Projection]
        E --&gt; H[Analytics Projection]
        
        F --&gt; I[Content API]
        G --&gt; J[Recommendation API]
        H --&gt; K[Analytics Dashboard]
    end
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자 행동(시청, 평가, 검색) 이벤트 발생</li><li>각 마이크로서비스가 관련 이벤트를 Kafka에 발행</li><li>이벤트 기반 프로젝션이 실시간으로 업데이트</li><li>추천 시스템과 분석 시스템이 이벤트 스트림 소비</li></ol><p><strong>Event Sourcing의 역할</strong>:</p><ul><li><strong>사용자 경험 개인화</strong>: 시청 이력 기반 추천</li><li><strong>A/B 테스트</strong>: 사용자 행동 패턴 분석</li><li><strong>시스템 확장성</strong>: 서비스별 독립적 확장</li><li><strong>장애 복구</strong>: 이벤트 재생을 통한 상태 복원</li></ul><p><strong>기존 방식과의 차이점</strong>:</p><ul><li><strong>전통적 방식</strong>: 현재 상태만 저장, 히스토리 정보 부족</li><li><strong>Event Sourcing</strong>: 모든 사용자 행동 보존, 시간별 패턴 분석 가능</li><li><strong>확장성</strong>: 개별 서비스 스케일링 vs 모놀리식 스케일링</li><li><strong>장애 복구</strong>: 부분적 복구 vs 전체 시스템 재시작</li></ul><h2 id=구현-예시>구현 예시<a hidden class=anchor aria-hidden=true href=#구현-예시>#</a></h2><h3 id=javascript를-이용한-은행-계좌-event-sourcing>JavaScript를 이용한 은행 계좌 Event Sourcing<a hidden class=anchor aria-hidden=true href=#javascript를-이용한-은행-계좌-event-sourcing>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-67-1><a class=lnlinks href=#hl-67-1>  1</a>
</span><span class=lnt id=hl-67-2><a class=lnlinks href=#hl-67-2>  2</a>
</span><span class=lnt id=hl-67-3><a class=lnlinks href=#hl-67-3>  3</a>
</span><span class=lnt id=hl-67-4><a class=lnlinks href=#hl-67-4>  4</a>
</span><span class=lnt id=hl-67-5><a class=lnlinks href=#hl-67-5>  5</a>
</span><span class=lnt id=hl-67-6><a class=lnlinks href=#hl-67-6>  6</a>
</span><span class=lnt id=hl-67-7><a class=lnlinks href=#hl-67-7>  7</a>
</span><span class=lnt id=hl-67-8><a class=lnlinks href=#hl-67-8>  8</a>
</span><span class=lnt id=hl-67-9><a class=lnlinks href=#hl-67-9>  9</a>
</span><span class=lnt id=hl-67-10><a class=lnlinks href=#hl-67-10> 10</a>
</span><span class=lnt id=hl-67-11><a class=lnlinks href=#hl-67-11> 11</a>
</span><span class=lnt id=hl-67-12><a class=lnlinks href=#hl-67-12> 12</a>
</span><span class=lnt id=hl-67-13><a class=lnlinks href=#hl-67-13> 13</a>
</span><span class=lnt id=hl-67-14><a class=lnlinks href=#hl-67-14> 14</a>
</span><span class=lnt id=hl-67-15><a class=lnlinks href=#hl-67-15> 15</a>
</span><span class=lnt id=hl-67-16><a class=lnlinks href=#hl-67-16> 16</a>
</span><span class=lnt id=hl-67-17><a class=lnlinks href=#hl-67-17> 17</a>
</span><span class=lnt id=hl-67-18><a class=lnlinks href=#hl-67-18> 18</a>
</span><span class=lnt id=hl-67-19><a class=lnlinks href=#hl-67-19> 19</a>
</span><span class=lnt id=hl-67-20><a class=lnlinks href=#hl-67-20> 20</a>
</span><span class=lnt id=hl-67-21><a class=lnlinks href=#hl-67-21> 21</a>
</span><span class=lnt id=hl-67-22><a class=lnlinks href=#hl-67-22> 22</a>
</span><span class=lnt id=hl-67-23><a class=lnlinks href=#hl-67-23> 23</a>
</span><span class=lnt id=hl-67-24><a class=lnlinks href=#hl-67-24> 24</a>
</span><span class=lnt id=hl-67-25><a class=lnlinks href=#hl-67-25> 25</a>
</span><span class=lnt id=hl-67-26><a class=lnlinks href=#hl-67-26> 26</a>
</span><span class=lnt id=hl-67-27><a class=lnlinks href=#hl-67-27> 27</a>
</span><span class=lnt id=hl-67-28><a class=lnlinks href=#hl-67-28> 28</a>
</span><span class=lnt id=hl-67-29><a class=lnlinks href=#hl-67-29> 29</a>
</span><span class=lnt id=hl-67-30><a class=lnlinks href=#hl-67-30> 30</a>
</span><span class=lnt id=hl-67-31><a class=lnlinks href=#hl-67-31> 31</a>
</span><span class=lnt id=hl-67-32><a class=lnlinks href=#hl-67-32> 32</a>
</span><span class=lnt id=hl-67-33><a class=lnlinks href=#hl-67-33> 33</a>
</span><span class=lnt id=hl-67-34><a class=lnlinks href=#hl-67-34> 34</a>
</span><span class=lnt id=hl-67-35><a class=lnlinks href=#hl-67-35> 35</a>
</span><span class=lnt id=hl-67-36><a class=lnlinks href=#hl-67-36> 36</a>
</span><span class=lnt id=hl-67-37><a class=lnlinks href=#hl-67-37> 37</a>
</span><span class=lnt id=hl-67-38><a class=lnlinks href=#hl-67-38> 38</a>
</span><span class=lnt id=hl-67-39><a class=lnlinks href=#hl-67-39> 39</a>
</span><span class=lnt id=hl-67-40><a class=lnlinks href=#hl-67-40> 40</a>
</span><span class=lnt id=hl-67-41><a class=lnlinks href=#hl-67-41> 41</a>
</span><span class=lnt id=hl-67-42><a class=lnlinks href=#hl-67-42> 42</a>
</span><span class=lnt id=hl-67-43><a class=lnlinks href=#hl-67-43> 43</a>
</span><span class=lnt id=hl-67-44><a class=lnlinks href=#hl-67-44> 44</a>
</span><span class=lnt id=hl-67-45><a class=lnlinks href=#hl-67-45> 45</a>
</span><span class=lnt id=hl-67-46><a class=lnlinks href=#hl-67-46> 46</a>
</span><span class=lnt id=hl-67-47><a class=lnlinks href=#hl-67-47> 47</a>
</span><span class=lnt id=hl-67-48><a class=lnlinks href=#hl-67-48> 48</a>
</span><span class=lnt id=hl-67-49><a class=lnlinks href=#hl-67-49> 49</a>
</span><span class=lnt id=hl-67-50><a class=lnlinks href=#hl-67-50> 50</a>
</span><span class=lnt id=hl-67-51><a class=lnlinks href=#hl-67-51> 51</a>
</span><span class=lnt id=hl-67-52><a class=lnlinks href=#hl-67-52> 52</a>
</span><span class=lnt id=hl-67-53><a class=lnlinks href=#hl-67-53> 53</a>
</span><span class=lnt id=hl-67-54><a class=lnlinks href=#hl-67-54> 54</a>
</span><span class=lnt id=hl-67-55><a class=lnlinks href=#hl-67-55> 55</a>
</span><span class=lnt id=hl-67-56><a class=lnlinks href=#hl-67-56> 56</a>
</span><span class=lnt id=hl-67-57><a class=lnlinks href=#hl-67-57> 57</a>
</span><span class=lnt id=hl-67-58><a class=lnlinks href=#hl-67-58> 58</a>
</span><span class=lnt id=hl-67-59><a class=lnlinks href=#hl-67-59> 59</a>
</span><span class=lnt id=hl-67-60><a class=lnlinks href=#hl-67-60> 60</a>
</span><span class=lnt id=hl-67-61><a class=lnlinks href=#hl-67-61> 61</a>
</span><span class=lnt id=hl-67-62><a class=lnlinks href=#hl-67-62> 62</a>
</span><span class=lnt id=hl-67-63><a class=lnlinks href=#hl-67-63> 63</a>
</span><span class=lnt id=hl-67-64><a class=lnlinks href=#hl-67-64> 64</a>
</span><span class=lnt id=hl-67-65><a class=lnlinks href=#hl-67-65> 65</a>
</span><span class=lnt id=hl-67-66><a class=lnlinks href=#hl-67-66> 66</a>
</span><span class=lnt id=hl-67-67><a class=lnlinks href=#hl-67-67> 67</a>
</span><span class=lnt id=hl-67-68><a class=lnlinks href=#hl-67-68> 68</a>
</span><span class=lnt id=hl-67-69><a class=lnlinks href=#hl-67-69> 69</a>
</span><span class=lnt id=hl-67-70><a class=lnlinks href=#hl-67-70> 70</a>
</span><span class=lnt id=hl-67-71><a class=lnlinks href=#hl-67-71> 71</a>
</span><span class=lnt id=hl-67-72><a class=lnlinks href=#hl-67-72> 72</a>
</span><span class=lnt id=hl-67-73><a class=lnlinks href=#hl-67-73> 73</a>
</span><span class=lnt id=hl-67-74><a class=lnlinks href=#hl-67-74> 74</a>
</span><span class=lnt id=hl-67-75><a class=lnlinks href=#hl-67-75> 75</a>
</span><span class=lnt id=hl-67-76><a class=lnlinks href=#hl-67-76> 76</a>
</span><span class=lnt id=hl-67-77><a class=lnlinks href=#hl-67-77> 77</a>
</span><span class=lnt id=hl-67-78><a class=lnlinks href=#hl-67-78> 78</a>
</span><span class=lnt id=hl-67-79><a class=lnlinks href=#hl-67-79> 79</a>
</span><span class=lnt id=hl-67-80><a class=lnlinks href=#hl-67-80> 80</a>
</span><span class=lnt id=hl-67-81><a class=lnlinks href=#hl-67-81> 81</a>
</span><span class=lnt id=hl-67-82><a class=lnlinks href=#hl-67-82> 82</a>
</span><span class=lnt id=hl-67-83><a class=lnlinks href=#hl-67-83> 83</a>
</span><span class=lnt id=hl-67-84><a class=lnlinks href=#hl-67-84> 84</a>
</span><span class=lnt id=hl-67-85><a class=lnlinks href=#hl-67-85> 85</a>
</span><span class=lnt id=hl-67-86><a class=lnlinks href=#hl-67-86> 86</a>
</span><span class=lnt id=hl-67-87><a class=lnlinks href=#hl-67-87> 87</a>
</span><span class=lnt id=hl-67-88><a class=lnlinks href=#hl-67-88> 88</a>
</span><span class=lnt id=hl-67-89><a class=lnlinks href=#hl-67-89> 89</a>
</span><span class=lnt id=hl-67-90><a class=lnlinks href=#hl-67-90> 90</a>
</span><span class=lnt id=hl-67-91><a class=lnlinks href=#hl-67-91> 91</a>
</span><span class=lnt id=hl-67-92><a class=lnlinks href=#hl-67-92> 92</a>
</span><span class=lnt id=hl-67-93><a class=lnlinks href=#hl-67-93> 93</a>
</span><span class=lnt id=hl-67-94><a class=lnlinks href=#hl-67-94> 94</a>
</span><span class=lnt id=hl-67-95><a class=lnlinks href=#hl-67-95> 95</a>
</span><span class=lnt id=hl-67-96><a class=lnlinks href=#hl-67-96> 96</a>
</span><span class=lnt id=hl-67-97><a class=lnlinks href=#hl-67-97> 97</a>
</span><span class=lnt id=hl-67-98><a class=lnlinks href=#hl-67-98> 98</a>
</span><span class=lnt id=hl-67-99><a class=lnlinks href=#hl-67-99> 99</a>
</span><span class=lnt id=hl-67-100><a class=lnlinks href=#hl-67-100>100</a>
</span><span class=lnt id=hl-67-101><a class=lnlinks href=#hl-67-101>101</a>
</span><span class=lnt id=hl-67-102><a class=lnlinks href=#hl-67-102>102</a>
</span><span class=lnt id=hl-67-103><a class=lnlinks href=#hl-67-103>103</a>
</span><span class=lnt id=hl-67-104><a class=lnlinks href=#hl-67-104>104</a>
</span><span class=lnt id=hl-67-105><a class=lnlinks href=#hl-67-105>105</a>
</span><span class=lnt id=hl-67-106><a class=lnlinks href=#hl-67-106>106</a>
</span><span class=lnt id=hl-67-107><a class=lnlinks href=#hl-67-107>107</a>
</span><span class=lnt id=hl-67-108><a class=lnlinks href=#hl-67-108>108</a>
</span><span class=lnt id=hl-67-109><a class=lnlinks href=#hl-67-109>109</a>
</span><span class=lnt id=hl-67-110><a class=lnlinks href=#hl-67-110>110</a>
</span><span class=lnt id=hl-67-111><a class=lnlinks href=#hl-67-111>111</a>
</span><span class=lnt id=hl-67-112><a class=lnlinks href=#hl-67-112>112</a>
</span><span class=lnt id=hl-67-113><a class=lnlinks href=#hl-67-113>113</a>
</span><span class=lnt id=hl-67-114><a class=lnlinks href=#hl-67-114>114</a>
</span><span class=lnt id=hl-67-115><a class=lnlinks href=#hl-67-115>115</a>
</span><span class=lnt id=hl-67-116><a class=lnlinks href=#hl-67-116>116</a>
</span><span class=lnt id=hl-67-117><a class=lnlinks href=#hl-67-117>117</a>
</span><span class=lnt id=hl-67-118><a class=lnlinks href=#hl-67-118>118</a>
</span><span class=lnt id=hl-67-119><a class=lnlinks href=#hl-67-119>119</a>
</span><span class=lnt id=hl-67-120><a class=lnlinks href=#hl-67-120>120</a>
</span><span class=lnt id=hl-67-121><a class=lnlinks href=#hl-67-121>121</a>
</span><span class=lnt id=hl-67-122><a class=lnlinks href=#hl-67-122>122</a>
</span><span class=lnt id=hl-67-123><a class=lnlinks href=#hl-67-123>123</a>
</span><span class=lnt id=hl-67-124><a class=lnlinks href=#hl-67-124>124</a>
</span><span class=lnt id=hl-67-125><a class=lnlinks href=#hl-67-125>125</a>
</span><span class=lnt id=hl-67-126><a class=lnlinks href=#hl-67-126>126</a>
</span><span class=lnt id=hl-67-127><a class=lnlinks href=#hl-67-127>127</a>
</span><span class=lnt id=hl-67-128><a class=lnlinks href=#hl-67-128>128</a>
</span><span class=lnt id=hl-67-129><a class=lnlinks href=#hl-67-129>129</a>
</span><span class=lnt id=hl-67-130><a class=lnlinks href=#hl-67-130>130</a>
</span><span class=lnt id=hl-67-131><a class=lnlinks href=#hl-67-131>131</a>
</span><span class=lnt id=hl-67-132><a class=lnlinks href=#hl-67-132>132</a>
</span><span class=lnt id=hl-67-133><a class=lnlinks href=#hl-67-133>133</a>
</span><span class=lnt id=hl-67-134><a class=lnlinks href=#hl-67-134>134</a>
</span><span class=lnt id=hl-67-135><a class=lnlinks href=#hl-67-135>135</a>
</span><span class=lnt id=hl-67-136><a class=lnlinks href=#hl-67-136>136</a>
</span><span class=lnt id=hl-67-137><a class=lnlinks href=#hl-67-137>137</a>
</span><span class=lnt id=hl-67-138><a class=lnlinks href=#hl-67-138>138</a>
</span><span class=lnt id=hl-67-139><a class=lnlinks href=#hl-67-139>139</a>
</span><span class=lnt id=hl-67-140><a class=lnlinks href=#hl-67-140>140</a>
</span><span class=lnt id=hl-67-141><a class=lnlinks href=#hl-67-141>141</a>
</span><span class=lnt id=hl-67-142><a class=lnlinks href=#hl-67-142>142</a>
</span><span class=lnt id=hl-67-143><a class=lnlinks href=#hl-67-143>143</a>
</span><span class=lnt id=hl-67-144><a class=lnlinks href=#hl-67-144>144</a>
</span><span class=lnt id=hl-67-145><a class=lnlinks href=#hl-67-145>145</a>
</span><span class=lnt id=hl-67-146><a class=lnlinks href=#hl-67-146>146</a>
</span><span class=lnt id=hl-67-147><a class=lnlinks href=#hl-67-147>147</a>
</span><span class=lnt id=hl-67-148><a class=lnlinks href=#hl-67-148>148</a>
</span><span class=lnt id=hl-67-149><a class=lnlinks href=#hl-67-149>149</a>
</span><span class=lnt id=hl-67-150><a class=lnlinks href=#hl-67-150>150</a>
</span><span class=lnt id=hl-67-151><a class=lnlinks href=#hl-67-151>151</a>
</span><span class=lnt id=hl-67-152><a class=lnlinks href=#hl-67-152>152</a>
</span><span class=lnt id=hl-67-153><a class=lnlinks href=#hl-67-153>153</a>
</span><span class=lnt id=hl-67-154><a class=lnlinks href=#hl-67-154>154</a>
</span><span class=lnt id=hl-67-155><a class=lnlinks href=#hl-67-155>155</a>
</span><span class=lnt id=hl-67-156><a class=lnlinks href=#hl-67-156>156</a>
</span><span class=lnt id=hl-67-157><a class=lnlinks href=#hl-67-157>157</a>
</span><span class=lnt id=hl-67-158><a class=lnlinks href=#hl-67-158>158</a>
</span><span class=lnt id=hl-67-159><a class=lnlinks href=#hl-67-159>159</a>
</span><span class=lnt id=hl-67-160><a class=lnlinks href=#hl-67-160>160</a>
</span><span class=lnt id=hl-67-161><a class=lnlinks href=#hl-67-161>161</a>
</span><span class=lnt id=hl-67-162><a class=lnlinks href=#hl-67-162>162</a>
</span><span class=lnt id=hl-67-163><a class=lnlinks href=#hl-67-163>163</a>
</span><span class=lnt id=hl-67-164><a class=lnlinks href=#hl-67-164>164</a>
</span><span class=lnt id=hl-67-165><a class=lnlinks href=#hl-67-165>165</a>
</span><span class=lnt id=hl-67-166><a class=lnlinks href=#hl-67-166>166</a>
</span><span class=lnt id=hl-67-167><a class=lnlinks href=#hl-67-167>167</a>
</span><span class=lnt id=hl-67-168><a class=lnlinks href=#hl-67-168>168</a>
</span><span class=lnt id=hl-67-169><a class=lnlinks href=#hl-67-169>169</a>
</span><span class=lnt id=hl-67-170><a class=lnlinks href=#hl-67-170>170</a>
</span><span class=lnt id=hl-67-171><a class=lnlinks href=#hl-67-171>171</a>
</span><span class=lnt id=hl-67-172><a class=lnlinks href=#hl-67-172>172</a>
</span><span class=lnt id=hl-67-173><a class=lnlinks href=#hl-67-173>173</a>
</span><span class=lnt id=hl-67-174><a class=lnlinks href=#hl-67-174>174</a>
</span><span class=lnt id=hl-67-175><a class=lnlinks href=#hl-67-175>175</a>
</span><span class=lnt id=hl-67-176><a class=lnlinks href=#hl-67-176>176</a>
</span><span class=lnt id=hl-67-177><a class=lnlinks href=#hl-67-177>177</a>
</span><span class=lnt id=hl-67-178><a class=lnlinks href=#hl-67-178>178</a>
</span><span class=lnt id=hl-67-179><a class=lnlinks href=#hl-67-179>179</a>
</span><span class=lnt id=hl-67-180><a class=lnlinks href=#hl-67-180>180</a>
</span><span class=lnt id=hl-67-181><a class=lnlinks href=#hl-67-181>181</a>
</span><span class=lnt id=hl-67-182><a class=lnlinks href=#hl-67-182>182</a>
</span><span class=lnt id=hl-67-183><a class=lnlinks href=#hl-67-183>183</a>
</span><span class=lnt id=hl-67-184><a class=lnlinks href=#hl-67-184>184</a>
</span><span class=lnt id=hl-67-185><a class=lnlinks href=#hl-67-185>185</a>
</span><span class=lnt id=hl-67-186><a class=lnlinks href=#hl-67-186>186</a>
</span><span class=lnt id=hl-67-187><a class=lnlinks href=#hl-67-187>187</a>
</span><span class=lnt id=hl-67-188><a class=lnlinks href=#hl-67-188>188</a>
</span><span class=lnt id=hl-67-189><a class=lnlinks href=#hl-67-189>189</a>
</span><span class=lnt id=hl-67-190><a class=lnlinks href=#hl-67-190>190</a>
</span><span class=lnt id=hl-67-191><a class=lnlinks href=#hl-67-191>191</a>
</span><span class=lnt id=hl-67-192><a class=lnlinks href=#hl-67-192>192</a>
</span><span class=lnt id=hl-67-193><a class=lnlinks href=#hl-67-193>193</a>
</span><span class=lnt id=hl-67-194><a class=lnlinks href=#hl-67-194>194</a>
</span><span class=lnt id=hl-67-195><a class=lnlinks href=#hl-67-195>195</a>
</span><span class=lnt id=hl-67-196><a class=lnlinks href=#hl-67-196>196</a>
</span><span class=lnt id=hl-67-197><a class=lnlinks href=#hl-67-197>197</a>
</span><span class=lnt id=hl-67-198><a class=lnlinks href=#hl-67-198>198</a>
</span><span class=lnt id=hl-67-199><a class=lnlinks href=#hl-67-199>199</a>
</span><span class=lnt id=hl-67-200><a class=lnlinks href=#hl-67-200>200</a>
</span><span class=lnt id=hl-67-201><a class=lnlinks href=#hl-67-201>201</a>
</span><span class=lnt id=hl-67-202><a class=lnlinks href=#hl-67-202>202</a>
</span><span class=lnt id=hl-67-203><a class=lnlinks href=#hl-67-203>203</a>
</span><span class=lnt id=hl-67-204><a class=lnlinks href=#hl-67-204>204</a>
</span><span class=lnt id=hl-67-205><a class=lnlinks href=#hl-67-205>205</a>
</span><span class=lnt id=hl-67-206><a class=lnlinks href=#hl-67-206>206</a>
</span><span class=lnt id=hl-67-207><a class=lnlinks href=#hl-67-207>207</a>
</span><span class=lnt id=hl-67-208><a class=lnlinks href=#hl-67-208>208</a>
</span><span class=lnt id=hl-67-209><a class=lnlinks href=#hl-67-209>209</a>
</span><span class=lnt id=hl-67-210><a class=lnlinks href=#hl-67-210>210</a>
</span><span class=lnt id=hl-67-211><a class=lnlinks href=#hl-67-211>211</a>
</span><span class=lnt id=hl-67-212><a class=lnlinks href=#hl-67-212>212</a>
</span><span class=lnt id=hl-67-213><a class=lnlinks href=#hl-67-213>213</a>
</span><span class=lnt id=hl-67-214><a class=lnlinks href=#hl-67-214>214</a>
</span><span class=lnt id=hl-67-215><a class=lnlinks href=#hl-67-215>215</a>
</span><span class=lnt id=hl-67-216><a class=lnlinks href=#hl-67-216>216</a>
</span><span class=lnt id=hl-67-217><a class=lnlinks href=#hl-67-217>217</a>
</span><span class=lnt id=hl-67-218><a class=lnlinks href=#hl-67-218>218</a>
</span><span class=lnt id=hl-67-219><a class=lnlinks href=#hl-67-219>219</a>
</span><span class=lnt id=hl-67-220><a class=lnlinks href=#hl-67-220>220</a>
</span><span class=lnt id=hl-67-221><a class=lnlinks href=#hl-67-221>221</a>
</span><span class=lnt id=hl-67-222><a class=lnlinks href=#hl-67-222>222</a>
</span><span class=lnt id=hl-67-223><a class=lnlinks href=#hl-67-223>223</a>
</span><span class=lnt id=hl-67-224><a class=lnlinks href=#hl-67-224>224</a>
</span><span class=lnt id=hl-67-225><a class=lnlinks href=#hl-67-225>225</a>
</span><span class=lnt id=hl-67-226><a class=lnlinks href=#hl-67-226>226</a>
</span><span class=lnt id=hl-67-227><a class=lnlinks href=#hl-67-227>227</a>
</span><span class=lnt id=hl-67-228><a class=lnlinks href=#hl-67-228>228</a>
</span><span class=lnt id=hl-67-229><a class=lnlinks href=#hl-67-229>229</a>
</span><span class=lnt id=hl-67-230><a class=lnlinks href=#hl-67-230>230</a>
</span><span class=lnt id=hl-67-231><a class=lnlinks href=#hl-67-231>231</a>
</span><span class=lnt id=hl-67-232><a class=lnlinks href=#hl-67-232>232</a>
</span><span class=lnt id=hl-67-233><a class=lnlinks href=#hl-67-233>233</a>
</span><span class=lnt id=hl-67-234><a class=lnlinks href=#hl-67-234>234</a>
</span><span class=lnt id=hl-67-235><a class=lnlinks href=#hl-67-235>235</a>
</span><span class=lnt id=hl-67-236><a class=lnlinks href=#hl-67-236>236</a>
</span><span class=lnt id=hl-67-237><a class=lnlinks href=#hl-67-237>237</a>
</span><span class=lnt id=hl-67-238><a class=lnlinks href=#hl-67-238>238</a>
</span><span class=lnt id=hl-67-239><a class=lnlinks href=#hl-67-239>239</a>
</span><span class=lnt id=hl-67-240><a class=lnlinks href=#hl-67-240>240</a>
</span><span class=lnt id=hl-67-241><a class=lnlinks href=#hl-67-241>241</a>
</span><span class=lnt id=hl-67-242><a class=lnlinks href=#hl-67-242>242</a>
</span><span class=lnt id=hl-67-243><a class=lnlinks href=#hl-67-243>243</a>
</span><span class=lnt id=hl-67-244><a class=lnlinks href=#hl-67-244>244</a>
</span><span class=lnt id=hl-67-245><a class=lnlinks href=#hl-67-245>245</a>
</span><span class=lnt id=hl-67-246><a class=lnlinks href=#hl-67-246>246</a>
</span><span class=lnt id=hl-67-247><a class=lnlinks href=#hl-67-247>247</a>
</span><span class=lnt id=hl-67-248><a class=lnlinks href=#hl-67-248>248</a>
</span><span class=lnt id=hl-67-249><a class=lnlinks href=#hl-67-249>249</a>
</span><span class=lnt id=hl-67-250><a class=lnlinks href=#hl-67-250>250</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 이벤트 정의
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>AccountCreated</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>initialBalance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>initialBalance</span> <span class=o>=</span> <span class=nx>initialBalance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>timestamp</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;AccountCreated&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MoneyDeposited</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>amount</span> <span class=o>=</span> <span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>timestamp</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;MoneyDeposited&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MoneyWithdrawn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>amount</span> <span class=o>=</span> <span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>timestamp</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;MoneyWithdrawn&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 애그리게이트 루트
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>BankAccount</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>uncommittedEvents</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>version</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 계좌 생성 명령 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>static</span> <span class=nx>create</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>initialBalance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>account</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BankAccount</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>account</span><span class=p>.</span><span class=nx>applyEvent</span><span class=p>(</span><span class=k>new</span> <span class=nx>AccountCreated</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>initialBalance</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>account</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 입금 명령 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deposit</span><span class=p>(</span><span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>amount</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;입금액은 0보다 커야 합니다&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>applyEvent</span><span class=p>(</span><span class=k>new</span> <span class=nx>MoneyDeposited</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 출금 명령 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>withdraw</span><span class=p>(</span><span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>amount</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;출금액은 0보다 커야 합니다&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>&lt;</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;잔액이 부족합니다&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>applyEvent</span><span class=p>(</span><span class=k>new</span> <span class=nx>MoneyWithdrawn</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 이벤트 적용
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>applyEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s1>&#39;AccountCreated&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>initialBalance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s1>&#39;MoneyDeposited&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>+=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s1>&#39;MoneyWithdrawn&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>-=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>version</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 이벤트 스트림에서 상태 재구성
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>static</span> <span class=nx>fromHistory</span><span class=p>(</span><span class=nx>events</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>account</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BankAccount</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>events</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>account</span><span class=p>.</span><span class=nx>applyEventFromHistory</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>account</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>applyEventFromHistory</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s1>&#39;AccountCreated&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>accountId</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>accountId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>initialBalance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s1>&#39;MoneyDeposited&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>+=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s1>&#39;MoneyWithdrawn&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>balance</span> <span class=o>-=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>version</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 저장되지 않은 이벤트 반환
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>getUncommittedEvents</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[...</span><span class=k>this</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 이벤트 커밋 표시
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>markEventsAsCommitted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>uncommittedEvents</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 이벤트 스토어
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>EventStore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>events</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>();</span> <span class=c1>// accountId -&gt; events[]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 이벤트 저장
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>saveEvents</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>events</span><span class=p>,</span> <span class=nx>expectedVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>accountId</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=p>[]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>existingEvents</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>accountId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 동시성 제어 - 낙관적 잠금
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>existingEvents</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=nx>expectedVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`동시성 충돌: 예상 버전 </span><span class=si>${</span><span class=nx>expectedVersion</span><span class=si>}</span><span class=sb>, 실제 버전 </span><span class=si>${</span><span class=nx>existingEvents</span><span class=p>.</span><span class=nx>length</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 이벤트 추가
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>existingEvents</span><span class=p>.</span><span class=nx>push</span><span class=p>(...</span><span class=nx>events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 이벤트 로드
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>getEvents</span><span class=p>(</span><span class=nx>accountId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>accountId</span><span class=p>)</span> <span class=o>||</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 특정 버전까지의 이벤트 로드
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>getEventsUpToVersion</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>version</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>events</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getEvents</span><span class=p>(</span><span class=nx>accountId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>events</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>version</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 리포지터리
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>BankAccountRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>eventStore</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>eventStore</span> <span class=o>=</span> <span class=nx>eventStore</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 계좌 로드
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>load</span><span class=p>(</span><span class=nx>accountId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>events</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>eventStore</span><span class=p>.</span><span class=nx>getEvents</span><span class=p>(</span><span class=nx>accountId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>events</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>BankAccount</span><span class=p>.</span><span class=nx>fromHistory</span><span class=p>(</span><span class=nx>events</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 계좌 저장
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>save</span><span class=p>(</span><span class=nx>account</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>uncommittedEvents</span> <span class=o>=</span> <span class=nx>account</span><span class=p>.</span><span class=nx>getUncommittedEvents</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>uncommittedEvents</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>expectedVersion</span> <span class=o>=</span> <span class=nx>account</span><span class=p>.</span><span class=nx>version</span> <span class=o>-</span> <span class=nx>uncommittedEvents</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>eventStore</span><span class=p>.</span><span class=nx>saveEvents</span><span class=p>(</span><span class=nx>account</span><span class=p>.</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>uncommittedEvents</span><span class=p>,</span> <span class=nx>expectedVersion</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>account</span><span class=p>.</span><span class=nx>markEventsAsCommitted</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 명령 처리기
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>BankAccountCommandHandler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>repository</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>repository</span> <span class=o>=</span> <span class=nx>repository</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 계좌 생성 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>createAccount</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>initialBalance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>existingAccount</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=nx>accountId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>existingAccount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;계좌가 이미 존재합니다&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>account</span> <span class=o>=</span> <span class=nx>BankAccount</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>initialBalance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nx>save</span><span class=p>(</span><span class=nx>account</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>account</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 입금 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deposit</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>account</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=nx>accountId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>account</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;계좌를 찾을 수 없습니다&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>account</span><span class=p>.</span><span class=nx>deposit</span><span class=p>(</span><span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nx>save</span><span class=p>(</span><span class=nx>account</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>account</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 출금 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>withdraw</span><span class=p>(</span><span class=nx>accountId</span><span class=p>,</span> <span class=nx>amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>account</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=nx>accountId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>account</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;계좌를 찾을 수 없습니다&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>account</span><span class=p>.</span><span class=nx>withdraw</span><span class=p>(</span><span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nx>save</span><span class=p>(</span><span class=nx>account</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>account</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 사용 예시
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>eventStore</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>EventStore</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>repository</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BankAccountRepository</span><span class=p>(</span><span class=nx>eventStore</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>commandHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BankAccountCommandHandler</span><span class=p>(</span><span class=nx>repository</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 계좌 생성
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>account1</span> <span class=o>=</span> <span class=nx>commandHandler</span><span class=p>.</span><span class=nx>createAccount</span><span class=p>(</span><span class=s1>&#39;ACC-001&#39;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`계좌 생성: </span><span class=si>${</span><span class=nx>account1</span><span class=p>.</span><span class=nx>accountId</span><span class=si>}</span><span class=sb>, 잔액: </span><span class=si>${</span><span class=nx>account1</span><span class=p>.</span><span class=nx>balance</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 입금
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>commandHandler</span><span class=p>.</span><span class=nx>deposit</span><span class=p>(</span><span class=s1>&#39;ACC-001&#39;</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;500 입금 완료&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 출금
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>commandHandler</span><span class=p>.</span><span class=nx>withdraw</span><span class=p>(</span><span class=s1>&#39;ACC-001&#39;</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;200 출금 완료&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 현재 상태 조회
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>currentAccount</span> <span class=o>=</span> <span class=nx>repository</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=s1>&#39;ACC-001&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`현재 잔액: </span><span class=si>${</span><span class=nx>currentAccount</span><span class=p>.</span><span class=nx>balance</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 이벤트 히스토리 조회
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>events</span> <span class=o>=</span> <span class=nx>eventStore</span><span class=p>.</span><span class=nx>getEvents</span><span class=p>(</span><span class=s1>&#39;ACC-001&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;이벤트 히스토리:&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>events</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>event</span><span class=p>,</span> <span class=nx>index</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>index</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=sb>. </span><span class=si>${</span><span class=nx>event</span><span class=p>.</span><span class=nx>type</span><span class=si>}</span><span class=sb> - </span><span class=si>${</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점-1>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점-1>#</a></h2><table><thead><tr><th>구분</th><th>고려사항</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>도메인 설계</strong></td><td>적절한 애그리게이트 경계 설정</td><td>비즈니스 일관성 경계에 따라 애그리게이트 크기 결정</td></tr><tr><td><strong>이벤트 설계</strong></td><td>이벤트 스키마의 미래 호환성</td><td>이벤트에 버전 정보 포함, 선택적 필드 사용</td></tr><tr><td><strong>성능 관리</strong></td><td>대용량 이벤트 스트림 처리</td><td>스냅샷 구현, 이벤트 아카이빙 전략 수립</td></tr><tr><td><strong>일관성 관리</strong></td><td>최종 일관성 수용</td><td>비즈니스 요구사항에 맞는 일관성 수준 정의</td></tr><tr><td><strong>모니터링</strong></td><td>이벤트 처리 상태 추적</td><td>프로젝션 지연 모니터링, 실패 이벤트 재처리</td></tr><tr><td><strong>보안</strong></td><td>민감한 데이터 처리</td><td>이벤트 암호화, 개인정보 익명화</td></tr><tr><td><strong>테스트</strong></td><td>시간 기반 테스트 복잡성</td><td>시간 추상화, 이벤트 시나리오 기반 테스트</td></tr></tbody></table><h2 id=최적화하기-위한-고려사항-및-주의할-점-1>최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#최적화하기-위한-고려사항-및-주의할-점-1>#</a></h2><table><thead><tr><th>구분</th><th>최적화 방법</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>저장소 최적화</strong></td><td>이벤트 스토어 파티셔닝</td><td>애그리게이트 ID 기반 샤딩</td></tr><tr><td><strong>읽기 성능</strong></td><td>프로젝션 캐싱</td><td>Redis 등을 활용한 자주 조회되는 프로젝션 캐싱</td></tr><tr><td><strong>쓰기 성능</strong></td><td>배치 이벤트 처리</td><td>여러 이벤트를 배치로 처리하여 I/O 최적화</td></tr><tr><td><strong>네트워크 최적화</strong></td><td>이벤트 압축</td><td>큰 이벤트 페이로드 압축 전송</td></tr><tr><td><strong>메모리 관리</strong></td><td>애그리게이트 캐싱</td><td>자주 접근되는 애그리게이트 메모리 캐싱</td></tr><tr><td><strong>동시성 최적화</strong></td><td>애그리게이트별 락</td><td>세밀한 단위의 동시성 제어</td></tr><tr><td><strong>이벤트 압축</strong></td><td>중복 이벤트 제거</td><td>의미없는 중간 상태 이벤트 압축</td></tr></tbody></table><h2 id=기타-사항-1>기타 사항<a hidden class=anchor aria-hidden=true href=#기타-사항-1>#</a></h2><h3 id=event-sourcing과-gdpr-준수>Event Sourcing과 GDPR 준수<a hidden class=anchor aria-hidden=true href=#event-sourcing과-gdpr-준수>#</a></h3><ul><li><strong>개인정보 삭제 요구</strong>: 이벤트의 불변성과 충돌하는 GDPR의 삭제권</li><li><strong>해결 방안</strong>:<ul><li>암호화된 이벤트 저장 후 키 삭제</li><li>개인정보 분리 저장</li><li>의사화(Pseudonymization) 적용</li></ul></li></ul><h3 id=이벤트-스키마-진화-전략>이벤트 스키마 진화 전략<a hidden class=anchor aria-hidden=true href=#이벤트-스키마-진화-전략>#</a></h3><ul><li><strong>전진 호환성</strong>: 새로운 필드 추가 시 기존 시스템 호환성 유지</li><li><strong>후진 호환성</strong>: 이전 버전 이벤트 처리 가능성</li><li><strong>업캐스팅</strong>: 오래된 이벤트를 새로운 스키마로 변환</li><li><strong>다운캐스팅</strong>: 새로운 이벤트를 이전 스키마로 변환</li></ul><h3 id=분산-환경에서의-고려사항>분산 환경에서의 고려사항<a hidden class=anchor aria-hidden=true href=#분산-환경에서의-고려사항>#</a></h3><ul><li><strong>이벤트 순서</strong>: 분산 환경에서 전역 순서 보장의 어려움</li><li><strong>시계 동기화</strong>: 타임스탬프 기반 순서 결정 시 시계 편차 문제</li><li><strong>네트워크 분할</strong>: CAP 정리에 따른 일관성과 가용성 트레이드오프</li></ul><hr><h2 id=주제와-관련하여-주목할-내용>주제와 관련하여 주목할 내용<a hidden class=anchor aria-hidden=true href=#주제와-관련하여-주목할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>패턴</strong></td><td>아키텍처 패턴</td><td>CQRS</td><td>Event Sourcing과 함께 사용되어 읽기/쓰기 분리</td></tr><tr><td></td><td></td><td>Saga 패턴</td><td>분산 트랜잭션에서 Event Sourcing 활용</td></tr><tr><td></td><td></td><td>Outbox 패턴</td><td>데이터베이스와 메시지 발행의 원자성 보장</td></tr><tr><td><strong>기술</strong></td><td>메시지 브로커</td><td>Apache Kafka</td><td>이벤트 스트리밍과 저장소 역할</td></tr><tr><td></td><td></td><td>RabbitMQ</td><td>이벤트 발행/구독 처리</td></tr><tr><td></td><td></td><td>EventStore DB</td><td>전용 이벤트 저장소</td></tr><tr><td><strong>개념</strong></td><td>도메인 설계</td><td>Aggregate</td><td>DDD의 일관성 경계와 Event Sourcing 통합</td></tr><tr><td></td><td></td><td>Domain Events</td><td>비즈니스 이벤트의 표현</td></tr><tr><td></td><td></td><td>Bounded Context</td><td>마이크로서비스와 이벤트 경계</td></tr><tr><td><strong>도구</strong></td><td>프레임워크</td><td>Axon Framework</td><td>Java 기반 CQRS/ES 프레임워크</td></tr><tr><td></td><td></td><td>EventStore</td><td>전용 이벤트 데이터베이스</td></tr><tr><td></td><td></td><td>Marten</td><td>.NET용 Event Sourcing 라이브러리</td></tr></tbody></table><h2 id=주제와-관련하여-반드시-학습해야할-내용>주제와 관련하여 반드시 학습해야할 내용<a hidden class=anchor aria-hidden=true href=#주제와-관련하여-반드시-학습해야할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>기초 개념</strong></td><td>Event Sourcing</td><td>기본 원리</td><td>이벤트 기반 상태 관리의 핵심 개념</td></tr><tr><td></td><td>CQRS</td><td>명령/쿼리 분리</td><td>읽기와 쓰기 모델의 분리</td></tr><tr><td></td><td>Domain Events</td><td>도메인 이벤트</td><td>비즈니스 의미가 있는 이벤트 설계</td></tr><tr><td><strong>구현 기술</strong></td><td>Event Store</td><td>이벤트 저장소</td><td>이벤트 지속화 메커니즘</td></tr><tr><td></td><td>Projections</td><td>프로젝션</td><td>이벤트에서 읽기 모델 생성</td></tr><tr><td></td><td>Snapshots</td><td>스냅샷</td><td>성능 최적화 기법</td></tr><tr><td><strong>설계 패턴</strong></td><td>Aggregate Design</td><td>애그리게이트 설계</td><td>적절한 경계 설정</td></tr><tr><td></td><td>Event Schema</td><td>이벤트 스키마</td><td>진화 가능한 이벤트 구조</td></tr><tr><td></td><td>Concurrency Control</td><td>동시성 제어</td><td>낙관적 잠금과 버전 관리</td></tr><tr><td><strong>운영 관리</strong></td><td>Monitoring</td><td>모니터링</td><td>이벤트 처리 상태 추적</td></tr><tr><td></td><td>Error Handling</td><td>오류 처리</td><td>실패한 이벤트 처리 전략</td></tr><tr><td></td><td>Data Migration</td><td>데이터 마이그레이션</td><td>이벤트 스키마 변경 관리</td></tr></tbody></table><hr><h2 id=용어-정리-5>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리-5>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td><strong>핵심 개념</strong></td><td>Event Store</td><td>이벤트가 지속화되는 추가 전용 데이터베이스로 시스템 기록의 권위 있는 소스</td></tr><tr><td></td><td>Aggregate Root</td><td>도메인 주도 설계에서 애그리게이트의 진입점 역할을 하는 엔터티</td></tr><tr><td></td><td>Projection</td><td>이벤트 스트림에서 파생된 읽기 전용 뷰 또는 상태 표현</td></tr><tr><td></td><td>Command Handler</td><td>비즈니스 명령을 처리하고 이벤트를 생성하는 컴포넌트</td></tr><tr><td><strong>기술 용어</strong></td><td>Event Replay</td><td>저장된 이벤트를 순서대로 재생하여 상태를 재구성하는 과정</td></tr><tr><td></td><td>Snapshot</td><td>특정 시점의 애그리게이트 상태를 저장한 것으로 성능 최적화에 사용</td></tr><tr><td></td><td>Upcasting</td><td>이전 버전의 이벤트를 새로운 스키마 버전으로 변환하는 과정</td></tr><tr><td></td><td>Idempotency</td><td>동일한 연산을 여러 번 수행해도 결과가 같음을 보장하는 속성</td></tr><tr><td><strong>패턴 용어</strong></td><td>Outbox Pattern</td><td>데이터베이스 변경과 메시지 발행의 원자성을 보장하는 패턴</td></tr><tr><td></td><td>Saga Pattern</td><td>분산 트랜잭션을 일련의 로컬 트랜잭션으로 분해하는 패턴</td></tr><tr><td></td><td>Eventually Consistent</td><td>시스템이 시간이 지나면서 결국 일관된 상태에 도달하는 일관성 모델</td></tr><tr><td></td><td>Stream Aggregation</td><td>이벤트 스트림에서 쓰기 모델의 현재 상태를 구축하는 과정</td></tr></tbody></table><hr><h2 id=참고-및-출처-5>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-5>#</a></h2><ul><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing>Event Sourcing pattern - Microsoft Azure Architecture Center</a></li><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs>CQRS pattern - Microsoft Azure Architecture Center</a></li><li><a href=https://microservices.io/patterns/data/event-sourcing.html>Microservices Pattern: Event sourcing</a></li><li><a href=https://martinfowler.com/eaaDev/EventSourcing.html>Event Sourcing - Martin Fowler</a></li><li><a href=https://www.kurrent.io/event-sourcing>Beginner&rsquo;s Guide to Event Sourcing - Kurrent</a></li><li><a href=https://www.baeldung.com/cqrs-event-sourcing-java>CQRS and Event Sourcing in Java - Baeldung</a></li><li><a href=https://www.geeksforgeeks.org/event-sourcing-pattern/>Event Sourcing Pattern - GeeksforGeeks</a></li><li><a href=https://mia-platform.eu/blog/understanding-event-sourcing-and-cqrs-pattern/>Understanding Event Sourcing and CQRS Pattern - Mia-Platform</a></li><li><a href=https://blog.risingstack.com/event-sourcing-with-examples-node-js-at-scale/>Event Sourcing with Examples in Node.js - RisingStack</a></li><li><a href=https://edykim.com/ko/post/event-sourcing-implementing-eventsourcing-patterns-with-javascript/>이벤트 소싱 패턴 JavaScript로 구현하기 - edykim</a></li></ul><hr><p>Event Sourcing은 마이크로서비스 아키텍처(MSA)에서 데이터 일관성을 유지하는 중요한 패턴 중 하나이다.<br>이 패턴은 시스템의 상태 변화를 일련의 이벤트로 저장하고 관리하는 방식을 말한다.</p><p>Event Sourcing은 복잡한 도메인 모델을 가진 시스템이나 높은 감사 요구사항이 있는 금융, 의료 등의 분야에서 특히 유용하다. 하지만 구현의 복잡성과 초기 학습 곡선이 높다는 점을 고려해야 한다.</p><h3 id=event-sourcing의-핵심-개념>Event Sourcing의 핵심 개념<a hidden class=anchor aria-hidden=true href=#event-sourcing의-핵심-개념>#</a></h3><ol><li><strong>이벤트 중심 저장</strong>: 시스템의 모든 상태 변경을 이벤트로 저장한다.</li><li><strong>불변성</strong>: 저장된 이벤트는 수정되거나 삭제되지 않고 항상 추가만 된다.</li><li><strong>시간 순서</strong>: 이벤트는 발생한 순서대로 저장된다.</li><li><strong>상태 재구성</strong>: 현재 상태는 저장된 이벤트를 순차적으로 적용하여 재구성한다.</li></ol><h3 id=event-sourcing의-장점>Event Sourcing의 장점<a hidden class=anchor aria-hidden=true href=#event-sourcing의-장점>#</a></h3><ol><li><strong>완전한 감사 추적</strong>: 모든 변경 사항이 이벤트로 저장되어 시스템의 전체 히스토리를 추적할 수 있다.</li><li><strong>시간 여행 가능</strong>: 특정 시점의 상태를 재구성할 수 있어 디버깅과 분석에 유용하다.</li><li><strong>확장성</strong>: 이벤트 저장소는 추가만 하므로 확장이 용이합니다.</li><li><strong>유연성</strong>: 새로운 요구사항에 따라 이벤트를 재해석하여 새로운 뷰를 만들 수 있다.</li></ol><h3 id=event-sourcing의-구현-방법>Event Sourcing의 구현 방법<a hidden class=anchor aria-hidden=true href=#event-sourcing의-구현-방법>#</a></h3><ol><li><strong>이벤트 정의</strong>: 시스템에서 발생할 수 있는 모든 이벤트 유형을 정의한다.</li><li><strong>이벤트 저장소</strong>: 이벤트를 영구적으로 저장할 수 있는 저장소를 구현한다.</li><li><strong>이벤트 핸들러</strong>: 각 이벤트 유형에 대한 처리 로직을 구현한다.</li><li><strong>상태 재구성 로직</strong>: 저장된 이벤트를 기반으로 현재 상태를 재구성하는 로직을 구현한다.</li></ol><h3 id=event-sourcing의-주의사항>Event Sourcing의 주의사항<a hidden class=anchor aria-hidden=true href=#event-sourcing의-주의사항>#</a></h3><ol><li><strong>성능 고려</strong>: 이벤트가 많아질수록 상태 재구성에 시간이 걸릴 수 있다. 이를 위해 스냅샷을 주기적으로 저장하는 방법을 고려해야 한다.</li><li><strong>이벤트 버전 관리</strong>: 시스템이 발전함에 따라 이벤트 스키마가 변경될 수 있으므로, 버전 관리가 필요하다.</li><li><strong>최종 일관성</strong>: Event Sourcing은 일반적으로 최종 일관성 모델을 따르므로, 즉시 일관성이 필요한 경우 추가적인 메커니즘이 필요할 수 있다.</li></ol><h3 id=이벤트-소싱의-구현-시-고려사항>이벤트 소싱의 구현 시 고려사항<a hidden class=anchor aria-hidden=true href=#이벤트-소싱의-구현-시-고려사항>#</a></h3><ol><li><p><strong>이벤트 저장소(Event Store)</strong>: 이벤트를 영구적으로 저장하고, 효율적으로 조회할 수 있는 저장소를 구축해야 한다. 이는 관계형 데이터베이스, NoSQL 데이터베이스, 또는 전문 이벤트 저장소를 사용할 수 있다.</p></li><li><p><strong>이벤트 발행 및 구독 메커니즘</strong>: 이벤트를 발행하고, 이를 구독하는 서비스 간의 통신 메커니즘을 설계해야 한다. 이는 메시지 브로커나 이벤트 스트리밍 플랫폼을 활용할 수 있다.</p></li><li><p><strong>트랜잭션 관리</strong>: 이벤트 저장과 관련된 트랜잭션을 원자적으로 처리하여, 데이터 일관성을 보장해야 한다.</p></li></ol><h3 id=event-sourcing과-cqrs>Event Sourcing과 CQRS<a hidden class=anchor aria-hidden=true href=#event-sourcing과-cqrs>#</a></h3><p>Event Sourcing은 종종 CQRS(Command Query Responsibility Segregation) 패턴과 함께 사용된다. CQRS는 데이터의 쓰기(Command)와 읽기(Query) 모델을 분리하는 패턴으로, Event Sourcing과 결합하면 더욱 강력한 아키텍처를 구성할 수 있다.</p><h3 id=구현-예시-1>구현 예시<a hidden class=anchor aria-hidden=true href=#구현-예시-1>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-68-1><a class=lnlinks href=#hl-68-1> 1</a>
</span><span class=lnt id=hl-68-2><a class=lnlinks href=#hl-68-2> 2</a>
</span><span class=lnt id=hl-68-3><a class=lnlinks href=#hl-68-3> 3</a>
</span><span class=lnt id=hl-68-4><a class=lnlinks href=#hl-68-4> 4</a>
</span><span class=lnt id=hl-68-5><a class=lnlinks href=#hl-68-5> 5</a>
</span><span class=lnt id=hl-68-6><a class=lnlinks href=#hl-68-6> 6</a>
</span><span class=lnt id=hl-68-7><a class=lnlinks href=#hl-68-7> 7</a>
</span><span class=lnt id=hl-68-8><a class=lnlinks href=#hl-68-8> 8</a>
</span><span class=lnt id=hl-68-9><a class=lnlinks href=#hl-68-9> 9</a>
</span><span class=lnt id=hl-68-10><a class=lnlinks href=#hl-68-10>10</a>
</span><span class=lnt id=hl-68-11><a class=lnlinks href=#hl-68-11>11</a>
</span><span class=lnt id=hl-68-12><a class=lnlinks href=#hl-68-12>12</a>
</span><span class=lnt id=hl-68-13><a class=lnlinks href=#hl-68-13>13</a>
</span><span class=lnt id=hl-68-14><a class=lnlinks href=#hl-68-14>14</a>
</span><span class=lnt id=hl-68-15><a class=lnlinks href=#hl-68-15>15</a>
</span><span class=lnt id=hl-68-16><a class=lnlinks href=#hl-68-16>16</a>
</span><span class=lnt id=hl-68-17><a class=lnlinks href=#hl-68-17>17</a>
</span><span class=lnt id=hl-68-18><a class=lnlinks href=#hl-68-18>18</a>
</span><span class=lnt id=hl-68-19><a class=lnlinks href=#hl-68-19>19</a>
</span><span class=lnt id=hl-68-20><a class=lnlinks href=#hl-68-20>20</a>
</span><span class=lnt id=hl-68-21><a class=lnlinks href=#hl-68-21>21</a>
</span><span class=lnt id=hl-68-22><a class=lnlinks href=#hl-68-22>22</a>
</span><span class=lnt id=hl-68-23><a class=lnlinks href=#hl-68-23>23</a>
</span><span class=lnt id=hl-68-24><a class=lnlinks href=#hl-68-24>24</a>
</span><span class=lnt id=hl-68-25><a class=lnlinks href=#hl-68-25>25</a>
</span><span class=lnt id=hl-68-26><a class=lnlinks href=#hl-68-26>26</a>
</span><span class=lnt id=hl-68-27><a class=lnlinks href=#hl-68-27>27</a>
</span><span class=lnt id=hl-68-28><a class=lnlinks href=#hl-68-28>28</a>
</span><span class=lnt id=hl-68-29><a class=lnlinks href=#hl-68-29>29</a>
</span><span class=lnt id=hl-68-30><a class=lnlinks href=#hl-68-30>30</a>
</span><span class=lnt id=hl-68-31><a class=lnlinks href=#hl-68-31>31</a>
</span><span class=lnt id=hl-68-32><a class=lnlinks href=#hl-68-32>32</a>
</span><span class=lnt id=hl-68-33><a class=lnlinks href=#hl-68-33>33</a>
</span><span class=lnt id=hl-68-34><a class=lnlinks href=#hl-68-34>34</a>
</span><span class=lnt id=hl-68-35><a class=lnlinks href=#hl-68-35>35</a>
</span><span class=lnt id=hl-68-36><a class=lnlinks href=#hl-68-36>36</a>
</span><span class=lnt id=hl-68-37><a class=lnlinks href=#hl-68-37>37</a>
</span><span class=lnt id=hl-68-38><a class=lnlinks href=#hl-68-38>38</a>
</span><span class=lnt id=hl-68-39><a class=lnlinks href=#hl-68-39>39</a>
</span><span class=lnt id=hl-68-40><a class=lnlinks href=#hl-68-40>40</a>
</span><span class=lnt id=hl-68-41><a class=lnlinks href=#hl-68-41>41</a>
</span><span class=lnt id=hl-68-42><a class=lnlinks href=#hl-68-42>42</a>
</span><span class=lnt id=hl-68-43><a class=lnlinks href=#hl-68-43>43</a>
</span><span class=lnt id=hl-68-44><a class=lnlinks href=#hl-68-44>44</a>
</span><span class=lnt id=hl-68-45><a class=lnlinks href=#hl-68-45>45</a>
</span><span class=lnt id=hl-68-46><a class=lnlinks href=#hl-68-46>46</a>
</span><span class=lnt id=hl-68-47><a class=lnlinks href=#hl-68-47>47</a>
</span><span class=lnt id=hl-68-48><a class=lnlinks href=#hl-68-48>48</a>
</span><span class=lnt id=hl-68-49><a class=lnlinks href=#hl-68-49>49</a>
</span><span class=lnt id=hl-68-50><a class=lnlinks href=#hl-68-50>50</a>
</span><span class=lnt id=hl-68-51><a class=lnlinks href=#hl-68-51>51</a>
</span><span class=lnt id=hl-68-52><a class=lnlinks href=#hl-68-52>52</a>
</span><span class=lnt id=hl-68-53><a class=lnlinks href=#hl-68-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 이벤트 기본 클래스
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>Event</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>eventId</span> <span class=o>=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>randomUUID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>timestamp</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>data</span> <span class=o>=</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>version</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 주문 관련 이벤트들
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>OrderCreatedEvent</span> <span class=kr>extends</span> <span class=nx>Event</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>orderId</span><span class=p>,</span> <span class=nx>customerId</span><span class=p>,</span> <span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>super</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>orderId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>customerId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;CREATED&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;ORDER_CREATED&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 이벤트 저장소
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>EventStore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>events</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>eventHandlers</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>snapshots</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=nx>saveEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 이벤트 유효성 검증
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>validateEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 이벤트 저장
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 이벤트 처리
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>processEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 스냅샷 필요 여부 확인
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>checkForSnapshot</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>orderId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=nx>getEvents</span><span class=p>(</span><span class=nx>aggregateId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>events</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>event</span> <span class=p>=&gt;</span> <span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>orderId</span> <span class=o>===</span> <span class=nx>aggregateId</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=용어-정리-6>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리-6>#</a></h2><table><thead><tr><th>용어</th><th>설명</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><hr><h2 id=참고-및-출처-6>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-6>#</a></h2><hr></div></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>