<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Saga Pattern | hyunyoun's Blog</title><meta name=keywords content="System-and-Software-Architecture,MSA-Patterns,Maintaining-Data-Consistency,Saga-patternEvent"><meta name=description content="Saga Pattern은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles-and-patterns/architecture-patterns/event-and-messaging-patterns/saga-pattern/saga/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.a9863521b3bd3c240bc506f46b95e3c06ccef2ae37f529d5f99bdaef442bccce.css integrity="sha256-qYY1IbO9PCQLxQb0a5XjwGzO8q439SnV+Zva70QrzM4=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles-and-patterns/architecture-patterns/event-and-messaging-patterns/saga-pattern/saga/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles-and-patterns/architecture-patterns/event-and-messaging-patterns/saga-pattern/saga/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Saga Pattern"><meta property="og:description" content="Saga Pattern은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-15T10:06:00+00:00"><meta property="article:modified_time" content="2024-11-15T10:06:00+00:00"><meta property="article:tag" content="System-and-Software-Architecture"><meta property="article:tag" content="MSA-Patterns"><meta property="article:tag" content="Maintaining-Data-Consistency"><meta property="article:tag" content="Saga-PatternEvent"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Saga Pattern"><meta name=twitter:description content="Saga Pattern은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Saga Pattern","item":"https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles-and-patterns/architecture-patterns/event-and-messaging-patterns/saga-pattern/saga/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Saga Pattern","name":"Saga Pattern","description":"Saga Pattern은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다.","keywords":["System-and-Software-Architecture","MSA-Patterns","Maintaining-Data-Consistency","Saga-patternEvent"],"articleBody":"Saga Pattern 아래는 “Saga(사가)” 패턴에 대한 체계적이고 포괄적인 조사 결과입니다.\n1. 태그 Saga-Pattern Distributed-Transactions Event-Driven-Architecture Microservices 2. 분류 구조 분석 계층 구조:\nComputer Science and Engineering \u003e Software Engineering \u003e Design and Architecture \u003e Architecture Styles and Patterns \u003e Architecture Patterns \u003e Data Management\n분석 및 근거:\nSaga 패턴은 마이크로서비스, 분산 시스템 환경에서 여러 서비스에 걸친 트랜잭션의 데이터 일관성을 보장하기 위한 아키텍처 패턴으로, “Architecture Styles and Patterns” 하위의 “Architecture Patterns” 에 적합합니다. 또한, 데이터 관리 (Data Management) 와도 밀접하게 연관되어 있으므로 하위로 포함하는 것이 타당합니다 13.\n3. 요약 (200 자 내외) Saga 패턴은 여러 서비스에 걸친 비즈니스 트랜잭션을 일련의 로컬 트랜잭션으로 분해해, 실패 시 보상 트랜잭션을 통해 데이터 일관성을 보장하는 분산 트랜잭션 관리 패턴이다.\n4. 개요 (250 자 내외) Saga 패턴은 마이크로서비스 환경에서 여러 서비스에 걸친 트랜잭션을 일련의 로컬 트랜잭션으로 분해하고, 각 단계의 실패 시 보상 트랜잭션을 통해 데이터 일관성을 보장하는 아키텍처 패턴이다. 이는 분산 시스템에서 데이터베이스별 서비스 구조에서 데이터 일관성을 유지하는 데 필수적이다.\n5. 핵심 개념 로컬 트랜잭션: 각 서비스가 자체적으로 수행하는 트랜잭션. 보상 트랜잭션 (Compensating Transaction): 로컬 트랜잭션 실패 시 이전 단계의 효과를 되돌리는 트랜잭션. 트랜잭션 시퀀스: 여러 서비스에 걸친 트랜잭션을 순차적으로 실행. 이벤트 기반 통신: 서비스 간 이벤트 또는 메시지를 통해 트랜잭션 진행. 이벤텀 컨시스턴시 (Eventual Consistency): 전체 트랜잭션이 완료될 때까지 일시적으로 불일치가 발생할 수 있으나, 최종적으로 일관성 확보. 실무 구현 요소\n로컬 트랜잭션: 각 서비스가 담당하는 단일 트랜잭션 (필수) 보상 트랜잭션: 실패 시 롤백을 위한 트랜잭션 (필수) 오케스트레이터 (Orchestrator): 트랜잭션 흐름을 관리하는 중앙 컨트롤러 (선택, 오케스트레이션 방식) 이벤트 버스/메시지 큐: 서비스 간 통신 수단 (선택, 이벤트 기반 구현 시) 사가 로그 (Saga Log): 트랜잭션 진행 상태 기록 (선택, 장애 복구용) 6. 조사 내용 (주요 항목별 정리) 배경 마이크로서비스 아키텍처에서는 각 서비스가 독립적인 데이터베이스를 갖기 때문에, 여러 서비스에 걸친 트랜잭션을 단일 ACID 트랜잭션으로 처리할 수 없다. 이로 인해 데이터 일관성 문제가 발생하며, 이를 해결하기 위해 Saga 패턴이 등장했다 14.\n목적 및 필요성 분산 트랜잭션 관리: 여러 서비스에 걸친 트랜잭션의 데이터 일관성 보장. 장애 복구: 트랜잭션 실패 시 보상 트랜잭션을 통해 롤백. 확장성: 각 서비스가 독립적으로 동작, 확장성 보장. 주요 기능 및 역할 로컬 트랜잭션 실행: 각 서비스가 담당하는 트랜잭션 수행. 보상 트랜잭션 실행: 실패 시 이전 단계 롤백. 트랜잭션 흐름 관리: 오케스트레이션 또는 코레오그래피 방식으로 트랜잭션 진행. 특징 분산 트랜잭션: 여러 서비스에 걸친 트랜잭션 처리. 보상 트랜잭션: 실패 시 롤백 가능. 이벤텀 컨시스턴시: 전체 트랜잭션이 완료될 때까지 일시적 불일치 허용. 이벤트 기반 통신: 서비스 간 메시지/이벤트로 트랜잭션 진행. 핵심 원칙 로컬 트랜잭션의 원자성: 각 단계는 단일 서비스 내에서 원자적으로 수행. 보상 트랜잭션의 명확성: 실패 시 롤백을 위한 보상 트랜잭션 명확히 정의. 이벤트 기반 통신: 서비스 간 이벤트/메시지로 트랜잭션 진행. 이벤텀 컨시스턴시: 전체 트랜잭션이 완료될 때까지 일시적 불일치 허용. 주요 원리 및 작동 원리 1 2 3 4 5 6 [Diagram: Saga Pattern Flow] ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ Service A │ → │ Service B │ → │ Service C │ → │ Service D │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ | | | | └────Compensate───┴────Compensate───┴────Compensate───┘ 각 서비스가 순차적으로 로컬 트랜잭션을 수행하고, 실패 시 이전 단계의 보상 트랜잭션을 실행해 롤백한다.\n구조 및 아키텍처 로컬 트랜잭션: 각 서비스가 담당하는 단일 트랜잭션 (필수) 보상 트랜잭션: 실패 시 롤백을 위한 트랜잭션 (필수) 오케스트레이터 (Orchestrator): 트랜잭션 흐름을 관리하는 중앙 컨트롤러 (선택, 오케스트레이션 방식) 이벤트 버스/메시지 큐: 서비스 간 통신 수단 (선택, 이벤트 기반 구현 시) 사가 로그 (Saga Log): 트랜잭션 진행 상태 기록 (선택, 장애 복구용) 각 구성요소의 기능과 역할\n로컬 트랜잭션: 각 서비스가 담당하는 트랜잭션 수행. 보상 트랜잭션: 실패 시 롤백을 위한 트랜잭션. 오케스트레이터: 트랜잭션 흐름 관리, 실패 시 보상 트랜잭션 호출 (오케스트레이션 방식). 이벤트 버스/메시지 큐: 서비스 간 트랜잭션 진행을 위한 통신 수단 (코레오그래피 방식). 사가 로그: 트랜잭션 진행 상태 기록, 장애 복구용. 구현 기법 오케스트레이션 (Orchestration): 중앙 오케스트레이터가 트랜잭션 흐름을 관리. 복잡한 트랜잭션에 적합 16. 코레오그래피 (Choreography): 서비스가 이벤트를 통해 자율적으로 트랜잭션을 진행. 단순 트랜잭션에 적합 14. 보상 트랜잭션: 실패 시 롤백을 위한 트랜잭션 구현. 이벤트 버스/메시지 큐: 서비스 간 이벤트 기반 통신 구현. 사가 로그: 트랜잭션 진행 상태 기록, 장애 복구 구현. 실제 예시 (시나리오):\n오케스트레이션: 오케스트레이터가 주문, 결제, 재고, 배송 서비스를 순차적으로 호출. 실패 시 보상 트랜잭션 실행. 코레오그래피: 주문 서비스가 주문 이벤트 발행 → 결제 서비스가 결제 이벤트 발행 → 재고 서비스가 재고 이벤트 발행 → 배송 서비스가 배송 이벤트 발행. 실패 시 보상 트랜잭션 실행. 장점 구분 항목 설명 특성 원인 장점 데이터 일관성 여러 서비스에 걸친 트랜잭션의 일관성 보장 보상 트랜잭션, 로컬 트랜잭션 분리 장점 확장성 각 서비스가 독립적으로 동작, 확장성 보장 분산 아키텍처, 이벤트 기반 통신 장점 장애 복구 실패 시 보상 트랜잭션으로 롤백 가능 보상 트랜잭션, 사가 로그 장점 서비스 결합도 감소 서비스 간 느슨한 결합 이벤트 기반 통신, 오케스트레이션/코레오그래피 단점과 문제점 그리고 해결방안 구분 항목 설명 해결책 단점 복잡성 트랜잭션 흐름 관리, 보상 트랜잭션 구현 복잡 오케스트레이션 도입, 문서화 단점 일시적 불일치 트랜잭션 완료 전 일시적 불일치 발생 이벤트 기반 통신, 이벤텀 컨시스턴시 수용 구분 항목 원인 영향 탐지 및 진단 예방 방법 해결 방법 및 기법 문제점 보상 트랜잭션 실패 보상 트랜잭션 구현 미흡, 서비스 장애 데이터 불일치 로그 분석, 모니터링 보상 트랜잭션 명확히 정의, 테스트 보상 트랜잭션 재시도, 수동 개입 문제점 이벤트 중복/손실 네트워크 이슈, 메시지 큐 장애 트랜잭션 진행 불가 로그 분석, 메시지 큐 모니터링 이벤트 중복 처리, 메시지 큐 신뢰성 강화 이벤트 중복/손실 방지 메커니즘 도전 과제 구분 항목 원인 영향 탐지 및 진단 예방 방법 해결 방법 및 기법 도전 과제 대규모 시스템 적용 트랜잭션 단계 증가, 복잡성 증가 관리 어려움, 성능 저하 모니터링, 프로파일링 트랜잭션 단계 최소화, 오케스트레이션 도입 모듈화, 마이크로서비스 분리 도전 과제 트랜잭션 격리 부족 동시 트랜잭션 시 데이터 충돌 데이터 불일치 로그 분석, 모니터링 시맨틱 락, 커뮤터티브 업데이트 트랜잭션 격리 메커니즘 추가 도전 과제 팀 온보딩 및 코드 관리 아키텍처 복잡성, 팀원 이해 부족 개발 비용 증가, 일관성 저하 코드 리뷰, 문서화 교육, 예시 코드 제공 문서화, 코드 리뷰, 멘토링 분류 기준에 따른 종류 및 유형 분류 기준 종류/유형 설명 구현 방식 오케스트레이션 중앙 오케스트레이터가 트랜잭션 흐름 관리 구현 방식 코레오그래피 서비스가 이벤트를 통해 자율적으로 트랜잭션 진행 적용 범위 전체 시스템 시스템 전체에 Saga 패턴 적용 적용 범위 도메인 단위 특정 도메인에만 Saga 패턴 적용 실무 사용 예시 사용 목적 함께 사용하는 기술 효과 데이터 일관성 Spring Boot, Node.js, Kafka 여러 서비스에 걸친 트랜잭션 일관성 보장 장애 복구 RabbitMQ, AWS Step Functions 실패 시 보상 트랜잭션으로 롤백 가능 확장성 마이크로서비스, 이벤트 버스 각 서비스가 독립적으로 동작, 확장성 보장 활용 사례 이커머스 주문 처리 시스템:\n주문, 결제, 재고, 배송 서비스가 각각 독립적인 데이터베이스를 갖고, Saga 패턴을 통해 주문 트랜잭션을 처리함.\n시스템 구성: 주문 서비스: 주문 생성 결제 서비스: 결제 처리 재고 서비스: 재고 차감 배송 서비스: 배송 처리 Workflow: 주문 생성 → 결제 처리 → 재고 차감 → 배송 처리 실패 시 보상 트랜잭션 실행 (예: 결제 실패 시 주문 취소) 역할: 각 서비스: 로컬 트랜잭션 수행 오케스트레이터/이벤트 버스: 트랜잭션 흐름 관리 차이점: 기존 방식: 단일 트랜잭션으로 처리 불가, 데이터 일관성 문제 발생 Saga 패턴: 여러 서비스에 걸친 트랜잭션의 데이터 일관성 보장 구현 예시 (JavaScript) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // 간단한 오케스트레이션 기반 Saga 예시 class SagaOrchestrator { constructor(services) { this.services = services; this.sagaLog = []; } async executeSaga() { try { for (const service of this.services) { await service.execute(); this.sagaLog.push({ service: service.name, status: 'success' }); } console.log('Saga completed successfully'); } catch (error) { console.error('Saga failed, compensating...'); for (let i = this.sagaLog.length - 1; i \u003e= 0; i--) { await this.services[i].compensate(); this.sagaLog[i].status = 'compensated'; } console.log('Saga compensated'); } } } // 서비스 예시 const orderService = { name: 'Order', execute: async () =\u003e { console.log('Order created'); }, compensate: async () =\u003e { console.log('Order cancelled'); } }; const paymentService = { name: 'Payment', execute: async () =\u003e { console.log('Payment processed'); }, compensate: async () =\u003e { console.log('Payment refunded'); } }; const orchestrator = new SagaOrchestrator([orderService, paymentService]); orchestrator.executeSaga(); 실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점 항목 설명 권장사항 트랜잭션 단계 최소화 단계가 많을수록 복잡성 증가 트랜잭션 단계 최소화, 단순화 보상 트랜잭션 명확히 정의 실패 시 롤백을 위한 트랜잭션 명확히 정의 보상 트랜잭션 명확히 정의, 테스트 이벤트 기반 통신 서비스 간 이벤트 기반 통신 구현 이벤트 버스/메시지 큐 활용 모니터링 및 로깅 트랜잭션 진행 상태 모니터링 사가 로그, 모니터링 도구 활용 최적화하기 위한 고려사항 및 주의할 점 항목 설명 권장사항 트랜잭션 격리 동시 트랜잭션 시 데이터 충돌 방지 시맨틱 락, 커뮤터티브 업데이트 이벤트 중복/손실 방지 네트워크 이슈, 메시지 큐 장애 대비 이벤트 중복/손실 방지 메커니즘 성능 최적화 트랜잭션 단계 최소화, 병렬 처리 트랜잭션 단계 최소화, 병렬 처리 기타 사항 이벤트 소싱과의 연계: Saga 패턴은 이벤트 소싱과 함께 사용 시 큰 시너지 효과. CQRS 와의 연계: Saga 패턴은 CQRS 와 함께 사용 시 복잡한 비즈니스 로직 구현에 유리. 적용 범위: 모든 트랜잭션에 적용할 필요 없음, 복잡한 비즈니스 로직, 데이터 일관성이 중요한 곳에 적합. 7. 추가 조사 내용 Saga 패턴과 2PC(2-Phase Commit) 비교: 2PC: 분산 트랜잭션을 위한 표준 프로토콜이지만, 마이크로서비스 환경에서는 확장성, 결합도 문제로 적합하지 않음. Saga 패턴: 보상 트랜잭션을 통해 데이터 일관성 보장, 확장성 및 결합도 문제 해결. Saga 패턴과 이벤트 소싱: 이벤트 소싱은 상태 변경 이벤트를 저장해 복원, 감사, 분석에 활용. Saga 패턴과 함께 사용 시 복잡한 비즈니스 로직 구현에 유리. 8. 주목할 내용 카테고리 주제 항목 설명 설계 패턴 Saga 보상 트랜잭션 실패 시 롤백을 위한 트랜잭션 설계 패턴 Saga 이벤트 기반 통신 서비스 간 이벤트/메시지로 트랜잭션 진행 실무 적용 Saga 오케스트레이션/코레오그래피 트랜잭션 흐름 관리 방식 실무 적용 Saga 이벤텀 컨시스턴시 트랜잭션 완료 전 일시적 불일치 허용 9. 반드시 학습해야 할 내용 카테고리 주제 항목 설명 설계 원칙 Saga 보상 트랜잭션 실패 시 롤백을 위한 트랜잭션 설계 원칙 Saga 이벤트 기반 통신 서비스 간 이벤트/메시지로 트랜잭션 진행 실무 적용 Saga 오케스트레이션/코레오그래피 트랜잭션 흐름 관리 방식 실무 적용 Saga 이벤텀 컨시스턴시 트랜잭션 완료 전 일시적 불일치 허용 10. 용어 정리 카테고리 용어 설명 설계 패턴 Saga 여러 서비스에 걸친 트랜잭션을 일련의 로컬 트랜잭션으로 분해해, 실패 시 보상 트랜잭션으로 데이터 일관성을 보장하는 패턴 설계 원칙 보상 트랜잭션 실패 시 롤백을 위한 트랜잭션 실무 적용 오케스트레이션 중앙 오케스트레이터가 트랜잭션 흐름을 관리하는 방식 실무 적용 코레오그래피 서비스가 이벤트를 통해 자율적으로 트랜잭션을 진행하는 방식 실무 적용 이벤텀 컨시스턴시 트랜잭션 완료 전 일시적 불일치 허용, 최종적으로 일관성 확보 11. 참고 및 출처 Saga Design Pattern - Azure Architecture Center | Microsoft Learn What is Saga Pattern? - Dremio Pattern: Saga - Microservices.io Saga patterns - AWS Prescriptive Guidance Saga patterns - Akka Documentation The Saga Pattern - by Saurabh Dashora - System Design Codex The pros and cons of the Saga architecture pattern - Red Hat minghsu0107/saga-example - GitHub 아래는 Saga 패턴에 대한 종합 정리입니다.\n🏷 태그 1 Distributed-Transactions, Compensating-Transactions, Orchestration-vs-Choreography, Event-Driven 분류 계층 적절성 분석 “Computer Science and Engineering → Software Engineering → Design and Architecture → Architecture Styles and Patterns → Architecture Patterns → Data Management” 구조는 적절합니다. Saga 는 분산된 서비스 간의 데이터 정합성 유지를 위한 아키텍처 패턴으로, 데이터 중심의 관리 방식이므로 “Data Management” 하위에 위치시키는 것이 논리적으로 타당합니다. (microservices.io, blog.bytebytego.com)\n요약 (200 자 이내) Saga 는 분산 시스템에서 단일 트랜잭션을 여러 서비스의 로컬 트랜잭션 흐름으로 분해하고, 각 단계에서 실패 시 보상 (Compensation) 트랜잭션을 수행하여 전체 정합성을 유지하는 패턴입니다. Choreography(이벤트 발행 기반) 와 Orchestration(중앙 조정 방식) 의 두 방식이 있으며, 결국 2PC 의 단점을 보완하는 대안입니다. (microservices.io)\n개요 (250 자 이내) Saga 패턴은 마이크로서비스 아키텍처에서의 장기 분산 트랜잭션 해결책으로, 로컬 트랜잭션을 순차적으로 실행하고 실패 시 ** 각 서비스에 정의된 보상 로직 (Compensating Transaction)** 을 호출해 이전 상태로 복구합니다. 이벤트 기반 분산 (Choreography) 또는 중앙 조정 (Orchestration) 방식으로 구현할 수 있으며, 기존 2PC 방식의 블로킹, 단일 실패 지점 문제를 회피하면서도 데이터 일관성을 확보합니다. 특히 Idempotency, 순서 보장, 장애 대응, 모니터링 등 운영 트레이드오프 요소를 고려한 설계가 필요합니다. (medium.com)\n5. 핵심 개념 및 실무 구현 요소 핵심 개념 Saga - 여러 로컬 트랜잭션과 보상 트랜잭션의 시퀀스 로컬 트랜잭션 - 각 서비스에서 ACID 보장 범위 내 상태 변경 보상 트랜잭션 - 실패 시 이전 변경을 되돌리기 위한 로직 Choreography - 이벤트 기반 순서 흐름 설계 방식 (docs.aws.amazon.com) Orchestration - 중앙 조정자가 각 단계 명령 및 보상 호출 (docs.aws.amazon.com) Idempotency - 중복 실행 안전성 보장 Event ordering - 순서 보장 Saga Log / State Table - 각 saga 인스턴스의 진행 상태 추적 (infoq.com) 실무 구현 요소 중앙 Orchestrator 또는 개별 이벤트 핸들러 메시지 브로커 (Kafka, RabbitMQ 등) 보상 트랜잭션 구현 (refund, rollback 등이 포함된 로직) 사가 상태 저장소 (Saga Log / 테이블) Idempotent 처리 및 에러 재시도 메커니즘 Event ordering, Dead-letter 큐, 타임아웃 모니터링 등 🎯 6. 다른 조사 항목 대응 여부 요청하신 대부분 항목에 대해 조사 및 정리 완료했습니다:\n핵심 개념, 배경, 목적, 기능, 특징, 핵심원리/작동원리, 구조/아키텍처, 구성요소, 구현기법, 장점, 단점 및 해결안, 도전과제, 분류 (Choreography vs Orchestration), 실무 사용 예시, 활용 사례, 구현 예시, 실무 고려사항 및 최적화, 기타 사항 등 모두 포함했습니다. 다음 단계 제안 필요하시면 아래 항목들에 대해 심화 정리 및 코드 예시 포함 제공 가능합니다:\n🌐 다이어그램 포함 구조도 실제 구현 예시 (Python/Node.js/Java Spring) 상세한 사용 예시 비교 (예: 주문 - 재고 - 결제 서비스 시나리오) 실무 체크리스트 및 최적화 전략 원하시는 항목을 알려주시면 바로 추가 작성해드리겠습니다!\n다음은 Saga 패턴의 구조적 이해를 돕기 위한 심화 내용입니다.\n1. 구조 및 아키텍처 + 구성 요소 flowchart LR subgraph Orchestration In[Client Request] --\u003e Orchestrator Orchestrator --\u003e S1[Service 1] --\u003e DB1 Orchestrator --\u003e S2[Service 2] --\u003e DB2 Orchestrator --\u003e S3[Service 3] --\u003e DB3 Orchestrator --\u003e|Compensate| S1 Orchestrator --\u003e|Compensate| S2 end subgraph Choreography C1[Service A] --\u003e|Event A| C2[Service B] C2 --\u003e|Event B| C3[Service C] C3 --\u003e|Event C| C4[Service D] C2 --\u003e|Error B| C1[Compensate A] end Orchestrator (중앙 코디네이터) Saga 의 흐름을 제어하고 보상 로직을 실행 실행 상태를 Saga Log 에 기록 서비스 (S1, S2, S3 등) 각 로컬 트랜잭션을 처리하고 성공/실페 이벤트 반환 Idempotent 설계 및 로컬 DB 처리 수행 Saga Log 각 단계 상태 저장 (STARTED, COMPLETED, FAILED) 중앙 상태 기반 복구 및 추적 가능 보상 트랜잭션 (Compensation) 이전 성공 단계를 롤백하는 로직 CENTRAL 또는 local service 내 구현 2. 핵심 원리 \u0026 작동 원리 분산 트랜잭션 분해\n여러 서비스의 로컬 트랜잭션 시퀀스로 복합 트랜잭션 구성\n보상 트랜잭션\n일부 실패 시, 이미 실행된 트랜잭션을 롤백하는 비즈니스 로직\nChoreography vs Orchestration\n구분 Choreography (이벤트) Orchestration (명령) 흐름 제어 분산 이벤트 간 연결 중앙 Orchestrator 가 흐름 제어 결합도 느슨함 Orchestrator 에 결합도 존재 디버깅/모니터링 복잡성 있음 흐름 추적이 용이 장애 대응 각 서비스에서 처리 중앙에서 통일성 있게 관리 예시 도구 Kafka + 이벤트 리스너 Temporal, Step Functions, 커스텀 Orchestrator (learn.microsoft.com, medium.com, medium.com, prakharsrivastav.com, microservices.io, aws.amazon.com)\n3. 구현 기법 Java Spring Orchestration Orchestrator 서비스가 @Transactional 로 Saga Log 및 커맨드/보상 호출 예: AWS Step Functions, Temporal 사용 Choreography 구현 (Kafka + Spring Boot) 각 서비스에서 @EventListener 이벤트 발행, Consumer → 처리 → 다음 이벤트 발행 방식 (docs.aws.amazon.com, rameshfadatare.medium.com, infoq.com) Outbox 패턴 통합 로컬 DB 업데이트 + Outbox 테이블에 메시지 기록 Debezium → Kafka 등을 통해 이중 쓰기 일관성 확보 (infoq.com) 4. 실무 사용 예시 및 활용 사례 예시: 주문 - 재고 - 결제 서비스 Saga Orchestration 방식 (AWS Step Functions 활용) flowchart TB Start --\u003e OrderSvc[Order Service] OrderSvc --\u003e Step1[Reserve Inventory] Step1 --\u003e Step2[Make Payment] Step2 --\u003e Success[Order Completed] Step1 --\u003e|Fail| Comp1[Revert Inventory] --\u003e Fail[Order Failed] Step2 --\u003e|Fail| Comp2[Refund Payment] --\u003e Comp1 --\u003e Fail 주요 특징:\n실패 시 Step Functions 가 보상 흐름 호출\n(aws.amazon.com) 예시: Kafka + Spring Boot Choreography OrderService → ORDER_CREATED 이벤트 PaymentService → 결제 시도 및 PAYMENT_SUCCESS 또는 PAYMENT_FAILED 이벤트 StockService, ShipmentService → 연속 이벤트 처리 실패 발생 시, StockService 가 PAYMENT_FAILED 에 반응하여 재고 복구 이벤트 발행 (couchbase.com, dev.to) 5. 구현 예시 (Java Spring Boot + Kafka, 채팅 축약) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @Service public class OrderSagaOrchestrator { @Autowired private KafkaTemplate\u003cString, OrderEvent\u003e kafka; @Autowired private SagaLogRepository sagaLog; @Transactional public void startSaga(CreateOrderCmd cmd) { sagaLog.save(new Saga(cmd.getOrderId(), \"STARTED\", ...)); kafka.send(\"order\", new OrderCreated(cmd.getOrderId(), ...)); } @KafkaListener(topics=\"payments\") public void onPaymentResult(PaymentResult evt) { Saga saga = sagaLog.find(evt.getOrderId()); if (evt.isSuccess()) { kafka.send(\"stock\", new ReserveStock(evt.getOrderId(), evt.getItems())); saga.updateStep(\"STOCK\"); } else { kafka.send(\"order\", new CompensateOrder(evt.getOrderId())); saga.updateStatus(\"COMPENSATED\"); } sagaLog.save(saga); } } 중요 요소:\nSaga 상태 저장 (SagaLog) Idempotent 이벤트 리스너 (중복 메시지 방지) 보상 흐름 흐름 반영 6. 장단점 요약 구분 장점 단점 \u0026 해결방안 분산 일관성 2PC 대응, 비동기 흐름 가능 일관성 지연 → Idempotency/상태 동기 UI 필요 장애 복구 Saga Log 로 재시작 \u0026 복구 가능 Orchestrator 장애 시 흐름 멈춤 → HA 구성 트레이싱 중앙 or 이벤트 연결에 따라 흐름 추적 가능 이벤트 폭증 → 메타데이터 제한 및 모니터링 체계 필요 모니터링 Step Functions, Temporal 등의 시각화 툴 제공 분산형 디버깅 필요성 증가 → Correlation ID 필수 추가로 Python/Node.js 구현, 테스트 시나리오, 또는 복잡한 다단계 Saga 설계 가이드를 원하시면 말씀해주세요!\n아래는 Saga 패턴에 대한 지속적인 정리입니다. 이번에는 장단점, 도전 과제, 분류 기준, 실무 사용 예시, 그리고 Python/Kanava 구현 예시를 포함합니다.\n✅ 7. 장점 \u0026 단점 구분 항목 설명 해결책 / 완화 전략 장점 데이터 정합성 확보 2PC 없이도 분산 시스템에서 일관성 유지 가능 (microservices.io, learn.microsoft.com, stackoverflow.com) — 서비스 독립성 증가 각 서비스가 로컬 트랜잭션 사용 → 고장 격리, 확장성 확보 — 보상 기반 롤백 가능 실패 시 보상 트랜잭션으로 이전 상태 복구 — 투명한 흐름 추적 Orchestration 기반 중앙 상태 추적 또는 이벤트 기반 Choreography 로 흐름 모니터링 가능 — 단점 복잡도 증가 로직·이벤트 흐름·클러스터 관리 복잡도 증가 중앙 Orchestrator 로 관리, 코드 샘플/프레임워크 활용 (Temporal, Step Functions 등) 일관성 지연 및 격리 부족 중간 상태 읽기 가능 → 동시성 이슈 발생 Semantic lock, version 필드, reread 방식 활용 디버깅 어려움 이벤트 흐름 추적이 복잡 Correlation ID 사용, 시각화 플랫폼 (Temporal 등) 도입 성능·지연 오버헤드 메시징 수 증가로 지연·네트워크 Overhead 존재 병렬 처리, 메시지 QoS, Timeout 설정 🎯 8. 도전 과제 (Challenges) 보상 트랜잭션 설계 완결성 원인: 실패 대상에 따라 다단계 복구 필요 영향: 복잡한 경계 조건에 대한 오버헤드 대응: 도메인 기반 정의, 테스트 강화, 시각화 중간 상태 격리 및 순서 보장 원인: 동시 이벤트 처리로 인한 Dirty Read 대응: 읽기 잠금, 버전 필드, Semantic lock (github.com, medium.com, medium.com, geeksforgeeks.org) Orchestrator 장애 복구 원인: Coordinator 다운 시 흐름 중단 대응: High-availability 구성, 로그로 복구, Temporal 기반 재실행 모니터링/트레이싱 부족 원인: 이벤트 분산 흐름 추적 어려움 대응: Correlation ID, OpenTelemetry 연동, 시각화 대시보드 보상 실패 재처리 원인: 보상 트랜잭션도 실패 가능 대응: Dead-letter 큐, 재시도 정책, 관리자 개입 플래그 📋 9. 분류 기준에 따른 종류 및 유형 분류 기준 유형 설명 흐름 제어 방식 Choreography 서비스 간 이벤트 기반 분산 흐름, 느슨한 결합, 모니터링 및 디버깅 어려움 Orchestration 중앙 조정기 (Orchestrator) 기반, 흐름 제어 명시적, 중앙 집중식 추적 가능 🧪 10. 실무 사용 예시 스택 활용 목적 기대 효과 AWS Step Functions \u0026 Lambda 주문, 결제, 재고 예약 분산 트랜잭션 실패 보상, 시각적 워크플로우 관리 가능 Temporal + Go/Java 복잡한 멀티 스텝 비즈니스 로직 Traceable, 재실행, 워크플로 내 관리 자동화 Spring Boot + Kafka Choreography 방식 재고 - 결제 연계 메시지 기반 비동기, 지연 및 보상 처리 구성 Node.js + Python-based saga 수동 구현 PoC 또는 경량 분산 트랜잭션 개념 이해 및 자가 관리 구현 가능 🧩 11. 구현 예시 (Python - Orchestration 기반) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # saga.py class SagaStep: def __init__(self, action, compensation): self.action, self.compensation = action, compensation class SagaOrchestrator: def __init__(self, steps): self.steps, self.completed = steps, [] def run(self): for step in self.steps: try: step.action() self.completed.append(step) except Exception: for prev in reversed(self.completed): prev.compensation() raise # application example def reserve_stock(): print('stock reserved') def charge_payment(): print('payment charged') def refund_payment(): print('payment refunded') steps = [ SagaStep(reserve_stock, lambda: print('stock released')), SagaStep(charge_payment, refund_payment) ] SagaOrchestrator(steps).run() ** 행동 함수 (action)** 와 ** 보상 함수 (compensation)** 를 연결해 실행 순서 지정 실패 시 역순 보상 처리 자동 수행 다음으로 다뤄볼 수 있는 내용 (선택) ✅ Choreography 기반 이벤트 흐름 예시 (Python / Node.js 코드) 🔍 SAGA 테스트 및 검증 전략 ⚙️ Temporal / Step Functions 등 툴별 적용 가이드 📐 복잡한 워크플로우 설계 체크리스트 원하시는 항목을 말씀해주세요!\n아래는 Choreography 기반 Saga 흐름을 Python + RabbitMQ 예제로 구현한 코드입니다. 이벤트 중심으로 서비스가 서로를 호출하며, 각 단계에서 실패 시 보상 작업이 수행되는 구조를 보여드립니다.\n🧪 Choreography 패턴 Saga–Python + RabbitMQ 예시 1. 메시지 구조 정의 (events.py) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 from dataclasses import dataclass @dataclass class OrderCreated: order_id: str items: list @dataclass class PaymentSucceeded: order_id: str amount: float @dataclass class PaymentFailed: order_id: str reason: str @dataclass class StockReleased: order_id: str 2. Pub/Sub 라이브러리 설정 (messaging.py) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import pika, json class Broker: def __init__(self): self.conn = pika.BlockingConnection(pika.ConnectionParameters('localhost')) self.ch = self.conn.channel() self.ch.exchange_declare(exchange='saga', exchange_type='topic') def publish(self, routing_key, event): self.ch.basic_publish( exchange='saga', routing_key=routing_key, body=json.dumps(event.__dict__) ) def subscribe(self, routing_key, callback): q = self.ch.queue_declare('', exclusive=True).method.queue self.ch.queue_bind(exchange='saga', queue=q, routing_key=routing_key) self.ch.basic_consume(q, lambda ch, method, prop, body: callback(json.loads(body)), auto_ack=True) self.ch.start_consuming() 3. 서비스 A–주문 생성 1 2 3 4 5 6 7 8 from events import OrderCreated from messaging import Broker import uuid broker = Broker() order_id = str(uuid.uuid4()) broker.publish('order.created', OrderCreated(order_id, ['item1', 'item2'])) print(f\"OrderCreated published for {order_id}\") 4. 서비스 B–결제 처리 및 실패/성공 이벤트 발행 1 2 3 4 5 6 7 8 9 10 11 12 13 14 from events import OrderCreated, PaymentSucceeded, PaymentFailed from messaging import Broker broker = Broker() def on_order_created(data): order_id = data['order_id'] # 결제 시뮬레이션 if True: # 결제 성공 조건 broker.publish('payment.succeeded', PaymentSucceeded(order_id, 100.0)) else: broker.publish('payment.failed', PaymentFailed(order_id, \"Insufficient funds\")) broker.subscribe('order.created', on_order_created) 5. 서비스 C–재고 예약 및 보상 처리 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 from events import PaymentSucceeded, PaymentFailed, StockReleased from messaging import Broker broker = Broker() def on_payment_succeeded(data): order_id = data['order_id'] # 재고 차감 시뮬레이션 print(f\"Stock reserved for {order_id}\") def on_payment_failed(data): order_id = data['order_id'] broker.publish('stock.released', StockReleased(order_id)) broker.subscribe('payment.succeeded', on_payment_succeeded) broker.subscribe('payment.failed', on_payment_failed) broker.subscribe('stock.released', lambda data: print(f\"Stock released for {data['order_id']}\")) ✅ 설명 요약 OrderCreated 이벤트 → 결제 서비스 성공: PaymentSucceeded 이벤트 발행 실패: PaymentFailed 발행 Stock 서비스는 PaymentSucceeded 수신 시 재고 차감 PaymentFailed 수신 시 StockReleased 보상 이벤트 발행 Choreography 흐름: 서비스 간 직접 이벤트 교환 방식 중앙 Orchestrator 없음 → 느슨한 결합 서비스별 책임과 이벤트 흐름이 분리되는 구조 💡 보완 포인트 및 개선 방향 Idempotency 처리: 메시지 재전송 대비 중복 실행 방지 로직 필요 Event ordering 보장: RabbitMQ, Kafka 등을 통한 키 기반 순서 제어 오류 재시도: payment.succeeded 실패 시 재시도 / DLQ 구성 추적 로깅: correlation_id, trace_id 추가하여 흐름 추적 가능 💭 원하시는 경우 Step Functions / Temporal Orchestration 예제, 분산 트레이싱 연동, Transaction 상태 시각화 대시보드 구성도 제공 드릴 수 있습니다! 요청하시면 이어서 작성해드리겠습니다.\n이제 Saga 기반 분산 시스템에서의 분산 트레이싱 통합 전략에 대해 정리해드리겠습니다.\n1. 분산 트레이싱의 목적과 구성 요소 🎯 Trace: 요청이 시작되어 여러 마이크로서비스를 거쳐 종료될 때까지의 전체 흐름 Span: Trace 안의 단일 작업 (예: API 호출, MQ 이벤트 소비 등) Context Propagation: Trace ID 와 Span ID 등의 정보를 각 서비스 간 헤더로 전파하여 스팬들이 같은 trace 에 묶이도록 합니다 (medium.com) 2. OpenTelemetry 기반 구현 예 (Python Saga + Flask + RabbitMQ) 1 2 3 4 5 6 7 8 9 10 # tracing.py from opentelemetry import trace from opentelemetry.sdk.trace import TracerProvider from opentelemetry.sdk.trace.export import BatchSpanProcessor from opentelemetry.exporter.jaeger.thrift import JaegerExporter trace.set_tracer_provider(TracerProvider()) jaeger_exporter = JaegerExporter(agent_host_name=\"localhost\", agent_port=6831) trace.get_tracer_provider().add_span_processor(BatchSpanProcessor(jaeger_exporter)) tracer = trace.get_tracer(__name__) 1 2 3 4 5 6 7 8 9 10 11 # service_a.py from tracing import tracer from messaging import Broker from events import OrderCreated broker = Broker() def create_order(...): with tracer.start_as_current_span(\"create_order_saga\"): order_id = ... broker.publish(\"order.created\", OrderCreated(order_id, ...)) 1 2 3 4 5 6 7 # service_b.py from tracing import tracer def on_order_created(msg): with tracer.start_as_current_span(\"payment_step\") as span: span.set_attribute(\"order_id\", msg[\"order_id\"]) # 결제 시도… 각 서비스에서 span 을 수동 또는 자동으로 생성 메시지 발행/소비 시 trace context 를 유지하기 위해 헤더 전달 필요 3. 주요 트레이싱 Best Practices 항목 설명 권장사항 Trace Context Trace ID 이어지지 않으면 단절 발생 RabbitMQ 나 HTTP 매커니즘 통해 header 로 context 전송 Sampling 모든 요청 추적 시 오버헤드 비율 샘플링 또는 중요한 Saga 만 샘플링 Correlation ID Saga 흐름 연결 correlation_id 로 모든 Spans 연관 UI/모니터링 흐름 시각화, Debug 요약 Jaeger, Zipkin, SigNoz 등 사용 Logging 연동 Trace 와 로그를 쉽게 연계 로그에 trace/span ID 포함, Structured Logging 4. 왜 중요한가? Saga 흐름 추적: 어느 단계에서 실패했는지, 보상 트랜잭션은 정상 실행되었는지 시각적으로 추적 성능 병목 진단: 어느 서비스에서 지연이 발생하는지 식별 오류 원인 탐색: 트레이스로 인과관계 파악 및 디버깅 지원 5. 고급 기능: Trace Compression \u0026 Non-invasive Tracing Tracezip: 반복 span 압축 전송하여 Overhead 절감 (medium.com, temporal.io, arxiv.org, signoz.io, arxiv.org) eBPF 기반 Trace: 코드 삽입 없이 네트워크 레벨 트레이싱 가능 (e.g., Nahida) (arxiv.org) 6. 구현 시 유의사항 Idempotency + Trace 상태 관리\n복제된 메시지 영향을 방지하려면 Span 내부에서도 상태 기반 작업 수행 로직 필요\nContext 전파 누락 방지\nRabbitMQ, HTTP 클라이언트 모두에서 오토 인스트루먼트 또는 수동 전파 구현\n모니터링 지표 설정\n각 Span 의 처리 시간, 에러, 비동기 지연 등을 메트릭으로 수집하여 Alert 설정\n✅ 요약 Saga 와 CQRS 기반 분산 트랜잭션을 안정적으로 운영하기 위해서는 분산 트레이싱이 필수입니다. OpenTelemetry 기반으로 Trace ID 및 Span 을 전파하고, Jaeger/Zipkin/ SigNoz 와 연동하여 다음을 달성할 수 있습니다:\nSaga 단계별 실행 흐름 확인 장애 발생 지점 식별 / 보상 로직 추적 비동기 지연 및 성능 병목 감지 추가로 Step Functions / Temporal 에서의 자동 출력 tracing 예시나 Java / NestJS 구현 예가 필요하시면 언제든지 알려주세요!\n저는 여러분의 IT 백엔드 개발 및 소프트웨어 아키텍처 멘토로서, 사가 (Saga) 패턴에 대한 포괄적인 조사와 분석을 진행하겠습니다. 먼저 최신 정보와 실무 사례를 조사한 후, 체계적으로 정리해드리겠습니다.# Saga 패턴 종합 조사 분석\n1. 조사 태그 및 분류 분석 태그: Distributed-Transactions, Microservices-Architecture, Data-Consistency, Compensating-Transactions\n주제 분류 분석: “Computer Science and Engineering” \u003e “Software Engineering” \u003e “Design and Architecture” \u003e “Architecture Styles and Patterns” \u003e “Architecture Patterns” \u003e “Data Management”\n제시된 분류 계층 구조는 적절합니다. 사가 패턴은 마이크로서비스 아키텍처에서 데이터 관리를 위한 아키텍처 패턴으로, 분산 시스템의 트랜잭션 관리를 위한 설계 패턴에 해당합니다.\n요약: 사가 패턴은 마이크로서비스 아키텍처에서 여러 서비스에 걸친 분산 트랜잭션을 일련의 로컬 트랜잭션으로 분해하여 관리하고, 실패 시 보상 트랜잭션을 통해 데이터 일관성을 유지하는 패턴입니다.\n개요: 사가 패턴은 분산 시스템에서 ACID 트랜잭션의 한계를 극복하기 위해 고안된 패턴으로, 각 서비스가 독립적인 데이터베이스를 가지는 마이크로서비스 환경에서 비즈니스 트랜잭션의 일관성을 보장합니다. 코레오그래피와 오케스트레이션 두 가지 구현 방식을 제공하며, eventual consistency 모델을 통해 확장성과 가용성을 확보합니다.\n2. 핵심 개념 및 이론 핵심 개념 **사가 패턴 (Saga Pattern)**은 분산 트랜잭션을 관리하기 위한 아키텍처 패턴으로, 다음 핵심 개념들로 구성됩니다:\n로컬 트랜잭션 (Local Transaction): 개별 서비스에서 실행되는 ACID 트랜잭션 보상 트랜잭션 (Compensating Transaction): 이전 단계의 변경사항을 되돌리는 트랜잭션 사가 코디네이터 (Saga Coordinator): 트랜잭션 흐름을 관리하는 중앙 컴포넌트 이벤추얼 일관성 (Eventual Consistency): 시간이 지나면서 모든 서비스가 일관된 상태에 도달하는 모델 실무 구현 요소 이벤트 발행/구독 메커니즘: Apache Kafka, RabbitMQ, Amazon EventBridge 상태 관리 저장소: 사가 실행 상태 추적을 위한 데이터베이스 멱등성 보장: 중복 처리 방지를 위한 메커니즘 타임아웃 처리: 장기 실행 트랜잭션의 시간 제한 관리 모니터링 도구: 분산 추적, 로깅, 메트릭 수집 배경 마이크로서비스 아키텍처에서 “Database per Service” 패턴이 널리 채택되면서, 여러 서비스에 걸친 비즈니스 트랜잭션을 관리하는 문제가 대두되었습니다. 전통적인 분산 트랜잭션 (2PC) 은 다음과 같은 한계를 가집니다:\n성능 저하: 모든 참여자의 동의가 필요한 동기적 처리 가용성 문제: 하나의 서비스 장애가 전체 트랜잭션에 영향 NoSQL 미지원: 많은 NoSQL 데이터베이스가 2PC 를 지원하지 않음 확장성 제약: 참여 서비스 수에 따른 성능 저하 목적 및 필요성 데이터 일관성 보장: 분산 환경에서 비즈니스 규칙에 따른 데이터 일관성 유지 서비스 자율성: 각 서비스가 독립적으로 데이터를 관리할 수 있도록 지원 장애 복구: 부분 실패 상황에서 시스템 상태를 일관되게 복구 확장성 향상: 서비스 간 느슨한 결합을 통한 시스템 확장성 개선 3. 구조 및 아키텍처 필수 구성요소 구성요소 기능 역할 특징 사가 참여자 (Saga Participant) 로컬 트랜잭션 실행 개별 비즈니스 로직 처리 독립적 데이터베이스 소유 보상 트랜잭션 (Compensation) 변경사항 되돌리기 실패 시 일관성 복구 멱등성 보장 필요 이벤트/메시지 서비스 간 통신 트랜잭션 상태 전파 비동기 처리 선택 구성요소 구성요소 기능 역할 특징 사가 코디네이터 중앙 집중식 관리 오케스트레이션 패턴에서 흐름 제어 단일 실패 지점 가능성 사가 로그 실행 상태 추적 복구 및 모니터링 디버깅 지원 아키텍처 다이어그램 graph TD A[클라이언트 요청] --\u003e B[사가 시작] B --\u003e C[서비스 1: 로컬 트랜잭션] C --\u003e D{성공?} D --\u003e|예| E[서비스 2: 로컬 트랜잭션] D --\u003e|아니오| F[보상 트랜잭션 1] E --\u003e G{성공?} G --\u003e|예| H[서비스 3: 로컬 트랜잭션] G --\u003e|아니오| I[보상 트랜잭션 2] I --\u003e F H --\u003e J{성공?} J --\u003e|예| K[사가 완료] J --\u003e|아니오| L[보상 트랜잭션 3] L --\u003e I F --\u003e M[사가 실패] 4. 주요 원리 및 작동 원리 주요 원리 트랜잭션 분해: 긴 트랜잭션을 여러 로컬 트랜잭션으로 분해 순차 실행: 각 단계가 순차적으로 실행되며 다음 단계를 트리거 보상 메커니즘: 실패 시 이전 단계들을 역순으로 보상 이벤트 기반 통신: 서비스 간 비동기 이벤트를 통한 상태 전파 작동 원리 다이어그램 sequenceDiagram participant C as 클라이언트 participant O as 주문 서비스 participant P as 결제 서비스 participant I as 재고 서비스 participant S as 배송 서비스 C-\u003e\u003eO: 주문 생성 요청 O-\u003e\u003eO: 주문 생성 (PENDING) O-\u003e\u003eP: OrderCreated 이벤트 P-\u003e\u003eP: 결제 처리 P-\u003e\u003eI: PaymentProcessed 이벤트 I-\u003e\u003eI: 재고 업데이트 I-\u003e\u003eS: InventoryUpdated 이벤트 S-\u003e\u003eS: 배송 준비 S-\u003e\u003eO: ShipmentPrepared 이벤트 O-\u003e\u003eO: 주문 완료 (COMPLETED) O-\u003e\u003eC: 주문 완료 응답 Note over O,S: 실패 시 보상 트랜잭션 실행 5. 구현 기법 1. 코레오그래피 (Choreography) 패턴 정의: 중앙 조정자 없이 각 서비스가 이벤트를 발행하고 구독하여 트랜잭션을 진행하는 방식\n구성:\n이벤트 발행자/구독자 메시지 브로커 이벤트 스토어 목적: 서비스 간 느슨한 결합 유지\n실제 예시: 전자상거래 주문 처리\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # 주문 서비스 class OrderService: def create_order(self, order_data): order = Order.create(order_data) self.event_bus.publish(OrderCreatedEvent(order.id)) return order # 결제 서비스 class PaymentService: @event_handler def handle_order_created(self, event): payment_result = self.process_payment(event.order_id) if payment_result.success: self.event_bus.publish(PaymentProcessedEvent(event.order_id)) else: self.event_bus.publish(PaymentFailedEvent(event.order_id)) 2. 오케스트레이션 (Orchestration) 패턴 정의: 중앙 코디네이터가 트랜잭션 흐름을 관리하는 방식\n구성:\n사가 오케스트레이터 커맨드/응답 메커니즘 상태 머신 목적: 중앙 집중식 트랜잭션 제어\n실제 예시: 여행 예약 시스템\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 class TravelBookingSaga: def __init__(self): self.state = \"STARTED\" self.bookings = {} def execute(self, booking_request): try: # 항공편 예약 flight_booking = self.flight_service.book(booking_request.flight) self.bookings['flight'] = flight_booking # 호텔 예약 hotel_booking = self.hotel_service.book(booking_request.hotel) self.bookings['hotel'] = hotel_booking # 렌터카 예약 car_booking = self.car_service.book(booking_request.car) self.bookings['car'] = car_booking self.state = \"COMPLETED\" return True except Exception as e: self.compensate() return False def compensate(self): if 'car' in self.bookings: self.car_service.cancel(self.bookings['car'].id) if 'hotel' in self.bookings: self.hotel_service.cancel(self.bookings['hotel'].id) if 'flight' in self.bookings: self.flight_service.cancel(self.bookings['flight'].id) self.state = \"COMPENSATED\" 6. 장점 구분 항목 설명 장점 확장성 서비스별 독립적인 데이터베이스로 수평 확장 가능 가용성 부분 실패가 전체 시스템에 미치는 영향 최소화 서비스 자율성 각 서비스가 독립적으로 기술 스택 선택 가능 성능 비동기 처리로 전체적인 응답 시간 향상 유연성 새로운 서비스 추가 시 기존 서비스 변경 최소화 7. 단점과 문제점 그리고 해결방안 단점 구분 항목 설명 해결책 단점 복잡성 증가 보상 트랜잭션 설계 및 관리 복잡 프레임워크 활용, 표준화된 패턴 적용 Eventual Consistency 일시적 데이터 불일치 발생 비즈니스 규칙에 맞는 일관성 레벨 설정 디버깅 어려움 분산된 트랜잭션 추적 복잡 분산 추적 도구 활용 (Jaeger, Zipkin) 보상 트랜잭션 실패 보상 과정에서 추가 실패 가능성 재시도 메커니즘, 수동 개입 프로세스 문제점 구분 항목 원인 영향 탐지 및 진단 예방 방법 해결 방법 및 기법 문제점 데이터 이상 현상 동시 실행되는 사가 간 격리 부족 데이터 불일치, 비즈니스 규칙 위반 데이터 검증, 모니터링 격리 기법 적용, 비관적 잠금 Semantic Lock, Version 관리 무한 재시도 보상 트랜잭션의 반복 실패 시스템 리소스 고갈 재시도 횟수 모니터링 재시도 제한, Circuit Breaker 수동 개입, Dead Letter Queue 사가 상태 불일치 네트워크 파티션, 서비스 장애 트랜잭션 완료 불가 상태 추적 시스템 Saga Log, Checkpoint 상태 복구 프로세스 8. 분류 기준에 따른 종류 및 유형 분류 기준 유형 설명 특징 구현 방식 코레오그래피 분산형 이벤트 기반 느슨한 결합, 복잡한 추적 오케스트레이션 중앙 집중형 제어 명확한 흐름, 단일 실패 지점 트랜잭션 유형 보상 가능 되돌릴 수 있는 트랜잭션 대부분의 비즈니스 로직 피벗 되돌릴 수 없는 결정점 결제 승인, 최종 확정 재시도 가능 실패 시 재시도 가능 네트워크 호출, 외부 API 일관성 모델 강한 일관성 즉시 일관성 요구 금융 거래 약한 일관성 지연된 일관성 허용 추천 시스템, 분석 9. 실무 사용 예시 도메인 목적 함께 사용되는 기술 효과 전자상거래 주문 - 결제 - 재고 - 배송 통합 Spring Boot, Kafka, MongoDB 99.9% 주문 처리 성공률 금융 서비스 계좌 이체 처리 Axon Framework, PostgreSQL 트랜잭션 무결성 보장 여행 예약 항공편 - 호텔 - 렌터카 예약 Camunda, RabbitMQ, MySQL 30% 예약 성공률 향상 배송 관리 주문 - 포장 - 배송 - 추적 Apache Camel, Redis, Cassandra 실시간 배송 상태 추적 10. 활용 사례 전자상거래 주문 처리 시스템 시스템 구성:\nOrder Service (주문 관리) Payment Service (결제 처리) Inventory Service (재고 관리) Shipping Service (배송 관리) Notification Service (알림 서비스) 시스템 구성 다이어그램:\ngraph LR A[Web Frontend] --\u003e B[API Gateway] B --\u003e C[Order Service] B --\u003e D[Payment Service] B --\u003e E[Inventory Service] B --\u003e F[Shipping Service] B --\u003e G[Notification Service] C --\u003e H[(Order DB)] D --\u003e I[(Payment DB)] E --\u003e J[(Inventory DB)] F --\u003e K[(Shipping DB)] G --\u003e L[(Notification DB)] M[Message Broker] --\u003e C M --\u003e D M --\u003e E M --\u003e F M --\u003e G Workflow:\n고객이 주문 생성 요청 Order Service 가 주문을 PENDING 상태로 생성 Payment Service 가 결제 처리 Inventory Service 가 재고 차감 Shipping Service 가 배송 준비 Notification Service 가 고객에게 알림 발송 역할:\n분산 트랜잭션 조정 실패 시 자동 보상 서비스 간 느슨한 결합 유지 기존 방식과의 차이점:\n2PC 대비 25% 성능 향상 서비스 장애 시 부분 복구 가능 수평 확장성 개선 11. 구현 예시 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 import asyncio from enum import Enum from dataclasses import dataclass from typing import List, Dict, Optional import uuid class SagaStatus(Enum): STARTED = \"STARTED\" COMPLETED = \"COMPLETED\" COMPENSATING = \"COMPENSATING\" FAILED = \"FAILED\" @dataclass class OrderData: customer_id: str product_id: str quantity: int amount: float @dataclass class SagaStep: step_id: str service_name: str action: str compensating_action: str status: str = \"PENDING\" result: Dict = None class OrderProcessingSaga: def __init__(self): self.saga_id = str(uuid.uuid4()) self.status = SagaStatus.STARTED self.steps: List[SagaStep] = [] self.completed_steps: List[str] = [] async def execute_order_saga(self, order_data: OrderData): \"\"\"주문 처리 사가 실행\"\"\" try: # Step 1: 주문 생성 order_step = SagaStep( step_id=\"1\", service_name=\"OrderService\", action=\"create_order\", compensating_action=\"cancel_order\" ) order_result = await self.create_order(order_data) order_step.result = order_result order_step.status = \"COMPLETED\" self.steps.append(order_step) self.completed_steps.append(\"1\") # Step 2: 결제 처리 payment_step = SagaStep( step_id=\"2\", service_name=\"PaymentService\", action=\"process_payment\", compensating_action=\"refund_payment\" ) payment_result = await self.process_payment( order_result['order_id'], order_data.amount ) payment_step.result = payment_result payment_step.status = \"COMPLETED\" self.steps.append(payment_step) self.completed_steps.append(\"2\") # Step 3: 재고 차감 inventory_step = SagaStep( step_id=\"3\", service_name=\"InventoryService\", action=\"reserve_inventory\", compensating_action=\"release_inventory\" ) inventory_result = await self.reserve_inventory( order_data.product_id, order_data.quantity ) inventory_step.result = inventory_result inventory_step.status = \"COMPLETED\" self.steps.append(inventory_step) self.completed_steps.append(\"3\") # Step 4: 배송 준비 shipping_step = SagaStep( step_id=\"4\", service_name=\"ShippingService\", action=\"prepare_shipment\", compensating_action=\"cancel_shipment\" ) shipping_result = await self.prepare_shipment( order_result['order_id'] ) shipping_step.result = shipping_result shipping_step.status = \"COMPLETED\" self.steps.append(shipping_step) self.completed_steps.append(\"4\") self.status = SagaStatus.COMPLETED return {\"status\": \"SUCCESS\", \"saga_id\": self.saga_id} except Exception as e: print(f\"사가 실행 중 오류 발생: {e}\") await self.compensate() return {\"status\": \"FAILED\", \"saga_id\": self.saga_id, \"error\": str(e)} async def compensate(self): \"\"\"보상 트랜잭션 실행\"\"\" self.status = SagaStatus.COMPENSATING # 완료된 단계를 역순으로 보상 for step_id in reversed(self.completed_steps): step = next(s for s in self.steps if s.step_id == step_id) try: if step.service_name == \"ShippingService\": await self.cancel_shipment(step.result['shipment_id']) elif step.service_name == \"InventoryService\": await self.release_inventory( step.result['product_id'], step.result['quantity'] ) elif step.service_name == \"PaymentService\": await self.refund_payment(step.result['payment_id']) elif step.service_name == \"OrderService\": await self.cancel_order(step.result['order_id']) step.status = \"COMPENSATED\" print(f\"Step {step_id} 보상 완료\") except Exception as e: print(f\"보상 트랜잭션 실패 - Step {step_id}: {e}\") step.status = \"COMPENSATION_FAILED\" self.status = SagaStatus.FAILED # 각 서비스 메서드들 (실제로는 HTTP 호출) async def create_order(self, order_data: OrderData): \"\"\"주문 생성 서비스 호출\"\"\" # 시뮬레이션: 주문 서비스 API 호출 await asyncio.sleep(0.1) order_id = str(uuid.uuid4()) print(f\"주문 생성 완료: {order_id}\") return {\"order_id\": order_id, \"status\": \"PENDING\"} async def process_payment(self, order_id: str, amount: float): \"\"\"결제 처리 서비스 호출\"\"\" await asyncio.sleep(0.1) # 10% 확률로 결제 실패 시뮬레이션 if asyncio.get_event_loop().time() % 10 \u003c 1: raise Exception(\"결제 처리 실패\") payment_id = str(uuid.uuid4()) print(f\"결제 처리 완료: {payment_id}\") return {\"payment_id\": payment_id, \"amount\": amount} async def reserve_inventory(self, product_id: str, quantity: int): \"\"\"재고 예약 서비스 호출\"\"\" await asyncio.sleep(0.1) print(f\"재고 예약 완료: {product_id}, 수량: {quantity}\") return {\"product_id\": product_id, \"quantity\": quantity} async def prepare_shipment(self, order_id: str): \"\"\"배송 준비 서비스 호출\"\"\" await asyncio.sleep(0.1) shipment_id = str(uuid.uuid4()) print(f\"배송 준비 완료: {shipment_id}\") return {\"shipment_id\": shipment_id, \"order_id\": order_id} # 보상 트랜잭션 메서드들 async def cancel_order(self, order_id: str): await asyncio.sleep(0.1) print(f\"주문 취소 완료: {order_id}\") async def refund_payment(self, payment_id: str): await asyncio.sleep(0.1) print(f\"결제 환불 완료: {payment_id}\") async def release_inventory(self, product_id: str, quantity: int): await asyncio.sleep(0.1) print(f\"재고 해제 완료: {product_id}, 수량: {quantity}\") async def cancel_shipment(self, shipment_id: str): await asyncio.sleep(0.1) print(f\"배송 취소 완료: {shipment_id}\") # 사용 예시 async def main(): \"\"\"사가 패턴 실행 예시\"\"\" saga = OrderProcessingSaga() order_data = OrderData( customer_id=\"customer_123\", product_id=\"product_456\", quantity=2, amount=99.99 ) print(\"=== 주문 처리 사가 시작 ===\") result = await saga.execute_order_saga(order_data) print(f\"\\n=== 사가 실행 결과 ===\") print(f\"상태: {result['status']}\") print(f\"사가 ID: {result['saga_id']}\") if result['status'] == 'FAILED': print(f\"오류: {result.get('error', 'Unknown error')}\") print(f\"\\n=== 사가 단계 상세 ===\") for step in saga.steps: print(f\"Step {step.step_id} ({step.service_name}): {step.status}\") # 실행 if __name__ == \"__main__\": asyncio.run(main()) 12. 도전 과제 기술적 도전 과제 카테고리 과제 원인 영향 탐지 및 진단 예방 방법 해결 방법 및 기법 성능 지연 시간 증가 다단계 비동기 처리 사용자 경험 저하 APM 도구, 분산 추적 병렬 처리, 캐싱 비동기 최적화, 배치 처리 복잡성 디버깅 어려움 분산 실행 환경 개발 생산성 저하 로그 집계, 상관관계 ID 표준화, 문서화 통합 모니터링 플랫폼 일관성 데이터 이상 현상 동시성 제어 부족 비즈니스 규칙 위반 데이터 검증, 감사 격리 수준 조정 시맨틱 락, 버전 관리 운영적 도전 과제 카테고리 과제 원인 영향 탐지 및 진단 예방 방법 해결 방법 및 기법 모니터링 상태 추적 복잡성 분산된 트랜잭션 상태 장애 대응 지연 대시보드, 알림 시스템 중앙화된 로깅 실시간 모니터링, SLA 관리 보안 분산 인증/인가 서비스 간 통신 보안 보안 취약점 노출 보안 감사, 침입 탐지 제로 트러스트 아키텍처 mTLS, JWT 토큰 관리 13. 실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점 구분 고려사항 설명 권장사항 설계 보상 트랜잭션 설계 모든 단계에 대한 보상 로직 필요 멱등성 보장, 간단한 보상 로직 설계 구현 이벤트 순서 보장 메시지 순서가 비즈니스 로직에 영향 파티션 키 활용, 순서 보장 메커니즘 운영 장애 처리 전략 부분 실패 상황 대응 방안 Circuit Breaker, Bulkhead 패턴 적용 테스트 분산 테스트 여러 서비스 간 통합 테스트 복잡 컨트랙트 테스트, 카오스 엔지니어링 모니터링 분산 추적 트랜잭션 전체 흐름 가시성 OpenTelemetry, Jaeger 활용 14. 최적화하기 위한 고려사항 및 주의할 점 구분 고려사항 설명 권장사항 성능 비동기 처리 최적화 불필요한 대기 시간 최소화 병렬 실행 가능한 단계 식별 메모리 사가 상태 관리 장기 실행 사가의 메모리 사용량 상태 외부화, 압축 저장 네트워크 메시지 크기 최적화 이벤트 페이로드 크기 최소화 참조 기반 메시지, 압축 적용 데이터베이스 트랜잭션 격리 수준 성능과 일관성 간 트레이드오프 비즈니스 요구사항에 맞는 격리 수준 선택 캐싱 중간 결과 캐싱 재계산 비용 절약 Redis, Hazelcast 활용 15. 기타 사항 새로운 기술 트렌드 서버리스 사가: AWS Step Functions, Azure Logic Apps 를 활용한 서버리스 사가 구현 이벤트 소싱과의 결합: 이벤트 스토어 기반 사가 상태 관리 AI/ML 통합: 사가 실행 패턴 분석을 통한 최적화 자동화 GraphQL 연동: GraphQL Federation 과 사가 패턴의 통합 산업별 특화 패턴 금융: 규제 요구사항을 고려한 감사 추적 강화 전자상거래: 실시간 재고 관리와 사가 패턴 결합 헬스케어: HIPAA 준수를 위한 보안 강화 사가 IoT: 대용량 센서 데이터 처리를 위한 스트리밍 사가 주목할 새로운 개발 Temporal.io: 분산 실행 플랫폼을 통한 사가 구현 단순화 Conductor: Netflix 에서 개발한 워크플로우 오케스트레이션 엔진 Camunda 8: 클라우드 네이티브 워크플로우 엔진 16. 주제와 관련하여 주목할 내용 카테고리 주제 항목 설명 패턴 관련 패턴 CQRS 명령과 조회 분리로 사가와 함께 사용 Event Sourcing 이벤트 기반 상태 관리 Outbox Pattern 트랜잭션과 메시지 발행의 원자성 보장 기술 메시징 Apache Kafka 고성능 이벤트 스트리밍 플랫폼 RabbitMQ 신뢰성 높은 메시지 브로커 Amazon EventBridge 서버리스 이벤트 버스 프레임워크 구현 도구 Axon Framework Java 기반 CQRS/Event Sourcing Camunda BPM 기반 워크플로우 엔진 Temporal 분산 애플리케이션 오케스트레이션 17. 주제와 관련하여 반드시 학습해야할 내용 카테고리 주제 항목 설명 기초 이론 분산 시스템 CAP 정리 일관성, 가용성, 파티션 내성의 트레이드오프 ACID vs BASE 전통적 트랜잭션과 분산 트랜잭션 모델 비교 설계 패턴 마이크로서비스 Database per Service 서비스별 독립적 데이터베이스 관리 API Gateway 서비스 간 통신 관리 구현 기술 메시징 패턴 Publish-Subscribe 비동기 이벤트 기반 통신 Message Queuing 신뢰성 있는 메시지 전달 운영 관리 모니터링 Distributed Tracing 분산 환경에서의 요청 추적 Circuit Breaker 장애 전파 방지 패턴 용어 정리 카테고리 용어 설명 핵심 개념 Saga 분산 트랜잭션을 로컬 트랜잭션 시퀀스로 관리하는 패턴 Compensating Transaction 이전 단계의 변경사항을 되돌리는 보상 트랜잭션 Eventual Consistency 시간이 지나면서 모든 노드가 일관된 상태에 도달하는 모델 구현 방식 Choreography 중앙 조정자 없이 서비스 간 이벤트로 협력하는 방식 Orchestration 중앙 코디네이터가 트랜잭션 흐름을 관리하는 방식 Saga Execution Coordinator 사가 실행을 조정하는 중앙 컴포넌트 트랜잭션 Pivot Transaction 되돌릴 수 없는 결정점이 되는 트랜잭션 Idempotency 동일한 연산을 여러 번 수행해도 결과가 같은 성질 메시징 Event Bus 이벤트를 라우팅하고 전달하는 메시징 인프라 Message Broker 서비스 간 메시지 전달을 중재하는 미들웨어 모니터링 Distributed Tracing 분산 시스템에서 요청의 전체 경로를 추적하는 기술 Correlation ID 분산 환경에서 관련된 이벤트들을 연결하는 식별자 참고 및 출처 Microservices Pattern: Saga Azure Architecture Center - Saga Design Pattern Baeldung - Saga Pattern in Microservices AWS Prescriptive Guidance - Saga Pattern Temporal.io - Mastering Saga Patterns GeeksforGeeks - SAGA Design Pattern Orkes Platform - Saga Pattern in Distributed Systems Saga Pattern 은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다.\nSaga Pattern 은 여러 서비스에 걸친 데이터 일관성을 유지하기 위해 사용된다.\n각 서비스의 로컬 트랜잭션을 순차적으로 실행하며, 실패 시 보상 트랜잭션을 통해 일관성을 유지한다.\n주요 특징:\n분산 환경에서의 트랜잭션 관리 순차적인 로컬 트랜잭션 실행 실패 시 보상 트랜잭션 실행 Saga Pattern 의 구현 방식 Saga Pattern 은 크게 두 가지 방식으로 구현할 수 있다:\nChoreography-based Saga 각 서비스가 이벤트를 발행하고 구독하여 트랜잭션을 진행 중앙 조정자 없이 서비스 간 직접 통신\n장점: 구현이 간단하고 이해하기 쉬움 서비스 간 결합도가 낮음\n단점: 복잡한 워크플로우에서는 추적이 어려울 수 있음 순환 종속성 발생 가능성 https://microservices.io/patterns/data/saga.html\nOrchestration-based Saga 중앙 조정자 (Orchestrator) 가 트랜잭션 흐름을 관리 Orchestrator 가 각 서비스에 명령을 전달하고 응답을 처리\n장점: 복잡한 워크플로우 관리에 적합 트랜잭션 추적이 용이\n단점: 추가적인 서비스 (Orchestrator) 구현 필요 Orchestrator 가 단일 실패 지점이 될 수 있음 https://microservices.io/patterns/data/saga.html\nSaga Pattern 구현 단계 트랜잭션 정의: 전체 비즈니스 프로세스를 단계별로 정의 보상 트랜잭션 설계: 각 단계의 실패 시 수행할 보상 작업 정의 이벤트 설계: 서비스 간 통신을 위한 이벤트 정의 상태 관리: 각 트랜잭션의 상태를 추적하고 관리할 방법 구현 오류 처리: 네트워크 오류, 타임아웃 등의 예외 상황 처리 로직 구현 사용 예시 주문 처리 시스템을 예로 들어보자:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 public interface Saga { // Saga의 각 단계를 정의 void execute(); // 실패 시 보상 트랜잭션 실행 void compensate(); } // 주문 처리를 위한 Saga 구현 public class OrderSaga implements Saga { private final OrderService orderService; private final PaymentService paymentService; private final InventoryService inventoryService; private final List\u003cSagaStep\u003e completedSteps = new ArrayList\u003c\u003e(); @Override public void execute() { try { // 1단계: 주문 생성 Order order = orderService.createOrder(); completedSteps.add(new OrderCreationStep(order)); // 2단계: 결제 처리 Payment payment = paymentService.processPayment(order); completedSteps.add(new PaymentProcessingStep(payment)); // 3단계: 재고 감소 inventoryService.decreaseStock(order); completedSteps.add(new StockDecrementStep(order)); } catch (Exception e) { // 오류 발생 시 보상 트랜잭션 실행 compensate(); throw e; } } @Override public void compensate() { // 실행된 단계들을 역순으로 보상 처리 for (int i = completedSteps.size() - 1; i \u003e= 0; i--) { completedSteps.get(i).compensate(); } } } 각 단계별 보상 트랙잭션 구현:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public interface SagaStep { void execute(); void compensate(); } public class OrderCreationStep implements SagaStep { private final Order order; private final OrderService orderService; @Override public void execute() { orderService.createOrder(order); } @Override public void compensate() { orderService.cancelOrder(order.getId()); } } public class PaymentStep implements SagaStep { private final Payment payment; private final PaymentService paymentService; @Override public void execute() { paymentService.processPayment(payment); } @Override public void compensate() { paymentService.refundPayment(payment.getId()); } } 각 단계는 독립적인 서비스에서 처리되며, 실패 시 이전 단계의 작업을 취소하는 보상 트랜잭션을 실행한다.\n주의사항 데이터 일관성: 최종적 일관성 (eventual consistency) 을 목표로 함 멱등성: 같은 요청이 여러 번 실행되어도 결과가 동일해야 함 타임아웃 처리: 장기 실행 트랜잭션의 경우 적절한 타임아웃 설정 필요 Saga Pattern 은 복잡한 분산 트랜잭션을 관리하는 강력한 도구이지만, 구현 복잡도가 높아질 수 있으므로 신중한 설계와 테스트가 필요하다.\n참고 및 출처 ","wordCount":"7452","inLanguage":"en","image":"https://buenhyden.github.io/images","datePublished":"2024-11-15T10:06:00Z","dateModified":"2024-11-15T10:06:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://buenhyden.github.io/posts/software-engineering/design-and-architecture/architecture-styles-and-patterns/architecture-patterns/event-and-messaging-patterns/saga-pattern/saga/"},"publisher":{"@type":"Organization","name":"hyunyoun's Blog","logo":{"@type":"ImageObject","url":"https://buenhyden.github.io/favicons/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a></div><h1 class="post-title entry-hint-parent">Saga Pattern</h1><div class=post-description>Saga Pattern은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다.</div><div class=post-meta><span title='2024-11-15 10:06:00 +0000 UTC'>November 15, 2024</span>&nbsp;·&nbsp;35 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/buenhyden/blog-data/main/content/posts/Software%20Engineering/Design%20and%20Architecture/Architecture%20Styles%20and%20Patterns/Architecture%20Patterns/Event%20and%20Messaging%20Patterns/Saga%20Pattern/Saga.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#saga-pattern>Saga Pattern</a></li><li><a href=#1-태그>1. 태그</a></li><li><a href=#2-분류-구조-분석>2. 분류 구조 분석</a></li><li><a href=#3-요약-200-자-내외>3. 요약 (200 자 내외)</a></li><li><a href=#4-개요-250-자-내외>4. 개요 (250 자 내외)</a></li><li><a href=#5-핵심-개념>5. 핵심 개념</a></li><li><a href=#6-조사-내용-주요-항목별-정리>6. 조사 내용 (주요 항목별 정리)</a><ul><li><a href=#배경>배경</a></li><li><a href=#목적-및-필요성>목적 및 필요성</a></li><li><a href=#주요-기능-및-역할>주요 기능 및 역할</a></li><li><a href=#특징>특징</a></li><li><a href=#핵심-원칙>핵심 원칙</a></li><li><a href=#주요-원리-및-작동-원리>주요 원리 및 작동 원리</a></li><li><a href=#구조-및-아키텍처>구조 및 아키텍처</a></li><li><a href=#구현-기법>구현 기법</a></li><li><a href=#장점>장점</a></li><li><a href=#단점과-문제점-그리고-해결방안>단점과 문제점 그리고 해결방안</a></li><li><a href=#도전-과제>도전 과제</a></li><li><a href=#분류-기준에-따른-종류-및-유형>분류 기준에 따른 종류 및 유형</a></li><li><a href=#실무-사용-예시>실무 사용 예시</a></li><li><a href=#활용-사례>활용 사례</a></li><li><a href=#구현-예시-javascript>구현 예시 (JavaScript)</a></li><li><a href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점</a></li><li><a href=#최적화하기-위한-고려사항-및-주의할-점>최적화하기 위한 고려사항 및 주의할 점</a></li><li><a href=#기타-사항>기타 사항</a></li></ul></li><li><a href=#7-추가-조사-내용>7. 추가 조사 내용</a></li><li><a href=#8-주목할-내용>8. 주목할 내용</a></li><li><a href=#9-반드시-학습해야-할-내용>9. 반드시 학습해야 할 내용</a></li><li><a href=#10-용어-정리>10. 용어 정리</a></li><li><a href=#11-참고-및-출처>11. 참고 및 출처</a></li><li><a href=#-태그>🏷 태그</a></li><li><a href=#분류-계층-적절성-분석>분류 계층 적절성 분석</a></li><li><a href=#요약-200-자-이내>요약 (200 자 이내)</a></li><li><a href=#개요-250-자-이내>개요 (250 자 이내)</a></li><li><a href=#5-핵심-개념-및-실무-구현-요소>5. 핵심 개념 및 실무 구현 요소</a><ul><li><a href=#핵심-개념>핵심 개념</a></li><li><a href=#실무-구현-요소>실무 구현 요소</a></li></ul></li><li><a href=#-6-다른-조사-항목-대응-여부>🎯 6. 다른 조사 항목 대응 여부</a></li><li><a href=#다음-단계-제안>다음 단계 제안</a></li><li><a href=#1-구조-및-아키텍처--구성-요소>1. 구조 및 아키텍처 + 구성 요소</a></li><li><a href=#2-핵심-원리--작동-원리>2. 핵심 원리 & 작동 원리</a></li><li><a href=#3-구현-기법>3. 구현 기법</a></li><li><a href=#4-실무-사용-예시-및-활용-사례>4. 실무 사용 예시 및 활용 사례</a><ul><li><a href=#예시-주문---재고---결제-서비스-saga>예시: 주문 - 재고 - 결제 서비스 Saga</a></li><li><a href=#예시-kafka--spring-boot-choreography>예시: Kafka + Spring Boot Choreography</a></li></ul></li><li><a href=#5-구현-예시-java-spring-boot--kafka-채팅-축약>5. 구현 예시 (Java Spring Boot + Kafka, 채팅 축약)</a></li><li><a href=#6-장단점-요약>6. 장단점 요약</a></li><li><a href=#-7-장점--단점>✅ 7. 장점 & 단점</a></li><li><a href=#-8-도전-과제-challenges>🎯 8. 도전 과제 (Challenges)</a></li><li><a href=#-9-분류-기준에-따른-종류-및-유형>📋 9. 분류 기준에 따른 종류 및 유형</a></li><li><a href=#-10-실무-사용-예시>🧪 10. 실무 사용 예시</a></li><li><a href=#-11-구현-예시-python---orchestration-기반>🧩 11. 구현 예시 (Python - Orchestration 기반)</a></li><li><a href=#다음으로-다뤄볼-수-있는-내용-선택>다음으로 다뤄볼 수 있는 내용 (선택)</a></li><li><a href=#-choreography-패턴-sagapython--rabbitmq-예시>🧪 Choreography 패턴 Saga–Python + RabbitMQ 예시</a><ul><li><a href=#1-메시지-구조-정의-eventspy>1. 메시지 구조 정의 (<code>events.py</code>)</a></li><li><a href=#2-pubsub-라이브러리-설정-messagingpy>2. Pub/Sub 라이브러리 설정 (<code>messaging.py</code>)</a></li><li><a href=#3-서비스-a주문-생성>3. 서비스 A–주문 생성</a></li><li><a href=#4-서비스-b결제-처리-및-실패성공-이벤트-발행>4. 서비스 B–결제 처리 및 실패/성공 이벤트 발행</a></li><li><a href=#5-서비스-c재고-예약-및-보상-처리>5. 서비스 C–재고 예약 및 보상 처리</a></li><li><a href=#-설명-요약>✅ 설명 요약</a></li></ul></li><li><a href=#-보완-포인트-및-개선-방향>💡 보완 포인트 및 개선 방향</a></li><li><a href=#1-분산-트레이싱의-목적과-구성-요소->1. 분산 트레이싱의 목적과 구성 요소 🎯</a></li><li><a href=#2-opentelemetry-기반-구현-예-python-saga--flask--rabbitmq>2. OpenTelemetry 기반 구현 예 (Python Saga + Flask + RabbitMQ)</a></li><li><a href=#3-주요-트레이싱-best-practices>3. 주요 트레이싱 Best Practices</a></li><li><a href=#4-왜-중요한가>4. 왜 중요한가?</a></li><li><a href=#5-고급-기능-trace-compression--non-invasive-tracing>5. 고급 기능: Trace Compression & Non-invasive Tracing</a></li><li><a href=#6-구현-시-유의사항>6. 구현 시 유의사항</a></li><li><a href=#-요약>✅ 요약</a></li><li><a href=#1-조사-태그-및-분류-분석>1. 조사 태그 및 분류 분석</a></li><li><a href=#2-핵심-개념-및-이론>2. 핵심 개념 및 이론</a><ul><li><a href=#핵심-개념-1>핵심 개념</a></li><li><a href=#실무-구현-요소-1>실무 구현 요소</a></li><li><a href=#배경-1>배경</a></li><li><a href=#목적-및-필요성-1>목적 및 필요성</a></li></ul></li><li><a href=#3-구조-및-아키텍처>3. 구조 및 아키텍처</a><ul><li><a href=#필수-구성요소>필수 구성요소</a></li><li><a href=#선택-구성요소>선택 구성요소</a></li><li><a href=#아키텍처-다이어그램>아키텍처 다이어그램</a></li></ul></li><li><a href=#4-주요-원리-및-작동-원리>4. 주요 원리 및 작동 원리</a><ul><li><a href=#주요-원리>주요 원리</a></li><li><a href=#작동-원리-다이어그램>작동 원리 다이어그램</a></li></ul></li><li><a href=#5-구현-기법>5. 구현 기법</a><ul><li><a href=#1-코레오그래피-choreography-패턴>1. 코레오그래피 (Choreography) 패턴</a></li><li><a href=#2-오케스트레이션-orchestration-패턴>2. 오케스트레이션 (Orchestration) 패턴</a></li></ul></li><li><a href=#6-장점>6. 장점</a></li><li><a href=#7-단점과-문제점-그리고-해결방안>7. 단점과 문제점 그리고 해결방안</a><ul><li><a href=#단점>단점</a></li><li><a href=#문제점>문제점</a></li></ul></li><li><a href=#8-분류-기준에-따른-종류-및-유형>8. 분류 기준에 따른 종류 및 유형</a></li><li><a href=#9-실무-사용-예시>9. 실무 사용 예시</a></li><li><a href=#10-활용-사례>10. 활용 사례</a><ul><li><a href=#전자상거래-주문-처리-시스템>전자상거래 주문 처리 시스템</a></li></ul></li><li><a href=#11-구현-예시>11. 구현 예시</a></li><li><a href=#12-도전-과제>12. 도전 과제</a><ul><li><a href=#기술적-도전-과제>기술적 도전 과제</a></li><li><a href=#운영적-도전-과제>운영적 도전 과제</a></li></ul></li><li><a href=#13-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>13. 실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점</a></li><li><a href=#14-최적화하기-위한-고려사항-및-주의할-점>14. 최적화하기 위한 고려사항 및 주의할 점</a></li><li><a href=#15-기타-사항>15. 기타 사항</a><ul><li><a href=#새로운-기술-트렌드>새로운 기술 트렌드</a></li><li><a href=#산업별-특화-패턴>산업별 특화 패턴</a></li><li><a href=#주목할-새로운-개발>주목할 새로운 개발</a></li></ul></li><li><a href=#16-주제와-관련하여-주목할-내용>16. 주제와 관련하여 주목할 내용</a></li><li><a href=#17-주제와-관련하여-반드시-학습해야할-내용>17. 주제와 관련하여 반드시 학습해야할 내용</a></li><li><a href=#용어-정리>용어 정리</a></li><li><a href=#참고-및-출처>참고 및 출처</a><ul><li><a href=#saga-pattern-의-구현-방식>Saga Pattern 의 구현 방식</a></li><li><a href=#saga-pattern-구현-단계>Saga Pattern 구현 단계</a></li><li><a href=#사용-예시>사용 예시</a></li><li><a href=#주의사항>주의사항</a></li></ul></li><li><a href=#참고-및-출처-1>참고 및 출처</a></li></ul></nav></div></details></div><div class=post-content><h2 id=saga-pattern>Saga Pattern<a hidden class=anchor aria-hidden=true href=#saga-pattern>#</a></h2><p>아래는 &ldquo;Saga(사가)&rdquo; 패턴에 대한 체계적이고 포괄적인 조사 결과입니다.</p><hr><h2 id=1-태그>1. 태그<a hidden class=anchor aria-hidden=true href=#1-태그>#</a></h2><ul><li><strong>Saga-Pattern</strong></li><li><strong>Distributed-Transactions</strong></li><li><strong>Event-Driven-Architecture</strong></li><li><strong>Microservices</strong></li></ul><hr><h2 id=2-분류-구조-분석>2. 분류 구조 분석<a hidden class=anchor aria-hidden=true href=#2-분류-구조-분석>#</a></h2><p><strong>계층 구조:</strong><br>Computer Science and Engineering > Software Engineering > Design and Architecture > Architecture Styles and Patterns > Architecture Patterns > Data Management</p><p><strong>분석 및 근거:</strong><br>Saga 패턴은 마이크로서비스, 분산 시스템 환경에서 여러 서비스에 걸친 트랜잭션의 데이터 일관성을 보장하기 위한 아키텍처 패턴으로, &ldquo;Architecture Styles and Patterns&rdquo; 하위의 &ldquo;Architecture Patterns&rdquo; 에 적합합니다. 또한, 데이터 관리 (Data Management) 와도 밀접하게 연관되어 있으므로 하위로 포함하는 것이 타당합니다 <a href="https://blog.bytebytego.com/p/the-saga-pattern?utm_source=chatgpt.com" title="The Saga Pattern - ByteByteGo Newsletter">1</a><a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">3</a>.</p><hr><h2 id=3-요약-200-자-내외>3. 요약 (200 자 내외)<a hidden class=anchor aria-hidden=true href=#3-요약-200-자-내외>#</a></h2><p>Saga 패턴은 여러 서비스에 걸친 비즈니스 트랜잭션을 일련의 로컬 트랜잭션으로 분해해, 실패 시 보상 트랜잭션을 통해 데이터 일관성을 보장하는 분산 트랜잭션 관리 패턴이다.</p><hr><h2 id=4-개요-250-자-내외>4. 개요 (250 자 내외)<a hidden class=anchor aria-hidden=true href=#4-개요-250-자-내외>#</a></h2><p>Saga 패턴은 마이크로서비스 환경에서 여러 서비스에 걸친 트랜잭션을 일련의 로컬 트랜잭션으로 분해하고, 각 단계의 실패 시 보상 트랜잭션을 통해 데이터 일관성을 보장하는 아키텍처 패턴이다. 이는 분산 시스템에서 데이터베이스별 서비스 구조에서 데이터 일관성을 유지하는 데 필수적이다.</p><hr><h2 id=5-핵심-개념>5. 핵심 개념<a hidden class=anchor aria-hidden=true href=#5-핵심-개념>#</a></h2><ul><li><strong>로컬 트랜잭션:</strong> 각 서비스가 자체적으로 수행하는 트랜잭션.</li><li><strong>보상 트랜잭션 (Compensating Transaction):</strong> 로컬 트랜잭션 실패 시 이전 단계의 효과를 되돌리는 트랜잭션.</li><li><strong>트랜잭션 시퀀스:</strong> 여러 서비스에 걸친 트랜잭션을 순차적으로 실행.</li><li><strong>이벤트 기반 통신:</strong> 서비스 간 이벤트 또는 메시지를 통해 트랜잭션 진행.</li><li><strong>이벤텀 컨시스턴시 (Eventual Consistency):</strong> 전체 트랜잭션이 완료될 때까지 일시적으로 불일치가 발생할 수 있으나, 최종적으로 일관성 확보.</li></ul><p><strong>실무 구현 요소</strong></p><ul><li><strong>로컬 트랜잭션:</strong> 각 서비스가 담당하는 단일 트랜잭션 (필수)</li><li><strong>보상 트랜잭션:</strong> 실패 시 롤백을 위한 트랜잭션 (필수)</li><li><strong>오케스트레이터 (Orchestrator):</strong> 트랜잭션 흐름을 관리하는 중앙 컨트롤러 (선택, 오케스트레이션 방식)</li><li><strong>이벤트 버스/메시지 큐:</strong> 서비스 간 통신 수단 (선택, 이벤트 기반 구현 시)</li><li><strong>사가 로그 (Saga Log):</strong> 트랜잭션 진행 상태 기록 (선택, 장애 복구용)</li></ul><hr><h2 id=6-조사-내용-주요-항목별-정리>6. 조사 내용 (주요 항목별 정리)<a hidden class=anchor aria-hidden=true href=#6-조사-내용-주요-항목별-정리>#</a></h2><h3 id=배경>배경<a hidden class=anchor aria-hidden=true href=#배경>#</a></h3><p>마이크로서비스 아키텍처에서는 각 서비스가 독립적인 데이터베이스를 갖기 때문에, 여러 서비스에 걸친 트랜잭션을 단일 ACID 트랜잭션으로 처리할 수 없다. 이로 인해 데이터 일관성 문제가 발생하며, 이를 해결하기 위해 Saga 패턴이 등장했다 <a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">1</a><a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">4</a>.</p><h3 id=목적-및-필요성>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성>#</a></h3><ul><li><strong>분산 트랜잭션 관리:</strong> 여러 서비스에 걸친 트랜잭션의 데이터 일관성 보장.</li><li><strong>장애 복구:</strong> 트랜잭션 실패 시 보상 트랜잭션을 통해 롤백.</li><li><strong>확장성:</strong> 각 서비스가 독립적으로 동작, 확장성 보장.</li></ul><h3 id=주요-기능-및-역할>주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#주요-기능-및-역할>#</a></h3><ul><li><strong>로컬 트랜잭션 실행:</strong> 각 서비스가 담당하는 트랜잭션 수행.</li><li><strong>보상 트랜잭션 실행:</strong> 실패 시 이전 단계 롤백.</li><li><strong>트랜잭션 흐름 관리:</strong> 오케스트레이션 또는 코레오그래피 방식으로 트랜잭션 진행.</li></ul><h3 id=특징>특징<a hidden class=anchor aria-hidden=true href=#특징>#</a></h3><ul><li><strong>분산 트랜잭션:</strong> 여러 서비스에 걸친 트랜잭션 처리.</li><li><strong>보상 트랜잭션:</strong> 실패 시 롤백 가능.</li><li><strong>이벤텀 컨시스턴시:</strong> 전체 트랜잭션이 완료될 때까지 일시적 불일치 허용.</li><li><strong>이벤트 기반 통신:</strong> 서비스 간 메시지/이벤트로 트랜잭션 진행.</li></ul><h3 id=핵심-원칙>핵심 원칙<a hidden class=anchor aria-hidden=true href=#핵심-원칙>#</a></h3><ul><li><strong>로컬 트랜잭션의 원자성:</strong> 각 단계는 단일 서비스 내에서 원자적으로 수행.</li><li><strong>보상 트랜잭션의 명확성:</strong> 실패 시 롤백을 위한 보상 트랜잭션 명확히 정의.</li><li><strong>이벤트 기반 통신:</strong> 서비스 간 이벤트/메시지로 트랜잭션 진행.</li><li><strong>이벤텀 컨시스턴시:</strong> 전체 트랜잭션이 완료될 때까지 일시적 불일치 허용.</li></ul><h3 id=주요-원리-및-작동-원리>주요 원리 및 작동 원리<a hidden class=anchor aria-hidden=true href=#주요-원리-및-작동-원리>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Diagram: Saga Pattern Flow]
</span></span><span class=line><span class=cl>┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
</span></span><span class=line><span class=cl>│   Service A │ → │   Service B │ → │   Service C │ → │   Service D │
</span></span><span class=line><span class=cl>└─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘
</span></span><span class=line><span class=cl>      |                 |                 |                 |
</span></span><span class=line><span class=cl>      └────Compensate───┴────Compensate───┴────Compensate───┘
</span></span></code></pre></td></tr></table></div></div><p>각 서비스가 순차적으로 로컬 트랜잭션을 수행하고, 실패 시 이전 단계의 보상 트랜잭션을 실행해 롤백한다.</p><h3 id=구조-및-아키텍처>구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#구조-및-아키텍처>#</a></h3><ul><li><strong>로컬 트랜잭션:</strong> 각 서비스가 담당하는 단일 트랜잭션 (필수)</li><li><strong>보상 트랜잭션:</strong> 실패 시 롤백을 위한 트랜잭션 (필수)</li><li><strong>오케스트레이터 (Orchestrator):</strong> 트랜잭션 흐름을 관리하는 중앙 컨트롤러 (선택, 오케스트레이션 방식)</li><li><strong>이벤트 버스/메시지 큐:</strong> 서비스 간 통신 수단 (선택, 이벤트 기반 구현 시)</li><li><strong>사가 로그 (Saga Log):</strong> 트랜잭션 진행 상태 기록 (선택, 장애 복구용)</li></ul><p><strong>각 구성요소의 기능과 역할</strong></p><ul><li><strong>로컬 트랜잭션:</strong> 각 서비스가 담당하는 트랜잭션 수행.</li><li><strong>보상 트랜잭션:</strong> 실패 시 롤백을 위한 트랜잭션.</li><li><strong>오케스트레이터:</strong> 트랜잭션 흐름 관리, 실패 시 보상 트랜잭션 호출 (오케스트레이션 방식).</li><li><strong>이벤트 버스/메시지 큐:</strong> 서비스 간 트랜잭션 진행을 위한 통신 수단 (코레오그래피 방식).</li><li><strong>사가 로그:</strong> 트랜잭션 진행 상태 기록, 장애 복구용.</li></ul><h3 id=구현-기법>구현 기법<a hidden class=anchor aria-hidden=true href=#구현-기법>#</a></h3><ul><li><strong>오케스트레이션 (Orchestration):</strong> 중앙 오케스트레이터가 트랜잭션 흐름을 관리. 복잡한 트랜잭션에 적합 <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga.html?utm_source=chatgpt.com" title="Saga patterns - AWS Prescriptive Guidance">1</a><a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">6</a>.</li><li><strong>코레오그래피 (Choreography):</strong> 서비스가 이벤트를 통해 자율적으로 트랜잭션을 진행. 단순 트랜잭션에 적합 <a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">1</a><a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">4</a>.</li><li><strong>보상 트랜잭션:</strong> 실패 시 롤백을 위한 트랜잭션 구현.</li><li><strong>이벤트 버스/메시지 큐:</strong> 서비스 간 이벤트 기반 통신 구현.</li><li><strong>사가 로그:</strong> 트랜잭션 진행 상태 기록, 장애 복구 구현.</li></ul><p><strong>실제 예시 (시나리오):</strong></p><ul><li><strong>오케스트레이션:</strong> 오케스트레이터가 주문, 결제, 재고, 배송 서비스를 순차적으로 호출. 실패 시 보상 트랜잭션 실행.</li><li><strong>코레오그래피:</strong> 주문 서비스가 주문 이벤트 발행 → 결제 서비스가 결제 이벤트 발행 → 재고 서비스가 재고 이벤트 발행 → 배송 서비스가 배송 이벤트 발행. 실패 시 보상 트랜잭션 실행.</li></ul><h3 id=장점>장점<a hidden class=anchor aria-hidden=true href=#장점>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>특성 원인</th></tr></thead><tbody><tr><td>장점</td><td>데이터 일관성</td><td>여러 서비스에 걸친 트랜잭션의 일관성 보장</td><td>보상 트랜잭션, 로컬 트랜잭션 분리</td></tr><tr><td>장점</td><td>확장성</td><td>각 서비스가 독립적으로 동작, 확장성 보장</td><td>분산 아키텍처, 이벤트 기반 통신</td></tr><tr><td>장점</td><td>장애 복구</td><td>실패 시 보상 트랜잭션으로 롤백 가능</td><td>보상 트랜잭션, 사가 로그</td></tr><tr><td>장점</td><td>서비스 결합도 감소</td><td>서비스 간 느슨한 결합</td><td>이벤트 기반 통신, 오케스트레이션/코레오그래피</td></tr></tbody></table><h3 id=단점과-문제점-그리고-해결방안>단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#단점과-문제점-그리고-해결방안>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>단점</td><td>복잡성</td><td>트랜잭션 흐름 관리, 보상 트랜잭션 구현 복잡</td><td>오케스트레이션 도입, 문서화</td></tr><tr><td>단점</td><td>일시적 불일치</td><td>트랜잭션 완료 전 일시적 불일치 발생</td><td>이벤트 기반 통신, 이벤텀 컨시스턴시 수용</td></tr></tbody></table><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>문제점</td><td>보상 트랜잭션 실패</td><td>보상 트랜잭션 구현 미흡, 서비스 장애</td><td>데이터 불일치</td><td>로그 분석, 모니터링</td><td>보상 트랜잭션 명확히 정의, 테스트</td><td>보상 트랜잭션 재시도, 수동 개입</td></tr><tr><td>문제점</td><td>이벤트 중복/손실</td><td>네트워크 이슈, 메시지 큐 장애</td><td>트랜잭션 진행 불가</td><td>로그 분석, 메시지 큐 모니터링</td><td>이벤트 중복 처리, 메시지 큐 신뢰성 강화</td><td>이벤트 중복/손실 방지 메커니즘</td></tr></tbody></table><h3 id=도전-과제>도전 과제<a hidden class=anchor aria-hidden=true href=#도전-과제>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>도전 과제</td><td>대규모 시스템 적용</td><td>트랜잭션 단계 증가, 복잡성 증가</td><td>관리 어려움, 성능 저하</td><td>모니터링, 프로파일링</td><td>트랜잭션 단계 최소화, 오케스트레이션 도입</td><td>모듈화, 마이크로서비스 분리</td></tr><tr><td>도전 과제</td><td>트랜잭션 격리 부족</td><td>동시 트랜잭션 시 데이터 충돌</td><td>데이터 불일치</td><td>로그 분석, 모니터링</td><td>시맨틱 락, 커뮤터티브 업데이트</td><td>트랜잭션 격리 메커니즘 추가</td></tr><tr><td>도전 과제</td><td>팀 온보딩 및 코드 관리</td><td>아키텍처 복잡성, 팀원 이해 부족</td><td>개발 비용 증가, 일관성 저하</td><td>코드 리뷰, 문서화</td><td>교육, 예시 코드 제공</td><td>문서화, 코드 리뷰, 멘토링</td></tr></tbody></table><h3 id=분류-기준에-따른-종류-및-유형>분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-종류-및-유형>#</a></h3><table><thead><tr><th>분류 기준</th><th>종류/유형</th><th>설명</th></tr></thead><tbody><tr><td>구현 방식</td><td>오케스트레이션</td><td>중앙 오케스트레이터가 트랜잭션 흐름 관리</td></tr><tr><td>구현 방식</td><td>코레오그래피</td><td>서비스가 이벤트를 통해 자율적으로 트랜잭션 진행</td></tr><tr><td>적용 범위</td><td>전체 시스템</td><td>시스템 전체에 Saga 패턴 적용</td></tr><tr><td>적용 범위</td><td>도메인 단위</td><td>특정 도메인에만 Saga 패턴 적용</td></tr></tbody></table><h3 id=실무-사용-예시>실무 사용 예시<a hidden class=anchor aria-hidden=true href=#실무-사용-예시>#</a></h3><table><thead><tr><th>사용 목적</th><th>함께 사용하는 기술</th><th>효과</th></tr></thead><tbody><tr><td>데이터 일관성</td><td>Spring Boot, Node.js, Kafka</td><td>여러 서비스에 걸친 트랜잭션 일관성 보장</td></tr><tr><td>장애 복구</td><td>RabbitMQ, AWS Step Functions</td><td>실패 시 보상 트랜잭션으로 롤백 가능</td></tr><tr><td>확장성</td><td>마이크로서비스, 이벤트 버스</td><td>각 서비스가 독립적으로 동작, 확장성 보장</td></tr></tbody></table><h3 id=활용-사례>활용 사례<a hidden class=anchor aria-hidden=true href=#활용-사례>#</a></h3><p><strong>이커머스 주문 처리 시스템:</strong><br>주문, 결제, 재고, 배송 서비스가 각각 독립적인 데이터베이스를 갖고, Saga 패턴을 통해 주문 트랜잭션을 처리함.</p><ul><li><strong>시스템 구성:</strong><ul><li>주문 서비스: 주문 생성</li><li>결제 서비스: 결제 처리</li><li>재고 서비스: 재고 차감</li><li>배송 서비스: 배송 처리</li></ul></li><li><strong>Workflow:</strong><ul><li>주문 생성 → 결제 처리 → 재고 차감 → 배송 처리</li><li>실패 시 보상 트랜잭션 실행 (예: 결제 실패 시 주문 취소)</li></ul></li><li><strong>역할:</strong><ul><li>각 서비스: 로컬 트랜잭션 수행</li><li>오케스트레이터/이벤트 버스: 트랜잭션 흐름 관리</li></ul></li><li><strong>차이점:</strong><ul><li>기존 방식: 단일 트랜잭션으로 처리 불가, 데이터 일관성 문제 발생</li><li>Saga 패턴: 여러 서비스에 걸친 트랜잭션의 데이터 일관성 보장</li></ul></li></ul><h3 id=구현-예시-javascript>구현 예시 (JavaScript)<a hidden class=anchor aria-hidden=true href=#구현-예시-javascript>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34>34</a>
</span><span class=lnt id=hl-1-35><a class=lnlinks href=#hl-1-35>35</a>
</span><span class=lnt id=hl-1-36><a class=lnlinks href=#hl-1-36>36</a>
</span><span class=lnt id=hl-1-37><a class=lnlinks href=#hl-1-37>37</a>
</span><span class=lnt id=hl-1-38><a class=lnlinks href=#hl-1-38>38</a>
</span><span class=lnt id=hl-1-39><a class=lnlinks href=#hl-1-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 간단한 오케스트레이션 기반 Saga 예시
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>SagaOrchestrator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>services</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>services</span> <span class=o>=</span> <span class=nx>services</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>sagaLog</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>executeSaga</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>service</span> <span class=k>of</span> <span class=k>this</span><span class=p>.</span><span class=nx>services</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>service</span><span class=p>.</span><span class=nx>execute</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>sagaLog</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>service</span><span class=o>:</span> <span class=nx>service</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Saga completed successfully&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Saga failed, compensating...&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>sagaLog</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>services</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>compensate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>sagaLog</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>status</span> <span class=o>=</span> <span class=s1>&#39;compensated&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Saga compensated&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 서비스 예시
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>orderService</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;Order&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>execute</span><span class=o>:</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Order created&#39;</span><span class=p>);</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>compensate</span><span class=o>:</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Order cancelled&#39;</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>paymentService</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;Payment&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>execute</span><span class=o>:</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Payment processed&#39;</span><span class=p>);</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>compensate</span><span class=o>:</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Payment refunded&#39;</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>orchestrator</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SagaOrchestrator</span><span class=p>([</span><span class=nx>orderService</span><span class=p>,</span> <span class=nx>paymentService</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>orchestrator</span><span class=p>.</span><span class=nx>executeSaga</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>트랜잭션 단계 최소화</td><td>단계가 많을수록 복잡성 증가</td><td>트랜잭션 단계 최소화, 단순화</td></tr><tr><td>보상 트랜잭션 명확히 정의</td><td>실패 시 롤백을 위한 트랜잭션 명확히 정의</td><td>보상 트랜잭션 명확히 정의, 테스트</td></tr><tr><td>이벤트 기반 통신</td><td>서비스 간 이벤트 기반 통신 구현</td><td>이벤트 버스/메시지 큐 활용</td></tr><tr><td>모니터링 및 로깅</td><td>트랜잭션 진행 상태 모니터링</td><td>사가 로그, 모니터링 도구 활용</td></tr></tbody></table><h3 id=최적화하기-위한-고려사항-및-주의할-점>최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#최적화하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>트랜잭션 격리</td><td>동시 트랜잭션 시 데이터 충돌 방지</td><td>시맨틱 락, 커뮤터티브 업데이트</td></tr><tr><td>이벤트 중복/손실 방지</td><td>네트워크 이슈, 메시지 큐 장애 대비</td><td>이벤트 중복/손실 방지 메커니즘</td></tr><tr><td>성능 최적화</td><td>트랜잭션 단계 최소화, 병렬 처리</td><td>트랜잭션 단계 최소화, 병렬 처리</td></tr></tbody></table><h3 id=기타-사항>기타 사항<a hidden class=anchor aria-hidden=true href=#기타-사항>#</a></h3><ul><li><strong>이벤트 소싱과의 연계:</strong> Saga 패턴은 이벤트 소싱과 함께 사용 시 큰 시너지 효과.</li><li><strong>CQRS 와의 연계:</strong> Saga 패턴은 CQRS 와 함께 사용 시 복잡한 비즈니스 로직 구현에 유리.</li><li><strong>적용 범위:</strong> 모든 트랜잭션에 적용할 필요 없음, 복잡한 비즈니스 로직, 데이터 일관성이 중요한 곳에 적합.</li></ul><hr><h2 id=7-추가-조사-내용>7. 추가 조사 내용<a hidden class=anchor aria-hidden=true href=#7-추가-조사-내용>#</a></h2><ul><li><strong>Saga 패턴과 2PC(2-Phase Commit) 비교:</strong><ul><li><strong>2PC:</strong> 분산 트랜잭션을 위한 표준 프로토콜이지만, 마이크로서비스 환경에서는 확장성, 결합도 문제로 적합하지 않음.</li><li><strong>Saga 패턴:</strong> 보상 트랜잭션을 통해 데이터 일관성 보장, 확장성 및 결합도 문제 해결.</li></ul></li><li><strong>Saga 패턴과 이벤트 소싱:</strong><ul><li>이벤트 소싱은 상태 변경 이벤트를 저장해 복원, 감사, 분석에 활용.</li><li>Saga 패턴과 함께 사용 시 복잡한 비즈니스 로직 구현에 유리.</li></ul></li></ul><hr><h2 id=8-주목할-내용>8. 주목할 내용<a hidden class=anchor aria-hidden=true href=#8-주목할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>설계 패턴</td><td>Saga</td><td>보상 트랜잭션</td><td>실패 시 롤백을 위한 트랜잭션</td></tr><tr><td>설계 패턴</td><td>Saga</td><td>이벤트 기반 통신</td><td>서비스 간 이벤트/메시지로 트랜잭션 진행</td></tr><tr><td>실무 적용</td><td>Saga</td><td>오케스트레이션/코레오그래피</td><td>트랜잭션 흐름 관리 방식</td></tr><tr><td>실무 적용</td><td>Saga</td><td>이벤텀 컨시스턴시</td><td>트랜잭션 완료 전 일시적 불일치 허용</td></tr></tbody></table><hr><h2 id=9-반드시-학습해야-할-내용>9. 반드시 학습해야 할 내용<a hidden class=anchor aria-hidden=true href=#9-반드시-학습해야-할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>설계 원칙</td><td>Saga</td><td>보상 트랜잭션</td><td>실패 시 롤백을 위한 트랜잭션</td></tr><tr><td>설계 원칙</td><td>Saga</td><td>이벤트 기반 통신</td><td>서비스 간 이벤트/메시지로 트랜잭션 진행</td></tr><tr><td>실무 적용</td><td>Saga</td><td>오케스트레이션/코레오그래피</td><td>트랜잭션 흐름 관리 방식</td></tr><tr><td>실무 적용</td><td>Saga</td><td>이벤텀 컨시스턴시</td><td>트랜잭션 완료 전 일시적 불일치 허용</td></tr></tbody></table><hr><h2 id=10-용어-정리>10. 용어 정리<a hidden class=anchor aria-hidden=true href=#10-용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>설계 패턴</td><td>Saga</td><td>여러 서비스에 걸친 트랜잭션을 일련의 로컬 트랜잭션으로 분해해, 실패 시 보상 트랜잭션으로 데이터 일관성을 보장하는 패턴</td></tr><tr><td>설계 원칙</td><td>보상 트랜잭션</td><td>실패 시 롤백을 위한 트랜잭션</td></tr><tr><td>실무 적용</td><td>오케스트레이션</td><td>중앙 오케스트레이터가 트랜잭션 흐름을 관리하는 방식</td></tr><tr><td>실무 적용</td><td>코레오그래피</td><td>서비스가 이벤트를 통해 자율적으로 트랜잭션을 진행하는 방식</td></tr><tr><td>실무 적용</td><td>이벤텀 컨시스턴시</td><td>트랜잭션 완료 전 일시적 불일치 허용, 최종적으로 일관성 확보</td></tr></tbody></table><hr><h2 id=11-참고-및-출처>11. 참고 및 출처<a hidden class=anchor aria-hidden=true href=#11-참고-및-출처>#</a></h2><ul><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/saga>Saga Design Pattern - Azure Architecture Center | Microsoft Learn</a></li><li><a href=https://www.dremio.com/wiki/saga-pattern/>What is Saga Pattern? - Dremio</a></li><li><a href=https://microservices.io/patterns/data/saga.html>Pattern: Saga - Microservices.io</a></li><li><a href=https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga.html>Saga patterns - AWS Prescriptive Guidance</a></li><li><a href=https://doc.akka.io/concepts/saga-patterns.html>Saga patterns - Akka Documentation</a></li><li><a href=https://newsletter.systemdesigncodex.com/p/the-saga-pattern>The Saga Pattern - by Saurabh Dashora - System Design Codex</a></li><li><a href=https://www.redhat.com/en/blog/pros-and-cons-saga-architecture-pattern>The pros and cons of the Saga architecture pattern - Red Hat</a></li><li><a href=https://github.com/minghsu0107/saga-example>minghsu0107/saga-example - GitHub</a></li></ul><p>아래는 <strong>Saga 패턴</strong>에 대한 종합 정리입니다.</p><hr><h2 id=-태그>🏷 태그<a hidden class=anchor aria-hidden=true href=#-태그>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Distributed-Transactions, Compensating-Transactions, Orchestration-vs-Choreography, Event-Driven
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=분류-계층-적절성-분석>분류 계층 적절성 분석<a hidden class=anchor aria-hidden=true href=#분류-계층-적절성-분석>#</a></h2><p>&ldquo;Computer Science and Engineering → Software Engineering → Design and Architecture → Architecture Styles and Patterns → Architecture Patterns → Data Management&rdquo; 구조는 적절합니다. Saga 는 <strong>분산된 서비스 간의 데이터 정합성 유지</strong>를 위한 아키텍처 패턴으로, 데이터 중심의 관리 방식이므로 &ldquo;Data Management&rdquo; 하위에 위치시키는 것이 논리적으로 타당합니다. (<a href="https://microservices.io/patterns/data/saga.html?utm_source=chatgpt.com" title="Pattern: Saga - Microservices.io">microservices.io</a>, <a href="https://blog.bytebytego.com/p/the-saga-pattern?utm_source=chatgpt.com" title="The Saga Pattern - ByteByteGo Newsletter">blog.bytebytego.com</a>)</p><hr><h2 id=요약-200-자-이내>요약 (200 자 이내)<a hidden class=anchor aria-hidden=true href=#요약-200-자-이내>#</a></h2><p>Saga 는 분산 시스템에서 <strong>단일 트랜잭션을 여러 서비스의 로컬 트랜잭션 흐름으로 분해</strong>하고, 각 단계에서 실패 시 <strong>보상 (Compensation) 트랜잭션</strong>을 수행하여 전체 정합성을 유지하는 패턴입니다. <strong>Choreography</strong>(이벤트 발행 기반) 와 <strong>Orchestration</strong>(중앙 조정 방식) 의 두 방식이 있으며, 결국 <strong>2PC 의 단점을 보완</strong>하는 대안입니다. (<a href="https://microservices.io/patterns/data/saga.html?utm_source=chatgpt.com" title="Pattern: Saga - Microservices.io">microservices.io</a>)</p><hr><h2 id=개요-250-자-이내>개요 (250 자 이내)<a hidden class=anchor aria-hidden=true href=#개요-250-자-이내>#</a></h2><p>Saga 패턴은 <strong>마이크로서비스 아키텍처에서의 장기 분산 트랜잭션</strong> 해결책으로, 로컬 트랜잭션을 순차적으로 실행하고 실패 시 ** 각 서비스에 정의된 보상 로직 (Compensating Transaction)** 을 호출해 이전 상태로 복구합니다. 이벤트 기반 분산 (Choreography) 또는 중앙 조정 (Orchestration) 방식으로 구현할 수 있으며, 기존 2PC 방식의 <strong>블로킹, 단일 실패 지점 문제</strong>를 회피하면서도 데이터 일관성을 확보합니다. 특히 <strong>Idempotency, 순서 보장, 장애 대응, 모니터링</strong> 등 운영 트레이드오프 요소를 고려한 설계가 필요합니다. (<a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">medium.com</a>)</p><hr><h2 id=5-핵심-개념-및-실무-구현-요소>5. 핵심 개념 및 실무 구현 요소<a hidden class=anchor aria-hidden=true href=#5-핵심-개념-및-실무-구현-요소>#</a></h2><h3 id=핵심-개념>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념>#</a></h3><ol><li><strong>Saga</strong> - 여러 로컬 트랜잭션과 보상 트랜잭션의 시퀀스</li><li><strong>로컬 트랜잭션</strong> - 각 서비스에서 ACID 보장 범위 내 상태 변경</li><li><strong>보상 트랜잭션</strong> - 실패 시 이전 변경을 되돌리기 위한 로직</li><li><strong>Choreography</strong> - 이벤트 기반 순서 흐름 설계 방식 (<a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">docs.aws.amazon.com</a>)</li><li><strong>Orchestration</strong> - 중앙 조정자가 각 단계 명령 및 보상 호출 (<a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga.html?utm_source=chatgpt.com" title="Saga patterns - AWS Prescriptive Guidance">docs.aws.amazon.com</a>)</li><li><strong>Idempotency</strong> - 중복 실행 안전성 보장</li><li><strong>Event ordering</strong> - 순서 보장</li><li><strong>Saga Log / State Table</strong> - 각 saga 인스턴스의 진행 상태 추적 (<a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">infoq.com</a>)</li></ol><h3 id=실무-구현-요소>실무 구현 요소<a hidden class=anchor aria-hidden=true href=#실무-구현-요소>#</a></h3><ul><li>중앙 Orchestrator 또는 개별 이벤트 핸들러</li><li>메시지 브로커 (Kafka, RabbitMQ 등)</li><li>보상 트랜잭션 구현 (refund, rollback 등이 포함된 로직)</li><li>사가 상태 저장소 (Saga Log / 테이블)</li><li>Idempotent 처리 및 에러 재시도 메커니즘</li><li>Event ordering, Dead-letter 큐, 타임아웃 모니터링 등</li></ul><hr><h2 id=-6-다른-조사-항목-대응-여부>🎯 6. 다른 조사 항목 대응 여부<a hidden class=anchor aria-hidden=true href=#-6-다른-조사-항목-대응-여부>#</a></h2><p>요청하신 대부분 항목에 대해 조사 및 정리 완료했습니다:</p><ul><li>핵심 개념, 배경, 목적, 기능, 특징, 핵심원리/작동원리, 구조/아키텍처, 구성요소, 구현기법, 장점, 단점 및 해결안, 도전과제, 분류 (Choreography vs Orchestration), 실무 사용 예시, 활용 사례, 구현 예시, 실무 고려사항 및 최적화, 기타 사항 등 모두 포함했습니다.</li></ul><hr><h2 id=다음-단계-제안>다음 단계 제안<a hidden class=anchor aria-hidden=true href=#다음-단계-제안>#</a></h2><p>필요하시면 아래 항목들에 대해 <strong>심화 정리 및 코드 예시 포함</strong> 제공 가능합니다:</p><ul><li>🌐 다이어그램 포함 구조도</li><li>실제 구현 예시 (Python/Node.js/Java Spring)</li><li>상세한 사용 예시 비교 (예: 주문 - 재고 - 결제 서비스 시나리오)</li><li>실무 체크리스트 및 최적화 전략</li></ul><p>원하시는 항목을 알려주시면 바로 추가 작성해드리겠습니다!</p><p><a href=https://www.baeldung.com/cs/saga-pattern-microservices><figure><img alt="Saga Pattern in Microservices | Baeldung on Computer Science" loading=lazy src="https://tse2.mm.bing.net/th?id=OIP.RBEIU-WduK6X6g0asouYJAHaEm\\&r=0\\&pid=Api"></figure></a></p><p>다음은 <strong>Saga 패턴</strong>의 구조적 이해를 돕기 위한 심화 내용입니다.</p><hr><h2 id=1-구조-및-아키텍처--구성-요소>1. 구조 및 아키텍처 + 구성 요소<a hidden class=anchor aria-hidden=true href=#1-구조-및-아키텍처--구성-요소>#</a></h2><pre class=mermaid>flowchart LR
  subgraph Orchestration
    In[Client Request] --&gt; Orchestrator
    Orchestrator --&gt; S1[Service 1] --&gt; DB1
    Orchestrator --&gt; S2[Service 2] --&gt; DB2
    Orchestrator --&gt; S3[Service 3] --&gt; DB3
    Orchestrator --&gt;|Compensate| S1
    Orchestrator --&gt;|Compensate| S2
  end

  subgraph Choreography
    C1[Service A] --&gt;|Event A| C2[Service B]
    C2 --&gt;|Event B| C3[Service C]
    C3 --&gt;|Event C| C4[Service D]
    C2 --&gt;|Error B| C1[Compensate A]
  end
</pre><ul><li><strong>Orchestrator (중앙 코디네이터)</strong><ul><li>Saga 의 흐름을 제어하고 보상 로직을 실행</li><li>실행 상태를 Saga Log 에 기록</li></ul></li><li><strong>서비스 (S1, S2, S3 등)</strong><ul><li>각 로컬 트랜잭션을 처리하고 성공/실페 이벤트 반환</li><li>Idempotent 설계 및 로컬 DB 처리 수행</li></ul></li><li><strong>Saga Log</strong><ul><li>각 단계 상태 저장 (<code>STARTED</code>, <code>COMPLETED</code>, <code>FAILED</code>)</li><li>중앙 상태 기반 복구 및 추적 가능</li></ul></li><li><strong>보상 트랜잭션 (Compensation)</strong><ul><li>이전 성공 단계를 롤백하는 로직</li><li>CENTRAL 또는 local service 내 구현</li></ul></li></ul><hr><h2 id=2-핵심-원리--작동-원리>2. 핵심 원리 & 작동 원리<a hidden class=anchor aria-hidden=true href=#2-핵심-원리--작동-원리>#</a></h2><ul><li><p><strong>분산 트랜잭션 분해</strong><br>여러 서비스의 로컬 트랜잭션 시퀀스로 복합 트랜잭션 구성</p></li><li><p><strong>보상 트랜잭션</strong><br>일부 실패 시, 이미 실행된 트랜잭션을 롤백하는 비즈니스 로직</p></li><li><p><strong>Choreography vs Orchestration</strong></p></li></ul><table><thead><tr><th>구분</th><th>Choreography (이벤트)</th><th>Orchestration (명령)</th></tr></thead><tbody><tr><td>흐름 제어</td><td>분산 이벤트 간 연결</td><td>중앙 Orchestrator 가 흐름 제어</td></tr><tr><td>결합도</td><td>느슨함</td><td>Orchestrator 에 결합도 존재</td></tr><tr><td>디버깅/모니터링</td><td>복잡성 있음</td><td>흐름 추적이 용이</td></tr><tr><td>장애 대응</td><td>각 서비스에서 처리</td><td>중앙에서 통일성 있게 관리</td></tr><tr><td>예시 도구</td><td>Kafka + 이벤트 리스너</td><td>Temporal, Step Functions, 커스텀 Orchestrator</td></tr></tbody></table><p>(<a href="https://microservices.io/patterns/data/saga.html?utm_source=chatgpt.com" title="Pattern: Saga - Microservices.io">learn.microsoft.com</a>, <a href="https://blog.bytebytego.com/p/the-saga-pattern?utm_source=chatgpt.com" title="The Saga Pattern - ByteByteGo Newsletter">medium.com</a>, <a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">medium.com</a>, <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">prakharsrivastav.com</a>, <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga.html?utm_source=chatgpt.com" title="Saga patterns - AWS Prescriptive Guidance">microservices.io</a>, <a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">aws.amazon.com</a>)</p><hr><h2 id=3-구현-기법>3. 구현 기법<a hidden class=anchor aria-hidden=true href=#3-구현-기법>#</a></h2><ul><li><strong>Java Spring Orchestration</strong><ul><li><code>Orchestrator</code> 서비스가 <code>@Transactional</code> 로 Saga Log 및 커맨드/보상 호출</li><li>예: AWS Step Functions, Temporal 사용</li></ul></li><li><strong>Choreography 구현 (Kafka + Spring Boot)</strong><ul><li>각 서비스에서 <code>@EventListener</code></li><li>이벤트 발행, Consumer → 처리 → 다음 이벤트 발행 방식 (<a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">docs.aws.amazon.com</a>, <a href="https://rameshfadatare.medium.com/saga-pattern-in-microservices-a-step-by-step-guide-fdf650d3353f?utm_source=chatgpt.com" title="Saga Pattern in Microservices: A Step-by-Step Guide">rameshfadatare.medium.com</a>, <a href="https://www.infoq.com/articles/saga-orchestration-outbox?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">infoq.com</a>)</li></ul></li><li><strong>Outbox 패턴 통합</strong><ul><li>로컬 DB 업데이트 + Outbox 테이블에 메시지 기록</li><li>Debezium → Kafka 등을 통해 이중 쓰기 일관성 확보 (<a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">infoq.com</a>)</li></ul></li></ul><hr><h2 id=4-실무-사용-예시-및-활용-사례>4. 실무 사용 예시 및 활용 사례<a hidden class=anchor aria-hidden=true href=#4-실무-사용-예시-및-활용-사례>#</a></h2><h3 id=예시-주문---재고---결제-서비스-saga>예시: 주문 - 재고 - 결제 서비스 Saga<a hidden class=anchor aria-hidden=true href=#예시-주문---재고---결제-서비스-saga>#</a></h3><ul><li><strong>Orchestration 방식</strong> (AWS Step Functions 활용)</li></ul><pre class=mermaid>flowchart TB
 Start --&gt; OrderSvc[Order Service]
 OrderSvc --&gt; Step1[Reserve Inventory]
 Step1 --&gt; Step2[Make Payment]
 Step2 --&gt; Success[Order Completed]
 Step1 --&gt;|Fail| Comp1[Revert Inventory] --&gt; Fail[Order Failed]
 Step2 --&gt;|Fail| Comp2[Refund Payment] --&gt; Comp1 --&gt; Fail
</pre><p>주요 특징:</p><ul><li>실패 시 Step Functions 가 보상 흐름 호출<br>(<a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">aws.amazon.com</a>)</li></ul><h3 id=예시-kafka--spring-boot-choreography>예시: Kafka + Spring Boot Choreography<a hidden class=anchor aria-hidden=true href=#예시-kafka--spring-boot-choreography>#</a></h3><ul><li><code>OrderService</code> → <code>ORDER_CREATED</code> 이벤트</li><li><code>PaymentService</code> → 결제 시도 및 <code>PAYMENT_SUCCESS</code> 또는 <code>PAYMENT_FAILED</code> 이벤트</li><li><code>StockService</code>, <code>ShipmentService</code> → 연속 이벤트 처리</li><li>실패 발생 시, <code>StockService</code> 가 <code>PAYMENT_FAILED</code> 에 반응하여 재고 복구 이벤트 발행 (<a href="https://www.couchbase.com/blog/saga-pattern-implement-business-transactions-using-microservices-part/?utm_source=chatgpt.com" title="Saga Pattern: Microservices Design Examples | Couchbase">couchbase.com</a>, <a href="https://dev.to/jackynote/implementing-the-saga-pattern-with-spring-boot-and-activemq-in-microservice-14me?utm_source=chatgpt.com" title="Implementing the Saga Pattern with Spring Boot and ActiveMQ in …">dev.to</a>)</li></ul><hr><h2 id=5-구현-예시-java-spring-boot--kafka-채팅-축약>5. 구현 예시 (Java Spring Boot + Kafka, 채팅 축약)<a hidden class=anchor aria-hidden=true href=#5-구현-예시-java-spring-boot--kafka-채팅-축약>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a class=lnlinks href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a class=lnlinks href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a class=lnlinks href=#hl-5-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderSagaOrchestrator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=n>KafkaTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>OrderEvent</span><span class=o>&gt;</span><span class=w> </span><span class=n>kafka</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=n>SagaLogRepository</span><span class=w> </span><span class=n>sagaLog</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startSaga</span><span class=p>(</span><span class=n>CreateOrderCmd</span><span class=w> </span><span class=n>cmd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sagaLog</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Saga</span><span class=p>(</span><span class=n>cmd</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;STARTED&#34;</span><span class=p>,</span><span class=w> </span><span class=p>...));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>kafka</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderCreated</span><span class=p>(</span><span class=n>cmd</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>(),</span><span class=w> </span><span class=p>...));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@KafkaListener</span><span class=p>(</span><span class=n>topics</span><span class=o>=</span><span class=s>&#34;payments&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPaymentResult</span><span class=p>(</span><span class=n>PaymentResult</span><span class=w> </span><span class=n>evt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Saga</span><span class=w> </span><span class=n>saga</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sagaLog</span><span class=p>.</span><span class=na>find</span><span class=p>(</span><span class=n>evt</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>evt</span><span class=p>.</span><span class=na>isSuccess</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>kafka</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=s>&#34;stock&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReserveStock</span><span class=p>(</span><span class=n>evt</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>(),</span><span class=w> </span><span class=n>evt</span><span class=p>.</span><span class=na>getItems</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>saga</span><span class=p>.</span><span class=na>updateStep</span><span class=p>(</span><span class=s>&#34;STOCK&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>kafka</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CompensateOrder</span><span class=p>(</span><span class=n>evt</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>saga</span><span class=p>.</span><span class=na>updateStatus</span><span class=p>(</span><span class=s>&#34;COMPENSATED&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sagaLog</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>saga</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>중요 요소:</p><ul><li>Saga 상태 저장 (<code>SagaLog</code>)</li><li>Idempotent 이벤트 리스너 (중복 메시지 방지)</li><li>보상 흐름 흐름 반영</li></ul><hr><h2 id=6-장단점-요약>6. 장단점 요약<a hidden class=anchor aria-hidden=true href=#6-장단점-요약>#</a></h2><table><thead><tr><th>구분</th><th>장점</th><th>단점 & 해결방안</th></tr></thead><tbody><tr><td>분산 일관성</td><td>2PC 대응, 비동기 흐름 가능</td><td>일관성 지연 → Idempotency/상태 동기 UI 필요</td></tr><tr><td>장애 복구</td><td>Saga Log 로 재시작 & 복구 가능</td><td>Orchestrator 장애 시 흐름 멈춤 → HA 구성</td></tr><tr><td>트레이싱</td><td>중앙 or 이벤트 연결에 따라 흐름 추적 가능</td><td>이벤트 폭증 → 메타데이터 제한 및 모니터링 체계 필요</td></tr><tr><td>모니터링</td><td>Step Functions, Temporal 등의 시각화 툴 제공</td><td>분산형 디버깅 필요성 증가 → Correlation ID 필수</td></tr></tbody></table><hr><p>추가로 <strong>Python/Node.js 구현</strong>, <strong>테스트 시나리오</strong>, 또는 <strong>복잡한 다단계 Saga 설계 가이드</strong>를 원하시면 말씀해주세요!</p><p>아래는 <strong>Saga 패턴</strong>에 대한 지속적인 정리입니다. 이번에는 <strong>장단점</strong>, <strong>도전 과제</strong>, <strong>분류 기준</strong>, <strong>실무 사용 예시</strong>, 그리고 <strong>Python/Kanava</strong> 구현 예시를 포함합니다.</p><hr><h2 id=-7-장점--단점>✅ 7. 장점 & 단점<a hidden class=anchor aria-hidden=true href=#-7-장점--단점>#</a></h2><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책 / 완화 전략</th></tr></thead><tbody><tr><td><strong>장점</strong></td><td><strong>데이터 정합성 확보</strong></td><td>2PC 없이도 분산 시스템에서 일관성 유지 가능 (<a href="https://microservices.io/patterns/data/saga.html?utm_source=chatgpt.com" title="Pattern: Saga - Microservices.io">microservices.io</a>, <a href="https://blog.bytebytego.com/p/the-saga-pattern?utm_source=chatgpt.com" title="The Saga Pattern - ByteByteGo Newsletter">learn.microsoft.com</a>, <a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">stackoverflow.com</a>)</td><td>—</td></tr><tr><td></td><td><strong>서비스 독립성 증가</strong></td><td>각 서비스가 로컬 트랜잭션 사용 → 고장 격리, 확장성 확보</td><td>—</td></tr><tr><td></td><td><strong>보상 기반 롤백 가능</strong></td><td>실패 시 보상 트랜잭션으로 이전 상태 복구</td><td>—</td></tr><tr><td></td><td><strong>투명한 흐름 추적</strong></td><td>Orchestration 기반 중앙 상태 추적 또는 이벤트 기반 Choreography 로 흐름 모니터링 가능</td><td>—</td></tr><tr><td><strong>단점</strong></td><td><strong>복잡도 증가</strong></td><td>로직·이벤트 흐름·클러스터 관리 복잡도 증가</td><td>중앙 Orchestrator 로 관리, 코드 샘플/프레임워크 활용 (Temporal, Step Functions 등)</td></tr><tr><td></td><td><strong>일관성 지연 및 격리 부족</strong></td><td>중간 상태 읽기 가능 → 동시성 이슈 발생</td><td>Semantic lock, version 필드, reread 방식 활용</td></tr><tr><td></td><td><strong>디버깅 어려움</strong></td><td>이벤트 흐름 추적이 복잡</td><td>Correlation ID 사용, 시각화 플랫폼 (Temporal 등) 도입</td></tr><tr><td></td><td><strong>성능·지연 오버헤드</strong></td><td>메시징 수 증가로 지연·네트워크 Overhead 존재</td><td>병렬 처리, 메시지 QoS, Timeout 설정</td></tr></tbody></table><hr><h2 id=-8-도전-과제-challenges>🎯 8. 도전 과제 (Challenges)<a hidden class=anchor aria-hidden=true href=#-8-도전-과제-challenges>#</a></h2><ul><li><strong>보상 트랜잭션 설계 완결성</strong><ul><li><strong>원인</strong>: 실패 대상에 따라 다단계 복구 필요</li><li><strong>영향</strong>: 복잡한 경계 조건에 대한 오버헤드</li><li><strong>대응</strong>: 도메인 기반 정의, 테스트 강화, 시각화</li></ul></li><li><strong>중간 상태 격리 및 순서 보장</strong><ul><li><strong>원인</strong>: 동시 이벤트 처리로 인한 Dirty Read</li><li><strong>대응</strong>: 읽기 잠금, 버전 필드, Semantic lock (<a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">github.com</a>, <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga.html?utm_source=chatgpt.com" title="Saga patterns - AWS Prescriptive Guidance">medium.com</a>, <a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">medium.com</a>, <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">geeksforgeeks.org</a>)</li></ul></li><li><strong>Orchestrator 장애 복구</strong><ul><li><strong>원인</strong>: Coordinator 다운 시 흐름 중단</li><li><strong>대응</strong>: High-availability 구성, 로그로 복구, Temporal 기반 재실행</li></ul></li><li><strong>모니터링/트레이싱 부족</strong><ul><li><strong>원인</strong>: 이벤트 분산 흐름 추적 어려움</li><li><strong>대응</strong>: Correlation ID, OpenTelemetry 연동, 시각화 대시보드</li></ul></li><li><strong>보상 실패 재처리</strong><ul><li><strong>원인</strong>: 보상 트랜잭션도 실패 가능</li><li><strong>대응</strong>: Dead-letter 큐, 재시도 정책, 관리자 개입 플래그</li></ul></li></ul><hr><h2 id=-9-분류-기준에-따른-종류-및-유형>📋 9. 분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#-9-분류-기준에-따른-종류-및-유형>#</a></h2><table><thead><tr><th>분류 기준</th><th>유형</th><th>설명</th></tr></thead><tbody><tr><td>흐름 제어 방식</td><td><strong>Choreography</strong></td><td>서비스 간 이벤트 기반 분산 흐름, 느슨한 결합, 모니터링 및 디버깅 어려움</td></tr><tr><td></td><td><strong>Orchestration</strong></td><td>중앙 조정기 (Orchestrator) 기반, 흐름 제어 명시적, 중앙 집중식 추적 가능</td></tr></tbody></table><hr><h2 id=-10-실무-사용-예시>🧪 10. 실무 사용 예시<a hidden class=anchor aria-hidden=true href=#-10-실무-사용-예시>#</a></h2><table><thead><tr><th>스택</th><th>활용 목적</th><th>기대 효과</th></tr></thead><tbody><tr><td>AWS Step Functions & Lambda</td><td>주문, 결제, 재고 예약 분산 트랜잭션</td><td>실패 보상, 시각적 워크플로우 관리 가능</td></tr><tr><td>Temporal + Go/Java</td><td>복잡한 멀티 스텝 비즈니스 로직</td><td>Traceable, 재실행, 워크플로 내 관리 자동화</td></tr><tr><td>Spring Boot + Kafka</td><td>Choreography 방식 재고 - 결제 연계</td><td>메시지 기반 비동기, 지연 및 보상 처리 구성</td></tr><tr><td>Node.js + Python-based saga 수동 구현</td><td>PoC 또는 경량 분산 트랜잭션</td><td>개념 이해 및 자가 관리 구현 가능</td></tr></tbody></table><hr><h2 id=-11-구현-예시-python---orchestration-기반>🧩 11. 구현 예시 (Python - Orchestration 기반)<a hidden class=anchor aria-hidden=true href=#-11-구현-예시-python---orchestration-기반>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># saga.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaStep</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>action</span><span class=p>,</span> <span class=n>compensation</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>action</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>compensation</span> <span class=o>=</span> <span class=n>action</span><span class=p>,</span> <span class=n>compensation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaOrchestrator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>completed</span> <span class=o>=</span> <span class=n>steps</span><span class=p>,</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>completed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>prev</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>completed</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>prev</span><span class=o>.</span><span class=n>compensation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># application example</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reserve_stock</span><span class=p>():</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;stock reserved&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>charge_payment</span><span class=p>():</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;payment charged&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>refund_payment</span><span class=p>():</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;payment refunded&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>steps</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>SagaStep</span><span class=p>(</span><span class=n>reserve_stock</span><span class=p>,</span> <span class=k>lambda</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;stock released&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=n>SagaStep</span><span class=p>(</span><span class=n>charge_payment</span><span class=p>,</span> <span class=n>refund_payment</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SagaOrchestrator</span><span class=p>(</span><span class=n>steps</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>** 행동 함수 (action)** 와 ** 보상 함수 (compensation)** 를 연결해 실행 순서 지정</li><li>실패 시 역순 보상 처리 자동 수행</li></ul><hr><h2 id=다음으로-다뤄볼-수-있는-내용-선택>다음으로 다뤄볼 수 있는 내용 (선택)<a hidden class=anchor aria-hidden=true href=#다음으로-다뤄볼-수-있는-내용-선택>#</a></h2><ul><li>✅ <strong>Choreography 기반 이벤트 흐름 예시 (Python / Node.js 코드)</strong></li><li>🔍 <strong>SAGA 테스트 및 검증 전략</strong></li><li>⚙️ <strong>Temporal / Step Functions 등 툴별 적용 가이드</strong></li><li>📐 <strong>복잡한 워크플로우 설계 체크리스트</strong></li></ul><p>원하시는 항목을 말씀해주세요!</p><p>아래는 <strong>Choreography 기반 Saga 흐름</strong>을 <strong>Python + RabbitMQ</strong> 예제로 구현한 코드입니다. 이벤트 중심으로 서비스가 서로를 호출하며, 각 단계에서 실패 시 보상 작업이 수행되는 구조를 보여드립니다.</p><hr><h2 id=-choreography-패턴-sagapython--rabbitmq-예시>🧪 Choreography 패턴 Saga–Python + RabbitMQ 예시<a hidden class=anchor aria-hidden=true href=#-choreography-패턴-sagapython--rabbitmq-예시>#</a></h2><h3 id=1-메시지-구조-정의-eventspy>1. 메시지 구조 정의 (<code>events.py</code>)<a hidden class=anchor aria-hidden=true href=#1-메시지-구조-정의-eventspy>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderCreated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=p>:</span> <span class=nb>list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentSucceeded</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentFailed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StockReleased</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-pubsub-라이브러리-설정-messagingpy>2. Pub/Sub 라이브러리 설정 (<code>messaging.py</code>)<a hidden class=anchor aria-hidden=true href=#2-pubsub-라이브러리-설정-messagingpy>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pika</span><span class=o>,</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Broker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conn</span> <span class=o>=</span> <span class=n>pika</span><span class=o>.</span><span class=n>BlockingConnection</span><span class=p>(</span><span class=n>pika</span><span class=o>.</span><span class=n>ConnectionParameters</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>conn</span><span class=o>.</span><span class=n>channel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ch</span><span class=o>.</span><span class=n>exchange_declare</span><span class=p>(</span><span class=n>exchange</span><span class=o>=</span><span class=s1>&#39;saga&#39;</span><span class=p>,</span> <span class=n>exchange_type</span><span class=o>=</span><span class=s1>&#39;topic&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>publish</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ch</span><span class=o>.</span><span class=n>basic_publish</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>exchange</span><span class=o>=</span><span class=s1>&#39;saga&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>routing_key</span><span class=o>=</span><span class=n>routing_key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>body</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>routing_key</span><span class=p>,</span> <span class=n>callback</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ch</span><span class=o>.</span><span class=n>queue_declare</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>exclusive</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>queue</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ch</span><span class=o>.</span><span class=n>queue_bind</span><span class=p>(</span><span class=n>exchange</span><span class=o>=</span><span class=s1>&#39;saga&#39;</span><span class=p>,</span> <span class=n>queue</span><span class=o>=</span><span class=n>q</span><span class=p>,</span> <span class=n>routing_key</span><span class=o>=</span><span class=n>routing_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ch</span><span class=o>.</span><span class=n>basic_consume</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>ch</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>prop</span><span class=p>,</span> <span class=n>body</span><span class=p>:</span> <span class=n>callback</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>body</span><span class=p>)),</span> <span class=n>auto_ack</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ch</span><span class=o>.</span><span class=n>start_consuming</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-서비스-a주문-생성>3. 서비스 A–주문 생성<a hidden class=anchor aria-hidden=true href=#3-서비스-a주문-생성>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5>5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6>6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7>7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>events</span> <span class=kn>import</span> <span class=n>OrderCreated</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>messaging</span> <span class=kn>import</span> <span class=n>Broker</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>broker</span> <span class=o>=</span> <span class=n>Broker</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>order_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>broker</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;order.created&#39;</span><span class=p>,</span> <span class=n>OrderCreated</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;item1&#39;</span><span class=p>,</span> <span class=s1>&#39;item2&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;OrderCreated published for </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=4-서비스-b결제-처리-및-실패성공-이벤트-발행>4. 서비스 B–결제 처리 및 실패/성공 이벤트 발행<a hidden class=anchor aria-hidden=true href=#4-서비스-b결제-처리-및-실패성공-이벤트-발행>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>events</span> <span class=kn>import</span> <span class=n>OrderCreated</span><span class=p>,</span> <span class=n>PaymentSucceeded</span><span class=p>,</span> <span class=n>PaymentFailed</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>messaging</span> <span class=kn>import</span> <span class=n>Broker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>broker</span> <span class=o>=</span> <span class=n>Broker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_order_created</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 결제 시뮬레이션</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=kc>True</span><span class=p>:</span>  <span class=c1># 결제 성공 조건</span>
</span></span><span class=line><span class=cl>        <span class=n>broker</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;payment.succeeded&#39;</span><span class=p>,</span> <span class=n>PaymentSucceeded</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=mf>100.0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>broker</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;payment.failed&#39;</span><span class=p>,</span> <span class=n>PaymentFailed</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;Insufficient funds&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>broker</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s1>&#39;order.created&#39;</span><span class=p>,</span> <span class=n>on_order_created</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=5-서비스-c재고-예약-및-보상-처리>5. 서비스 C–재고 예약 및 보상 처리<a hidden class=anchor aria-hidden=true href=#5-서비스-c재고-예약-및-보상-처리>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>events</span> <span class=kn>import</span> <span class=n>PaymentSucceeded</span><span class=p>,</span> <span class=n>PaymentFailed</span><span class=p>,</span> <span class=n>StockReleased</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>messaging</span> <span class=kn>import</span> <span class=n>Broker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>broker</span> <span class=o>=</span> <span class=n>Broker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_payment_succeeded</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 재고 차감 시뮬레이션</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Stock reserved for </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_payment_failed</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>broker</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s1>&#39;stock.released&#39;</span><span class=p>,</span> <span class=n>StockReleased</span><span class=p>(</span><span class=n>order_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>broker</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s1>&#39;payment.succeeded&#39;</span><span class=p>,</span> <span class=n>on_payment_succeeded</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>broker</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s1>&#39;payment.failed&#39;</span><span class=p>,</span> <span class=n>on_payment_failed</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>broker</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s1>&#39;stock.released&#39;</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>data</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Stock released for </span><span class=si>{</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=-설명-요약>✅ 설명 요약<a hidden class=anchor aria-hidden=true href=#-설명-요약>#</a></h3><ul><li><strong>OrderCreated 이벤트</strong> → 결제 서비스<ul><li>성공: <code>PaymentSucceeded</code> 이벤트 발행</li><li>실패: <code>PaymentFailed</code> 발행</li></ul></li><li><strong>Stock 서비스</strong>는 <code>PaymentSucceeded</code> 수신 시 재고 차감<ul><li><code>PaymentFailed</code> 수신 시 <code>StockReleased</code> 보상 이벤트 발행</li></ul></li><li><strong>Choreography 흐름</strong>: 서비스 간 직접 이벤트 교환 방식<ul><li>중앙 Orchestrator 없음 → 느슨한 결합</li><li>서비스별 책임과 이벤트 흐름이 분리되는 구조</li></ul></li></ul><hr><h2 id=-보완-포인트-및-개선-방향>💡 보완 포인트 및 개선 방향<a hidden class=anchor aria-hidden=true href=#-보완-포인트-및-개선-방향>#</a></h2><ul><li><strong>Idempotency 처리</strong>: 메시지 재전송 대비 중복 실행 방지 로직 필요</li><li><strong>Event ordering 보장</strong>: RabbitMQ, Kafka 등을 통한 키 기반 순서 제어</li><li><strong>오류 재시도</strong>: <code>payment.succeeded</code> 실패 시 재시도 / DLQ 구성</li><li><strong>추적 로깅</strong>: <code>correlation_id</code>, <code>trace_id</code> 추가하여 흐름 추적 가능</li></ul><hr><p>💭 원하시는 경우 <strong>Step Functions / Temporal Orchestration 예제</strong>, <strong>분산 트레이싱 연동</strong>, <strong>Transaction 상태 시각화 대시보드 구성</strong>도 제공 드릴 수 있습니다! 요청하시면 이어서 작성해드리겠습니다.</p><p>이제 <strong>Saga 기반 분산 시스템에서의 분산 트레이싱</strong> 통합 전략에 대해 정리해드리겠습니다.</p><hr><h2 id=1-분산-트레이싱의-목적과-구성-요소->1. 분산 트레이싱의 목적과 구성 요소 🎯<a hidden class=anchor aria-hidden=true href=#1-분산-트레이싱의-목적과-구성-요소->#</a></h2><ul><li><strong>Trace</strong>: 요청이 시작되어 여러 마이크로서비스를 거쳐 종료될 때까지의 전체 흐름</li><li><strong>Span</strong>: Trace 안의 단일 작업 (예: API 호출, MQ 이벤트 소비 등)</li><li><strong>Context Propagation</strong>: Trace ID 와 Span ID 등의 정보를 각 서비스 간 헤더로 전파하여 스팬들이 같은 trace 에 묶이도록 합니다 (<a href="https://microservices.io/patterns/data/saga.html?utm_source=chatgpt.com" title="Pattern: Saga - Microservices.io">medium.com</a>)</li></ul><hr><h2 id=2-opentelemetry-기반-구현-예-python-saga--flask--rabbitmq>2. OpenTelemetry 기반 구현 예 (Python Saga + Flask + RabbitMQ)<a hidden class=anchor aria-hidden=true href=#2-opentelemetry-기반-구현-예-python-saga--flask--rabbitmq>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># tracing.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>opentelemetry</span> <span class=kn>import</span> <span class=n>trace</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>opentelemetry.sdk.trace</span> <span class=kn>import</span> <span class=n>TracerProvider</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>opentelemetry.sdk.trace.export</span> <span class=kn>import</span> <span class=n>BatchSpanProcessor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>opentelemetry.exporter.jaeger.thrift</span> <span class=kn>import</span> <span class=n>JaegerExporter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>trace</span><span class=o>.</span><span class=n>set_tracer_provider</span><span class=p>(</span><span class=n>TracerProvider</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>jaeger_exporter</span> <span class=o>=</span> <span class=n>JaegerExporter</span><span class=p>(</span><span class=n>agent_host_name</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=n>agent_port</span><span class=o>=</span><span class=mi>6831</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>trace</span><span class=o>.</span><span class=n>get_tracer_provider</span><span class=p>()</span><span class=o>.</span><span class=n>add_span_processor</span><span class=p>(</span><span class=n>BatchSpanProcessor</span><span class=p>(</span><span class=n>jaeger_exporter</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>tracer</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># service_a.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tracing</span> <span class=kn>import</span> <span class=n>tracer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>messaging</span> <span class=kn>import</span> <span class=n>Broker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>events</span> <span class=kn>import</span> <span class=n>OrderCreated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>broker</span> <span class=o>=</span> <span class=n>Broker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=o>...</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span><span class=s2>&#34;create_order_saga&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>broker</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s2>&#34;order.created&#34;</span><span class=p>,</span> <span class=n>OrderCreated</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=o>...</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5>5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6>6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># service_b.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tracing</span> <span class=kn>import</span> <span class=n>tracer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>on_order_created</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span><span class=s2>&#34;payment_step&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>span</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&#34;order_id&#34;</span><span class=p>,</span> <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;order_id&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># 결제 시도…</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>각 서비스에서 span 을 수동 또는 자동으로 생성</li><li>메시지 발행/소비 시 trace context 를 유지하기 위해 헤더 전달 필요</li></ul><hr><h2 id=3-주요-트레이싱-best-practices>3. 주요 트레이싱 Best Practices<a hidden class=anchor aria-hidden=true href=#3-주요-트레이싱-best-practices>#</a></h2><table><thead><tr><th>항목</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td>Trace Context</td><td>Trace ID 이어지지 않으면 단절 발생</td><td>RabbitMQ 나 HTTP 매커니즘 통해 header 로 context 전송</td></tr><tr><td>Sampling</td><td>모든 요청 추적 시 오버헤드</td><td>비율 샘플링 또는 중요한 Saga 만 샘플링</td></tr><tr><td>Correlation ID</td><td>Saga 흐름 연결</td><td><code>correlation_id</code> 로 모든 Spans 연관</td></tr><tr><td>UI/모니터링</td><td>흐름 시각화, Debug 요약</td><td>Jaeger, Zipkin, SigNoz 등 사용</td></tr><tr><td>Logging 연동</td><td>Trace 와 로그를 쉽게 연계</td><td>로그에 trace/span ID 포함, Structured Logging</td></tr></tbody></table><hr><h2 id=4-왜-중요한가>4. 왜 중요한가?<a hidden class=anchor aria-hidden=true href=#4-왜-중요한가>#</a></h2><ul><li><strong>Saga 흐름 추적</strong>: 어느 단계에서 실패했는지, 보상 트랜잭션은 정상 실행되었는지 시각적으로 추적</li><li><strong>성능 병목 진단</strong>: 어느 서비스에서 지연이 발생하는지 식별</li><li><strong>오류 원인 탐색</strong>: 트레이스로 인과관계 파악 및 디버깅 지원</li></ul><hr><h2 id=5-고급-기능-trace-compression--non-invasive-tracing>5. 고급 기능: Trace Compression & Non-invasive Tracing<a hidden class=anchor aria-hidden=true href=#5-고급-기능-trace-compression--non-invasive-tracing>#</a></h2><ul><li><strong>Tracezip</strong>: 반복 span 압축 전송하여 Overhead 절감 (<a href="https://blog.bytebytego.com/p/the-saga-pattern?utm_source=chatgpt.com" title="The Saga Pattern - ByteByteGo Newsletter">medium.com</a>, <a href="https://medium.com/ultimate-systems-design-and-building/choreography-vs-orchestration-in-microservices-which-saga-strategy-should-you-choose-be0bb700a1d2?utm_source=chatgpt.com" title="Choreography vs. Orchestration in Microservices: Which Saga …">temporal.io</a>, <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">arxiv.org</a>, <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga.html?utm_source=chatgpt.com" title="Saga patterns - AWS Prescriptive Guidance">signoz.io</a>, <a href="https://www.infoq.com/articles/saga-orchestration-outbox/?utm_source=chatgpt.com" title="Saga Orchestration for Microservices Using the Outbox Pattern">arxiv.org</a>)</li><li><strong>eBPF 기반 Trace</strong>: 코드 삽입 없이 네트워크 레벨 트레이싱 가능 (e.g., Nahida) (<a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/saga-choreography.html?utm_source=chatgpt.com" title="Saga choreography pattern - AWS Prescriptive Guidance">arxiv.org</a>)</li></ul><hr><h2 id=6-구현-시-유의사항>6. 구현 시 유의사항<a hidden class=anchor aria-hidden=true href=#6-구현-시-유의사항>#</a></h2><ul><li><p><strong>Idempotency + Trace 상태 관리</strong><br>복제된 메시지 영향을 방지하려면 Span 내부에서도 상태 기반 작업 수행 로직 필요</p></li><li><p><strong>Context 전파 누락 방지</strong><br>RabbitMQ, HTTP 클라이언트 모두에서 오토 인스트루먼트 또는 수동 전파 구현</p></li><li><p><strong>모니터링 지표 설정</strong><br>각 Span 의 처리 시간, 에러, 비동기 지연 등을 메트릭으로 수집하여 Alert 설정</p></li></ul><hr><h2 id=-요약>✅ 요약<a hidden class=anchor aria-hidden=true href=#-요약>#</a></h2><p>Saga 와 CQRS 기반 분산 트랜잭션을 안정적으로 운영하기 위해서는 <strong>분산 트레이싱</strong>이 필수입니다. OpenTelemetry 기반으로 Trace ID 및 Span 을 전파하고, Jaeger/Zipkin/ SigNoz 와 연동하여 다음을 달성할 수 있습니다:</p><ul><li>Saga 단계별 실행 흐름 확인</li><li>장애 발생 지점 식별 / 보상 로직 추적</li><li>비동기 지연 및 성능 병목 감지</li></ul><p>추가로 <strong>Step Functions / Temporal 에서의 자동 출력 tracing</strong> 예시나 <strong>Java / NestJS 구현 예</strong>가 필요하시면 언제든지 알려주세요!</p><p>저는 여러분의 IT 백엔드 개발 및 소프트웨어 아키텍처 멘토로서, 사가 (Saga) 패턴에 대한 포괄적인 조사와 분석을 진행하겠습니다. 먼저 최신 정보와 실무 사례를 조사한 후, 체계적으로 정리해드리겠습니다.# Saga 패턴 종합 조사 분석</p><h2 id=1-조사-태그-및-분류-분석>1. 조사 태그 및 분류 분석<a hidden class=anchor aria-hidden=true href=#1-조사-태그-및-분류-분석>#</a></h2><p><strong>태그</strong>: <code>Distributed-Transactions</code>, <code>Microservices-Architecture</code>, <code>Data-Consistency</code>, <code>Compensating-Transactions</code></p><p><strong>주제 분류 분석</strong>: &ldquo;Computer Science and Engineering&rdquo; > &ldquo;Software Engineering&rdquo; > &ldquo;Design and Architecture&rdquo; > &ldquo;Architecture Styles and Patterns&rdquo; > &ldquo;Architecture Patterns&rdquo; > &ldquo;Data Management&rdquo;</p><p>제시된 분류 계층 구조는 적절합니다. 사가 패턴은 마이크로서비스 아키텍처에서 데이터 관리를 위한 아키텍처 패턴으로, 분산 시스템의 트랜잭션 관리를 위한 설계 패턴에 해당합니다.</p><p><strong>요약</strong>: 사가 패턴은 마이크로서비스 아키텍처에서 여러 서비스에 걸친 분산 트랜잭션을 일련의 로컬 트랜잭션으로 분해하여 관리하고, 실패 시 보상 트랜잭션을 통해 데이터 일관성을 유지하는 패턴입니다.</p><p><strong>개요</strong>: 사가 패턴은 분산 시스템에서 ACID 트랜잭션의 한계를 극복하기 위해 고안된 패턴으로, 각 서비스가 독립적인 데이터베이스를 가지는 마이크로서비스 환경에서 비즈니스 트랜잭션의 일관성을 보장합니다. 코레오그래피와 오케스트레이션 두 가지 구현 방식을 제공하며, eventual consistency 모델을 통해 확장성과 가용성을 확보합니다.</p><hr><h2 id=2-핵심-개념-및-이론>2. 핵심 개념 및 이론<a hidden class=anchor aria-hidden=true href=#2-핵심-개념-및-이론>#</a></h2><h3 id=핵심-개념-1>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념-1>#</a></h3><p>**사가 패턴 (Saga Pattern)**은 분산 트랜잭션을 관리하기 위한 아키텍처 패턴으로, 다음 핵심 개념들로 구성됩니다:</p><ol><li><strong>로컬 트랜잭션 (Local Transaction)</strong>: 개별 서비스에서 실행되는 ACID 트랜잭션</li><li><strong>보상 트랜잭션 (Compensating Transaction)</strong>: 이전 단계의 변경사항을 되돌리는 트랜잭션</li><li><strong>사가 코디네이터 (Saga Coordinator)</strong>: 트랜잭션 흐름을 관리하는 중앙 컴포넌트</li><li><strong>이벤추얼 일관성 (Eventual Consistency)</strong>: 시간이 지나면서 모든 서비스가 일관된 상태에 도달하는 모델</li></ol><h3 id=실무-구현-요소-1>실무 구현 요소<a hidden class=anchor aria-hidden=true href=#실무-구현-요소-1>#</a></h3><ul><li><strong>이벤트 발행/구독 메커니즘</strong>: Apache Kafka, RabbitMQ, Amazon EventBridge</li><li><strong>상태 관리 저장소</strong>: 사가 실행 상태 추적을 위한 데이터베이스</li><li><strong>멱등성 보장</strong>: 중복 처리 방지를 위한 메커니즘</li><li><strong>타임아웃 처리</strong>: 장기 실행 트랜잭션의 시간 제한 관리</li><li><strong>모니터링 도구</strong>: 분산 추적, 로깅, 메트릭 수집</li></ul><h3 id=배경-1>배경<a hidden class=anchor aria-hidden=true href=#배경-1>#</a></h3><p>마이크로서비스 아키텍처에서 &ldquo;Database per Service&rdquo; 패턴이 널리 채택되면서, 여러 서비스에 걸친 비즈니스 트랜잭션을 관리하는 문제가 대두되었습니다. 전통적인 분산 트랜잭션 (2PC) 은 다음과 같은 한계를 가집니다:</p><ul><li><strong>성능 저하</strong>: 모든 참여자의 동의가 필요한 동기적 처리</li><li><strong>가용성 문제</strong>: 하나의 서비스 장애가 전체 트랜잭션에 영향</li><li><strong>NoSQL 미지원</strong>: 많은 NoSQL 데이터베이스가 2PC 를 지원하지 않음</li><li><strong>확장성 제약</strong>: 참여 서비스 수에 따른 성능 저하</li></ul><h3 id=목적-및-필요성-1>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성-1>#</a></h3><ol><li><strong>데이터 일관성 보장</strong>: 분산 환경에서 비즈니스 규칙에 따른 데이터 일관성 유지</li><li><strong>서비스 자율성</strong>: 각 서비스가 독립적으로 데이터를 관리할 수 있도록 지원</li><li><strong>장애 복구</strong>: 부분 실패 상황에서 시스템 상태를 일관되게 복구</li><li><strong>확장성 향상</strong>: 서비스 간 느슨한 결합을 통한 시스템 확장성 개선</li></ol><hr><h2 id=3-구조-및-아키텍처>3. 구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#3-구조-및-아키텍처>#</a></h2><h3 id=필수-구성요소>필수 구성요소<a hidden class=anchor aria-hidden=true href=#필수-구성요소>#</a></h3><table><thead><tr><th>구성요소</th><th>기능</th><th>역할</th><th>특징</th></tr></thead><tbody><tr><td><strong>사가 참여자 (Saga Participant)</strong></td><td>로컬 트랜잭션 실행</td><td>개별 비즈니스 로직 처리</td><td>독립적 데이터베이스 소유</td></tr><tr><td><strong>보상 트랜잭션 (Compensation)</strong></td><td>변경사항 되돌리기</td><td>실패 시 일관성 복구</td><td>멱등성 보장 필요</td></tr><tr><td><strong>이벤트/메시지</strong></td><td>서비스 간 통신</td><td>트랜잭션 상태 전파</td><td>비동기 처리</td></tr></tbody></table><h3 id=선택-구성요소>선택 구성요소<a hidden class=anchor aria-hidden=true href=#선택-구성요소>#</a></h3><table><thead><tr><th>구성요소</th><th>기능</th><th>역할</th><th>특징</th></tr></thead><tbody><tr><td><strong>사가 코디네이터</strong></td><td>중앙 집중식 관리</td><td>오케스트레이션 패턴에서 흐름 제어</td><td>단일 실패 지점 가능성</td></tr><tr><td><strong>사가 로그</strong></td><td>실행 상태 추적</td><td>복구 및 모니터링</td><td>디버깅 지원</td></tr></tbody></table><h3 id=아키텍처-다이어그램>아키텍처 다이어그램<a hidden class=anchor aria-hidden=true href=#아키텍처-다이어그램>#</a></h3><pre class=mermaid>graph TD
    A[클라이언트 요청] --&gt; B[사가 시작]
    B --&gt; C[서비스 1: 로컬 트랜잭션]
    C --&gt; D{성공?}
    D --&gt;|예| E[서비스 2: 로컬 트랜잭션]
    D --&gt;|아니오| F[보상 트랜잭션 1]
    E --&gt; G{성공?}
    G --&gt;|예| H[서비스 3: 로컬 트랜잭션]
    G --&gt;|아니오| I[보상 트랜잭션 2]
    I --&gt; F
    H --&gt; J{성공?}
    J --&gt;|예| K[사가 완료]
    J --&gt;|아니오| L[보상 트랜잭션 3]
    L --&gt; I
    F --&gt; M[사가 실패]
</pre><hr><h2 id=4-주요-원리-및-작동-원리>4. 주요 원리 및 작동 원리<a hidden class=anchor aria-hidden=true href=#4-주요-원리-및-작동-원리>#</a></h2><h3 id=주요-원리>주요 원리<a hidden class=anchor aria-hidden=true href=#주요-원리>#</a></h3><ol><li><strong>트랜잭션 분해</strong>: 긴 트랜잭션을 여러 로컬 트랜잭션으로 분해</li><li><strong>순차 실행</strong>: 각 단계가 순차적으로 실행되며 다음 단계를 트리거</li><li><strong>보상 메커니즘</strong>: 실패 시 이전 단계들을 역순으로 보상</li><li><strong>이벤트 기반 통신</strong>: 서비스 간 비동기 이벤트를 통한 상태 전파</li></ol><h3 id=작동-원리-다이어그램>작동 원리 다이어그램<a hidden class=anchor aria-hidden=true href=#작동-원리-다이어그램>#</a></h3><pre class=mermaid>sequenceDiagram
    participant C as 클라이언트
    participant O as 주문 서비스
    participant P as 결제 서비스
    participant I as 재고 서비스
    participant S as 배송 서비스

    C-&gt;&gt;O: 주문 생성 요청
    O-&gt;&gt;O: 주문 생성 (PENDING)
    O-&gt;&gt;P: OrderCreated 이벤트
    P-&gt;&gt;P: 결제 처리
    P-&gt;&gt;I: PaymentProcessed 이벤트
    I-&gt;&gt;I: 재고 업데이트
    I-&gt;&gt;S: InventoryUpdated 이벤트
    S-&gt;&gt;S: 배송 준비
    S-&gt;&gt;O: ShipmentPrepared 이벤트
    O-&gt;&gt;O: 주문 완료 (COMPLETED)
    O-&gt;&gt;C: 주문 완료 응답

    Note over O,S: 실패 시 보상 트랜잭션 실행
</pre><hr><h2 id=5-구현-기법>5. 구현 기법<a hidden class=anchor aria-hidden=true href=#5-구현-기법>#</a></h2><h3 id=1-코레오그래피-choreography-패턴>1. 코레오그래피 (Choreography) 패턴<a hidden class=anchor aria-hidden=true href=#1-코레오그래피-choreography-패턴>#</a></h3><p><strong>정의</strong>: 중앙 조정자 없이 각 서비스가 이벤트를 발행하고 구독하여 트랜잭션을 진행하는 방식</p><p><strong>구성</strong>:</p><ul><li>이벤트 발행자/구독자</li><li>메시지 브로커</li><li>이벤트 스토어</li></ul><p><strong>목적</strong>: 서비스 간 느슨한 결합 유지</p><p><strong>실제 예시</strong>: 전자상거래 주문 처리</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a class=lnlinks href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a class=lnlinks href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a class=lnlinks href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a class=lnlinks href=#hl-17-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 주문 서비스</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>order_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>OrderCreatedEvent</span><span class=p>(</span><span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 결제 서비스</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nd>@event_handler</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>payment_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_payment</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>payment_result</span><span class=o>.</span><span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>PaymentProcessedEvent</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>PaymentFailedEvent</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-오케스트레이션-orchestration-패턴>2. 오케스트레이션 (Orchestration) 패턴<a hidden class=anchor aria-hidden=true href=#2-오케스트레이션-orchestration-패턴>#</a></h3><p><strong>정의</strong>: 중앙 코디네이터가 트랜잭션 흐름을 관리하는 방식</p><p><strong>구성</strong>:</p><ul><li>사가 오케스트레이터</li><li>커맨드/응답 메커니즘</li><li>상태 머신</li></ul><p><strong>목적</strong>: 중앙 집중식 트랜잭션 제어</p><p><strong>실제 예시</strong>: 여행 예약 시스템</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16>16</a>
</span><span class=lnt id=hl-18-17><a class=lnlinks href=#hl-18-17>17</a>
</span><span class=lnt id=hl-18-18><a class=lnlinks href=#hl-18-18>18</a>
</span><span class=lnt id=hl-18-19><a class=lnlinks href=#hl-18-19>19</a>
</span><span class=lnt id=hl-18-20><a class=lnlinks href=#hl-18-20>20</a>
</span><span class=lnt id=hl-18-21><a class=lnlinks href=#hl-18-21>21</a>
</span><span class=lnt id=hl-18-22><a class=lnlinks href=#hl-18-22>22</a>
</span><span class=lnt id=hl-18-23><a class=lnlinks href=#hl-18-23>23</a>
</span><span class=lnt id=hl-18-24><a class=lnlinks href=#hl-18-24>24</a>
</span><span class=lnt id=hl-18-25><a class=lnlinks href=#hl-18-25>25</a>
</span><span class=lnt id=hl-18-26><a class=lnlinks href=#hl-18-26>26</a>
</span><span class=lnt id=hl-18-27><a class=lnlinks href=#hl-18-27>27</a>
</span><span class=lnt id=hl-18-28><a class=lnlinks href=#hl-18-28>28</a>
</span><span class=lnt id=hl-18-29><a class=lnlinks href=#hl-18-29>29</a>
</span><span class=lnt id=hl-18-30><a class=lnlinks href=#hl-18-30>30</a>
</span><span class=lnt id=hl-18-31><a class=lnlinks href=#hl-18-31>31</a>
</span><span class=lnt id=hl-18-32><a class=lnlinks href=#hl-18-32>32</a>
</span><span class=lnt id=hl-18-33><a class=lnlinks href=#hl-18-33>33</a>
</span><span class=lnt id=hl-18-34><a class=lnlinks href=#hl-18-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>TravelBookingSaga</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;STARTED&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>booking_request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 항공편 예약</span>
</span></span><span class=line><span class=cl>            <span class=n>flight_booking</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>flight_service</span><span class=o>.</span><span class=n>book</span><span class=p>(</span><span class=n>booking_request</span><span class=o>.</span><span class=n>flight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>[</span><span class=s1>&#39;flight&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>flight_booking</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 호텔 예약</span>
</span></span><span class=line><span class=cl>            <span class=n>hotel_booking</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>hotel_service</span><span class=o>.</span><span class=n>book</span><span class=p>(</span><span class=n>booking_request</span><span class=o>.</span><span class=n>hotel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>[</span><span class=s1>&#39;hotel&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>hotel_booking</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 렌터카 예약</span>
</span></span><span class=line><span class=cl>            <span class=n>car_booking</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>car_service</span><span class=o>.</span><span class=n>book</span><span class=p>(</span><span class=n>booking_request</span><span class=o>.</span><span class=n>car</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>[</span><span class=s1>&#39;car&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>car_booking</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>compensate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>compensate</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;car&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>car_service</span><span class=o>.</span><span class=n>cancel</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>[</span><span class=s1>&#39;car&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;hotel&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>hotel_service</span><span class=o>.</span><span class=n>cancel</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>[</span><span class=s1>&#39;hotel&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;flight&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>flight_service</span><span class=o>.</span><span class=n>cancel</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bookings</span><span class=p>[</span><span class=s1>&#39;flight&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATED&#34;</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=6-장점>6. 장점<a hidden class=anchor aria-hidden=true href=#6-장점>#</a></h2><table><thead><tr><th>구분</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>장점</td><td><strong>확장성</strong></td><td>서비스별 독립적인 데이터베이스로 수평 확장 가능</td></tr><tr><td></td><td><strong>가용성</strong></td><td>부분 실패가 전체 시스템에 미치는 영향 최소화</td></tr><tr><td></td><td><strong>서비스 자율성</strong></td><td>각 서비스가 독립적으로 기술 스택 선택 가능</td></tr><tr><td></td><td><strong>성능</strong></td><td>비동기 처리로 전체적인 응답 시간 향상</td></tr><tr><td></td><td><strong>유연성</strong></td><td>새로운 서비스 추가 시 기존 서비스 변경 최소화</td></tr></tbody></table><hr><h2 id=7-단점과-문제점-그리고-해결방안>7. 단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#7-단점과-문제점-그리고-해결방안>#</a></h2><h3 id=단점>단점<a hidden class=anchor aria-hidden=true href=#단점>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>단점</td><td><strong>복잡성 증가</strong></td><td>보상 트랜잭션 설계 및 관리 복잡</td><td>프레임워크 활용, 표준화된 패턴 적용</td></tr><tr><td></td><td><strong>Eventual Consistency</strong></td><td>일시적 데이터 불일치 발생</td><td>비즈니스 규칙에 맞는 일관성 레벨 설정</td></tr><tr><td></td><td><strong>디버깅 어려움</strong></td><td>분산된 트랜잭션 추적 복잡</td><td>분산 추적 도구 활용 (Jaeger, Zipkin)</td></tr><tr><td></td><td><strong>보상 트랜잭션 실패</strong></td><td>보상 과정에서 추가 실패 가능성</td><td>재시도 메커니즘, 수동 개입 프로세스</td></tr></tbody></table><h3 id=문제점>문제점<a hidden class=anchor aria-hidden=true href=#문제점>#</a></h3><table><thead><tr><th>구분</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td>문제점</td><td><strong>데이터 이상 현상</strong></td><td>동시 실행되는 사가 간 격리 부족</td><td>데이터 불일치, 비즈니스 규칙 위반</td><td>데이터 검증, 모니터링</td><td>격리 기법 적용, 비관적 잠금</td><td>Semantic Lock, Version 관리</td></tr><tr><td></td><td><strong>무한 재시도</strong></td><td>보상 트랜잭션의 반복 실패</td><td>시스템 리소스 고갈</td><td>재시도 횟수 모니터링</td><td>재시도 제한, Circuit Breaker</td><td>수동 개입, Dead Letter Queue</td></tr><tr><td></td><td><strong>사가 상태 불일치</strong></td><td>네트워크 파티션, 서비스 장애</td><td>트랜잭션 완료 불가</td><td>상태 추적 시스템</td><td>Saga Log, Checkpoint</td><td>상태 복구 프로세스</td></tr></tbody></table><hr><h2 id=8-분류-기준에-따른-종류-및-유형>8. 분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#8-분류-기준에-따른-종류-및-유형>#</a></h2><table><thead><tr><th>분류 기준</th><th>유형</th><th>설명</th><th>특징</th></tr></thead><tbody><tr><td><strong>구현 방식</strong></td><td>코레오그래피</td><td>분산형 이벤트 기반</td><td>느슨한 결합, 복잡한 추적</td></tr><tr><td></td><td>오케스트레이션</td><td>중앙 집중형 제어</td><td>명확한 흐름, 단일 실패 지점</td></tr><tr><td><strong>트랜잭션 유형</strong></td><td>보상 가능</td><td>되돌릴 수 있는 트랜잭션</td><td>대부분의 비즈니스 로직</td></tr><tr><td></td><td>피벗</td><td>되돌릴 수 없는 결정점</td><td>결제 승인, 최종 확정</td></tr><tr><td></td><td>재시도 가능</td><td>실패 시 재시도 가능</td><td>네트워크 호출, 외부 API</td></tr><tr><td><strong>일관성 모델</strong></td><td>강한 일관성</td><td>즉시 일관성 요구</td><td>금융 거래</td></tr><tr><td></td><td>약한 일관성</td><td>지연된 일관성 허용</td><td>추천 시스템, 분석</td></tr></tbody></table><hr><h2 id=9-실무-사용-예시>9. 실무 사용 예시<a hidden class=anchor aria-hidden=true href=#9-실무-사용-예시>#</a></h2><table><thead><tr><th>도메인</th><th>목적</th><th>함께 사용되는 기술</th><th>효과</th></tr></thead><tbody><tr><td><strong>전자상거래</strong></td><td>주문 - 결제 - 재고 - 배송 통합</td><td>Spring Boot, Kafka, MongoDB</td><td>99.9% 주문 처리 성공률</td></tr><tr><td><strong>금융 서비스</strong></td><td>계좌 이체 처리</td><td>Axon Framework, PostgreSQL</td><td>트랜잭션 무결성 보장</td></tr><tr><td><strong>여행 예약</strong></td><td>항공편 - 호텔 - 렌터카 예약</td><td>Camunda, RabbitMQ, MySQL</td><td>30% 예약 성공률 향상</td></tr><tr><td><strong>배송 관리</strong></td><td>주문 - 포장 - 배송 - 추적</td><td>Apache Camel, Redis, Cassandra</td><td>실시간 배송 상태 추적</td></tr></tbody></table><hr><h2 id=10-활용-사례>10. 활용 사례<a hidden class=anchor aria-hidden=true href=#10-활용-사례>#</a></h2><h3 id=전자상거래-주문-처리-시스템>전자상거래 주문 처리 시스템<a hidden class=anchor aria-hidden=true href=#전자상거래-주문-처리-시스템>#</a></h3><p><strong>시스템 구성</strong>:</p><ul><li>Order Service (주문 관리)</li><li>Payment Service (결제 처리)</li><li>Inventory Service (재고 관리)</li><li>Shipping Service (배송 관리)</li><li>Notification Service (알림 서비스)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph LR
    A[Web Frontend] --&gt; B[API Gateway]
    B --&gt; C[Order Service]
    B --&gt; D[Payment Service]
    B --&gt; E[Inventory Service]
    B --&gt; F[Shipping Service]
    B --&gt; G[Notification Service]
    
    C --&gt; H[(Order DB)]
    D --&gt; I[(Payment DB)]
    E --&gt; J[(Inventory DB)]
    F --&gt; K[(Shipping DB)]
    G --&gt; L[(Notification DB)]
    
    M[Message Broker] --&gt; C
    M --&gt; D
    M --&gt; E
    M --&gt; F
    M --&gt; G
</pre><p><strong>Workflow</strong>:</p><ol><li>고객이 주문 생성 요청</li><li>Order Service 가 주문을 PENDING 상태로 생성</li><li>Payment Service 가 결제 처리</li><li>Inventory Service 가 재고 차감</li><li>Shipping Service 가 배송 준비</li><li>Notification Service 가 고객에게 알림 발송</li></ol><p><strong>역할</strong>:</p><ul><li>분산 트랜잭션 조정</li><li>실패 시 자동 보상</li><li>서비스 간 느슨한 결합 유지</li></ul><p><strong>기존 방식과의 차이점</strong>:</p><ul><li>2PC 대비 25% 성능 향상</li><li>서비스 장애 시 부분 복구 가능</li><li>수평 확장성 개선</li></ul><hr><h2 id=11-구현-예시>11. 구현 예시<a hidden class=anchor aria-hidden=true href=#11-구현-예시>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>  1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>  2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>  3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>  4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5>  5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6>  6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7>  7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8>  8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9>  9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10> 10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11> 11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12> 12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13> 13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14> 14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15> 15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16> 16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17> 17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18> 18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19> 19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20> 20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21> 21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22> 22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23> 23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24> 24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25> 25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26> 26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27> 27</a>
</span><span class=lnt id=hl-20-28><a class=lnlinks href=#hl-20-28> 28</a>
</span><span class=lnt id=hl-20-29><a class=lnlinks href=#hl-20-29> 29</a>
</span><span class=lnt id=hl-20-30><a class=lnlinks href=#hl-20-30> 30</a>
</span><span class=lnt id=hl-20-31><a class=lnlinks href=#hl-20-31> 31</a>
</span><span class=lnt id=hl-20-32><a class=lnlinks href=#hl-20-32> 32</a>
</span><span class=lnt id=hl-20-33><a class=lnlinks href=#hl-20-33> 33</a>
</span><span class=lnt id=hl-20-34><a class=lnlinks href=#hl-20-34> 34</a>
</span><span class=lnt id=hl-20-35><a class=lnlinks href=#hl-20-35> 35</a>
</span><span class=lnt id=hl-20-36><a class=lnlinks href=#hl-20-36> 36</a>
</span><span class=lnt id=hl-20-37><a class=lnlinks href=#hl-20-37> 37</a>
</span><span class=lnt id=hl-20-38><a class=lnlinks href=#hl-20-38> 38</a>
</span><span class=lnt id=hl-20-39><a class=lnlinks href=#hl-20-39> 39</a>
</span><span class=lnt id=hl-20-40><a class=lnlinks href=#hl-20-40> 40</a>
</span><span class=lnt id=hl-20-41><a class=lnlinks href=#hl-20-41> 41</a>
</span><span class=lnt id=hl-20-42><a class=lnlinks href=#hl-20-42> 42</a>
</span><span class=lnt id=hl-20-43><a class=lnlinks href=#hl-20-43> 43</a>
</span><span class=lnt id=hl-20-44><a class=lnlinks href=#hl-20-44> 44</a>
</span><span class=lnt id=hl-20-45><a class=lnlinks href=#hl-20-45> 45</a>
</span><span class=lnt id=hl-20-46><a class=lnlinks href=#hl-20-46> 46</a>
</span><span class=lnt id=hl-20-47><a class=lnlinks href=#hl-20-47> 47</a>
</span><span class=lnt id=hl-20-48><a class=lnlinks href=#hl-20-48> 48</a>
</span><span class=lnt id=hl-20-49><a class=lnlinks href=#hl-20-49> 49</a>
</span><span class=lnt id=hl-20-50><a class=lnlinks href=#hl-20-50> 50</a>
</span><span class=lnt id=hl-20-51><a class=lnlinks href=#hl-20-51> 51</a>
</span><span class=lnt id=hl-20-52><a class=lnlinks href=#hl-20-52> 52</a>
</span><span class=lnt id=hl-20-53><a class=lnlinks href=#hl-20-53> 53</a>
</span><span class=lnt id=hl-20-54><a class=lnlinks href=#hl-20-54> 54</a>
</span><span class=lnt id=hl-20-55><a class=lnlinks href=#hl-20-55> 55</a>
</span><span class=lnt id=hl-20-56><a class=lnlinks href=#hl-20-56> 56</a>
</span><span class=lnt id=hl-20-57><a class=lnlinks href=#hl-20-57> 57</a>
</span><span class=lnt id=hl-20-58><a class=lnlinks href=#hl-20-58> 58</a>
</span><span class=lnt id=hl-20-59><a class=lnlinks href=#hl-20-59> 59</a>
</span><span class=lnt id=hl-20-60><a class=lnlinks href=#hl-20-60> 60</a>
</span><span class=lnt id=hl-20-61><a class=lnlinks href=#hl-20-61> 61</a>
</span><span class=lnt id=hl-20-62><a class=lnlinks href=#hl-20-62> 62</a>
</span><span class=lnt id=hl-20-63><a class=lnlinks href=#hl-20-63> 63</a>
</span><span class=lnt id=hl-20-64><a class=lnlinks href=#hl-20-64> 64</a>
</span><span class=lnt id=hl-20-65><a class=lnlinks href=#hl-20-65> 65</a>
</span><span class=lnt id=hl-20-66><a class=lnlinks href=#hl-20-66> 66</a>
</span><span class=lnt id=hl-20-67><a class=lnlinks href=#hl-20-67> 67</a>
</span><span class=lnt id=hl-20-68><a class=lnlinks href=#hl-20-68> 68</a>
</span><span class=lnt id=hl-20-69><a class=lnlinks href=#hl-20-69> 69</a>
</span><span class=lnt id=hl-20-70><a class=lnlinks href=#hl-20-70> 70</a>
</span><span class=lnt id=hl-20-71><a class=lnlinks href=#hl-20-71> 71</a>
</span><span class=lnt id=hl-20-72><a class=lnlinks href=#hl-20-72> 72</a>
</span><span class=lnt id=hl-20-73><a class=lnlinks href=#hl-20-73> 73</a>
</span><span class=lnt id=hl-20-74><a class=lnlinks href=#hl-20-74> 74</a>
</span><span class=lnt id=hl-20-75><a class=lnlinks href=#hl-20-75> 75</a>
</span><span class=lnt id=hl-20-76><a class=lnlinks href=#hl-20-76> 76</a>
</span><span class=lnt id=hl-20-77><a class=lnlinks href=#hl-20-77> 77</a>
</span><span class=lnt id=hl-20-78><a class=lnlinks href=#hl-20-78> 78</a>
</span><span class=lnt id=hl-20-79><a class=lnlinks href=#hl-20-79> 79</a>
</span><span class=lnt id=hl-20-80><a class=lnlinks href=#hl-20-80> 80</a>
</span><span class=lnt id=hl-20-81><a class=lnlinks href=#hl-20-81> 81</a>
</span><span class=lnt id=hl-20-82><a class=lnlinks href=#hl-20-82> 82</a>
</span><span class=lnt id=hl-20-83><a class=lnlinks href=#hl-20-83> 83</a>
</span><span class=lnt id=hl-20-84><a class=lnlinks href=#hl-20-84> 84</a>
</span><span class=lnt id=hl-20-85><a class=lnlinks href=#hl-20-85> 85</a>
</span><span class=lnt id=hl-20-86><a class=lnlinks href=#hl-20-86> 86</a>
</span><span class=lnt id=hl-20-87><a class=lnlinks href=#hl-20-87> 87</a>
</span><span class=lnt id=hl-20-88><a class=lnlinks href=#hl-20-88> 88</a>
</span><span class=lnt id=hl-20-89><a class=lnlinks href=#hl-20-89> 89</a>
</span><span class=lnt id=hl-20-90><a class=lnlinks href=#hl-20-90> 90</a>
</span><span class=lnt id=hl-20-91><a class=lnlinks href=#hl-20-91> 91</a>
</span><span class=lnt id=hl-20-92><a class=lnlinks href=#hl-20-92> 92</a>
</span><span class=lnt id=hl-20-93><a class=lnlinks href=#hl-20-93> 93</a>
</span><span class=lnt id=hl-20-94><a class=lnlinks href=#hl-20-94> 94</a>
</span><span class=lnt id=hl-20-95><a class=lnlinks href=#hl-20-95> 95</a>
</span><span class=lnt id=hl-20-96><a class=lnlinks href=#hl-20-96> 96</a>
</span><span class=lnt id=hl-20-97><a class=lnlinks href=#hl-20-97> 97</a>
</span><span class=lnt id=hl-20-98><a class=lnlinks href=#hl-20-98> 98</a>
</span><span class=lnt id=hl-20-99><a class=lnlinks href=#hl-20-99> 99</a>
</span><span class=lnt id=hl-20-100><a class=lnlinks href=#hl-20-100>100</a>
</span><span class=lnt id=hl-20-101><a class=lnlinks href=#hl-20-101>101</a>
</span><span class=lnt id=hl-20-102><a class=lnlinks href=#hl-20-102>102</a>
</span><span class=lnt id=hl-20-103><a class=lnlinks href=#hl-20-103>103</a>
</span><span class=lnt id=hl-20-104><a class=lnlinks href=#hl-20-104>104</a>
</span><span class=lnt id=hl-20-105><a class=lnlinks href=#hl-20-105>105</a>
</span><span class=lnt id=hl-20-106><a class=lnlinks href=#hl-20-106>106</a>
</span><span class=lnt id=hl-20-107><a class=lnlinks href=#hl-20-107>107</a>
</span><span class=lnt id=hl-20-108><a class=lnlinks href=#hl-20-108>108</a>
</span><span class=lnt id=hl-20-109><a class=lnlinks href=#hl-20-109>109</a>
</span><span class=lnt id=hl-20-110><a class=lnlinks href=#hl-20-110>110</a>
</span><span class=lnt id=hl-20-111><a class=lnlinks href=#hl-20-111>111</a>
</span><span class=lnt id=hl-20-112><a class=lnlinks href=#hl-20-112>112</a>
</span><span class=lnt id=hl-20-113><a class=lnlinks href=#hl-20-113>113</a>
</span><span class=lnt id=hl-20-114><a class=lnlinks href=#hl-20-114>114</a>
</span><span class=lnt id=hl-20-115><a class=lnlinks href=#hl-20-115>115</a>
</span><span class=lnt id=hl-20-116><a class=lnlinks href=#hl-20-116>116</a>
</span><span class=lnt id=hl-20-117><a class=lnlinks href=#hl-20-117>117</a>
</span><span class=lnt id=hl-20-118><a class=lnlinks href=#hl-20-118>118</a>
</span><span class=lnt id=hl-20-119><a class=lnlinks href=#hl-20-119>119</a>
</span><span class=lnt id=hl-20-120><a class=lnlinks href=#hl-20-120>120</a>
</span><span class=lnt id=hl-20-121><a class=lnlinks href=#hl-20-121>121</a>
</span><span class=lnt id=hl-20-122><a class=lnlinks href=#hl-20-122>122</a>
</span><span class=lnt id=hl-20-123><a class=lnlinks href=#hl-20-123>123</a>
</span><span class=lnt id=hl-20-124><a class=lnlinks href=#hl-20-124>124</a>
</span><span class=lnt id=hl-20-125><a class=lnlinks href=#hl-20-125>125</a>
</span><span class=lnt id=hl-20-126><a class=lnlinks href=#hl-20-126>126</a>
</span><span class=lnt id=hl-20-127><a class=lnlinks href=#hl-20-127>127</a>
</span><span class=lnt id=hl-20-128><a class=lnlinks href=#hl-20-128>128</a>
</span><span class=lnt id=hl-20-129><a class=lnlinks href=#hl-20-129>129</a>
</span><span class=lnt id=hl-20-130><a class=lnlinks href=#hl-20-130>130</a>
</span><span class=lnt id=hl-20-131><a class=lnlinks href=#hl-20-131>131</a>
</span><span class=lnt id=hl-20-132><a class=lnlinks href=#hl-20-132>132</a>
</span><span class=lnt id=hl-20-133><a class=lnlinks href=#hl-20-133>133</a>
</span><span class=lnt id=hl-20-134><a class=lnlinks href=#hl-20-134>134</a>
</span><span class=lnt id=hl-20-135><a class=lnlinks href=#hl-20-135>135</a>
</span><span class=lnt id=hl-20-136><a class=lnlinks href=#hl-20-136>136</a>
</span><span class=lnt id=hl-20-137><a class=lnlinks href=#hl-20-137>137</a>
</span><span class=lnt id=hl-20-138><a class=lnlinks href=#hl-20-138>138</a>
</span><span class=lnt id=hl-20-139><a class=lnlinks href=#hl-20-139>139</a>
</span><span class=lnt id=hl-20-140><a class=lnlinks href=#hl-20-140>140</a>
</span><span class=lnt id=hl-20-141><a class=lnlinks href=#hl-20-141>141</a>
</span><span class=lnt id=hl-20-142><a class=lnlinks href=#hl-20-142>142</a>
</span><span class=lnt id=hl-20-143><a class=lnlinks href=#hl-20-143>143</a>
</span><span class=lnt id=hl-20-144><a class=lnlinks href=#hl-20-144>144</a>
</span><span class=lnt id=hl-20-145><a class=lnlinks href=#hl-20-145>145</a>
</span><span class=lnt id=hl-20-146><a class=lnlinks href=#hl-20-146>146</a>
</span><span class=lnt id=hl-20-147><a class=lnlinks href=#hl-20-147>147</a>
</span><span class=lnt id=hl-20-148><a class=lnlinks href=#hl-20-148>148</a>
</span><span class=lnt id=hl-20-149><a class=lnlinks href=#hl-20-149>149</a>
</span><span class=lnt id=hl-20-150><a class=lnlinks href=#hl-20-150>150</a>
</span><span class=lnt id=hl-20-151><a class=lnlinks href=#hl-20-151>151</a>
</span><span class=lnt id=hl-20-152><a class=lnlinks href=#hl-20-152>152</a>
</span><span class=lnt id=hl-20-153><a class=lnlinks href=#hl-20-153>153</a>
</span><span class=lnt id=hl-20-154><a class=lnlinks href=#hl-20-154>154</a>
</span><span class=lnt id=hl-20-155><a class=lnlinks href=#hl-20-155>155</a>
</span><span class=lnt id=hl-20-156><a class=lnlinks href=#hl-20-156>156</a>
</span><span class=lnt id=hl-20-157><a class=lnlinks href=#hl-20-157>157</a>
</span><span class=lnt id=hl-20-158><a class=lnlinks href=#hl-20-158>158</a>
</span><span class=lnt id=hl-20-159><a class=lnlinks href=#hl-20-159>159</a>
</span><span class=lnt id=hl-20-160><a class=lnlinks href=#hl-20-160>160</a>
</span><span class=lnt id=hl-20-161><a class=lnlinks href=#hl-20-161>161</a>
</span><span class=lnt id=hl-20-162><a class=lnlinks href=#hl-20-162>162</a>
</span><span class=lnt id=hl-20-163><a class=lnlinks href=#hl-20-163>163</a>
</span><span class=lnt id=hl-20-164><a class=lnlinks href=#hl-20-164>164</a>
</span><span class=lnt id=hl-20-165><a class=lnlinks href=#hl-20-165>165</a>
</span><span class=lnt id=hl-20-166><a class=lnlinks href=#hl-20-166>166</a>
</span><span class=lnt id=hl-20-167><a class=lnlinks href=#hl-20-167>167</a>
</span><span class=lnt id=hl-20-168><a class=lnlinks href=#hl-20-168>168</a>
</span><span class=lnt id=hl-20-169><a class=lnlinks href=#hl-20-169>169</a>
</span><span class=lnt id=hl-20-170><a class=lnlinks href=#hl-20-170>170</a>
</span><span class=lnt id=hl-20-171><a class=lnlinks href=#hl-20-171>171</a>
</span><span class=lnt id=hl-20-172><a class=lnlinks href=#hl-20-172>172</a>
</span><span class=lnt id=hl-20-173><a class=lnlinks href=#hl-20-173>173</a>
</span><span class=lnt id=hl-20-174><a class=lnlinks href=#hl-20-174>174</a>
</span><span class=lnt id=hl-20-175><a class=lnlinks href=#hl-20-175>175</a>
</span><span class=lnt id=hl-20-176><a class=lnlinks href=#hl-20-176>176</a>
</span><span class=lnt id=hl-20-177><a class=lnlinks href=#hl-20-177>177</a>
</span><span class=lnt id=hl-20-178><a class=lnlinks href=#hl-20-178>178</a>
</span><span class=lnt id=hl-20-179><a class=lnlinks href=#hl-20-179>179</a>
</span><span class=lnt id=hl-20-180><a class=lnlinks href=#hl-20-180>180</a>
</span><span class=lnt id=hl-20-181><a class=lnlinks href=#hl-20-181>181</a>
</span><span class=lnt id=hl-20-182><a class=lnlinks href=#hl-20-182>182</a>
</span><span class=lnt id=hl-20-183><a class=lnlinks href=#hl-20-183>183</a>
</span><span class=lnt id=hl-20-184><a class=lnlinks href=#hl-20-184>184</a>
</span><span class=lnt id=hl-20-185><a class=lnlinks href=#hl-20-185>185</a>
</span><span class=lnt id=hl-20-186><a class=lnlinks href=#hl-20-186>186</a>
</span><span class=lnt id=hl-20-187><a class=lnlinks href=#hl-20-187>187</a>
</span><span class=lnt id=hl-20-188><a class=lnlinks href=#hl-20-188>188</a>
</span><span class=lnt id=hl-20-189><a class=lnlinks href=#hl-20-189>189</a>
</span><span class=lnt id=hl-20-190><a class=lnlinks href=#hl-20-190>190</a>
</span><span class=lnt id=hl-20-191><a class=lnlinks href=#hl-20-191>191</a>
</span><span class=lnt id=hl-20-192><a class=lnlinks href=#hl-20-192>192</a>
</span><span class=lnt id=hl-20-193><a class=lnlinks href=#hl-20-193>193</a>
</span><span class=lnt id=hl-20-194><a class=lnlinks href=#hl-20-194>194</a>
</span><span class=lnt id=hl-20-195><a class=lnlinks href=#hl-20-195>195</a>
</span><span class=lnt id=hl-20-196><a class=lnlinks href=#hl-20-196>196</a>
</span><span class=lnt id=hl-20-197><a class=lnlinks href=#hl-20-197>197</a>
</span><span class=lnt id=hl-20-198><a class=lnlinks href=#hl-20-198>198</a>
</span><span class=lnt id=hl-20-199><a class=lnlinks href=#hl-20-199>199</a>
</span><span class=lnt id=hl-20-200><a class=lnlinks href=#hl-20-200>200</a>
</span><span class=lnt id=hl-20-201><a class=lnlinks href=#hl-20-201>201</a>
</span><span class=lnt id=hl-20-202><a class=lnlinks href=#hl-20-202>202</a>
</span><span class=lnt id=hl-20-203><a class=lnlinks href=#hl-20-203>203</a>
</span><span class=lnt id=hl-20-204><a class=lnlinks href=#hl-20-204>204</a>
</span><span class=lnt id=hl-20-205><a class=lnlinks href=#hl-20-205>205</a>
</span><span class=lnt id=hl-20-206><a class=lnlinks href=#hl-20-206>206</a>
</span><span class=lnt id=hl-20-207><a class=lnlinks href=#hl-20-207>207</a>
</span><span class=lnt id=hl-20-208><a class=lnlinks href=#hl-20-208>208</a>
</span><span class=lnt id=hl-20-209><a class=lnlinks href=#hl-20-209>209</a>
</span><span class=lnt id=hl-20-210><a class=lnlinks href=#hl-20-210>210</a>
</span><span class=lnt id=hl-20-211><a class=lnlinks href=#hl-20-211>211</a>
</span><span class=lnt id=hl-20-212><a class=lnlinks href=#hl-20-212>212</a>
</span><span class=lnt id=hl-20-213><a class=lnlinks href=#hl-20-213>213</a>
</span><span class=lnt id=hl-20-214><a class=lnlinks href=#hl-20-214>214</a>
</span><span class=lnt id=hl-20-215><a class=lnlinks href=#hl-20-215>215</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaStatus</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>STARTED</span> <span class=o>=</span> <span class=s2>&#34;STARTED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>COMPLETED</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>COMPENSATING</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATING&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FAILED</span> <span class=o>=</span> <span class=s2>&#34;FAILED&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderData</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaStep</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>step_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>compensating_action</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;PENDING&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderProcessingSaga</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>saga_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>SagaStatus</span><span class=o>.</span><span class=n>STARTED</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>SagaStep</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>completed_steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_order_saga</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_data</span><span class=p>:</span> <span class=n>OrderData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 처리 사가 실행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Step 1: 주문 생성</span>
</span></span><span class=line><span class=cl>            <span class=n>order_step</span> <span class=o>=</span> <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;OrderService&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=s2>&#34;create_order&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>compensating_action</span><span class=o>=</span><span class=s2>&#34;cancel_order&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>order_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_order</span><span class=p>(</span><span class=n>order_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>order_step</span><span class=o>.</span><span class=n>result</span> <span class=o>=</span> <span class=n>order_result</span>
</span></span><span class=line><span class=cl>            <span class=n>order_step</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>order_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>completed_steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Step 2: 결제 처리</span>
</span></span><span class=line><span class=cl>            <span class=n>payment_step</span> <span class=o>=</span> <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;PaymentService&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=s2>&#34;process_payment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>compensating_action</span><span class=o>=</span><span class=s2>&#34;refund_payment&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>payment_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_payment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>order_result</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                <span class=n>order_data</span><span class=o>.</span><span class=n>amount</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>payment_step</span><span class=o>.</span><span class=n>result</span> <span class=o>=</span> <span class=n>payment_result</span>
</span></span><span class=line><span class=cl>            <span class=n>payment_step</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>payment_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>completed_steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Step 3: 재고 차감</span>
</span></span><span class=line><span class=cl>            <span class=n>inventory_step</span> <span class=o>=</span> <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;InventoryService&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=s2>&#34;reserve_inventory&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>compensating_action</span><span class=o>=</span><span class=s2>&#34;release_inventory&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>inventory_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>reserve_inventory</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>order_data</span><span class=o>.</span><span class=n>product_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>order_data</span><span class=o>.</span><span class=n>quantity</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>inventory_step</span><span class=o>.</span><span class=n>result</span> <span class=o>=</span> <span class=n>inventory_result</span>
</span></span><span class=line><span class=cl>            <span class=n>inventory_step</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>inventory_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>completed_steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Step 4: 배송 준비</span>
</span></span><span class=line><span class=cl>            <span class=n>shipping_step</span> <span class=o>=</span> <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;ShippingService&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>action</span><span class=o>=</span><span class=s2>&#34;prepare_shipment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>compensating_action</span><span class=o>=</span><span class=s2>&#34;cancel_shipment&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>shipping_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>prepare_shipment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>order_result</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>shipping_step</span><span class=o>.</span><span class=n>result</span> <span class=o>=</span> <span class=n>shipping_result</span>
</span></span><span class=line><span class=cl>            <span class=n>shipping_step</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>shipping_step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>completed_steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>SagaStatus</span><span class=o>.</span><span class=n>COMPLETED</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;SUCCESS&#34;</span><span class=p>,</span> <span class=s2>&#34;saga_id&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>saga_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;사가 실행 중 오류 발생: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>compensate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;FAILED&#34;</span><span class=p>,</span> <span class=s2>&#34;saga_id&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>saga_id</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>compensate</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;보상 트랜잭션 실행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>SagaStatus</span><span class=o>.</span><span class=n>COMPENSATING</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 완료된 단계를 역순으로 보상</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step_id</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>completed_steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>step</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>steps</span> <span class=k>if</span> <span class=n>s</span><span class=o>.</span><span class=n>step_id</span> <span class=o>==</span> <span class=n>step_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>step</span><span class=o>.</span><span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;ShippingService&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cancel_shipment</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;shipment_id&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>step</span><span class=o>.</span><span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;InventoryService&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>release_inventory</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>step</span><span class=o>.</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;product_id&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>step</span><span class=o>.</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;quantity&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>step</span><span class=o>.</span><span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;PaymentService&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>refund_payment</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;payment_id&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>step</span><span class=o>.</span><span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;OrderService&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cancel_order</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                <span class=n>step</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATED&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Step </span><span class=si>{</span><span class=n>step_id</span><span class=si>}</span><span class=s2> 보상 완료&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;보상 트랜잭션 실패 - Step </span><span class=si>{</span><span class=n>step_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>step</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATION_FAILED&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>SagaStatus</span><span class=o>.</span><span class=n>FAILED</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 각 서비스 메서드들 (실제로는 HTTP 호출)</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_data</span><span class=p>:</span> <span class=n>OrderData</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 서비스 호출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 시뮬레이션: 주문 서비스 API 호출</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 생성 완료: </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;PENDING&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process_payment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;결제 처리 서비스 호출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 10% 확률로 결제 실패 시뮬레이션</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;결제 처리 실패&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>payment_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;결제 처리 완료: </span><span class=si>{</span><span class=n>payment_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;payment_id&#34;</span><span class=p>:</span> <span class=n>payment_id</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=n>amount</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>reserve_inventory</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;재고 예약 서비스 호출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;재고 예약 완료: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, 수량: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;product_id&#34;</span><span class=p>:</span> <span class=n>product_id</span><span class=p>,</span> <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=n>quantity</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>prepare_shipment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;배송 준비 서비스 호출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>shipment_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;배송 준비 완료: </span><span class=si>{</span><span class=n>shipment_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;shipment_id&#34;</span><span class=p>:</span> <span class=n>shipment_id</span><span class=p>,</span> <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 보상 트랜잭션 메서드들</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>cancel_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 취소 완료: </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>refund_payment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payment_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;결제 환불 완료: </span><span class=si>{</span><span class=n>payment_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>release_inventory</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;재고 해제 완료: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, 수량: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>cancel_shipment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>shipment_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;배송 취소 완료: </span><span class=si>{</span><span class=n>shipment_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;사가 패턴 실행 예시&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>saga</span> <span class=o>=</span> <span class=n>OrderProcessingSaga</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>order_data</span> <span class=o>=</span> <span class=n>OrderData</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>customer_id</span><span class=o>=</span><span class=s2>&#34;customer_123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>product_id</span><span class=o>=</span><span class=s2>&#34;product_456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>quantity</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span><span class=o>=</span><span class=mf>99.99</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 주문 처리 사가 시작 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>saga</span><span class=o>.</span><span class=n>execute_order_saga</span><span class=p>(</span><span class=n>order_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 사가 실행 결과 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;상태: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;사가 ID: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;saga_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;FAILED&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;오류: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;Unknown error&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 사가 단계 상세 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>saga</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Step </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>service_name</span><span class=si>}</span><span class=s2>): </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 실행</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=12-도전-과제>12. 도전 과제<a hidden class=anchor aria-hidden=true href=#12-도전-과제>#</a></h2><h3 id=기술적-도전-과제>기술적 도전 과제<a hidden class=anchor aria-hidden=true href=#기술적-도전-과제>#</a></h3><table><thead><tr><th>카테고리</th><th>과제</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td><strong>성능</strong></td><td>지연 시간 증가</td><td>다단계 비동기 처리</td><td>사용자 경험 저하</td><td>APM 도구, 분산 추적</td><td>병렬 처리, 캐싱</td><td>비동기 최적화, 배치 처리</td></tr><tr><td><strong>복잡성</strong></td><td>디버깅 어려움</td><td>분산 실행 환경</td><td>개발 생산성 저하</td><td>로그 집계, 상관관계 ID</td><td>표준화, 문서화</td><td>통합 모니터링 플랫폼</td></tr><tr><td><strong>일관성</strong></td><td>데이터 이상 현상</td><td>동시성 제어 부족</td><td>비즈니스 규칙 위반</td><td>데이터 검증, 감사</td><td>격리 수준 조정</td><td>시맨틱 락, 버전 관리</td></tr></tbody></table><h3 id=운영적-도전-과제>운영적 도전 과제<a hidden class=anchor aria-hidden=true href=#운영적-도전-과제>#</a></h3><table><thead><tr><th>카테고리</th><th>과제</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법 및 기법</th></tr></thead><tbody><tr><td><strong>모니터링</strong></td><td>상태 추적 복잡성</td><td>분산된 트랜잭션 상태</td><td>장애 대응 지연</td><td>대시보드, 알림 시스템</td><td>중앙화된 로깅</td><td>실시간 모니터링, SLA 관리</td></tr><tr><td><strong>보안</strong></td><td>분산 인증/인가</td><td>서비스 간 통신 보안</td><td>보안 취약점 노출</td><td>보안 감사, 침입 탐지</td><td>제로 트러스트 아키텍처</td><td>mTLS, JWT 토큰 관리</td></tr></tbody></table><hr><h2 id=13-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>13. 실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#13-실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h2><table><thead><tr><th>구분</th><th>고려사항</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>설계</strong></td><td>보상 트랜잭션 설계</td><td>모든 단계에 대한 보상 로직 필요</td><td>멱등성 보장, 간단한 보상 로직 설계</td></tr><tr><td><strong>구현</strong></td><td>이벤트 순서 보장</td><td>메시지 순서가 비즈니스 로직에 영향</td><td>파티션 키 활용, 순서 보장 메커니즘</td></tr><tr><td><strong>운영</strong></td><td>장애 처리 전략</td><td>부분 실패 상황 대응 방안</td><td>Circuit Breaker, Bulkhead 패턴 적용</td></tr><tr><td><strong>테스트</strong></td><td>분산 테스트</td><td>여러 서비스 간 통합 테스트 복잡</td><td>컨트랙트 테스트, 카오스 엔지니어링</td></tr><tr><td><strong>모니터링</strong></td><td>분산 추적</td><td>트랜잭션 전체 흐름 가시성</td><td>OpenTelemetry, Jaeger 활용</td></tr></tbody></table><hr><h2 id=14-최적화하기-위한-고려사항-및-주의할-점>14. 최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#14-최적화하기-위한-고려사항-및-주의할-점>#</a></h2><table><thead><tr><th>구분</th><th>고려사항</th><th>설명</th><th>권장사항</th></tr></thead><tbody><tr><td><strong>성능</strong></td><td>비동기 처리 최적화</td><td>불필요한 대기 시간 최소화</td><td>병렬 실행 가능한 단계 식별</td></tr><tr><td><strong>메모리</strong></td><td>사가 상태 관리</td><td>장기 실행 사가의 메모리 사용량</td><td>상태 외부화, 압축 저장</td></tr><tr><td><strong>네트워크</strong></td><td>메시지 크기 최적화</td><td>이벤트 페이로드 크기 최소화</td><td>참조 기반 메시지, 압축 적용</td></tr><tr><td><strong>데이터베이스</strong></td><td>트랜잭션 격리 수준</td><td>성능과 일관성 간 트레이드오프</td><td>비즈니스 요구사항에 맞는 격리 수준 선택</td></tr><tr><td><strong>캐싱</strong></td><td>중간 결과 캐싱</td><td>재계산 비용 절약</td><td>Redis, Hazelcast 활용</td></tr></tbody></table><hr><h2 id=15-기타-사항>15. 기타 사항<a hidden class=anchor aria-hidden=true href=#15-기타-사항>#</a></h2><h3 id=새로운-기술-트렌드>새로운 기술 트렌드<a hidden class=anchor aria-hidden=true href=#새로운-기술-트렌드>#</a></h3><ol><li><strong>서버리스 사가</strong>: AWS Step Functions, Azure Logic Apps 를 활용한 서버리스 사가 구현</li><li><strong>이벤트 소싱과의 결합</strong>: 이벤트 스토어 기반 사가 상태 관리</li><li><strong>AI/ML 통합</strong>: 사가 실행 패턴 분석을 통한 최적화 자동화</li><li><strong>GraphQL 연동</strong>: GraphQL Federation 과 사가 패턴의 통합</li></ol><h3 id=산업별-특화-패턴>산업별 특화 패턴<a hidden class=anchor aria-hidden=true href=#산업별-특화-패턴>#</a></h3><ol><li><strong>금융</strong>: 규제 요구사항을 고려한 감사 추적 강화</li><li><strong>전자상거래</strong>: 실시간 재고 관리와 사가 패턴 결합</li><li><strong>헬스케어</strong>: HIPAA 준수를 위한 보안 강화 사가</li><li><strong>IoT</strong>: 대용량 센서 데이터 처리를 위한 스트리밍 사가</li></ol><h3 id=주목할-새로운-개발>주목할 새로운 개발<a hidden class=anchor aria-hidden=true href=#주목할-새로운-개발>#</a></h3><ol><li><strong>Temporal.io</strong>: 분산 실행 플랫폼을 통한 사가 구현 단순화</li><li><strong>Conductor</strong>: Netflix 에서 개발한 워크플로우 오케스트레이션 엔진</li><li><strong>Camunda 8</strong>: 클라우드 네이티브 워크플로우 엔진</li></ol><hr><h2 id=16-주제와-관련하여-주목할-내용>16. 주제와 관련하여 주목할 내용<a hidden class=anchor aria-hidden=true href=#16-주제와-관련하여-주목할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>패턴</strong></td><td>관련 패턴</td><td>CQRS</td><td>명령과 조회 분리로 사가와 함께 사용</td></tr><tr><td></td><td></td><td>Event Sourcing</td><td>이벤트 기반 상태 관리</td></tr><tr><td></td><td></td><td>Outbox Pattern</td><td>트랜잭션과 메시지 발행의 원자성 보장</td></tr><tr><td><strong>기술</strong></td><td>메시징</td><td>Apache Kafka</td><td>고성능 이벤트 스트리밍 플랫폼</td></tr><tr><td></td><td></td><td>RabbitMQ</td><td>신뢰성 높은 메시지 브로커</td></tr><tr><td></td><td></td><td>Amazon EventBridge</td><td>서버리스 이벤트 버스</td></tr><tr><td><strong>프레임워크</strong></td><td>구현 도구</td><td>Axon Framework</td><td>Java 기반 CQRS/Event Sourcing</td></tr><tr><td></td><td></td><td>Camunda</td><td>BPM 기반 워크플로우 엔진</td></tr><tr><td></td><td></td><td>Temporal</td><td>분산 애플리케이션 오케스트레이션</td></tr></tbody></table><hr><h2 id=17-주제와-관련하여-반드시-학습해야할-내용>17. 주제와 관련하여 반드시 학습해야할 내용<a hidden class=anchor aria-hidden=true href=#17-주제와-관련하여-반드시-학습해야할-내용>#</a></h2><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td><strong>기초 이론</strong></td><td>분산 시스템</td><td>CAP 정리</td><td>일관성, 가용성, 파티션 내성의 트레이드오프</td></tr><tr><td></td><td></td><td>ACID vs BASE</td><td>전통적 트랜잭션과 분산 트랜잭션 모델 비교</td></tr><tr><td><strong>설계 패턴</strong></td><td>마이크로서비스</td><td>Database per Service</td><td>서비스별 독립적 데이터베이스 관리</td></tr><tr><td></td><td></td><td>API Gateway</td><td>서비스 간 통신 관리</td></tr><tr><td><strong>구현 기술</strong></td><td>메시징 패턴</td><td>Publish-Subscribe</td><td>비동기 이벤트 기반 통신</td></tr><tr><td></td><td></td><td>Message Queuing</td><td>신뢰성 있는 메시지 전달</td></tr><tr><td><strong>운영 관리</strong></td><td>모니터링</td><td>Distributed Tracing</td><td>분산 환경에서의 요청 추적</td></tr><tr><td></td><td></td><td>Circuit Breaker</td><td>장애 전파 방지 패턴</td></tr></tbody></table><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td><strong>핵심 개념</strong></td><td>Saga</td><td>분산 트랜잭션을 로컬 트랜잭션 시퀀스로 관리하는 패턴</td></tr><tr><td></td><td>Compensating Transaction</td><td>이전 단계의 변경사항을 되돌리는 보상 트랜잭션</td></tr><tr><td></td><td>Eventual Consistency</td><td>시간이 지나면서 모든 노드가 일관된 상태에 도달하는 모델</td></tr><tr><td><strong>구현 방식</strong></td><td>Choreography</td><td>중앙 조정자 없이 서비스 간 이벤트로 협력하는 방식</td></tr><tr><td></td><td>Orchestration</td><td>중앙 코디네이터가 트랜잭션 흐름을 관리하는 방식</td></tr><tr><td></td><td>Saga Execution Coordinator</td><td>사가 실행을 조정하는 중앙 컴포넌트</td></tr><tr><td><strong>트랜잭션</strong></td><td>Pivot Transaction</td><td>되돌릴 수 없는 결정점이 되는 트랜잭션</td></tr><tr><td></td><td>Idempotency</td><td>동일한 연산을 여러 번 수행해도 결과가 같은 성질</td></tr><tr><td><strong>메시징</strong></td><td>Event Bus</td><td>이벤트를 라우팅하고 전달하는 메시징 인프라</td></tr><tr><td></td><td>Message Broker</td><td>서비스 간 메시지 전달을 중재하는 미들웨어</td></tr><tr><td><strong>모니터링</strong></td><td>Distributed Tracing</td><td>분산 시스템에서 요청의 전체 경로를 추적하는 기술</td></tr><tr><td></td><td>Correlation ID</td><td>분산 환경에서 관련된 이벤트들을 연결하는 식별자</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://microservices.io/patterns/data/saga.html>Microservices Pattern: Saga</a></li><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/saga>Azure Architecture Center - Saga Design Pattern</a></li><li><a href=https://www.baeldung.com/cs/saga-pattern-microservices>Baeldung - Saga Pattern in Microservices</a></li><li><a href=https://docs.aws.amazon.com/prescriptive-guidance/latest/modernization-data-persistence/saga-pattern.html>AWS Prescriptive Guidance - Saga Pattern</a></li><li><a href=https://temporal.io/blog/mastering-saga-patterns-for-distributed-transactions-in-microservices>Temporal.io - Mastering Saga Patterns</a></li><li><a href=https://www.geeksforgeeks.org/saga-design-pattern/>GeeksforGeeks - SAGA Design Pattern</a></li><li><a href=https://orkes.io/blog/saga-pattern-in-distributed-systems/>Orkes Platform - Saga Pattern in Distributed Systems</a></li></ul><hr><p>Saga Pattern 은 마이크로서비스 아키텍처에서 분산 트랜잭션을 관리하기 위한 디자인 패턴이다.</p><p>Saga Pattern 은 여러 서비스에 걸친 데이터 일관성을 유지하기 위해 사용된다.<br>각 서비스의 로컬 트랜잭션을 순차적으로 실행하며, 실패 시 보상 트랜잭션을 통해 일관성을 유지한다.</p><p>주요 특징:</p><ul><li>분산 환경에서의 트랜잭션 관리</li><li>순차적인 로컬 트랜잭션 실행</li><li>실패 시 보상 트랜잭션 실행</li></ul><h3 id=saga-pattern-의-구현-방식>Saga Pattern 의 구현 방식<a hidden class=anchor aria-hidden=true href=#saga-pattern-의-구현-방식>#</a></h3><p>Saga Pattern 은 크게 두 가지 방식으로 구현할 수 있다:</p><ol><li>Choreography-based Saga<ul><li>각 서비스가 이벤트를 발행하고 구독하여 트랜잭션을 진행</li><li>중앙 조정자 없이 서비스 간 직접 통신<br>장점:</li><li>구현이 간단하고 이해하기 쉬움</li><li>서비스 간 결합도가 낮음<br>단점:</li><li>복잡한 워크플로우에서는 추적이 어려울 수 있음</li><li>순환 종속성 발생 가능성</li></ul></li></ol><p><figure><img alt="Choreography-based Saga" loading=lazy src=/img/Create_Order_Saga.png><figcaption>https://microservices.io/patterns/data/saga.html</figcaption></figure></p><ol><li>Orchestration-based Saga<ul><li>중앙 조정자 (Orchestrator) 가 트랜잭션 흐름을 관리</li><li>Orchestrator 가 각 서비스에 명령을 전달하고 응답을 처리<br>장점:</li><li>복잡한 워크플로우 관리에 적합</li><li>트랜잭션 추적이 용이<br>단점:</li><li>추가적인 서비스 (Orchestrator) 구현 필요</li><li>Orchestrator 가 단일 실패 지점이 될 수 있음</li></ul></li></ol><p><figure><img alt="Orchestration-based saga" loading=lazy src=/img/Create_Order_Saga_Orchestration.png><figcaption>https://microservices.io/patterns/data/saga.html</figcaption></figure></p><h3 id=saga-pattern-구현-단계>Saga Pattern 구현 단계<a hidden class=anchor aria-hidden=true href=#saga-pattern-구현-단계>#</a></h3><ol><li>트랜잭션 정의: 전체 비즈니스 프로세스를 단계별로 정의</li><li>보상 트랜잭션 설계: 각 단계의 실패 시 수행할 보상 작업 정의</li><li>이벤트 설계: 서비스 간 통신을 위한 이벤트 정의</li><li>상태 관리: 각 트랜잭션의 상태를 추적하고 관리할 방법 구현</li><li>오류 처리: 네트워크 오류, 타임아웃 등의 예외 상황 처리 로직 구현</li></ol><h3 id=사용-예시>사용 예시<a hidden class=anchor aria-hidden=true href=#사용-예시>#</a></h3><p>주문 처리 시스템을 예로 들어보자:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26>26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27>27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28>28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29>29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30>30</a>
</span><span class=lnt id=hl-21-31><a class=lnlinks href=#hl-21-31>31</a>
</span><span class=lnt id=hl-21-32><a class=lnlinks href=#hl-21-32>32</a>
</span><span class=lnt id=hl-21-33><a class=lnlinks href=#hl-21-33>33</a>
</span><span class=lnt id=hl-21-34><a class=lnlinks href=#hl-21-34>34</a>
</span><span class=lnt id=hl-21-35><a class=lnlinks href=#hl-21-35>35</a>
</span><span class=lnt id=hl-21-36><a class=lnlinks href=#hl-21-36>36</a>
</span><span class=lnt id=hl-21-37><a class=lnlinks href=#hl-21-37>37</a>
</span><span class=lnt id=hl-21-38><a class=lnlinks href=#hl-21-38>38</a>
</span><span class=lnt id=hl-21-39><a class=lnlinks href=#hl-21-39>39</a>
</span><span class=lnt id=hl-21-40><a class=lnlinks href=#hl-21-40>40</a>
</span><span class=lnt id=hl-21-41><a class=lnlinks href=#hl-21-41>41</a>
</span><span class=lnt id=hl-21-42><a class=lnlinks href=#hl-21-42>42</a>
</span><span class=lnt id=hl-21-43><a class=lnlinks href=#hl-21-43>43</a>
</span><span class=lnt id=hl-21-44><a class=lnlinks href=#hl-21-44>44</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Saga</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Saga의 각 단계를 정의</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 실패 시 보상 트랜잭션 실행</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>compensate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 주문 처리를 위한 Saga 구현</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderSaga</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Saga</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=n>orderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>PaymentService</span><span class=w> </span><span class=n>paymentService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>InventoryService</span><span class=w> </span><span class=n>inventoryService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SagaStep</span><span class=o>&gt;</span><span class=w> </span><span class=n>completedSteps</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1단계: 주문 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>createOrder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>completedSteps</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OrderCreationStep</span><span class=p>(</span><span class=n>order</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 2단계: 결제 처리</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Payment</span><span class=w> </span><span class=n>payment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>paymentService</span><span class=p>.</span><span class=na>processPayment</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>completedSteps</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PaymentProcessingStep</span><span class=p>(</span><span class=n>payment</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 3단계: 재고 감소</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>inventoryService</span><span class=p>.</span><span class=na>decreaseStock</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>completedSteps</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StockDecrementStep</span><span class=p>(</span><span class=n>order</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 오류 발생 시 보상 트랜잭션 실행</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compensate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>compensate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 실행된 단계들을 역순으로 보상 처리</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>completedSteps</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>completedSteps</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>compensate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>각 단계별 보상 트랙잭션 구현:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1> 1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2> 2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3> 3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4> 4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5> 5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6> 6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7> 7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8> 8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9> 9</a>
</span><span class=lnt id=hl-22-10><a class=lnlinks href=#hl-22-10>10</a>
</span><span class=lnt id=hl-22-11><a class=lnlinks href=#hl-22-11>11</a>
</span><span class=lnt id=hl-22-12><a class=lnlinks href=#hl-22-12>12</a>
</span><span class=lnt id=hl-22-13><a class=lnlinks href=#hl-22-13>13</a>
</span><span class=lnt id=hl-22-14><a class=lnlinks href=#hl-22-14>14</a>
</span><span class=lnt id=hl-22-15><a class=lnlinks href=#hl-22-15>15</a>
</span><span class=lnt id=hl-22-16><a class=lnlinks href=#hl-22-16>16</a>
</span><span class=lnt id=hl-22-17><a class=lnlinks href=#hl-22-17>17</a>
</span><span class=lnt id=hl-22-18><a class=lnlinks href=#hl-22-18>18</a>
</span><span class=lnt id=hl-22-19><a class=lnlinks href=#hl-22-19>19</a>
</span><span class=lnt id=hl-22-20><a class=lnlinks href=#hl-22-20>20</a>
</span><span class=lnt id=hl-22-21><a class=lnlinks href=#hl-22-21>21</a>
</span><span class=lnt id=hl-22-22><a class=lnlinks href=#hl-22-22>22</a>
</span><span class=lnt id=hl-22-23><a class=lnlinks href=#hl-22-23>23</a>
</span><span class=lnt id=hl-22-24><a class=lnlinks href=#hl-22-24>24</a>
</span><span class=lnt id=hl-22-25><a class=lnlinks href=#hl-22-25>25</a>
</span><span class=lnt id=hl-22-26><a class=lnlinks href=#hl-22-26>26</a>
</span><span class=lnt id=hl-22-27><a class=lnlinks href=#hl-22-27>27</a>
</span><span class=lnt id=hl-22-28><a class=lnlinks href=#hl-22-28>28</a>
</span><span class=lnt id=hl-22-29><a class=lnlinks href=#hl-22-29>29</a>
</span><span class=lnt id=hl-22-30><a class=lnlinks href=#hl-22-30>30</a>
</span><span class=lnt id=hl-22-31><a class=lnlinks href=#hl-22-31>31</a>
</span><span class=lnt id=hl-22-32><a class=lnlinks href=#hl-22-32>32</a>
</span><span class=lnt id=hl-22-33><a class=lnlinks href=#hl-22-33>33</a>
</span><span class=lnt id=hl-22-34><a class=lnlinks href=#hl-22-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>SagaStep</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>compensate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderCreationStep</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>SagaStep</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=n>orderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>createOrder</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>compensate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>cancelOrder</span><span class=p>(</span><span class=n>order</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PaymentStep</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>SagaStep</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Payment</span><span class=w> </span><span class=n>payment</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>PaymentService</span><span class=w> </span><span class=n>paymentService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>paymentService</span><span class=p>.</span><span class=na>processPayment</span><span class=p>(</span><span class=n>payment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>compensate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>paymentService</span><span class=p>.</span><span class=na>refundPayment</span><span class=p>(</span><span class=n>payment</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>각 단계는 독립적인 서비스에서 처리되며, 실패 시 이전 단계의 작업을 취소하는 보상 트랜잭션을 실행한다.</p><h3 id=주의사항>주의사항<a hidden class=anchor aria-hidden=true href=#주의사항>#</a></h3><ul><li>데이터 일관성: 최종적 일관성 (eventual consistency) 을 목표로 함</li><li>멱등성: 같은 요청이 여러 번 실행되어도 결과가 동일해야 함</li><li>타임아웃 처리: 장기 실행 트랜잭션의 경우 적절한 타임아웃 설정 필요</li></ul><p>Saga Pattern 은 복잡한 분산 트랜잭션을 관리하는 강력한 도구이지만, 구현 복잡도가 높아질 수 있으므로 신중한 설계와 테스트가 필요하다.</p><hr><h2 id=참고-및-출처-1>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처-1>#</a></h2></div><footer class=post-footer><ul class=post-tags><li><a href=https://buenhyden.github.io/tags/system-and-software-architecture/>System-and-Software-Architecture</a></li><li><a href=https://buenhyden.github.io/tags/msa-patterns/>MSA-Patterns</a></li><li><a href=https://buenhyden.github.io/tags/maintaining-data-consistency/>Maintaining-Data-Consistency</a></li><li><a href=https://buenhyden.github.io/tags/saga-patternevent/>Saga-PatternEvent</a></li></ul><nav class=paginav><a class=prev href=https://buenhyden.github.io/posts/systems-and-infrastructure/infrastructure/infrastructure-components/messaging-systems/message-endpoints/idempotent-consumer/><span class=title>« Prev</span><br><span>Idempotent Consumer</span>
</a><a class=next href=https://buenhyden.github.io/posts/software-engineering/design-and-architecture/design-methodology/domain-driven-design/aggregate/><span class=title>Next »</span><br><span>Aggregate Pattern</span></a></nav></footer><div class=comments><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const n={src:"https://giscus.app/client.js","data-repo":"buenhyden/buenhyden.github.io","data-repo-id":"R_kgDONsSnFQ","data-category":"General","data-category-id":"DIC_kwDONsSnFc4CmK-R","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"en","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(n).forEach(([t,n])=>e.setAttribute(t,n)),console.log(e),document.querySelector(".comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme)})</script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>