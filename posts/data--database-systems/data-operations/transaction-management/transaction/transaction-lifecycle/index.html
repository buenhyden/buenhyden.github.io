<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Transaction Lifecycle | hyunyoun's Blog</title><meta name=keywords content="System-Design,Database-Systems,Transactions,Transaction-Lifecycle,ACID"><meta name=description content="트랜잭션 생명주기는 시작→실행→동시성 제어(2PL/MVCC/OCC)→로그(WAL)·체크포인트→커밋/롤백→회복(Analysis→REDO→UNDO)으로 구성된다. ARIES/WAL 기반 로그와 2PC·Saga 등 분산 패턴으로 일관성·내구성을 확보한다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/transaction/transaction-lifecycle/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.8762af4fa9ee176c57f72565b721f234162fc7a9c882a271e0a1f68c4e89fb34.css integrity="sha256-h2KvT6nuF2xX9yVltyHyNBYvx6nIgqJx4KH2jE6J+zQ=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/transaction/transaction-lifecycle/index.xml><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/transaction/transaction-lifecycle/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/transaction/transaction-lifecycle/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Transaction Lifecycle"><meta property="og:description" content="트랜잭션 생명주기는 시작→실행→동시성 제어(2PL/MVCC/OCC)→로그(WAL)·체크포인트→커밋/롤백→회복(Analysis→REDO→UNDO)으로 구성된다. ARIES/WAL 기반 로그와 2PC·Saga 등 분산 패턴으로 일관성·내구성을 확보한다."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Transaction Lifecycle"><meta name=twitter:description content="트랜잭션 생명주기는 시작→실행→동시성 제어(2PL/MVCC/OCC)→로그(WAL)·체크포인트→커밋/롤백→회복(Analysis→REDO→UNDO)으로 구성된다. ARIES/WAL 기반 로그와 2PC·Saga 등 분산 패턴으로 일관성·내구성을 확보한다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HY's Blog","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":6,"name":"Transaction Lifecycle","item":"https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/transaction/transaction-lifecycle/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>HY's Blog</a></div><h1>Transaction Lifecycle</h1><div class=post-description>트랜잭션 생명주기는 시작→실행→동시성 제어(2PL/MVCC/OCC)→로그(WAL)·체크포인트→커밋/롤백→회복(Analysis→REDO→UNDO)으로 구성된다. ARIES/WAL 기반 로그와 2PC·Saga 등 분산 패턴으로 일관성·내구성을 확보한다.</div></header><div class=post-content><h2 id=transaction-lifecycle>Transaction Lifecycle<a hidden class=anchor aria-hidden=true href=#transaction-lifecycle>#</a></h2><p>트랜잭션은 여러 연산을 하나로 묶어 데이터 무결성을 보장하는 단위다.<br>생명주기는 BEGIN → 읽기/쓰기 → 검증·잠금·버전관리 → WAL(로그) 기록 → COMMIT/ROLLBACK → 락 해제·버전 가시화로 흐른다.<br>WAL 은 변경을 로그에 먼저 써서 내구성을 확보하고, 장애 복구는 ARIES 의 분석→재실행→역실행 순으로 동작한다.<br>동시성은 MVCC(읽기 비차단), 2PL(잠금 기반), OCC(낙관적 재시도) 로 관리하며 각 방식은 데드락·재시도·버전관리 비용에서 트레이드오프가 있다.<br>분산 환경에서는 2PC(원자성 보장·블로킹), 3PC(부분 개선), 합의 (강일관성), Saga·Outbox(비동기 보상·실무 친화) 중 비즈니스 요구에 맞게 선택한다. 설계할 때는 일관성·지연·가용성의 균형과 로그·체크포인트·격리 수준 튜닝을 우선 점검하라.</p><h3 id=트랜잭션-생명주기와-실무-설계-지도>트랜잭션 생명주기와 실무 설계 지도<a hidden class=anchor aria-hidden=true href=#트랜잭션-생명주기와-실무-설계-지도>#</a></h3><p>트랜잭션은 데이터베이스에서 " 한 작업처럼 " 수행되는 연산들의 묶음이다.<br>안정적인 시스템은 트랜잭션이 실패하면 시스템을 일관된 상태로 되돌려야 하고, 성공하면 영구적으로 반영해야 한다. 이를 위해 ACID 원칙을 적용하고, 동시성을 제어하기 위해 2PL 이나 MVCC 를 사용하고, 장애 복구를 위해 WAL 과 ARIES 같은 로그·복구 메커니즘을 둔다.<br>분산 환경에서는 2PC 같은 강한 방법 또는 Saga/Outbox 같은 비동기 보상 방법을 사용해 시스템 요구 (정합성 vs 가용성) 과 운영 현실 (네트워크 지연, 장애) 을 맞춘다.</p><table><thead><tr><th>핵심 개념 (한글 (약어))</th><th style=text-align:right>정의 (간단)</th><th>왜 중요한가 (실무 관점)</th></tr></thead><tbody><tr><td>트랜잭션 (Transaction)</td><td style=text-align:right>연관된 연산의 원자 단위</td><td>데이터 정합성, 비즈니스 불변식 보호</td></tr><tr><td>원자성 (Atomicity)</td><td style=text-align:right>전부 실행 또는 전부 취소</td><td>부분 반영으로 인한 데이터 손상 방지</td></tr><tr><td>일관성 (Consistency)</td><td style=text-align:right>제약·무결성 유지</td><td>비즈니스 규칙 준수</td></tr><tr><td>격리성 (Isolation)</td><td style=text-align:right>동시 트랜잭션 간 간섭 제어</td><td>레이스·더티리드 방지</td></tr><tr><td>지속성 (Durability)</td><td style=text-align:right>커밋 후 영구 보존</td><td>장애 복구 시 데이터 보장</td></tr><tr><td>2 단계 락 (2PL)</td><td style=text-align:right>락 기반 성장/축소 단계</td><td>충돌 직렬화 보장 (그러나 데드락 발생 가능)</td></tr><tr><td>다중버전 (MVCC)</td><td style=text-align:right>버전별 스냅샷 읽기</td><td>읽기 성능 향상, 스냅샷 일관성 제공</td></tr><tr><td>낙관적 제어 (OCC)</td><td style=text-align:right>실행 후 검증</td><td>충돌 낮은 환경에서 성능 우위</td></tr><tr><td>WAL (Write-Ahead Log)</td><td style=text-align:right>변경 전 로그 기록</td><td>내구성·복구 기반</td></tr><tr><td>ARIES</td><td style=text-align:right>analysis/redo/undo 복구 절차</td><td>일관된 빠른 장애 복구</td></tr><tr><td>2PC / Saga</td><td style=text-align:right>분산 커밋 / 보상 패턴</td><td>분산 일관성 확보 방법</td></tr><tr><td>Outbox</td><td style=text-align:right>DB 변경→메시지 원자적 처리</td><td>Dual-write 문제 완화, 일관성 보장</td></tr><tr><td>멱등성 (Idempotency)</td><td style=text-align:right>중복 안전성</td><td>재시도/중복 메시지에서 안정화</td></tr></tbody></table><ul><li>트랜잭션은 비즈니스 불변식을 기술적으로 보장하기 위한 단위다.</li><li>ACID 는 이를 달성하는 목표이며, 격리와 지속성은 각각 동시성·장애 대응 관점에서 구현 전략 (2PL/MVCC, WAL/ARIES) 을 요구한다.</li><li>분산 환경에서는 2PC 와 Saga 사이에서 일관성/가용성/지연의 트레이드오프를 판단해야 한다.</li></ul><h4 id=개념-상호관계와-목적-매핑표>개념 상호관계와 목적 매핑표<a hidden class=anchor aria-hidden=true href=#개념-상호관계와-목적-매핑표>#</a></h4><table><thead><tr><th>출발 개념 → 도착 개념</th><th style=text-align:right>관계 (방향성)</th><th>무엇을 위해/어떤 영향</th></tr></thead><tbody><tr><td>ACID → Isolation</td><td style=text-align:right>ACID 의 한 축 → 구현 필요</td><td>동시성 제어 필요성 (무결성 보호)</td></tr><tr><td>Isolation → Concurrency Control(2PL/MVCC/OCC)</td><td style=text-align:right>격리 수준을 구현 → 구현 선택</td><td>성능 vs 일관성 조정 (락/버전/검증)</td></tr><tr><td>Durability → WAL + Checkpoint</td><td style=text-align:right>지속성 달성 → 로그 기반</td><td>장애 시 데이터 복구 기반 제공</td></tr><tr><td>WAL → ARIES</td><td style=text-align:right>WAL 이 입력 → ARIES 가 복구 절차 수행</td><td>로그를 이용한 분석/재실행/역실행</td></tr><tr><td>분산 시스템 → 2PC / Saga / Outbox</td><td style=text-align:right>분산 환경에서 선택지 → 패턴 적용</td><td>강한 일관성 또는 회복 가능성 선택</td></tr><tr><td>Outbox → Idempotency</td><td style=text-align:right>메시지 원자화 → 소비자 중복방지 필요</td><td>exactly-once 유사 보장 구현 지원</td></tr></tbody></table><ul><li>방향성은 " 목표 → 구현 (메커니즘) → 운용 (운영 선택)" 순이다. 예컨대 &lsquo;Durability&rsquo; 를 목표로 삼으면 WAL 을 도입하고, WAL 을 전제로 ARIES 같은 복구 알고리즘을 설계한다. 분산 트랜잭션은 목표 (즉시성·일관성) 에 따라 2PC(동기·강한 일관성) 또는 Saga/Outbox(비동기·가용성 우선) 를 선택한다.</li></ul><p><strong>관계 맵 (개요)</strong></p><pre class=mermaid>flowchart LR
  A[ACID] --&gt; B[Isolation]
  B --&gt; C[Concurrency Control]
  C --&gt;|2PL| C1[Locks]
  C --&gt;|MVCC| C2[Versions]
  C --&gt;|OCC| C3[Validation]
  A --&gt; D[Durability]
  D --&gt; E[WAL &amp; Checkpoint]
  E --&gt; F[ARIES Recovery]
  A --&gt; G[Distributed]
  G --&gt; H[2PC/3PC]
  G --&gt; I[Saga/Outbox]
</pre><h4 id=핵심-개념의-실무-적용-매핑표>핵심 개념의 실무 적용 매핑표<a hidden class=anchor aria-hidden=true href=#핵심-개념의-실무-적용-매핑표>#</a></h4><table><thead><tr><th>핵심 개념</th><th style=text-align:right>실무에서 무엇을?</th><th>어떻게 적용?</th><th>왜 중요한가?</th></tr></thead><tbody><tr><td>트랜잭션</td><td style=text-align:right>결제/재고 변경 원자화</td><td>DB 트랜잭션/서비스 트랜잭션 설계</td><td>비즈니스 신뢰성 보장</td></tr><tr><td>ACID</td><td style=text-align:right>데이터 무결성 정의</td><td>DBMS 설정·애플리케이션 불변식 검사</td><td>시스템 신뢰성 기준</td></tr><tr><td>MVCC</td><td style=text-align:right>읽기 성능 최적화</td><td>DB 엔진 (예: Postgres) 설정, vacuum/cleanup</td><td>높은 읽기량에서 스캔 지연 축소.</td></tr><tr><td>2PL</td><td style=text-align:right>강한 직렬화 필요 시</td><td>Strict 2PL (X lock 해제 시점 조정)</td><td>데드락·지연 관리 (단일 DC 사용시 유리)</td></tr><tr><td>WAL + ARIES</td><td style=text-align:right>장애 복구 정책 수립</td><td>로그 보존/체크포인트 주기 튜닝</td><td>RTO/RPO 목표 달성 (복구 속도·데이터 손실 최소화)</td></tr><tr><td>2PC</td><td style=text-align:right>핵심 장부 동기화</td><td>코디네이터 + 참가자 구현</td><td>즉시 일관성 보장 (하지만 블로킹, 운영 비용)</td></tr><tr><td>Saga / Outbox</td><td style=text-align:right>마이크로서비스 분산 처리</td><td>보상 트랜잭션, Outbox 테이블 + 메시지 브로커</td><td>가용성 유지, 지연 허용 범위 내 처리</td></tr><tr><td>Idempotency</td><td style=text-align:right>재시도 안전성</td><td>소비자 키 기반 dedupe, 토큰 사용</td><td>네트워크 재시도·중복방지</td></tr></tbody></table><ul><li>트랜잭션의 중요도 (금융 핵심 vs 로그성 데이터), 네트워크 조건 (단일 DC vs 다중 DC), 지연 허용치, 운영 복잡도에 따라 위 패턴을 조합해 적용한다.</li><li>WAL·ARIES 는 모든 강한 일관성 DB 에서 기본이며, 분산 환경에선 Outbox + 소비자 멱등성으로 현실적인 일관성 확보가 일반적이다.</li></ul><h3 id=기초-조사-및-개념-정립>기초 조사 및 개념 정립<a hidden class=anchor aria-hidden=true href=#기초-조사-및-개념-정립>#</a></h3><h4 id=개념-정의-및-본질적-이해>개념 정의 및 본질적 이해<a hidden class=anchor aria-hidden=true href=#개념-정의-및-본질적-이해>#</a></h4><p>트랜잭션 생명주기 (Transaction Lifecycle) 는 하나의 트랜잭션이 시스템에서 생성되어 실행・완료・종결되는 전 과정을 유한 상태 머신으로 모델링한 것이다.</p><p>생명주기는 명확한 상태 집합과 각 상태 간의 결정론적 전이 규칙으로 구성되며, 설계 목표는 데이터 일관성·무결성·원자성 (ACID) 을 보장하는 데 있다.<br>주요 상태로는 Active(실행 중), Partially Committed(연산 완료, 커밋 준비), Committed(영구화 완료), Failed(오류 발생), Aborted(롤백 완료), Terminated(자원 정리) 등이 있다.<br>실제 구현은 동시성 제어 (락, 타임스탬프, MVCC), 장애 회복 (로그·체크포인트·ARIES), 분산 커밋 프로토콜 (2PC/3PC) 등과 긴밀히 연동되며, 운영 환경에서는 격리 수준 선택, 장기 트랜잭션의 관리, 분산 실패 모델에 따른 보상 로직 설계가 필수적이다.<br>이 모델은 전통적 관계형 DB 뿐 아니라 분산 DB, 블록체인, 금융 결제 시스템 등 다양한 도메인에서 일관성과 신뢰성을 확보하는 근간이 된다.</p><h5 id=트랜잭션과-acid>트랜잭션과 ACID<a hidden class=anchor aria-hidden=true href=#트랜잭션과-acid>#</a></h5><table><thead><tr><th>속성</th><th style=text-align:right>정의 (한 문장)</th><th>실무적 의미</th><th>구현 / 예시</th><th>주의사항·실무 팁</th></tr></thead><tbody><tr><td><strong>원자성 (Atomicity)</strong></td><td style=text-align:right>트랜잭션 내 모든 연산이 전부 성공하거나 전부 실패함</td><td>부분 적용된 상태가 남지 않도록 보장—실패 시 전체 롤백</td><td>로컬 DB 트랜잭션 (ROLLBACK), 분산 시 2PC·Saga(보상)</td><td>분산 경계는 원자성 보장 어렵다 → 보상 설계 필요, idempotency 고려</td></tr><tr><td><strong>일관성 (Consistency)</strong></td><td style=text-align:right>트랜잭션 전후에 데이터가 제약·비즈니스 규칙을 만족함</td><td>무결성 제약 (FK, 유니크), 트리거, 검증 로직으로 방어선 구축</td><td>DB 제약조건, 트리거, 앱 레벨 검증, 스키마 제약</td><td>제약 위반 방지 우선, 복잡한 비즈니스 규칙은 도메인 레벨에서 검증</td></tr><tr><td><strong>격리성 (Isolation)</strong></td><td style=text-align:right>동시에 실행되는 트랜잭션이 서로의 중간 결과를 보지 않게 함</td><td>동시성에 따른 이상현상 제어—성능과 균형 필요</td><td>격리수준: READ COMMITTED, REPEATABLE READ, SERIALIZABLE; 기술: 2PL, MVCC, OCC</td><td>높은 격리성은 충돌·재시도·지연 증가 → 워크로드에 맞춰 선택, 재시도 로직 필요</td></tr><tr><td><strong>지속성 (Durability)</strong></td><td style=text-align:right>커밋된 변경은 영구적으로 보존되어 장애 후에도 보존됨</td><td>커밋 시 데이터 손실 없음 보장—WAL·fsync·복제 필요</td><td>Write-Ahead Log, 체크포인트, 디스크 동기화, 복제 (동기/비동기)</td><td>WAL flush 정책·디스크 성능 튜닝 필요, 복제 지연과 내구성 수준 명확화</td></tr></tbody></table><p>간단한 SQL(예: Postgres) 사용 예:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 실패 시 ROLLBACK으로 두 업데이트 모두 취소되어야 함 (원자성)
</span></span></span></code></pre></td></tr></table></div></div><h4 id=트랜잭션-생명주기-역사와-설계의-진화>트랜잭션 생명주기: 역사와 설계의 진화<a hidden class=anchor aria-hidden=true href=#트랜잭션-생명주기-역사와-설계의-진화>#</a></h4><p>트랜잭션은 " 작업 단위 " 로, 여러 데이터 조작을 하나로 묶어 <strong>모두 성공하거나 모두 실패</strong>하도록 하는 메커니즘이다.</p><p>초기에는 관계형 DB 에서 데이터 일관성을 위해 필요했고 (1970s) ACID 라는 규칙으로 정리되었다 (1983).<br>시스템이 분산되면서 여러 DB·서비스에 걸친 트랜잭션을 안전하게 마무리하기 위한 2PC 같은 기법이 나왔지만, 분산 특성 때문에 성능이나 가용성 문제가 생겼다. 이를 해결하려고 장기 트랜잭션 (Saga) 이나, 상황에 따라 일관성보다 가용성을 선택하는 BASE/CAP 접근이 등장했다.<br>최근에는 블록체인이 합의 기반으로 트랜잭션의 순서와 불변성을 보장하며 스마트컨트랙트로 자동화 영역을 넓히고 있습니다.</p><h5 id=등장-배경>등장 배경<a hidden class=anchor aria-hidden=true href=#등장-배경>#</a></h5><p>1970 년대 관계형 데이터베이스가 다중 사용자 환경에서의 데이터 일관성 문제를 드러내자, 트랜잭션 모델이 등장했다. 이후 동시성·장애 복구·무결성 보장을 위해 ACID 속성이 정립되었고, 대규모·분산화에 따라 전역 커밋 (2PC) 과 장기 트랜잭션 (Saga) 패턴이 제안되었다.<br>웹·마이크로서비스의 확산은 확장성과 가용성 요구를 높여 BASE/CAP 와 같은 약한 일관성 설계로 이어졌고, 블록체인은 중앙기관 없이 합의로 트랜잭션을 확정하는 새로운 패러다임을 제공했다.</p><h5 id=발전-과정>발전 과정<a hidden class=anchor aria-hidden=true href=#발전-과정>#</a></h5><table><thead><tr><th style=text-align:right>시기</th><th>핵심 사건/개념</th><th>등장 이유</th><th>개선/의미</th></tr></thead><tbody><tr><td style=text-align:right>1970s</td><td>관계형 모델 (Codd)</td><td>다중 사용자 데이터 표현·질의 표준화 필요</td><td>구조화된 데이터 모델·SQL 도입.</td></tr><tr><td style=text-align:right>1983</td><td>ACID 정립 (Haerder & Reuter)</td><td>장애·동시성으로부터 무결성 확보 필요</td><td>트랜잭션 속성으로 일관성 보장.</td></tr><tr><td style=text-align:right>1980s</td><td>2PC 등 분산 커밋</td><td>다중 자원 간 원자적 작업 필요</td><td>전역 커밋/복구 프로토콜 제공 (블로킹 리스크 존재).</td></tr><tr><td style=text-align:right>1987</td><td>Sagas(장기 트랜잭션)</td><td>장기 실행·자원 점유 문제 해결 필요</td><td>보상 트랜잭션으로 점진적 정합성 제공.</td></tr><tr><td style=text-align:right>2000s</td><td>CAP 정리·NoSQL·BASE</td><td>대규모 분산 시스템의 가용성·확장성 요구</td><td>일관성 vs 가용성의 설계 선택, 약한 일관성 채택.</td></tr><tr><td style=text-align:right>2008~</td><td>블록체인 (비트코인), 스마트컨트랙트 (Ethereum)</td><td>중앙 신뢰기관 없이 불변·합의 보장 필요</td><td>분산합의로 불변의 트랜잭션 원장·온체인 자동화.</td></tr></tbody></table><pre class=mermaid>gantt
    dateFormat  YYYY
    title 트랜잭션 발전 타임라인
    1970s :rel1, 1970, 1975
    1983  :rel2, 1983, 1983
    1980s :rel3, 1980, 1989
    1987  :rel4, 1987, 1987
    2000s :rel5, 2000, 2010
    2008  :rel6, 2008, 2015

    section 핵심
    관계형 모델(Codd)         :rel1, 1970, 1970
    ACID 정립(Haerder&amp;Reuter) :rel2, 1983, 1983
    분산 커밋(2PC 등)         :rel3, 1985, 1988
    Sagas 제안                :rel4, 1987, 1987
    CAP/NoSQL/BASE 등장       :rel5, 2000, 2009
    블록체인·스마트컨트랙트    :rel6, 2008, 2015
</pre><p>트랜잭션 모델은 단순한 DB 연산 보호에서 출발해 분산과 확장성 요구에 따라 여러 갈래로 진화했다.<br>ACID 가 강한 일관성과 장애 복구를 주도했고, 2PC 는 다수 자원 간 동기화 문제를 해결했지만 성능·가용성 한계를 드러냈다.<br>Sagas 는 장기 흐름에서 롤백 대신 보상으로 현실적 솔루션을 제공했고, CAP/BASE 는 분산 시스템 설계 철학을 바꿔 일관성과 가용성의 균형을 설계적 선택으로 만들었다.<br>블록체인은 합의 기반으로 트랜잭션 확정 방식을 근본적으로 바꾸며 불변성과 분산 신뢰를 제공한다.</p><h4 id=트랜잭션-신뢰성일관성-설계>트랜잭션 신뢰성·일관성 설계<a hidden class=anchor aria-hidden=true href=#트랜잭션-신뢰성일관성-설계>#</a></h4><ol><li>문제 인지: 여러 사용자가 같은 데이터를 동시에 바꿀 때와 시스템 실패 시 어떤 잘못이 발생하는지 확인.</li><li>기초 원리: 트랜잭션은 하나의 &rsquo; 원자적 작업 단위 &lsquo;—ACID(원자성·일관성·격리성·지속성) 를 지켜야 함.</li><li>격리 해결책: 락 (2PL) 은 충돌 시 기다리게 하고, MVCC 는 읽기용 스냅샷을 주어 읽기 충돌을 줄임. 워크로드에 따라 선택.</li><li>내구성/복구: 변경은 먼저 로그 (WAL) 에 기록 → 커밋 시 로그를 디스크에 flush → 장애 시 ARIES 절차로 복구.</li><li>분산: 여러 서비스가 관련되면 2PC(동기·원자) 또는 Saga(비동기·보상) 패턴을 사용해 일관성/확장성 균형을 맞춤.</li></ol><h5 id=트랜잭션이-해결하는-문제>트랜잭션이 해결하는 문제<a hidden class=anchor aria-hidden=true href=#트랜잭션이-해결하는-문제>#</a></h5><table><thead><tr><th>문제</th><th style=text-align:right>원인 (요약)</th><th>해결 메커니즘 (주요 기법)</th><th>기대 효과</th></tr></thead><tbody><tr><td>동시성 이상 (잃어버린 갱신 등)</td><td style=text-align:right>동시 쓰기/읽기 충돌</td><td>2PL, MVCC, OCC, 적절한 격리 수준</td><td>데이터 일관성·갱신 누락 방지</td></tr><tr><td>장애 복구</td><td style=text-align:right>시스템/디스크 크래시, 로그 손상</td><td>WAL, 체크포인트, ARIES(Analysis→REDO→UNDO)</td><td>장애 후 복구·트랜잭션 완결성 보장</td></tr><tr><td>분산 트랜잭션 문제</td><td style=text-align:right>네트워크 분할·여러 서비스 간 동기화</td><td>2PC(동기적), Saga(보상·비동기), outbox</td><td>서비스 간 일관성 관리·확장성 확보</td></tr><tr><td>데이터 무결성 위반</td><td style=text-align:right>제약/참조 규칙 미적용</td><td>DB 제약, 트랜잭션 경계 내 검증, 불변식 설계</td><td>비즈니스 규칙·참조 무결성 유지</td></tr><tr><td>운영·규제·감사 요구</td><td style=text-align:right>투명성 부족·규제 준수 필요</td><td>로그·트레이스·감사레코드</td><td>규제 준수·추적·신뢰도 향상</td></tr></tbody></table><ul><li>핵심은 &rsquo; 동시성·장애·분산 &rsquo; 에서 발생하는 불일치를 각기 다른 원리 (락·버전·로그·보상) 로 해결하는 것.</li><li>실제 설계에서는 워크로드·성능·복구 목표에 따라 위 기법들을 조합해 적용한다.</li></ul><h5 id=트랜잭션의-핵심-목적>트랜잭션의 핵심 목적<a hidden class=anchor aria-hidden=true href=#트랜잭션의-핵심-목적>#</a></h5><table><thead><tr><th>목적</th><th style=text-align:right>설명</th><th>주요 메커니즘</th><th>운영 지표 (예)</th></tr></thead><tbody><tr><td>신뢰성 (Reliability)</td><td style=text-align:right>장애·오류 상황에서도 일관된 동작 보장</td><td>WAL, 백업, ARIES 복구</td><td>복구 성공률, 장애 후 RTO</td></tr><tr><td>격리성 (Isolation)</td><td style=text-align:right>동시 트랜잭션 간 간섭 방지</td><td>격리 수준, 2PL, MVCC</td><td>충돌률, abort 비율</td></tr><tr><td>원자성 (Atomicity)</td><td style=text-align:right>복합 연산의 전부 성공/전부 실패</td><td>트랜잭션 경계, 로그 기반 원자성</td><td>커밋률, 반취소 발생 빈도</td></tr><tr><td>지속성 (Durability)</td><td style=text-align:right>커밋 후 변경의 영구 보존</td><td>로그 플러시 정책 (WAL)</td><td>데이터 손실 사건 수</td></tr><tr><td>무결성·감사성</td><td style=text-align:right>비즈니스 규칙·규제 준수</td><td>제약조건, 감사로그, 트랜잭션 검사</td><td>감사 적합성, 규제 위반 사례 수</td></tr></tbody></table><ul><li>목적들은 상호보완적이며, 각각을 만족시키기 위해 다른 기술 (로그·락·버전·감사) 을 적용한다.</li><li>운영 지표를 설정하면 설계·튜닝 우선순위를 정하기 쉽다.</li></ul><h5 id=문제와-목적의-연관성>문제와 목적의 연관성<a hidden class=anchor aria-hidden=true href=#문제와-목적의-연관성>#</a></h5><table><thead><tr><th>문제 \ 목적</th><th style=text-align:center>신뢰성</th><th style=text-align:center>격리성</th><th style=text-align:center>원자성</th><th style=text-align:center>지속성</th><th style=text-align:center>무결성·감사</th></tr></thead><tbody><tr><td>동시성 이상</td><td style=text-align:center>낮음→중</td><td style=text-align:center>높음</td><td style=text-align:center>중</td><td style=text-align:center>낮</td><td style=text-align:center>중</td></tr><tr><td>장애 복구</td><td style=text-align:center>높음</td><td style=text-align:center>낮</td><td style=text-align:center>중</td><td style=text-align:center>매우 높</td><td style=text-align:center>중</td></tr><tr><td>분산 트랜잭션</td><td style=text-align:center>높음</td><td style=text-align:center>중</td><td style=text-align:center>높</td><td style=text-align:center>중</td><td style=text-align:center>중</td></tr><tr><td>데이터 무결성 위반</td><td style=text-align:center>중</td><td style=text-align:center>중</td><td style=text-align:center>높</td><td style=text-align:center>중</td><td style=text-align:center>매우 높</td></tr><tr><td>운영·규제 문제</td><td style=text-align:center>중</td><td style=text-align:center>낮</td><td style=text-align:center>낮</td><td style=text-align:center>중</td><td style=text-align:center>매우 높</td></tr></tbody></table><ul><li>각 문제는 특정 목적에 더 직접적 영향을 미친다 (예: 장애 복구는 지속성과 신뢰성에 큰 영향).</li><li>설계 우선순위는 해결하려는 문제의 영향도에 따라 목적 가중치를 조정해 결정한다.</li></ul><h4 id=트랜잭션-기반-시스템-필수요건>트랜잭션 기반 시스템 필수요건<a hidden class=anchor aria-hidden=true href=#트랜잭션-기반-시스템-필수요건>#</a></h4><p>트랜잭션을 안전하게 운영하려면 **기본 시스템 (로그·복구·동시성·버퍼)**과 **운영 전제 (저장·네트워크·시간·성능 예산)**가 맞춰져야 한다.<br>구체적으로는:</p><ol><li>모든 변경은 **Write-Ahead Log(WAL)**에 먼저 기록되어야 하고 (내구성 확보)</li><li>장애 복구는 <strong>ARIES</strong> 방식처럼 로그와 LSN 을 이용해 분석→재실행→역실행으로 수행해야 하며,</li><li>동시성 제어는 <strong>Lock Manager</strong> 또는 <strong>MVCC/OCC</strong>로 충돌을 관리하고,</li><li><strong>Buffer Manager</strong>가 메모리와 디스크 동기화를 최적화한다.</li></ol><p>분산 환경에서는 **네트워크 안정성, 타임아웃·재시도, 시계 동기화 (또는 논리시계)**를 추가로 설계해야 한다.<br>이 요소들이 없으면 장애복구·일관성·성능에서 치명적 문제를 맞을 수 있다.</p><h5 id=트랜잭션-시스템-필수-전제-목록>트랜잭션 시스템 필수 전제 목록<a hidden class=anchor aria-hidden=true href=#트랜잭션-시스템-필수-전제-목록>#</a></h5><table><thead><tr><th>항목</th><th style=text-align:right>기술적 설명</th><th>필요 이유 / 근거</th><th>운영상 고려사항</th></tr></thead><tbody><tr><td>영구 로그 (WAL)</td><td style=text-align:right>변경을 로그에 먼저 flush 후 DB 페이지 쓰기</td><td>장애 시 재실행으로 일관성 확보. 로그 우선 규칙 필수.</td><td>WAL 아카이빙, 생성량 관리, 디스크 I/O</td></tr><tr><td>복구 관리자 (ARIES)</td><td style=text-align:right>LSN·pageLSN·트랜잭션 테이블로 분석→redo→undo</td><td>빠른 재기동과 정확한 미완료 트랜잭션 처리.</td><td>체크포인트 빈도, CLR 관리, 로그 스캔 비용</td></tr><tr><td>잠금 관리자 / 동시성</td><td style=text-align:right>Lock Manager, MVCC/OCC 등 충돌 제어 구조</td><td>동시 업데이트 충돌·데드락/재시도 관리.</td><td>격리수준, 타임아웃, 데드락 탐지</td></tr><tr><td>버퍼 관리자</td><td style=text-align:right>메모리 - 디스크 페이지 캐시와 플러시 정책</td><td>디스크 I/O 최소화·로그와의 동기화 보장.</td><td>버퍼 크기, 대체 정책, dirty page 플러시 정책</td></tr><tr><td>저장소 (비휘발성)</td><td style=text-align:right>안정적 영속성 장치 (NVMe, SAN 등)</td><td>커밋 내구성 보장</td><td>성능·비용 균형, 복제/백업</td></tr><tr><td>네트워크·타임아웃</td><td style=text-align:right>분산 코디네이션 (2PC·합의) 위한 안정 네트워크</td><td>분산 트랜잭션에서 블로킹/타임아웃 리스크 완화.</td><td>타임아웃 조정, 재시도 정책, 모니터링</td></tr><tr><td>시계/타임스탬프</td><td style=text-align:right>물리 (NTP/PTP) 또는 논리 (Lamport) 선택</td><td>타임스탬프 기반 충돌 해결/정렬 (또는 인과관계 추적).</td><td>정밀도 요구 (NTP/PTP), 논리시계 설계</td></tr><tr><td>보안·컴플라이언스</td><td style=text-align:right>암호화·감사·식별·접근제어</td><td>규제·무결성·비밀성 준수</td><td>로그 무결성, 접근 로그 보존 기간</td></tr></tbody></table><p>트랜잭션 신뢰성은 **로그 (영속성)**와 **복구 정책 (ARIES 등)**이 근간이다. 이와 함께 **동시성 제어 (잠금/MVCC)**와 <strong>버퍼 관리</strong>가 성능과 일관성 사이 균형을 잡는다.<br>분산 환경에서는 <strong>네트워크 신뢰성·타임아웃·시계 방식</strong>을 명확히 설계해야 실제 운영에서 2PC·합의·사가 패턴을 안정적으로 적용할 수 있다.<br>운영자는 WAL 생성량·체크포인트·버퍼 사이즈·타임아웃을 모니터링하며 조정해야 한다.</p><h4 id=트랜잭션-핵심-특징과-차별화-설계>트랜잭션 핵심 특징과 차별화 설계<a hidden class=anchor aria-hidden=true href=#트랜잭션-핵심-특징과-차별화-설계>#</a></h4><p>트랜잭션 생명주기는 &rsquo; 상태 (state)&rsquo; 로 나눠 생각하면 이해하기 쉽다.<br>각 상태에서 해야 할 검증 (무결성 검사), 잠금·버전 관리 (동시성), 로그 기록 (내구성) 을 수행하고 마지막에 커밋 또는 롤백한다.<br>큰 시스템에서는 장애 복구 (로그→체크포인트→복구 절차) 를 설계하고, 여러 서비스가 얽힌 경우 메시지 기반 (Outbox) 과 멱등성으로 데이터 일관성을 지킨다.<br>성능을 위해 동시성 제어 방식 (락/버전/낙관적) 을 워크로드에 맞춰 선택·전환하는 전략이 실무에서 핵심이다.</p><h5 id=생명주기-기반-트랜잭션-핵심특징>생명주기 기반 트랜잭션 핵심특징<a hidden class=anchor aria-hidden=true href=#생명주기-기반-트랜잭션-핵심특징>#</a></h5><ol><li><p><strong>상태 기반 생명주기 모델 (State-based Lifecycle)</strong></p><ul><li>기술적 근거: FSM 모델은 전이·선행조건을 명확화해 테스트·검증을 용이하게 함.</li><li>차별점: 절차적 흐름보다 보상 (rollback/compensate)·중단 상황을 가시적으로 처리할 수 있음.</li></ul></li><li><p><strong>ACID 속성 통합 보장 (Lifecycle-integrated ACID)</strong></p><ul><li>기술적 근거: 단계별 (Validation → Lock/Version → Log → Commit) 구현으로 각 속성을 운영적으로 확보함.</li><li>차별점: 단일 체크포인트가 아닌 생명주기 단위 점검으로 문제지점 신속 식별 가능.</li></ul></li><li><p><strong>계층적 복구 전략 (Hierarchical Recovery)</strong></p><ul><li>기술적 근거: ARIES 기반 recovery (analysis/redo/undo), fuzzy checkpoint 등으로 빠른 재가동·부분적 재실행 가능.</li><li>차별점: 즉시복구 vs 지연복구를 운영 목표 (RTO/RPO) 에 맞춰 선택·조정 가능.</li></ul></li><li><p><strong>적응적 동시성 제어 (Adaptive Concurrency Control)</strong></p><ul><li>기술적 근거: 하이브리드·적응형 CC 알고리즘 연구로 컨텐션에 따른 전환 이점 입증.</li><li>차별점: 정적 방식보다 더 넓은 운영 조건에서 최적 성능 달성.</li></ul></li><li><p><strong>메시지 원자화 + 멱등성 확보 (Outbox/Inbox + Idempotency)</strong></p><ul><li>기술적 근거: Outbox/Inbox 패턴 + Idempotent Consumer 로 at-least-once 보장과 중복 처리 방지.</li><li>차별점: 2PC 대비 운영 단순성·가용성 우위 (단, 일관성 지연 존재).</li></ul></li></ol><h5 id=트랜잭션-핵심특징-비교표>트랜잭션 핵심특징 비교표<a hidden class=anchor aria-hidden=true href=#트랜잭션-핵심특징-비교표>#</a></h5><table><thead><tr><th>핵심 특징</th><th style=text-align:right>기술적 근거</th><th>실무적 차별점 (왜 다른가)</th></tr></thead><tbody><tr><td>상태 기반 생명주기</td><td style=text-align:right>FSM 모델, 상태 전이·테스트 자동화 근거.</td><td>절차적 흐름보다 상태 관점의 예측·디버깅·보상 처리 용이</td></tr><tr><td>ACID 통합 보장</td><td style=text-align:right>단계별 검증 (Validate→Lock→Log→Commit).</td><td>생명주기 단위로 불변식 체크·오류 지점 빠르게 식별</td></tr><tr><td>계층적 복구</td><td style=text-align:right>WAL + ARIES(analysis/redo/undo), fuzzy checkpoint.</td><td>RTO/RPO 목표에 맞춘 즉시/지연 복구 선택 가능</td></tr><tr><td>적응적 동시성 제어</td><td style=text-align:right>하이브리드 CC 연구 (전환 기반 최적화).</td><td>정적 프로토콜보다 넓은 워크로드에서 성능 우위</td></tr><tr><td>Outbox + 멱등성</td><td style=text-align:right>Outbox 패턴 및 Idempotent Consumer 사례·가이드.</td><td>2PC 보다 운영 단순, 가용성·확장성에서 실무 친화적</td></tr></tbody></table><ul><li>이 표는 " 무엇을 근거로 (기술적 근거)" 해당 특징을 주장하는지와 " 실무에서 왜 이게 다른지 (차별점)" 를 직관적으로 연결한다. 설계·리뷰 시 각 셀을 기준으로 체크리스트 (테스트 케이스, 로그 정책, 모니터링 임계값 등) 를 만들면 바로 운영 문서로 전환할 수 있다.</li></ul><h3 id=핵심-원리-및-이론적-기반>핵심 원리 및 이론적 기반<a hidden class=anchor aria-hidden=true href=#핵심-원리-및-이론적-기반>#</a></h3><h4 id=트랜잭션-핵심-원칙과-설계철학>트랜잭션 핵심 원칙과 설계철학<a hidden class=anchor aria-hidden=true href=#트랜잭션-핵심-원칙과-설계철학>#</a></h4><p>트랜잭션은 여러 데이터 변경 작업을 하나의 묶음으로 다루어, 모두 성공하거나 모두 취소되게 만드는 기능이다.</p><p>이를 안전하게 운영하려면 다음 원칙을 지켜야 한다.</p><ol><li><strong>모두 아니면 없음 (원자성)</strong>: 작업 전부가 완료되지 않으면 변화는 반영되지 않음 → 예: 계좌 이체의 출금과 입금은 함께 적용.</li><li><strong>다른 트랜잭션에 영향 주지 않기 (격리성)</strong>: 동시에 일어나도 마치 순서대로 처리된 것처럼 보여야 함 → 격리 수준으로 조절.</li><li><strong>필요한 것만·짧게 (최소 권한)</strong>: 최소 데이터만 접근하고 잠금은 최소 시간만 유지 → 성능과 보안 확보.</li><li><strong>로그 먼저 (WAL) → 회복 가능하게</strong>: 변경은 로그에 먼저 기록해 장애 시 복구 가능하도록 함.</li><li><strong>분산이면 더 주의 (점진적 커밋/보상 패턴)</strong>: 여러 시스템에 걸친 작업은 2PC 같은 프로토콜이나 Saga 같은 보상 패턴으로 설계.</li></ol><p>이 다섯 가지를 균형 있게 설계하면 데이터 일관성을 지키면서도 성능·운영성 요구를 만족시킬 수 있다.</p><h5 id=트랜잭션-핵심-원칙>트랜잭션 핵심 원칙<a hidden class=anchor aria-hidden=true href=#트랜잭션-핵심-원칙>#</a></h5><table><thead><tr><th>핵심 원칙</th><th style=text-align:right>간단 설명</th><th>목적</th><th>왜 필요한가</th></tr></thead><tbody><tr><td>원자성</td><td style=text-align:right>모든 연산을 전부 성공하거나 전부 취소</td><td>비즈니스 논리의 일관성 보장</td><td>부분 반영으로 인한 불일치 방지</td></tr><tr><td>격리성</td><td style=text-align:right>동시 트랜잭션 간 간섭 차단</td><td>동시성 환경에서 데이터 무결성 유지</td><td>Dirty/Non-repeatable/Phantom 방지</td></tr><tr><td>최소 권한</td><td style=text-align:right>필요한 자원·시간만 접근/잠금</td><td>성능 향상·권한 남용 방지</td><td>락 경합·보안 취약 감소</td></tr><tr><td>점진적 커밋</td><td style=text-align:right>Prepare 단계로 커밋 준비를 나눔</td><td>분산 커밋 지연 최소화</td><td>블로킹·커밋 실패 리스크 축소</td></tr><tr><td>WAL (로그 우선)</td><td style=text-align:right>변경을 먼저 로그에 기록</td><td>장애 시 복구·내구성 보장</td><td>영속성 확보, 재실행 근거 제공</td></tr><tr><td>회복 (Undo/Redo)</td><td style=text-align:right>로그로 복구 절차 수행</td><td>장애 복구·일관성 복원</td><td>데이터 손실·불일치 방지</td></tr></tbody></table><p>핵심 원칙은 트랜잭션을 <strong>안전하게 실행하고, 실패 시 일관성을 회복하며, 동시성 환경에서도 예측 가능한 동작을 보장</strong>하기 위한 설계 규범들이다. 원자성과 WAL/회복은 데이터 무결성과 내구성을 담당하고, 격리성과 최소 권한은 동시성·성능·보안을 균형 있게 맞춘다. 점진적 커밋은 특히 분산 환경에서의 커밋 지연·블로킹 문제를 완화하는 실무적 보완책이다.</p><h5 id=트랜잭션-설계-철학>트랜잭션 설계 철학<a hidden class=anchor aria-hidden=true href=#트랜잭션-설계-철학>#</a></h5><table><thead><tr><th>설계 철학</th><th style=text-align:right>간단 설명</th><th>목적</th><th>왜 필요한가</th></tr></thead><tbody><tr><td>안전성 중심</td><td style=text-align:right>일관성·ACID 우선</td><td>민감 도메인의 신뢰성 보장</td><td>심각한 비즈니스·법적 리스크 예방</td></tr><tr><td>성능 - 일관성 균형</td><td style=text-align:right>격리 수준과 동시성 제어로 타협</td><td>SLA 에 맞춘 최적화</td><td>지나친 일관성→성능 저하 방지</td></tr><tr><td>운영 친화성</td><td style=text-align:right>관찰·모니터링·복구 용이성</td><td>신속한 문제 탐지·복구</td><td>운영 중 다운타임·장애 영향 최소화</td></tr><tr><td>단순성 & 최소 권한</td><td style=text-align:right>트랜잭션 단순·짧게 유지</td><td>디버깅·보안·성능 유리</td><td>복잡성으로 인한 오류·락 문제 회피</td></tr><tr><td>분산 대비 (복원력)</td><td style=text-align:right>네트워크 분할·노드 실패 고려</td><td>시스템 전체의 가용성 유지</td><td>분산 환경 고유 실패 모델 대응</td></tr></tbody></table><p>설계 철학은 원칙을 현실 환경에 적용하는 방식이다.<br>무엇을 우선시할지 (안전성 vs 성능), 어떻게 운영 편의성을 확보할지 (모니터링·로그), 분산 환경의 특수성 (파티션·합의 등) 을 고려해 설계를 선택한다.<br>실무에서는 한 철학을 절대적 기준으로 삼기보다, 서비스 요구사항에 맞춰 균형 있게 적용하는 것이 중요하다.</p><h4 id=트랜잭션-동작-원리와-운영-메커니즘>트랜잭션 동작 원리와 운영 메커니즘<a hidden class=anchor aria-hidden=true href=#트랜잭션-동작-원리와-운영-메커니즘>#</a></h4><p>트랜잭션은 여러 데이터 조작을 하나의 <strong>단위 작업</strong>으로 묶어 " 전부 성공하거나 전부 실패 " 하게 만드는 규칙이다.</p><p>실제 흐름은 &rsquo; 시작 → 검증 (권한·유효성) → 데이터 읽기/쓰기 (동시성 제어 적용) → 로그에 기록 → 커밋 (영구 반영) 또는 롤백 (되돌림) → 로그 보관/감사 &rsquo; 로 진행된다.<br>동시성을 관리하려면 락 (2PL), 버전 (MVCC), 또는 낙관적 방법 (OCC) 을 사용하고, 장애 시 로그 (예: WAL) 와 복구 알고리즘 (예: ARIES) 이 시스템을 일관된 상태로 복원한다.</p><h5 id=트랜잭션-단계별-메커니즘-표준-정리>트랜잭션 단계별 메커니즘 표준 정리<a hidden class=anchor aria-hidden=true href=#트랜잭션-단계별-메커니즘-표준-정리>#</a></h5><table><thead><tr><th style=text-align:right>단계</th><th>핵심 동작</th><th>내부 메커니즘/예시</th><th>실패 시 처리</th></tr></thead><tbody><tr><td style=text-align:right>Initiation (시작)</td><td>트랜잭션 생성, TID 할당</td><td>클라이언트 요청 → <code>BEGIN</code></td><td>없음 (준비 상태)</td></tr><tr><td style=text-align:right>Authorization (승인)</td><td>권한·유효성·컴플라이언스 검사</td><td>인증, 권한 체크, 사기검출</td><td>거부 → Abort</td></tr><tr><td style=text-align:right>Execution (실행)</td><td>실제 Read/Write 연산 수행</td><td>2PL / MVCC / OCC 중 선택, 로그 레코드 생성</td><td>충돌→재시도/대기/Abort</td></tr><tr><td style=text-align:right>Processing (처리)</td><td>WAL 에 로그 append, 중간 처리 (정산 준비)</td><td>WAL 규칙 (로그 먼저), 체크포인트</td><td>로그 손상→복구시 문제</td></tr><tr><td style=text-align:right>Settlement (정산/커밋)</td><td>커밋 결정·플러시·가시화</td><td>Commit 레코드 디스크 플러시 → Unlock / 버전 공개</td><td>시스템 실패→복구 (REDO/UNDO)</td></tr><tr><td style=text-align:right>Reporting (보고/보관)</td><td>감사 로그·리포팅·보관</td><td>아카이브, 리컨실리이션, 모니터링</td><td>규정 위반 조사</td></tr></tbody></table><ul><li><strong>Initiation</strong>은 유저/시스템이 트랜잭션 단위를 시작하는 순간이다. 실무 결제 시스템에서는 추가로 디지털 서명·토큰 검증 등이 포함된다.</li><li><strong>Authorization</strong>은 단순 접근 권한을 넘어서 규정·사기 탐지 로직을 포함할 수 있어, 데이터베이스 수준 트랜잭션과는 별개로 비즈니스 레이어에서 강하게 작동한다.</li><li><strong>Execution</strong>에서 사용하는 동시성 전략 (2PL/MVCC/OCC) 은 성능·응답성·데드락 가능성 등의 트레이드오프가 있으므로 워크로드 특성에 따라 선택한다.</li><li><strong>Processing & Settlement</strong>에서는 WAL 규칙과 커밋 플러시 보장이 핵심이며, 실패 복구는 로그 기반 복구 (ARIES 등) 에 의존한다.</li></ul><h5 id=트랜잭션-실행-흐름-메커니즘-시퀀스>트랜잭션 실행 흐름 (메커니즘 시퀀스)<a hidden class=anchor aria-hidden=true href=#트랜잭션-실행-흐름-메커니즘-시퀀스>#</a></h5><pre class=mermaid>flowchart TD
  subgraph T[&#34;트랜잭션 흐름&#34;]
    A[&#34;1.INIT: Begin / 생성&#34;] --&gt; B[&#34;2.AUTH: 인증/권한/검증&#34;]
    B --&gt; C[&#34;3.EXEC: Read/Write 연산&#34;]
    C --&gt; D{동시성 제어 선택}
    D --&gt; D1[2PL: Lock 획득]
    D --&gt; D2[MVCC: 버전 생성/읽기]
    D --&gt; D3[OCC: 실행 후 검증]
    D1 --&gt; E[WAL Append / 로그 생성]
    D2 --&gt; E
    D3 --&gt; E
    E --&gt; F{커밋 조건?}
    F -- Yes --&gt; G[Commit 레코드 Flush → 가시화/Unlock]
    F -- No --&gt; H[&#34;Abort → UNDO / 보상(Saga)&#34;]
    G --&gt; I[Reporting &amp; Archive]
    H --&gt; I
  end
  style T stroke:#333,stroke-width:1px
</pre><ul><li>트랜잭션은 먼저 생성 (Init) 된 뒤 비즈니스·보안 규칙에 따른 승인 (Authorization) 을 거친다.</li><li>Execution 단계에서 동시성 제어 전략을 선택해 읽기/쓰기 연산을 수행하고, 모든 변경은 WAL(로그) 에 먼저 기록되어야 한다.</li><li>커밋 조건이 만족되면 커밋 레코드를 디스크에 플러시하고 (내구성 보장) 잠금을 해제하거나 버전을 공개한다. 커밋 실패나 오류가 날 경우 UNDO 혹은 보상 트랜잭션 (Saga) 을 통해 상태를 정리한다.</li><li>마지막으로 감사·정산·아카이브가 이루어진다. 분산 환경 또는 결제 시스템에서는 승인과 정산이 비동기/배치로 분리되는 점을 고려해야 한다.</li></ul><h4 id=트랜잭션-흐름내구성-설계-총괄>트랜잭션 흐름·내구성 설계 총괄<a hidden class=anchor aria-hidden=true href=#트랜잭션-흐름내구성-설계-총괄>#</a></h4><p>트랜잭션은 여러 연산을 하나의 단위처럼 묶어 &rsquo; 모두 실행되거나 모두 취소 &rsquo; 되도록 보장한다.<br>애플리케이션 요청은 트랜잭션 매니저로 들어가고, 락 매니저가 동시 접근을 제어하며 버퍼 매니저가 메모리에서 페이지를 관리한다.<br>모든 변경은 먼저 로그에 남기고 (Write-Ahead Log), 커밋 시 로그를 디스크에 강제로 기록하여 영구성을 확보한다.<br>장애가 나면 Recovery Manager 가 로그를 보고 미완료 작업을 되돌리거나 재실행하여 데이터 일관성을 복구한다.</p><h5 id=트랜잭션-흐름-단계표>트랜잭션 흐름 단계표<a hidden class=anchor aria-hidden=true href=#트랜잭션-흐름-단계표>#</a></h5><table><thead><tr><th>단계</th><th style=text-align:right>호출/행동</th><th>주요 구성요소</th><th>핵심 역할/주의점</th></tr></thead><tbody><tr><td>세션/트랜잭션 시작</td><td style=text-align:right>TM.begin() → TID 생성</td><td>Transaction Manager</td><td>트랜잭션 ID·상태 초기화, 타임아웃 설정</td></tr><tr><td>연산 실행</td><td style=text-align:right>TM.execute(op)</td><td>Lock Manager, Buffer Manager, Log Buffer</td><td>락 획득 → 버퍼에서 읽기/쓰기 → Log.append (WAL 규칙)</td></tr><tr><td>커밋 준비</td><td style=text-align:right>TM.prepare()</td><td>Transaction Manager</td><td>제약/무결성 검사, 분산일땐 Prepare 단계</td></tr><tr><td>커밋</td><td style=text-align:right>TM.commit()</td><td>Log.force_write(), Lock Manager</td><td>로그 디스크 강제 기록 → 락 해제 순서 준수 (Strict 2PL)</td></tr><tr><td>롤백</td><td style=text-align:right>TM.abort()</td><td>Recovery/Log Manager</td><td>Undo(CLR) 실행 → 락 해제 → 상태 ABORTED</td></tr><tr><td>체크포인트/청소</td><td style=text-align:right>Checkpoint, GC, VACUUM</td><td>Buffer/Recovery Manager</td><td>Dirty page flush, 로그 재사용 범위 축소</td></tr><tr><td>복구</td><td style=text-align:right>Recovery Manager</td><td>WAL, LSN, ARIES 단계</td><td>Analysis → REDO → UNDO (장애 복구 절차)</td></tr></tbody></table><ul><li>로그는 데이터보다 먼저 기록 (WAL). 커밋 시 로그 강제 기록이 내구성을 보장하고, 락은 보통 커밋 후 해제해야 격리성 보장. 체크포인트와 가비지 수거로 운영 비용을 관리한다.</li></ul><h5 id=트랜잭션-데이터-제어-흐름도>트랜잭션 데이터 제어 흐름도<a hidden class=anchor aria-hidden=true href=#트랜잭션-데이터-제어-흐름도>#</a></h5><pre class=mermaid>flowchart LR
  A[Application/API] --&gt; B[Transaction Manager]
  B --&gt; C[Lock Manager]
  C --&gt; D[Buffer Manager]
  D --&gt; E[Disk Storage]
  D --&gt;|dirty page, LSN| F[Log Buffer]
  F --&gt; G[&#34;Write-Ahead Log (WAL)&#34;]
  G --&gt; H[Recovery Manager]
  B --&gt; I[Commit Protocol]
  I --&gt; G
  I --&gt; C
  subgraph Ops [운영/관리]
    J[Checkpoint] --&gt; D
    K[Garbage Collection/VACUUM] --&gt; D
    L[Replication/Outbox] --&gt; G
  end
</pre><ul><li>Application 이 요청을 보내면 Transaction Manager 가 트랜잭션을 시작하고 Lock Manager 를 통해 자원 접근을 제어한다.</li><li>실제 읽기/쓰기는 Buffer Manager(메모리 페이지 캐시) 에서 이루어지며 변경은 Dirty Page 와 LSN 과 함께 Log Buffer 에 기록된다.</li><li>Log Buffer 는 순차적으로 WAL 에 기록되고, 커밋 시 WAL 을 강제로 디스크에 기록한 뒤 락을 해제한다.</li><li>Recovery Manager 는 WAL 을 사용해 장애 시 Analysis→REDO→UNDO 절차로 복구한다.</li><li>Checkpoint 와 GC 는 운영상 dirty page 를 디스크에 내보내고 로그 재사용 범위를 줄여 복구 시간을 단축한다.</li><li>분산 환경에서는 Commit Protocol(예: 2PC 또는 Saga) 과 Outbox 패턴이 WAL 및 복제와 협력한다.</li></ul><h5 id=트랜잭션-생명주기-다이어그램>트랜잭션 생명주기 다이어그램<a hidden class=anchor aria-hidden=true href=#트랜잭션-생명주기-다이어그램>#</a></h5><pre class=mermaid>stateDiagram-v2
  [*] --&gt; ACTIVE
  ACTIVE --&gt; PARTIALLY_COMMITTED: TM.prepare()/validation
  PARTIALLY_COMMITTED --&gt; COMMITTED: TM.commit() / Log.force_write
  PARTIALLY_COMMITTED --&gt; ABORTED: failure during prepare
  ACTIVE --&gt; ABORTED: TM.abort()/deadlock/validation fail
  COMMITTED --&gt; [*]
  ABORTED --&gt; [*]
  note left of ABORTED: UNDO executed (CLR logs)
  note right of COMMITTED: locks released, post-processing
  %% Recovery transitions
  [*] --&gt; RECOVERY: system crash
  RECOVERY --&gt; ANALYSIS
  ANALYSIS --&gt; REDO
  REDO --&gt; UNDO
  UNDO --&gt; [*]
</pre><ul><li>트랜잭션은 ACTIVE 에서 시작해 정상 흐름이면 PARTIALLY_COMMITTED(검증/prepare) 를 거쳐 COMMITTED 가 된다.</li><li>실패 시 ABORTED 로 이동하며, 이때 로그 기반 UNDO(Compensation Log Record) 가 실행된다.</li><li>시스템 크래시가 발생하면 Recovery 상태로 들어가 ARIES 순서 (Analysis→REDO→UNDO) 로 데이터 일관성을 복원한다.</li><li>분산 트랜잭션의 prepare 단계는 외부 코디네이터의 결정이 필요하며, 코디네이터 장애 시 블로킹 위험을 고려해야 한다.</li></ul><h4 id=완전한-트랜잭션-시스템-설계지도>완전한 트랜잭션 시스템 설계지도<a hidden class=anchor aria-hidden=true href=#완전한-트랜잭션-시스템-설계지도>#</a></h4><p>트랜잭션 시스템은 " 요청을 받아 안전하게 처리하고, 실패 시 복구하며, 기록을 남겨 추적 가능한 " 파이프라인이다.<br>실무적으로는 다음 네 가지 축을 설계해야 한다:</p><ol><li><strong>경계</strong>—어디까지가 단일 트랜잭션인가 (로컬/분산)</li><li><strong>내구성</strong>—변경은 먼저 로그에 기록되어야 한다 (WAL)</li><li><strong>동시성</strong>—여러 작업이 충돌하지 않도록 잠금이나 버전관리 (MVCC) 를 선택</li><li><strong>운영성</strong>—메트릭·로그·체크포인트·타임아웃을 정해 안정적으로 운영.</li></ol><p>각 축의 선택은 성능·가용성·일관성의 트레이드오프를 만든다.</p><h5 id=트랜잭션-구조와-운영-개요>트랜잭션 구조와 운영 개요<a hidden class=anchor aria-hidden=true href=#트랜잭션-구조와-운영-개요>#</a></h5><p>구조는 크게 3 계층으로 생각하면 쉽다:</p><ol><li><strong>프론트엔드 (입력·인증)</strong>—요청을 받아 검증하고 트랜잭션 ID 를 부여한다.</li><li><strong>코어 (트랜잭션 매니저·동시성 제어)</strong>—트랜잭션의 시작·완료를 결정하고 동시성 충돌을 조정한다.</li><li><strong>저장소 (로그·버퍼·스토리지·체크포인트·복구)</strong>—변경을 안전하게 기록하고, 장애 시 이 기록으로 복구한다.</li></ol><p>운영 (모니터링/복구/외부연계) 은 이 3 계층 전역에서 동작한다.</p><h6 id=트랜잭션-구조-핵심-요소-표>트랜잭션 구조 핵심 요소 표<a hidden class=anchor aria-hidden=true href=#트랜잭션-구조-핵심-요소-표>#</a></h6><table><thead><tr><th>구조요소</th><th>설명</th><th>역할</th><th>주요 기능</th><th>특징</th><th>상호관계</th></tr></thead><tbody><tr><td>입력 인터페이스</td><td>외부 요청 진입점</td><td>요청 수신·초기검증</td><td>idempotency 키 발급, 라우팅</td><td>외부 중복·재전송 대비</td><td>인증엔진→트랜잭션매니저 전달</td></tr><tr><td>인증·승인 엔진</td><td>신원·권한 검증</td><td>승인/거부 결정</td><td>서명검증, ACL 조회</td><td>낮은 지연·안전성 요구</td><td>입력→처리로직 접근 제어</td></tr><tr><td>트랜잭션 매니저</td><td>생명주기 제어</td><td>BEGIN/COMMIT/ROLLBACK 조정</td><td>상태테이블, 2PC 조정</td><td>전역 상태 테이블 필요</td><td>동시성제어·로그와 연동</td></tr><tr><td>동시성 제어기</td><td>충돌·격리 보장</td><td>락/버전관리</td><td>S/X 락, MVCC 타임스탬프</td><td>전략별 성능 차이 큼</td><td>트랜잭션매니저·락매니저와 동작</td></tr><tr><td>로그 서브시스템</td><td>변경 영구 기록</td><td>WAL 작성·플러시</td><td>LSN 관리, 아카이빙</td><td>I/O 병목 가능</td><td>복구매니저·체크포인트 의존</td></tr><tr><td>버퍼/스토리지</td><td>메모리 캐시·디스크 저장</td><td>페이지 관리·영속화</td><td>페이지 교체·flush</td><td>메모리 크기 영향 큼</td><td>체크포인트와 협업</td></tr><tr><td>체크포인트</td><td>일관성 스냅샷</td><td>로그 범위 축소</td><td>dirty page flush</td><td>빈도 조정 필요</td><td>로그·버퍼 관리와 상호작용</td></tr><tr><td>복구 관리자</td><td>장애시 상태 복원</td><td>ARIES(분석/redo/undo)</td><td>로그 스캔·CLR 처리</td><td>로그 무결성 전제</td><td>로그 서브시스템 의존</td></tr><tr><td>외부연계 (Outbox)</td><td>외부 메시지 원자화</td><td>이벤트 발행 보장</td><td>outbox 작성·배포</td><td>비동기 안정성 확보</td><td>처리로직↔메시지브로커 연결</td></tr><tr><td>모니터링·감사</td><td>운영 관찰·규제준수</td><td>경보·감사 기록</td><td>메트릭·로그·알람</td><td>실시간성·보관정책 필요</td><td>모든 모듈로부터 수집</td></tr></tbody></table><p>구조 수준에서 핵심은 <strong>요청진입 → 승인 → 트랜잭션 제어 → 로그/버퍼/체크포인트 → 복구</strong>의 연속성이다. 각 단계는 명확한 인터페이스와 로그/메트릭을 통해 연결되어야 장애 시 책임 구분과 복구가 쉬워진다.</p><h6 id=구조-운영비기능-요건-표>구조 운영·비기능 요건 표<a hidden class=anchor aria-hidden=true href=#구조-운영비기능-요건-표>#</a></h6><table><thead><tr><th>항목</th><th>설명</th><th style=text-align:right>중요 이유</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>SLA(RTO/RPO)</td><td>복구 시간·데이터 손실 허용치</td><td style=text-align:right>아키텍처 선택 기준</td><td>체크포인트·아카이빙 정책</td></tr><tr><td>성능 목표</td><td>처리량·응답시간 목표</td><td style=text-align:right>동시성 전략 선택 영향</td><td>버퍼사이즈·락그레인 조정</td></tr><tr><td>보안·컴플라이언스</td><td>로그 보존·접근 통제</td><td style=text-align:right>규제·감사 요구</td><td>암호화·감사로그 보존기간</td></tr><tr><td>가용성·복제</td><td>복제 유형 (동기/비동기)</td><td style=text-align:right>장애 복원·지연 영향</td><td>재해복구 계획·리전 분산</td></tr><tr><td>관찰성</td><td>분산 트레이스·메트릭</td><td style=text-align:right>문제 원인 추적</td><td>Trace ID·로그 포맷 표준화</td></tr><tr><td>유지보수 정책</td><td>로그 보존·아카이브</td><td style=text-align:right>장기 보관·비용 절감</td><td>자동화 아카이빙·압축</td></tr></tbody></table><p>비기능 요건 (SLA·보안·가용성) 이 구조 선택과 세부 튜닝을 결정한다. 특히 RTO/RPO 는 체크포인트·로그 보존 전략과 직접 연동된다.</p><h6 id=트랜잭션-아키텍처-계층도>트랜잭션 아키텍처 계층도<a hidden class=anchor aria-hidden=true href=#트랜잭션-아키텍처-계층도>#</a></h6><pre class=mermaid>flowchart TB
  subgraph Frontend[&#34;Frontend / API Layer&#34;]
    A[Input Interface]
    B[Auth &amp; Approval]
  end

  subgraph Core[&#34;Transaction Core&#34;]
    TM[Transaction Manager]
    CC[Concurrency Controller]
    LM[Lock Manager / MVCC Store]
  end

  subgraph Storage[&#34;Storage Engine&#34;]
    BM[Buffer Manager]
    SM[Storage Manager]
    LS[&#34;Log Subsystem (WAL)&#34;]
    CP[Checkpoint Manager]
    RM[Recovery Manager]
  end

  subgraph Integration[&#34;Integration &amp; Ops&#34;]
    OUT[Outbox / Message Broker]
    MON[Monitoring &amp; Audit]
    EXT[External Services]
  end

  A --&gt; B
  B --&gt; TM
  TM --&gt; CC
  CC --&gt; LM
  CC --&gt; BM
  LM --&gt; BM
  BM --&gt; SM
  TM --&gt; LS
  LS --&gt; CP
  CP --&gt; BM
  LS --&gt; RM
  RM --&gt; SM
  TM --&gt; OUT
  OUT --&gt; EXT
  ALL[&#34;ALL COMPONENTS&#34;] -.-&gt; MON
</pre><ul><li><strong>프론트엔드</strong>는 요청을 받아 인증을 확인하고 트랜잭션을 시작한다.</li><li><strong>트랜잭션 코어</strong>는 트랜잭션 상태를 관리하고 동시성 (락 또는 버전) 을 제어한다.</li><li><strong>스토리지 엔진</strong>은 로그 (WAL) 에 먼저 기록하고, 버퍼를 통해 디스크에 페이지를 쓰며 체크포인트·복구를 통해 장애에서 시스템을 복원한다.</li><li><strong>통합/운영</strong>은 외부 시스템과의 메시지 교환 (Outbox) 과 모니터링을 담당한다.</li><li>이 흐름에서 ** 로그 (WAL)** 가 핵심 역할 (내구성 보장) 을 하므로 로그 플러시는 트랜잭션 커밋 시 필수적인 단계다.</li></ul><h5 id=트랜잭션-구성요소-상세지도>트랜잭션 구성요소 상세지도<a hidden class=anchor aria-hidden=true href=#트랜잭션-구성요소-상세지도>#</a></h5><p>구성 요소는 트랜잭션의 " 누가 (Manager)", " 어떻게 (Concurrency/Log/Buffer)", " 무엇 (Recovery/Checkpoint)" 을 담당한다. 트랜잭션 매니저가 생명주기를 조정하고, 동시성 제어기는 충돌을 조정한다. 로그 서브시스템은 변경을 안전히 보관해 복구 관리자에게 복구 근거를 제공한다. 버퍼 매니저는 성능을 위해 메모리에서 페이지를 관리하고 체크포인트가 이를 디스크에 동기화한다. 외부와 통신하는 부분은 Outbox 패턴으로 원자성을 근접하게 확보한다.</p><h6 id=트랜잭션-구성-요소-상세표>트랜잭션 구성 요소 상세표<a hidden class=anchor aria-hidden=true href=#트랜잭션-구성-요소-상세표>#</a></h6><table><thead><tr><th>구성요소</th><th>설명 (짧게)</th><th>역할</th><th>주요 기능</th><th style=text-align:right>특징</th><th>상호관계</th><th>필수/선택</th><th>속하는 구조</th></tr></thead><tbody><tr><td>Transaction Manager</td><td>생명주기 중앙제어</td><td>begin/commit/rollback, 2PC 코디네이션</td><td>트랜잭션 상태테이블, 타임아웃</td><td style=text-align:right>전역조정 시 로그 필요</td><td>Log/CC/Recovery 연동</td><td>필수</td><td>Core</td></tr><tr><td>Concurrency Controller</td><td>격리성 보장</td><td>스케줄링·충돌제어</td><td>Lock/MVCC/OCC 전략</td><td style=text-align:right>전략별 성능 차이 큼</td><td>TM, LockManager 와 연동</td><td>필수</td><td>Core</td></tr><tr><td>Lock Manager</td><td>자원락 관리</td><td>락 테이블 유지</td><td>S/X 락, 대기큐, 데드락탐지</td><td style=text-align:right>데드락 위험 존재</td><td>CC 와 긴밀</td><td>필수</td><td>Storage/Core</td></tr><tr><td>Log Subsystem (WAL)</td><td>변경 영구기록</td><td>로그 write/flush/arch</td><td>LSN, 아카이빙, fsync</td><td style=text-align:right>I/O 집중 가능성</td><td>Recovery/CP 와 연동</td><td>필수</td><td>Storage</td></tr><tr><td>Buffer Manager</td><td>메모리 캐시</td><td>페이지 캐시·flush</td><td>LRU 등 교체, dirty 관리</td><td style=text-align:right>메모리 제약 영향</td><td>Storage/CP 연동</td><td>필수</td><td>Storage</td></tr><tr><td>Checkpoint Manager</td><td>스냅샷 관리</td><td>로그 스캔 범위 축소</td><td>flush trigger, checkpoint write</td><td style=text-align:right>빈도·타이밍 트레이드오프</td><td>Log/BM 연동</td><td>필수</td><td>Storage</td></tr><tr><td>Recovery Manager</td><td>복구 담당</td><td>ARIES 기반 복구</td><td>analysis/redo/undo, CLR 처리</td><td style=text-align:right>로그 무결성 전제</td><td>Log/TM 연동</td><td>필수</td><td>Storage</td></tr><tr><td>Outbox Module</td><td>메시지 원자화</td><td>로컬 트랜잭션 내 메시지 기록</td><td>pending→publish 프로세스</td><td style=text-align:right>비동기 보장</td><td>TM/External 연동</td><td>선택 (분산시 권장)</td><td>Integration</td></tr><tr><td>Monitoring/Audit</td><td>관찰·감사</td><td>메트릭·로그 수집·알람</td><td>TraceID, 경보</td><td style=text-align:right>운영 필수요소</td><td>전 컴포넌트와 연결</td><td>필수</td><td>Integration</td></tr><tr><td>Auth & Approval</td><td>인증·권한검사</td><td>요청 승인/거부</td><td>서명검증, ACL</td><td style=text-align:right>규제 민감</td><td>Frontend 연동</td><td>필수</td><td>Frontend</td></tr></tbody></table><p>트랜잭션 코어 (Manager·CC·Log·Buffer·Recovery) 는 반드시 필요하고, Outbox 는 분산·비동기 시 강력히 권장된다. 모든 컴포넌트는 명확한 인터페이스와 트랜잭션 ID 공유로 통합되어야 추적·복구가 쉬워진다.</p><h6 id=구성요소-운영비기능-속성표>구성요소 운영·비기능 속성표<a hidden class=anchor aria-hidden=true href=#구성요소-운영비기능-속성표>#</a></h6><table><thead><tr><th>구성요소</th><th>필수 비기능 속성</th><th style=text-align:right>운영 고려사항</th><th>확장성/복제 전략</th></tr></thead><tbody><tr><td>Transaction Manager</td><td>내구성 로그, 고가용</td><td style=text-align:right>코디네이터 장애대응</td><td>코디네이터 HA, 리더선출</td></tr><tr><td>Concurrency Controller</td><td>낮은 지연, 데드락감지</td><td style=text-align:right>격리수준 튜닝</td><td>샤딩 시 락 분리</td></tr><tr><td>Log Subsystem</td><td>높은 쓰기처리량</td><td style=text-align:right>로그 아카이브·압축</td><td>로그 복제 (동기/비동기)</td></tr><tr><td>Buffer Manager</td><td>메모리 효율</td><td style=text-align:right>버퍼풀 조정</td><td>분산 캐시 연동</td></tr><tr><td>Recovery Manager</td><td>빠른 복구시간</td><td style=text-align:right>체크포인트 빈도 조절</td><td>복구 병렬화 가능</td></tr><tr><td>Outbox Module</td><td>메시지 일관성</td><td style=text-align:right>배포 실패/재시도 정책</td><td>파티션별 Outbox 가능</td></tr><tr><td>Monitoring</td><td>low overhead</td><td style=text-align:right>샘플링·알림 정책</td><td>중앙수집·분산에이전트</td></tr></tbody></table><p>운영 측면에서 각 구성요소는 성능·가용성·비용의 트레이드오프를 갖는다. 예: 로그의 아카이브 빈도는 디스크·복구시간에 영향, Concurrency 전략은 지연과 충돌 빈도에 영향.</p><h6 id=트랜잭션-구성요소-상호관계도>트랜잭션 구성요소 상호관계도<a hidden class=anchor aria-hidden=true href=#트랜잭션-구성요소-상호관계도>#</a></h6><pre class=mermaid>graph TB
  subgraph Frontend
    A[API / Input]
    Auth[Auth &amp; Approval]
  end

  subgraph Core
    TM[Transaction Manager]
    CC[Concurrency Controller]
    LM[Lock Manager]
  end

  subgraph Storage
    LOG[&#34;Log Subsystem (WAL)&#34;]
    BUF[Buffer Manager]
    ST[Storage Manager]
    CP[Checkpoint Manager]
    REC[Recovery Manager]
  end

  subgraph Integration
    OUT[Outbox]
    BRK[Message Broker / External]
    MON[Monitoring / Audit]
  end

  A --&gt; Auth
  Auth --&gt; TM
  TM --&gt; CC
  CC --&gt; LM
  LM --&gt; BUF
  BUF --&gt; ST
  TM --&gt; LOG
  LOG --&gt; REC
  LOG --&gt; CP
  CP --&gt; BUF
  TM --&gt; OUT
  OUT --&gt; BRK
  ALL[&#34;ALL COMPONENTS&#34;] -.-&gt; MON
</pre><p>구성요소 다이어그램은 각 모듈의 책임 경계를 보여주고, 트랜잭션이 흐를 때 어떤 컴포넌트들이 관여하는지 (예: TM 가 LOG 에 기록 → CC 가 LM 에 락 요청 → BUF 를 통해 디스크 접근) 순서를 명확히 한다. 이 다이어그램을 바탕으로 API 계약 (함수/메시지 포맷) 을 정의하면 구현·테스트가 쉬워진다.</p><h3 id=특성-분석-및-평가>특성 분석 및 평가<a hidden class=anchor aria-hidden=true href=#특성-분석-및-평가>#</a></h3><h4 id=트랜잭션-장점과-실무-적용-전략>트랜잭션 장점과 실무 적용 전략<a hidden class=anchor aria-hidden=true href=#트랜잭션-장점과-실무-적용-전략>#</a></h4><p>트랜잭션은 여러 데이터 연산을 <strong>하나의 안전한 단위</strong>로 묶는 개념이다.<br>이 단위는 실패하면 전부 되돌리고, 성공하면 영구 반영된다. 이를 가능하게 하는 핵심 기술은 <strong>ACID</strong>(무결성 보장), <strong>MVCC</strong>(읽기 성능), <strong>WAL·체크포인트</strong>(장애 복구), 그리고 <strong>분산 트랜잭션 패턴</strong>(2PC/Saga/Outbox) 이다.<br>실제 시스템에서는 이 기술들을 조합해 <strong>정합성</strong>, <strong>성능</strong>, <strong>가용성</strong> 사이의 균형을 맞춘다.</p><h5 id=트랜잭션-장점실무-이점-표>트랜잭션 장점·실무 이점 표<a hidden class=anchor aria-hidden=true href=#트랜잭션-장점실무-이점-표>#</a></h5><table><thead><tr><th>장점 (요약)</th><th style=text-align:right>기술적 근거</th><th>실무적 효과</th><th>적용 예시</th></tr></thead><tbody><tr><td>데이터 무결성 보장</td><td style=text-align:right>ACID, WAL</td><td>부분 반영·중복 방지, 규제 대응</td><td>결제·송금·재고 감소</td></tr><tr><td>읽기 성능 향상</td><td style=text-align:right>MVCC(스냅샷)</td><td>비차단 읽기, 지연↓ 처리량↑</td><td>리포트·조회 많은 서비스</td></tr><tr><td>장애 복구성</td><td style=text-align:right>WAL + Checkpoint + UNDO/REDO</td><td>빠른 재가동 (RTO↓), 데이터 손실 최소화</td><td>24/7 미션 크리티컬 서비스</td></tr><tr><td>분산 일관성 선택지</td><td style=text-align:right>2PC/합의 vs Saga/Outbox</td><td>일관성·가용성·지연 트레이드오프 선택</td><td>마이크로서비스 결합 업무</td></tr><tr><td>운영·감사·추적성</td><td style=text-align:right>FSM 기반 상태·상세 로그</td><td>감사·이상탐지·디버깅 용이</td><td>규제·컴플라이언스 환경</td></tr><tr><td>운영 효율성</td><td style=text-align:right>워크플로우·자동화·모니터링</td><td>운영 비용↓, 복구·대응 속도↑</td><td>대형 플랫폼 운영팀</td></tr></tbody></table><ul><li>이 표는 각각의 장점이 <strong>어떤 기술로 실현되는지</strong>와 <strong>그 결과로 실무에서 어떤 가치를 주는지</strong>를 연결한다.</li><li>설계 시에는 각 장점이 요구하는 구체적인 운영 파라미터 (예: 체크포인트 주기, MVCC GC 주기, Saga 보상 설계) 를 함께 문서화해야 실제 효과를 얻을 수 있다.</li></ul><h4 id=트랜잭션-한계와-실무적-대응-전략>트랜잭션 한계와 실무적 대응 전략<a hidden class=anchor aria-hidden=true href=#트랜잭션-한계와-실무적-대응-전략>#</a></h4><p>트랜잭션은 데이터 무결성을 지키는 대신 비용 (오버헤드) 과 제약을 동반한다.</p><ul><li><p><strong>무엇이 문제인가?</strong></p><ul><li>로그·동기화와 잠금 때문에 성능 저하가 발생하고, 분산 환경에서는 글로벌 합의로 지연이 커진다.</li></ul></li><li><p><strong>왜 발생하나?</strong></p><ul><li>ACID 를 보장하려면 상태를 안전하게 기록하고 동시성 충돌을 막아야 하므로 추가 작업과 조정이 필요하다.</li></ul></li><li><p><strong>실무에서 어떤 문제가 생기나?</strong></p><ul><li>응답시간 상승, 처리량 감소, 데드락, 메모리 과다 사용, 분산 실패 시 블로킹.</li></ul></li><li><p><strong>어떻게 대응하나?</strong></p><ul><li>단기: 그룹커밋·인덱스 튜닝·락 순서 표준화·타임아웃.</li><li>중장기: 샤딩·Saga 패턴·MVCC·LSM 기반 스토리지 전환·운영 모니터링 강화.<br>핵심은 <strong>요구 (일관성·내구성) 와 현실 (성능·확장성) 사이의 균형</strong>을 서비스 요구에 맞게 설계하는 것.</li></ul></li></ul><h5 id=트랜잭션-단점>트랜잭션 단점<a hidden class=anchor aria-hidden=true href=#트랜잭션-단점>#</a></h5><table><thead><tr><th>단점</th><th>설명</th><th>원인</th><th>실무 문제</th><th>해결책</th><th>대안 기술</th></tr></thead><tbody><tr><td>성능 오버헤드</td><td>로깅/락/동기화로 인한 추가 연산·I/O</td><td>ACID 보장 (특히 Durability/Isolation)</td><td>응답 지연·처리량 감소</td><td>그룹커밋, 배치, 쿼리 튜닝</td><td>인메모리 DB, NoSQL</td></tr><tr><td>데드락</td><td>순환적 락 대기 발생</td><td>배타적 락·자원 획득 순서 불일치</td><td>요청 블록·타임아웃</td><td>락 순서 표준화, 탐지·롤백</td><td>MVCC, OCC</td></tr><tr><td>쓰기 증폭</td><td>로그 + 데이터 동시 기록으로 I/O 증가</td><td>WAL + 페이지 플러시</td><td>스토리지 비용·I/O 병목</td><td>그룹커밋, 로그 압축</td><td>LSM-tree DB</td></tr><tr><td>분산 커밋 지연</td><td>2PC 라운드트립·코디네이터 블로킹</td><td>분산 합의 필요</td><td>tail latency 증가</td><td>Prepare 최적화, 타임아웃</td><td>Saga, Eventual Consistency</td></tr><tr><td>긴 트랜잭션</td><td>장시간 락·스냅샷 유지</td><td>사용자 상호작용·대형 작업</td><td>동시성 저하·GC 부담</td><td>트랜잭션 분할, 비동기 처리</td><td>마이크로 트랜잭션, 상태 머신</td></tr><tr><td>메모리/로그 성장</td><td>트랜잭션 메타·로그 버퍼 증가</td><td>동시 트랜잭션 증가</td><td>OOM·성능 저하</td><td>풀 제한, 로그 순환</td><td>상태 외부화, 스트리밍 처리</td></tr></tbody></table><p>단점 표는 트랜잭션 설계에서 <strong>성능·동시성·스토리지·분산성</strong> 측면에서 불가피하게 마주치는 문제들을 모아놓았다. 각 문제는 원인 (ACID 보장·분산 합의 등) 에 뿌리를 두며, 해결은 대개 <strong>설계 조정 (트랜잭션 짧게, 샤딩 등)</strong> 과 **운영 기법 (그룹커밋, 타임아웃, 로그 관리)**의 조합으로 이뤄진다. 필요시 아키텍처 전환 (LSM, NoSQL, Saga 등) 이 현실적 대안이다.</p><h5 id=트랜잭션-제약사항>트랜잭션 제약사항<a hidden class=anchor aria-hidden=true href=#트랜잭션-제약사항>#</a></h5><table><thead><tr><th>제약사항</th><th>설명</th><th>원인</th><th>영향</th><th>해결 방안</th><th>대안 기술</th></tr></thead><tbody><tr><td>fsync 비용</td><td>디스크 동기화로 인한 지연</td><td>스토리지·OS 동기화 특성</td><td>p99 지연↑, 처리량↓</td><td>그룹커밋, BBU, 비동기 플러시</td><td>인메모리 영속화</td></tr><tr><td>확장성 한계</td><td>전역 일관성 유지 시 스케일아웃 제한</td><td>글로벌 순서·중앙 조정 필요</td><td>샤딩 복잡도↑, 비용↑</td><td>파티셔닝, 로컬 트랜잭션</td><td>Eventual Consistency, 분산 DB</td></tr><tr><td>네트워크 의존성</td><td>분산 합의의 네트워크 의존성</td><td>분산 동기화 프로토콜</td><td>파티셔닝 시 가용성 저하</td><td>중복화, 로컬 캐시, CB</td><td>최종 일관성 모델</td></tr><tr><td>규제·컴플라이언스</td><td>법적 요건으로 설계 제약</td><td>업종·국가별 규제</td><td>설계 제한·운영 비용 증가</td><td>암호화·감사 로그·자동화</td><td>프라이버시 보존 기술</td></tr></tbody></table><p>제약사항 표는 <strong>시스템 물리·환경적 한계</strong>(디스크 특성, 네트워크, 규제 등) 때문에 피하기 힘든 제한들을 보여준다. 이런 제약은 기술 선택뿐 아니라 운영·비용·법률적 대응까지 요구하므로 아키텍처 설계 단계에서부터 고려해야 한다.</p><h4 id=트랜잭션-트레이드오프와-하이브리드-전략>트랜잭션 트레이드오프와 하이브리드 전략<a hidden class=anchor aria-hidden=true href=#트랜잭션-트레이드오프와-하이브리드-전략>#</a></h4><p>트레이드오프란 <strong>한쪽을 더 강하게 만들면 다른 쪽을 약하게 만들 수밖에 없는 선택</strong>이다.<br><em>무엇을 당연히 보장할지</em>와 <em>어떤 지연·운영 비용을 허용할지</em>에 대한 설계 선택이다.</p><p>트랜잭션 설계에서는 주로 <strong>일관성 vs 성능</strong>, <strong>원자성 (글로벌 커밋) vs 가용성</strong>, <strong>즉시 일관성 vs 최종 일관성</strong>의 균형을 고민한다.<br>정답은 하나가 아니라 **도메인 요구에 따른 혼합 전략 (핵심 데이터는 강일관성, 나머지는 약일관성)**이며, Saga·2PC·MVCC 같은 도구를 적재적소에 조합해 쓴다.</p><ul><li><strong>실전 접근법</strong>:<ol><li>민감한 데이터 (금전·계정) 는 강일관성·동기적 커밋 (필요시 분산 합의) 로 처리.</li><li>사용자 경험·지연 허용 구간은 약일관성·비동기 처리로 처리 (높은 가용성 확보).</li><li>서비스 경계는 Saga/보상 패턴으로 분리, 단 단위 테스트·모니터링·보상 검증 필수.</li><li>성능 병목은 동시성 제어 전략 (2PL/MVCC/OCC)·샤딩·캐싱으로 미세 조정.</li></ol></li></ul><h5 id=트랜잭션-선택지별-장단점-비교표>트랜잭션 선택지별 장단점 비교표<a hidden class=anchor aria-hidden=true href=#트랜잭션-선택지별-장단점-비교표>#</a></h5><table><thead><tr><th style=text-align:right>비교</th><th>장점 (선택 시)</th><th>단점 (선택 시)</th><th>고려 기준 / 관련 트레이드오프</th></tr></thead><tbody><tr><td style=text-align:right><strong>Serializable(강격리)</strong> vs <strong>약격리 (SI/RC)</strong></td><td>완전한 동시성 이상 방지, 예측 가능한 동작</td><td>경합·재시도·지연 증가, 확장성 부담</td><td>데이터 정확성 요구도·트랜잭션 길이·동시성 수준.</td></tr><tr><td style=text-align:right><strong>2PC(분산 원자성)</strong> vs <strong>비분산/비동기 설계 (Saga)</strong></td><td>분산 환경에서 원자적 일관성 보장</td><td>블로킹·코디네이터 실패 시 가용성 저하·지연</td><td>장애 모델·연결 지연·서비스 수·정합성 중요도.</td></tr><tr><td style=text-align:right><strong>MVCC</strong> vs <strong>2PL(락)</strong></td><td>읽기 성능 우수·낙관적 읽기 처리</td><td>가비지 버전 관리·쓰기 충돌 처리 필요</td><td>읽기 중심 vs 쓰기 중심 워크로드, 가비지 컬렉션 비용.</td></tr><tr><td style=text-align:right><strong>Strong Consistency(CP)</strong> vs <strong>High Availability(AP)</strong></td><td>데이터 정확성 우선 (장애 시에도 일관성 유지)</td><td>일부 기간 가용성 저하</td><td>장애 허용 수준·지리적 분산·SLA.</td></tr></tbody></table><ul><li><strong>결정은 도메인에 따라</strong>: 금융·회계 같은 분야는 강일관성 쪽으로 무게, 소셜 피드·통계는 가용성·지연 최소화 쪽으로 무게를 둔다.</li><li><strong>운영 비용을 고려</strong>: 강일관성·2PC 는 운영·모니터링·복구 부담 (특히 네트워크 문제) 이 크므로 조직의 운영 역량과 맞춰야 한다.</li><li><strong>혼합 전략 권장</strong>: 거의 모든 실무 시스템은 전역적으로 하나의 선택만 쓰지 않고, 중요도에 따라 혼합 (하이브리드) 을 적용한다.</li></ul><h5 id=하이브리드-트랜잭션-패턴-비교표>하이브리드 트랜잭션 패턴 비교표<a hidden class=anchor aria-hidden=true href=#하이브리드-트랜잭션-패턴-비교표>#</a></h5><table><thead><tr><th style=text-align:right>방법</th><th>구성 요소</th><th style=text-align:right>적용 목적</th><th>장점</th><th>고려사항</th></tr></thead><tbody><tr><td style=text-align:right><strong>선택적 강일관성</strong></td><td>핵심 DB 영역 (강격리) + 주변영역 (약격리)</td><td style=text-align:right>중요 데이터 보호 + 전체 성능 유지</td><td>비용/지연을 핵심에만 집중</td><td>데이터 분류·경계 정의 필요.</td></tr><tr><td style=text-align:right><strong>로컬 ACID + 글로벌 Saga</strong></td><td>서비스 내부 ACID 트랜잭션 + 서비스 간 Saga</td><td style=text-align:right>마이크로서비스에서 분산 트랜잭션 회피</td><td>가용성·독립 배포성 확보</td><td>보상 설계·모니터링 복잡도.</td></tr><tr><td style=text-align:right><strong>MVCC + 선택적 락</strong></td><td>기본 MVCC + 쓰기핫스팟엔 2PL 적용</td><td style=text-align:right>읽기 성능 유지 + 충돌 완화</td><td>대부분 워크로드에서 높은 처리량</td><td>핫스팟 탐지·정책 관리 필요.</td></tr><tr><td style=text-align:right><strong>Sync 승인 + Async 정산</strong></td><td>즉시 승인 (동기) + 배치 정산 (비동기)</td><td style=text-align:right>실시간 UX 보장 + 비용 최적화</td><td>사용자 응답성 보장, 비용 절감</td><td>정산 실패·재처리 전략 필수.</td></tr></tbody></table><ul><li>하이브리드는 <strong>실무적 현실성</strong>에서 나온 산물: 완전한 일관성이나 완전한 가용성 하나만 고집하면 대부분의 현실 요구를 충족시키기 어렵다.</li><li>핵심은 <strong>영역 나누기 (데이터·서비스·워크로드)</strong> 와 <strong>명확한 운영 규칙 (모니터링·재처리·보상)</strong> 이며, 이를 통해 트레이드오프를 실용적으로 관리할 수 있다. ([Medium][7])</li></ul><h4 id=트랜잭션-적용-적합성-전략>트랜잭션 적용 적합성 전략<a hidden class=anchor aria-hidden=true href=#트랜잭션-적용-적합성-전략>#</a></h4><p>트랜잭션 설계는 &rsquo; 무엇을 우선시하는가 &rsquo; 를 정하는 일이다. 만약 정확성과 법적 추적성이 최우선이면 강한 일관성 (ACID, 2PC) 이 필요하다. 반면 처리량과 낮은 지연이 우선이라면 최종적 일관성 (이벤트/로그 기반, Saga, 캐시) 을 택한다. 다중 서비스 환경이라면 메시지 내구성 (outbox) 과 보상 트랜잭션 (idempotency) 을 설계해 실패 시 상태 정합성을 확보해야 한다. 핵심은 비즈니스 요구를 기술 (설계·운영) 제약과 맞춰 매핑하는 것이다.</p><h5 id=트랜잭션-적용-적합성-분석>트랜잭션 적용 적합성 분석<a hidden class=anchor aria-hidden=true href=#트랜잭션-적용-적합성-분석>#</a></h5><ol><li><p>설계 관점</p><ul><li>설명: 요구 일관성 수준을 명확히 규정하고, 서비스 경계 (단일 DB vs 분산 서비스) 에 따라 트랜잭션 모델을 선택한다.</li><li>권장:<ul><li>단일 영속성 경계이면 ACID 트랜잭션 (Strict 2PL/MVCC+ 높은 격리) 우선.</li><li>서비스 경계가 넘어가면 Saga+Outbox/Idempotency 우선, 2PC 는 특수 케이스로 제한.</li></ul></li><li>기대 효과: 설계 시 일관성·지연·운영 복잡도 균형을 예측 가능하게 함.</li></ul></li><li><p>분석 (요구·성능·리스크 평가) 관점</p><ul><li>설명: 워크로드 (읽기/쓰기 비율, TPS, p99 latency), 장애 시 복구 목표 (RTO/RPO), 규제 요구를 기준으로 적합성 판단.</li><li>권장:<ul><li>요구 기반 매핑표 (예: 금융결제 → 강일관성/저지연 허용범위 좁음 → 2PC/Serializable 고려).</li></ul></li><li>기대 효과: 기술 선택에 대한 비용·리스크 정량화로 의사결정 투명화.</li></ul></li><li><p>운영 관점</p><ul><li>설명: 선택한 모델의 운영 비용 (모니터링, 복구 연습, 롤백·보상 절차, 운영 자동화) 을 고려.</li><li>권장:<ul><li>2PC 사용 시 coordinator 장애 시 조치, Saga 사용 시 보상 실패 시 재시도·수동 조치 플랜 마련.</li><li>주요 메트릭 (커밋 지연, abort 률, 재시도율, 복구시간) 모니터링.</li></ul></li><li>기대 효과: 운영상 사건 대응 속도 향상·서비스 신뢰성 유지.</li></ul></li></ol><h5 id=트랜잭션-사용-적합성표>트랜잭션 사용 적합성표<a hidden class=anchor aria-hidden=true href=#트랜잭션-사용-적합성표>#</a></h5><table><thead><tr><th>적용대상</th><th style=text-align:right>적합성</th><th>이유 (핵심)</th><th>권장 패턴</th></tr></thead><tbody><tr><td>금융 거래 시스템</td><td style=text-align:right>매우 적합</td><td>강한 일관성·감사 요구</td><td>ACID, 2PC(특수), Strict 2PL</td></tr><tr><td>전자상거래 주문/재고</td><td style=text-align:right>적합</td><td>일관성 필요, 분산 고려</td><td>Outbox + Saga / 부분적 2PC</td></tr><tr><td>ERP(회계·재고)</td><td style=text-align:right>적합</td><td>정합성·규제 요구</td><td>ACID 단일 DB or 조정된 분산 패턴</td></tr><tr><td>의료정보 시스템</td><td style=text-align:right>적합</td><td>정확성·추적성 필수</td><td>ACID, 감사로그 강화</td></tr><tr><td>분석/리포팅</td><td style=text-align:right>비적합</td><td>읽기 집중·성능 우선</td><td>OLAP, 이벤트 소스, eventual</td></tr><tr><td>로그/이벤트 스토어</td><td style=text-align:right>비적합</td><td>순서/처리량 우선</td><td>Append-only, 스트리밍</td></tr><tr><td>캐시 시스템</td><td style=text-align:right>비적합</td><td>일시적 불일치 허용</td><td>Cache with TTL, eventual</td></tr><tr><td>실시간 스트리밍</td><td style=text-align:right>비적합</td><td>지연·처리량 우선</td><td>Stream processing, exactly-once 노력</td></tr></tbody></table><ul><li>강한 일관성은 규제·금융·의료 같이 정합성·감사가 필수인 곳에 적합하다.</li><li>분산 서비스 환경에서는 Saga+Outbox 를 기본으로 삼고, 원자적 원격 커밋이 절대적 요구일 때만 2PC 를 제한적으로 사용한다.</li><li>분석·로그·캐시 등은 성능·처리량을 우선해 최종적 일관성 모델을 선택한다.</li></ul><h3 id=구현-방법-및-분류>구현 방법 및 분류<a hidden class=anchor aria-hidden=true href=#구현-방법-및-분류>#</a></h3><h4 id=트랜잭션-구현-기법운영-총람>트랜잭션 구현 기법·운영 총람<a hidden class=anchor aria-hidden=true href=#트랜잭션-구현-기법운영-총람>#</a></h4><p>트랜잭션 구현은 <strong>데이터 변경을 안전하게 기록하고 (로그 기반)</strong>, <strong>동시 접근을 제어하며 (잠금/MVCC/타임스탬프/OCC)</strong>, <strong>장애 시 정확히 복구 (ARIES)</strong> 하도록 설계하는 작업이다.<br>단일 노드에서는 WAL+ 트랜잭션 매니저 + 동시성 전략을 조합해 ACID 를 만족시키고, 분산 환경에서는 2PC/합의로 강일관성을 추구하거나 Saga/Outbox 로 결국적 일관성을 선택한다.<br>각 기법은 성능·가용성·운영복잡도 사이의 트레이드오프를 만들므로 워크로드와 SLA(RTO/RPO) 를 기준으로 선택하고, 로그·체크포인트·타임아웃·보상 로직 등을 반드시 설계해야 한다.</p><h5 id=트랜잭션-구현-기법-카테고리>트랜잭션 구현 기법 카테고리<a hidden class=anchor aria-hidden=true href=#트랜잭션-구현-기법-카테고리>#</a></h5><h6 id=내구성복구-중심-기법>내구성·복구 중심 기법<a hidden class=anchor aria-hidden=true href=#내구성복구-중심-기법>#</a></h6><p>로그 우선 (WAL) 과 ARIES 기반 복구는 트랜잭션 구현의 근간이다. 모든 변경을 로그에 먼저 기록 (LSN 배정) 하고 체크포인트로 로그 스캔 범위를 줄이며, 재시작 시 Analysis→Redo→Undo 순으로 일관성을 복원한다. 이 카테고리는 커밋 내구성 (RPO ≈ 0) 과 빠른 일관성 복구를 목표로 한다. 로그 아카이빙, CLR 사용, 체크포인트 빈도 조절이 핵심 운용 포인트다.</p><table><thead><tr><th>항목</th><th style=text-align:right>핵심 아이디어</th><th>장점</th><th>단점 / 운영 고려</th></tr></thead><tbody><tr><td>WAL</td><td style=text-align:right>변경을 로그에 먼저 기록</td><td>강한 내구성 보장</td><td>로그 I/O 병목, 아카이브 필요</td></tr><tr><td>ARIES</td><td style=text-align:right>Analysis→Redo→Undo 복구 절차</td><td>정확한 미완료 트랜잭션 복구</td><td>로그 무결성 필요, 복구 스캔 비용</td></tr><tr><td>체크포인트</td><td style=text-align:right>로그 범위 축소</td><td>복구 시간 단축</td><td>체크포인트 시점 부하 증가</td></tr></tbody></table><ul><li>요약: 내구성 카테고리는 커밋 보장과 복구 시간 단축을 목표로 하며, 로그 I/O 와 체크포인트 빈도의 트레이드오프를 관리해야 한다.</li></ul><h6 id=동시성격리-중심-기법>동시성·격리 중심 기법<a hidden class=anchor aria-hidden=true href=#동시성격리-중심-기법>#</a></h6><p>동시성 카테고리는 여러 트랜잭션이 동일 자원에 접근할 때 일관성을 유지하는 기법들을 포함한다. 2PL(잠금 기반) 은 직렬성을 직접 보장하지만 데드락·블로킹이 발생하며, MVCC 는 읽기 비차단으로 읽기 성능 우수하나 버전 관리 비용이 있다. 타임스탬프 기반 기법은 데드락을 제거하지만 정확한 시계 (또는 논리시계) 가 필요하다. OCC 는 충돌이 적은 환경에서 뛰어난 처리량을 보이나 재시도 비용을 감수해야 한다.</p><table><thead><tr><th>기법</th><th style=text-align:right>주요 아이디어</th><th style=text-align:right>적합 워크로드</th><th>운영 고려</th></tr></thead><tbody><tr><td>2PL(잠금)</td><td style=text-align:right>S/X 락으로 접근 제어</td><td style=text-align:right>쓰기 경쟁 심한 OLTP</td><td>데드락 탐지, 타임아웃</td></tr><tr><td>MVCC</td><td style=text-align:right>버전으로 읽기 분리</td><td style=text-align:right>읽기 중심·혼합 워크로드</td><td>GC(버전 정리), 스냅샷 비용</td></tr><tr><td>Timestamp</td><td style=text-align:right>타임스탬프 순서 보장</td><td style=text-align:right>글로벌 시계 가능한 분산 DB</td><td>시계 정합성 필요</td></tr><tr><td>OCC</td><td style=text-align:right>검증 시 충돌 검사</td><td style=text-align:right>충돌 낮은 환경</td><td>재시도 로직 필요</td></tr></tbody></table><ul><li>요약: 동시성 전략은 워크로드 특성 (읽기/쓰기 비율, 충돌 빈도) 에 맞춰 선택하고, 데드락/버전 수집/재시도 같은 운영 비용을 계획해야 한다.</li></ul><h6 id=분산원자성일관성-기법>분산·원자성/일관성 기법<a hidden class=anchor aria-hidden=true href=#분산원자성일관성-기법>#</a></h6><p>분산 환경에서는 노드 장애·네트워크 분할을 고려한 프로토콜을 써야 한다. 2PC 는 전역원자성을 보장하지만 블로킹 위험이 있고 운영 부담이 크다. 합의 알고리듬 (Raft/Paxos) 은 레플리카 일관성에 유리하다. Saga/Outbox 는 서비스 독립성과 저지연을 제공하되 보상 로직·관찰성 설계가 필수다. 실제 설계는 비즈니스 강일관성 요구와 운영 비용을 고려해 선택한다.</p><table><thead><tr><th>기법</th><th style=text-align:right>핵심</th><th>장점</th><th>단점/운영</th></tr></thead><tbody><tr><td>2PC</td><td style=text-align:right>Prepare→Commit 원자성</td><td>강한 전역 원자성</td><td>블로킹·코디네이터 장애</td></tr><tr><td>3PC</td><td style=text-align:right>비차단 보강 시도</td><td>블로킹 완화 가능</td><td>복잡성↑</td></tr><tr><td>Consensus</td><td style=text-align:right>리더 기반 일관성</td><td>레플리카 일관성·내결함성</td><td>메시지 오버헤드</td></tr><tr><td>Saga/Outbox</td><td style=text-align:right>로컬 TX + 보상</td><td>확장성·저지연</td><td>보상 설계·관찰성 필요</td></tr></tbody></table><ul><li>요약: 분산 트랜잭션은 일관성 요구와 운영·성능 비용의 정량 비교에 따라 2PC/합의/Saga 중 선택해야 한다.</li></ul><h6 id=운영자동화컴플라이언스-기법>운영·자동화·컴플라이언스 기법<a hidden class=anchor aria-hidden=true href=#운영자동화컴플라이언스-기법>#</a></h6><p>운영·규정 요건을 만족시키기 위해 트랜잭션을 모듈화하고 BPM/오케스트레이션으로 자동화하며, 감사·암호화·로그 보존 정책을 통합한다. Outbox 는 외부 메시지 원자화를 지원해 이벤트 일관성을 확보한다. 이 카테고리는 신뢰성·감사성·운영 효율을 높이는 데 초점이 있다.</p><table><thead><tr><th>항목</th><th style=text-align:right>목적</th><th>구현 포인트</th><th>운영 고려</th></tr></thead><tbody><tr><td>BPM/오케스트레이션</td><td style=text-align:right>단계 자동화·복구</td><td>상태 머신·재시도 정책</td><td>오케스트레이터 장애 리스크</td></tr><tr><td>Outbox</td><td style=text-align:right>원자적 이벤트 발행</td><td>로컬 DB + 배포 프로세스</td><td>스루풋·retry 관리</td></tr><tr><td>감사·보안</td><td style=text-align:right>규정·무결성 확보</td><td>서명·암호화·로그 보존</td><td>보존 주기·접근 통제</td></tr></tbody></table><ul><li>요약: 운영 카테고리는 규제·감사·운영 효율을 보장하기 위한 실무적 기법을 제공하며, 시스템 설계 초기에 통합해야 효과적이다.</li></ul><h5 id=트랜잭션-기법-카테고리-통합표>트랜잭션 기법 카테고리 통합표<a hidden class=anchor aria-hidden=true href=#트랜잭션-기법-카테고리-통합표>#</a></h5><table><thead><tr><th>카테고리</th><th style=text-align:right>핵심 기법</th><th style=text-align:right>주요 목적</th><th style=text-align:right>장점</th><th>운영 리스크</th></tr></thead><tbody><tr><td>A. 내구성·복구</td><td style=text-align:right>WAL, ARIES, 체크포인트</td><td style=text-align:right>내구성·복구시간 단축</td><td style=text-align:right>강한 내구성</td><td>로그 I/O·복구 스캔 비용</td></tr><tr><td>B. 동시성·격리</td><td style=text-align:right>2PL, MVCC, Timestamp, OCC</td><td style=text-align:right>격리성·동시성 최적화</td><td style=text-align:right>워크로드별 성능 최적화</td><td>데드락·버전 GC·재시도</td></tr><tr><td>C. 분산·일관성</td><td style=text-align:right>2PC/3PC, Raft/Paxos, Saga</td><td style=text-align:right>분산 원자성/일관성 확보</td><td style=text-align:right>전역 일관성 / 확장성 선택 가능</td><td>블로킹·보상 복잡도</td></tr><tr><td>D. 운영·컴플라이언스</td><td style=text-align:right>BPM, Outbox, 감사</td><td style=text-align:right>자동화·감사·이벤트 일관성</td><td style=text-align:right>규정 준수·운영 효율</td><td>추가 인프라·운영비용</td></tr></tbody></table><h4 id=트랜잭션-분류제어운영-통합-체계>트랜잭션 분류·제어·운영 통합 체계<a hidden class=anchor aria-hidden=true href=#트랜잭션-분류제어운영-통합-체계>#</a></h4><p>트랜잭션은 &rsquo; 어떤 작업을 어느 범위까지, 얼마나 오래 &rsquo; 수행하느냐에 따라 유형이 달라지고 (단일·연산·분산·장기·배치), 각 유형에 적합한 기술 (락·버전·검증), 격리 수준, 복구 전략을 골라 적용해야 한다.<br>실무에서는 <strong>범위 (무엇을 묶는가)</strong> 와 <strong>목표 (강한 일관성 vs 가용성·지연 허용)</strong> 를 먼저 정하고, 그에 따라 동시성·복구·분산 패턴을 결정한다.<br>운영적 디테일 (로그 정책·GC·보상 로직) 이 설계의 성패를 좌우한다.</p><h5 id=트랜잭션-분류-유형메커니즘운영>트랜잭션 분류: 유형·메커니즘·운영<a hidden class=anchor aria-hidden=true href=#트랜잭션-분류-유형메커니즘운영>#</a></h5><h6 id=범위지속성-기반-유형-단일연산분산장기배치>범위·지속성 기반 유형 (단일·연산·분산·장기·배치)<a hidden class=anchor aria-hidden=true href=#범위지속성-기반-유형-단일연산분산장기배치>#</a></h6><p>설명: 트랜잭션을 비즈니스 관점에서 분류한 것. 각 유형은 요구되는 일관성 수준, 허용 지연, 실패 처리 방식이 다르다.</p><ul><li><strong>단일 트랜잭션</strong>: 하나의 연산 (예: 카드 결제 단건). 일반적으로 짧고 원자성이 중요. DB 트랜잭션으로 처리.</li><li><strong>연산 트랜잭션</strong>: 한 요청이 여러 연산을 포함 (예: 장바구니 체크아웃). 내부적으로 여러 커밋포인트·롤백 지점 고려.</li><li><strong>분산 트랜잭션</strong>: 여러 서비스/DB 에 걸쳐 조정 필요 (예: 송금→알림→원장). 2PC 또는 Saga 로 처리.</li><li><strong>장기 트랜잭션</strong>: 수시간~수일에 걸친 프로세스 (예: 대규모 계약·기업합병). 보상 트랜잭션·타임아웃 필요.</li><li><strong>배치 트랜잭션</strong>: 일괄 대량 처리 (예: 야간 정산). 격리 수준을 낮춰 성능 최적화 가능.</li></ul><table><thead><tr><th>유형</th><th style=text-align:right>특징</th><th style=text-align:right>요구사항 (정합성/지연)</th><th>대표 적용</th></tr></thead><tbody><tr><td>단일</td><td style=text-align:right>짧고 원자적</td><td style=text-align:right>강한 정합성, 낮은 지연</td><td>결제 단건</td></tr><tr><td>연산</td><td style=text-align:right>복수 연산 포함</td><td style=text-align:right>원자성 + 부분 보상 고려</td><td>장바구니 체크아웃</td></tr><tr><td>분산</td><td style=text-align:right>여러 시스템 연계</td><td style=text-align:right>일관성 전략 (강/최종) 필요</td><td>다중 서비스 송금</td></tr><tr><td>장기</td><td style=text-align:right>단계별 장시간 처리</td><td style=text-align:right>상태 보존·보상 필요</td><td>계약·프로젝트</td></tr><tr><td>배치</td><td style=text-align:right>대량 일괄</td><td style=text-align:right>처리량 최적화, 낮은 격리</td><td>정산·보고</td></tr></tbody></table><p>요약: 트랜잭션 유형은 &rsquo; 무엇을 묶는가 &rsquo; 와 &rsquo; 얼마나 오래 유지되는가 &rsquo; 로 결정된다. 유형에 따라 일관성 목표와 선택 가능한 기술 (2PC, Saga, DB 트랜잭션 등) 이 달라진다.</p><h6 id=제어-메커니즘-기반-유형-동시성격리복구분산패턴>제어 메커니즘 기반 유형 (동시성·격리·복구·분산패턴)<a hidden class=anchor aria-hidden=true href=#제어-메커니즘-기반-유형-동시성격리복구분산패턴>#</a></h6><p>설명: 시스템이 트랜잭션을 안전하게 실행하도록 하는 기술적 수단들을 분류한 것.</p><ul><li><strong>동시성 제어</strong>:<ul><li><em>비관적 (2PL)</em>: 락으로 충돌 예방 → 데드락 가능성</li><li><em>낙관적 (OCC)</em>: 충돌 시 검증·재시도 → 충돌 낮은 환경 유리</li><li><em>MVCC</em>: 버전 기반 읽기 (스냅샷) → 읽기 지연 없음</li></ul></li><li><strong>격리 수준</strong>: RU → RC → RR → Serializable(성능↔정합성의 트레이드오프)</li><li><strong>복구 메커니즘</strong>: WAL 선기록, 체크포인트, ARIES(analysis→redo→undo)</li><li><strong>분산 패턴</strong>: 2PC/3PC(동기적 강일관성), Saga/Outbox(비동기·보상 기반)</li></ul><table><thead><tr><th>메커니즘</th><th style=text-align:right>핵심 특성</th><th style=text-align:right>장점</th><th style=text-align:right>단점</th><th>권장 적용</th></tr></thead><tbody><tr><td>2PL(비관적)</td><td style=text-align:right>락 기반 직렬화</td><td style=text-align:right>강한 정합성</td><td style=text-align:right>데드락·지연</td><td>금융 장부</td></tr><tr><td>OCC(낙관적)</td><td style=text-align:right>실행 후 검증</td><td style=text-align:right>높은 동시성</td><td style=text-align:right>충돌 시 재시도 비용</td><td>충돌 적은 웹앱</td></tr><tr><td>MVCC</td><td style=text-align:right>버전 스냅샷 읽기</td><td style=text-align:right>비차단 읽기</td><td style=text-align:right>저장소 증가</td><td>리포팅 +OLTP 혼합</td></tr><tr><td>Serializable</td><td style=text-align:right>완전 격리</td><td style=text-align:right>완벽 일관성</td><td style=text-align:right>성능 저하</td><td>미션 크리티컬</td></tr><tr><td>2PC / Saga</td><td style=text-align:right>분산 커밋 vs 보상</td><td style=text-align:right>강/유연 선택지</td><td style=text-align:right>블로킹 vs 보상 설계 필요</td><td>마이크로서비스</td></tr></tbody></table><p>요약: 제어 메커니즘은 성능과 정합성의 균형을 조정하는 도구다. 각 기법은 장단점이 명확하므로 워크로드·비즈니스 요구에 따라 혼합·적응적으로 적용해야 한다.</p><h6 id=운영실무-고려사항-체크포인트gc멱등성모니터링>운영·실무 고려사항 (체크포인트·GC·멱등성·모니터링)<a hidden class=anchor aria-hidden=true href=#운영실무-고려사항-체크포인트gc멱등성모니터링>#</a></h6><p>설명: 실제 서비스 운영에서 반드시 다뤄야 할 항목들. 설계에서 누락되면 장애·데이터 누수·운영비용 증가로 이어짐.</p><ul><li><strong>체크포인트 주기</strong>: 너무 잦으면 디스크 부하, 너무 늦으면 복구시간 증가 → RTO/RPO 목표에 맞춤</li><li><strong>로그 보존 정책</strong>: 감사·포렌식 목적과 디스크 비용 균형 필요</li><li><strong>GC / Vacuum (MVCC)</strong>: 오래된 스냅샷 정리로 스토리지 회수 및 성능 유지를 보장</li><li><strong>멱등성 설계</strong>: Outbox/메시지 소비자에서 중복 처리 방지 (토큰/키 기반)</li><li><strong>보상 트랜잭션</strong>: 장기 트랜잭션·Saga 에서 필수, 보상 실패 시 재시도·수동개입 계획 필요</li><li><strong>모니터링/알람</strong>: 전이별 메트릭 (상태 카운트, 재시도율, 충돌률) 을 정의해 자동 전환/운영 정책 구현</li></ul><table><thead><tr><th>운영 항목</th><th style=text-align:right>핵심 포인트</th><th style=text-align:right>운영 영향</th><th>권장 조치</th></tr></thead><tbody><tr><td>체크포인트 주기</td><td style=text-align:right>RTO/RPO 와 트레이드오프</td><td style=text-align:right>디스크/복구시간 영향</td><td>목표 기반 튜닝</td></tr><tr><td>로그 보존</td><td style=text-align:right>규제·감사 vs 비용</td><td style=text-align:right>스토리지 증가</td><td>등급별 보존 정책</td></tr><tr><td>GC / Vacuum</td><td style=text-align:right>MVCC 스냅샷 정리</td><td style=text-align:right>성능/스토리지 영향</td><td>주기적 스케줄링</td></tr><tr><td>멱등성</td><td style=text-align:right>재시도 안전성</td><td style=text-align:right>중복처리 방지</td><td>키/토큰 기반 dedupe</td></tr><tr><td>보상 트랜잭션</td><td style=text-align:right>보상 시나리오 설계</td><td style=text-align:right>복구복잡도</td><td>재시도·수동플로우 포함</td></tr><tr><td>모니터링</td><td style=text-align:right>상태·지표 정의</td><td style=text-align:right>자동 전환·알람 가능</td><td>슬라이스별 대시보드</td></tr></tbody></table><p>요약: 운영 항목은 설계에서 요구사항 (예: RTO, 규정) 을 반영해 미리 정책화해야 한다. 특히 MVCC 와 분산 메시징에서는 GC·멱등성·로그정책이 핵심이다.</p><h5 id=트랜잭션-유형메커니즘운영-매핑표>트랜잭션 유형·메커니즘·운영 매핑표<a hidden class=anchor aria-hidden=true href=#트랜잭션-유형메커니즘운영-매핑표>#</a></h5><table><thead><tr><th>축/항목</th><th style=text-align:right>범위·지속성 (유형)</th><th style=text-align:right>제어 메커니즘</th><th style=text-align:right>운영 고려사항</th><th>주요 적용 예</th></tr></thead><tbody><tr><td>단일</td><td style=text-align:right>단건 원자</td><td style=text-align:right>DB 트랜잭션 (2PL 등)</td><td style=text-align:right>체크포인트·로그 보존</td><td>카드 결제</td></tr><tr><td>연산</td><td style=text-align:right>복합 연산</td><td style=text-align:right>트랜잭션 국소적 분해</td><td style=text-align:right>멱등성, 리트라이 정책</td><td>장바구니 결제</td></tr><tr><td>분산</td><td style=text-align:right>멀티서비스</td><td style=text-align:right>2PC / Saga / Outbox</td><td style=text-align:right>멱등성, 메시지 보장</td><td>글로벌 송금</td></tr><tr><td>장기</td><td style=text-align:right>장시간 상태</td><td style=text-align:right>보상 (Compensate) 패턴</td><td style=text-align:right>상태 보존·타임아웃</td><td>계약 처리</td></tr><tr><td>배치</td><td style=text-align:right>대량 일괄</td><td style=text-align:right>낮은 격리·파티셔닝</td><td style=text-align:right>자원 스케줄링</td><td>정산·보고</td></tr></tbody></table><h4 id=트랜잭션-도구프레임워크-생태계-분류>트랜잭션 도구·프레임워크 생태계 분류<a hidden class=anchor aria-hidden=true href=#트랜잭션-도구프레임워크-생태계-분류>#</a></h4><p>트랜잭션 도구 생태계는 크게</p><ol><li>전통 RDBMS</li><li>분산 DB/분산 SQL</li><li>메시징/스트리밍</li><li>트랜잭션 매니저</li><li>ORM/드라이버</li><li>블록체인·결제 SDK<br>로 나뉜다.</li></ol><ul><li>전통 RDBMS 는 ACID 와 풍부한 튜닝·운영 기능을 제공한다 (예: PostgreSQL 의 MVCC).</li><li>분산 DB 는 스케일아웃과 지리 분산을 제공하지만 일관성 수준 선택이 설계 포인트 (Spanner 는 TrueTime 으로 강한 일관성 제공).</li><li>카프카 같은 스트리밍 플랫폼은 <strong>Exactly-once</strong> 옵션을 통해 스트림 처리 수준에서 트랜잭셔널 보장을 제공하지만 설정·운영이 복잡하다.</li><li>애플리케이션은 ORM/드라이버 수준에서 트랜잭션 경계를 설계해야 하며, 분산 트랜잭션은 2PC 대신 Saga/Outbox 같은 대안을 자주 사용한다.</li></ul><h5 id=트랜잭션-도구프레임워크-분류>트랜잭션 도구·프레임워크 분류<a hidden class=anchor aria-hidden=true href=#트랜잭션-도구프레임워크-분류>#</a></h5><h6 id=영속성관계형-트랜잭션-rdbms>영속성·관계형 트랜잭션 (RDBMS)<a hidden class=anchor aria-hidden=true href=#영속성관계형-트랜잭션-rdbms>#</a></h6><p>전형적 용도는 ACID 보장, 복잡한 관계형 쿼리 처리, 트랜잭션 로그/체크포인트 기반 복구.<br>대표 제품별 특징:</p><ul><li>PostgreSQL(MVCC/SSI—읽기 - 쓰기 충돌 완화)</li><li>MySQL/InnoDB(Undo/Redo·웹환경 최적화)</li><li>Oracle(강력한 기업 기능)</li><li>SQL Server(체크포인트·로그 관리).</li></ul><table><thead><tr><th>제품</th><th>주요 기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>PostgreSQL</td><td>MVCC, WAL, SSI</td><td>범용 ACID DB</td><td>안정성·확장된 격리, 확장성 플러그인</td><td>VACUUM/버전 관리 운영 필요.</td></tr><tr><td>MySQL/InnoDB</td><td>Undo/Redo, MVCC</td><td>웹·서비스 DB</td><td>널리 사용·경량화</td><td>대규모 분산 트랜잭션 한계.</td></tr><tr><td>Oracle DB</td><td>Redo/Undo, 고급 격리</td><td>엔터프라이즈 트랜잭션</td><td>고급 기능·지원</td><td>비용·폐쇄형 운영.</td></tr><tr><td>SQL Server</td><td>트랜잭션 로그, 체크포인트</td><td>윈도우 친화적 DB</td><td>관리 도구·통합성 우수</td><td>플랫폼 종속성·라이선스 부담.</td></tr></tbody></table><ul><li>RDBMS 계열은 ACID 기반 작업에 최적화되어 있으며, 각 제품은 운영·튜닝 관행 (예: 로그·체크포인트·VACUUM) 과 함께 사용된다. 대규모 글로벌 확장은 설계·운영 난이도가 상승한다.</li></ul><h6 id=분산-일관성확장-분산-db--분산-sql>분산 일관성·확장 (분산 DB / 분산 SQL)<a hidden class=anchor aria-hidden=true href=#분산-일관성확장-분산-db--분산-sql>#</a></h6><p>목적은 지리 분산·스케일아웃에서 강한/조정된 일관성 제공 (또는 조정 가능한 일관성).<br>예:</p><ul><li>Spanner 는 TrueTime 으로 외부 일관성 보장</li><li>Cassandra 는 LWT(Paxos) 로 제한적 선형화 제공</li><li>CockroachDB 는 분산 트랜잭션을 ACID 로 처리.</li></ul><table><thead><tr><th>제품</th><th>주요 기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>Google Spanner</td><td>TrueTime, 외부 일관성</td><td>글로벌 ACID 트랜잭션</td><td>글로벌 강한 일관성, 자동 복제</td><td>비용·제약 (인프라 의존).</td></tr><tr><td>CockroachDB</td><td>분산 SQL, ACID</td><td>지리 분산 RDB</td><td>자동 파티셔닝·복제</td><td>운영 복잡성·투명성 한계.</td></tr><tr><td>Cassandra</td><td>LWT(Paxos), Tunable consistency</td><td>고확장성 키 - 값/컬럼</td><td>쓰기 성능·확장성 우수</td><td>복잡한 트랜잭션 요구엔 부적합.</td></tr><tr><td>MongoDB</td><td>멀티도큐먼트 트랜잭션</td><td>문서 DB + 트랜잭션</td><td>유연한 모델, 트랜잭션 지원</td><td>샤드 환경에서 성능 저하 가능.</td></tr></tbody></table><ul><li>분산 DB 는 확장성·지리적 가용성이 핵심. 강한 일관성이 필요하면 비용·지연을 감수해야 하며, 필요 시 부분적 (로컬) 일관성을 권장한다.</li></ul><h6 id=스트림메시징이벤트-트랜잭션-보강>스트림/메시징·이벤트 (트랜잭션 보강)<a hidden class=anchor aria-hidden=true href=#스트림메시징이벤트-트랜잭션-보강>#</a></h6><p>스트림 처리에서의 <strong>처리 의미론</strong>(at-least-once, at-most-once, exactly-once) 과 DB 와의 연계 (Outbox) 패턴이 핵심.<br>Kafka 는 트랜잭셔널 프로듀서/Streams EOS 를 제공하고, Debezium 은 DB CDC 를 통해 Outbox 패턴을 지원해 안전한 이벤트 발행을 돕는다.</p><table><thead><tr><th>툴</th><th>주요 기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>Apache Kafka</td><td>트랜잭션 프로듀서, Streams EOS</td><td>이벤트 스트리밍·처리</td><td>고처리량·내결함성, EOS 지원</td><td>EOS 구성·운영 복잡.</td></tr><tr><td>Kafka Streams</td><td>상태 ful stream, EOS 옵션</td><td>스트림 애플리케이션</td><td>라이브러리로 단순화</td><td>리소스 관리 필요.</td></tr><tr><td>Debezium</td><td>CDC, Outbox integration</td><td>DB->이벤트 브리징</td><td>안전한 outbox 패턴 구현</td><td>설정·연동 복잡.</td></tr></tbody></table><ul><li>이 계열은 이벤트 기반 아키텍처에 필수적이며, 트랜잭션적 일관성 (특히 분산 컨텍스트) 확보를 위해 Outbox·EOS 등 패턴을 함께 설계해야 한다.</li></ul><h6 id=분산-트랜잭션-코디네이터-jta--atomikos-등>분산 트랜잭션 코디네이터 (JTA / Atomikos 등)<a hidden class=anchor aria-hidden=true href=#분산-트랜잭션-코디네이터-jta--atomikos-등>#</a></h6><p>JTA 는 Java 환경의 표준 인터페이스로 2PC/XA 자원과의 통합을 지원하며, Atomikos 같은 매니저는 실제 운영 구현 (타임아웃·회복) 을 제공한다. 그러나 2PC 의 본질적 블로킹 문제 때문에 대안 (Saga 등) 과 병용하는 경우가 많다.</p><table><thead><tr><th>툴</th><th>주요 기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>JTA (Jakarta Transactions)</td><td>표준 트랜잭션 API</td><td>Java EE/Jakarta 분산 트랜잭션</td><td>표준화·광범위 호환</td><td>2PC 의 블로킹 특성 존재.</td></tr><tr><td>Atomikos</td><td>JTA 구현체, XA 지원</td><td>분산 TM(상용/OSS)</td><td>회복·모니터링 기능 제공</td><td>구성·운영 복잡도 · 라이선스 고려.</td></tr></tbody></table><ul><li>분산 트랜잭션은 표준 (예: JTA/XA) 으로 가능하지만, 성능·가용성 트레이드오프로 인해 Saga/Outbox 와 같은 비동기 보상 패턴이 자주 병용된다.</li></ul><h6 id=애플리케이션-레벨-트랜잭션-도구-orm드라이버>애플리케이션 레벨 트랜잭션 도구 (ORM·드라이버)<a hidden class=anchor aria-hidden=true href=#애플리케이션-레벨-트랜잭션-도구-orm드라이버>#</a></h6><p>ORM 과 드라이버는 트랜잭션 경계를 애플리케이션 코드로 쉽게 표현·관리하게 해주나, 비동기 환경에서 <strong>컨텍스트 전파</strong> 이슈가 발생할 수 있다 (예: Prisma 의 트랜잭션 타임아웃/컨텍스트 관리, TypeORM 데코레이터 패턴).</p><table><thead><tr><th>툴</th><th>주요 기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>SQLAlchemy</td><td>세션·트랜잭션 관리</td><td>Python ORM</td><td>유연한 트랜잭션 모델</td><td>세션 관리 실수로 버그 발생 가능.</td></tr><tr><td>Psycopg</td><td>Postgres 드라이버</td><td>DB 연결·트랜잭션</td><td>안정적·비동기 지원 개선</td><td>트랜잭션 자동 시작 동작 주의.</td></tr><tr><td>Prisma / TypeORM</td><td>JS/TS ORM/클라이언트</td><td>트랜잭션 API 제공</td><td>개발 생산성·타입 안전</td><td>비동기 컨텍스트 전파 문제.</td></tr></tbody></table><ul><li>ORM/드라이버는 개발 생산성을 높이나, 분산·비동기 환경에서 트랜잭션 전파·타임아웃을 명확히 설계해야 한다.</li></ul><h6 id=블록체인결제-sdk>블록체인·결제 SDK<a hidden class=anchor aria-hidden=true href=#블록체인결제-sdk>#</a></h6><p>블록체인 라이브러리는 체인상 트랜잭션 제출 (비용·지연 존재), 결제 게이트웨이는 <strong>idempotency</strong>·감사·규제 대응이 중요하다 (Stripe 의 idempotency key 권장).</p><table><thead><tr><th>툴</th><th>주요 기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>web3.js / ethers.js</td><td>EVM 트랜잭션 생성/서명</td><td>블록체인 상 트랜잭션</td><td>표준화된 API, 풍부한 커뮤니티</td><td>트랜잭션 확정 지연·가스비 부담.</td></tr><tr><td>Hyperledger Fabric SDK</td><td>Fabric 네트워크 트랜잭션 제출</td><td>엔터프라이즈 블록체인</td><td>프라이빗·권한형 네트워크</td><td>네트워크 운영 복잡, 학습 비용.</td></tr><tr><td>Stripe / PayPal</td><td>결제 API, idempotency</td><td>결제 트랜잭션 처리</td><td>결제 특화 기능·보안 ·감사</td><td>외부의존성·규제·수수료.</td></tr></tbody></table><ul><li>외부 결제·블록체인 연동은 트랜잭션 완결성 외에 규제·비용·지연 요소를 반드시 설계에 반영해야 한다.</li></ul><h5 id=트랜잭션-도구프레임워크-한눈표>트랜잭션 도구·프레임워크 한눈표<a hidden class=anchor aria-hidden=true href=#트랜잭션-도구프레임워크-한눈표>#</a></h5><table><thead><tr><th>카테고리</th><th>대표 툴 (예)</th><th>역할/주요 기능</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>RDBMS</td><td>PostgreSQL, MySQL, Oracle, SQL Server</td><td>ACID 트랜잭션, WAL, MVCC, 체크포인트</td><td>안정성·성숙한 운영도구</td><td>글로벌 확장성 한계, fsync 비용.</td></tr><tr><td>분산 DB</td><td>Spanner, CockroachDB, Cassandra, MongoDB</td><td>분산 트랜잭션/확장성, LWT, TrueTime</td><td>지리 분산·확장성</td><td>복잡성·비용·운영 난이도.</td></tr><tr><td>스트림/이벤트</td><td>Kafka, Kafka Streams, Debezium</td><td>EOS, CDC, Outbox 패턴</td><td>고처리량·내결함성</td><td>EOS 구성·연동 복잡.</td></tr><tr><td>TM / 미들웨어</td><td>JTA, Atomikos, Narayana</td><td>분산 트랜잭션 코디네이션 (2PC/XA)</td><td>표준화·원자성 보장</td><td>2PC 블로킹·성능 오버헤드.</td></tr><tr><td>ORM/드라이버</td><td>SQLAlchemy, Psycopg, Prisma, TypeORM</td><td>트랜잭션 경계·컨텍스트 관리</td><td>개발 생산성</td><td>컨텍스트 전파 이슈·비동기 난점.</td></tr><tr><td>블록체인/결제</td><td>web3.js, ethers.js, Fabric SDK, Stripe</td><td>분산원장 트랜잭션, 결제 API·idempotency</td><td>감사·영속성, 결제 안전성</td><td>지연·비용·규제·외부 의존.</td></tr></tbody></table><h4 id=트랜잭션-표준규격별-실무-준수-가이드>트랜잭션 표준·규격별 실무 준수 가이드<a hidden class=anchor aria-hidden=true href=#트랜잭션-표준규격별-실무-준수-가이드>#</a></h4><p>표준·규격 준수사항은 <strong>무엇을 어떻게 지켜야 안전하고 상호운용 가능한 트랜잭션을 만들 수 있는가</strong>를 규정한다.</p><ul><li>금융 메시지와 데이터 형식은 ISO 20022·SWIFT 같은 표준을 따르고,</li><li>카드·결제 관련 데이터 보안은 PCI DSS 규정을 따라야 하며,</li><li>개인정보·전자서명은 GDPR·eIDAS 같은 법·규정을 따르며,</li><li>데이터베이스·분산 트랜잭션은 SQL 표준·XA 같은 인터페이스 규격을 참고해 구현한다.</li></ul><h5 id=트랜잭션-표준규격-카테고리-분류>트랜잭션 표준·규격 카테고리 분류<a hidden class=anchor aria-hidden=true href=#트랜잭션-표준규격-카테고리-분류>#</a></h5><h6 id=금융-메시징상호운용성-표준>금융 메시징·상호운용성 표준<a hidden class=anchor aria-hidden=true href=#금융-메시징상호운용성-표준>#</a></h6><p>금융 거래 메시지의 구조·필드·교환 규약을 정의한다.<br>대표 표준은 ISO 20022 로, 풍부한 구조화된 데이터 (전자 수취인 정보·참조 정보 등) 를 전송해 자동화·정산·분석을 개선한다.<br>SWIFT 는 기존 MT 포맷과 ISO 20022 를 연결·운영하며, gpi 등 추가 서비스로 트래킹·투명성 기능을 제공한다. (활용: 계좌 이체, 해외송금, 결제 메시지).</p><table><thead><tr><th>항목</th><th>설명</th><th>실무 체크포인트</th></tr></thead><tbody><tr><td>ISO 20022</td><td>메시지 포맷·비즈니스 용어 표준</td><td>마이그레이션 일정·필드 매핑 점검</td></tr><tr><td>SWIFT (FIN/gpi)</td><td>메시지 전달·추적·네트워크 규약</td><td>수취/발신 은행 호환성·gpi 추적 설정</td></tr></tbody></table><ul><li>금융 메시징 표준은 &rsquo; 데이터 품질과 상호운용성 &rsquo; 을 높여 정산 오류를 줄이고 자동화를 촉진한다. 마이그레이션과 필드 매핑·운영 테스트가 핵심.</li></ul><h6 id=보안결제-데이터-보호-규격>보안·결제 데이터 보호 규격<a hidden class=anchor aria-hidden=true href=#보안결제-데이터-보호-규격>#</a></h6><p>카드·결제 데이터의 저장·전송·처리와 관련된 보안 요구사항을 규정한다.<br>PCI DSS 는 카드번호·CVV·토큰화·로그 관리·취약점 스캔 등 구체적 통제항목을 명시한다.<br>조직은 PCI 요구사항을 준수하기 위해 기술적 (암호화·네트워크 분할)·관리적 (정책·감사) 통제 구현이 필요하다. (출처: PCI SSC 문서).</p><table><thead><tr><th>항목</th><th>설명</th><th>실무 체크포인트</th></tr></thead><tbody><tr><td>PCI DSS</td><td>카드 데이터 보호 규정 (요구사항 집합)</td><td>범위 (Scope) 정의, 분리/토큰화, 정기 점검</td></tr><tr><td>운영 보안</td><td>접근통제·로그·취약점 관리</td><td>권한 최소화·정기 감사·패치</td></tr></tbody></table><ul><li>결제 보안은 기술·운영·관리 통제의 결합으로 달성된다. PCI 범위 축소와 토큰화가 비용·리스크를 낮춘다.</li></ul><h6 id=개인정보전자거래-법규전자신원>개인정보·전자거래 법규·전자신원<a hidden class=anchor aria-hidden=true href=#개인정보전자거래-법규전자신원>#</a></h6><p>개인정보 보호 (GDPR 등) 와 전자거래·전자서명 규제 (eIDAS 등) 는 데이터 처리 근거·보관기간·주체 권리 (접근·삭제 등) 와 전자식별·전자서명의 법적 요건을 규정한다.<br>전자거래에 필요한 신원확인·서명·타임스탬프 요건 등을 충족해야 법적 효력과 컴플라이언스를 확보할 수 있다.</p><table><thead><tr><th>항목</th><th>설명</th><th>실무 체크포인트</th></tr></thead><tbody><tr><td>GDPR</td><td>EU 개인정보 보호 규정</td><td>데이터 최소화·동의·처리기록·권리 대응 프로세스</td></tr><tr><td>eIDAS / Digital ID</td><td>전자서명·신원확인 규제</td><td>신원 수준 (LoA)·전자서명 요건 충족</td></tr></tbody></table><ul><li>법규 준수는 설계 초기부터 반영해야 하며, 데이터 보존·동의·국가별 규정 차이에 유의해야 한다.</li></ul><h6 id=데이터베이스트랜잭션-인터페이스-표준>데이터베이스·트랜잭션 인터페이스 표준<a hidden class=anchor aria-hidden=true href=#데이터베이스트랜잭션-인터페이스-표준>#</a></h6><p>SQL(ISO/IEC 9075) 은 트랜잭션·격리수준·저장점 등 데이터 조작 표준을 제공한다.<br>분산 트랜잭션을 위한 X/Open XA 규격 (2PC) 은 트랜잭션 매니저와 리소스 매니저 간 인터페이스를 정의하며, Java 진영에서는 JTA/Jakarta Transactions 로 연동된다.<br>분산 환경에서는 XA 의 블로킹 특성·복구 요구를 고려해야 한다.</p><table><thead><tr><th>항목</th><th>설명</th><th>실무 체크포인트</th></tr></thead><tbody><tr><td>SQL (ISO 9075)</td><td>표준 SQL 언어·격리수준 규정</td><td>DB 벤더별 확장·격리수준 동작 확인</td></tr><tr><td>X/Open XA / JTA</td><td>분산 트랜잭션 인터페이스 (2PC)</td><td>교착/미결 트랜잭션 감시·복구 계획</td></tr></tbody></table><ul><li>DB 표준과 XA 는 상호운영성 보장에 필수적이나, 분산 트랜잭션의 운영·복구 복잡성을 반드시 설계에 반영해야 한다.</li></ul><h6 id=네트워크플랫폼별-블록체인-등-규약>네트워크·플랫폼별 (블록체인 등) 규약<a hidden class=anchor aria-hidden=true href=#네트워크플랫폼별-블록체인-등-규약>#</a></h6><p>블록체인은 네트워크별 합의 알고리즘·블록 구조·트랜잭션 포맷을 규정하며, 온체인 데이터의 불변성·전파·컨펌 메커니즘이 표준 (프로토콜) 역할을 한다.<br>탈중앙 환경에서는 개인정보 보호·규제 준수 (예: 개인정보 삭제 요구와 블록체인 불변성 충돌) 문제를 별도로 설계해야 한다.</p><table><thead><tr><th>항목</th><th>설명</th><th>실무 체크포인트</th></tr></thead><tbody><tr><td>블록체인 프로토콜</td><td>합의·데이터 포맷 규정 (네트워크별)</td><td>개인정보 처리 설계·온체인/오프체인 분리</td></tr><tr><td>분산원장 규정</td><td>노드 운영·거래 처리 규약</td><td>규제 준수·가스/수수료 모델 고려</td></tr></tbody></table><ul><li>블록체인 규약은 네트워크별로 달라 설계·법규 충돌 (예: 삭제권) 해결 전략을 반드시 마련해야 한다.</li></ul><h5 id=트랜잭션-표준규격-총괄-요약표>트랜잭션 표준·규격 총괄 요약표<a hidden class=anchor aria-hidden=true href=#트랜잭션-표준규격-총괄-요약표>#</a></h5><table><thead><tr><th>카테고리</th><th>대표 표준/규정</th><th>핵심 요구사항</th><th>운영 체크포인트</th></tr></thead><tbody><tr><td>금융 메시징</td><td>ISO 20022, SWIFT</td><td>구조화된 메시지·상호운용성</td><td>마이그레이션·필드맵, 테스트</td></tr><tr><td>결제 보안</td><td>PCI DSS (v4.x)</td><td>카드데이터 보호·통제항목</td><td>범위 (Scope), 토큰화, 점검</td></tr><tr><td>개인정보 · 전자거래</td><td>GDPR, eIDAS</td><td>동의·처리근거·전자식별 요건</td><td>데이터보존·동의관리·법적효력</td></tr><tr><td>DB·트랜잭션 인터페이스</td><td>ISO/IEC 9075, X/Open XA, JTA</td><td>격리·저장점·2PC 인터페이스</td><td>벤더동작·미결복구·감시</td></tr><tr><td>블록체인·DLT</td><td>네트워크별 프로토콜</td><td>합의·불변성·온/오프체인 분리</td><td>개인정보·거래 수수료·정책</td></tr></tbody></table><p>위 표는 트랜잭션 관련 표준·규격을 <strong>기능별로 나누어</strong> 어떤 표준을 참고해야 하는지와 실무적 체크포인트를 한눈에 보여준다. 실제 설계·감사·컴플라이언스는 표에 적힌 체크포인트를 기준으로 정책·기술·운영 (모니터링·복구·감사) 을 결합해 실행해야 한다.</p><h4 id=트랜잭션-안티패턴-분석과-대응>트랜잭션 안티패턴 분석과 대응<a hidden class=anchor aria-hidden=true href=#트랜잭션-안티패턴-분석과-대응>#</a></h4><p>트랜잭션 안에 오래 머무르는 작업, 외부 호출, 혹은 대량 업데이트를 그대로 넣는 것이 가장 큰 실수다.<br>결과는 락 경쟁, 성능 저하, 복구 복잡도 증가다.<br>해결은 원칙적으로 &rsquo; 작게·짧게·분리 &rsquo; 다:</p><ul><li>트랜잭션은 핵심 상태 변경만 포함하고,</li><li>외부 통신은 비동기 (또는 outbox) 로 처리하며,</li><li>대량 작업은 청크 단위로 나누어 커밋하는 것이다.</li><li>또한 운영 매개변수 (로그 크기, 체크포인트, 풀 크기) 를 모니터링하며 튜닝해야 시스템이 안정화된다.</li></ul><h5 id=트랜잭션-안티패턴-분류>트랜잭션 안티패턴 분류<a hidden class=anchor aria-hidden=true href=#트랜잭션-안티패턴-분류>#</a></h5><h6 id=설계모델링-레벨-문제>설계/모델링 레벨 문제<a hidden class=anchor aria-hidden=true href=#설계모델링-레벨-문제>#</a></h6><p>설명: 트랜잭션 경계와 격리 수준을 설계 단계에서 잘못 정하면 시스템 전체에 성능·정합성 문제가 발생한다.</p><ul><li>문제: 무차별적 Serializable, 트랜잭션 범위 과다설계 (외부 호출 포함), 중첩 트랜잭션 남용</li><li>결과: 성능 저하 (대기·충돌), 예측 불가능한 롤백 동작, 복구·테스트 복잡도 증가</li><li>원인: 안전 최우선의 단순화 설계, 복잡한 비즈니스 로직의 DB 내 몰아넣기</li><li>해결책: 요구 기반 격리 수준 선택, 트랜잭션 범위 최소화, 외부 I/O 는 분리 또는 outbox 사용, 저장점은 국소적 사용으로 제한</li><li>예시 (문제): 모든 쓰기 작업을 Serializable 로 설정 → 동시성 급감.</li><li>예시 (해결): 핵심 불변식만 Serializable 로 지정, 나머지는 Snapshot isolation 또는 Read Committed 로 처리.</li></ul><p><strong>표: 설계/모델링 요약</strong></p><table><thead><tr><th>항목</th><th style=text-align:right>문제</th><th>해결 핵심</th></tr></thead><tbody><tr><td>격리 수준 오용</td><td style=text-align:right>불필요한 병목</td><td>요구 기반 선택</td></tr><tr><td>트랜잭션 범위 과대</td><td style=text-align:right>외부 I/O 포함 → 락 유지</td><td>outbox/비동기 분리</td></tr><tr><td>중첩 트랜잭션 남용</td><td style=text-align:right>롤백 경계 불명확</td><td>저장점 최소화, 분리 TX</td></tr></tbody></table><ul><li>요약: 설계 단계에서 &rsquo; 무엇을 보장할지 &rsquo; 를 명확히 정하고 트랜잭션은 그에 맞게 최소화해야 한다.</li></ul><h6 id=구현런타임-레벨-문제>구현/런타임 레벨 문제<a hidden class=anchor aria-hidden=true href=#구현런타임-레벨-문제>#</a></h6><p>설명: 런타임 구현 (쿼리 방식·배치·루프) 이 트랜잭션 성능과 안정성에 직접적 영향을 준다.</p><ul><li>문제: 긴 트랜잭션 (사용자 대기·대량 I/O), N+1 업데이트 루프, 대용량 단일 TX 업데이트</li><li>결과: 로그 폭증·복구 지연·데드락 발생·버퍼/디스크 과다 사용</li><li>원인: 단순 구현 (루프 내 업데이트), 편의적 단일 TX 처리</li><li>해결책: 청크 처리·배치 커밋·대량 연산은 BULK 쿼리로, 쿼리 최적화, 트랜잭션 타임박스 적용</li><li>예시 (문제): 게시글에 달린 댓글을 트랜잭션에서 하나씩 업데이트 처리 → N+1 I/O.</li><li>예시 (해결): JOIN 기반 일괄 업데이트 또는 1K 씩 청크로 커밋.</li></ul><p><strong>표: 구현/런타임 요약</strong></p><table><thead><tr><th>항목</th><th style=text-align:right>문제</th><th>해결 핵심</th></tr></thead><tbody><tr><td>긴 트랜잭션</td><td style=text-align:right>락·MVCC bloat</td><td>트랜잭션 분할, 비동기화</td></tr><tr><td>N+1 루프</td><td style=text-align:right>불필요 I/O</td><td>배치/BULK, 청크 처리</td></tr><tr><td>대량 단일 TX</td><td style=text-align:right>로그·복구 비용</td><td>청크 + 커밋, idempotent 설계</td></tr></tbody></table><ul><li>요약: 구현 관점에서 핵심은 트랜잭션을 &rsquo; 작게 &rsquo; 유지하고 대량 작업은 나눠서 처리하는 것이다.</li></ul><h6 id=분산통합-레벨-문제>분산/통합 레벨 문제<a hidden class=anchor aria-hidden=true href=#분산통합-레벨-문제>#</a></h6><p>설명: 여러 서비스·외부 시스템과 연계되는 트랜잭션은 네트워크·가용성 문제를 추가로 야기한다.</p><ul><li>문제: 외부 호출을 TX 에 포함, 2PC 의 블로킹, 보상 로직 미설계</li><li>결과: 코디네이터 장애 시 블로킹, 상태 불일치, 복잡한 장애 복구</li><li>원인: 원자성 욕구로 모든 것을 동기식으로 묶으려는 설계</li><li>해결책: outbox pattern + idempotency, Saga(보상) 패턴 적용, 2PC 는 제한적 사용, 타임아웃·휴리스틱 정책 수립</li><li>예시 (문제): 주문 트랜잭션에서 결제·배송 API 를 동기 호출 → 결제 게이트웨이 지연이 DB 락으로 번짐.</li><li>예시 (해결): 주문 DB 기록 + outbox 에 이벤트 기록 → 트랜잭션 커밋 → 워커가 외부 호출, 실패 시 보상 트랜잭션 수행.</li></ul><p><strong>표: 분산/통합 요약</strong></p><table><thead><tr><th>항목</th><th style=text-align:right>문제</th><th>해결 핵심</th></tr></thead><tbody><tr><td>외부 I/O 포함</td><td style=text-align:right>락 유지·지연</td><td>outbox, 비동기 전송</td></tr><tr><td>2PC 오용</td><td style=text-align:right>블로킹·복잡성</td><td>Saga 우선, 2PC 제한적</td></tr><tr><td>보상 미비</td><td style=text-align:right>상태 불일치</td><td>보상 트랜잭션 설계</td></tr></tbody></table><ul><li>요약: 분산 환경에서는 동기적 원자성보다 내결함성과 보상 설계가 현실적이다.</li></ul><h6 id=운영환경-레벨-문제>운영/환경 레벨 문제<a hidden class=anchor aria-hidden=true href=#운영환경-레벨-문제>#</a></h6><p>설명: 구성·모니터링·튜닝 부족은 이론적 보장을 무력화한다.</p><ul><li>문제: 부적절한 데드락 탐지, 로그 관리 부실, 연결 풀·체크포인트 미조정</li><li>결과: 운영 중 장애·긴 복구시간·자원 고갈</li><li>원인: 관측 지표 부족·운영 정책 부재</li><li>해결책: 메트릭 수집 (커밋 지연, abort 률, 로그 성장), 자동화된 복구 runbook, 적정 파라미터 튜닝, 정기 점검 (체크포인트·VACUUM)</li><li>예시 (문제): 로그가 무한히 커져 디스크 부족 발생.</li><li>예시 (해결): 로그 보존 정책·체크포인트 간격 재설정·그룹 커밋 도입.</li></ul><p><strong>표: 운영/환경 요약</strong></p><table><thead><tr><th>항목</th><th style=text-align:right>문제</th><th>해결 핵심</th></tr></thead><tbody><tr><td>데드락 탐지 설정</td><td style=text-align:right>오버헤드/지연</td><td>적정 주기·알고리즘 선택</td></tr><tr><td>로그/체크포인트</td><td style=text-align:right>디스크·복구 이슈</td><td>보존정책·주기 조정</td></tr><tr><td>연결 풀</td><td style=text-align:right>리소스 고갈/대기</td><td>모니터링 기반 크기 조정</td></tr></tbody></table><ul><li>요약: 운영 지표와 자동화가 없다면 어떤 설계도 안정적으로 운영되지 못한다.</li></ul><h5 id=트랜잭션-안티패턴-통합표>트랜잭션 안티패턴 통합표<a hidden class=anchor aria-hidden=true href=#트랜잭션-안티패턴-통합표>#</a></h5><table><thead><tr><th>카테고리</th><th style=text-align:right>대표 안티패턴</th><th style=text-align:right>핵심 문제</th><th>권장 대체/해결책</th></tr></thead><tbody><tr><td>설계/모델링</td><td style=text-align:right>무차별 Serializable, 과대 TX 범위, 중첩 TX</td><td style=text-align:right>성능 저하·롤백 불확실성</td><td>요구 기반 격리·범위 최소화·outbox</td></tr><tr><td>구현/런타임</td><td style=text-align:right>긴 TX, N+1 루프, 대량 단일 TX</td><td style=text-align:right>로그/버퍼 폭증·데드락</td><td>청크·배치·BULK·비동기화</td></tr><tr><td>분산/통합</td><td style=text-align:right>외부 호출 포함, 2PC 남용, 보상 미비</td><td style=text-align:right>블로킹·상태 불일치</td><td>Saga + outbox + idempotency</td></tr><tr><td>운영/환경</td><td style=text-align:right>데드락 탐지·로그·체크포인트 미조정</td><td style=text-align:right>디스크 고갈·긴 RTO</td><td>모니터링·튜닝·자동화·runbook</td></tr></tbody></table><h5 id=트랜잭션-경계-설계-연습>트랜잭션 경계 설계 연습<a hidden class=anchor aria-hidden=true href=#트랜잭션-경계-설계-연습>#</a></h5><h6 id=연습-a은행-이체-외부-호출을-트랜잭션-안에-넣는-안티패턴-vs-개선>연습 A—은행 이체: 외부 호출을 트랜잭션 안에 넣는 안티패턴 Vs 개선<a hidden class=anchor aria-hidden=true href=#연습-a은행-이체-외부-호출을-트랜잭션-안에-넣는-안티패턴-vs-개선>#</a></h6><p>목표: 트랜잭션은 <strong>핵심 상태 변경</strong>만 포함하고 외부 I/O(예: 결제 게이트웨이, 알림) 는 분리한다.</p><ol><li><p>문제 시나리오 (안티패턴)</p><ul><li>한 트랜잭션에서 계좌 차감 → 외부 결제/알림 호출 → 계좌 입금 처리</li><li>외부 호출 지연 시 DB 락이 길게 유지되어 동시성 붕괴</li></ul></li><li><p>개선 설계 (권장 경계)</p><ol><li>DB 트랜잭션은 계좌 잔액 변경 (원자적) 만 수행하고 즉시 커밋</li><li>외부 호출은 트랜잭션 밖에서 수행하거나 outbox 에 이벤트를 기록한 뒤 백그라운드로 전송</li></ol></li><li><p>예제 1: 안티패턴 (하지 말 것)—Python(단순화)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 안티패턴: 외부 호출을 트랜잭션 내부에 포함</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=err>…</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1) 출금</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance - </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># 2) 외부 결제 (네트워크 호출) - 트랜잭션을 블로킹</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;https://external-pay/api/pay&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;amount&#34;</span><span class=p>:</span><span class=mi>100</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Payment failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 3) 입금</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance + </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>문제: <code>requests.post</code> 가 지연 또는 실패하면 DB 락이 길게 유지되며 다른 트랜잭션 성능에 악영향.</p></li><li><p>예제 2: 권장 (Outbox 패턴)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 권장: DB 트랜잭션은 상태 변경 + outbox 기록만 수행, 외부 전송은 워커가 처리</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=err>…</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1) 출금</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance - </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># 2) 입금</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance + </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># 3) outbox에 외부 호출 정보 기록(동일 트랜잭션 내에 기록)</span>
</span></span><span class=line><span class=cl>    <span class=n>event</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span><span class=s2>&#34;transfer&#34;</span><span class=p>,</span> <span class=s2>&#34;from&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;to&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span><span class=mi>100</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO outbox (payload, processed) VALUES (</span><span class=si>%s</span><span class=s2>, false)&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>),))</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 별도 프로세스(워커)가 outbox를 폴링해 외부 전송 및 processed=true로 표시</span>
</span></span></code></pre></td></tr></table></div></div><p>검증: DB 트랜잭션은 빠르게 커밋됨 (외부 지연과 분리). outbox 워커 재시도/아이던포턴시 로직 필요.</p></li></ol><h6 id=연습-b주문-처리-트랜잭션-경계-설계-단일-db-경계--분산-시-고려>연습 B—주문 처리: 트랜잭션 경계 설계 (단일 DB 경계 + 분산 시 고려)<a hidden class=anchor aria-hidden=true href=#연습-b주문-처리-트랜잭션-경계-설계-단일-db-경계--분산-시-고려>#</a></h6><p>목표: 주문 생성, 재고 예약, 외부 결제/배송 호출의 경계 설정</p><ol><li><p>권장 흐름 (단계)</p><ol><li>트랜잭션 A (짧음): <code>orders</code> 생성 + <code>inventory</code> 예약 + <code>outbox</code> 이벤트 기록 → 커밋</li><li>워커 (트랜잭션 B): outbox 이벤트 읽어 외부 결제/배송 호출 → 성공 시 outbox 표시, 실패 시 보상 또는 재시도</li></ol></li><li><p>샘플 스키마 (간단)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8>8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>SERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> </span><span class=n>total</span><span class=w> </span><span class=nb>NUMERIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>inventory</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>sku</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w> </span><span class=n>qty</span><span class=w> </span><span class=nb>INT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>outbox</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>SERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=n>JSONB</span><span class=p>,</span><span class=w> </span><span class=n>processed</span><span class=w> </span><span class=nb>BOOLEAN</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Python: 주문 생성 (트랜잭션 A)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18>18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19>19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20>20</a>
</span><span class=lnt id=hl-11-21><a class=lnlinks href=#hl-11-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 주문 생성: DB 변경 + outbox 기록 (원자적)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>order</span><span class=p>,</span> <span class=n>items</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO orders (status, total) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>) RETURNING id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=s1>&#39;PENDING&#39;</span><span class=p>,</span> <span class=n>order</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 재고 감소(간단 예)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span> <span class=ow>in</span> <span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE inventory SET qty = qty - </span><span class=si>%s</span><span class=s2> WHERE sku = </span><span class=si>%s</span><span class=s2> AND qty &gt;= </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>qty</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cur</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Out of stock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># outbox 이벤트 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=n>items</span><span class=p>,</span> <span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=n>order</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO outbox (payload) VALUES (</span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>),))</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span></code></pre></td></tr></table></div></div><p>검증 포인트:</p><ul><li><p>주문 생성 트랜잭션은 외부 호출 없이 빠르게 끝남.</p></li><li><p>워커 실패시, 보상 로직 (예: 재고 롤백 또는 주문 상태 업데이트) 설계 필요.</p></li></ul></li></ol><h6 id=연습-c대량-업데이트-청크-chunk-로-나누어-커밋>연습 C—대량 업데이트: 청크 (Chunk) 로 나누어 커밋<a hidden class=anchor aria-hidden=true href=#연습-c대량-업데이트-청크-chunk-로-나누어-커밋>#</a></h6><p>목표: 대량 작업을 하나의 TX 에 넣는 안티패턴 회피</p><ol><li><p>문제 시나리오</p><ul><li>사용자 수만큼 루프 돌며 레코드 업데이트를 하나의 트랜잭션으로 수행 → 로그 폭증, 실패 시 전량 롤백</li></ul></li><li><p>권장: 청크 단위 커밋 (예: 1000 건씩)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>BATCH</span> <span class=o>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_large_update</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>rows</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>rows</span><span class=p>),</span> <span class=n>BATCH</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=n>rows</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>BATCH</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE users SET score = score + </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;delta&#39;</span><span class=p>],</span> <span class=n>r</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># 해당 배치만 재시도 로직 또는 실패 로그 기록</span>
</span></span></code></pre></td></tr></table></div></div><p>검증:</p><ul><li>각 배치 실패 시 영향 범위 국한</li><li>로그 성장 및 복구시간 개선</li></ul></li></ol><h6 id=연습-dsavepoint-로-국소적-롤백-처리>연습 D—SAVEPOINT 로 국소적 롤백 처리<a hidden class=anchor aria-hidden=true href=#연습-dsavepoint-로-국소적-롤백-처리>#</a></h6><p>목표: 트랜잭션 내에서 일부 단계 실패 시 전체 롤백 대신 국소 롤백</p><ol><li><p>예제 (Python + SAVEPOINT)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=err>…</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO orders (status, total) VALUES (&#39;PENDING&#39;, 100)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 저장점 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SAVEPOINT sp_payment&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 외부 결제 시뮬레이션(실제 호출은 TX 밖 권장)</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span> <span class=o>=</span> <span class=n>simulate_payment</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 저장점까지 롤백 (order row는 남아 있음)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;ROLLBACK TO SAVEPOINT sp_payment&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 나머지 처리</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>주의: 저장점은 DB 내부 작업의 국소적 롤백에 유용하지만, 외부 호출의 사이드이펙트는 되돌릴 수 없다 (이미 전송된 이메일 등).</p></li></ol><h5 id=주문-처리-애플리케이션의-3-단계-실습-문제-재현--outbox-개선--saga-보상>주문 처리 애플리케이션의 3 단계 실습 (문제 재현 → Outbox 개선 → Saga 보상)<a hidden class=anchor aria-hidden=true href=#주문-처리-애플리케이션의-3-단계-실습-문제-재현--outbox-개선--saga-보상>#</a></h5><h6 id=사전-준비>사전 준비<a hidden class=anchor aria-hidden=true href=#사전-준비>#</a></h6><ul><li>로컬 PostgreSQL (버전 관계 없음) 접근 정보: <code>PG_HOST, PG_PORT, PG_DB, PG_USER, PG_PASS</code> (환경에 맞게 바꿔서 사용)</li><li>Python: <code>psycopg2</code>, <code>requests</code>, <code>flask</code>(간단 결제 모킹용), <code>aiohttp</code>/<code>threading</code> 등 (옵션)</li><li>터미널 3~4 개 (애플리케이션, 워커, 결제 모킹, DB 콘솔)</li></ul><h6 id=공통-db-스키마-모든-단계-공통>공통 DB 스키마 (모든 단계 공통)<a hidden class=anchor aria-hidden=true href=#공통-db-스키마-모든-단계-공통>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a class=lnlinks href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a class=lnlinks href=#hl-14-24>24</a>
</span><span class=lnt id=hl-14-25><a class=lnlinks href=#hl-14-25>25</a>
</span><span class=lnt id=hl-14-26><a class=lnlinks href=#hl-14-26>26</a>
</span><span class=lnt id=hl-14-27><a class=lnlinks href=#hl-14-27>27</a>
</span><span class=lnt id=hl-14-28><a class=lnlinks href=#hl-14-28>28</a>
</span><span class=lnt id=hl-14-29><a class=lnlinks href=#hl-14-29>29</a>
</span><span class=lnt id=hl-14-30><a class=lnlinks href=#hl-14-30>30</a>
</span><span class=lnt id=hl-14-31><a class=lnlinks href=#hl-14-31>31</a>
</span><span class=lnt id=hl-14-32><a class=lnlinks href=#hl-14-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- orders: 주문 상태 추적
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>SERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>user_id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>total</span><span class=w> </span><span class=nb>NUMERIC</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>         </span><span class=c1>-- PENDING, PAID, CONFIRMED, CANCELLED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- inventory: 간단 재고
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>inventory</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>sku</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>qty</span><span class=w> </span><span class=nb>INT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- payments: 로컬 시뮬레이션용 결제 로그
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>payments</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>SERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>order_id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>         </span><span class=c1>-- INIT, SUCCESS, FAILED, REFUNDED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=n>provider_tx_id</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- outbox: Outbox 패턴용 이벤트 저장
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>outbox</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>SERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>topic</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>payload</span><span class=w> </span><span class=n>JSONB</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>processed</span><span class=w> </span><span class=nb>BOOLEAN</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>processed_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>DB 에 기본 재고 삽입 (예시):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>inventory</span><span class=w> </span><span class=p>(</span><span class=n>sku</span><span class=p>,</span><span class=w> </span><span class=n>qty</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;SKU-001&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=단계-1안티패턴-단일-트랜잭션에-외부-결제-호출-포함-문제-재현>단계 1—안티패턴: <strong>단일 트랜잭션에 외부 결제 호출 포함 (문제 재현)</strong><a hidden class=anchor aria-hidden=true href=#단계-1안티패턴-단일-트랜잭션에-외부-결제-호출-포함-문제-재현>#</a></h6><ul><li>애플리케이션 트랜잭션 내에서 DB 업데이트 (주문 생성/재고 차감) 와 외부 결제 호출 (HTTP) 을 동기적으로 수행.</li><li>외부 결제 지연/실패 시 DB 락이 장시간 유지되어 동시성 문제 발생.</li></ul><p><strong>코드 (단순화된 예—하지 말 것)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19>19</a>
</span><span class=lnt id=hl-16-20><a class=lnlinks href=#hl-16-20>20</a>
</span><span class=lnt id=hl-16-21><a class=lnlinks href=#hl-16-21>21</a>
</span><span class=lnt id=hl-16-22><a class=lnlinks href=#hl-16-22>22</a>
</span><span class=lnt id=hl-16-23><a class=lnlinks href=#hl-16-23>23</a>
</span><span class=lnt id=hl-16-24><a class=lnlinks href=#hl-16-24>24</a>
</span><span class=lnt id=hl-16-25><a class=lnlinks href=#hl-16-25>25</a>
</span><span class=lnt id=hl-16-26><a class=lnlinks href=#hl-16-26>26</a>
</span><span class=lnt id=hl-16-27><a class=lnlinks href=#hl-16-27>27</a>
</span><span class=lnt id=hl-16-28><a class=lnlinks href=#hl-16-28>28</a>
</span><span class=lnt id=hl-16-29><a class=lnlinks href=#hl-16-29>29</a>
</span><span class=lnt id=hl-16-30><a class=lnlinks href=#hl-16-30>30</a>
</span><span class=lnt id=hl-16-31><a class=lnlinks href=#hl-16-31>31</a>
</span><span class=lnt id=hl-16-32><a class=lnlinks href=#hl-16-32>32</a>
</span><span class=lnt id=hl-16-33><a class=lnlinks href=#hl-16-33>33</a>
</span><span class=lnt id=hl-16-34><a class=lnlinks href=#hl-16-34>34</a>
</span><span class=lnt id=hl-16-35><a class=lnlinks href=#hl-16-35>35</a>
</span><span class=lnt id=hl-16-36><a class=lnlinks href=#hl-16-36>36</a>
</span><span class=lnt id=hl-16-37><a class=lnlinks href=#hl-16-37>37</a>
</span><span class=lnt id=hl-16-38><a class=lnlinks href=#hl-16-38>38</a>
</span><span class=lnt id=hl-16-39><a class=lnlinks href=#hl-16-39>39</a>
</span><span class=lnt id=hl-16-40><a class=lnlinks href=#hl-16-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># file: bad_order.py</span>
</span></span><span class=line><span class=cl><span class=c1># pip install psycopg2 requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DSN</span> <span class=o>=</span> <span class=s2>&#34;dbname=test user=test password=test host=localhost port=5432&#34;</span>  <span class=c1># 환경에 맞게 대체</span>
</span></span><span class=line><span class=cl><span class=n>PAYMENT_URL</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:5000/pay&#34;</span>  <span class=c1># 로컬 결제 모킹</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>place_order_bad</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>DSN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1) 재고 감소 (잠금 발생 가능)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE inventory SET qty = qty - </span><span class=si>%s</span><span class=s2> WHERE sku = </span><span class=si>%s</span><span class=s2> AND qty &gt;= </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>qty</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cur</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;OUT_OF_STOCK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 2) 주문 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO orders (user_id, total, status) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>) RETURNING id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>,</span> <span class=s1>&#39;PENDING&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 3) 외부 결제 (네트워크 호출) -&gt; 트랜잭션을 블로킹</span>
</span></span><span class=line><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>PAYMENT_URL</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>amount</span><span class=p>)},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span> <span class=ow>or</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;status&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>&#34;OK&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;PAYMENT_FAILED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 4) 결제 성공 시 주문 상태 변경</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO payments (order_id, status, provider_tx_id) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;SUCCESS&#39;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;txid&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE orders SET status = </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;PAID&#39;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ORDER PLACED&#34;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;FAILED:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>place_order_bad</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;SKU-001&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mf>9.99</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>외부 결제 모킹 (지연/오류 시나리오 만들기)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a class=lnlinks href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a class=lnlinks href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a class=lnlinks href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a class=lnlinks href=#hl-17-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># file: payment_mock.py</span>
</span></span><span class=line><span class=cl><span class=c1># pip install flask</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/pay&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;POST&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pay</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl>    <span class=c1># 지연을 넣어 문제 재현: time.sleep(15)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>15</span><span class=p>)</span>  <span class=c1># 의도적 지연 -&gt; DB 락 관찰</span>
</span></span><span class=line><span class=cl>    <span class=c1># 또는 실패 시: return jsonify({&#34;status&#34;:&#34;FAIL&#34;}), 500</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;OK&#34;</span><span class=p>,</span> <span class=s2>&#34;txid&#34;</span><span class=p>:</span><span class=s2>&#34;TX-12345&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>port</span><span class=o>=</span><span class=mi>5000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>실행·검증</strong>:</p><ol><li><code>payment_mock.py</code> 실행 (지연 시나리오)</li><li><code>bad_order.py</code> 실행—실행 중 DB 에서 락 확인:<ul><li>psql 에서 <code>SELECT * FROM pg_locks WHERE granted = false;</code> 또는 <code>SELECT pid, query FROM pg_stat_activity WHERE waiting = true;</code></li></ul></li><li>관찰 결과: 외부 호출이 끝날 때까지 트랜잭션이 락을 유지 → 다른 트랜잭션 (예: 재고 조회/수정) 대기 또는 타임아웃.</li></ol><p><strong>문제 요약</strong>:</p><ul><li>외부 지연으로 인해 DB 락 보유가 길어져 동시성 떨어짐, 데드락·타임아웃 위험, 전체 시스템 성능 저하.</li></ul><h6 id=단계-2개선-outbox-패턴-적용-트랜잭션은-db-변경--outbox-기록만>단계 2—개선: <strong>Outbox 패턴 적용 (트랜잭션은 DB 변경 + Outbox 기록만)</strong><a hidden class=anchor aria-hidden=true href=#단계-2개선-outbox-패턴-적용-트랜잭션은-db-변경--outbox-기록만>#</a></h6><ul><li>트랜잭션 내에서는 외부 호출을 하지 않고, 외부로 전달해야 할 메시지를 <code>outbox</code> 테이블에 기록한다 (동일 트랜잭션 안에서).</li><li>커밋 이후 별도 워커가 <code>outbox</code> 를 읽어 외부에 안전하게 전송 (재시도·아이덴포텐트 보장).</li></ul><p><strong>주문 생성 (트랜잭션 A: DB 변경 + outbox 기록)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16>16</a>
</span><span class=lnt id=hl-18-17><a class=lnlinks href=#hl-18-17>17</a>
</span><span class=lnt id=hl-18-18><a class=lnlinks href=#hl-18-18>18</a>
</span><span class=lnt id=hl-18-19><a class=lnlinks href=#hl-18-19>19</a>
</span><span class=lnt id=hl-18-20><a class=lnlinks href=#hl-18-20>20</a>
</span><span class=lnt id=hl-18-21><a class=lnlinks href=#hl-18-21>21</a>
</span><span class=lnt id=hl-18-22><a class=lnlinks href=#hl-18-22>22</a>
</span><span class=lnt id=hl-18-23><a class=lnlinks href=#hl-18-23>23</a>
</span><span class=lnt id=hl-18-24><a class=lnlinks href=#hl-18-24>24</a>
</span><span class=lnt id=hl-18-25><a class=lnlinks href=#hl-18-25>25</a>
</span><span class=lnt id=hl-18-26><a class=lnlinks href=#hl-18-26>26</a>
</span><span class=lnt id=hl-18-27><a class=lnlinks href=#hl-18-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># file: outbox_order.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=n>DSN</span> <span class=o>=</span> <span class=s2>&#34;dbname=test user=test password=test host=localhost port=5432&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order_outbox</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>DSN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=c1># 재고 감소</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE inventory SET qty = qty - </span><span class=si>%s</span><span class=s2> WHERE sku = </span><span class=si>%s</span><span class=s2> AND qty &gt;= </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>qty</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cur</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;OUT_OF_STOCK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 주문 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO orders (user_id, total, status) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>) RETURNING id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>,</span> <span class=s1>&#39;PENDING&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># outbox 이벤트 기록 (동일 트랜잭션)</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span><span class=s2>&#34;ORDER_CREATED&#34;</span><span class=p>,</span> <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>amount</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO outbox (topic, payload) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;payments&#39;</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ORDER CREATED (outbox)&#34;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;FAILED:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Outbox 워커: outbox 를 폴링하여 외부 결제 호출 및 처리 상태 업데이트</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17>17</a>
</span><span class=lnt id=hl-19-18><a class=lnlinks href=#hl-19-18>18</a>
</span><span class=lnt id=hl-19-19><a class=lnlinks href=#hl-19-19>19</a>
</span><span class=lnt id=hl-19-20><a class=lnlinks href=#hl-19-20>20</a>
</span><span class=lnt id=hl-19-21><a class=lnlinks href=#hl-19-21>21</a>
</span><span class=lnt id=hl-19-22><a class=lnlinks href=#hl-19-22>22</a>
</span><span class=lnt id=hl-19-23><a class=lnlinks href=#hl-19-23>23</a>
</span><span class=lnt id=hl-19-24><a class=lnlinks href=#hl-19-24>24</a>
</span><span class=lnt id=hl-19-25><a class=lnlinks href=#hl-19-25>25</a>
</span><span class=lnt id=hl-19-26><a class=lnlinks href=#hl-19-26>26</a>
</span><span class=lnt id=hl-19-27><a class=lnlinks href=#hl-19-27>27</a>
</span><span class=lnt id=hl-19-28><a class=lnlinks href=#hl-19-28>28</a>
</span><span class=lnt id=hl-19-29><a class=lnlinks href=#hl-19-29>29</a>
</span><span class=lnt id=hl-19-30><a class=lnlinks href=#hl-19-30>30</a>
</span><span class=lnt id=hl-19-31><a class=lnlinks href=#hl-19-31>31</a>
</span><span class=lnt id=hl-19-32><a class=lnlinks href=#hl-19-32>32</a>
</span><span class=lnt id=hl-19-33><a class=lnlinks href=#hl-19-33>33</a>
</span><span class=lnt id=hl-19-34><a class=lnlinks href=#hl-19-34>34</a>
</span><span class=lnt id=hl-19-35><a class=lnlinks href=#hl-19-35>35</a>
</span><span class=lnt id=hl-19-36><a class=lnlinks href=#hl-19-36>36</a>
</span><span class=lnt id=hl-19-37><a class=lnlinks href=#hl-19-37>37</a>
</span><span class=lnt id=hl-19-38><a class=lnlinks href=#hl-19-38>38</a>
</span><span class=lnt id=hl-19-39><a class=lnlinks href=#hl-19-39>39</a>
</span><span class=lnt id=hl-19-40><a class=lnlinks href=#hl-19-40>40</a>
</span><span class=lnt id=hl-19-41><a class=lnlinks href=#hl-19-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># file: outbox_worker.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=n>DSN</span> <span class=o>=</span> <span class=s2>&#34;dbname=test user=test password=test host=localhost port=5432&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PAYMENT_URL</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:5000/pay&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_outbox</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>DSN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 아직 처리되지 않은 outbox 항목 하나 선택 (간단한 구현)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT id, topic, payload FROM outbox WHERE processed = false ORDER BY id LIMIT 1 FOR UPDATE SKIP LOCKED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>outbox_id</span><span class=p>,</span> <span class=n>topic</span><span class=p>,</span> <span class=n>payload</span> <span class=o>=</span> <span class=n>row</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 외부 결제 호출 (재시도/아이덴포텐트는 생산환경에서 더 정교)</span>
</span></span><span class=line><span class=cl>            <span class=n>resp</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>PAYMENT_URL</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;order_id&#34;</span><span class=p>],</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;amount&#34;</span><span class=p>]},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;status&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;OK&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 결제 성공 기록: 트랜잭션 내에서 payments 테이블에 로그 추가하고 outbox 표기</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO payments (order_id, status, provider_tx_id) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;order_id&#34;</span><span class=p>],</span> <span class=s1>&#39;SUCCESS&#39;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;txid&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE orders SET status = </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;PAID&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;order_id&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE outbox SET processed = true, processed_at = now() WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>outbox_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Processed outbox&#34;</span><span class=p>,</span> <span class=n>outbox_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 실패: 보류하거나 retry logic 필요</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Payment failed for outbox&#34;</span><span class=p>,</span> <span class=n>outbox_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Worker exception:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>process_outbox</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>실행·검증</strong>:</p><ol><li><code>payment_mock.py</code> 실행—이때 지연을 길게 해도 핵심 트랜잭션 빠르게 커밋되는지 확인.</li><li>실행 순서:<ul><li><code>outbox_order.py</code> 로 주문 생성 (트랜잭션이 빠르게 끝나야 함)</li><li><code>outbox_worker.py</code> 가 outbox 를 읽어 결제 시도—결제 서비스가 느려도 <code>outbox_order</code> 의 커밋이 블로킹되지 않음.</li></ul></li><li>DB 확인:<ul><li><code>SELECT * FROM orders WHERE id = …;</code> (PENDING → PAID 로 변경되는지)</li><li><code>SELECT * FROM outbox WHERE processed = true;</code></li><li><code>SELECT * FROM payments;</code></li></ul></li></ol><p><strong>장점/검증 포인트</strong>:</p><ul><li>트랜잭션이 외부 지연에 묶이지 않음 → 락 유지 시간 단축, 동시성 향상.</li><li>outbox 워커의 재시도·아이덴포텐시 설계가 중요 (중복 결제 방지).</li></ul><h6 id=단계-3saga-패턴-오케스트레이션-기반-보상-트랜잭션-분산-일관성보상-구현>단계 3—Saga 패턴: <strong>오케스트레이션 기반 보상 트랜잭션</strong> (분산 일관성·보상 구현)<a hidden class=anchor aria-hidden=true href=#단계-3saga-패턴-오케스트레이션-기반-보상-트랜잭션-분산-일관성보상-구현>#</a></h6><ul><li>여러 참가 서비스 (예: 주문 서비스, 결제 서비스, 재고 서비스) 가 연속적으로 작업을 수행.</li><li>각 단계 실패 시 이전 단계들을 보상 (Compensating transaction) 하여 최종적으로 일관성 유지 (최종적 일관성).</li><li>보상은 명시적이며 각 서비스가 책임지고 구현.</li></ul><p><strong>시나리오</strong>:</p><ol><li>주문 생성 + 재고 예약</li><li>결제 시도</li><li>결제 성공 → 주문 확정</li><li>결제 실패 → 보상: 재고 해제, 주문 상태 취소, 필요 시 환불 호출 (이미 결제된 경우)</li></ol><p><strong>간단한 orchestrator (오케스트레이터) 구현 예</strong>:</p><ul><li>오케스트레이터가 각 서비스의 엔드포인트를 호출하고, 실패 시 보상 API 를 호출.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20>20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21>21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22>22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23>23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24>24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25>25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26>26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27>27</a>
</span><span class=lnt id=hl-20-28><a class=lnlinks href=#hl-20-28>28</a>
</span><span class=lnt id=hl-20-29><a class=lnlinks href=#hl-20-29>29</a>
</span><span class=lnt id=hl-20-30><a class=lnlinks href=#hl-20-30>30</a>
</span><span class=lnt id=hl-20-31><a class=lnlinks href=#hl-20-31>31</a>
</span><span class=lnt id=hl-20-32><a class=lnlinks href=#hl-20-32>32</a>
</span><span class=lnt id=hl-20-33><a class=lnlinks href=#hl-20-33>33</a>
</span><span class=lnt id=hl-20-34><a class=lnlinks href=#hl-20-34>34</a>
</span><span class=lnt id=hl-20-35><a class=lnlinks href=#hl-20-35>35</a>
</span><span class=lnt id=hl-20-36><a class=lnlinks href=#hl-20-36>36</a>
</span><span class=lnt id=hl-20-37><a class=lnlinks href=#hl-20-37>37</a>
</span><span class=lnt id=hl-20-38><a class=lnlinks href=#hl-20-38>38</a>
</span><span class=lnt id=hl-20-39><a class=lnlinks href=#hl-20-39>39</a>
</span><span class=lnt id=hl-20-40><a class=lnlinks href=#hl-20-40>40</a>
</span><span class=lnt id=hl-20-41><a class=lnlinks href=#hl-20-41>41</a>
</span><span class=lnt id=hl-20-42><a class=lnlinks href=#hl-20-42>42</a>
</span><span class=lnt id=hl-20-43><a class=lnlinks href=#hl-20-43>43</a>
</span><span class=lnt id=hl-20-44><a class=lnlinks href=#hl-20-44>44</a>
</span><span class=lnt id=hl-20-45><a class=lnlinks href=#hl-20-45>45</a>
</span><span class=lnt id=hl-20-46><a class=lnlinks href=#hl-20-46>46</a>
</span><span class=lnt id=hl-20-47><a class=lnlinks href=#hl-20-47>47</a>
</span><span class=lnt id=hl-20-48><a class=lnlinks href=#hl-20-48>48</a>
</span><span class=lnt id=hl-20-49><a class=lnlinks href=#hl-20-49>49</a>
</span><span class=lnt id=hl-20-50><a class=lnlinks href=#hl-20-50>50</a>
</span><span class=lnt id=hl-20-51><a class=lnlinks href=#hl-20-51>51</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># file: saga_orchestrator.py</span>
</span></span><span class=line><span class=cl><span class=c1># pip install requests psycopg2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span><span class=o>,</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DSN</span> <span class=o>=</span> <span class=s2>&#34;dbname=test user=test password=test host=localhost port=5432&#34;</span>
</span></span><span class=line><span class=cl><span class=n>INVENTORY_SERVICE</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:5001&#34;</span>   <span class=c1># 가상의 서비스 엔드포인트</span>
</span></span><span class=line><span class=cl><span class=n>PAYMENT_SERVICE</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:5000&#34;</span>     <span class=c1># 결제 모킹</span>
</span></span><span class=line><span class=cl><span class=n>ORDER_SERVICE</span> <span class=o>=</span> <span class=s2>&#34;http://localhost:5002&#34;</span>       <span class=c1># 주문 서비스 (또는 DB 직접 조작)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>orchestrate_order</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1) 주문 생성(로컬 DB에서) - or local service</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>DSN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO orders (user_id, total, status) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>) RETURNING id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>,</span> <span class=s1>&#39;PENDING&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 재고 예약 (단순 예: inventory 서비스 호출 대신 DB 업데이트)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE inventory SET qty = qty - </span><span class=si>%s</span><span class=s2> WHERE sku = </span><span class=si>%s</span><span class=s2> AND qty &gt;= </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>qty</span><span class=p>,</span> <span class=n>sku</span><span class=p>,</span> <span class=n>qty</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cur</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;OUT_OF_STOCK&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Initial order failed:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2) 결제 시도 (외부 서비스 호출)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>PAYMENT_SERVICE</span> <span class=o>+</span> <span class=s2>&#34;/pay&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>amount</span><span class=p>)},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;status&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;OK&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 결제 성공 -&gt; 주문 상태 확정</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>DSN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO payments (order_id, status, provider_tx_id) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;SUCCESS&#39;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;txid&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE orders SET status = </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;CONFIRMED&#39;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Order confirmed&#34;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Payment failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Payment failed, running compensation:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 보상: 재고 복구, 주문 취소</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>DSN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE inventory SET qty = qty + </span><span class=si>%s</span><span class=s2> WHERE sku = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>qty</span><span class=p>,</span> <span class=n>sku</span><span class=p>))</span>  <span class=c1># 보상</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE orders SET status = </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;CANCELLED&#39;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Compensation done for order&#34;</span><span class=p>,</span> <span class=n>order_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>보상 (Compensation) 핵심원칙</strong>:</p><ul><li>각 참가 작업 (예약, 결제 등) 은 자신만의 보상 작업을 명확히 구현해야 함.</li><li>보상도 실패할 수 있으므로 재시도와 운영적 수동개입 (runbook) 필요.</li><li>오케스트레이터 장애/중단에 대비해 상태 저장 (예: saga state table) 이 필요.</li></ul><p><strong>실행·검증 시나리오</strong>:</p><ol><li>정상 흐름: <code>payment_mock</code> 이 OK → 주문 <code>CONFIRMED</code>, payments 로그 <code>SUCCESS</code>, inventory 감소 상태 유지.</li><li>결제 지연/실패 흐름 (시나리오):<ul><li><code>payment_mock</code> 을 지연 또는 실패로 설정 → orchestrator 가 실패 감지 → 보상 실행 (재고 복구, 주문 CANCELLED)</li><li>DB 상태 확인:<ul><li><code>orders.status</code> == <code>CANCELLED</code></li><li><code>inventory.qty</code> 원복</li><li><code>payments</code> 에 실패 로그 (선택적)</li></ul></li></ul></li><li>오케스트레이터 장애 흐름:<ul><li>오케스트레이터 프로세스가 중단되는 경우 saga 상태 테이블이 있어야 재시작 시 미완료 saga 복구 가능 (예: 주기적 체크·타임아웃 후 보상).</li></ul></li></ol><p><strong>참고: Saga 상태 테이블 (권장)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3>3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4>4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5>5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6>6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>saga</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>SERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>order_id</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>state</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>        </span><span class=c1>-- STARTED, PAYMENT_PENDING, CONFIRMED, COMPENSATING, COMPLETED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>  </span><span class=n>payload</span><span class=w> </span><span class=n>JSONB</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>updated_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>오케스트레이터는 각 단계 완료/실패 시 saga 테이블을 갱신해 재시작/모니터링이 가능하게 한다.</li></ul><h6 id=비교-세-방식의-실패-시-상태-변화-요약>비교: 세 방식의 실패 시 상태 변화 (요약)<a hidden class=anchor aria-hidden=true href=#비교-세-방식의-실패-시-상태-변화-요약>#</a></h6><ol><li><strong>단일 TX + 외부 호출 (안티패턴)</strong><ul><li>외부 지연: DB 락 장기 보유 → 동시성 저하</li><li>외부 실패: 트랜잭션 롤백 → 외부 호출은 이미 수행됐을 경우 (타이밍에 따라) 상태 불일치 발생 가능</li><li>운영 부담: 데드락·타임아웃·수동 조치</li></ul></li><li><strong>Outbox 패턴</strong><ul><li>외부 지연: 주문 생성/재고 차감이 빠르게 커밋 → 사용자 경험 향상</li><li>외부 실패: 워커가 재시도, 기본적으로 idempotency 필요 → 중복 방지 설계 필요</li><li>운영 부담: outbox 처리 안정성 (폴링/처리 병렬성)·모니터링 필요</li></ul></li><li><strong>Saga 패턴 (오케스트레이션)</strong><ul><li>외부 실패: 각 단계별 보상 수행 → 최종적 일관성 보장 (강한 원자성 아님)</li><li>운영 부담: 각 보상 로직 구현·보상 실패 시 수동 개입/재시도 정책 필요</li><li>적합성: 마이크로서비스형 분산 환경에서 현실적인 방법</li></ul></li></ol><h6 id=결론-핵심-포인트>결론 (핵심 포인트)<a hidden class=anchor aria-hidden=true href=#결론-핵심-포인트>#</a></h6><ul><li><p><strong>단일 TX 에 외부 호출 포함은 프로덕션에서 피해야 할 대표적 안티패턴</strong>(락 유지→동시성 붕괴).</p></li><li><p><strong>Outbox 패턴은 트랜잭션 경계를 분리하면서도 메시지 내구성을 보장</strong>해 실무에서 널리 쓰이는 개선책. 워커의 재시도·아이덴포텐시 설계가 핵심.</p></li><li><p><strong>Saga 패턴은 분산 환경에서 보상 로직으로 일관성을 유지하는 현실적 선택</strong>이지만, 보상 설계·운영 부담이 증가하므로 도메인에 맞는 트레이드오프 평가 필요.</p></li></ul><h3 id=실무-적용-및-사례>실무 적용 및 사례<a hidden class=anchor aria-hidden=true href=#실무-적용-및-사례>#</a></h3><h4 id=실습-예제-및-코드-구현>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현>#</a></h4><h5 id=실습-예제-postgresql--python-재시도-가능한-트랜잭션>실습 예제: PostgreSQL + Python 재시도 가능한 트랜잭션<a hidden class=anchor aria-hidden=true href=#실습-예제-postgresql--python-재시도-가능한-트랜잭션>#</a></h5><h6 id=목적>목적<a hidden class=anchor aria-hidden=true href=#목적>#</a></h6><ul><li>직렬화 격리에서 발생하는 재시도 (SerializationFailure) 처리 패턴 학습</li></ul><h6 id=사전-요구사항>사전 요구사항<a hidden class=anchor aria-hidden=true href=#사전-요구사항>#</a></h6><ul><li>Python 3.11+, psycopg[binary] 3.x, PostgreSQL 14+</li></ul><h6 id=단계별-구현>단계별 구현<a hidden class=anchor aria-hidden=true href=#단계별-구현>#</a></h6><ol><li><p>환경 준비</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 로컬 도커 예시</span>
</span></span><span class=line><span class=cl>docker run --name pg -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>pass -p 5432:5432 -d postgres:16
</span></span></code></pre></td></tr></table></div></div></li><li><p>파이썬 코드 (재시도 래퍼)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20>20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21>21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22>22</a>
</span><span class=lnt id=hl-23-23><a class=lnlinks href=#hl-23-23>23</a>
</span><span class=lnt id=hl-23-24><a class=lnlinks href=#hl-23-24>24</a>
</span><span class=lnt id=hl-23-25><a class=lnlinks href=#hl-23-25>25</a>
</span><span class=lnt id=hl-23-26><a class=lnlinks href=#hl-23-26>26</a>
</span><span class=lnt id=hl-23-27><a class=lnlinks href=#hl-23-27>27</a>
</span><span class=lnt id=hl-23-28><a class=lnlinks href=#hl-23-28>28</a>
</span><span class=lnt id=hl-23-29><a class=lnlinks href=#hl-23-29>29</a>
</span><span class=lnt id=hl-23-30><a class=lnlinks href=#hl-23-30>30</a>
</span><span class=lnt id=hl-23-31><a class=lnlinks href=#hl-23-31>31</a>
</span><span class=lnt id=hl-23-32><a class=lnlinks href=#hl-23-32>32</a>
</span><span class=lnt id=hl-23-33><a class=lnlinks href=#hl-23-33>33</a>
</span><span class=lnt id=hl-23-34><a class=lnlinks href=#hl-23-34>34</a>
</span><span class=lnt id=hl-23-35><a class=lnlinks href=#hl-23-35>35</a>
</span><span class=lnt id=hl-23-36><a class=lnlinks href=#hl-23-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 트랜잭션 라이프사이클: BEGIN→작업→WAL→COMMIT. 직렬화 충돌 시 재시도.</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>psycopg.errors</span> <span class=kn>import</span> <span class=n>SerializationFailure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MAX_RETRIES</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_tx</span><span class=p>(</span><span class=n>op</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>attempt</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>psycopg</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;dbname=postgres user=postgres password=pass host=localhost&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 직렬화 격리 수준 설정</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=n>conn</span><span class=o>.</span><span class=n>transaction</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                    <span class=n>op</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>  <span class=c1># 비즈니스 작업 실행</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>  <span class=c1># 커밋 성공 시 종료</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>SerializationFailure</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>attempt</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>attempt</span> <span class=o>&gt;</span> <span class=n>MAX_RETRIES</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span> <span class=o>*</span> <span class=n>attempt</span><span class=p>)</span>  <span class=c1># 지수 백오프 전 단순 백오프</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 예시 비즈니스 로직: 잔액 이체 (단순화)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transfer</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>from_id</span><span class=p>,</span> <span class=n>to_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 읽기: 스냅샷 기반, 쓰기 전 검증 의도적</span>
</span></span><span class=line><span class=cl>    <span class=n>bal</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT balance FROM acct WHERE id=</span><span class=si>%s</span><span class=s2> FOR UPDATE&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>from_id</span><span class=p>,))</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>bal</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>,</span> <span class=s2>&#34;잔액 부족&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE acct SET balance = balance - </span><span class=si>%s</span><span class=s2> WHERE id=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>amount</span><span class=p>,</span> <span class=n>from_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE acct SET balance = balance + </span><span class=si>%s</span><span class=s2> WHERE id=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>amount</span><span class=p>,</span> <span class=n>to_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 실행</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>op</span><span class=p>(</span><span class=n>conn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>transfer</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>run_tx</span><span class=p>(</span><span class=n>op</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h5 id=실습-예제-은행-계좌-이체-트랜잭션-구현>실습 예제: 은행 계좌 이체 트랜잭션 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-은행-계좌-이체-트랜잭션-구현>#</a></h5><h6 id=목적-1>목적<a hidden class=anchor aria-hidden=true href=#목적-1>#</a></h6><ul><li>트랜잭션 생명주기의 전 과정을 실제 코드로 구현</li><li>ACID 속성이 어떻게 보장되는지 실습</li><li>예외 상황에서의 롤백 메커니즘 이해</li></ul><h6 id=사전-요구사항-1>사전 요구사항<a hidden class=anchor aria-hidden=true href=#사전-요구사항-1>#</a></h6><ul><li>Python 3.8+</li><li>SQLite 3 또는 PostgreSQL</li><li>psycopg2 또는 sqlite3 라이브러리</li></ul><h6 id=단계별-구현-1>단계별 구현<a hidden class=anchor aria-hidden=true href=#단계별-구현-1>#</a></h6><ol><li><p><strong>1 단계: 데이터베이스 초기 설정</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1> 1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2> 2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3> 3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4> 4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5> 5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6> 6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7> 7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8> 8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9> 9</a>
</span><span class=lnt id=hl-24-10><a class=lnlinks href=#hl-24-10>10</a>
</span><span class=lnt id=hl-24-11><a class=lnlinks href=#hl-24-11>11</a>
</span><span class=lnt id=hl-24-12><a class=lnlinks href=#hl-24-12>12</a>
</span><span class=lnt id=hl-24-13><a class=lnlinks href=#hl-24-13>13</a>
</span><span class=lnt id=hl-24-14><a class=lnlinks href=#hl-24-14>14</a>
</span><span class=lnt id=hl-24-15><a class=lnlinks href=#hl-24-15>15</a>
</span><span class=lnt id=hl-24-16><a class=lnlinks href=#hl-24-16>16</a>
</span><span class=lnt id=hl-24-17><a class=lnlinks href=#hl-24-17>17</a>
</span><span class=lnt id=hl-24-18><a class=lnlinks href=#hl-24-18>18</a>
</span><span class=lnt id=hl-24-19><a class=lnlinks href=#hl-24-19>19</a>
</span><span class=lnt id=hl-24-20><a class=lnlinks href=#hl-24-20>20</a>
</span><span class=lnt id=hl-24-21><a class=lnlinks href=#hl-24-21>21</a>
</span><span class=lnt id=hl-24-22><a class=lnlinks href=#hl-24-22>22</a>
</span><span class=lnt id=hl-24-23><a class=lnlinks href=#hl-24-23>23</a>
</span><span class=lnt id=hl-24-24><a class=lnlinks href=#hl-24-24>24</a>
</span><span class=lnt id=hl-24-25><a class=lnlinks href=#hl-24-25>25</a>
</span><span class=lnt id=hl-24-26><a class=lnlinks href=#hl-24-26>26</a>
</span><span class=lnt id=hl-24-27><a class=lnlinks href=#hl-24-27>27</a>
</span><span class=lnt id=hl-24-28><a class=lnlinks href=#hl-24-28>28</a>
</span><span class=lnt id=hl-24-29><a class=lnlinks href=#hl-24-29>29</a>
</span><span class=lnt id=hl-24-30><a class=lnlinks href=#hl-24-30>30</a>
</span><span class=lnt id=hl-24-31><a class=lnlinks href=#hl-24-31>31</a>
</span><span class=lnt id=hl-24-32><a class=lnlinks href=#hl-24-32>32</a>
</span><span class=lnt id=hl-24-33><a class=lnlinks href=#hl-24-33>33</a>
</span><span class=lnt id=hl-24-34><a class=lnlinks href=#hl-24-34>34</a>
</span><span class=lnt id=hl-24-35><a class=lnlinks href=#hl-24-35>35</a>
</span><span class=lnt id=hl-24-36><a class=lnlinks href=#hl-24-36>36</a>
</span><span class=lnt id=hl-24-37><a class=lnlinks href=#hl-24-37>37</a>
</span><span class=lnt id=hl-24-38><a class=lnlinks href=#hl-24-38>38</a>
</span><span class=lnt id=hl-24-39><a class=lnlinks href=#hl-24-39>39</a>
</span><span class=lnt id=hl-24-40><a class=lnlinks href=#hl-24-40>40</a>
</span><span class=lnt id=hl-24-41><a class=lnlinks href=#hl-24-41>41</a>
</span><span class=lnt id=hl-24-42><a class=lnlinks href=#hl-24-42>42</a>
</span><span class=lnt id=hl-24-43><a class=lnlinks href=#hl-24-43>43</a>
</span><span class=lnt id=hl-24-44><a class=lnlinks href=#hl-24-44>44</a>
</span><span class=lnt id=hl-24-45><a class=lnlinks href=#hl-24-45>45</a>
</span><span class=lnt id=hl-24-46><a class=lnlinks href=#hl-24-46>46</a>
</span><span class=lnt id=hl-24-47><a class=lnlinks href=#hl-24-47>47</a>
</span><span class=lnt id=hl-24-48><a class=lnlinks href=#hl-24-48>48</a>
</span><span class=lnt id=hl-24-49><a class=lnlinks href=#hl-24-49>49</a>
</span><span class=lnt id=hl-24-50><a class=lnlinks href=#hl-24-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sqlite3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TransactionState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;트랜잭션 상태를 나타내는 열거형&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ACTIVE</span> <span class=o>=</span> <span class=s2>&#34;ACTIVE&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>PARTIALLY_COMMITTED</span> <span class=o>=</span> <span class=s2>&#34;PARTIALLY_COMMITTED&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>COMMITTED</span> <span class=o>=</span> <span class=s2>&#34;COMMITTED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FAILED</span> <span class=o>=</span> <span class=s2>&#34;FAILED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ABORTED</span> <span class=o>=</span> <span class=s2>&#34;ABORTED&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 데이터베이스 초기화 및 테이블 생성</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>initialize_database</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;은행 계좌와 트랜잭션 로그 테이블을 생성&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;bank.db&#39;</span><span class=p>,</span> <span class=n>check_same_thread</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 계좌 테이블 생성 (잔액과 버전 정보 포함)</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>        CREATE TABLE IF NOT EXISTS accounts (
</span></span></span><span class=line><span class=cl><span class=s1>            account_id INTEGER PRIMARY KEY,
</span></span></span><span class=line><span class=cl><span class=s1>            balance DECIMAL(10,2) NOT NULL CHECK(balance &gt;= 0),
</span></span></span><span class=line><span class=cl><span class=s1>            version INTEGER DEFAULT 0,
</span></span></span><span class=line><span class=cl><span class=s1>            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
</span></span></span><span class=line><span class=cl><span class=s1>        )
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 트랜잭션 로그 테이블 생성 (WAL 구현)</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>        CREATE TABLE IF NOT EXISTS transaction_log (
</span></span></span><span class=line><span class=cl><span class=s1>            log_id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class=line><span class=cl><span class=s1>            transaction_id TEXT NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>            operation_type TEXT NOT NULL, -- INSERT, UPDATE, DELETE
</span></span></span><span class=line><span class=cl><span class=s1>            table_name TEXT NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s1>            old_value TEXT,
</span></span></span><span class=line><span class=cl><span class=s1>            new_value TEXT,
</span></span></span><span class=line><span class=cl><span class=s1>            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
</span></span></span><span class=line><span class=cl><span class=s1>        )
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 초기 계좌 데이터 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;INSERT OR REPLACE INTO accounts (account_id, balance) VALUES (1, 1000.00)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;INSERT OR REPLACE INTO accounts (account_id, balance) VALUES (2, 500.00)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>2 단계: 트랜잭션 관리자 구현</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1>  1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2>  2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3>  3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4>  4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5>  5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6>  6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7>  7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8>  8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9>  9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10> 10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11> 11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12> 12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13> 13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14> 14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15> 15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16> 16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17> 17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18> 18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19> 19</a>
</span><span class=lnt id=hl-25-20><a class=lnlinks href=#hl-25-20> 20</a>
</span><span class=lnt id=hl-25-21><a class=lnlinks href=#hl-25-21> 21</a>
</span><span class=lnt id=hl-25-22><a class=lnlinks href=#hl-25-22> 22</a>
</span><span class=lnt id=hl-25-23><a class=lnlinks href=#hl-25-23> 23</a>
</span><span class=lnt id=hl-25-24><a class=lnlinks href=#hl-25-24> 24</a>
</span><span class=lnt id=hl-25-25><a class=lnlinks href=#hl-25-25> 25</a>
</span><span class=lnt id=hl-25-26><a class=lnlinks href=#hl-25-26> 26</a>
</span><span class=lnt id=hl-25-27><a class=lnlinks href=#hl-25-27> 27</a>
</span><span class=lnt id=hl-25-28><a class=lnlinks href=#hl-25-28> 28</a>
</span><span class=lnt id=hl-25-29><a class=lnlinks href=#hl-25-29> 29</a>
</span><span class=lnt id=hl-25-30><a class=lnlinks href=#hl-25-30> 30</a>
</span><span class=lnt id=hl-25-31><a class=lnlinks href=#hl-25-31> 31</a>
</span><span class=lnt id=hl-25-32><a class=lnlinks href=#hl-25-32> 32</a>
</span><span class=lnt id=hl-25-33><a class=lnlinks href=#hl-25-33> 33</a>
</span><span class=lnt id=hl-25-34><a class=lnlinks href=#hl-25-34> 34</a>
</span><span class=lnt id=hl-25-35><a class=lnlinks href=#hl-25-35> 35</a>
</span><span class=lnt id=hl-25-36><a class=lnlinks href=#hl-25-36> 36</a>
</span><span class=lnt id=hl-25-37><a class=lnlinks href=#hl-25-37> 37</a>
</span><span class=lnt id=hl-25-38><a class=lnlinks href=#hl-25-38> 38</a>
</span><span class=lnt id=hl-25-39><a class=lnlinks href=#hl-25-39> 39</a>
</span><span class=lnt id=hl-25-40><a class=lnlinks href=#hl-25-40> 40</a>
</span><span class=lnt id=hl-25-41><a class=lnlinks href=#hl-25-41> 41</a>
</span><span class=lnt id=hl-25-42><a class=lnlinks href=#hl-25-42> 42</a>
</span><span class=lnt id=hl-25-43><a class=lnlinks href=#hl-25-43> 43</a>
</span><span class=lnt id=hl-25-44><a class=lnlinks href=#hl-25-44> 44</a>
</span><span class=lnt id=hl-25-45><a class=lnlinks href=#hl-25-45> 45</a>
</span><span class=lnt id=hl-25-46><a class=lnlinks href=#hl-25-46> 46</a>
</span><span class=lnt id=hl-25-47><a class=lnlinks href=#hl-25-47> 47</a>
</span><span class=lnt id=hl-25-48><a class=lnlinks href=#hl-25-48> 48</a>
</span><span class=lnt id=hl-25-49><a class=lnlinks href=#hl-25-49> 49</a>
</span><span class=lnt id=hl-25-50><a class=lnlinks href=#hl-25-50> 50</a>
</span><span class=lnt id=hl-25-51><a class=lnlinks href=#hl-25-51> 51</a>
</span><span class=lnt id=hl-25-52><a class=lnlinks href=#hl-25-52> 52</a>
</span><span class=lnt id=hl-25-53><a class=lnlinks href=#hl-25-53> 53</a>
</span><span class=lnt id=hl-25-54><a class=lnlinks href=#hl-25-54> 54</a>
</span><span class=lnt id=hl-25-55><a class=lnlinks href=#hl-25-55> 55</a>
</span><span class=lnt id=hl-25-56><a class=lnlinks href=#hl-25-56> 56</a>
</span><span class=lnt id=hl-25-57><a class=lnlinks href=#hl-25-57> 57</a>
</span><span class=lnt id=hl-25-58><a class=lnlinks href=#hl-25-58> 58</a>
</span><span class=lnt id=hl-25-59><a class=lnlinks href=#hl-25-59> 59</a>
</span><span class=lnt id=hl-25-60><a class=lnlinks href=#hl-25-60> 60</a>
</span><span class=lnt id=hl-25-61><a class=lnlinks href=#hl-25-61> 61</a>
</span><span class=lnt id=hl-25-62><a class=lnlinks href=#hl-25-62> 62</a>
</span><span class=lnt id=hl-25-63><a class=lnlinks href=#hl-25-63> 63</a>
</span><span class=lnt id=hl-25-64><a class=lnlinks href=#hl-25-64> 64</a>
</span><span class=lnt id=hl-25-65><a class=lnlinks href=#hl-25-65> 65</a>
</span><span class=lnt id=hl-25-66><a class=lnlinks href=#hl-25-66> 66</a>
</span><span class=lnt id=hl-25-67><a class=lnlinks href=#hl-25-67> 67</a>
</span><span class=lnt id=hl-25-68><a class=lnlinks href=#hl-25-68> 68</a>
</span><span class=lnt id=hl-25-69><a class=lnlinks href=#hl-25-69> 69</a>
</span><span class=lnt id=hl-25-70><a class=lnlinks href=#hl-25-70> 70</a>
</span><span class=lnt id=hl-25-71><a class=lnlinks href=#hl-25-71> 71</a>
</span><span class=lnt id=hl-25-72><a class=lnlinks href=#hl-25-72> 72</a>
</span><span class=lnt id=hl-25-73><a class=lnlinks href=#hl-25-73> 73</a>
</span><span class=lnt id=hl-25-74><a class=lnlinks href=#hl-25-74> 74</a>
</span><span class=lnt id=hl-25-75><a class=lnlinks href=#hl-25-75> 75</a>
</span><span class=lnt id=hl-25-76><a class=lnlinks href=#hl-25-76> 76</a>
</span><span class=lnt id=hl-25-77><a class=lnlinks href=#hl-25-77> 77</a>
</span><span class=lnt id=hl-25-78><a class=lnlinks href=#hl-25-78> 78</a>
</span><span class=lnt id=hl-25-79><a class=lnlinks href=#hl-25-79> 79</a>
</span><span class=lnt id=hl-25-80><a class=lnlinks href=#hl-25-80> 80</a>
</span><span class=lnt id=hl-25-81><a class=lnlinks href=#hl-25-81> 81</a>
</span><span class=lnt id=hl-25-82><a class=lnlinks href=#hl-25-82> 82</a>
</span><span class=lnt id=hl-25-83><a class=lnlinks href=#hl-25-83> 83</a>
</span><span class=lnt id=hl-25-84><a class=lnlinks href=#hl-25-84> 84</a>
</span><span class=lnt id=hl-25-85><a class=lnlinks href=#hl-25-85> 85</a>
</span><span class=lnt id=hl-25-86><a class=lnlinks href=#hl-25-86> 86</a>
</span><span class=lnt id=hl-25-87><a class=lnlinks href=#hl-25-87> 87</a>
</span><span class=lnt id=hl-25-88><a class=lnlinks href=#hl-25-88> 88</a>
</span><span class=lnt id=hl-25-89><a class=lnlinks href=#hl-25-89> 89</a>
</span><span class=lnt id=hl-25-90><a class=lnlinks href=#hl-25-90> 90</a>
</span><span class=lnt id=hl-25-91><a class=lnlinks href=#hl-25-91> 91</a>
</span><span class=lnt id=hl-25-92><a class=lnlinks href=#hl-25-92> 92</a>
</span><span class=lnt id=hl-25-93><a class=lnlinks href=#hl-25-93> 93</a>
</span><span class=lnt id=hl-25-94><a class=lnlinks href=#hl-25-94> 94</a>
</span><span class=lnt id=hl-25-95><a class=lnlinks href=#hl-25-95> 95</a>
</span><span class=lnt id=hl-25-96><a class=lnlinks href=#hl-25-96> 96</a>
</span><span class=lnt id=hl-25-97><a class=lnlinks href=#hl-25-97> 97</a>
</span><span class=lnt id=hl-25-98><a class=lnlinks href=#hl-25-98> 98</a>
</span><span class=lnt id=hl-25-99><a class=lnlinks href=#hl-25-99> 99</a>
</span><span class=lnt id=hl-25-100><a class=lnlinks href=#hl-25-100>100</a>
</span><span class=lnt id=hl-25-101><a class=lnlinks href=#hl-25-101>101</a>
</span><span class=lnt id=hl-25-102><a class=lnlinks href=#hl-25-102>102</a>
</span><span class=lnt id=hl-25-103><a class=lnlinks href=#hl-25-103>103</a>
</span><span class=lnt id=hl-25-104><a class=lnlinks href=#hl-25-104>104</a>
</span><span class=lnt id=hl-25-105><a class=lnlinks href=#hl-25-105>105</a>
</span><span class=lnt id=hl-25-106><a class=lnlinks href=#hl-25-106>106</a>
</span><span class=lnt id=hl-25-107><a class=lnlinks href=#hl-25-107>107</a>
</span><span class=lnt id=hl-25-108><a class=lnlinks href=#hl-25-108>108</a>
</span><span class=lnt id=hl-25-109><a class=lnlinks href=#hl-25-109>109</a>
</span><span class=lnt id=hl-25-110><a class=lnlinks href=#hl-25-110>110</a>
</span><span class=lnt id=hl-25-111><a class=lnlinks href=#hl-25-111>111</a>
</span><span class=lnt id=hl-25-112><a class=lnlinks href=#hl-25-112>112</a>
</span><span class=lnt id=hl-25-113><a class=lnlinks href=#hl-25-113>113</a>
</span><span class=lnt id=hl-25-114><a class=lnlinks href=#hl-25-114>114</a>
</span><span class=lnt id=hl-25-115><a class=lnlinks href=#hl-25-115>115</a>
</span><span class=lnt id=hl-25-116><a class=lnlinks href=#hl-25-116>116</a>
</span><span class=lnt id=hl-25-117><a class=lnlinks href=#hl-25-117>117</a>
</span><span class=lnt id=hl-25-118><a class=lnlinks href=#hl-25-118>118</a>
</span><span class=lnt id=hl-25-119><a class=lnlinks href=#hl-25-119>119</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>TransactionManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;트랜잭션 생명주기를 관리하는 핵심 클래스&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db_path</span><span class=o>=</span><span class=s1>&#39;bank.db&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db_path</span> <span class=o>=</span> <span class=n>db_path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 활성 트랜잭션 추적</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>RLock</span><span class=p>()</span>  <span class=c1># 스레드 안전성 보장</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_transaction_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;고유한 트랜잭션 ID 생성&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;TXN_</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>threading</span><span class=o>.</span><span class=n>get_ident</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>isolation_level</span><span class=o>=</span><span class=s2>&#34;IMMEDIATE&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;트랜잭션 컨텍스트 매니저 - 생명주기 자동 관리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>transaction_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_transaction_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Phase 1: 트랜잭션 시작 (ACTIVE 상태)</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>db_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;BEGIN </span><span class=si>{</span><span class=n>isolation_level</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;state&#39;</span><span class=p>:</span> <span class=n>TransactionState</span><span class=o>.</span><span class=n>ACTIVE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;start_time&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;operations&#39;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Transaction started - State: ACTIVE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 트랜잭션 실행 컨텍스트 제공</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>TransactionContext</span><span class=p>(</span><span class=n>transaction_id</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Phase 2: 부분 커밋 상태 (PARTIALLY_COMMITTED)</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>][</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>TransactionState</span><span class=o>.</span><span class=n>PARTIALLY_COMMITTED</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Entering PARTIALLY_COMMITTED state&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 제약조건 검증 및 최종 커밋 결정</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_validate_constraints</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Phase 3: 최종 커밋 (COMMITTED)</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>][</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>TransactionState</span><span class=o>.</span><span class=n>COMMITTED</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>][</span><span class=s1>&#39;end_time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Transaction committed - State: COMMITTED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Phase 4: 실패 및 롤백 처리 (FAILED -&gt; ABORTED)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>transaction_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>][</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>TransactionState</span><span class=o>.</span><span class=n>FAILED</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Transaction failed - State: FAILED, Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>][</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>TransactionState</span><span class=o>.</span><span class=n>ABORTED</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>active_transactions</span><span class=p>[</span><span class=n>transaction_id</span><span class=p>][</span><span class=s1>&#39;end_time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Transaction aborted - State: ABORTED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_validate_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;비즈니스 제약조건 검증 (일관성 체크)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 음수 잔액 체크</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;SELECT account_id, balance FROM accounts WHERE balance &lt; 0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>negative_accounts</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>negative_accounts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Constraint violation: Negative balance detected in accounts: </span><span class=si>{</span><span class=n>negative_accounts</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_operation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>,</span> <span class=n>operation_type</span><span class=p>,</span> <span class=n>table_name</span><span class=p>,</span> <span class=n>old_value</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>new_value</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;WAL 구현 - 모든 연산을 로그에 기록&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>            INSERT INTO transaction_log (transaction_id, operation_type, table_name, old_value, new_value)
</span></span></span><span class=line><span class=cl><span class=s1>            VALUES (?, ?, ?, ?, ?)
</span></span></span><span class=line><span class=cl><span class=s1>        &#39;&#39;&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>transaction_id</span><span class=p>,</span> <span class=n>operation_type</span><span class=p>,</span> <span class=n>table_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>old_value</span><span class=p>),</span> <span class=nb>str</span><span class=p>(</span><span class=n>new_value</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TransactionContext</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;트랜잭션 실행 컨텍스트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>,</span> <span class=n>connection</span><span class=p>,</span> <span class=n>manager</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>transaction_id</span> <span class=o>=</span> <span class=n>transaction_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=n>connection</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>manager</span> <span class=o>=</span> <span class=n>manager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_with_log</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>log_info</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;로깅과 함께 SQL 실행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>params</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 연산 로그 기록 (WAL)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>log_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>manager</span><span class=o>.</span><span class=n>log_operation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>transaction_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>log_info</span><span class=p>[</span><span class=s1>&#39;operation&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>log_info</span><span class=p>[</span><span class=s1>&#39;table&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>log_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;old_value&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>log_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;new_value&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>cursor</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>3 단계: 계좌 이체 비즈니스 로직 구현</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>  1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2>  2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3>  3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4>  4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5>  5</a>
</span><span class=lnt id=hl-26-6><a class=lnlinks href=#hl-26-6>  6</a>
</span><span class=lnt id=hl-26-7><a class=lnlinks href=#hl-26-7>  7</a>
</span><span class=lnt id=hl-26-8><a class=lnlinks href=#hl-26-8>  8</a>
</span><span class=lnt id=hl-26-9><a class=lnlinks href=#hl-26-9>  9</a>
</span><span class=lnt id=hl-26-10><a class=lnlinks href=#hl-26-10> 10</a>
</span><span class=lnt id=hl-26-11><a class=lnlinks href=#hl-26-11> 11</a>
</span><span class=lnt id=hl-26-12><a class=lnlinks href=#hl-26-12> 12</a>
</span><span class=lnt id=hl-26-13><a class=lnlinks href=#hl-26-13> 13</a>
</span><span class=lnt id=hl-26-14><a class=lnlinks href=#hl-26-14> 14</a>
</span><span class=lnt id=hl-26-15><a class=lnlinks href=#hl-26-15> 15</a>
</span><span class=lnt id=hl-26-16><a class=lnlinks href=#hl-26-16> 16</a>
</span><span class=lnt id=hl-26-17><a class=lnlinks href=#hl-26-17> 17</a>
</span><span class=lnt id=hl-26-18><a class=lnlinks href=#hl-26-18> 18</a>
</span><span class=lnt id=hl-26-19><a class=lnlinks href=#hl-26-19> 19</a>
</span><span class=lnt id=hl-26-20><a class=lnlinks href=#hl-26-20> 20</a>
</span><span class=lnt id=hl-26-21><a class=lnlinks href=#hl-26-21> 21</a>
</span><span class=lnt id=hl-26-22><a class=lnlinks href=#hl-26-22> 22</a>
</span><span class=lnt id=hl-26-23><a class=lnlinks href=#hl-26-23> 23</a>
</span><span class=lnt id=hl-26-24><a class=lnlinks href=#hl-26-24> 24</a>
</span><span class=lnt id=hl-26-25><a class=lnlinks href=#hl-26-25> 25</a>
</span><span class=lnt id=hl-26-26><a class=lnlinks href=#hl-26-26> 26</a>
</span><span class=lnt id=hl-26-27><a class=lnlinks href=#hl-26-27> 27</a>
</span><span class=lnt id=hl-26-28><a class=lnlinks href=#hl-26-28> 28</a>
</span><span class=lnt id=hl-26-29><a class=lnlinks href=#hl-26-29> 29</a>
</span><span class=lnt id=hl-26-30><a class=lnlinks href=#hl-26-30> 30</a>
</span><span class=lnt id=hl-26-31><a class=lnlinks href=#hl-26-31> 31</a>
</span><span class=lnt id=hl-26-32><a class=lnlinks href=#hl-26-32> 32</a>
</span><span class=lnt id=hl-26-33><a class=lnlinks href=#hl-26-33> 33</a>
</span><span class=lnt id=hl-26-34><a class=lnlinks href=#hl-26-34> 34</a>
</span><span class=lnt id=hl-26-35><a class=lnlinks href=#hl-26-35> 35</a>
</span><span class=lnt id=hl-26-36><a class=lnlinks href=#hl-26-36> 36</a>
</span><span class=lnt id=hl-26-37><a class=lnlinks href=#hl-26-37> 37</a>
</span><span class=lnt id=hl-26-38><a class=lnlinks href=#hl-26-38> 38</a>
</span><span class=lnt id=hl-26-39><a class=lnlinks href=#hl-26-39> 39</a>
</span><span class=lnt id=hl-26-40><a class=lnlinks href=#hl-26-40> 40</a>
</span><span class=lnt id=hl-26-41><a class=lnlinks href=#hl-26-41> 41</a>
</span><span class=lnt id=hl-26-42><a class=lnlinks href=#hl-26-42> 42</a>
</span><span class=lnt id=hl-26-43><a class=lnlinks href=#hl-26-43> 43</a>
</span><span class=lnt id=hl-26-44><a class=lnlinks href=#hl-26-44> 44</a>
</span><span class=lnt id=hl-26-45><a class=lnlinks href=#hl-26-45> 45</a>
</span><span class=lnt id=hl-26-46><a class=lnlinks href=#hl-26-46> 46</a>
</span><span class=lnt id=hl-26-47><a class=lnlinks href=#hl-26-47> 47</a>
</span><span class=lnt id=hl-26-48><a class=lnlinks href=#hl-26-48> 48</a>
</span><span class=lnt id=hl-26-49><a class=lnlinks href=#hl-26-49> 49</a>
</span><span class=lnt id=hl-26-50><a class=lnlinks href=#hl-26-50> 50</a>
</span><span class=lnt id=hl-26-51><a class=lnlinks href=#hl-26-51> 51</a>
</span><span class=lnt id=hl-26-52><a class=lnlinks href=#hl-26-52> 52</a>
</span><span class=lnt id=hl-26-53><a class=lnlinks href=#hl-26-53> 53</a>
</span><span class=lnt id=hl-26-54><a class=lnlinks href=#hl-26-54> 54</a>
</span><span class=lnt id=hl-26-55><a class=lnlinks href=#hl-26-55> 55</a>
</span><span class=lnt id=hl-26-56><a class=lnlinks href=#hl-26-56> 56</a>
</span><span class=lnt id=hl-26-57><a class=lnlinks href=#hl-26-57> 57</a>
</span><span class=lnt id=hl-26-58><a class=lnlinks href=#hl-26-58> 58</a>
</span><span class=lnt id=hl-26-59><a class=lnlinks href=#hl-26-59> 59</a>
</span><span class=lnt id=hl-26-60><a class=lnlinks href=#hl-26-60> 60</a>
</span><span class=lnt id=hl-26-61><a class=lnlinks href=#hl-26-61> 61</a>
</span><span class=lnt id=hl-26-62><a class=lnlinks href=#hl-26-62> 62</a>
</span><span class=lnt id=hl-26-63><a class=lnlinks href=#hl-26-63> 63</a>
</span><span class=lnt id=hl-26-64><a class=lnlinks href=#hl-26-64> 64</a>
</span><span class=lnt id=hl-26-65><a class=lnlinks href=#hl-26-65> 65</a>
</span><span class=lnt id=hl-26-66><a class=lnlinks href=#hl-26-66> 66</a>
</span><span class=lnt id=hl-26-67><a class=lnlinks href=#hl-26-67> 67</a>
</span><span class=lnt id=hl-26-68><a class=lnlinks href=#hl-26-68> 68</a>
</span><span class=lnt id=hl-26-69><a class=lnlinks href=#hl-26-69> 69</a>
</span><span class=lnt id=hl-26-70><a class=lnlinks href=#hl-26-70> 70</a>
</span><span class=lnt id=hl-26-71><a class=lnlinks href=#hl-26-71> 71</a>
</span><span class=lnt id=hl-26-72><a class=lnlinks href=#hl-26-72> 72</a>
</span><span class=lnt id=hl-26-73><a class=lnlinks href=#hl-26-73> 73</a>
</span><span class=lnt id=hl-26-74><a class=lnlinks href=#hl-26-74> 74</a>
</span><span class=lnt id=hl-26-75><a class=lnlinks href=#hl-26-75> 75</a>
</span><span class=lnt id=hl-26-76><a class=lnlinks href=#hl-26-76> 76</a>
</span><span class=lnt id=hl-26-77><a class=lnlinks href=#hl-26-77> 77</a>
</span><span class=lnt id=hl-26-78><a class=lnlinks href=#hl-26-78> 78</a>
</span><span class=lnt id=hl-26-79><a class=lnlinks href=#hl-26-79> 79</a>
</span><span class=lnt id=hl-26-80><a class=lnlinks href=#hl-26-80> 80</a>
</span><span class=lnt id=hl-26-81><a class=lnlinks href=#hl-26-81> 81</a>
</span><span class=lnt id=hl-26-82><a class=lnlinks href=#hl-26-82> 82</a>
</span><span class=lnt id=hl-26-83><a class=lnlinks href=#hl-26-83> 83</a>
</span><span class=lnt id=hl-26-84><a class=lnlinks href=#hl-26-84> 84</a>
</span><span class=lnt id=hl-26-85><a class=lnlinks href=#hl-26-85> 85</a>
</span><span class=lnt id=hl-26-86><a class=lnlinks href=#hl-26-86> 86</a>
</span><span class=lnt id=hl-26-87><a class=lnlinks href=#hl-26-87> 87</a>
</span><span class=lnt id=hl-26-88><a class=lnlinks href=#hl-26-88> 88</a>
</span><span class=lnt id=hl-26-89><a class=lnlinks href=#hl-26-89> 89</a>
</span><span class=lnt id=hl-26-90><a class=lnlinks href=#hl-26-90> 90</a>
</span><span class=lnt id=hl-26-91><a class=lnlinks href=#hl-26-91> 91</a>
</span><span class=lnt id=hl-26-92><a class=lnlinks href=#hl-26-92> 92</a>
</span><span class=lnt id=hl-26-93><a class=lnlinks href=#hl-26-93> 93</a>
</span><span class=lnt id=hl-26-94><a class=lnlinks href=#hl-26-94> 94</a>
</span><span class=lnt id=hl-26-95><a class=lnlinks href=#hl-26-95> 95</a>
</span><span class=lnt id=hl-26-96><a class=lnlinks href=#hl-26-96> 96</a>
</span><span class=lnt id=hl-26-97><a class=lnlinks href=#hl-26-97> 97</a>
</span><span class=lnt id=hl-26-98><a class=lnlinks href=#hl-26-98> 98</a>
</span><span class=lnt id=hl-26-99><a class=lnlinks href=#hl-26-99> 99</a>
</span><span class=lnt id=hl-26-100><a class=lnlinks href=#hl-26-100>100</a>
</span><span class=lnt id=hl-26-101><a class=lnlinks href=#hl-26-101>101</a>
</span><span class=lnt id=hl-26-102><a class=lnlinks href=#hl-26-102>102</a>
</span><span class=lnt id=hl-26-103><a class=lnlinks href=#hl-26-103>103</a>
</span><span class=lnt id=hl-26-104><a class=lnlinks href=#hl-26-104>104</a>
</span><span class=lnt id=hl-26-105><a class=lnlinks href=#hl-26-105>105</a>
</span><span class=lnt id=hl-26-106><a class=lnlinks href=#hl-26-106>106</a>
</span><span class=lnt id=hl-26-107><a class=lnlinks href=#hl-26-107>107</a>
</span><span class=lnt id=hl-26-108><a class=lnlinks href=#hl-26-108>108</a>
</span><span class=lnt id=hl-26-109><a class=lnlinks href=#hl-26-109>109</a>
</span><span class=lnt id=hl-26-110><a class=lnlinks href=#hl-26-110>110</a>
</span><span class=lnt id=hl-26-111><a class=lnlinks href=#hl-26-111>111</a>
</span><span class=lnt id=hl-26-112><a class=lnlinks href=#hl-26-112>112</a>
</span><span class=lnt id=hl-26-113><a class=lnlinks href=#hl-26-113>113</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>BankingService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;은행 서비스 - 비즈니스 로직과 트랜잭션 통합&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tm</span> <span class=o>=</span> <span class=n>TransactionManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>transfer_money</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>from_account</span><span class=p>,</span> <span class=n>to_account</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        계좌 이체 - 트랜잭션 생명주기 전체 과정 시연
</span></span></span><span class=line><span class=cl><span class=s2>        ACID 속성 모두 적용: 원자성, 일관성, 격리성, 지속성
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Transfer amount must be positive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>tm</span><span class=o>.</span><span class=n>transaction</span><span class=p>()</span> <span class=k>as</span> <span class=n>tx</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span> <span class=o>=</span> <span class=n>tx</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>tx</span><span class=o>.</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Starting transfer: </span><span class=si>{</span><span class=n>from_account</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>to_account</span><span class=si>}</span><span class=s2>, Amount: </span><span class=si>{</span><span class=n>amount</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 1. 출금 계좌 잔액 확인 및 잠금 (Pessimistic Locking)</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>                SELECT balance, version FROM accounts 
</span></span></span><span class=line><span class=cl><span class=s1>                WHERE account_id = ? 
</span></span></span><span class=line><span class=cl><span class=s1>                FOR UPDATE
</span></span></span><span class=line><span class=cl><span class=s1>            &#39;&#39;&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>from_account</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>from_result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>from_result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account </span><span class=si>{</span><span class=n>from_account</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>from_balance</span><span class=p>,</span> <span class=n>from_version</span> <span class=o>=</span> <span class=n>from_result</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>from_balance</span> <span class=o>&lt;</span> <span class=n>amount</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Insufficient balance. Available: </span><span class=si>{</span><span class=n>from_balance</span><span class=si>}</span><span class=s2>, Required: </span><span class=si>{</span><span class=n>amount</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 2. 입금 계좌 확인 및 잠금</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>                SELECT balance, version FROM accounts 
</span></span></span><span class=line><span class=cl><span class=s1>                WHERE account_id = ? 
</span></span></span><span class=line><span class=cl><span class=s1>                FOR UPDATE
</span></span></span><span class=line><span class=cl><span class=s1>            &#39;&#39;&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>to_account</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>to_result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>to_result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account </span><span class=si>{</span><span class=n>to_account</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>to_balance</span><span class=p>,</span> <span class=n>to_version</span> <span class=o>=</span> <span class=n>to_result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 3. 출금 처리 (원자성 보장 - 둘 다 성공하거나 둘 다 실패)</span>
</span></span><span class=line><span class=cl>            <span class=n>new_from_balance</span> <span class=o>=</span> <span class=n>from_balance</span> <span class=o>-</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>            <span class=n>tx</span><span class=o>.</span><span class=n>execute_with_log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;UPDATE accounts SET balance = ?, version = version + 1 WHERE account_id = ? AND version = ?&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>new_from_balance</span><span class=p>,</span> <span class=n>from_account</span><span class=p>,</span> <span class=n>from_version</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;operation&#39;</span><span class=p>:</span> <span class=s1>&#39;UPDATE&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;table&#39;</span><span class=p>:</span> <span class=s1>&#39;accounts&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;old_value&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;account_id&#39;</span><span class=p>:</span> <span class=n>from_account</span><span class=p>,</span> <span class=s1>&#39;balance&#39;</span><span class=p>:</span> <span class=n>from_balance</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;new_value&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;account_id&#39;</span><span class=p>:</span> <span class=n>from_account</span><span class=p>,</span> <span class=s1>&#39;balance&#39;</span><span class=p>:</span> <span class=n>new_from_balance</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cursor</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Concurrent modification detected - transaction aborted&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 4. 입금 처리</span>
</span></span><span class=line><span class=cl>            <span class=n>new_to_balance</span> <span class=o>=</span> <span class=n>to_balance</span> <span class=o>+</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>            <span class=n>tx</span><span class=o>.</span><span class=n>execute_with_log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;UPDATE accounts SET balance = ?, version = version + 1 WHERE account_id = ? AND version = ?&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>new_to_balance</span><span class=p>,</span> <span class=n>to_account</span><span class=p>,</span> <span class=n>to_version</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;operation&#39;</span><span class=p>:</span> <span class=s1>&#39;UPDATE&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;table&#39;</span><span class=p>:</span> <span class=s1>&#39;accounts&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;old_value&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;account_id&#39;</span><span class=p>:</span> <span class=n>to_account</span><span class=p>,</span> <span class=s1>&#39;balance&#39;</span><span class=p>:</span> <span class=n>to_balance</span><span class=p>},</span> 
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;new_value&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;account_id&#39;</span><span class=p>:</span> <span class=n>to_account</span><span class=p>,</span> <span class=s1>&#39;balance&#39;</span><span class=p>:</span> <span class=n>new_to_balance</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cursor</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Concurrent modification detected - transaction aborted&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>tx</span><span class=o>.</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>] Transfer completed successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 트랜잭션이 성공적으로 완료되면 with 블록 종료 시 자동 커밋</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;transaction_id&#39;</span><span class=p>:</span> <span class=n>tx</span><span class=o>.</span><span class=n>transaction_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;from_account&#39;</span><span class=p>:</span> <span class=n>from_account</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;to_account&#39;</span><span class=p>:</span> <span class=n>to_account</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;amount&#39;</span><span class=p>:</span> <span class=n>amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;from_balance&#39;</span><span class=p>:</span> <span class=n>new_from_balance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;to_balance&#39;</span><span class=p>:</span> <span class=n>new_to_balance</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_balance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>account_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;계좌 잔액 조회 (읽기 전용 트랜잭션)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tm</span><span class=o>.</span><span class=n>db_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;SELECT balance FROM accounts WHERE account_id = ?&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>account_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>result</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_transaction_history</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;트랜잭션 로그 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tm</span><span class=o>.</span><span class=n>db_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>            SELECT transaction_id, operation_type, table_name, old_value, new_value, timestamp
</span></span></span><span class=line><span class=cl><span class=s1>            FROM transaction_log 
</span></span></span><span class=line><span class=cl><span class=s1>            ORDER BY timestamp DESC
</span></span></span><span class=line><span class=cl><span class=s1>            LIMIT 10
</span></span></span><span class=line><span class=cl><span class=s1>        &#39;&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=실행-결과>실행 결과<a hidden class=anchor aria-hidden=true href=#실행-결과>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a class=lnlinks href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a class=lnlinks href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a class=lnlinks href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a class=lnlinks href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a class=lnlinks href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a class=lnlinks href=#hl-27-18>18</a>
</span><span class=lnt id=hl-27-19><a class=lnlinks href=#hl-27-19>19</a>
</span><span class=lnt id=hl-27-20><a class=lnlinks href=#hl-27-20>20</a>
</span><span class=lnt id=hl-27-21><a class=lnlinks href=#hl-27-21>21</a>
</span><span class=lnt id=hl-27-22><a class=lnlinks href=#hl-27-22>22</a>
</span><span class=lnt id=hl-27-23><a class=lnlinks href=#hl-27-23>23</a>
</span><span class=lnt id=hl-27-24><a class=lnlinks href=#hl-27-24>24</a>
</span><span class=lnt id=hl-27-25><a class=lnlinks href=#hl-27-25>25</a>
</span><span class=lnt id=hl-27-26><a class=lnlinks href=#hl-27-26>26</a>
</span><span class=lnt id=hl-27-27><a class=lnlinks href=#hl-27-27>27</a>
</span><span class=lnt id=hl-27-28><a class=lnlinks href=#hl-27-28>28</a>
</span><span class=lnt id=hl-27-29><a class=lnlinks href=#hl-27-29>29</a>
</span><span class=lnt id=hl-27-30><a class=lnlinks href=#hl-27-30>30</a>
</span><span class=lnt id=hl-27-31><a class=lnlinks href=#hl-27-31>31</a>
</span><span class=lnt id=hl-27-32><a class=lnlinks href=#hl-27-32>32</a>
</span><span class=lnt id=hl-27-33><a class=lnlinks href=#hl-27-33>33</a>
</span><span class=lnt id=hl-27-34><a class=lnlinks href=#hl-27-34>34</a>
</span><span class=lnt id=hl-27-35><a class=lnlinks href=#hl-27-35>35</a>
</span><span class=lnt id=hl-27-36><a class=lnlinks href=#hl-27-36>36</a>
</span><span class=lnt id=hl-27-37><a class=lnlinks href=#hl-27-37>37</a>
</span><span class=lnt id=hl-27-38><a class=lnlinks href=#hl-27-38>38</a>
</span><span class=lnt id=hl-27-39><a class=lnlinks href=#hl-27-39>39</a>
</span><span class=lnt id=hl-27-40><a class=lnlinks href=#hl-27-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>demonstrate_transaction_lifecycle</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;트랜잭션 생명주기 시연&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 데이터베이스 초기화</span>
</span></span><span class=line><span class=cl>    <span class=n>initialize_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>banking_service</span> <span class=o>=</span> <span class=n>BankingService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 초기 상태 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account 1 balance: </span><span class=si>{</span><span class=n>banking_service</span><span class=o>.</span><span class=n>get_balance</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account 2 balance: </span><span class=si>{</span><span class=n>banking_service</span><span class=o>.</span><span class=n>get_balance</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 정상 이체 (성공 케이스) ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>banking_service</span><span class=o>.</span><span class=n>transfer_money</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Transfer result: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Transfer failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account 1 balance: </span><span class=si>{</span><span class=n>banking_service</span><span class=o>.</span><span class=n>get_balance</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account 2 balance: </span><span class=si>{</span><span class=n>banking_service</span><span class=o>.</span><span class=n>get_balance</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 잔액 부족 이체 (실패 케이스) ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>banking_service</span><span class=o>.</span><span class=n>transfer_money</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2000</span><span class=p>)</span>  <span class=c1># 잔액 초과</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Transfer result: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Transfer failed (expected): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account 1 balance: </span><span class=si>{</span><span class=n>banking_service</span><span class=o>.</span><span class=n>get_balance</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Account 2 balance: </span><span class=si>{</span><span class=n>banking_service</span><span class=o>.</span><span class=n>get_balance</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 트랜잭션 로그 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>history</span> <span class=o>=</span> <span class=n>banking_service</span><span class=o>.</span><span class=n>get_transaction_history</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>log_entry</span> <span class=ow>in</span> <span class=n>history</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;TXN: </span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=mi>0</span><span class=p>][:</span><span class=mi>20</span><span class=p>]</span><span class=si>}</span><span class=s2>… | Op: </span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2> | Table: </span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=si>}</span><span class=s2> | Time: </span><span class=si>{</span><span class=n>log_entry</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 실행</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>demonstrate_transaction_lifecycle</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=추가-실험>추가 실험<a hidden class=anchor aria-hidden=true href=#추가-실험>#</a></h6><ol><li><strong>동시성 테스트</strong>: 멀티 스레드로 동시 이체 수행</li><li><strong>데드락 시연</strong>: 순환 대기 상황 생성 및 탐지</li><li><strong>복구 테스트</strong>: 중간에 프로세스 종료 후 로그 기반 복구</li><li><strong>성능 측정</strong>: 트랜잭션 처리량과 응답 시간 측정</li></ol><h4 id=실제-도입-사례-분석>실제 도입 사례 분석<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-분석>#</a></h4><h5 id=실제-도입-사례-netflix-의-분산-트랜잭션-관리>실제 도입 사례: Netflix 의 분산 트랜잭션 관리<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-netflix-의-분산-트랜잭션-관리>#</a></h5><h6 id=배경-및-도입-이유>배경 및 도입 이유<a hidden class=anchor aria-hidden=true href=#배경-및-도입-이유>#</a></h6><p>Netflix 는 글로벌 스트리밍 서비스로 다음과 같은 도전과제에 직면했다:</p><ul><li><strong>마이크로서비스 아키텍처</strong>: 200 개 이상의 서비스 간 데이터 일관성 보장</li><li><strong>글로벌 규모</strong>: 전 세계 다중 리전에서 일관된 사용자 경험 제공</li><li><strong>높은 가용성</strong>: 99.99% 가용성 목표로 단일 장애점 제거 필요</li><li><strong>복잡한 비즈니스 로직</strong>: 결제, 구독, 컨텐츠 라이선스 등의 트랜잭션 처리</li></ul><p>전통적인 ACID 트랜잭션 대신 <strong>Saga 패턴</strong>과 <strong>Eventual Consistency</strong> 모델을 채택하여 확장성과 가용성을 확보했다.</p><h6 id=구현-아키텍처>구현 아키텍처<a hidden class=anchor aria-hidden=true href=#구현-아키텍처>#</a></h6><pre class=mermaid>graph TB
    subgraph &#34;User Request&#34;
        UR[User Subscription Request]
    end
    
    subgraph &#34;Orchestrator Layer&#34;
        SO[Saga Orchestrator]
        EM[Event Manager] 
    end
    
    subgraph &#34;Business Services&#34;
        PS[Payment Service]
        SS[Subscription Service]
        NS[Notification Service]
        AS[Analytics Service]
    end
    
    subgraph &#34;Data Persistence&#34;  
        PDB[(Payment DB)]
        SDB[(Subscription DB)]
        MQ[Message Queue]
    end
    
    UR --&gt; SO
    SO --&gt; EM
    EM --&gt; PS
    EM --&gt; SS
    EM --&gt; NS
    EM --&gt; AS
    PS --&gt; PDB
    SS --&gt; SDB
    PS --&gt; MQ
    SS --&gt; MQ
    MQ --&gt; EM
</pre><p>Netflix 의 분산 트랜잭션 아키텍처는 다음 요소들로 구성된다:</p><ul><li><strong>Saga Orchestrator</strong>: 분산 트랜잭션의 전체 생명주기 관리</li><li><strong>Event-Driven 통신</strong>: 서비스 간 비동기 메시지 전달</li><li><strong>Compensating Actions</strong>: 실패 시 이전 상태로 복원하는 보상 트랜잭션</li><li><strong>Circuit Breaker</strong>: 장애 전파 방지와 빠른 실패 처리</li></ul><h6 id=핵심-구현-코드>핵심 구현 코드<a hidden class=anchor aria-hidden=true href=#핵심-구현-코드>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1>  1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2>  2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3>  3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4>  4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5>  5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6>  6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7>  7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8>  8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9>  9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10> 10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11> 11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12> 12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13> 13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14> 14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15> 15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16> 16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17> 17</a>
</span><span class=lnt id=hl-29-18><a class=lnlinks href=#hl-29-18> 18</a>
</span><span class=lnt id=hl-29-19><a class=lnlinks href=#hl-29-19> 19</a>
</span><span class=lnt id=hl-29-20><a class=lnlinks href=#hl-29-20> 20</a>
</span><span class=lnt id=hl-29-21><a class=lnlinks href=#hl-29-21> 21</a>
</span><span class=lnt id=hl-29-22><a class=lnlinks href=#hl-29-22> 22</a>
</span><span class=lnt id=hl-29-23><a class=lnlinks href=#hl-29-23> 23</a>
</span><span class=lnt id=hl-29-24><a class=lnlinks href=#hl-29-24> 24</a>
</span><span class=lnt id=hl-29-25><a class=lnlinks href=#hl-29-25> 25</a>
</span><span class=lnt id=hl-29-26><a class=lnlinks href=#hl-29-26> 26</a>
</span><span class=lnt id=hl-29-27><a class=lnlinks href=#hl-29-27> 27</a>
</span><span class=lnt id=hl-29-28><a class=lnlinks href=#hl-29-28> 28</a>
</span><span class=lnt id=hl-29-29><a class=lnlinks href=#hl-29-29> 29</a>
</span><span class=lnt id=hl-29-30><a class=lnlinks href=#hl-29-30> 30</a>
</span><span class=lnt id=hl-29-31><a class=lnlinks href=#hl-29-31> 31</a>
</span><span class=lnt id=hl-29-32><a class=lnlinks href=#hl-29-32> 32</a>
</span><span class=lnt id=hl-29-33><a class=lnlinks href=#hl-29-33> 33</a>
</span><span class=lnt id=hl-29-34><a class=lnlinks href=#hl-29-34> 34</a>
</span><span class=lnt id=hl-29-35><a class=lnlinks href=#hl-29-35> 35</a>
</span><span class=lnt id=hl-29-36><a class=lnlinks href=#hl-29-36> 36</a>
</span><span class=lnt id=hl-29-37><a class=lnlinks href=#hl-29-37> 37</a>
</span><span class=lnt id=hl-29-38><a class=lnlinks href=#hl-29-38> 38</a>
</span><span class=lnt id=hl-29-39><a class=lnlinks href=#hl-29-39> 39</a>
</span><span class=lnt id=hl-29-40><a class=lnlinks href=#hl-29-40> 40</a>
</span><span class=lnt id=hl-29-41><a class=lnlinks href=#hl-29-41> 41</a>
</span><span class=lnt id=hl-29-42><a class=lnlinks href=#hl-29-42> 42</a>
</span><span class=lnt id=hl-29-43><a class=lnlinks href=#hl-29-43> 43</a>
</span><span class=lnt id=hl-29-44><a class=lnlinks href=#hl-29-44> 44</a>
</span><span class=lnt id=hl-29-45><a class=lnlinks href=#hl-29-45> 45</a>
</span><span class=lnt id=hl-29-46><a class=lnlinks href=#hl-29-46> 46</a>
</span><span class=lnt id=hl-29-47><a class=lnlinks href=#hl-29-47> 47</a>
</span><span class=lnt id=hl-29-48><a class=lnlinks href=#hl-29-48> 48</a>
</span><span class=lnt id=hl-29-49><a class=lnlinks href=#hl-29-49> 49</a>
</span><span class=lnt id=hl-29-50><a class=lnlinks href=#hl-29-50> 50</a>
</span><span class=lnt id=hl-29-51><a class=lnlinks href=#hl-29-51> 51</a>
</span><span class=lnt id=hl-29-52><a class=lnlinks href=#hl-29-52> 52</a>
</span><span class=lnt id=hl-29-53><a class=lnlinks href=#hl-29-53> 53</a>
</span><span class=lnt id=hl-29-54><a class=lnlinks href=#hl-29-54> 54</a>
</span><span class=lnt id=hl-29-55><a class=lnlinks href=#hl-29-55> 55</a>
</span><span class=lnt id=hl-29-56><a class=lnlinks href=#hl-29-56> 56</a>
</span><span class=lnt id=hl-29-57><a class=lnlinks href=#hl-29-57> 57</a>
</span><span class=lnt id=hl-29-58><a class=lnlinks href=#hl-29-58> 58</a>
</span><span class=lnt id=hl-29-59><a class=lnlinks href=#hl-29-59> 59</a>
</span><span class=lnt id=hl-29-60><a class=lnlinks href=#hl-29-60> 60</a>
</span><span class=lnt id=hl-29-61><a class=lnlinks href=#hl-29-61> 61</a>
</span><span class=lnt id=hl-29-62><a class=lnlinks href=#hl-29-62> 62</a>
</span><span class=lnt id=hl-29-63><a class=lnlinks href=#hl-29-63> 63</a>
</span><span class=lnt id=hl-29-64><a class=lnlinks href=#hl-29-64> 64</a>
</span><span class=lnt id=hl-29-65><a class=lnlinks href=#hl-29-65> 65</a>
</span><span class=lnt id=hl-29-66><a class=lnlinks href=#hl-29-66> 66</a>
</span><span class=lnt id=hl-29-67><a class=lnlinks href=#hl-29-67> 67</a>
</span><span class=lnt id=hl-29-68><a class=lnlinks href=#hl-29-68> 68</a>
</span><span class=lnt id=hl-29-69><a class=lnlinks href=#hl-29-69> 69</a>
</span><span class=lnt id=hl-29-70><a class=lnlinks href=#hl-29-70> 70</a>
</span><span class=lnt id=hl-29-71><a class=lnlinks href=#hl-29-71> 71</a>
</span><span class=lnt id=hl-29-72><a class=lnlinks href=#hl-29-72> 72</a>
</span><span class=lnt id=hl-29-73><a class=lnlinks href=#hl-29-73> 73</a>
</span><span class=lnt id=hl-29-74><a class=lnlinks href=#hl-29-74> 74</a>
</span><span class=lnt id=hl-29-75><a class=lnlinks href=#hl-29-75> 75</a>
</span><span class=lnt id=hl-29-76><a class=lnlinks href=#hl-29-76> 76</a>
</span><span class=lnt id=hl-29-77><a class=lnlinks href=#hl-29-77> 77</a>
</span><span class=lnt id=hl-29-78><a class=lnlinks href=#hl-29-78> 78</a>
</span><span class=lnt id=hl-29-79><a class=lnlinks href=#hl-29-79> 79</a>
</span><span class=lnt id=hl-29-80><a class=lnlinks href=#hl-29-80> 80</a>
</span><span class=lnt id=hl-29-81><a class=lnlinks href=#hl-29-81> 81</a>
</span><span class=lnt id=hl-29-82><a class=lnlinks href=#hl-29-82> 82</a>
</span><span class=lnt id=hl-29-83><a class=lnlinks href=#hl-29-83> 83</a>
</span><span class=lnt id=hl-29-84><a class=lnlinks href=#hl-29-84> 84</a>
</span><span class=lnt id=hl-29-85><a class=lnlinks href=#hl-29-85> 85</a>
</span><span class=lnt id=hl-29-86><a class=lnlinks href=#hl-29-86> 86</a>
</span><span class=lnt id=hl-29-87><a class=lnlinks href=#hl-29-87> 87</a>
</span><span class=lnt id=hl-29-88><a class=lnlinks href=#hl-29-88> 88</a>
</span><span class=lnt id=hl-29-89><a class=lnlinks href=#hl-29-89> 89</a>
</span><span class=lnt id=hl-29-90><a class=lnlinks href=#hl-29-90> 90</a>
</span><span class=lnt id=hl-29-91><a class=lnlinks href=#hl-29-91> 91</a>
</span><span class=lnt id=hl-29-92><a class=lnlinks href=#hl-29-92> 92</a>
</span><span class=lnt id=hl-29-93><a class=lnlinks href=#hl-29-93> 93</a>
</span><span class=lnt id=hl-29-94><a class=lnlinks href=#hl-29-94> 94</a>
</span><span class=lnt id=hl-29-95><a class=lnlinks href=#hl-29-95> 95</a>
</span><span class=lnt id=hl-29-96><a class=lnlinks href=#hl-29-96> 96</a>
</span><span class=lnt id=hl-29-97><a class=lnlinks href=#hl-29-97> 97</a>
</span><span class=lnt id=hl-29-98><a class=lnlinks href=#hl-29-98> 98</a>
</span><span class=lnt id=hl-29-99><a class=lnlinks href=#hl-29-99> 99</a>
</span><span class=lnt id=hl-29-100><a class=lnlinks href=#hl-29-100>100</a>
</span><span class=lnt id=hl-29-101><a class=lnlinks href=#hl-29-101>101</a>
</span><span class=lnt id=hl-29-102><a class=lnlinks href=#hl-29-102>102</a>
</span><span class=lnt id=hl-29-103><a class=lnlinks href=#hl-29-103>103</a>
</span><span class=lnt id=hl-29-104><a class=lnlinks href=#hl-29-104>104</a>
</span><span class=lnt id=hl-29-105><a class=lnlinks href=#hl-29-105>105</a>
</span><span class=lnt id=hl-29-106><a class=lnlinks href=#hl-29-106>106</a>
</span><span class=lnt id=hl-29-107><a class=lnlinks href=#hl-29-107>107</a>
</span><span class=lnt id=hl-29-108><a class=lnlinks href=#hl-29-108>108</a>
</span><span class=lnt id=hl-29-109><a class=lnlinks href=#hl-29-109>109</a>
</span><span class=lnt id=hl-29-110><a class=lnlinks href=#hl-29-110>110</a>
</span><span class=lnt id=hl-29-111><a class=lnlinks href=#hl-29-111>111</a>
</span><span class=lnt id=hl-29-112><a class=lnlinks href=#hl-29-112>112</a>
</span><span class=lnt id=hl-29-113><a class=lnlinks href=#hl-29-113>113</a>
</span><span class=lnt id=hl-29-114><a class=lnlinks href=#hl-29-114>114</a>
</span><span class=lnt id=hl-29-115><a class=lnlinks href=#hl-29-115>115</a>
</span><span class=lnt id=hl-29-116><a class=lnlinks href=#hl-29-116>116</a>
</span><span class=lnt id=hl-29-117><a class=lnlinks href=#hl-29-117>117</a>
</span><span class=lnt id=hl-29-118><a class=lnlinks href=#hl-29-118>118</a>
</span><span class=lnt id=hl-29-119><a class=lnlinks href=#hl-29-119>119</a>
</span><span class=lnt id=hl-29-120><a class=lnlinks href=#hl-29-120>120</a>
</span><span class=lnt id=hl-29-121><a class=lnlinks href=#hl-29-121>121</a>
</span><span class=lnt id=hl-29-122><a class=lnlinks href=#hl-29-122>122</a>
</span><span class=lnt id=hl-29-123><a class=lnlinks href=#hl-29-123>123</a>
</span><span class=lnt id=hl-29-124><a class=lnlinks href=#hl-29-124>124</a>
</span><span class=lnt id=hl-29-125><a class=lnlinks href=#hl-29-125>125</a>
</span><span class=lnt id=hl-29-126><a class=lnlinks href=#hl-29-126>126</a>
</span><span class=lnt id=hl-29-127><a class=lnlinks href=#hl-29-127>127</a>
</span><span class=lnt id=hl-29-128><a class=lnlinks href=#hl-29-128>128</a>
</span><span class=lnt id=hl-29-129><a class=lnlinks href=#hl-29-129>129</a>
</span><span class=lnt id=hl-29-130><a class=lnlinks href=#hl-29-130>130</a>
</span><span class=lnt id=hl-29-131><a class=lnlinks href=#hl-29-131>131</a>
</span><span class=lnt id=hl-29-132><a class=lnlinks href=#hl-29-132>132</a>
</span><span class=lnt id=hl-29-133><a class=lnlinks href=#hl-29-133>133</a>
</span><span class=lnt id=hl-29-134><a class=lnlinks href=#hl-29-134>134</a>
</span><span class=lnt id=hl-29-135><a class=lnlinks href=#hl-29-135>135</a>
</span><span class=lnt id=hl-29-136><a class=lnlinks href=#hl-29-136>136</a>
</span><span class=lnt id=hl-29-137><a class=lnlinks href=#hl-29-137>137</a>
</span><span class=lnt id=hl-29-138><a class=lnlinks href=#hl-29-138>138</a>
</span><span class=lnt id=hl-29-139><a class=lnlinks href=#hl-29-139>139</a>
</span><span class=lnt id=hl-29-140><a class=lnlinks href=#hl-29-140>140</a>
</span><span class=lnt id=hl-29-141><a class=lnlinks href=#hl-29-141>141</a>
</span><span class=lnt id=hl-29-142><a class=lnlinks href=#hl-29-142>142</a>
</span><span class=lnt id=hl-29-143><a class=lnlinks href=#hl-29-143>143</a>
</span><span class=lnt id=hl-29-144><a class=lnlinks href=#hl-29-144>144</a>
</span><span class=lnt id=hl-29-145><a class=lnlinks href=#hl-29-145>145</a>
</span><span class=lnt id=hl-29-146><a class=lnlinks href=#hl-29-146>146</a>
</span><span class=lnt id=hl-29-147><a class=lnlinks href=#hl-29-147>147</a>
</span><span class=lnt id=hl-29-148><a class=lnlinks href=#hl-29-148>148</a>
</span><span class=lnt id=hl-29-149><a class=lnlinks href=#hl-29-149>149</a>
</span><span class=lnt id=hl-29-150><a class=lnlinks href=#hl-29-150>150</a>
</span><span class=lnt id=hl-29-151><a class=lnlinks href=#hl-29-151>151</a>
</span><span class=lnt id=hl-29-152><a class=lnlinks href=#hl-29-152>152</a>
</span><span class=lnt id=hl-29-153><a class=lnlinks href=#hl-29-153>153</a>
</span><span class=lnt id=hl-29-154><a class=lnlinks href=#hl-29-154>154</a>
</span><span class=lnt id=hl-29-155><a class=lnlinks href=#hl-29-155>155</a>
</span><span class=lnt id=hl-29-156><a class=lnlinks href=#hl-29-156>156</a>
</span><span class=lnt id=hl-29-157><a class=lnlinks href=#hl-29-157>157</a>
</span><span class=lnt id=hl-29-158><a class=lnlinks href=#hl-29-158>158</a>
</span><span class=lnt id=hl-29-159><a class=lnlinks href=#hl-29-159>159</a>
</span><span class=lnt id=hl-29-160><a class=lnlinks href=#hl-29-160>160</a>
</span><span class=lnt id=hl-29-161><a class=lnlinks href=#hl-29-161>161</a>
</span><span class=lnt id=hl-29-162><a class=lnlinks href=#hl-29-162>162</a>
</span><span class=lnt id=hl-29-163><a class=lnlinks href=#hl-29-163>163</a>
</span><span class=lnt id=hl-29-164><a class=lnlinks href=#hl-29-164>164</a>
</span><span class=lnt id=hl-29-165><a class=lnlinks href=#hl-29-165>165</a>
</span><span class=lnt id=hl-29-166><a class=lnlinks href=#hl-29-166>166</a>
</span><span class=lnt id=hl-29-167><a class=lnlinks href=#hl-29-167>167</a>
</span><span class=lnt id=hl-29-168><a class=lnlinks href=#hl-29-168>168</a>
</span><span class=lnt id=hl-29-169><a class=lnlinks href=#hl-29-169>169</a>
</span><span class=lnt id=hl-29-170><a class=lnlinks href=#hl-29-170>170</a>
</span><span class=lnt id=hl-29-171><a class=lnlinks href=#hl-29-171>171</a>
</span><span class=lnt id=hl-29-172><a class=lnlinks href=#hl-29-172>172</a>
</span><span class=lnt id=hl-29-173><a class=lnlinks href=#hl-29-173>173</a>
</span><span class=lnt id=hl-29-174><a class=lnlinks href=#hl-29-174>174</a>
</span><span class=lnt id=hl-29-175><a class=lnlinks href=#hl-29-175>175</a>
</span><span class=lnt id=hl-29-176><a class=lnlinks href=#hl-29-176>176</a>
</span><span class=lnt id=hl-29-177><a class=lnlinks href=#hl-29-177>177</a>
</span><span class=lnt id=hl-29-178><a class=lnlinks href=#hl-29-178>178</a>
</span><span class=lnt id=hl-29-179><a class=lnlinks href=#hl-29-179>179</a>
</span><span class=lnt id=hl-29-180><a class=lnlinks href=#hl-29-180>180</a>
</span><span class=lnt id=hl-29-181><a class=lnlinks href=#hl-29-181>181</a>
</span><span class=lnt id=hl-29-182><a class=lnlinks href=#hl-29-182>182</a>
</span><span class=lnt id=hl-29-183><a class=lnlinks href=#hl-29-183>183</a>
</span><span class=lnt id=hl-29-184><a class=lnlinks href=#hl-29-184>184</a>
</span><span class=lnt id=hl-29-185><a class=lnlinks href=#hl-29-185>185</a>
</span><span class=lnt id=hl-29-186><a class=lnlinks href=#hl-29-186>186</a>
</span><span class=lnt id=hl-29-187><a class=lnlinks href=#hl-29-187>187</a>
</span><span class=lnt id=hl-29-188><a class=lnlinks href=#hl-29-188>188</a>
</span><span class=lnt id=hl-29-189><a class=lnlinks href=#hl-29-189>189</a>
</span><span class=lnt id=hl-29-190><a class=lnlinks href=#hl-29-190>190</a>
</span><span class=lnt id=hl-29-191><a class=lnlinks href=#hl-29-191>191</a>
</span><span class=lnt id=hl-29-192><a class=lnlinks href=#hl-29-192>192</a>
</span><span class=lnt id=hl-29-193><a class=lnlinks href=#hl-29-193>193</a>
</span><span class=lnt id=hl-29-194><a class=lnlinks href=#hl-29-194>194</a>
</span><span class=lnt id=hl-29-195><a class=lnlinks href=#hl-29-195>195</a>
</span><span class=lnt id=hl-29-196><a class=lnlinks href=#hl-29-196>196</a>
</span><span class=lnt id=hl-29-197><a class=lnlinks href=#hl-29-197>197</a>
</span><span class=lnt id=hl-29-198><a class=lnlinks href=#hl-29-198>198</a>
</span><span class=lnt id=hl-29-199><a class=lnlinks href=#hl-29-199>199</a>
</span><span class=lnt id=hl-29-200><a class=lnlinks href=#hl-29-200>200</a>
</span><span class=lnt id=hl-29-201><a class=lnlinks href=#hl-29-201>201</a>
</span><span class=lnt id=hl-29-202><a class=lnlinks href=#hl-29-202>202</a>
</span><span class=lnt id=hl-29-203><a class=lnlinks href=#hl-29-203>203</a>
</span><span class=lnt id=hl-29-204><a class=lnlinks href=#hl-29-204>204</a>
</span><span class=lnt id=hl-29-205><a class=lnlinks href=#hl-29-205>205</a>
</span><span class=lnt id=hl-29-206><a class=lnlinks href=#hl-29-206>206</a>
</span><span class=lnt id=hl-29-207><a class=lnlinks href=#hl-29-207>207</a>
</span><span class=lnt id=hl-29-208><a class=lnlinks href=#hl-29-208>208</a>
</span><span class=lnt id=hl-29-209><a class=lnlinks href=#hl-29-209>209</a>
</span><span class=lnt id=hl-29-210><a class=lnlinks href=#hl-29-210>210</a>
</span><span class=lnt id=hl-29-211><a class=lnlinks href=#hl-29-211>211</a>
</span><span class=lnt id=hl-29-212><a class=lnlinks href=#hl-29-212>212</a>
</span><span class=lnt id=hl-29-213><a class=lnlinks href=#hl-29-213>213</a>
</span><span class=lnt id=hl-29-214><a class=lnlinks href=#hl-29-214>214</a>
</span><span class=lnt id=hl-29-215><a class=lnlinks href=#hl-29-215>215</a>
</span><span class=lnt id=hl-29-216><a class=lnlinks href=#hl-29-216>216</a>
</span><span class=lnt id=hl-29-217><a class=lnlinks href=#hl-29-217>217</a>
</span><span class=lnt id=hl-29-218><a class=lnlinks href=#hl-29-218>218</a>
</span><span class=lnt id=hl-29-219><a class=lnlinks href=#hl-29-219>219</a>
</span><span class=lnt id=hl-29-220><a class=lnlinks href=#hl-29-220>220</a>
</span><span class=lnt id=hl-29-221><a class=lnlinks href=#hl-29-221>221</a>
</span><span class=lnt id=hl-29-222><a class=lnlinks href=#hl-29-222>222</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Saga 트랜잭션 상태&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>STARTED</span> <span class=o>=</span> <span class=s2>&#34;STARTED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>IN_PROGRESS</span> <span class=o>=</span> <span class=s2>&#34;IN_PROGRESS&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>COMPLETED</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FAILED</span> <span class=o>=</span> <span class=s2>&#34;FAILED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>COMPENSATING</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATING&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>COMPENSATED</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATED&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StepState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;개별 단계 상태&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>PENDING</span> <span class=o>=</span> <span class=s2>&#34;PENDING&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>EXECUTING</span> <span class=o>=</span> <span class=s2>&#34;EXECUTING&#34;</span> 
</span></span><span class=line><span class=cl>    <span class=n>COMPLETED</span> <span class=o>=</span> <span class=s2>&#34;COMPLETED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FAILED</span> <span class=o>=</span> <span class=s2>&#34;FAILED&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>COMPENSATED</span> <span class=o>=</span> <span class=s2>&#34;COMPENSATED&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaStep</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Saga의 개별 실행 단계&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>step_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># 실행할 액션</span>
</span></span><span class=line><span class=cl>    <span class=n>compensate_action</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># 보상 액션</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>StepState</span> <span class=o>=</span> <span class=n>StepState</span><span class=o>.</span><span class=n>PENDING</span>
</span></span><span class=line><span class=cl>    <span class=n>retry_count</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaOrchestrator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Netflix 스타일 분산 트랜잭션 오케스트레이터&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_manager</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_manager</span> <span class=o>=</span> <span class=n>event_manager</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 활성 Saga 추적</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_saga</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>saga_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>SagaStep</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Saga 패턴을 통한 분산 트랜잭션 실행
</span></span></span><span class=line><span class=cl><span class=s2>        전통적인 트랜잭션 생명주기를 분산 환경에 적용
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Phase 1: Saga 시작 (분산 트랜잭션의 ACTIVE 상태)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span><span class=p>[</span><span class=n>saga_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;state&#39;</span><span class=p>:</span> <span class=n>SagaState</span><span class=o>.</span><span class=n>STARTED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;steps&#39;</span><span class=p>:</span> <span class=n>steps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;start_time&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;completed_steps&#39;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;failed_steps&#39;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Started - State: </span><span class=si>{</span><span class=n>SagaState</span><span class=o>.</span><span class=n>STARTED</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Phase 2: 순차적 단계 실행 (IN_PROGRESS)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span><span class=p>[</span><span class=n>saga_id</span><span class=p>][</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>SagaState</span><span class=o>.</span><span class=n>IN_PROGRESS</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_step</span><span class=p>(</span><span class=n>saga_id</span><span class=p>,</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>step</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=n>StepState</span><span class=o>.</span><span class=n>FAILED</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 실패 시 보상 트랜잭션 실행</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compensate_saga</span><span class=p>(</span><span class=n>saga_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span><span class=p>[</span><span class=n>saga_id</span><span class=p>][</span><span class=s1>&#39;completed_steps&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Phase 3: 성공적 완료 (COMPLETED - 분산 COMMITTED에 해당)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span><span class=p>[</span><span class=n>saga_id</span><span class=p>][</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>SagaState</span><span class=o>.</span><span class=n>COMPLETED</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span><span class=p>[</span><span class=n>saga_id</span><span class=p>][</span><span class=s1>&#39;end_time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Completed successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Phase 4: 실패 처리 (FAILED -&gt; COMPENSATING -&gt; COMPENSATED)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compensate_saga</span><span class=p>(</span><span class=n>saga_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>saga_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=n>SagaStep</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;개별 단계 실행 - 마이크로서비스 호출&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>step</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>StepState</span><span class=o>.</span><span class=n>EXECUTING</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Executing step: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>step</span><span class=o>.</span><span class=n>retry_count</span> <span class=o>&lt;=</span> <span class=n>step</span><span class=o>.</span><span class=n>max_retries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 실제로는 HTTP API 호출 또는 메시지 큐 발송</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_call_microservice</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>service_name</span><span class=p>,</span> <span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=p>,</span> <span class=n>step</span><span class=o>.</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;success&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>step</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>StepState</span><span class=o>.</span><span class=n>COMPLETED</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Step </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2> completed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Service returned failure: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>step</span><span class=o>.</span><span class=n>retry_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Step </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2> failed (attempt </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>retry_count</span><span class=si>}</span><span class=s2>): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>step</span><span class=o>.</span><span class=n>retry_count</span> <span class=o>&gt;</span> <span class=n>step</span><span class=o>.</span><span class=n>max_retries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>step</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>StepState</span><span class=o>.</span><span class=n>FAILED</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 지수 백오프로 재시도</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>**</span> <span class=n>step</span><span class=o>.</span><span class=n>retry_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_compensate_saga</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>saga_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;보상 트랜잭션 실행 - 분산 환경의 롤백에 해당&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>saga_info</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_sagas</span><span class=p>[</span><span class=n>saga_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>saga_info</span><span class=p>[</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>SagaState</span><span class=o>.</span><span class=n>COMPENSATING</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Starting compensation&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 성공한 단계들을 역순으로 보상</span>
</span></span><span class=line><span class=cl>        <span class=n>completed_steps</span> <span class=o>=</span> <span class=n>saga_info</span><span class=p>[</span><span class=s1>&#39;completed_steps&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>completed_steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_call_microservice</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>step</span><span class=o>.</span><span class=n>service_name</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>step</span><span class=o>.</span><span class=n>compensate_action</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>step</span><span class=o>.</span><span class=n>payload</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>step</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>StepState</span><span class=o>.</span><span class=n>COMPENSATED</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Step </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2> compensated&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Compensation failed for </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># 보상 실패 시 수동 개입 필요 (Dead Letter Queue 등)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>saga_info</span><span class=p>[</span><span class=s1>&#39;state&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>SagaState</span><span class=o>.</span><span class=n>COMPENSATED</span>
</span></span><span class=line><span class=cl>        <span class=n>saga_info</span><span class=p>[</span><span class=s1>&#39;end_time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Saga </span><span class=si>{</span><span class=n>saga_id</span><span class=si>}</span><span class=s2>] Compensation completed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_call_microservice</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>action</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>payload</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;마이크로서비스 호출 시뮬레이션&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 실제로는 HTTP 클라이언트나 메시지 큐 사용</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>  <span class=c1># 네트워크 지연 시뮬레이션</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Netflix의 실제 서비스별 로직</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;payment&#34;</span> <span class=ow>and</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;charge&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 결제 처리 로직</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;amount&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s1>&#39;transaction_id&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;pay_</span><span class=si>{</span><span class=n>payload</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=s1>&#39;Invalid amount&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;subscription&#34;</span> <span class=ow>and</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;activate&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 구독 활성화 로직  </span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s1>&#39;subscription_id&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;sub_</span><span class=si>{</span><span class=n>payload</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>service_name</span> <span class=o>==</span> <span class=s2>&#34;notification&#34;</span> <span class=ow>and</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;send_welcome&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 환영 메시지 발송</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s1>&#39;message_id&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;msg_</span><span class=si>{</span><span class=n>payload</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;success&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Netflix 구독 프로세스 시연</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>netflix_subscription_example</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Netflix의 사용자 구독 처리 Saga&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>event_manager</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 실제로는 Kafka 등의 이벤트 스트림</span>
</span></span><span class=line><span class=cl>    <span class=n>orchestrator</span> <span class=o>=</span> <span class=n>SagaOrchestrator</span><span class=p>(</span><span class=n>event_manager</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 구독 프로세스의 분산 트랜잭션 단계 정의</span>
</span></span><span class=line><span class=cl>    <span class=n>subscription_steps</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;validate_payment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;payment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>action</span><span class=o>=</span><span class=s2>&#34;validate_card&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>compensate_action</span><span class=o>=</span><span class=s2>&#34;release_hold&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user123&#34;</span><span class=p>,</span> <span class=s2>&#34;card_token&#34;</span><span class=p>:</span> <span class=s2>&#34;card_xyz&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;charge_payment&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;payment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>action</span><span class=o>=</span><span class=s2>&#34;charge&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>compensate_action</span><span class=o>=</span><span class=s2>&#34;refund&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user123&#34;</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>:</span> <span class=mf>12.99</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;create_subscription&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;subscription&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>action</span><span class=o>=</span><span class=s2>&#34;activate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>compensate_action</span><span class=o>=</span><span class=s2>&#34;deactivate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user123&#34;</span><span class=p>,</span> <span class=s2>&#34;plan&#34;</span><span class=p>:</span> <span class=s2>&#34;premium&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;send_notification&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;notification&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>action</span><span class=o>=</span><span class=s2>&#34;send_welcome&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>compensate_action</span><span class=o>=</span><span class=s2>&#34;send_cancellation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user123&#34;</span><span class=p>,</span> <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;user@example.com&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>SagaStep</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>step_id</span><span class=o>=</span><span class=s2>&#34;update_analytics&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>service_name</span><span class=o>=</span><span class=s2>&#34;analytics&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>action</span><span class=o>=</span><span class=s2>&#34;track_conversion&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>compensate_action</span><span class=o>=</span><span class=s2>&#34;remove_conversion&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user123&#34;</span><span class=p>,</span> <span class=s2>&#34;event&#34;</span><span class=p>:</span> <span class=s2>&#34;subscription_created&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 분산 트랜잭션 실행</span>
</span></span><span class=line><span class=cl>    <span class=n>saga_id</span> <span class=o>=</span> <span class=s2>&#34;subscription_saga_123&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span> <span class=o>=</span> <span class=k>await</span> <span class=n>orchestrator</span><span class=o>.</span><span class=n>execute_saga</span><span class=p>(</span><span class=n>saga_id</span><span class=p>,</span> <span class=n>subscription_steps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>✅ User subscription completed successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>❌ User subscription failed and was compensated&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 실행</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>netflix_subscription_example</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=성과-및-결과>성과 및 결과<a hidden class=anchor aria-hidden=true href=#성과-및-결과>#</a></h6><p><strong>정량적 지표</strong>:</p><ul><li><strong>가용성</strong>: 99.99% 달성 (연간 52 분 미만 다운타임)</li><li><strong>처리량</strong>: 초당 100 만 + 요청 처리 능력</li><li><strong>지연시간</strong>: P95 기준 100ms 미만 응답시간</li><li><strong>비용 절감</strong>: 전통적 분산 트랜잭션 대비 30% 인프라 비용 절약</li></ul><p><strong>정성적 개선</strong>:</p><ul><li><strong>운영성</strong>: 서비스별 독립 배포와 장애 격리 실현</li><li><strong>개발자 경험</strong>: 도메인별 팀의 자율적 개발과 운영 가능</li><li><strong>비즈니스 민첩성</strong>: 새로운 기능의 빠른 실험과 배포</li></ul><h6 id=교훈-및-시사점>교훈 및 시사점<a hidden class=anchor aria-hidden=true href=#교훈-및-시사점>#</a></h6><p><strong>재현 시 유의점</strong>:</p><ol><li><strong>멱등성 보장</strong>: 각 마이크로서비스의 API 는 반드시 멱등성을 가져야 함</li><li><strong>보상 트랜잭션 설계</strong>: 모든 액션에 대해 신뢰할 수 있는 롤백 메커니즘 필요</li><li><strong>모니터링</strong>: 분산 트레이싱과 로그 집계로 문제 추적 필수</li><li><strong>타임아웃 설정</strong>: 각 단계별 적절한 타임아웃으로 무한 대기 방지</li></ol><p><strong>대안 접근</strong>:</p><ul><li><strong>Event Sourcing</strong>: 상태 변경을 이벤트로 기록하여 감사 추적성 향상</li><li><strong>CQRS</strong>: 명령과 조회를 분리하여 읽기 성능 최적화</li><li><strong>Two-Phase Saga</strong>: 준비 - 실행 단계로 일관성 강화</li></ul><p><strong>확장 아이디어</strong>:</p><ul><li><strong>AI 기반 보상</strong>: 머신러닝으로 최적 보상 전략 자동 선택</li><li><strong>블록체인 연동</strong>: 크리티컬 트랜잭션의 불변성 보장</li><li><strong>Serverless 통합</strong>: Function-as-a-Service 로 비용 효율성 극대화</li></ul><h4 id=트랜잭션-통합연계-기술-총정리>트랜잭션 통합·연계 기술 총정리<a hidden class=anchor aria-hidden=true href=#트랜잭션-통합연계-기술-총정리>#</a></h4><p>트랜잭션 생명주기와 외부 시스템을 안정적으로 엮으려면 <strong>데이터 변경과 이벤트 발행의 원자성 (Outbox), DB 변경을 읽어 이벤트로 만드는 CDC, 캐시 무효화 전략, 이벤트 소싱 (감사), 그리고 분산 추적 (Trace ID) 으로 관찰성</strong>을 결합해야 하며, 각 기술은 <strong>일관성·지연·운영 복잡도</strong> 사이에서 트레이드오프를 만든다.</p><h5 id=트랜잭션-통합연계-기술-분류>트랜잭션 통합·연계 기술 분류<a hidden class=anchor aria-hidden=true href=#트랜잭션-통합연계-기술-분류>#</a></h5><h6 id=메시징이벤트-연계-outbox--mq--saga>메시징·이벤트 연계 (Outbox / MQ / Saga)<a hidden class=anchor aria-hidden=true href=#메시징이벤트-연계-outbox--mq--saga>#</a></h6><p>메시징 계층은 트랜잭션 결과를 다른 서비스에 전달하는 핵심 통로다.<br><strong>Outbox 패턴</strong>은 DB 트랜잭션과 메시지 기록을 함께 커밋해 데이터/이벤트 불일치를 최소화한다.<br><strong>Saga</strong>는 여러 서비스에 걸친 비즈니스 트랜잭션을 로컬 트랜잭션 + 보상으로 구성하여 결국적 일관성을 제공한다.<br>운영 포인트는 poller 성능, 메시지 중복 (→idempotency), 순서 보장, 보상 실패 처리 로직이다.</p><table><thead><tr><th>항목</th><th>구현 패턴</th><th style=text-align:right>장점</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>Outbox</td><td>트랜잭션 내 outbox 레코드 + poller → MQ</td><td style=text-align:right>데이터 + 이벤트 간 원자성 사실상 확보</td><td>poller 장애/지연, 큐 발행 중복 → idempotency 필요</td></tr><tr><td>MQ (Message Queue)</td><td>브로커 기반 publish/subscribe</td><td style=text-align:right>확장성·내결함성 제공</td><td>파티셔닝·ordering 설계, 브로커 장애</td></tr><tr><td>Saga</td><td>오케스트레이션 / 코레오그래피</td><td style=text-align:right>서비스 독립적, 저지연</td><td>보상 트랜잭션 설계·관찰성 필요</td></tr></tbody></table><ul><li>요약: 메시징 계층은 데이터 일관성과 서비스 간 신뢰를 만들지만 <strong>idempotency, 순서, 보상 전략</strong>을 반드시 설계해야 한다.</li></ul><h6 id=데이터-동기화파이프라인-cdc--replication>데이터 동기화·파이프라인 (CDC / Replication)<a hidden class=anchor aria-hidden=true href=#데이터-동기화파이프라인-cdc--replication>#</a></h6><p>CDC 는 DB 로그를 캡처해 실시간으로 이벤트를 만들며, 레거시 시스템과 데이터 파이프라인을 연결하는 표준 방식이다.<br>장점은 애플리케이션 변경 최소, 단점은 lag(지연) 과 순서/필터링 복잡성.<br>실무에서는 CDC → Kafka → 소비자 형태로 많이 운영하며, 모니터링 (로그 오프셋, lag) 과 백프레셔 대책이 필요하다.</p><table><thead><tr><th>항목</th><th>구현 방식</th><th style=text-align:right>장점</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>CDC</td><td>DB 로그 (예: WAL) 파싱 → 이벤트 생성</td><td style=text-align:right>레거시 변경 포착, 코드 변경 최소</td><td>로그 포맷종속성, lag 모니터링, 스키마 변경 처리</td></tr><tr><td>레플리카/Replicate</td><td>DB 복제 (동기/비동기)</td><td style=text-align:right>읽기 분리, HA 지원</td><td>복제 지연, 일관성 모델 선택</td></tr></tbody></table><ul><li>요약: CDC 는 실시간 파이프라인 구축에 강력하나 <strong>lag·스키마 변경·정렬 문제</strong>를 관리해야 한다.</li></ul><h6 id=읽기-최적화캐시-통합-cache-전략>읽기 최적화·캐시 통합 (Cache 전략)<a hidden class=anchor aria-hidden=true href=#읽기-최적화캐시-통합-cache-전략>#</a></h6><p>캐시는 읽기 성능을 대폭 개선하지만 캐시 일관성 문제를 초래할 수 있다.<br><strong>Write-Through</strong>는 쓰기 시 동기 캐시 갱신, <strong>Cache-Aside</strong>는 트랜잭션 commit 후 이벤트로 무효화/갱신한다.<br>분산 캐시 환경에서는 토폴로지와 무효화 신뢰성 (예: 메시지 전파 실패) 이 운영 이슈다.</p><table><thead><tr><th>항목</th><th>패턴</th><th style=text-align:right>장점</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>Write-Through</td><td>트랜잭션 내 또는 동기화된 갱신</td><td style=text-align:right>일관성 높음</td><td>쓰기 지연 증가</td></tr><tr><td>Cache-Aside</td><td>트랜잭션 완료 이벤트로 무효화</td><td style=text-align:right>읽기 성능 최적화</td><td>무효화 지연 시 stale 읽기 가능</td></tr><tr><td>분산 캐시</td><td>여러 인스턴스 캐시 공유</td><td style=text-align:right>확장성</td><td>캐시 동기화, 네트워크 분할 대책</td></tr></tbody></table><ul><li>요약: 캐시 전략은 <strong>일관성 요구와 지연 민감도</strong>에 따라 선택해야 한다.</li></ul><h6 id=상태-관리감사-event-sourcing--event-store>상태 관리·감사 (Event Sourcing / Event Store)<a hidden class=anchor aria-hidden=true href=#상태-관리감사-event-sourcing--event-store>#</a></h6><p>이벤트소싱은 모든 상태 변화를 이벤트로 저장해 완전한 감사와 상태 재구성이 가능하다.<br>트랜잭션 경계에서 이벤트를 생성하여 이벤트스토어에 append 하고, 읽기 모델은 프로젝션으로 유지한다.<br>운영상 쿼리 성능을 위해 프로젝션 설계·관리, 이벤트 스키마 진화 전략이 필수다.</p><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th style=text-align:right>장점</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>Event Sourcing</td><td>모든 상태변화를 이벤트로 기록</td><td style=text-align:right>완전한 감사·time-travel</td><td>프로젝션 관리·스토리지 증가</td></tr><tr><td>Projection</td><td>이벤트 → 읽기 모델 생성</td><td style=text-align:right>빠른 쿼리 성능 제공</td><td>프로젝션 재빌드 비용</td></tr></tbody></table><ul><li>요약: 이벤트소싱은 규제·감사·디버깅에서 강력하지만 <strong>프로젝션·스토리지 설계</strong>가 필수다.</li></ul><h6 id=관찰성레질리언스-trace-id--apm--circuit-breaker>관찰성·레질리언스 (Trace ID / APM / Circuit Breaker)<a hidden class=anchor aria-hidden=true href=#관찰성레질리언스-trace-id--apm--circuit-breaker>#</a></h6><p>분산 트랜잭션 관리는 전역 추적과 장애 격리가 핵심이다.<br>요청에 Trace ID 를 부여해 모든 이벤트/메시지/로그에 전파하고, APM 으로 스팬을 수집한다.<br>Circuit Breaker, Bulkhead 로 장애 전파를 막고 자동 회복을 설계한다.</p><table><thead><tr><th>항목</th><th>도구/패턴</th><th style=text-align:right>장점</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>Trace ID / Distributed Tracing</td><td>Trace 헤더 전파 (Span 생성)</td><td style=text-align:right>루트코즈 빠름</td><td>헤더 전파 일관성 유지</td></tr><tr><td>APM / Metrics</td><td>지연·오류 모니터링</td><td style=text-align:right>SLA 관리</td><td>샘플링·오버헤드 고려</td></tr><tr><td>Circuit Breaker</td><td>서비스 보호 패턴</td><td style=text-align:right>장애 전파 차단</td><td>임계치·복구 정책 튜닝</td></tr></tbody></table><ul><li>요약: 관찰성은 <strong>문제 탐지·복구 속도</strong>를 결정하므로 설계 초기부터 통합해야 한다.</li></ul><h6 id=외부-시스템-어댑터-payment--kyc--erp--blockchain>외부 시스템 어댑터 (Payment / KYC / ERP / Blockchain)<a hidden class=anchor aria-hidden=true href=#외부-시스템-어댑터-payment--kyc--erp--blockchain>#</a></h6><p>외부 연계는 정산·규제·보안 이슈가 밀접하다.<br>어댑터는 재시도·타임아웃·결과 보증 (영수증, webhooks) 과 로그 보존을 설계해야 한다.<br>결제·KYC 는 규제 준수 (로그 보존, 암호화) 요구가 높아 별도의 감사 파이프라인이 필요하다.</p><table><thead><tr><th>항목</th><th>주요 요구사항</th><th style=text-align:right>구현 포인트</th><th>운영 고려사항</th></tr></thead><tbody><tr><td>결제 게이트웨이</td><td>가용성·안정성·보증</td><td style=text-align:right>영수증/확인, 재시도·타임아웃</td><td>규제·PCI 준수, 환불/보상 시나리오</td></tr><tr><td>KYC / 인증</td><td>신원확인·증적보관</td><td style=text-align:right>비동기 검증, 상태머신</td><td>개인정보 보호, 보존 정책</td></tr><tr><td>ERP/CRM 연동</td><td>배치/실시간 동기화</td><td style=text-align:right>API 어댑터, 메시지 보장</td><td>스키마 변동·속도 차이</td></tr><tr><td>블록체인 연동</td><td>불변 원장·검증</td><td style=text-align:right>트랜잭션 해시 저장</td><td>비용·확정성 지연 (컨펌)</td></tr></tbody></table><ul><li>요약: 외부 연계는 <strong>법적·시간적 특성</strong>을 반영한 상태머신·보상 설계가 핵심이다.</li></ul><h5 id=통합-연계-기술-개요표>통합 연계 기술 개요표<a hidden class=anchor aria-hidden=true href=#통합-연계-기술-개요표>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 기술</th><th>목적</th><th style=text-align:right>핵심 가치</th><th>운영 리스크</th></tr></thead><tbody><tr><td>메시징·이벤트 연계 (Outbox / MQ / Saga)</td><td>Outbox, MQ, Saga</td><td>데이터→이벤트 원자성, 분산 TX 조정</td><td style=text-align:right>신뢰성·확장성</td><td>중복·순서·보상 복잡도</td></tr><tr><td>데이터 동기화·파이프라인 (CDC / Replication)</td><td>CDC, Replication</td><td>DB 변경 실시간 전파</td><td style=text-align:right>레거시 통합·데이터 파이프라인</td><td>lag·스키마 진화 문제</td></tr><tr><td>읽기 최적화·캐시 통합 (Cache 전략)</td><td>Cache (Write-Through/Aside)</td><td>읽기 성능 개선</td><td style=text-align:right>낮은 응답시간</td><td>일관성/동기화 문제</td></tr><tr><td>상태 관리·감사 (Event Sourcing / Event Store)</td><td>Event Sourcing</td><td>완전한 감사·상태 재구성</td><td style=text-align:right>규정 준수·디버깅</td><td>프로젝션 관리 부담</td></tr><tr><td>관찰성·레질리언스 (Trace ID / APM / Circuit Breaker)</td><td>Trace/APM, Circuit Breaker</td><td>관찰성·장애격리</td><td style=text-align:right>빠른 문제해결·SLA 준수</td><td>오버헤드·정합성 유지</td></tr><tr><td>외부 시스템 어댑터 (Payment / KYC / ERP / Blockchain)</td><td>Payment/KYC/ERP/Blockchain</td><td>외부 비즈니스 연계</td><td style=text-align:right>법적 준수·정산</td><td>규제·지연·보안 리스크</td></tr></tbody></table><h3 id=운영-및-최적화>운영 및 최적화<a hidden class=anchor aria-hidden=true href=#운영-및-최적화>#</a></h3><h4 id=트랜잭션-관측성-메트릭로그트레이스-실무지침>트랜잭션 관측성 (메트릭·로그·트레이스) 실무지침<a hidden class=anchor aria-hidden=true href=#트랜잭션-관측성-메트릭로그트레이스-실무지침>#</a></h4><p>트랜잭션 관측성은 <strong>메트릭 (숫자)</strong>, <strong>로그 (텍스트 이벤트)</strong>, <strong>트레이스 (경로)</strong> 세 가지로 이뤄진다.</p><ul><li>메트릭은 성능·건강 상태를 빠르게 알려주고 (SLO 확인),</li><li>로그는 상세 원인 (쿼리·예외) 을 남기며,</li><li>트레이스는 여러 서비스로 흩어진 작업의 흐름을 보여준다.</li></ul><p>이 세 가지를 결합하면 " 어디가 병목이고 왜 실패했는지 " 를 빠르게 찾아 복구하거나 자동화 대응을 설계할 수 있다.</p><h5 id=트랜잭션-관측성-4-대-카테고리>트랜잭션 관측성 4 대 카테고리<a hidden class=anchor aria-hidden=true href=#트랜잭션-관측성-4-대-카테고리>#</a></h5><h6 id=트랜잭션-레벨-관측>트랜잭션 레벨 관측<a hidden class=anchor aria-hidden=true href=#트랜잭션-레벨-관측>#</a></h6><p>트랜잭션 단위의 핵심 지표를 수집해 SLA/SLO 를 확인하고 이상을 탐지한다.</p><ul><li><strong>무엇</strong>: <code>txn_start_total</code>, <code>txn_commit_total</code>, <code>txn_rollback_total</code>, <code>txn_duration_seconds</code>(histogram), <code>txn_active_gauge</code>, <code>txn_state_transition_duration</code></li><li><strong>왜</strong>: 트랜잭션 성공률·지연·활성 수는 서비스 품질의 직접 지표. SLO 위반 시 빠른 대응 필요.</li><li><strong>어떻게</strong>: 애플리케이션에서 각 트랜잭션 경계 (시작/종료/롤백) 에 메트릭 기록. Prometheus 히스토그램으로 p50/95/99 산출. 라벨은 <code>txn_type</code>, <code>service</code>, <code>db</code> 로 제한해 카디널리티 관리.</li></ul><table><thead><tr><th>지표</th><th style=text-align:right>설명</th><th>권장 레이블</th><th style=text-align:right>임계값 예시</th></tr></thead><tbody><tr><td>txn_commit_total</td><td style=text-align:right>커밋된 트랜잭션 총수</td><td>txn_type, service</td><td style=text-align:right>—</td></tr><tr><td>txn_rollback_total</td><td style=text-align:right>롤백된 트랜잭션 총수</td><td>txn_type, service</td><td style=text-align:right>급증 시 경고</td></tr><tr><td>txn_duration_seconds (hist)</td><td style=text-align:right>트랜잭션 지연 히스토그램</td><td>txn_type, service</td><td style=text-align:right>p95 > X ms → 경보</td></tr><tr><td>txn_active_gauge</td><td style=text-align:right>현재 활성 트랜잭션 수</td><td>service, db</td><td style=text-align:right>비정상적 증가 감지</td></tr></tbody></table><ul><li>요약: 트랜잭션 메트릭은 서비스 레벨 품질을 직접 보여준다. 라벨 설계·카디널리티 관리는 필수.</li></ul><h6 id=동시성락-관측>동시성·락 관측<a hidden class=anchor aria-hidden=true href=#동시성락-관측>#</a></h6><p>동시성 이슈 (락 경합·데드락) 는 성능 악화의 주요 원인이다. DB 와 애플리케이션 양쪽을 관측해야 한다.</p><ul><li><strong>무엇</strong>: <code>lock_wait_seconds</code>(histogram), <code>deadlock_total</code>, DB 락 스냅샷, 슬로우 쿼리 발생 빈도</li><li><strong>왜</strong>: 락 경합은 트랜잭션 지연·타임아웃·재시도 증가를 유발. 근본 원인 (잘못된 인덱스, 긴 트랜잭션 등) 탐색 필요.</li><li><strong>어떻게</strong>: DB 뷰 (예: <code>pg_locks</code>, <code>pg_stat_activity</code>) 주기 스냅샷, 애플리케이션에서 락 획득/대기 시간 로깅, 데드락 발생 시 쿼리 텍스트·스택 캡쳐.</li></ul><table><thead><tr><th>지표/로그</th><th style=text-align:right>설명</th><th>수집 방식</th><th>대응</th></tr></thead><tbody><tr><td>lock_wait_seconds</td><td style=text-align:right>락 획득 대기시간 분포</td><td>앱 + DB 뷰</td><td>긴 대기 시 쿼리 취소/튜닝</td></tr><tr><td>deadlock_total</td><td style=text-align:right>데드락 발생 횟수</td><td>DB 로그</td><td>빈발 시 설계 재검토</td></tr><tr><td>lock_owner</td><td style=text-align:right>락 소유자 정보</td><td>DB 스냅샷</td><td>롱 트랜잭션 종료 권고</td></tr></tbody></table><ul><li>요약: 락 관측은 실시간 스냅샷과 로그 결합으로 원인 분석이 가능하다. 데드락 빈발은 즉시 조치 대상.</li></ul><h6 id=로그-및-복구-관측>로그 및 복구 관측<a hidden class=anchor aria-hidden=true href=#로그-및-복구-관측>#</a></h6><p>로그/체크포인트/WAL 상태는 내구성·복구 능력의 핵심 지표다.</p><ul><li><strong>무엇</strong>: 슬로우 쿼리 로그, 재시도 원인 로그 (SerializationFailure), WAL 생성 속도/크기, 체크포인트 지속시간, 복구 시뮬레이션 결과</li><li><strong>왜</strong>: WAL 과 체크포인트 이상은 디스크·I/O 문제로 이어져 서비스 영향이 큼. 슬로우 쿼리는 전체 성능 저하 원인.</li><li><strong>어떻게</strong>: 중앙화 로그 파이프라인 (Fluentd → ES) 으로 이벤트 파싱, 주기적 복구 시뮬레이션 (자동화 스크립트), WAL/Checkpoint 메트릭 수집.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>설명</th><th>수집/검증 방법</th><th>조치 예시</th></tr></thead><tbody><tr><td>WAL rate</td><td style=text-align:right>초당 WAL 생성량</td><td>DB 메트릭 / 로그</td><td>체크포인트 주기 조정</td></tr><tr><td>checkpoint_duration</td><td style=text-align:right>체크포인트 작업 시간</td><td>DB 로그</td><td>I/O 튜닝, 스케줄 변경</td></tr><tr><td>slow_query</td><td style=text-align:right>긴 실행 쿼리 로그</td><td>슬로우 로그 수집</td><td>쿼리 리팩터링, 인덱스 추가</td></tr></tbody></table><ul><li>요약: 로그 기반 관측은 &rsquo; 데이터 안전성 &rsquo; 과 &rsquo; 성능 이슈 &rsquo; 모두에 직결된다. 정기 복구 테스트는 필수.</li></ul><h6 id=분산-트레이스-및-서비스-관측>분산 트레이스 및 서비스 관측<a hidden class=anchor aria-hidden=true href=#분산-트레이스-및-서비스-관측>#</a></h6><p>분산 환경에서 트랜잭션 흐름을 추적해 어느 서비스가 병목인지 파악.</p><ul><li><strong>무엇</strong>: 전체 트레이스 (Trace) 와 스팬 (Span) 별 지연, 서비스별 에러율, 네트워크 지연 영향</li><li><strong>왜</strong>: 마이크로서비스·분산 트랜잭션에서 문제 구간은 서비스 경계에 숨는다. 트레이스를 통해 호출 체인을 시각화해야 빠르게 원인 규명 가능.</li><li><strong>어떻게</strong>: OpenTelemetry 로 TraceContext 전파, Jaeger/Tempo 로 집계, 샘플링 규칙: 오류/슬로우 샘플은 100% 저장, 정상은 확률 샘플링.</li></ul><table><thead><tr><th>지표</th><th style=text-align:right>설명</th><th>도구/방법</th><th>활용</th></tr></thead><tbody><tr><td>trace_latency_p95</td><td style=text-align:right>분산트레이스 p95 지연</td><td>OpenTelemetry + Jaeger</td><td>서비스별 지연 기여도 파악</td></tr><tr><td>span_error_rate</td><td style=text-align:right>스팬 에러 비율</td><td>Tracing 플랫폼</td><td>오류 루트 서비스 식별</td></tr><tr><td>saga_latency</td><td style=text-align:right>Saga 전체 수행시간</td><td>트레이스 + 애플리케이션 메트릭</td><td>보상 필요성 판단</td></tr></tbody></table><ul><li>요약: 분산 트레이스는 서비스 책임 경계 파악에 필수. 샘플링 정책과 스팬 태깅 (예: saga.id, txn.id) 설계가 중요.</li></ul><h5 id=트랜잭션-관측성-통합-매트릭스>트랜잭션 관측성 통합 매트릭스<a hidden class=anchor aria-hidden=true href=#트랜잭션-관측성-통합-매트릭스>#</a></h5><table><thead><tr><th>카테고리</th><th style=text-align:right>핵심지표 예시</th><th>목적</th><th>수집·도구</th></tr></thead><tbody><tr><td>트랜잭션 레벨</td><td style=text-align:right>txn_commit_total, txn_rollback_total, txn_duration_seconds(p95)</td><td>SLA/SLO 모니터링, 성능 측정</td><td>앱 메트릭 (Prometheus), Grafana</td></tr><tr><td>동시성·락</td><td style=text-align:right>lock_wait_seconds, deadlock_total, pg_locks 스냅샷</td><td>경합·데드락 탐지</td><td>DB 뷰 + 앱 로그</td></tr><tr><td>로그·복구</td><td style=text-align:right>slow_query, WAL rate, checkpoint_duration</td><td>복구·디스크 문제 탐지, 쿼리 최적화</td><td>중앙화 로그 (ELK), 자동 복구 테스트</td></tr><tr><td>분산 트레이스</td><td style=text-align:right>trace_latency_p95, span_error_rate, saga_latency</td><td>분산 병목 파악, 서비스 책임 구분</td><td>OpenTelemetry + Jaeger/Tempo</td></tr></tbody></table><h4 id=트랜잭션-보안컴플라이언스-실무체계>트랜잭션 보안·컴플라이언스 실무체계<a hidden class=anchor aria-hidden=true href=#트랜잭션-보안컴플라이언스-실무체계>#</a></h4><p>트랜잭션 보안은 단일 조치로 끝나지 않고 여러 방어층을 합쳐야 안전하다.</p><ul><li>접근 제어 (RBAC/ABAC) 로 <strong>누가</strong> 무엇을 할 수 있는지 엄격히 관리한다.</li><li>모든 트랜잭션 이벤트는 <strong>변조 불가능한 감사 로그</strong>로 남겨 규제·포렌식에 대비한다.</li><li><strong>전송·저장 데이터는 암호화</strong>하고, 암호화 키는 안전하게 관리 (HSM/KMS) 한다.</li><li>규제 (PCI, GDPR, SOX) 는 자동화로 검증·보고하고, 증적을 보존한다.</li><li>운영 단계에서는 SIEM·알림·DR 리허설로 사고 대응 능력을 확보한다.</li></ul><p>이 모든 것을 통합해 <strong>증명가능한 (증적 보유) 트랜잭션 처리</strong>를 만드는 것이 목표다.</p><h5 id=트랜잭션-보안컴플라이언스-체계>트랜잭션 보안·컴플라이언스 체계<a hidden class=anchor aria-hidden=true href=#트랜잭션-보안컴플라이언스-체계>#</a></h5><h6 id=접근-제어-및-인증>접근 제어 및 인증<a hidden class=anchor aria-hidden=true href=#접근-제어-및-인증>#</a></h6><p>트랜잭션 실행 권한을 엄격히 관리하고, 고위험 트랜잭션에는 추가 인증 (다중요소, 디지털 서명) 을 요구한다.<br>서비스 - 서비스 통신은 mTLS 로 인증한다.<br>권한 변경은 승인 워크플로로 처리하고 모든 변경을 감사 로그로 남긴다.</p><table><thead><tr><th>항목</th><th>적용 방식</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>RBAC</td><td>역할별 권한 할당 (업데이트는 승인가 필요)</td><td>간편한 운영·권한 통제</td><td>역할 설계 실패 시 권한 남발</td></tr><tr><td>ABAC</td><td>속성 (시간/위치/장치) 기반 정책</td><td>세부 컨텍스트 제어</td><td>복잡한 정책 관리 필요</td></tr><tr><td>인증 (mTLS, OAuth2)</td><td>서비스 간 인증·토큰</td><td>서비스 신뢰성 확보</td><td>토큰 관리·수명 고려</td></tr><tr><td>트랜잭션 서명</td><td>중요 트랜잭션 서명 요구</td><td>부인방지·무결성 강화</td><td>키관리 부담</td></tr></tbody></table><ul><li>요약: 접근 통제는 <strong>누가 무엇을 언제 실행했는지 증명</strong>할 수 있게 하고, 권한 변경은 승인·감사로 묶어야 안전하다.</li></ul><h6 id=로그감사증적-관리>로그·감사·증적 관리<a hidden class=anchor aria-hidden=true href=#로그감사증적-관리>#</a></h6><p>트랜잭션 단계별 로그 (시작/쿼리/커밋/롤백/권한 체크) 를 변조 불가능하게 보관하고, SIEM 으로 연동해 실시간 이상탐지와 규제 리포팅을 자동화한다.</p><table><thead><tr><th>항목</th><th>적용 방식</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>무결성 로그 (해시체인)</td><td>로그에 순차해시/서명 추가</td><td>변조 탐지 가능</td><td>저장·검증 비용</td></tr><tr><td>중앙 SIEM</td><td>로그 집계·상관분석</td><td>이상탐지·포렌식 가능</td><td>노이즈 관리 필요</td></tr><tr><td>규제 리포트</td><td>규칙 기반 자동 리포트</td><td>감사 대응 용이</td><td>규칙 보수 필요</td></tr><tr><td>접근 통제 (로그)</td><td>로그 열람 권한 관리</td><td>증적 안전성 보장</td><td>운영 부하</td></tr></tbody></table><ul><li>요약: 로그는 단순 기록이 아니라 <strong>증거 (evidence)</strong> 로 다루며, 변조 방지·중앙분석·자동리포팅이 핵심이다.</li></ul><h6 id=암호화키관리>암호화·키관리<a hidden class=anchor aria-hidden=true href=#암호화키관리>#</a></h6><p>전송·저장·필드 수준 암호화를 적용하고, 키는 KMS/HSM 으로 관리하며 주기 회전과 접근 통제를 수행한다.</p><table><thead><tr><th>항목</th><th>적용 방식</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>전송암호화</td><td>TLS1.3 / mTLS</td><td>중간자 공격 방지</td><td>인증서 관리 필요</td></tr><tr><td>저장암호화</td><td>TDE + 컬럼암호화</td><td>데이터 유출 시 보호</td><td>복구·성능 고려</td></tr><tr><td>키관리</td><td>KMS/HSM, 키 회전</td><td>키 유출 예방</td><td>비용·운영 복잡</td></tr><tr><td>필드 마스킹</td><td>민감 필드 가리기</td><td>최소권한 노출 감소</td><td>마스킹 정책 관리</td></tr></tbody></table><ul><li>요약: 암호화는 <strong>데이터가 노출돼도 안전성</strong>을 확보하며, 키관리 (KMS/HSM) 가 전체의 핵심이다.</li></ul><h6 id=컴플라이언스-자동화보고>컴플라이언스 자동화·보고<a hidden class=anchor aria-hidden=true href=#컴플라이언스-자동화보고>#</a></h6><p>규제별 검증 로직을 자동화해 규정 준수 증적을 생산하고, 규제 감사에 대비한 보존·삭제 규칙을 운영한다.</p><table><thead><tr><th>항목</th><th>적용 방식</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>규칙 엔진</td><td>트랜잭션 단위 규칙 검증</td><td>실시간 규제 위반 방지</td><td>규칙 복잡성</td></tr><tr><td>자동 리포트</td><td>주기/이벤트 기반 리포트</td><td>감사 효율화</td><td>형식 표준화 필요</td></tr><tr><td>보존/삭제 정책</td><td>보존·삭제 자동화</td><td>GDPR 대응 용이</td><td>보존 요구 충족 검증 필요</td></tr><tr><td>증적 보관소</td><td>접근 제한된 WORM 스토리지</td><td>법적 증거 보존</td><td>비용 발생</td></tr></tbody></table><ul><li>요약: 컴플라이언스는 <strong>자동화로 증적을 만들고 보존</strong>해야 실무에서 유지·점검이 가능하다.</li></ul><h6 id=운영-보안사건-대응>운영 보안·사건 대응<a hidden class=anchor aria-hidden=true href=#운영-보안사건-대응>#</a></h6><p>SIEM·모니터링·알림과 사건 대응 플레이북, 정기 DR/PITR 리허설을 통해 사고 시 신속 복구와 규제 보고를 보장한다.</p><table><thead><tr><th>항목</th><th>적용 방식</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>SIEM·알림</td><td>실시간 상관분석·알람</td><td>조기경보</td><td>알람 튜닝 필요</td></tr><tr><td>사건 대응 PL</td><td>Playbook·온콜</td><td>신속 복구</td><td>정기 훈련 필요</td></tr><tr><td>DR·PITR 연습</td><td>분기·연간 리허설</td><td>실제 복구 능력 검증</td><td>리소스 소요</td></tr><tr><td>포렌식 스냅샷</td><td>시점 스냅샷 보관</td><td>증거 확보</td><td>개인정보 주의</td></tr></tbody></table><ul><li>요약: 운영 보안은 <strong>탐지 → 대응 → 복구</strong> 흐름을 반복적으로 연습해 신뢰도를 높여야 한다.</li></ul><h6 id=개발테스트배포-보안-secure-sdlc>개발·테스트·배포 보안 (Secure SDLC)<a hidden class=anchor aria-hidden=true href=#개발테스트배포-보안-secure-sdlc>#</a></h6><p>트랜잭션 코드의 취약점은 배포 전 제거해야 하므로 비밀관리·정적/동적 분석·계약 테스트·카오스 테스트를 통합한다.</p><table><thead><tr><th>항목</th><th>적용 방식</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>비밀관리</td><td>시크릿 매니저 사용</td><td>비밀 유출 감소</td><td>접근 관리 필요</td></tr><tr><td>코드스캔</td><td>SAST/DAST 자동화</td><td>취약점 조기 발견</td><td>오탐 관리</td></tr><tr><td>계약/통합 테스트</td><td>트랜잭션 계약 검증</td><td>통합 오류 감소</td><td>테스트 유지비</td></tr><tr><td>카오스/부하 테스트</td><td>장애 주입</td><td>복구 능력 검증</td><td>테스트 설계 중요</td></tr></tbody></table><ul><li>요약: Secure SDLC 는 <strong>사전에 문제를 제거</strong>해 운영 리스크를 크게 줄인다.</li></ul><h5 id=트랜잭션-보안컴플라이언스-한눈표>트랜잭션 보안·컴플라이언스 한눈표<a hidden class=anchor aria-hidden=true href=#트랜잭션-보안컴플라이언스-한눈표>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 통제</th><th>목적</th><th>주요 실무 항목</th></tr></thead><tbody><tr><td>접근 제어</td><td>RBAC/ABAC, mTLS, 트랜잭션 서명</td><td>무단 실행 방지</td><td>역할설계, 승인 워크플로, 서명정책</td></tr><tr><td>로그·감사</td><td>해시체인/WORM, SIEM</td><td>증거 보관·포렌식</td><td>변조방지 로그, 중앙수집, 리포트 자동화</td></tr><tr><td>암호화·키관리</td><td>TLS1.3, TDE, KMS/HSM</td><td>기밀성·무결성</td><td>키 회전·접근통제·필드암호화</td></tr><tr><td>컴플라이언스</td><td>규칙엔진, 자동리포트</td><td>규제 준수 증빙</td><td>SOX/PCI/GDPR 템플릿, 보존정책</td></tr><tr><td>운영 보안</td><td>SIEM, Playbook, DR 리허설</td><td>탐지·대응·복구</td><td>알림·온콜, RTO/RPO 리허설</td></tr><tr><td>SDLC 보안</td><td>SAST/DAST, 비밀관리</td><td>배포 전 결함 제거</td><td>코드스캔, 계약테스트, 카오스 실습</td></tr></tbody></table><h4 id=트랜잭션-성능확장성-계층별-실행-전략>트랜잭션 성능·확장성: 계층별 실행 전략<a hidden class=anchor aria-hidden=true href=#트랜잭션-성능확장성-계층별-실행-전략>#</a></h4><p>성능 최적화는 <strong>작게·덜 자주·빠르게</strong> 처리하는 것이 목표다.<br>트랜잭션을 작게 유지하고 (긴 트랜잭션 회피), 여러 커밋을 묶어 디스크 I/O 비용을 낮추며 (그룹 커밋), 읽기 부하는 복제나 캐시로 분산한다.<br>확장성은 <strong>데이터를 여러 노드로 나누는 샤딩</strong>, 읽기 전용 트래픽을 리플리카로 분산, 그리고 필요할 때 노드를 추가하는 수평 확장으로 달성한다.<br>모든 최적화는 <strong>일관성·내구성·지연</strong> 사이의 트레이드오프를 수반하므로, 핵심 데이터와 비핵심 데이터에 다른 전략을 적용하는 것이 실무 핵심이다.</p><h5 id=트랜잭션-성능확장성-계층별-전략>트랜잭션 성능·확장성 계층별 전략<a hidden class=anchor aria-hidden=true href=#트랜잭션-성능확장성-계층별-전략>#</a></h5><h6 id=트랜잭션-레벨-최적화>트랜잭션 레벨 최적화<a hidden class=anchor aria-hidden=true href=#트랜잭션-레벨-최적화>#</a></h6><p>트랜잭션 단위에서 처리량을 높이고 지연을 낮추는 기법들이다. 배치 커밋 (그룹 커밋) 은 여러 커밋을 묶어 WAL/디스크 동기화를 줄이고, 지연 커밋은 응답성을 개선한다. 트랜잭션 풀링 (객체 재사용) 으로 오버헤드를 낮추고, 트랜잭션을 가능한 짧게 유지해 잠금 보유 시간을 줄인다. 단, 배치·지연 커밋은 내구성/장애 모델과의 트레이드오프를 명확히 해야 한다.</p><table><thead><tr><th>기법</th><th>목적</th><th style=text-align:right>장점</th><th>단점/주의</th></tr></thead><tbody><tr><td>그룹 커밋</td><td>fsync 빈도 감소</td><td style=text-align:right>처리량 증가</td><td>대기시간 (지연) 증가</td></tr><tr><td>지연 커밋</td><td>응답성 개선</td><td style=text-align:right>빠른 응답</td><td>장애 시 데이터 손실 가능성</td></tr><tr><td>트랜잭션 풀링</td><td>오버헤드 감소</td><td style=text-align:right>리소스 재사용</td><td>구현 복잡성</td></tr></tbody></table><ul><li>트랜잭션 레벨 최적화는 I/O 비용을 묶고 트랜잭션 길이를 줄여 동시성 경쟁을 낮춘다. 적용 시 내구성·지연의 균형을 반드시 설계하라.</li></ul><h6 id=동시성잠금-전략>동시성·잠금 전략<a hidden class=anchor aria-hidden=true href=#동시성잠금-전략>#</a></h6><p>동시성 제어는 시스템 처리량과 일관성에 직접적 영향을 준다. MVCC 는 읽기 성능을 확보하면서 쓰기 충돌을 허용하고, 2PL 은 직렬화 보장에 강하지만 블로킹 위험이 있다. 잠금 분할, 낙관적 동시성 (OCC), 락 - 프리 자료구조 (CAS 등) 를 혼용해 워크로드 특성에 맞춰 적용한다. 데드락 탐지와 타임아웃 정책도 함께 설계해야 한다.</p><table><thead><tr><th>기법</th><th>적용대상</th><th style=text-align:right>장점</th><th>단점</th></tr></thead><tbody><tr><td>MVCC</td><td>읽기중심</td><td style=text-align:right>읽기 무잠금, 높은 동시성</td><td>버전 관리/가비지 수집</td></tr><tr><td>2PL(Strict)</td><td>쓰기 충돌 민감</td><td style=text-align:right>강한 일관성</td><td>블로킹/데드락</td></tr><tr><td>OCC</td><td>충돌 희박</td><td style=text-align:right>락 오버헤드 없음</td><td>충돌시 재시도 비용</td></tr></tbody></table><ul><li>동시성 전략은 워크로드 (읽기/쓰기 비율, 충돌 빈도) 에 맞춰 선택하라. 혼합 적용과 모니터링으로 동작을 검증해야 한다.</li></ul><h6 id=스토리지io-최적화>스토리지·I/O 최적화<a hidden class=anchor aria-hidden=true href=#스토리지io-최적화>#</a></h6><p>WAL·로그 배치를 최적화하고 체크포인트 주기를 조정하면 복구 시간 (RTO) 과 I/O 부하를 균형시킬 수 있다. 압축·쓰기 합치기 (write coalescing), SSD 튜닝, 파일시스템·블록 레벨 큐잉 튜닝으로 성능을 개선한다. 또한 로그 무결성 (append-only) 과 백업 스케줄을 운영 정책에 포함시켜야 한다.</p><table><thead><tr><th>기법</th><th>목적</th><th style=text-align:right>장점</th><th>단점</th></tr></thead><tbody><tr><td>WAL 배치/압축</td><td>디스크 I/O 감소</td><td style=text-align:right>fsync 비용 절감</td><td>CPU 오버헤드 (압축)</td></tr><tr><td>체크포인트 튜닝</td><td>복구 시간/IO 균형</td><td style=text-align:right>RTO 조절 가능</td><td>너무 잦으면 성능 저하</td></tr></tbody></table><ul><li>스토리지 최적화는 디스크 특성 (SSD/HDD) 과 로그 정책에 맞춰 조정해야 하며, 복구 시간과 성능의 균형을 지속 관찰하라.</li></ul><h6 id=데이터-분할-파티셔닝샤딩>데이터 분할 (파티셔닝/샤딩)<a hidden class=anchor aria-hidden=true href=#데이터-분할-파티셔닝샤딩>#</a></h6><p>데이터를 샤드로 나누어 저장하면 수평 확장이 가능하다. 해시 샤딩은 균등 분배에 유리하고, 범위 샤딩은 지역성 최적화에 유리하다. 샤드 키 선택, 리밸런싱 비용, 트랜잭션의 샤드 횡단 여부 (분산 트랜잭션 필요 여부) 를 사전에 설계해야 한다.</p><table><thead><tr><th>전략</th><th>장점</th><th style=text-align:right>단점</th><th>적용 포인트</th></tr></thead><tbody><tr><td>해시 샤딩</td><td>균등부하</td><td style=text-align:right>범위 쿼리 비효율</td><td>재배치 비용 고려</td></tr><tr><td>범위 샤딩</td><td>지역성 최적화</td><td style=text-align:right>핫스팟 위험</td><td>키 설계 중요</td></tr><tr><td>일관 해시</td><td>재배치 최소화</td><td style=text-align:right>구현 복잡성</td><td>노드 추가/제거 대응</td></tr></tbody></table><ul><li>샤딩은 설계 초기 결정 사항이다. 샤드 키와 리밸런싱 전략이 전체 시스템의 확장성·운영성을 좌우한다.</li></ul><h6 id=읽기-확장-리플리카캐싱>읽기 확장 (리플리카·캐싱)<a hidden class=anchor aria-hidden=true href=#읽기-확장-리플리카캐싱>#</a></h6><p>읽기 부하는 리플리카/캐시/Materialized View 로 분산한다. 캐시는 TTL·무효화 정책과 함께 사용하고, 리플리카는 복제 지연을 고려해 강일관성 필요 시 리더에서 읽게 설계한다. 캐시 히트율·캐시 일관성 지표를 모니터링한다.</p><table><thead><tr><th>기법</th><th>목적</th><th style=text-align:right>장점</th><th>단점</th></tr></thead><tbody><tr><td>읽기 리플리카</td><td>읽기 확장</td><td style=text-align:right>처리량 증가</td><td>복제 지연</td></tr><tr><td>분산 캐시</td><td>응답 시간 단축</td><td style=text-align:right>DB 부하 감소</td><td>캐시 무효화 복잡</td></tr><tr><td>Materialized View</td><td>복잡 쿼리 가속</td><td style=text-align:right>응답성 대폭 향상</td><td>실시간성 제한</td></tr></tbody></table><ul><li>읽기 확장은 비용 효율적이나 일관성 요구에 따라 설계가 달라진다. 캐시 무효화와 복제 지연 관리가 핵심이다.</li></ul><h6 id=인프라클러스터-확장>인프라·클러스터 확장<a hidden class=anchor aria-hidden=true href=#인프라클러스터-확장>#</a></h6><p>수평 확장은 노드 추가로 처리 능력을 올리는 방법이다. 오토스케일 정책, 리소스 오케스트레이션 (쿠버네티스), 서비스 디스커버리, 데이터 재배포 자동화가 필요하다. 장애 격리·리밸런싱 시 성능 저하를 방지할 수 있는 전략을 마련한다.</p><table><thead><tr><th>항목</th><th>목적</th><th style=text-align:right>장점</th><th>주의점</th></tr></thead><tbody><tr><td>오토스케일</td><td>수요 대응</td><td style=text-align:right>탄력적 자원 활용</td><td>재배치 지연·데이터 재분배 비용</td></tr><tr><td>클러스터링</td><td>가용성</td><td style=text-align:right>장애 격리</td><td>네트워크/일관성 복잡성</td></tr></tbody></table><ul><li>인프라 확장은 애플리케이션·데이터 레이어 변화와 연계되어야 하며, 자동화는 신중한 검증 후 적용하라.</li></ul><h6 id=운영자동화-aiops모니터링>운영·자동화 (AIOps·모니터링)<a hidden class=anchor aria-hidden=true href=#운영자동화-aiops모니터링>#</a></h6><p>성능 문제는 실시간 모니터링과 자동화 기반으로 조기 탐지·대응해야 한다. 지표 (throughput, p50/p95/p99 latency, queue length, fsync latency), 분산 트레이싱 (OpenTelemetry), 알람·자동 스케일·자동 리밸런싱을 결합해 운영 비용을 줄인다. AIOps 는 이상 감지·쿼리 추천에 유용하지만, 자동 작업 전 승인·롤백 메커니즘 필요.</p><table><thead><tr><th>항목</th><th>목적</th><th style=text-align:right>장점</th><th>고려사항</th></tr></thead><tbody><tr><td>지표·트레이싱</td><td>원인 분석</td><td style=text-align:right>빠른 문제 탐지</td><td>계측 비용</td></tr><tr><td>AIOps</td><td>자동화 권고/실행</td><td style=text-align:right>운영 효율화</td><td>안전장치 필요</td></tr></tbody></table><ul><li>운영 자동화는 문제 축소에 효과적이나, 자동 조치의 범위와 실패 대처를 명확히 정의해야 안전하다.</li></ul><h6 id=애플리케이션-설계-패턴-cqrs-배치-idempotency>애플리케이션 설계 패턴 (CQRS, 배치, Idempotency)<a hidden class=anchor aria-hidden=true href=#애플리케이션-설계-패턴-cqrs-배치-idempotency>#</a></h6><p>애플리케이션 레벨에서 CQRS(쓰기/읽기 분리), 배치 처리, 아이덴포턴시 (중복호출 안전) 설계를 적용하면 전체 시스템의 성능·확장성을 높인다. 특히 분산 환경에서는 Outbox 패턴과 Saga 를 조합해 메시지 유실과 중복을 관리한다.</p><table><thead><tr><th>패턴</th><th>목적</th><th>장점</th><th>단점</th></tr></thead><tbody><tr><td>CQRS</td><td>읽기/쓰기 분리</td><td>각 경로 최적화</td><td>설계 복잡성</td></tr><tr><td>Outbox + CDC</td><td>이벤트 일관성</td><td>원자성 보장</td><td>인프라 복잡성</td></tr><tr><td>Idempotency</td><td>중복 안전</td><td>재시도 안전화</td><td>키 설계 필요</td></tr></tbody></table><ul><li>애플리케이션 패턴은 DB·인프라 최적화와 결합될 때 가장 효과적이다. 중복·정합성 정책을 초기에 설계하라.</li></ul><h5 id=트랜잭션-성능확장성-핵심-요약표>트랜잭션 성능·확장성 핵심 요약표<a hidden class=anchor aria-hidden=true href=#트랜잭션-성능확장성-핵심-요약표>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 기법</th><th>목적</th><th style=text-align:right>주요 장점</th><th>주요 고려사항</th></tr></thead><tbody><tr><td>트랜잭션 레벨</td><td>그룹 커밋, 지연 커밋</td><td>I/O 감소·응답성</td><td style=text-align:right>처리량 향상</td><td>내구성·지연 트레이드오프</td></tr><tr><td>동시성 제어</td><td>MVCC, 2PL, OCC</td><td>동시성 향상/일관성 보장</td><td style=text-align:right>워크로드 최적화</td><td>데드락/재시도 관리</td></tr><tr><td>스토리지 최적화</td><td>WAL 배치, 체크포인트</td><td>I/O·복구 최적화</td><td style=text-align:right>RTO/성능 균형</td><td>압축·CPU 비용</td></tr><tr><td>데이터 분할</td><td>샤딩 (해시/범위)</td><td>수평 확장</td><td style=text-align:right>저장·처리 확장</td><td>리밸런싱 복잡</td></tr><tr><td>읽기 확장</td><td>리플리카, 캐시</td><td>읽기 처리량 증가</td><td style=text-align:right>응답성 개선</td><td>복제 지연·캐시 무효화</td></tr><tr><td>인프라 확장</td><td>클러스터, 오토스케일</td><td>탄력적 처리능력</td><td style=text-align:right>수요 대응</td><td>재배치 비용</td></tr><tr><td>운영·자동화</td><td>OpenTelemetry, AIOps</td><td>문제 탐지·자동화</td><td style=text-align:right>운영 효율화</td><td>자동화 안전장치 필요</td></tr><tr><td>애플리케이션 패턴</td><td>CQRS, Outbox, Idempotency</td><td>설계 차원 성능 향상</td><td style=text-align:right>중복·정합성 관리</td><td>설계·운영 복잡성</td></tr></tbody></table><h4 id=트랜잭션-장애-대응-및-복구-운영체계>트랜잭션 장애 대응 및 복구 운영체계<a hidden class=anchor aria-hidden=true href=#트랜잭션-장애-대응-및-복구-운영체계>#</a></h4><ul><li><p><strong>무엇이 문제인가?</strong><br>트랜잭션이 시스템의 일관성·동시성·복구를 보장하지만, 잘못 설계·운영하면 데드락·성능저하·디스크고갈·불일치 같은 장애가 발생한다.</p></li><li><p><strong>왜 발생하나?</strong><br>리소스 (락·디스크·네트워크) 를 오래 점유하거나, 분산 환경에서 상태 동기화가 실패하거나, 로그 관리가 미흡하기 때문.</p></li><li><p><strong>핵심 대응 (우선순위)</strong></p><ol><li><strong>짧은 트랜잭션</strong>: TX 를 작게 쪼개라.</li><li><strong>일관된 락 정책</strong>: 락 순서 표준화 + 타임아웃.</li><li><strong>로그 관리</strong>: WAL/체크포인트 튜닝 + 아카이빙.</li><li><strong>분산 트랜잭션 회피/설계</strong>: saga 등 비동기/보상 모델 고려.</li><li><strong>모니터링</strong>: TX 지속시간·lock wait·WAL 사용량을 실시간 경보로 연결하라.</li></ol></li></ul><h5 id=트랜잭션-장애-대응-핵심-체계>트랜잭션 장애 대응 핵심 체계<a hidden class=anchor aria-hidden=true href=#트랜잭션-장애-대응-핵심-체계>#</a></h5><h6 id=데드락--락-관리>데드락 & 락 관리<a hidden class=anchor aria-hidden=true href=#데드락--락-관리>#</a></h6><p><strong>핵심 내용</strong></p><ul><li><strong>원인</strong>: 락 획득 순서 불일치, 교착 (순환) 발생.</li><li><strong>진단</strong>: wait-for 그래프 (사이클 탐지), DB deadlock 로그, 장기 대기 트랜잭션 모니터링.</li><li><strong>해결 전략 (우선순위)</strong>:<ol><li><strong>락 순서 규칙화</strong>: 모든 코드에 동일한 자원 획득 순서 적용.</li><li><strong>짧은 트랜잭션 유지</strong>: 사용자 대기 중 트랜잭션 열지 않기.</li><li><strong>타임아웃 설정</strong>: lock/txn timeout 으로 무한 대기 차단.</li><li><strong>탐지·복구</strong>: 이벤트 기반 대기 그래프 검사 → 희생자 선정 (비용·우선순위 기준) → 롤백.</li><li><strong>특수 회피</strong>: 사전 요구량 선언이 가능한 환경에서 Banker&rsquo;s algorithm 고려 (실무에서는 제한적).</li></ol></li></ul><table><thead><tr><th>항목</th><th style=text-align:right>진단 지표</th><th>우선 대응</th><th>장기 대책</th></tr></thead><tbody><tr><td>데드락 탐지</td><td style=text-align:right>wait-for 그래프, deadlock 로그</td><td>락 순서 표준화, 타임아웃</td><td>코드 리뷰·락 설계 개선</td></tr><tr><td>희생자 선정</td><td style=text-align:right>트랜잭션 비용/중요도</td><td>자동 롤백 (저비용 우선)</td><td>트랜잭션 비용 산정 지표</td></tr></tbody></table><ul><li>데드락은 <strong>순환 대기</strong> 문제로, 즉시 예방 (락 순서·짧은 TX) 과 타임아웃을 기본으로 하고, 탐지 후 희생자 롤백으로 복구한다.</li></ul><h6 id=긴-트랜잭션과-동시성-제어>긴 트랜잭션과 동시성 제어<a hidden class=anchor aria-hidden=true href=#긴-트랜잭션과-동시성-제어>#</a></h6><p><strong>핵심 내용</strong></p><ul><li><strong>원인</strong>: 사용자 입력 대기, 대용량 작업을 단일 TX 로 처리 → 락 장기 보유.</li><li><strong>진단</strong>: TX 지속시간 모니터, lock wait 길이, 처리량 저하.</li><li><strong>해결 전략</strong>:<ol><li><strong>분해</strong>: 큰 작업을 작은 트랜잭션으로 분리.</li><li><strong>비동기화</strong>: 큐/이벤트로 비핵심 작업 분리 (보상 트랜잭션 사용).</li><li><strong>타임아웃·알림</strong>: 장시간 TX 감지 시 알림·자동 조치.</li><li><strong>DB 기능 활용</strong>: snapshot isolation, row-versioning 등으로 읽기 영향 완화.</li></ol></li></ul><table><thead><tr><th>항목</th><th style=text-align:right>진단 지표</th><th>단기 대응</th><th>권장 패턴</th></tr></thead><tbody><tr><td>장시간 TX</td><td style=text-align:right>TX duration > threshold</td><td>알림, 강제 종료 (심각시)</td><td>트랜잭션 분해, saga 패턴</td></tr><tr><td>사용자 대기 TX</td><td style=text-align:right>사용자 상호작용 시 열려있는 TX</td><td>트랜잭션 제거</td><td>비동기 처리, 보상 트랜잭션</td></tr></tbody></table><ul><li>긴 트랜잭션은 동시성 파괴의 주요 원인이다. <strong>분해·비동기화·타임아웃</strong>이 핵심 해법이다.</li></ul><h6 id=로그-wal-및-디스크-관리>로그 (WAL) 및 디스크 관리<a hidden class=anchor aria-hidden=true href=#로그-wal-및-디스크-관리>#</a></h6><p><strong>핵심 내용</strong></p><ul><li><strong>원인</strong>: 과도한 쓰기, 체크포인트 미조정 → WAL 급증/디스크 소진.</li><li><strong>진단</strong>: WAL 디렉터리 사이즈, 체크포인트 빈도/경고, 디스크 사용률.</li><li><strong>해결 전략</strong>:<ol><li><strong>아카이빙·순환</strong>: 오래된 WAL 자동 아카이브·압축.</li><li><strong>체크포인트 튜닝</strong>: <code>max_wal_size</code>, <code>checkpoint_timeout</code> 등 조정.</li><li><strong>모니터링/예측 알림</strong>: 디스크 임계치 사전 경보.</li><li><strong>운영 정책</strong>: 보관 기간·복구 RTO 목표에 맞춘 아카이브 정책 수립.</li></ol></li></ul><table><thead><tr><th>항목</th><th style=text-align:right>진단 지표</th><th>즉각 대응</th><th>권장 설정</th></tr></thead><tbody><tr><td>WAL 급증</td><td style=text-align:right>WAL 디렉터리 증가율</td><td>아카이브 실행</td><td><code>max_wal_size</code>, <code>checkpoint_timeout</code> 조정</td></tr><tr><td>디스크 포화</td><td style=text-align:right>Disk used% > threshold</td><td>아카이브/확장</td><td>압축 아카이빙, 스토리지 증설</td></tr></tbody></table><ul><li>WAL 관리는 복구와 연관되므로 임의 삭제 금지. <strong>아카이브·체크포인트 튜닝·모니터링</strong>이 필수다.</li></ul><h6 id=분산-트랜잭션-2pc--복구>분산 트랜잭션 (2PC) & 복구<a hidden class=anchor aria-hidden=true href=#분산-트랜잭션-2pc--복구>#</a></h6><p><strong>핵심 내용</strong></p><ul><li><strong>원인</strong>: 네트워크/코디네이터 장애, PREPARE 상태 불확실성.</li><li><strong>진단</strong>: PREPARED 오래 유지, 참여자 로그 불일치, 코디네이터 로그 상태.</li><li><strong>해결 전략</strong>:<ol><li><strong>코디네이터 우선 점검</strong>: coordinator log 에서 txn 상태 확인 → COMMITTED 이면 참여자에 강제 COMMIT.</li><li><strong>타임아웃/정리 정책</strong>: PREPARED 장기 지속 시 보수적 ABORT 규칙 (서비스 정책에 따름).</li><li><strong>대체 패턴</strong>: 가능하면 saga(보상 트랜잭션) 또는 idempotent 설계로 2PC 회피.</li><li><strong>관측성 확보</strong>: 트랜잭션별 코디네이터·참여자 로그 연계 및 조회 API 마련.</li></ol></li></ul><table><thead><tr><th>항목</th><th style=text-align:right>진단 지표</th><th>즉각 대응</th><th>장기 대책</th></tr></thead><tbody><tr><td>PREPARED 블록</td><td style=text-align:right>PREPARED 상태 지속</td><td>코디네이터 로그 확인, 참여자 쿼리</td><td>saga/보상 패턴 도입</td></tr><tr><td>네트워크 파티션</td><td style=text-align:right>일부 참여자 응답 없음</td><td>보수적 ABORT</td><td>재시도/재동기화 절차</td></tr></tbody></table><ul><li>2PC 는 <strong>블로킹 특성</strong>이 있어 코디네이터·참여자 로그 기반의 명확한 복구 프로세스와 대체 설계 (사가 등) 가 필요하다.</li></ul><h6 id=모니터링경보복구-오케스트레이션>모니터링·경보·복구 오케스트레이션<a hidden class=anchor aria-hidden=true href=#모니터링경보복구-오케스트레이션>#</a></h6><p><strong>핵심 내용</strong></p><ul><li><strong>구성요소</strong>: 트랜잭션 추적 (상태/소요시간), 락/대기 모니터, WAL/디스크 모니터, 분산 TX 로그 집계, 알림 (임계치 기반), 자동 스크립트 (강제 롤백 등).</li><li><strong>권장 흐름</strong>: 메트릭 수집 → 임계치 기반 알림 → 자동화 (저비용 희생자 롤백 등) → 수동 복구 절차 문서화.</li><li><strong>운영 원칙</strong>: 가시성 우선 (트랜잭션 tracing), 자동화는 안전한 범위부터 (경고→반응), 복구 절차는 runbook 으로 문서화.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>핵심 메트릭</th><th>자동화 가능성</th><th>우선 구축 순서</th></tr></thead><tbody><tr><td>TX 가시성</td><td style=text-align:right>TX duration, state</td><td>알림, 강제 종료</td><td>TX 추적 먼저</td></tr><tr><td>락 모니터</td><td style=text-align:right>lock wait, blockers</td><td>알림, 희생자 롤백</td><td>락 모니터 연동</td></tr><tr><td>WAL 모니터</td><td style=text-align:right>WAL size, archive lag</td><td>자동 아카이브</td><td>아카이브 파이프라인</td></tr></tbody></table><ul><li>모니터링은 문제 발견뿐 아니라 <strong>자동 복구/수동 절차의 트리거</strong>다. 핵심 메트릭을 먼저 수집하고 runbook 으로 복구 흐름을 표준화하라.</li></ul><h5 id=트랜잭션-문제대응-요약표>트랜잭션 문제·대응 요약표**<a hidden class=anchor aria-hidden=true href=#트랜잭션-문제대응-요약표>#</a></h5><table><thead><tr><th>카테고리</th><th>주요 원인</th><th style=text-align:right>진단 지표</th><th>즉시 대응</th><th>권장 장기 대책</th></tr></thead><tbody><tr><td>데드락 & 락 관리</td><td>락 순서 불일치, 순환 대기</td><td style=text-align:right>wait-for 그래프, deadlock 로그</td><td>락 순서 표준화, 타임아웃, 희생자 롤백</td><td>코드수정·락 설계 개선</td></tr><tr><td>긴 트랜잭션</td><td>사용자 대기, 대용량 단일 TX</td><td style=text-align:right>TX duration, lock wait</td><td>알림, 분해·강제 종료 (심각)</td><td>분해·비동기화·saga 패턴</td></tr><tr><td>WAL/디스크</td><td>높은 쓰기량, 체크포인트 미조정</td><td style=text-align:right>WAL size, checkpoint warnings</td><td>아카이브, 임시 스토리지 확보</td><td>체크포인트 튜닝·압축 아카이브</td></tr><tr><td>분산 TX(2PC)</td><td>네트워크/코디네이터 장애</td><td style=text-align:right>PREPARED 지속, 로그 불일치</td><td>코디네이터 로그 확인, 강제 COMMIT/ROLLBACK</td><td>saga 도입, 재동기화 프로세스</td></tr><tr><td>모니터링·복구</td><td>가시성 부족</td><td style=text-align:right>메트릭·알림 결여</td><td>핵심 메트릭 수집 시작</td><td>자동화·runbook 표준화</td></tr></tbody></table><h3 id=고급-주제-및-미래-전망>고급 주제 및 미래 전망<a hidden class=anchor aria-hidden=true href=#고급-주제-및-미래-전망>#</a></h3><h4 id=분산-트랜잭션-도전과제-총괄>분산 트랜잭션 도전과제 총괄<a hidden class=anchor aria-hidden=true href=#분산-트랜잭션-도전과제-총괄>#</a></h4><p>분산 시스템에서는 <em>모든 걸 동시에 완벽히 보장할 수 없다</em>는 것이 핵심이다.<br>네트워크가 불완전한 상태에서 데이터를 동기화하려면 추가 통신 (라운드트립) 이 필요하고, 이는 지연을 만든다.<br>대안으로는</p><ol><li>강한 일관성을 위해 비용을 지불하거나</li><li>가용성과 저지연을 택하고 <strong>점진적 일관성 (이벤트→보상)</strong> 을 설계하는 것이 있다.</li></ol><p>실무에서는 Spanner 처럼 특수 하드웨어·시간 동기화로 일부 문제를 완화하거나, Saga·Outbox 로 분산 작업을 보상형으로 설계해 현실적인 균형을 맞춘다.</p><h5 id=분산-트랜잭션-주요-도전-과제>분산 트랜잭션 주요 도전 과제<a hidden class=anchor aria-hidden=true href=#분산-트랜잭션-주요-도전-과제>#</a></h5><h6 id=일관성지연-consistency-vs-latency>일관성·지연 (Consistency Vs Latency)<a hidden class=anchor aria-hidden=true href=#일관성지연-consistency-vs-latency>#</a></h6><p>설명:</p><ul><li>글로벌 서비스에서 &rsquo; 강한 일관성 &rsquo; 을 유지하려면 노드 간 동기화가 필요하고, 그 과정에서 지연이 발생한다. CAP 이론은 네트워크 분할 상황에서 일관성·가용성 중 하나를 포기해야 함을 본질적으로 보여준다.</li><li>문제: 단건 트랜잭션의 latency 증가, 사용성/UX 저하</li><li>결과: p99 지연 악화, 사용자 경험 저하, 일부 리전에서 서비스 불능 가능</li><li>원인: 네트워크 RTT, 라운드트립 요구, 동기적 확인 (leader-based commit)</li><li>해결책: 지역적 로컬화 (local reads), 약한 일관성 (최종적 일관성) 도입, 특정 경로만 강일관성 적용, Spanner 처럼 정밀 시간으로 타임스탬프 동기화 (비용 고려).</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>핵심 문제</th><th>권장 대응</th></tr></thead><tbody><tr><td>일관성 vs 지연</td><td style=text-align:right>강일관성은 지연을 낳음</td><td>로컬 리드/선택적 강일관성/사양화</td></tr></tbody></table><ul><li>요약: 비즈니스별 강일관성 요구를 선별하고 나머지는 약한 일관성으로 처리해 지연을 제어한다.</li></ul><h6 id=합의다중리전-drconsensus--multi-region-dr>합의·다중리전 DR(Consensus & Multi-region DR)<a hidden class=anchor aria-hidden=true href=#합의다중리전-drconsensus--multi-region-dr>#</a></h6><p>설명: Paxos/Raft 같은 합의 알고리즘은 복원력을 제공하지만 추가 통신과 리더 의존성 때문에 단건 지연과 운영복잡도를 올린다. 대규모 다중리전 DR 은 스토리지·시간 동기화 (예: TrueTime) 문제로 비용·구현 난이도가 크다.</p><ul><li>문제: 리더 장애·네트워크 분할 시 블로킹, 복구 정책 복잡성</li><li>결과: 운영비 증가, DR 설계·테스트 복잡도 상승</li><li>원인: 합의 라운드트립, 하드웨어 의존성 (정밀 시계)</li><li>해결책: 리더 장애 자동화 (rapid failover), 지역별 읽기/쓰기로 분리, 재해복구 시나리오 정기 검증, 필요 시 하이브리드 모델 도입 (부분적 sync + async 복제).</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>핵심 문제</th><th>권장 대응</th></tr></thead><tbody><tr><td>합의·DR</td><td style=text-align:right>합의 비용·운영 복잡성</td><td>자동화·테스트·하이브리드 복제</td></tr></tbody></table><ul><li>요약: 합의 기반 아키텍처는 강력하지만 비용·운영 복잡성을 함께 고려해 적용 범위를 한정해야 한다.</li></ul><h6 id=실시간-스트리밍트랜잭션-streaming-vs-transactions>실시간 스트리밍·트랜잭션 (Streaming Vs Transactions)<a hidden class=anchor aria-hidden=true href=#실시간-스트리밍트랜잭션-streaming-vs-transactions>#</a></h6><p>설명: 스트림 처리 (밀리초 단위) 는 전통 트랜잭션의 배치적, 동기적 모델과 충돌한다. exactly-once 보장은 체크포인트·아이덴포턴시·리플레이 대비를 필요로 한다.</p><ul><li>문제: 처리량 요구와 exactly-once·순서 보장 사이의 균형</li><li>결과: 처리 지연 또는 구현 복잡도 상승</li><li>원인: 상태 동기화·중복 처리 방지 로직 필요</li><li>해결책: 마이크로배치, 체크포인트 기반 커밋, idempotent 처리, 외부 상태 스토어 (쓰기 - 원자성 설계).</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>핵심 문제</th><th>권장 대응</th></tr></thead><tbody><tr><td>스트리밍 트랜잭션</td><td style=text-align:right>exactly-once 구현 비용</td><td>마이크로배치 + idempotency</td></tr></tbody></table><ul><li>요약: 실시간 성능 목표가 높으면 트랜잭션 의미론을 완화하고 idempotent 설계로 보완한다.</li></ul><h6 id=상태관리운영-state-management--operability>상태관리·운영 (State Management & Operability)<a hidden class=anchor aria-hidden=true href=#상태관리운영-state-management--operability>#</a></h6><p>설명: 컨테이너 오케스트레이션·마이크로서비스 환경에서는 트랜잭션 상태·사가 상태·아웃박스 큐 등 영속성이 중요하다.</p><ul><li>문제: 컨테이너 재시작·스케일링 시 진행중 트랜잭션·사가의 복구·이관 복잡성</li><li>결과: 운영 수동 개입 증가, RTO/RPO 악화</li><li>원인: 로컬 상태 의존, 관측성 부족, 표준화된 복구 runbook 부재</li><li>해결책: 상태 외부화 (etcd/Redis/DB), saga state table, 체계적 모니터링·알림·자동 재시작/재처리 정책 마련.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>핵심 문제</th><th>권장 대응</th></tr></thead><tbody><tr><td>상태관리·운영</td><td style=text-align:right>진행중 상태의 이동성 부족</td><td>상태 외부화 + saga table + 자동화</td></tr></tbody></table><ul><li>요약: 상태를 외부화하고 사가 상태·outbox 를 이용해 재시작·복구 시나리오를 자동화해야 한다.</li></ul><h5 id=분산-트랜잭션-도전-과제-요약표>분산 트랜잭션 도전 과제 요약표<a hidden class=anchor aria-hidden=true href=#분산-트랜잭션-도전-과제-요약표>#</a></h5><table><thead><tr><th>카테고리</th><th style=text-align:right>주요 도전</th><th style=text-align:right>원인 (요약)</th><th>권장 대응</th></tr></thead><tbody><tr><td>일관성·지연</td><td style=text-align:right>저지연과 강일관성 동시 충족 불가</td><td style=text-align:right>CAP 트레이드오프, RTT</td><td>지역화/선택적 강일관성, Spanner 식 대안 (비용 고려)</td></tr><tr><td>합의·다중리전 DR</td><td style=text-align:right>합의 비용·운영 복잡성</td><td style=text-align:right>Paxos/Raft 라운드트립, TrueTime 비용</td><td>자동화·하이브리드 복제·DR 테스트</td></tr><tr><td>스트리밍·트랜잭션</td><td style=text-align:right>exactly-once vs throughput</td><td style=text-align:right>체크포인트·아이덴포턴시 필요</td><td>마이크로배치·idempotency·외부 상태</td></tr><tr><td>상태관리·운영</td><td style=text-align:right>진행중 상태 이동·복구 어려움</td><td style=text-align:right>컨테이너 라이프사이클, 관측성 부족</td><td>상태 외부화·사가 테이블·자동화</td></tr></tbody></table><ul><li>요약: 모든 대응은 <strong>비즈니스 요구 (지연·일관성·가용성 우선순위)</strong> 에 맞춰 선택되어야 하며, 정량적 계측 (지연, TPS, p99) 과 운영 자동화가 핵심이다.</li></ul><h4 id=2025-트랜잭션-기술-로드맵-핵심축>2025 트랜잭션 기술 로드맵 핵심축<a hidden class=anchor aria-hidden=true href=#2025-트랜잭션-기술-로드맵-핵심축>#</a></h4><p>2025 년의 트랜잭션 기술 흐름은 " 속도·지능·신뢰·표준 " 에 맞춰진다.<br>실시간 결제 인프라가 늘고, AI 가 이상감지·운영 자동화를 담당하며, ISO 20022 같은 표준화가 교차국 경로를 정비한다.<br>CBDC 는 일부 국가에서 실험·확장 중이며, 분산 시스템 수준에서는 **Hybrid Logical Clock(HLC)**나 <strong>Serializable Snapshot Isolation(SSI)</strong> 같은 기법이 시간·직렬성 문제를 더 현실적으로 해결하려는 방향으로 발전하고 있다.<br>이 모든 통합은 Outbox/CDC/이벤트소싱·분산 추적을 통해 시스템 간 일관성과 관찰성을 확보하려는 실무적 노력과 맞닿아 있다.</p><h5 id=트랜잭션-최신-기술-5-대-축>트랜잭션 최신 기술 5 대 축<a hidden class=anchor aria-hidden=true href=#트랜잭션-최신-기술-5-대-축>#</a></h5><h6 id=실시간-결제정산-인프라-rtp--fednow--instant-payments>실시간 결제·정산 인프라 (RTP / FedNow / Instant Payments)<a hidden class=anchor aria-hidden=true href=#실시간-결제정산-인프라-rtp--fednow--instant-payments>#</a></h6><p><strong>설명</strong>:</p><ul><li>은행 간·국내 결제의 즉시성 요구가 확대되어 RTP·FedNow 같은 인프라가 거래량·가치를 급성장시키고 있다.</li><li>실무적 영향은 정산 지연 제거, UX 개선, 운영·리스크 모델 재설계 (실시간 리스크평가 필요) 이다.</li></ul><table><thead><tr><th>항목</th><th>의미</th><th style=text-align:right>실무 가치</th><th>고려사항</th></tr></thead><tbody><tr><td>RTP / Instant Payments</td><td>즉시 결제 네트워크</td><td style=text-align:right>즉시 정산, UX 개선</td><td>실시간 리스크·자금흐름 관리 필요</td></tr><tr><td>정산 모델 변화</td><td>T+N → real-time</td><td style=text-align:right>유동성·CP 관리 변화</td><td>은행간 자금흐름 재설계</td></tr></tbody></table><ul><li>요약: 즉시 결제는 운영·리스크 체계를 실시간으로 바꾸므로 트랜잭션 파이프라인·모니터링 재설계가 필수다.</li></ul><h6 id=aiml-기반-모니터링자동화-fraudamladaptive-ops>AI·ML 기반 모니터링·자동화 (Fraud/AML/Adaptive Ops)<a hidden class=anchor aria-hidden=true href=#aiml-기반-모니터링자동화-fraudamladaptive-ops>#</a></h6><p><strong>설명</strong>:</p><ul><li>이상거래 탐지·알림 분류·위험 점수화에 AI 가 핵심으로 자리잡고 있다.</li><li>모델 품질·데이터 완전성·설명가능성 (XAI)·규제 (감사 증빙) 가 실무 도입의 관건이다.</li></ul><table><thead><tr><th>항목</th><th>적용영역</th><th style=text-align:right>장점</th><th>리스크</th></tr></thead><tbody><tr><td>거래 이상탐지 (ML)</td><td>실시간 모니터링</td><td style=text-align:right>탐지 정밀도 향상</td><td>데이터 편향·설명성 요구</td></tr><tr><td>적응형 운영</td><td>동적 격리·튜닝</td><td style=text-align:right>성능 최적화</td><td>오탐·법규적 책임 문제</td></tr></tbody></table><ul><li>요약: AI 는 운영 효율과 탐지력을 높이지만 <strong>데이터·설명성·규제</strong>를 함께 설계해야 실무에서 효과적이다.</li></ul><h6 id=표준화규제cbdc-iso20022--swift-gpi--cbdc>표준화·규제·CBDC (ISO20022 / SWIFT GPI / CBDC)<a hidden class=anchor aria-hidden=true href=#표준화규제cbdc-iso20022--swift-gpi--cbdc>#</a></h6><p><strong>설명</strong>:</p><ul><li>ISO 20022 마이그레이션과 GPI 추적 표준이 교차국 결제의 상호운용성을 개선하고, CBDC 는 국가별 결제·정책의 미래 인프라로 시험되고 있다.</li><li>실무적으로는 메시지 맵핑·레거시 호환·법규 준수가 중요하다.</li></ul><table><thead><tr><th>항목</th><th>핵심</th><th style=text-align:right>가치</th><th>운영 영향</th></tr></thead><tbody><tr><td>ISO 20022</td><td>표준 메시지 포맷</td><td style=text-align:right>풍부한 메타데이터·추적성</td><td>변환·맵핑 비용</td></tr><tr><td>CBDC</td><td>중앙은행 발행 디지털 통화</td><td style=text-align:right>결제 혁신·정책 도구</td><td>규제·프라이버시 설계</td></tr></tbody></table><ul><li>요약: 표준화는 상호운용성·추적성을 높이고, CBDC 는 정책·결제 모델을 재정의한다—둘 다 운영 부담을 수반한다.</li></ul><h6 id=데이터이벤트-통합-outbox--cdc--event-sourcing>데이터·이벤트 통합 (Outbox / CDC / Event Sourcing)<a hidden class=anchor aria-hidden=true href=#데이터이벤트-통합-outbox--cdc--event-sourcing>#</a></h6><p><strong>설명</strong>:</p><ul><li>데이터 변경과 이벤트의 일관성 확보 (Outbox), DB 로그 기반 파이프라인 (CDC), 그리고 이벤트 소싱 (완전 감사) 이 트랜잭션 생명주기와 결합해 확장성과 관찰성을 높인다.</li></ul><table><thead><tr><th>항목</th><th>패턴</th><th style=text-align:right>장점</th><th>운영 요소</th></tr></thead><tbody><tr><td>Outbox</td><td>트랜잭션 내 메시지 기록</td><td style=text-align:right>데이터·이벤트 불일치 감소</td><td>Poller·idempotency</td></tr><tr><td>CDC</td><td>DB 로그 → 이벤트</td><td style=text-align:right>레거시 통합 쉬움</td><td>lag·스키마 관리</td></tr><tr><td>Event Sourcing</td><td>이벤트 원장화</td><td style=text-align:right>완전 감사·재구성</td><td>프로젝션 관리</td></tr></tbody></table><ul><li>요약: Outbox+CDC 는 실무에서 널리 쓰이며, 이벤트소싱은 감사·복잡 도메인에 유리하다.</li></ul><h6 id=분산-시간일관성-기법-hlc--ssi--hybrid-time>분산 시간·일관성 기법 (HLC / SSI / Hybrid Time)<a hidden class=anchor aria-hidden=true href=#분산-시간일관성-기법-hlc--ssi--hybrid-time>#</a></h6><p><strong>설명</strong>:</p><ul><li>TrueTime 처럼 엄격한 물리 시계가 없을 때 HLC 가 실무적 대안으로 쓰이며, SSI(Serializable Snapshot Isolation) 는 스냅샷 기반으로 직렬성 보장을 현실성 있게 제공한다.</li><li>분산 트랜잭션 설계·스냅샷 읽기·버전 관리에서 실무적 가치를 제공한다.</li></ul><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th style=text-align:right>장점</th><th>도입 고려사항</th></tr></thead><tbody><tr><td>HLC</td><td>물리 + 논리 시계 결합</td><td style=text-align:right>시계 의존성 완화·원활한 스냅샷</td><td>구현 복잡도</td></tr><tr><td>SSI</td><td>스냅샷으로 직렬성 제공</td><td style=text-align:right>낮은 오버헤드로 강일관성</td><td>재시도 정책 필요</td></tr></tbody></table><ul><li>요약: 클라우드·분산 환경에서 HLC·SSI 는 현실적 타임스탬핑·직렬화 해법으로 중요도가 상승 중이다.</li></ul><h5 id=트랜잭션-최신기술-통합표-2025>트랜잭션 최신기술 통합표 (2025)<a hidden class=anchor aria-hidden=true href=#트랜잭션-최신기술-통합표-2025>#</a></h5><table><thead><tr><th>축</th><th>핵심 기술/패턴</th><th style=text-align:right>얻는 가치</th><th>실무 리스크/과제</th></tr></thead><tbody><tr><td>실시간</td><td>RTP / instant payments</td><td style=text-align:right>즉시 정산·UX 개선</td><td>리스크 실시간 차단 필요 (유동성 관리)</td></tr><tr><td>지능화</td><td>AI/ML 이상탐지·적응 운영</td><td style=text-align:right>탐지 정밀도·자동화</td><td>데이터 품질·설명성·규제 이슈</td></tr><tr><td>표준·정책</td><td>ISO20022 / CBDC</td><td style=text-align:right>상호운용성·정책 도구</td><td>변환·법적·프라이버시 이슈</td></tr><tr><td>통합·데이터</td><td>Outbox / CDC / Event Sourcing</td><td style=text-align:right>일관성·관찰성·파이프라인</td><td>lag·중복·프로젝션 관리</td></tr><tr><td>분산 일관성</td><td>HLC / SSI / Hybrid Time</td><td style=text-align:right>현실적 타임스탬프·직렬성</td><td>구현·운영 복잡도</td></tr></tbody></table><h4 id=트랜잭션-대안-기술별-장단점-매트릭스>트랜잭션 대안 기술별 장단점 매트릭스<a hidden class=anchor aria-hidden=true href=#트랜잭션-대안-기술별-장단점-매트릭스>#</a></h4><ul><li><p><strong>무엇이 다른가?</strong></p><ul><li>기존 트랜잭션 (ACID/DB 트랜잭션) 은 &rsquo; 즉시적 일관성 &rsquo; 을 목표로 한다.</li><li>대안들은 &rsquo; 어떻게 분산·동시성·감사·확장 문제를 다룰까 &rsquo; 에 따라 갈라진다:<ul><li>이벤트 소싱 = 모든 상태 변화를 이벤트로 남겨 재구성/감사에 유리.</li><li>CRDT/OT = 충돌을 수학적으로 (또는 변환으로) 해결해 동시성 문제 대응.</li><li>분산 SQL(Spanner) = 전역적으로 강일관성을 유지하는 데이터베이스 선택.</li><li>블록체인 = 불변성·탈중앙·검증 가능한 트랜잭션 보장.</li></ul></li></ul></li><li><p><strong>언제 어떤 걸 선택하나?</strong></p><ul><li>감사·시점 복원이 중요하면 Event Sourcing.</li><li>실시간 협업·오프라인 동기화면 OT/CRDT.</li><li>글로벌 트랜잭션·강일관성 필요하면 Spanner 류.</li><li>탈중앙·토큰화·검증이 핵심이면 블록체인 계열.</li></ul></li></ul><h5 id=트랜잭션-대안-기술-분류-체계>트랜잭션 대안 기술 분류 체계<a hidden class=anchor aria-hidden=true href=#트랜잭션-대안-기술-분류-체계>#</a></h5><h6 id=이력감사-중심-event-sourcing--cqrs--outbox>이력·감사 중심 (Event Sourcing / CQRS / Outbox)<a hidden class=anchor aria-hidden=true href=#이력감사-중심-event-sourcing--cqrs--outbox>#</a></h6><p><strong>내용</strong>:</p><ul><li>상태를 직접 저장하지 않고 변경 이벤트를 append-only 이벤트스토어에 기록한다.</li><li>읽기 모델은 이벤트를 비동기로 재구성 (CQRS).</li><li>Transactional Outbox 는 RDB 변경과 메시지 발행을 원자적으로 처리하는 실무 패턴.<br><strong>장점</strong>:</li><li>완전한 감사 추적</li><li>시점 복원</li><li>읽기/쓰기 분리로 확장성 개선.<br><strong>단점</strong>:</li><li>이벤트 스토어 크기 증가</li><li>이벤트 리플레이 복잡성</li><li>최종일관성 처리와 스키마 진화 문제.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>장점</th><th style=text-align:right>단점</th><th>적용 사례</th></tr></thead><tbody><tr><td>Event Sourcing</td><td style=text-align:right>완전한 이력·감사, 시점복원</td><td style=text-align:right>리플레이·스토리지 비용, 복잡성</td><td>금융 감사·규제 로그</td></tr><tr><td>CQRS</td><td style=text-align:right>읽기/쓰기 최적화</td><td style=text-align:right>모델 동기화 복잡</td><td>읽기중심 대시보드</td></tr><tr><td>Transactional Outbox</td><td style=text-align:right>DB 변경 + 메시지 원자성</td><td style=text-align:right>추가 테이블·운영 복잡</td><td>마이크로서비스 메시징</td></tr></tbody></table><ul><li>요약: 감사를 최우선으로 하거나 읽기·쓰기 분리가 필요한 시스템에서 강력한 선택지. 리플레이·운영 비용을 설계 단계에서 치밀히 다뤄야 한다.</li></ul><h6 id=실시간-동시성-해결-ot--crdt>실시간 동시성 해결 (OT / CRDT)<a hidden class=anchor aria-hidden=true href=#실시간-동시성-해결-ot--crdt>#</a></h6><p><strong>내용</strong>:</p><ul><li>OT 는 연산 변환으로 실시간 편집 충돌을 조정한다.</li><li>CRDT 는 수학적 병합 함수를 통해 충돌 없는 상태 병합을 보장한다.</li><li>두 방법 모두 최종적으로 모든 복제본이 수렴하도록 설계됨.<br><strong>장점</strong>:</li><li>오프라인/동시 업데이트에서 높은 사용자 경험 (실시간 협업) 제공</li><li>네트워크 분단 저항성.<br><strong>단점</strong>:</li><li>복잡한 자료구조·연산 설계</li><li>일부 비즈니스 규칙 적용 한계 (복잡한 불변식 유지 어려움).</li></ul><table><thead><tr><th>기술</th><th style=text-align:right>장점</th><th style=text-align:right>단점</th><th>적용 사례</th></tr></thead><tbody><tr><td>OT</td><td style=text-align:right>직관적 실시간 조정</td><td style=text-align:right>구현 복잡도</td><td>Google Docs 류 편집기</td></tr><tr><td>CRDT</td><td style=text-align:right>병합 무결성 (자동)</td><td style=text-align:right>설계·메모리 비용</td><td>공동편집, IoT 집계</td></tr></tbody></table><ul><li>요약: 사용자 경험 (실시간 동시 편집) 최우선이면 OT/CRDT 를 고려. 트랜잭션식 불변식은 별도 보정 필요.</li></ul><h6 id=전역-강일관성-db-spanner-류>전역 강일관성 DB (Spanner 류)<a hidden class=anchor aria-hidden=true href=#전역-강일관성-db-spanner-류>#</a></h6><p><strong>내용</strong>:</p><ul><li>전역 분산 환경에서 외부 일관성 (외부적으로 직렬화된 일관된 타임라인) 을 제공하는 상용/매니지드 DB.</li><li>내부적으로 동기 복제·분산 시계 (타임 API) 등을 사용해 강일관성을 보장.<br><strong>장점</strong>:</li><li>SQL·트랜잭션 모델 유지하면서 글로벌 확장과 강일관성 확보.<br><strong>단점</strong>:</li><li>비용, 운영 복잡성 (네트워크·지연 설계)</li><li>일부 레이턴시 트레이드오프.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>장점</th><th style=text-align:right>단점</th><th>적용 사례</th></tr></thead><tbody><tr><td>Spanner 류</td><td style=text-align:right>전역 강일관성 + SQL</td><td style=text-align:right>비용·복잡성</td><td>글로벌 결제·원장 시스템</td></tr></tbody></table><ul><li>요약: 글로벌 트랜잭션·외부 일관성이 핵심 요구라면 Spanner 류가 현실적 대안. 비용/운영을 반드시 예산에 반영해야 함.</li></ul><h6 id=탈중앙불변성-플랫폼-블록체인--dlt>탈중앙·불변성 플랫폼 (블록체인 / DLT)<a hidden class=anchor aria-hidden=true href=#탈중앙불변성-플랫폼-블록체인--dlt>#</a></h6><p><strong>내용</strong>:</p><ul><li>탈중앙 합의로 거래를 검증·기록하는 구조.</li><li>네트워크 설계 (합의 알고리즘) 에 따라 처리량·확정성·비용 특성이 크게 달라짐 (예: Solana 고처리량 설계).<br><strong>장점</strong>:</li><li>불변성·투명성·검증 가능성</li><li>탈중앙 신뢰 모델.<br><strong>단점</strong>:</li><li>성능·비용·규제 (데이터 삭제, 개인정보) 문제.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>장점</th><th style=text-align:right>단점</th><th>적용 사례</th></tr></thead><tbody><tr><td>블록체인/DLT</td><td style=text-align:right>불변성·검증 가능</td><td style=text-align:right>처리량·규제·비용 문제</td><td>토큰화 결제, 탈중앙 거래소</td></tr></tbody></table><ul><li>요약: 탈중앙·검증이 사업의 핵심 가치라면 블록체인 고려. 일반 트랜잭션 대체제로는 신중한 검토 필요.</li></ul><h6 id=상용-통합-솔루션-결제계약관리-등>상용 통합 솔루션 (결제·계약관리 등)<a hidden class=anchor aria-hidden=true href=#상용-통합-솔루션-결제계약관리-등>#</a></h6><p><strong>내용</strong>:</p><ul><li>Stripe, PayPal, Icertis 등 표준화된 API·플랫폼을 통해 빠르게 기능을 도입.<br><strong>장점</strong>:</li><li>구현 속도·운영 이점 (가동·업데이트·규제 준수 지원).<br><strong>단점</strong>:</li><li>비용·커스터마이징 제약·데이터 주권 이슈.</li></ul><table><thead><tr><th>항목</th><th style=text-align:right>장점</th><th style=text-align:right>단점</th><th>적용 사례</th></tr></thead><tbody><tr><td>결제 플랫폼</td><td style=text-align:right>빠른 도입·운영 편의</td><td style=text-align:right>수수료·종속</td><td>결제 처리, 정산</td></tr><tr><td>계약관리 SaaS</td><td style=text-align:right>계약 자동화·AI 보조</td><td style=text-align:right>커스터마이징 한계</td><td>엔터프라이즈 계약업무</td></tr></tbody></table><ul><li>요약: 경쟁 솔루션은 시간·운영 부담을 줄여주지만 장기 비용·종속성은 설계에서 계산 필요.</li></ul><h5 id=대안-기술솔루션-비교-매트릭스>대안 기술·솔루션 비교 매트릭스<a hidden class=anchor aria-hidden=true href=#대안-기술솔루션-비교-매트릭스>#</a></h5><table><thead><tr><th>카테고리</th><th style=text-align:right>핵심 장점</th><th style=text-align:right>핵심 제약</th><th>권장 적용 조건</th></tr></thead><tbody><tr><td>Event Sourcing / CQRS</td><td style=text-align:right>완전한 감사·시점복원</td><td style=text-align:right>리플레이·스토리지 비용, 최종일관성</td><td>감사·복원·이력 핵심 도메인</td></tr><tr><td>OT / CRDT</td><td style=text-align:right>동시성·오프라인 강점</td><td style=text-align:right>구현 복잡·도메인 규칙 한계</td><td>실시간 협업·오프라인 동기화</td></tr><tr><td>Spanner 류 (분산 SQL)</td><td style=text-align:right>전역 강일관성 + SQL</td><td style=text-align:right>비용·네트워크·운영 난도</td><td>글로벌 트랜잭션·원장</td></tr><tr><td>블록체인 / DLT</td><td style=text-align:right>불변성·탈중앙 신뢰</td><td style=text-align:right>처리량·규제·비용</td><td>탈중앙 자산·검증 필요시</td></tr><tr><td>SaaS 통합 솔루션</td><td style=text-align:right>빠른 도입·운영 편의</td><td style=text-align:right>비용·종속성</td><td>비핵심 기능 외주화</td></tr></tbody></table><hr><h2 id=최종-정리-및-학습-가이드>최종 정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#최종-정리-및-학습-가이드>#</a></h2><h3 id=내용-종합>내용 종합<a hidden class=anchor aria-hidden=true href=#내용-종합>#</a></h3><p>트랜잭션은 여러 조작을 하나의 논리 단위로 묶어 시스템을 일관된 상태로 유지하는 메커니즘이다.</p><p>전통적으로 ACID(원자성·일관성·격리성·지속성) 가 설계 지침이며, 시스템 장애 시 로그 기반 복구 (Write-Ahead Logging + ARIES 같은 알고리즘) 가 트랜잭션 일관성을 복원한다.</p><p>분산 환경에서는 여러 자원 간의 전역 커밋을 위해 2PC 같은 프로토콜이 쓰이나, 코디네이터 장애·성능 저하 같은 현실적 한계 때문에 마이크로서비스 환경에서는 Saga 패턴 (작업을 작은 로컬 트랜잭션으로 나누고 보상으로 정합성 회복) 과 Transactional Outbox(트랜잭션 내부에 이벤트를 기록해 메시지 전송의 원자성을 확보) 같은 대체·보완 패턴이 널리 채택된다.</p><p>운영 차원에서는 분산 트레이싱 (OpenTelemetry), SLO 기반 모니터링, 로그의 무결성·보존, 그리고 암호화·토큰화·키관리 정책이 함께 작동해야 규정 준수·사고 대응·비즈니스 연속성을 달성할 수 있다.</p><p>설계 시 핵심 결정은 &rsquo; 어떤 데이터에 강일관성을 적용할지 &rsquo; 이며, 이 기준에 따라 성능·가용성·운영복잡성의 트레이드오프를 의도적으로 관리한다.</p><h3 id=실무-적용-가이드>실무 적용 가이드<a hidden class=anchor aria-hidden=true href=#실무-적용-가이드>#</a></h3><table><thead><tr><th>단계</th><th style=text-align:right>핵심 항목</th><th>목적</th><th>수행 방법 (요약)</th><th>검증 지표</th></tr></thead><tbody><tr><td>요구분석</td><td style=text-align:right>비즈니스 불변식 도출</td><td>핵심 일관성 정의</td><td>도메인 인터뷰 → 테스트 케이스화</td><td>불변식 커버율 (테스트)</td></tr><tr><td>요구분석</td><td style=text-align:right>일관성 수준 결정</td><td>설계 선택 근거 제공</td><td>서비스별 Strong/Eventual 맵핑</td><td>각 서비스 일관성 SLA</td></tr><tr><td>설계</td><td style=text-align:right>트랜잭션 모델 선택</td><td>적절한 아키텍처 확보</td><td>ACID / Saga / Outbox 비교·선택</td><td>실패 시 복구 시나리오 검증</td></tr><tr><td>설계</td><td style=text-align:right>격리 수준 정책</td><td>동시성·정합성 균형</td><td>기본값 정의 + 예외 절차 문서화</td><td>이상 현상 (Dirty/Phantom) 발생률</td></tr><tr><td>설계</td><td style=text-align:right>Idempotency 설계</td><td>중복 처리 방지</td><td>키 포맷·보관·TTL 정의</td><td>중복 반영 건수 (0 목표)</td></tr><tr><td>구현</td><td style=text-align:right>Outbox + 이벤트 발행</td><td>DB 트랜잭션 & 이벤트 일관성</td><td>DB 내 Outbox 테이블 + 워커</td><td>Outbox 큐 지연/실패 건수</td></tr><tr><td>구현</td><td style=text-align:right>재시도 · 타임아웃 정책</td><td>안정적 재시도·비동기 복구</td><td>미들웨어 표준화 (중복 방지 포함)</td><td>재시도 성공률, tail latency</td></tr><tr><td>테스트</td><td style=text-align:right>카오스·부하 테스트</td><td>복구능력 검증</td><td>장애 주입 테스트, p99 측정</td><td>RTO/RPO, p99 목표 달성 여부</td></tr><tr><td>운영</td><td style=text-align:right>모니터링·알림</td><td>문제 조기 탐지</td><td>대시보드 (p50/p95/p99, 롤백률 등)</td><td>알림 발생 수·응답시간</td></tr><tr><td>운영</td><td style=text-align:right>PITR/DR 리허설</td><td>재해 복구 능력 확보</td><td>분기별 리허설 · RTO 측정</td><td>성공적 복구 여부, RTO</td></tr><tr><td>확장</td><td style=text-align:right>샤딩·CQRS 설계</td><td>처리량·가용성 확보</td><td>파티셔닝 설계·읽기 복제 적용</td><td>스케일아웃 후 TPS 증가율</td></tr><tr><td>보안/규제</td><td style=text-align:right>감사로그·암호화</td><td>규제 준수·신뢰 확보</td><td>감사 정책·KMS 적용</td><td>컴플라이언스 체크리스트 통과</td></tr></tbody></table><h3 id=학습-로드맵>학습 로드맵<a hidden class=anchor aria-hidden=true href=#학습-로드맵>#</a></h3><table><thead><tr><th>단계 (기간)</th><th>학습 주제 (주요 항목)</th><th>학습 목표</th><th style=text-align:right>실무 연관성</th><th>권장 실습/평가</th></tr></thead><tbody><tr><td><strong>초급 1: 기본 (4 주)</strong></td><td>트랜잭션·ACID·상태 모델, SQL 트랜잭션 (BEGIN/COMMIT/ROLLBACK)</td><td>트랜잭션 개념·생명주기 이해</td><td style=text-align:right>모든 DB 기반 서비스의 기본</td><td>로컬 DB 로 계좌 이체 예제 (커밋/롤백)</td></tr><tr><td><strong>초급 2: 동시성 기초 (4 주)</strong></td><td>격리수준 (RU/RC/RR/SI/Serializable), 더티·리피트·팬텀 현상</td><td>격리 수준별 동작·위험 인지</td><td style=text-align:right>웹앱 동시성 이해·디버깅</td><td>두 트랜잭션 동시 실행 재현 실험</td></tr><tr><td><strong>핵심 3: 로그·복구 (4 주)</strong></td><td>WAL, 체크포인트, ARIES(analysis/redo/undo)</td><td>내구성·복구 메커니즘 이해</td><td style=text-align:right>RTO/RPO 설계 기초</td><td>WAL 기반 크래시 - 복구 실습</td></tr><tr><td><strong>핵심 4: 동시성 제어 (4 주)</strong></td><td>2PL, MVCC, OCC, 데드락 분석</td><td>적합한 제어 기법 선택·적용</td><td style=text-align:right>성능·정합성 튜닝</td><td>Postgres MVCC 관찰·데드락 시뮬</td></tr><tr><td><strong>중급 5: 분산 트랜잭션 (8 주)</strong></td><td>2PC/3PC, Saga, Outbox/Inbox, CDC</td><td>분산 일관성 패턴 설계·비교</td><td style=text-align:right>마이크로서비스·분산 시스템 설계</td><td>간단한 서비스에서 Outbox+ 멱등 구현</td></tr><tr><td><strong>중급 6: 운영·튜닝 (8 주)</strong></td><td>체크포인트·로그 정책, GC/vacuum, 모니터링</td><td>운영 파라미터 튜닝·운영 대응</td><td style=text-align:right>RTO/RPO 달성·실무 운영</td><td>Chaos 실습 (재시작·로그 손상 복구)</td></tr><tr><td><strong>고급 7: 장기·대규모 (12 주)</strong></td><td>장기 트랜잭션 보상, 파티셔닝·샤딩, 실시간 스트리밍</td><td>글로벌 확장·실시간 요구 대응</td><td style=text-align:right>대형 시스템·금융·전자상거래</td><td>파티셔닝 전략 벤치·스트리밍 통합 실습</td></tr><tr><td><strong>고급 8: 최신·연구 (지속)</strong></td><td>SSI, HLC, 블록체인 스마트컨트랙트, AI 기반 최적화</td><td>최신 기법 이해·실험</td><td style=text-align:right>특정 도메인·혁신적 적용</td><td>연구 논문 실습·프로토타입 제작</td></tr></tbody></table><h3 id=학습-항목>학습 항목<a hidden class=anchor aria-hidden=true href=#학습-항목>#</a></h3><table><thead><tr><th>단계</th><th>항목</th><th style=text-align:right>중요도</th><th>학습 목표</th><th style=text-align:right>실무 연관성</th><th>설명</th><th>권장 실습</th></tr></thead><tbody><tr><td>초급 1</td><td>ACID / 트랜잭션 상태</td><td style=text-align:right>필수</td><td>트랜잭션 본질·상태 설명</td><td style=text-align:right>모든 DB 서비스</td><td>원자성·일관성·격리성·내구성 개념</td><td>계좌 이체 예제</td></tr><tr><td>초급 1</td><td>상태 전이 (FSM)</td><td style=text-align:right>필수</td><td>생명주기 모델링</td><td style=text-align:right>디버깅·감사</td><td>상태·전이·가드 개념</td><td>mermaid 로 상태도 작성</td></tr><tr><td>초급 2</td><td>격리 수준 (RU/RC/RR/SI/Serializable)</td><td style=text-align:right>필수</td><td>이상현상 식별·선택</td><td style=text-align:right>트랜잭션 설계</td><td>각각의 발생 조건·해결책</td><td>동시성 재현 실험</td></tr><tr><td>초급 2</td><td>기본 락 메커니즘</td><td style=text-align:right>필수</td><td>락 유형·영향 이해</td><td style=text-align:right>데드락 진단</td><td>공유·배타락 개념</td><td>멀티스레드 락 시뮬</td></tr><tr><td>핵심 3</td><td>WAL / Checkpoint</td><td style=text-align:right>필수</td><td>내구성·복구 원리 습득</td><td style=text-align:right>RTO/RPO 설계</td><td>선기록 원리와 체크포인트 효과</td><td>WAL 복구 시나리오 실습</td></tr><tr><td>핵심 3</td><td>ARIES 복구 알고리즘</td><td style=text-align:right>필수</td><td>analysis/redo/undo 이해</td><td style=text-align:right>장애 복구 설계</td><td>LSN·undo-next 개념</td><td>로그 샘플로 복구 시연</td></tr><tr><td>핵심 4</td><td>MVCC</td><td style=text-align:right>필수</td><td>스냅샷 동작·GC 이해</td><td style=text-align:right>조회 성능 최적화</td><td>버전 관리·vacuum 필요성</td><td>Postgres MVCC 실험</td></tr><tr><td>핵심 4</td><td>2PL / OCC</td><td style=text-align:right>필수</td><td>제어 방식 비교·선택</td><td style=text-align:right>성능·정합성 균형</td><td>락 vs 낙관적 검증</td><td>데드락·재시도 실험</td></tr><tr><td>중급 5</td><td>2PC / 3PC</td><td style=text-align:right>권장</td><td>분산 커밋 프로토콜 이해</td><td style=text-align:right>강일관성 분산 DB</td><td>코디네이터·참가자 모델</td><td>시뮬레이션 구현</td></tr><tr><td>중급 5</td><td>Saga / Outbox / CDC</td><td style=text-align:right>필수</td><td>비동기 보상 패턴 설계</td><td style=text-align:right>마이크로서비스 연계</td><td>보상 트랜잭션·멱등성</td><td>Outbox 구현 + Consumer dedupe</td></tr><tr><td>중급 6</td><td>모니터링·지표</td><td style=text-align:right>필수</td><td>전환 규칙·알람 설계</td><td style=text-align:right>자동화 운영</td><td>충돌률·상태 카운트 등</td><td>Prometheus/Grafana 대시보드</td></tr><tr><td>중급 6</td><td>운영 튜닝</td><td style=text-align:right>필수</td><td>체크포인트·vacuum·로그 튜닝</td><td style=text-align:right>RTO/RPO·성능</td><td>튜닝 파라미터별 영향 이해</td><td>튜닝 전/후 벤치마크</td></tr><tr><td>고급 7</td><td>샤딩·파티셔닝</td><td style=text-align:right>권장</td><td>확장 전략 설계</td><td style=text-align:right>대규모 서비스</td><td>데이터 이동·거래 범위 관리</td><td>샤드 설계 실습</td></tr><tr><td>고급 7</td><td>장기 트랜잭션/보상</td><td style=text-align:right>필수</td><td>보상 전략·타임아웃 설계</td><td style=text-align:right>장기 업무 프로세스</td><td>수동개입·상태 보존 설계</td><td>보상 시나리오 구현</td></tr><tr><td>고급 8</td><td>SSI/HLC/최신연구</td><td style=text-align:right>선택</td><td>최신 직렬화/분산 기법 이해</td><td style=text-align:right>대규모 분산 최적화</td><td>이론 + 연구 적용 가능성</td><td>논문 리뷰·프로토타입</td></tr></tbody></table><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어 (한글 (영어 풀네임, 약어))</th><th>정의</th><th>관련 개념</th><th>실무 활용</th></tr></thead><tbody><tr><td>핵심</td><td>트랜잭션 (Transaction, Tx)</td><td>논리적으로 연관된 연산의 원자적 실행 단위</td><td>ACID, 커밋/롤백</td><td>결제·주문·DB 연산 경계 설정</td></tr><tr><td>핵심</td><td>ACID (Atomicity/Consistency/Isolation/Durability, ACID)</td><td>트랜잭션의 원자성·일관성·격리성·지속성 집합</td><td>WAL, 격리수준</td><td>시스템 신뢰성 요구 정의</td></tr><tr><td>핵심</td><td>생명주기 (Lifecycle, Lc)</td><td>트랜잭션의 시작→실행→커밋/롤백까지 단계 흐름</td><td>상태머신, 워크플로우</td><td>트랜잭션 모니터링·오케스트레이션</td></tr><tr><td>구현</td><td>WAL (Write-Ahead Logging, WAL)</td><td>변경을 디스크에 반영하기 전에 로그에 먼저 기록하는 기법</td><td>LSN, 체크포인트, ARIES</td><td>장애 복구·내구성 보장</td></tr><tr><td>구현</td><td>ARIES (Algorithms for Recovery and Isolation Exploiting Semantics, ARIES)</td><td>로그 기반 복구 (Analysis→Redo→Undo) 알고리듬</td><td>LSN, CLR, Checkpoint</td><td>DB 복구 로직 설계</td></tr><tr><td>구현</td><td>LSN (Log Sequence Number, LSN)</td><td>로그 레코드의 순차 식별자</td><td>WAL, REDO/UNDO</td><td>복구시점 판단·로그 스캔 기준</td></tr><tr><td>구현</td><td>CLR (Compensation Log Record, CLR)</td><td>Undo 수행 기록 (보상 로그)</td><td>ARIES, UNDO</td><td>역실행 (Undo) 안전성 보장</td></tr><tr><td>동시성</td><td>2PL (Two-Phase Locking, 2PL)</td><td>성장·축소 단계로 락을 관리해 직렬성 보장</td><td>S/X 락, 데드락</td><td>쓰기경쟁 많은 OLTP</td></tr><tr><td>동시성</td><td>MVCC (Multi-Version Concurrency Control, MVCC)</td><td>여러 버전으로 읽기 - 쓰기 충돌 회피</td><td>스냅샷, Vacuum/GC</td><td>읽기 비차단 워크로드</td></tr><tr><td>동시성</td><td>OCC (Optimistic Concurrency Control, OCC)</td><td>실행 후 검증하여 충돌시 재시도</td><td>읽기/쓰기 세트, 재시도</td><td>충돌 드문 환경 (폼 편집 등)</td></tr><tr><td>동시성</td><td>타임스탬프 순서 (Timestamp Ordering, TS)</td><td>트랜잭션에 타임스탬프로 순서 결정 (데드락 없음)</td><td>TrueTime / Lamport</td><td>글로벌 시계 가능한 분산 DB</td></tr><tr><td>분산</td><td>2PC (Two-Phase Commit, 2PC)</td><td>Prepare→Commit 단계로 전역원자성 보장</td><td>코디네이터, 참가자</td><td>금융·강일관성 필요 분산 트랜잭션</td></tr><tr><td>분산</td><td>3PC (Three-Phase Commit, 3PC)</td><td>2PC 의 블로킹 완화 시도 (복잡성↑)</td><td>비차단성 개입</td><td>특수 환경 (운영 복잡성 고려)</td></tr><tr><td>분산</td><td>합의 (Consensus: Raft/Paxos, Raft/Paxos)</td><td>레플리카 간 일관성 유지 알고리듬</td><td>리더선출, 로그복제</td><td>분산 데이터 저장소의 일관성</td></tr><tr><td>분산/패턴</td><td>Saga (Saga Pattern, Saga)</td><td>로컬 트랜잭션 + 보상 트랜잭션으로 결국일관성 달성</td><td>보상 트랜잭션, 오케스트레이션</td><td>마이크로서비스 장기 트랜잭션</td></tr><tr><td>통합</td><td>Outbox (Outbox Pattern, Outbox)</td><td>로컬 DB 에 메시지 기록→별도 프로세스가 발행해 원자성 확보</td><td>Idempotency, Inbox</td><td>이벤트 발행의 원자성 보장</td></tr><tr><td>엔진</td><td>트랜잭션 매니저 (Transaction Manager, TM)</td><td>트랜잭션 시작/종료·상태 관리 및 2PC 조정</td><td>상태 테이블, 타임아웃</td><td>트랜잭션 제어 중앙 엔진</td></tr><tr><td>엔진</td><td>락 관리자 (Lock Manager, LM)</td><td>자원별 락 획득/해제·데드락 탐지</td><td>Lock table, 대기 그래프</td><td>동시성 제어 구현</td></tr><tr><td>엔진</td><td>버퍼 관리자 (Buffer Manager, BM)</td><td>메모리 페이지 캐시·flush 정책 담당</td><td>Dirty page, Checkpoint</td><td>디스크 I/O 최적화</td></tr><tr><td>운영</td><td>체크포인트 (Checkpoint, CP)</td><td>로그 스캔 범위를 줄이기 위해 메모리 ->디스크 동기화 수행 시점</td><td>WAL, 복구시간</td><td>복구시간 (RTO) 최적화</td></tr><tr><td>운영</td><td>롤백 (Rollback, RB)</td><td>트랜잭션 실패 시 변경을 취소하는 동작</td><td>UNDO 로그, CLR</td><td>오류 처리·무결성 유지</td></tr><tr><td>운영</td><td>커밋 (Commit, COMMIT)</td><td>트랜잭션 변경을 영구화하는 동작</td><td>WAL flush</td><td>데이터 영속화 보장</td></tr><tr><td>운영</td><td>데드락 (Deadlock, DL)</td><td>트랜잭션들이 서로의 자원을 기다리며 교착 상태</td><td>대기 그래프, 타임아웃</td><td>성능/가용성 문제 진단</td></tr><tr><td>운영</td><td>격리 수준 (Isolation Level, IL)</td><td>트랜잭션 간 가시성 규칙 (읽기 현상 허용여부)</td><td>READ COMMITTED, SERIALIZABLE</td><td>비즈니스 요구에 따른 설정</td></tr><tr><td>운영</td><td>Idempotency (Idempotency, IDEMP)</td><td>같은 요청의 중복 실행이 동일 결과를 보장하는 성질</td><td>Outbox, 중복 감지</td><td>안전한 재시도 설계</td></tr><tr><td>운영</td><td>관찰성 (Observability, OBS)</td><td>트레이스·메트릭·로그로 시스템 상태를 모니터링</td><td>TraceID, 분산 트레이스</td><td>장애 원인 추적·운영 자동화</td></tr><tr><td>운영</td><td>감사 (Audit, Audit)</td><td>트랜잭션·접근 로그의 법적/규제 보존</td><td>암호화, 서명</td><td>규정 준수·증적 보관</td></tr><tr><td>운영</td><td>RTO/RPO (Recovery Time/Objectives, RTO/RPO)</td><td>복구 목표 시간/데이터 손실 허용치</td><td>체크포인트·복제</td><td>운영 SLA 정의</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://www.postgresql.org/docs/current/mvcc.html>PostgreSQL Documentation - Transaction Management</a></li><li><a href=https://dataintensive.net/>Martin Kleppmann - Designing Data-Intensive Applications</a></li><li><a href=https://kafka.apache.org/documentation/#exactly_once_semantics>Apache Kafka Documentation - Exactly Once Semantics</a></li><li><a href=https://aws.amazon.com/blogs/database/>AWS Database Blog - Distributed Transactions</a></li><li><a href=https://research.google/pubs/pub39966/>Google Research - Spanner: Google&rsquo;s Globally Distributed Database</a></li><li><a href=https://www.projectmanagertemplate.com/post/transaction-lifecycle-management-best-practices-for-modern-enterprises>Transaction Lifecycle Management: Best Practices for Modern Enterprises</a></li><li><a href=https://www.smartstream-stp.com/what-is-transaction-lifecycle-management-tlm/>What is Transaction Lifecycle Management (TLM®)? – SmartStream</a></li><li><a href=https://www.geeksforgeeks.org/blogs/blockchain-transaction-life-cycle/>Blockchain Transaction Lifecycle – GeeksforGeeks</a></li><li><a href=https://checkout.shiprocket.in/blog/transaction-lifecycle-management/>What is Transaction Lifecycle Management? | Shiprocket Checkout</a></li><li><a href=https://www.pcisecuritystandards.org/>PCI Security Standards Council (PCI DSS)</a></li><li><a href=https://hyperledger-fabric.readthedocs.io/en/latest/txflow.html>Hyperledger Fabric: Transaction Flow</a></li></ul><hr></div></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>