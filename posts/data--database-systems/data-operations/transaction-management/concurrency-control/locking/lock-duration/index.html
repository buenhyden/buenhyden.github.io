<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Lock Duration | hyunyoun's Blog</title><meta name=keywords content="Data-and-Database-Systems,Data-Operations,Transaction-Management,Concurrency-Control,Locking"><meta name=description content="락 지속시간은 트랜잭션이 특정 자원 락을 획득한 시점부터 해제·커밋으로 풀릴 때까지의 보유 기간이다. 격리수준, 2PL(Strict/Rigorous 여부), MVCC와 키-범위락, 락 에스컬레이션·타임아웃, 애플리케이션 로직이 이를 좌우한다. 지속시간은 동시성, 지연, 데드락 확률, 로그·복구 비용에 직접 영향을 준다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/concurrency-control/locking/lock-duration/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.d522c866f0cc9c20ae4fa73a0a8c07f0af4c36af75bcbcd3e90558446f681077.css integrity="sha256-1SLIZvDMnCCuT6c6CowH8K9MNq91vLzT6QVYRG9oEHc=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/concurrency-control/locking/lock-duration/index.xml><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/concurrency-control/locking/lock-duration/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/concurrency-control/locking/lock-duration/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Lock Duration"><meta property="og:description" content="락 지속시간은 트랜잭션이 특정 자원 락을 획득한 시점부터 해제·커밋으로 풀릴 때까지의 보유 기간이다. 격리수준, 2PL(Strict/Rigorous 여부), MVCC와 키-범위락, 락 에스컬레이션·타임아웃, 애플리케이션 로직이 이를 좌우한다. 지속시간은 동시성, 지연, 데드락 확률, 로그·복구 비용에 직접 영향을 준다."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Lock Duration"><meta name=twitter:description content="락 지속시간은 트랜잭션이 특정 자원 락을 획득한 시점부터 해제·커밋으로 풀릴 때까지의 보유 기간이다. 격리수준, 2PL(Strict/Rigorous 여부), MVCC와 키-범위락, 락 에스컬레이션·타임아웃, 애플리케이션 로직이 이를 좌우한다. 지속시간은 동시성, 지연, 데드락 확률, 로그·복구 비용에 직접 영향을 준다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HY's Blog","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":7,"name":"Lock Duration","item":"https://buenhyden.github.io/posts/data--database-systems/data-operations/transaction-management/concurrency-control/locking/lock-duration/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>HY's Blog</a></div><h1>Lock Duration</h1><div class=post-description>락 지속시간은 트랜잭션이 특정 자원 락을 획득한 시점부터 해제·커밋으로 풀릴 때까지의 보유 기간이다. 격리수준, 2PL(Strict/Rigorous 여부), MVCC와 키-범위락, 락 에스컬레이션·타임아웃, 애플리케이션 로직이 이를 좌우한다. 지속시간은 동시성, 지연, 데드락 확률, 로그·복구 비용에 직접 영향을 준다.</div></header><div class=post-content><h2 id=lock-duration>Lock Duration<a hidden class=anchor aria-hidden=true href=#lock-duration>#</a></h2><p>Lock Duration 은 트랜잭션이 락을 쥐고 있는 시간으로, 동시성과 일관성의 균형을 결정한다.<br>2PL 에서는 필요한 락을 모아 잡는 성장 단계와 해제만 하는 축소 단계가 있고, Strict 2PL 은 커밋 시 일괄 해제로 복구를 단순화하지만 대기가 길어질 수 있다.<br>MVCC 는 읽기에서 과도한 공유락을 줄여 동시성을 높이되, 갱신·메타데이터 작업·직렬화 격리에서는 여전히 락 (행·범위·테이블) 을 사용한다.<br>지속시간은 격리수준, 명시적 락 구문, 트랜잭션 경계 (오토커밋·프레임워크 전파), lock_timeout 같은 파라미터, 락 그라뉼러리티와 에스컬레이션에 좌우된다.<br>시간이 길면 경합·데드락·긴 꼬리 지연이, 너무 짧으면 재시도·롤백과 팬텀 위험이 커진다. 따라서 짧은 트랜잭션 설계, 일관된 락 순서, 적절한 타임아웃과 백오프, 인덱스와 쿼리 최적화로 범위락을 줄이고, DDL 은 업무와 시간대를 분리하는 방식이 실무적으로 효과적이다.</p><h3 id=락-지속시간-성능정합성의-결정변수>락 지속시간: 성능·정합성의 결정변수<a hidden class=anchor aria-hidden=true href=#락-지속시간-성능정합성의-결정변수>#</a></h3><p>락 지속시간은 " 잠근 뒤 얼마나 오래 잡고 있느냐 " 의 문제다.<br>이 시간이 길어질수록 다른 트랜잭션이 기다리는 시간이 늘고 데드락 위험도 커진다.<br>격리수준·쿼리 실행시간·세분성·락 모드·엔진 정책 (Strict/타임아웃/에스컬레이션) 이 지속시간을 결정한다.<br>관측 지표 (보유/대기시간, 대기체인) 를 꾸준히 보고, 트랜잭션을 짧게·정확히 잠그며, 필요하면 U/SIX/직접 X 로 업그레이드 없이 처리하는 것이 핵심이다.<br>MVCC 는 읽기 대기를 줄여주지만 쓰기 지속시간은 별도로 관리해야 한다.</p><h4 id=락-지속시간-핵심-개념-한눈에>락 지속시간 핵심 개념 한눈에<a hidden class=anchor aria-hidden=true href=#락-지속시간-핵심-개념-한눈에>#</a></h4><table><thead><tr><th>개념 (한글, 약어)</th><th>정의</th><th>왜 중요한가 (핵심 효과)</th><th>실무 포인트</th></tr></thead><tbody><tr><td>락 지속시간 (Lock Duration)</td><td>획득→해제까지의 보유 시간</td><td>차단·대기·데드락 확률을 결정</td><td>경계 단축, 플랜/인덱스 개선</td></tr><tr><td>세분성 (Granularity, MGL)</td><td>Row/Page/Table/Schema 단위</td><td>동시성↔오버헤드/차단 폭 조절</td><td>의도락 (IS/IX/SIX) 로 계층 제어</td></tr><tr><td>락 모드 (Lock Modes: S/X/U/IS/IX/SIX)</td><td>동시 보유 가능성 규정</td><td>업그레이드 필요성·경합 패턴 결정</td><td>U/SIX/직접 X 로 업그레이드 최소</td></tr><tr><td>2 단계 잠금 (Two-Phase Locking, 2PL)</td><td>Growing→Shrinking</td><td>직렬가능성·복구성 보장</td><td>Strict/Rigorous 는 보유기간↑</td></tr><tr><td>다중 버전 (MVCC)</td><td>읽기 버전 격리</td><td>읽기 대기↓, 쓰기 대기 별도</td><td>읽기는 스냅샷, 쓰기는 2PL 제어</td></tr><tr><td>타임아웃/데드락 (Timeout/Deadlock)</td><td>대기 상한/순환대기</td><td>가용성·예측성 보장</td><td>타임아웃·백오프·탐지/해소 운영</td></tr><tr><td>에스컬레이션 (Lock Escalation)</td><td>미세락→상위락 승격</td><td>메타비용↓ vs 차단폭↑</td><td>임계·시간대·파티션별 조정</td></tr></tbody></table><p><strong>요약</strong>: 지속시간은 <strong>격리/세분성/모드/정책</strong>의 함수다. 업그레이드 최소화·경계 단축·관측 기반 조정이 실무 핵심.</p><h4 id=락-지속시간-인과-관계도>락 지속시간 인과 관계도<a hidden class=anchor aria-hidden=true href=#락-지속시간-인과-관계도>#</a></h4><ul><li><strong>격리수준↑ → 지속시간↑ → 대기↑/데드락↑</strong></li><li><strong>세분성↓(거칠게) → 차단폭↑ → 효과적 지속시간↑</strong></li><li><strong>업그레이드 필요 (S→X) → 지속시간 중 교착 위험↑</strong></li><li><strong>Strict/Rigorous 채택 → 보유기간↑(복구성↑)</strong></li><li><strong>MVCC(읽기 분리) → 읽기 대기↓, " 쓰기 지속시간 " 은 별도 관리 필요</strong></li></ul><table><thead><tr><th>출발 개념 → 도착 개념</th><th>영향 방향</th><th>무엇을 위해</th><th>설명</th></tr></thead><tbody><tr><td>격리수준 → 락 지속시간</td><td>⬆</td><td>정합성 강화</td><td>Serializable 일수록 보유기간 길어짐</td></tr><tr><td>세분성 (거칠게) → 차단 폭</td><td>⬆</td><td>관리 단순</td><td>테이블락은 동시성 낮추고 체감 지속시간↑</td></tr><tr><td>락 모드 (S→X 업그레이드) → 데드락 위험</td><td>⬆</td><td>쓰기 보장</td><td>업그레이드 대기 교차로 위험 상승</td></tr><tr><td>Strict/Rigorous → 복구성</td><td>⬆</td><td>연쇄중단 방지</td><td>보유기간↑, 예측성↑</td></tr><tr><td>MVCC(읽기) → 읽기 대기</td><td>⬇</td><td>처리량↑</td><td>쓰기 지속시간은 별도</td></tr><tr><td>에스컬레이션 → 메타오버헤드</td><td>⬇</td><td>안정성↑</td><td>동시에 차단 폭↑(절충 필요)</td></tr><tr><td>타임아웃/백오프 → 가용성</td><td>⬆</td><td>꼬리지연 완화</td><td>무한대기 제거·폭주 제어</td></tr></tbody></table><p><strong>요약</strong>: 정합성을 올리면 보유·대기가 늘고, 성능을 올리면 정합성/관리비용이 늘어난다. <strong>조절 레버</strong>는 격리·세분성·모드·정책.</p><h4 id=락-지속시간-실무-매핑표>락 지속시간 실무 매핑표<a hidden class=anchor aria-hidden=true href=#락-지속시간-실무-매핑표>#</a></h4><ul><li><p><strong>무엇</strong>: 트랜잭션 경계 단축, 인덱스 최적화·쿼리 재작성, 적절한 모드 선택 (U/SIX/직접 X), 에스컬레이션 임계/시간대·파티션 단위 조정, 타임아웃/백오프.</p></li><li><p><strong>어떻게</strong>: <code>pg_locks/sys.dm_tran_locks/performance_schema</code> 로 <strong>보유/대기시간 분포</strong>를 관측 → 대기체인 상위 N 을 찾아 <strong>플랜/인덱스/경계</strong> 수정.</p></li><li><p><strong>왜</strong>: 지속시간을 줄이면 <strong>차단 폭과 대기</strong>가 선형~지수적으로 감소 → TPS·지연 SLO 개선.</p></li></ul><table><thead><tr><th>상황/목표</th><th>무엇을</th><th>어떻게</th><th>왜 (효과)</th></tr></thead><tbody><tr><td>대기시간 p95↓</td><td>트랜잭션 경계 단축</td><td>비즈니스 로직 분해, I/O 앞뒤 분리</td><td>보유시간 단축→차단 감소</td></tr><tr><td>데드락↓</td><td>업그레이드 제거</td><td>U 락/SIX/직접 X, 상→하 규칙</td><td>교착 경로 차단</td></tr><tr><td>TPS↑</td><td>인덱스·플랜 최적화</td><td>SARGABLE, 커버링 인덱스</td><td>실행시간↓→보유시간↓</td></tr><tr><td>예측성↑</td><td>Strict/Rigorous</td><td>쓰기/모든 락 커밋까지 유지</td><td>복구성·일관성 강화</td></tr><tr><td>메타비용↓</td><td>에스컬레이션/파티션</td><td>임계·시간대·샤딩 단위</td><td>관리비용↓, 차단폭은 모니터링 병행</td></tr><tr><td>읽기 확장</td><td>MVCC 혼용</td><td>읽기 스냅샷, 쓰기 2PL</td><td>읽기 - 쓰기 경합 분리</td></tr><tr><td>꼬리지연↓</td><td>타임아웃/백오프</td><td>대기 상한·지수 백오프</td><td>폭주·기아 방지</td></tr></tbody></table><p><strong>요약</strong>: " 경계 단축 + 업그레이드 제거 + 플랜 최적화 " 가 1 차 효과, " 정책 (Strict/에스컬/타임아웃)+ 구조 (MVCC/파티션)" 가 2 차 안정화 레버.</p><h3 id=기초-조사-및-개념-정립>기초 조사 및 개념 정립<a hidden class=anchor aria-hidden=true href=#기초-조사-및-개념-정립>#</a></h3><h4 id=락-지속시간-결정요인과-최적화>락 지속시간: 결정요인과 최적화<a hidden class=anchor aria-hidden=true href=#락-지속시간-결정요인과-최적화>#</a></h4><p>락 지속시간은 " 락을 얼마나 오래 쥐고 있나 " 다.<br>이 시간은</p><ol><li>2PL/Strict/Rigorous 같은 프로토콜</li><li>RC/RR/Serializable·MVCC 같은 격리 방식</li><li>행/페이지/테이블 수준과 인덱스 접근 범위</li><li>에스컬레이션·타임아웃 정책<br>으로 결정된다.</li></ol><p>길면 안전하지만 경합·대기가 늘고, 짧으면 빠르지만 불일치 위험이 커진다.<br>핵심은 스냅샷 읽기와 정밀한 인덱스, 짧은 트랜잭션으로 " 필요한 구간만 필요한 시간 " 보유하게 만드는 것이다.</p><h5 id=락-지속시간의-결정요인>락 지속시간의 결정요인<a hidden class=anchor aria-hidden=true href=#락-지속시간의-결정요인>#</a></h5><ol><li><p><strong>프로토콜</strong></p><ul><li>2PL: 성장 단계에서 획득, 수축 단계에서만 해제.</li><li>Strict 2PL: X 락을 <strong>커밋까지</strong> 유지.</li><li>Rigorous 2PL: S/X <strong>모두 커밋까지</strong> 유지.</li></ul></li><li><p><strong>격리수준·버저닝</strong></p><ul><li>RC: 읽기 S 락은 보통 문장 종료 시점에 해제.</li><li>RR/Serializable: 읽기 락 지속시간이 길어질 수 있음.</li><li>MVCC/SSI: 읽기는 버전 참조 (읽기 락 지속시간 실질 감소), 쓰기는 여전히 커밋까지 유지하는 경향.</li></ul></li><li><p><strong>그라뉼러리티·의도락</strong></p><ul><li>행/페이지/테이블 + IS/IX/SIX 의 조합이 보유 범위·시간을 좌우 (광역락일수록 효과적 동시성은 더 크게 감소).</li></ul></li><li><p><strong>접근 경로</strong></p><ul><li>인덱스 범위 (넥스트키/키 - 범위) 사용 시 " 보호 구간 " 이 넓어져 <strong>해제 전까지의 충돌 면적</strong>이 커질 수 있음.</li><li>커버링/선행열 정합 설계는 스캔 폭을 줄여 <strong>필요한 구간만</strong> 오래 잡게 함.</li></ul></li><li><p><strong>운영 정책</strong></p><ul><li>에스컬레이션 임계, 타임아웃/NOWAIT, 재시도·백오프, 배치 슬라이싱이 실효 지속시간과 충돌 빈도를 조정.</li></ul></li></ol><h5 id=lock-duration-정의와-핵심>Lock Duration: 정의와 핵심<a hidden class=anchor aria-hidden=true href=#lock-duration-정의와-핵심>#</a></h5><p>Lock Duration 은 트랜잭션의 락 생명주기다.<br>시작점은 락 획득, 끝점은 해제 또는 커밋이며, 이 구간이 동시성과 일관성의 균형을 결정한다.</p><p>Strict/Rigorous 2PL 처럼 커밋까지 보유하는 규율은 복구·일관성 측면에서 안전하지만, 대기열과 데드락 위험을 높인다.<br>반대로 MVCC/SSI 는 읽기를 버전으로 처리해 읽기 락의 지속시간을 사실상 제거하고, 쓰기 경로만 커밋까지 유지해 경합을 줄인다.<br>그라뉼러리티와 의도락, 인덱스 접근 (넥스트키/키 - 범위) 은 " 얼마나 넓은 범위를 얼마나 오래 " 잡는지를 좌우한다.</p><p>운영 측면에서는 에스컬레이션 임계, 락 타임아웃, 재시도·백오프, 배치 슬라이싱으로 실효 지속시간을 관리한다.<br>실무 목표는 " 필요 최소 범위를, 필요 최소 시간만 " 보유하는 설계다.</p><h4 id=락-지속시간의-역사와-핵심-전환점>락 지속시간의 역사와 핵심 전환점<a hidden class=anchor aria-hidden=true href=#락-지속시간의-역사와-핵심-전환점>#</a></h4><p>초기 DB 는 단순 배타락으로 직렬성을 만들었지만 병렬성이 낮았다.<br>2PL 은 " 획득 단계→해제 단계 " 라는 규칙으로 직렬성을 보장했으나, 길게 잡힌 락은 대기·교착을 키웠다.<br>그래서 의도 잠금과 다중 그라뉼러리티로 " 필요한 범위만, 필요한 시간만 " 잡도록 진화했고, 팬텀은 범위락으로 막았다.<br>읽기 지연을 줄이기 위해 MVCC 가 도입돼 읽기는 버전으로 해결하고, 쓰기에는 여전히 락을 쓴다.<br>운영에서는 NOWAIT·타임아웃·skip locked 로 대기 꼬리를 잘라낸다.<br>글로벌 서비스에선 전역 순서·합의로 분산 환경에서도 일관성과 적절한 락 지속시간을 동시에 달성한다.</p><h5 id=등장-배경>등장 배경<a hidden class=anchor aria-hidden=true href=#등장-배경>#</a></h5><ul><li>다중 사용자 환경에서 <strong>직렬성</strong>과 <strong>무결성</strong>을 보장하려면 트랜잭션 간 충돌을 제어해야 한다.</li><li>거친 락은 지속시간·영향 범위가 커 병렬 성능이 낮고, 단순 뮤텍스는 교착·기아를 체계적으로 다루지 못한다.</li><li>이에 2PL 이 <strong>획득→해제</strong>의 명확한 규율로 직렬성을 제공했고, 운영 현실 (경합·팬텀·지연) 에 대응해 <strong>의도 잠금·다중 그라뉼러리티·범위락·MVCC·운영 정책</strong>이 단계적으로 추가되었다.</li></ul><h5 id=발전-과정>발전 과정<a hidden class=anchor aria-hidden=true href=#발전-과정>#</a></h5><table><thead><tr><th>시기</th><th>왜 등장했나 (문제)</th><th>무엇이 나왔나 (해법)</th><th>Lock Duration 에 준 영향</th></tr></thead><tbody><tr><td>1960s</td><td>공유 자원 충돌, 뮤텍스 한계</td><td>배타 접근·단일 사용자 중심</td><td>길고 거친 락, 병렬성 낮음</td></tr><tr><td>1970s</td><td>직렬성·회복 필요</td><td>2PL, Conservative/Strict</td><td>규율 확립, Strict 로 지속시간 증가·회복성↑</td></tr><tr><td>1980s</td><td>경합·교착·비효율</td><td>다중 그라뉼러리티, 의도 잠금, 에스컬레이션</td><td>필요한 범위만 유지 → 평균 지속시간↓</td></tr><tr><td>1990s</td><td>팬텀 현상</td><td>범위락/넥스트키</td><td>재시도↓·일관성↑ ↔ 잠금 면적·지속시간↑ 가능</td></tr><tr><td>1990s~2000s</td><td>읽기 지연·보고 혼용</td><td>MVCC, Snapshot</td><td>읽기 지속시간 체감↓, 쓰기쪽 부담 전이</td></tr><tr><td>2000s</td><td>운영 안정화 필요</td><td>NOWAIT/타임아웃/skip locked</td><td>꼬리 대기·장수 Tx 억제</td></tr><tr><td>2010s</td><td>스냅샷 직렬화</td><td>SSI</td><td>읽기 자유 유지 + 직렬성 검증 (재시도 비용)</td></tr><tr><td>2010s~</td><td>글로벌 분산</td><td>전역 시간/합의, 2PC 결합</td><td>지역 락 짧게, 글로벌 순서로 일관성 유지</td></tr><tr><td>2020s~</td><td>자가 튜닝 요구</td><td>적응형 파라미터·자동 에스컬레이션</td><td>워크로드 기반으로 지속시간 자동 최적화</td></tr></tbody></table><pre class=mermaid>timeline
    title Lock Duration 발전 타임라인
    1960s : 배치·단일 사용자/뮤텍스 중심 : 초기 배타 접근 제어
    1970s : 2PL 도입 : Conservative/Strict 규율로 직렬성·회복성 강화
    1980s : 다중 그라뉼러리티·의도 잠금 : 상→하 획득·에스컬레이션로 평균 지속시간 절감
    1990s : 범위락/넥스트키 : 팬텀 차단(지속시간·면적은 증가 가능)
    1990s–2000s : MVCC·Snapshot : 읽기 락을 버전 가시성으로 대체
    2000s : NOWAIT/Timeout/Skip Locked : 꼬리 대기 억제·장수 Tx 완화
    2010s : SSI(Serializable Snapshot) : 읽기 자유 + 직렬성 검증(재시도 비용)
    2010s–현재 : 분산(전역 시간·합의/2PC) : 지역 락은 짧게, 전역 순서로 일관성 확보
    2020s–현재 : 적응형 락 지속시간 튜닝 : 워크로드 기반 자동 최적화
</pre><p>락 지속시간은 2PL 로 규율이 생기고, 의도 잠금·다중 그라뉼러리티로 평균을 줄였으며, 범위락으로 팬텀을 차단했다. MVCC/SSI 는 읽기 지속시간을 사실상 제거했지만 검증·재시도 비용을 낳았다. 운영 기능과 분산 기술은 긴 꼬리 대기를 누르고, 최근에는 워크로드에 맞춰 지속시간을 자동 최적화하는 방향으로 진화 중이다.</p><h4 id=lock-duration-으로-다잡는-일관성능>Lock Duration 으로 다잡는 일관·성능<a hidden class=anchor aria-hidden=true href=#lock-duration-으로-다잡는-일관성능>#</a></h4><p>락 지속시간은 &ldquo;<strong>잠금이 얼마나 오래 유지되느냐</strong>&rdquo; 를 뜻한다.<br>오래 잡으면 더 안전하지만 더 많이 기다려야 하고, 짧게 잡으면 빠르지만 이상 현상 (Dirty/Lost/Non-repeatable/Phantom) 이 나타날 수 있다.<br>그래서 <strong>필요한 구간만 충분히</strong>, 그 외에는 <strong>빨리 해제</strong>하는 전략이 중요하다.<br>이를 위해 트랜잭션을 짧게 설계하고, <strong>업그레이드 (S→X) 없이</strong> 처음부터 적절한 모드로 잠그며, <strong>프레디킷/넥스트키</strong> 같은 범위락은 정말 필요한 범위에만 적용한다.<br>남는 리스크는 <strong>타임아웃·에스컬레이션</strong>과 모니터링으로 제어한다.</p><h5 id=지속시간으로-해결하는-동시성-이상>지속시간으로 해결하는 동시성 이상<a hidden class=anchor aria-hidden=true href=#지속시간으로-해결하는-동시성-이상>#</a></h5><table><thead><tr><th>문제</th><th>원인</th><th>지속시간 관점의 해결 전략</th><th>개선 측면</th><th>기대 효과</th><th>주의/한계</th></tr></thead><tbody><tr><td>Dirty Read</td><td>미커밋 데이터 노출</td><td>X 를 커밋까지 유지 (Strict)</td><td>무결성</td><td>더티 읽기 제거</td><td>지연 증가 위험</td></tr><tr><td>Non-repeatable Read</td><td>읽기 사이에 타 트랜잭션 갱신</td><td>S 를 트랜잭션 동안 유지 또는 MVCC 스냅샷</td><td>일관성</td><td>동일 읽기 보장</td><td>S 대기 증가</td></tr><tr><td>Lost Update</td><td>동시 갱신 경합</td><td>대상 행/키에 X 보유, 업그레이드 회피 (U/SIX/초기 X)</td><td>정합성</td><td>갱신 손실 방지</td><td>교착 경로 주의</td></tr><tr><td>Phantom Read</td><td>범위 내 삽입/삭제</td><td>프레디킷/넥스트키를 충분히 유지</td><td>직렬성</td><td>팬텀 차단</td><td>과대 차단 가능</td></tr><tr><td>꼬리 지연</td><td>과도한 보유/긴 쿼리</td><td>경계 단축·플랜 튜닝·타임아웃</td><td>성능</td><td>p95 지연 완화</td><td>부분 롤백 증가 가능</td></tr></tbody></table><p><strong>요약</strong>: <strong>충분히 오래 + 필요한 곳만</strong>이 원칙이다. 범위를 잠글 때는 과대 차단을 피하도록 쿼리·인덱스를 함께 설계한다.</p><h5 id=지속시간-설계의-다섯-목표>지속시간 설계의 다섯 목표<a hidden class=anchor aria-hidden=true href=#지속시간-설계의-다섯-목표>#</a></h5><table><thead><tr><th>핵심 목적</th><th>설명</th><th>수단 (지속시간·프로토콜)</th><th>대표 지표</th></tr></thead><tbody><tr><td>무결성/직렬성</td><td>이상 행위 제거</td><td>Strict/Rigorous·범위락 유지</td><td>Dirty/Lost/Phantom 건수</td></tr><tr><td>동시성·처리량</td><td>대기 최소화</td><td>경계 단축·플랜/인덱스 최적화</td><td>TPS, Lock Wait p95</td></tr><tr><td>예측 가능성</td><td>스케줄 안정</td><td>커밋까지 보유 (필요시), 업그레이드 금지</td><td>지연 분산, 변동계수</td></tr><tr><td>운영 안정성</td><td>교착/폭주 방지</td><td>타임아웃·에스컬·백오프</td><td>데드락률, 타임아웃률</td></tr><tr><td>감사 가능성</td><td>책임 추적</td><td>보유/대기 이벤트 로깅</td><td>감사 적합률</td></tr></tbody></table><p><strong>요약</strong>: 목적은 <strong>무결성→성능→운영</strong> 순으로 연결돼 있으며, 각 목적은 <strong>지속시간 정책</strong>으로 구체화된다.</p><h5 id=문제와-목적의-11-매핑>문제와 목적의 1:1 매핑<a hidden class=anchor aria-hidden=true href=#문제와-목적의-11-매핑>#</a></h5><table><thead><tr><th>문제</th><th>대응 목적</th><th>지속시간 지렛대</th><th>결과 지표</th></tr></thead><tbody><tr><td>Dirty/Non-repeatable</td><td>무결성/직렬성</td><td>S/X 보유 구간 확대 (필요 구간만)</td><td>이상 건수↓</td></tr><tr><td>Lost Update</td><td>무결성</td><td>X 초기획득·업그레이드 금지</td><td>재시도/롤백↓</td></tr><tr><td>Phantom</td><td>직렬성</td><td>프레디킷/넥스트키 충분 유지</td><td>팬텀↓</td></tr><tr><td>꼬리 지연·혼잡</td><td>동시성·예측성</td><td>경계 단축·타임아웃·에스컬</td><td>p95 지연↓, TPS↑</td></tr><tr><td>교착</td><td>운영 안정성</td><td>상→하 획득·타임아웃·우선순위</td><td>데드락률↓</td></tr></tbody></table><p><strong>요약</strong>: 각 문제는 하나 이상의 목적과 직접 연결되며, <strong>지속시간 조절</strong>이 실천 레버다.</p><h4 id=dirty--non-repeatable-readnrr--lost-update--phantom-과-락-지속시간의-관계>Dirty / Non-repeatable Read(NRR) / Lost Update / Phantom 과 락 지속시간의 관계<a hidden class=anchor aria-hidden=true href=#dirty--non-repeatable-readnrr--lost-update--phantom-과-락-지속시간의-관계>#</a></h4><ul><li>이상을 막으려면 **어떤 락을 언제부터 언제까지 보유할지 (지속시간 창)**를 정확히 잡아야 한다.</li><li>요약 규칙:<ol><li><strong>Dirty Read 방지</strong>: **쓰기 (X)**는 <strong>커밋까지 유지</strong>(Strict)</li><li><strong>NRR 방지</strong>: **읽기 (S)**는 <strong>트랜잭션 종료까지 유지</strong>(Rigorous/Repeatable Read) <strong>또는</strong> 스냅샷 (MVCC)</li><li><strong>Lost Update 방지</strong>: 갱신 대상에 <strong>X 를 읽는 순간부터 커밋까지</strong>(업그레이드 대신 <strong>U/SIX/초기 X</strong>)</li><li><strong>Phantom 방지</strong>: 범위에 <strong>프레디킷/넥스트키 락을 트랜잭션 종료까지</strong>(또는 SSI)</li></ol></li></ul><h5 id=이상-유형--지속시간-한눈에-표>이상 유형 × 지속시간: 한눈에 표<a hidden class=anchor aria-hidden=true href=#이상-유형--지속시간-한눈에-표>#</a></h5><table><thead><tr><th>이상 유형</th><th>주된 원인 (시간 창)</th><th>2PL 에서의 <strong>최소 보유시간 규칙</strong></th><th>MVCC/기타 등가 전략</th><th>대표 격리수준 (일반적)</th><th>트레이드오프 (보유시간 ↑ 시)</th></tr></thead><tbody><tr><td><strong>Dirty Read</strong></td><td>T1 이 <strong>미커밋</strong> 값을 노출한 뒤 T2 가 읽음</td><td>T1 의 <strong>X 를 커밋까지 유지</strong>(Strict 2PL) → 미커밋 값 비가시화</td><td><strong>커밋된 버전만 읽기</strong>(스냅샷/Read Committed)</td><td>Read Committed 이상</td><td>쓰기 경합 시 대기↑, TPS↓</td></tr><tr><td><strong>NRR</strong></td><td>T1 이 같은 행을 두 번 읽는 사이 T2 가 갱신·커밋</td><td>T1 이 해당 행의 <strong>S 를 트랜잭션 종료까지 유지</strong></td><td><strong>스냅샷 일관성</strong>(같은 Read View 유지)</td><td>Repeatable Read</td><td>읽기 락 보유로 읽기 - 쓰기 경합↑</td></tr><tr><td><strong>Lost Update</strong></td><td>두 트랜잭션이 같은 값 읽고 모두 갱신</td><td>대상 행 (혹은 키) 에 <strong>X 를 읽는 순간부터 커밋까지</strong>. <strong>S→X 업그레이드 지양</strong>, <strong>U/SIX/초기 X</strong> 사용</td><td><strong>낙관적 검증</strong>(버전/조건갱신, 실패 시 재시도)</td><td>보장하려면 SELECT … FOR UPDATE 등</td><td>과잠금 위험, 대기·데드락 가능성</td></tr><tr><td><strong>Phantom</strong></td><td>T1 의 <strong>범위</strong> 내에 T2 가 행을 삽입/삭제</td><td><strong>프레디킷/넥스트키 (갭 포함) 락을 종료까지</strong> 유지 (인덱스 필요)</td><td><strong>SSI/직렬화 스냅샷</strong>(의존성 추적)</td><td>Serializable</td><td>범위 잠금으로 차단폭↑, 스캔 경합↑</td></tr></tbody></table><p><strong>요약</strong>: &ldquo;<strong>얼마나 오래 잠그느냐</strong>&rdquo; 가 이상 방지의 본질이다. Dirty 는 <strong>X- 커밋까지</strong>, NRR 은 <strong>S- 트랜잭션까지</strong>, Lost 는 <strong>X- 트랜잭션까지</strong>, Phantom 은 <strong>범위 - 트랜잭션까지</strong>가 최소치다.</p><h5 id=실무-메모>실무 메모<a hidden class=anchor aria-hidden=true href=#실무-메모>#</a></h5><ul><li><strong>업그레이드 최소화</strong>: <code>S→X</code> 는 전형적 교착 경로. 가능하면 <strong>U</strong>(Update) 또는 <strong>SIX/초기 X</strong>로 시작해 <strong>보유시간 창을 한 번에 확정</strong>.</li><li><strong>범위 잠금 최적화</strong>: Phantom 방지 시 <strong>선택도 높은 인덱스 + 넥스트키</strong>로 " 필요 범위만 오래 " 잠그기.</li><li><strong>MVCC 하이브리드</strong>: 읽기는 <strong>스냅샷</strong>으로 비차단, <strong>쓰기 구간만 강하게 오래</strong>(2PL) 잠그면 전체 대기시간이 크게 줄어든다.</li><li><strong>지표로 검증</strong>: <code>lock_hold_time</code>, <code>lock_wait_time</code>, 데드락률, 넥스트키 충돌 건수로 <strong>보유시간 조정 효과</strong>를 즉시 확인.</li></ul><h5 id=작은-타임라인-예시-dirty-vs-nrr>작은 타임라인 예시 (Dirty Vs NRR)<a hidden class=anchor aria-hidden=true href=#작은-타임라인-예시-dirty-vs-nrr>#</a></h5><ul><li><strong>Dirty 방지</strong>: <code>T1: X(행A) —[커밋까지 유지]→ Commit</code> → 이 동안 <code>T2: Read(A)</code> 는 <strong>대기/버전읽기</strong></li><li><strong>NRR 방지</strong>: <code>T1: S(행A) —[트랜잭션 종료까지 유지]→ Commit</code> → <code>T2: Write(A)</code> 는 <strong>대기</strong>, <code>T1</code> 의 두 번째 읽기도 동일값 보장</li></ul><h4 id=락-지속시간을-줄이는-시스템-요건>락 지속시간을 줄이는 시스템 요건<a hidden class=anchor aria-hidden=true href=#락-지속시간을-줄이는-시스템-요건>#</a></h4><p>락 지속시간은 " 언제까지 락을 쥐고 갈 것인가 " 의 문제다.<br>트랜잭션 경계, 격리 수준, Strict 여부가 해제 시점을 정한다.<br>로그 (WAL) 와 데드락 감지·타임아웃이 받쳐줘야 불필요한 장기 보유를 막을 수 있다.<br>애플리케이션은 짧은 트랜잭션과 일관된 자원 순서를 지켜 락 시간을 스스로 줄여야 한다.</p><h5 id=락-지속시간을-좌우하는-필수-조건>락 지속시간을 좌우하는 필수 조건<a hidden class=anchor aria-hidden=true href=#락-지속시간을-좌우하는-필수-조건>#</a></h5><ul><li><p><strong>트랜잭션 경계 규율</strong></p><ul><li>무엇: 명확한 BEGIN/COMMIT/ROLLBACK, 자동 커밋 정책.</li><li>왜: 락 해제 시점은 경계에 종속. 경계 모호하면 <strong>락 장기 보유</strong>·경합 급증.</li></ul></li><li><p><strong>회복·로그 전제 (WAL)</strong></p><ul><li>무엇: 커밋 전 로그 영속, 크래시 후 재실행/언두.</li><li>왜: Strict/Rigorous 에서 <strong>커밋까지 보유되는 락</strong>은 로그 일관성을 전제로 안전하게 해제 가능.</li></ul></li><li><p><strong>락 관리자·호환성·데드락 감지</strong></p><ul><li>무엇: 호환성 매트릭스, 대기 큐, Wait-for 그래프/타임아웃.</li><li>왜: 대기/감지 실패는 <strong>무한 보유</strong>로 이어짐.</li></ul></li><li><p><strong>격리 수준·정책 명세</strong></p><ul><li>무엇: 문장 수준 (S 해제 타이밍) vs 트랜잭션 수준 (X 커밋 해제), 키 - 범위 필요 여부.</li><li>왜: 격리에 따라 <strong>락 지속시간과 범위</strong>가 달라짐.</li></ul></li><li><p><strong>자원·스케줄링</strong></p><ul><li>무엇: 메모리 (락 테이블), CPU(큐·판정), 디스크 I/O(로그), 네트워크 지연 (분산).</li><li>왜: 자원 박하면 대기 증가 → <strong>보유시간 길어짐</strong>.</li></ul></li><li><p><strong>애플리케이션·SQL 규율</strong></p><ul><li>무엇: 외부 I/O·사용자 대기 금지, 짧은 트랜잭션, 일관된 자원 순서, <code>FOR UPDATE</code> 와 같은 <strong>의도적 락 전환 시점</strong> 문서화.</li><li>왜: 불필요한 대기가 <strong>락 지속시간을 폭증</strong>시킴.</li></ul></li><li><p><strong>운영 파라미터와 SLA</strong></p><ul><li>무엇: LOCK_TIMEOUT/DEADLOCK_TIMEOUT, 에스컬레이션 임계, 재시도·멱등.</li><li>왜: 꼬리 지연을 <strong>강제로 자름</strong>으로써 보유시간 상한을 관리.</li></ul></li></ul><h5 id=lock-duration-전제요구사항-요약>Lock Duration 전제·요구사항 요약<a hidden class=anchor aria-hidden=true href=#lock-duration-전제요구사항-요약>#</a></h5><table><thead><tr><th>구분</th><th>항목</th><th>요구사항/정책</th><th>근거 (왜)</th><th>실무 체크포인트</th><th>실패 징후</th></tr></thead><tbody><tr><td>경계</td><td>트랜잭션 경계</td><td>명시적 BEGIN/COMMIT, 자동 커밋 규율</td><td>해제 시점=경계에 종속</td><td>" 외부 호출 Tx 밖 " 규칙</td><td>Idle in Tx, 긴 보유</td></tr><tr><td>회복</td><td>WAL/로그</td><td>커밋 전 로그 영속, 크래시 리커버리</td><td>Strict 해제 안전성 확보</td><td>로그 대기, fsync 모니터</td><td>커밋 지연·재실행 실패</td></tr><tr><td>엔진</td><td>락 매니저</td><td>호환성 매트릭스, 대기 큐, 데드락 감지</td><td>무한 대기 방지</td><td>Wait-for 그래프/알람</td><td>데드락/타임아웃 급증</td></tr><tr><td>격리</td><td>정책 명세</td><td>문장 vs 트랜잭션 해제, 키 - 범위 여부</td><td>지속시간·범위 결정</td><td>경로별 격리 카탈로그</td><td>팬텀/스큐 발생</td></tr><tr><td>자원</td><td>메모리·CPU·I/O</td><td>락 테이블 메모리, 큐·판정 CPU, 로그 I/O</td><td>대기→보유시간 장기화</td><td>에스컬레이션률·큐 길이</td><td>상위 충돌·스로틀링</td></tr><tr><td>앱</td><td>SQL 규율</td><td>짧은 Tx, 자원 순서, FOR UPDATE 시점</td><td>대기 줄여 보유 단축</td><td>비즈 규칙 문서화</td><td>장수 Tx·재진입 대기</td></tr><tr><td>운영</td><td>타임아웃·SLA</td><td>LOCK/DEADLOCK_TIMEOUT, 재시도·멱등</td><td>꼬리 지연 컷오프</td><td>타임아웃률·재시도율</td><td>롤백 폭증·SLO 위반</td></tr></tbody></table><p><strong>요약</strong>: 락 지속시간은 <strong>경계·격리·회복</strong>이 정하고, <strong>엔진/자원/운영</strong>이 이를 지탱한다. 애플리케이션 규율이 느슨하면 어떤 엔진도 장기 보유를 막지 못한다.</p><h4 id=lock-duration-의-구조적-이해>Lock Duration 의 구조적 이해<a hidden class=anchor aria-hidden=true href=#lock-duration-의-구조적-이해>#</a></h4><p>Lock Duration 은 &ldquo;<strong>언제 락을 잡고 언제 놓는가</strong>&rdquo; 다.<br>RC 에선 읽기 (S) 가 <strong>문장 끝</strong>에 풀릴 수 있지만, RR/Serializable 이나 Strict 2PL 에선 <strong>트랜잭션 끝</strong>까지 유지된다.<br>X 는 보통 <strong>커밋까지</strong> 붙는다.<br>MVCC 는 읽기를 <strong>버전</strong>으로 처리해 공유락을 줄이지만, <strong>Serializable 수준</strong>에서는 범위/프레디킷 보호가 <strong>트랜잭션 종료</strong>까지 남는다.<br>에스컬레이션이 일어나면 <strong>상위락이 더 오래</strong> 유지되어 동시성이 줄 수 있다.<br>타임아웃·데드락 처리는 <strong>실효 지속시간</strong>을 줄이는 안전장치다.</p><h5 id=지속시간-관점에서-본-락의-본질>지속시간 관점에서 본 락의 본질<a hidden class=anchor aria-hidden=true href=#지속시간-관점에서-본-락의-본질>#</a></h5><ul><li><p><strong>시간 계층화</strong>: Statement/Transaction/Session/System 네 단계.<br>근거: 락 매니저의 상태천이 (요청·허용·해제).<br>차별점: MVCC 는 <strong>읽기락 최소화</strong>로 Statement-duration 조차 생략 가능.</p></li><li><p><strong>2PL 변형에 따른 락 수명</strong>: Basic(전이 규칙), Strict(X=커밋까지), Rigorous(S/X=커밋까지), Conservative(전부 선점).<br>근거: 2PL 규칙·복구성.<br>차별점: OCC 는 <strong>검증 순간</strong>에만 충돌 처리.</p></li><li><p><strong>격리수준별 보유 범위</strong>: RC(S=문장), RR/Serializable(S=트랜잭션), X=트랜잭션.<br>근거: 각 수준의 <strong>가시성·재실행 보장</strong> 요구.<br>차별점: RC-Snapshot/MVCC 는 <strong>S 락 불필요</strong>.</p></li><li><p><strong>MVCC/SSI 의 범위 보호</strong>: S 락 대신 Predicate/SIREAD 를 트랜잭션 종료까지 유지.<br>근거: 팬텀 방지.<br>차별점: " 락 없음 " 이 아니라 <strong>락 종류 변화</strong>.</p></li><li><p><strong>그레인·에스컬레이션</strong>: 행→페이지→테이블 승격 시 <strong>보유 주체가 상위로</strong> 바뀌고 차단면적 확대.<br>근거: 관리비용 절감 정책.<br>차별점: 지속시간 동일해도 <strong>대기 영향</strong> 급증.</p></li><li><p><strong>타임아웃·데드락 정책</strong>: 실효 지속시간을 줄이고, 시스템 정체를 해소.<br>근거: 대기 큐·Wait-For 그래프.<br>차별점: 기능은 " 단축 " 이 아니라 <strong>강제 종료</strong>.</p></li><li><p><strong>락/래치 구분</strong>: 지속시간 관점에서 <strong>락≫래치</strong>.<br>근거: 목적 (일관성 vs 메모리 보호), 수명 (트랜잭션 vs 수 μs–ms).</p></li></ul><h5 id=lock-duration-특징근거차별점>Lock Duration 특징·근거·차별점<a hidden class=anchor aria-hidden=true href=#lock-duration-특징근거차별점>#</a></h5><table><thead><tr><th>특징</th><th>기술적 근거</th><th>동작·지속 범위</th><th>타 기술과 차별점</th><th>주의/리스크</th></tr></thead><tbody><tr><td>시간 계층화 (Stmt/Tx/Session/System)</td><td>락 상태천이 (요청/해제 이벤트)</td><td>S: 문장<del>트랜잭션, X: 트랜잭션</del>커밋</td><td>MVCC 는 읽기 락 축소/무화</td><td>모델에 따라 지연 인지 상이</td></tr><tr><td>2PL 변형 영향</td><td>성장→수축, Strict/Rigorous 제약</td><td>Strict: X=커밋, Rigorous: S/X=커밋</td><td>OCC 는 검증 순간만 충돌 처리</td><td>동시성↔복구성 트레이드오프</td></tr><tr><td>격리수준 매핑</td><td>가시성·재실행 보장 요건</td><td>RC: S=문장, RR/S: S=트랜잭션</td><td>RC-Snapshot 은 버전 읽기</td><td>구현별 미세 차이</td></tr><tr><td>MVCC/SSI 범위 보호</td><td>팬텀 방지, Predicate/SIREAD</td><td>트랜잭션 종료까지 추적</td><td>" 락 미사용 " 아님 (종류 변경)</td><td>논리적 충돌로 재시도 발생</td></tr><tr><td>그레인·에스컬레이션</td><td>관리비용 절감 정책</td><td>상위락 지속시간이 지배</td><td>미세락은 대기 국소화</td><td>과승격 시 전면 차단</td></tr><tr><td>타임아웃/데드락</td><td>Wait-For 그래프·정책</td><td>강제 종료로 대기 단축</td><td>필요시 희생자 Abort</td><td>신중한 피해자 선택 필요</td></tr><tr><td>락 vs 래치</td><td>보호 목적 상이</td><td>락≫래치 (수명)</td><td>혼동 시 오진</td><td>원인 분리 필수</td></tr></tbody></table><p><strong>표 요약</strong>: Lock Duration 은 **수명 규칙 (2PL·격리수준)**과 <strong>읽기 전략 (MVCC/SSI)</strong>, **그레인/정책 (에스컬·타임아웃)**의 합성 결과다. " 얼마나 오래 잡는가 " 는 기술 스택과 정책 선택의 함수다.</p><h4 id=락-duration-의-균형과-설계-결정요인>락 Duration 의 균형과 설계 결정요인<a hidden class=anchor aria-hidden=true href=#락-duration-의-균형과-설계-결정요인>#</a></h4><ul><li>락은 <strong>오래 잡을수록 안전</strong>하지만 <strong>느려진다</strong>.</li><li>은행/결제처럼 실수하면 안 되는 시스템은 <strong>조금 더 오래</strong> 잡아 <strong>데이터를 안전하게</strong> 만든다.</li><li>대규모 웹 서비스는 <strong>최대한 짧게</strong> 잡고, <strong>읽기는 스냅샷/리플리카</strong>로 분리해 속도를 확보한다.</li><li>결국 목표는 <strong>일관성 vs 지연·처리량</strong>의 균형이며, 이를 위해 <strong>보유 시간 정책 + 운영 레버</strong>를 함께 설계한다.</li></ul><h5 id=설계-동기>설계 동기<a hidden class=anchor aria-hidden=true href=#설계-동기>#</a></h5><ul><li><p><strong>무결성 보호가 최우선인 도메인</strong>:<br>결제·정산은 잘못된 중복 갱신이 치명적이므로, <strong>락을 끝까지 유지</strong>(Strict 경향) 해 미커밋 의존을 차단하려는 동기.</p></li><li><p><strong>대량 동시성 처리 요구</strong>:<br>웹/모바일 트래픽은 순간 경합이 크다. <strong>짧은 보유 시간</strong>과 **국소 락 (행/버킷 단위)**로 큐 길이를 줄여 <strong>테일 지연</strong>을 낮추려는 동기.</p></li><li><p><strong>분산/HTAP 환경의 혼재</strong>:<br>분석 스캔이 길어지면 보유 시간도 길어져 OLTP 를 막는다. <strong>읽기 분리·스케줄 분리</strong>로 보유 시간을 간접적으로 줄이려는 동기.</p></li><li><p><strong>운영·복구 단순화</strong>:<br>보유 정책이 일관될수록 <strong>데드락/타임아웃 기준</strong>과 <strong>희생자 정책</strong>을 표준화하기 쉬워서 운영이 단순해지는 동기.</p></li></ul><h5 id=품질-속성>품질 속성<a hidden class=anchor aria-hidden=true href=#품질-속성>#</a></h5><ul><li><strong>성능/지연</strong>: 보유 시간이 길면 <strong>경합 대기</strong>가 늘어 평균/상위 지연이 증가. 짧게 만들면 반대로 개선.</li><li><strong>처리량</strong>: 대기열이 줄면 CPU·I/O 가 더 많은 트랜잭션을 처리해 <strong>TPS/QPS 증가</strong>.</li><li><strong>확장성</strong>: 짧고 지역화된 락은 <strong>파티셔닝/샤딩</strong>과 결합해 노드 수 증가에 선형에 가까운 확장성을 제공.</li><li><strong>복구성</strong>: Strict 보유는 <strong>연쇄 롤백 방지</strong>로 재처리 비용을 낮춘다.</li><li><strong>일관성/격리</strong>: <strong>범위 잠금</strong>(넥스트키/프레디킷) 을 동반한 긴 보유는 <strong>팬텀 방지</strong>에 직접 기여.</li><li><strong>예측 가능성/공정성</strong>: <strong>보유 상한 + 우선순위 노후화/부스팅</strong>은 기아를 줄이고 SLA 안정에 기여.</li><li><strong>운영성/관찰성</strong>: <strong>타임아웃/백오프/에스컬레이션 임계치</strong>를 지표로 자동 튜닝하면 보유 시간 분포를 제어하기 쉬움.</li></ul><h5 id=락-보유-시간-설계---품질-매핑표>락 보유 시간 설계 - 품질 매핑표<a hidden class=anchor aria-hidden=true href=#락-보유-시간-설계---품질-매핑표>#</a></h5><table><thead><tr><th>설계 동기</th><th>품질 속성 (목표)</th><th>왜 그런가 (메커니즘)</th><th>설계 레버 (실행 방안)</th><th>핵심 지표</th></tr></thead><tbody><tr><td>무결성 최우선</td><td>일관성/복구성↑</td><td>미커밋 의존 차단</td><td>Strict 경향, 범위 잠금, 단계적 커밋</td><td>데드락률, 롤백률</td></tr><tr><td>대량 동시성</td><td>지연↓/처리량↑</td><td>대기열 축소</td><td>짧은 TX, 국소 락, 인덱스 최적화</td><td>P95/P99, TPS</td></tr><tr><td>분산/HTAP</td><td>예측 가능성↑</td><td>긴 스캔 보유 축소</td><td>읽기 분리 (리플리카/스냅샷), 스케줄 분리</td><td>리플리카 랙, 충돌률</td></tr><tr><td>운영 단순화</td><td>운영성/관찰성↑</td><td>규칙 표준화</td><td>타임아웃/백오프, 에스컬레이션 임계치</td><td>대기시간, 락 수</td></tr></tbody></table><p>락 보유 시간은 <strong>도메인 위험 허용도</strong>와 <strong>성능 목표</strong>의 타협 결과다. " 긴 보유=안전/복구 용이 &ldquo;, " 짧은 보유=성능/확장성 " 이며, **레버 (Strict·범위 잠금·짧은 TX·읽기 분리·타임아웃/에스컬레이션)**로 목표 지표를 조정한다.</p><h3 id=phase-2-핵심-원리-및-이론적-기반>Phase 2: 핵심 원리 및 이론적 기반<a hidden class=anchor aria-hidden=true href=#phase-2-핵심-원리-및-이론적-기반>#</a></h3><h4 id=락-지속시간-운영-프레임워크>락 지속시간 운영 프레임워크<a hidden class=anchor aria-hidden=true href=#락-지속시간-운영-프레임워크>#</a></h4><p>락 지속시간은 " 락을 얼마나 오래 쥐고 있나 " 다.<br>이를 줄이려면 트랜잭션을 짧게 쪼개고, 인덱스·파티션으로 보호 구간을 정확히 만들며, 읽기는 스냅샷으로 분리한다.<br>반대로 안전이 최우선인 경로는 커밋까지 보유한다.<br>자원 획득 순서를 표준화하고, 대기·에스컬레이션 이벤트를 모니터링해 수치로 관리하면 지연과 데드락을 동시에 낮출 수 있다.</p><h5 id=lock-duration-핵심-원칙표>Lock Duration 핵심 원칙표<a hidden class=anchor aria-hidden=true href=#lock-duration-핵심-원칙표>#</a></h5><table><thead><tr><th>원칙</th><th>설명</th><th>목적</th><th>필요한 이유</th><th>적용 체크포인트</th></tr></thead><tbody><tr><td>최소 점유</td><td>최소 범위·시간만 보유</td><td>동시성↑</td><td>불필요 대기·교착 감소</td><td>쿼리 범위·보유 구간 검토</td></tr><tr><td>보수적 해제</td><td>커밋까지 보유 (필요 시)</td><td>무결성↑</td><td>더티/연쇄 롤백 방지</td><td>Strict/Rigorous 적용 대상</td></tr><tr><td>정밀 범위</td><td>인덱스·의도락으로 한정</td><td>광역 차단↓</td><td>광범위 경합 방지</td><td>등가→범위·커버링 인덱스</td></tr><tr><td>일관된 순서</td><td>자원 획득 순서 표준</td><td>교착 예방</td><td>순서 불일치 제거</td><td>테이블·키 잠금 순서 규약</td></tr><tr><td>공정성</td><td>큐·노후화로 기아 방지</td><td>지연 안정</td><td>장대기 제거</td><td>대기 큐 정책·우선순위</td></tr><tr><td>관측</td><td>지표 기반 운영</td><td>예측성↑</td><td>원인 파악·튜닝</td><td>p95/99, 리드 - 블로커</td></tr></tbody></table><p>원칙은 " 작게·짧게·정확하게 잡고, 순서와 공정성을 지키며, 수치로 관리 " 로 귀결된다.</p><h5 id=lock-duration-설계-철학표>Lock Duration 설계 철학표<a hidden class=anchor aria-hidden=true href=#lock-duration-설계-철학표>#</a></h5><table><thead><tr><th>설계 철학</th><th>설명</th><th>목적</th><th>필요한 이유</th><th>설계 지침</th></tr></thead><tbody><tr><td>2PL 규율</td><td>성장/축소 단계 구분</td><td>직렬성 보장</td><td>순서 왜곡 차단</td><td>해제는 축소 단계에서만</td></tr><tr><td>하이브리드</td><td>읽기=스냅샷, 쓰기=락</td><td>처리량↑</td><td>읽기 블로킹 제거</td><td>읽기 경로 MVCC/SSI</td></tr><tr><td>짧은 트랜잭션</td><td>업무 분할·외부 I/O 분리</td><td>보유시간↓</td><td>대기 전파 차단</td><td>단건/배치 슬라이싱</td></tr><tr><td>인덱스/파티션</td><td>범위 정밀화·핫스팟 분산</td><td>경합↓</td><td>스캔=잠금 구간</td><td>등가→범위·프루닝</td></tr><tr><td>정책 운영</td><td>타임아웃·에스컬 임계</td><td>예측성↑</td><td>가변 부하 대응</td><td>SLO 기반 수치 튜닝</td></tr></tbody></table><p>철학은 " 규율로 안전을, 역할 분리로 처리량을, 구조와 정책으로 예측성을 " 확보하는 방향이다.</p><h4 id=락-지속시간-동작-원리부터-흐름까지>락 지속시간: 동작 원리부터 흐름까지<a hidden class=anchor aria-hidden=true href=#락-지속시간-동작-원리부터-흐름까지>#</a></h4><p>트랜잭션은 자원에 S/X 락을 요청하고, 호환성 매트릭스가 허용하면 즉시 부여되어 락 지속시간이 시작된다.<br>2PL 규칙 때문에 중간에 임의 해제는 제한되고, Strict/Rigorous 방식이면 커밋까지 유지된다.<br>읽기는 격리수준과 MVCC 여부에 따라 S- 락을 짧게 혹은 생략할 수 있고, 쓰기는 X- 락을 커밋까지 보유한다. 의도락·인덱스 경로는 " 얼마나 넓게 " 잠그는지를, 타임아웃·데드락 탐지·에스컬레이션은 " 얼마나 오래 " 잡는지를 좌우한다.</p><h5 id=기본-동작-메커니즘>기본 동작 메커니즘<a hidden class=anchor aria-hidden=true href=#기본-동작-메커니즘>#</a></h5><ul><li>시작: 트랜잭션이 (리소스, 모드) 요청 → 락 매니저가 호환성 매트릭스 평가 → 부여 시 지속시간 시작, 불가 시 대기 큐.</li><li>보유: 2PL 하에서 추가 락은 성장 단계에서만; 읽기는 격리수준·MVCC 에 따라 단문/트랜잭션 단위 보유 또는 생략. 인덱스 범위 스캔이면 키 - 범위/넥스트키로 보호 구간 유지.</li><li>제어: 타임아웃, NOWAIT/SKIP LOCKED, 에스컬레이션 임계, 데드락 탐지 (대기 그래프) 로 대기/교착을 관리.</li><li>종료: 커밋/롤백 시 일괄 해제 (Strict/Rigorous 는 커밋 때), 세션 종료·타임아웃 시 강제 해제. 이후 대기 큐 재평가.</li></ul><h5 id=락-지속시간-동작-요약표>락 지속시간 동작 요약표<a hidden class=anchor aria-hidden=true href=#락-지속시간-동작-요약표>#</a></h5><table><thead><tr><th>단계</th><th>입력</th><th>핵심 판단 (원리)</th><th>동작 (메커니즘)</th><th>지속시간에의 영향</th><th>보완 포인트</th></tr></thead><tbody><tr><td>요청</td><td>(리소스, 모드)</td><td>호환성 매트릭스</td><td>부여/대기 큐 삽입</td><td>시작 시점 결정</td><td>NOWAIT/타임아웃 설정</td></tr><tr><td>보유</td><td>트랜잭션 작업</td><td>2PL·격리수준</td><td>읽기 S- 락/버전, 쓰기 X- 락</td><td>길이/범위 결정</td><td>인덱스/의도락/범위 설계</td></tr><tr><td>제어</td><td>경합·지연</td><td>공정성·안전</td><td>데드락 탐지·에스컬·재시도</td><td>과도 연장 방지</td><td>큐 정책·임계값 튜닝</td></tr><tr><td>종료</td><td>커밋/롤백</td><td>2PL 변형</td><td>일괄 해제·통지</td><td>종료 시점 결정</td><td>커밋 창 최소화</td></tr><tr><td>복구</td><td>크래시</td><td>안전 규약</td><td>고아 락 정리</td><td>비정상 연장 방지</td><td>세션/트랜잭션 GC</td></tr></tbody></table><p>매트릭스가 시작을, 2PL/격리·인덱스가 길이와 범위를, 타임아웃/탐지/에스컬이 과도 연장을 제어한다.</p><h5 id=락-지속시간-흐름-다이어그램>락 지속시간 흐름 다이어그램<a hidden class=anchor aria-hidden=true href=#락-지속시간-흐름-다이어그램>#</a></h5><pre class=mermaid>flowchart TD
  A[BEGIN TRANSACTION] --&gt; B[&#34;요청: (리소스, 모드)&#34;]
  B --&gt; C{호환성 매트릭스 OK?}
  C -- 예 --&gt; D[락 부여 &amp; 지속시간 시작]
  C -- 아니오 --&gt; E{정책}
  E -- NOWAIT --&gt; F[즉시 실패/재시도]
  E -- WAIT --&gt; G[대기 큐 등록]
  E -- SKIP LOCKED --&gt; H[잠긴 행 건너뛰고 진행]

  D --&gt; I{2PL 성장 단계?}
  I -- 예 --&gt; J[추가 락 가능]
  I -- 아니오 --&gt; K[해제만 가능]

  D --&gt; L{읽기 경로?}
  L -- MVCC/SSI --&gt; M[&#34;버전 읽기(락 생략/단문)&#34;]
  L -- RR/Serializable --&gt; N[&#34;S-락 유지(범위/프레디킷/넥스트키)&#34;]

  D --&gt; O{에스컬레이션 임계 초과?}
  O -- 예 --&gt; P[상위 락 승격]
  O -- 아니오 --&gt; Q[유지]

  D --&gt; R{데드락 탐지 주기}
  R --&gt;|사이클 발견| S[희생자 선택·롤백]
  R --&gt;|없음| Q

  G --&gt; C
  J --&gt; Q
  K --&gt; Q
  M --&gt; Q
  N --&gt; Q
  P --&gt; Q

  Q --&gt; T{COMMIT/ROLLBACK?}
  T -- 예 --&gt; U[&#34;일괄 해제(Strict/Rigorous: 커밋 시)&#34;]
  U --&gt; V[대기 큐 재평가·부여]
  V --&gt; W[END]
  T -- 아니오 --&gt; Q
</pre><p>요청은 매트릭스 평가로 즉시 부여·대기·우회 중 하나로 결정된다. 보유 중에는 2PL 규칙과 격리수준·MVCC 가 읽기 락의 지속을 정의하고, 인덱스 범위는 보호 구간을 형성한다. 에스컬레이션·데드락 탐지·타임아웃이 과도한 연장을 통제한다. 종료 시 일괄 해제 후 대기 큐를 재평가한다.</p><h4 id=락-지속시간-요청대기부여해제의-전모>락 지속시간: 요청·대기·부여·해제의 전모<a hidden class=anchor aria-hidden=true href=#락-지속시간-요청대기부여해제의-전모>#</a></h4><p>트랜잭션은 먼저 상위 객체에 의도 잠금 (IS/IX) 을 걸어 " 아래에서 S/X 를 잡겠다 " 는 의사를 밝힌다.<br>호환되면 하위 (페이지·행) 에서 실제 S/X 를 획득하고 작업을 수행한다.<br>충돌하면 대기큐로 들어가고, NOWAIT 면 즉시 실패한다.<br>타임아웃이면 롤백·재시도를 택한다.</p><p>Strict 2PL 에서는 커밋 시점까지 락을 유지해 복구가 쉽지만 대기가 늘 수 있다.<br>반대로 작업 단위 후 즉시 해제하면 대기는 줄지만 재시도·팬텀이 늘 수 있다.<br>실무에서는 상→하 획득, 일관된 락 순서, 적절한 타임아웃·백오프, 업그레이드 최소화로 지연과 교착을 줄인다.</p><h5 id=락-흐름-단계예외튜닝-한눈에>락 흐름 단계·예외·튜닝 한눈에<a hidden class=anchor aria-hidden=true href=#락-흐름-단계예외튜닝-한눈에>#</a></h5><ul><li><strong>요청→판정:</strong> <code>LOCK(req)</code> 가 오면 Lock Table 의 보유/대기 목록과 호환성 매트릭스로 즉시 판정한다.</li><li><strong>대기 제어:</strong> 불가면 <strong>대기큐</strong>(FIFO/우선순위) 로 이동, NOWAIT 이면 실패 반환, 타임아웃이면 중단·정책적 재시도.</li><li><strong>획득·유지:</strong> 호환되면 <strong>Granted</strong>. Strict 2PL 은 커밋/어보트까지 보유, 일반은 작업 단위 완료 시 해제 가능.</li><li><strong>업그레이드:</strong> S→X 는 별도 큐에서 <strong>기아 방지</strong>와 <strong>교착 회피</strong> 정책이 필요.</li><li><strong>해제·깨우기:</strong> 해제 시 같은 리소스의 대기큐를 깨우고 순서대로 재평가.</li><li><strong>감시:</strong> 데드락 탐지기 (Wait-For Graph) 로 순환 대기 발견 시 <strong>희생 Tx</strong>를 선정해 해제 트리거.</li></ul><table><thead><tr><th>단계</th><th>입력/상태</th><th>핵심 로직</th><th>결과/출력</th><th>실패·예외 경로</th><th>실무 포인트</th></tr></thead><tbody><tr><td>요청 (Requested)</td><td>TxID, 리소스, 모드, 정책</td><td>호환성 매트릭스 조회</td><td>부여 또는 대기</td><td>NOWAIT→즉시 실패</td><td>상→하 의도 잠금 선행</td></tr><tr><td>대기 (Waiting)</td><td>대기큐 등록</td><td>공정/우선순위 스케줄링</td><td>차례 도래 시 재평가</td><td>타임아웃/취소</td><td>긴 꼬리 지연 경보</td></tr><tr><td>부여 (Granted)</td><td>락 보유</td><td>작업 실행, 업그레이드 관리</td><td>처리량 산출</td><td>업그레이드 교착</td><td>업그레이드 최소화</td></tr><tr><td>해제 (Released)</td><td>커밋/롤백/명시적</td><td>큐 깨우기·재평가</td><td>다음 Tx 부여</td><td>—</td><td>배치 해제는 쓰로틀</td></tr><tr><td>감시 (Monitor)</td><td>대기그래프</td><td>데드락 탐지</td><td>희생자 중단</td><td>잘못된 선택→재폭주</td><td>희생 기준 일관성</td></tr></tbody></table><ul><li><strong>요약:</strong> 상→하 획득, 공정 큐, 타임아웃·NOWAIT, 업그레이드 억제가 락 지속시간과 대기 꼬리를 좌우한다.</li></ul><h5 id=lock-duration-제어-플로우차트>Lock Duration 제어 플로우차트<a hidden class=anchor aria-hidden=true href=#lock-duration-제어-플로우차트>#</a></h5><pre class=mermaid>flowchart TD
    A[Start/Tx begins] --&gt; B[&#34;Intent Lock on Parent (IS/IX/SIX)&#34;]
    B --&gt;|Compatible| C[&#34;Request Child Lock (S/X)&#34;]
    B --&gt;|Incompatible| WQ[Enqueue in Wait Queue]

    C --&gt;|Granted| D[Execute Work]
    C --&gt;|Upgrade S→X needed?| U{Upgrade Allowed?}

    U --&gt;|Yes| UQ[Upgrade Queue]
    UQ --&gt;|Granted| D
    U --&gt;|No| TO[Timeout/Abort Policy]

    WQ --&gt;|NOWAIT| NW[Fail Fast/Retry Backoff]
    WQ --&gt;|Wait| RCHK{Timeout reached?}
    RCHK --&gt;|Yes| TO2[Abort &amp; Retry Policy]
    RCHK --&gt;|No| C

    D --&gt;|Strict 2PL?| S2PL{Hold until Commit}
    S2PL --&gt;|Yes| COMMIT[Commit/Abort]
    S2PL --&gt;|No| REL[Release after Unit of Work]

    REL --&gt; WAKE[Wake Next Waiter]
    COMMIT --&gt; WAKE
    WAKE --&gt; C

    %% Deadlock side path
    MON[Wait-For Graph Monitor] --&gt;|Cycle?| VICTIM[Select Victim &amp; Abort]
    VICTIM --&gt; WAKE
</pre><h5 id=락-생명주기-상태-머신>락 생명주기 상태 머신<a hidden class=anchor aria-hidden=true href=#락-생명주기-상태-머신>#</a></h5><pre class=mermaid>stateDiagram-v2
    [*] --&gt; Requested
    Requested --&gt; Granted: Compatible &amp; Free
    Requested --&gt; Waiting: Incompatible/Busy
    Waiting --&gt; Granted: Woken &amp; Compatible
    Waiting --&gt; Timeout: Wait limit exceeded
    Granted --&gt; UpgradePending: S→X requested
    UpgradePending --&gt; Granted: Upgrade granted
    UpgradePending --&gt; Waiting: Upgrade blocked
    Granted --&gt; Released: Explicit release / Unit done
    Granted --&gt; CommitHold: Strict 2PL
    CommitHold --&gt; Released: Commit/Abort
    Waiting --&gt; DeadlockDetected: Cycle in WFG
    DeadlockDetected --&gt; Aborted: Victim selected
    Timeout --&gt; Aborted
    Aborted --&gt; Released
    Released --&gt; [*]
</pre><h3 id=특성-분석-및-평가>특성 분석 및 평가<a hidden class=anchor aria-hidden=true href=#특성-분석-및-평가>#</a></h3><h4 id=락-지속시간-성능정합성의-분기점>락 지속시간, 성능·정합성의 분기점<a hidden class=anchor aria-hidden=true href=#락-지속시간-성능정합성의-분기점>#</a></h4><ul><li>오래 잠그면 안전하지만 느려지고 (대기↑), 짧게 잠그면 빠르지만 오류 위험이 커진다.</li><li>미세락은 동시에 많이 돌릴 수 있지만 관리가 복잡해지고, 큰 단위 락은 관리가 쉽지만 많은 요청을 막아선다.</li><li>실무는 **읽기는 최대한 비차단 (MVCC), 쓰기는 필요한 동안만 강하게 (2PL)**가 기본. 여기에 <strong>업그레이드 최소화, 피크타임엔 미세락, 비피크엔 에스컬</strong> 같은 운영 룰을 더해 성능과 안정성을 동시에 잡는다.</li></ul><h5 id=주요-선택지별-트레이드오프-매트릭스>주요 선택지별 트레이드오프 매트릭스<a hidden class=anchor aria-hidden=true href=#주요-선택지별-트레이드오프-매트릭스>#</a></h5><table><thead><tr><th>비교 항목</th><th>A 선택지</th><th>장점</th><th>단점</th><th>선정 기준 (핵심 지표)</th><th>관련 트레이드오프</th></tr></thead><tbody><tr><td>보유시간</td><td><strong>짧게</strong></td><td>동시성↑, TPS↑</td><td>Dirty/NRR/팬텀 위험↑(조건)</td><td>오류 허용도, 재시도 예산, SLA</td><td>일관성↔병렬성</td></tr><tr><td></td><td><strong>길게</strong></td><td>정합성·예측성↑, 복구 용이</td><td>대기·데드락률↑, TPS↓</td><td>데이터 중요도, p95/99 목표</td><td>일관성↔병렬성, 예측성↔TPS</td></tr><tr><td>세분성</td><td><strong>Row</strong></td><td>차단폭↓, 병렬성↑</td><td>메타비용·락수↑</td><td>충돌 핫스팟 분포, 메모리</td><td>세분성↔관리비용</td></tr><tr><td></td><td><strong>Table</strong></td><td>관리 단순, 에스컬 비용↓</td><td>차단폭↑, HOL↑</td><td>대량스캔 빈도, 배치 창</td><td>세분성↔관리비용</td></tr><tr><td>프로토콜</td><td><strong>Strict/Rigorous</strong></td><td>연쇄중단 방지, 예측성↑</td><td>보유기간↑, TPS↓</td><td>복구 용이성, 규제 요구</td><td>안전성↔활성성, 예측성↔TPS</td></tr><tr><td></td><td><strong>Relaxed+ 재시도</strong></td><td>평균 처리량↑</td><td>재시도·꼬리지연↑</td><td>재시도 비용, 타임아웃 정책</td><td>안정성↔성능</td></tr><tr><td>업그레이드</td><td><strong>초기 X/U/SIX</strong></td><td>데드락 경로 차단, 지연 분산↓</td><td>과잠금 위험</td><td>쓰기비중, 지역성</td><td>데드락↔과잠금</td></tr><tr><td></td><td><strong>S→X 업그레이드</strong></td><td>초반 병렬성↑</td><td>교차대기·데드락↑</td><td>갱신 비율 낮음</td><td>지연분산↔데드락</td></tr><tr><td>범위 제어</td><td><strong>프레디킷/넥스트키</strong></td><td>팬텀 차단</td><td>과대차단, 인덱스 의존</td><td>선택도, 쿼리 형태</td><td>정확성↔차단폭</td></tr><tr><td>운영</td><td><strong>동적 에스컬</strong></td><td>메타비용↓, 예측성↑</td><td>순간 차단폭↑</td><td>시간대·파티션 지표</td><td>메타비용↔차단폭</td></tr></tbody></table><p><em>보유시간·세분성·업그레이드·범위 제어</em> 네 가지가 성능과 정합성을 좌우하는 핵심 레버다. 지표 (p95 지연, 데드락률, 에스컬 카운트) 로 지속 점검하며 조합을 조절하라.</p><h5 id=하이브리드-운용-레시피-모음>하이브리드 운용 레시피 모음<a hidden class=anchor aria-hidden=true href=#하이브리드-운용-레시피-모음>#</a></h5><table><thead><tr><th>방법</th><th>목적 (어떤 트레이드오프를 풀나)</th><th>구성 요소</th><th>장점</th><th>고려사항</th></tr></thead><tbody><tr><td>MVCC 읽기 + 2PL 쓰기</td><td>일관성↔병렬성</td><td>스냅샷 읽기, 쓰기 X 보유</td><td>읽기 비차단, 쓰기 정합성</td><td>버전 GC, 쓰기 경합은 여전</td></tr><tr><td>SIX 패턴</td><td>대량읽기·부분쓰기의 차단폭↓</td><td>상위 S + 하위 X</td><td>스캔 병행성↑, 수정 안전</td><td>상위 S 로 인한 경합 주의</td></tr><tr><td>초기 X/U 로 업그레이드 제거</td><td>데드락↔과잠금</td><td>U/SIX/초기 X</td><td>교착 경로 차단</td><td>과잠금·보유시간 증가 가능</td></tr><tr><td>시간대/파티션별 에스컬</td><td>메타비용↔차단폭</td><td>임계×시간대×파티션</td><td>메타비용↓, 예측성↑</td><td>피크 차단폭 관리 필요</td></tr><tr><td>큐잉 + <code>SKIP LOCKED</code></td><td>HOL·충돌 완화</td><td>작업큐, 배타 처리</td><td>대기 분산, 처리량 안정</td><td>순서보장·재시도 설계</td></tr><tr><td>샤딩/파티션 로컬락</td><td>차단 국소화</td><td>키 - 레인지 분할</td><td>충돌 격리, 확장성</td><td>분포 불균형·스플릿 관리</td></tr></tbody></table><p><strong>요약</strong>: 단일 선택보다 <strong>조합</strong>이 훨씬 강력하다. 읽기는 비차단, 쓰기는 정밀 제어, 운영은 시간·공간 (파티션) 으로 나눠 다르게 대한다.</p><h3 id=34-적용-적합성-평가>3.4 적용 적합성 평가<a hidden class=anchor aria-hidden=true href=#34-적용-적합성-평가>#</a></h3><h4 id=락을-오래-쥘-경로와-그렇지-않은-경로>락을 오래 쥘 경로와 그렇지 않은 경로<a hidden class=anchor aria-hidden=true href=#락을-오래-쥘-경로와-그렇지-않은-경로>#</a></h4><p>락 지속시간은 " 얼마나 오래 자원을 붙잡는가 " 다. 돈·주문처럼 틀리면 안 되는 경로는 커밋까지 락을 쥐는 게 맞다 (Strict). 대신 읽기가 많거나 초저지연이면 오래 잡는 락은 병목을 만든다. 이때는 읽기를 스냅샷으로 분리하고, 범위 무결성이 꼭 필요한 일부 경로만 강하게 보호해 총비용을 낮춘다.</p><h5 id=락-지속시간-관점의-적용-판단-기준>락 지속시간 관점의 적용 판단 기준<a hidden class=anchor aria-hidden=true href=#락-지속시간-관점의-적용-판단-기준>#</a></h5><h6 id=설계-관점>설계 관점<a hidden class=anchor aria-hidden=true href=#설계-관점>#</a></h6><ul><li><strong>적합</strong>: 짧은 트랜잭션, 작은 핫셋, <strong>강한 참조/범위 무결성</strong> 필요 (주문·권한·재무상태 변경). Strict/Rigorous 로 커밋 시 해제.</li><li><strong>조건부</strong>: 스캔 + 부분 갱신은 <strong>SIX+ 하위 X</strong>와 인덱스로 후보 축소. 범위 불변이면 <strong>키 - 범위/Serializable</strong>로 경로 한정 상승.</li><li><strong>부적합/대안</strong>: 대규모 읽기·캐시 친화 서비스, 실시간 스트리밍 → MVCC/락리스·OCC·CQRS 로 읽기 분리.</li></ul><h6 id=분석-관점>분석 관점<a hidden class=anchor aria-hidden=true href=#분석-관점>#</a></h6><ul><li><strong>지표 중심</strong>: P95 락 보유시간, 락 대기율, 데드락/분, 에스컬레이션률, 상위 충돌률.</li><li><strong>임계 예시</strong>: P95 보유 ≤ 150–200ms, 데드락/분 ≤ 0.01, 상위 충돌률 ≤ 5%. 초과 시 <strong>락 지속시간 단축</strong>(쿼리 프루닝·경계 단축·승격 예외).</li></ul><h6 id=운영-관점>운영 관점<a hidden class=anchor aria-hidden=true href=#운영-관점>#</a></h6><ul><li><strong>대기 관리</strong>: LOCK_TIMEOUT/DEADLOCK_TIMEOUT, 지수 백오프 + 멱등 재시도.</li><li><strong>격리 정책</strong>: 읽기 스냅샷 기본, <strong>쓰기 경로만</strong> Strict. 범위 민감 경로만 Serializable.</li><li><strong>분산</strong>: 샤드 키 순서 고정, 교차 트랜잭션 분해 (사가) 로 장시간 보유 방지.</li></ul><h5 id=lock-duration-관점의-적합성-매트릭스>Lock Duration 관점의 적합성 매트릭스<a hidden class=anchor aria-hidden=true href=#lock-duration-관점의-적합성-매트릭스>#</a></h5><table><thead><tr><th>시나리오/환경</th><th>적합도</th><th>근거 (락 지속시간 관점)</th><th>권장 전략</th><th>리스크</th><th>보완책</th></tr></thead><tbody><tr><td>금융·의료 핵심 OLTP</td><td>높음</td><td>커밋까지 보유해도 SLO 수용, 강 무결성 필요</td><td>Strict/Rigorous, 핫셋 인덱싱</td><td>대기/데드락</td><td>타임아웃·우선순위·멱등</td></tr><tr><td>중간 동시성 B2B 웹</td><td>중~높음</td><td>트랜잭션 짧고 경합 중간</td><td>Strict+MVCC 읽기</td><td>간헐적 핫키</td><td>샤딩·캐시·프루닝</td></tr><tr><td>대규모 읽기 중심</td><td>낮음</td><td>오래 잡는 락이 TPS 저해</td><td>MVCC/락리스, 리드 리플리카</td><td>스테일 읽기</td><td>SLA·캐시 무효화</td></tr><tr><td>스캔 + 부분 갱신</td><td>중간</td><td>스캔 동안 보유시간 증가</td><td>SIX+ 행 X, 후보 축소</td><td>상위 충돌</td><td>승격 예외·야간 배치</td></tr><tr><td>초저지연 실시간</td><td>낮음</td><td>밀리초 단위 보유도 부담</td><td>OCC/큐·사가</td><td>재시도 폭증</td><td>경량 파티션·분해</td></tr><tr><td>분석/배치 DWH</td><td>낮음</td><td>장기 보유로 OLTP 차단</td><td>스냅샷/리플리카·분리</td><td>데이터 신선도</td><td>파이프라인 분리</td></tr></tbody></table><p><strong>요약</strong>: 무결성이 우선인 코어 경로는 " 오래 잡는 락 (Strict)&rdquo; 이 맞고, 읽기 대량·초저지연·분산에선 " 오래 잡지 않는 설계 (MVCC/OCC/분해)" 가 맞다. 경로별로 다르게 가져가면 총비용이 최소화된다.</p><h3 id=구현-방법-및-분류>구현 방법 및 분류<a hidden class=anchor aria-hidden=true href=#구현-방법-및-분류>#</a></h3><h4 id=락-지속시간-최적화-전술부터-운영까지>락 지속시간 최적화: 전술부터 운영까지<a hidden class=anchor aria-hidden=true href=#락-지속시간-최적화-전술부터-운영까지>#</a></h4><p>락 지속시간을 줄이는 핵심은 " 잠금이 필요한 범위와 시간을 동시에 줄이는 것 " 이다.<br>이를 위해 대기·보유의 상한 (타임아웃) 을 두고, 경합이 높으면 자동으로 상한을 낮춘다.<br>상하위 객체에 서로 다른 정책을 두어 광역 차단을 피하고, 읽기는 MVCC/SSI 로, 쓰기는 잠금으로 분리한다.<br>잠긴 행은 건너뛰거나 즉시 실패시켜 꼬리 지연을 막고, 에스컬레이션·데드락 정책으로 장대기를 제어한다.<br>마지막으로 인덱스·쿼리·트랜잭션을 다듬어 스캔 폭과 보유 시간을 함께 줄인다.</p><h5 id=lock-duration-구현-기법표>Lock Duration 구현 기법표<a hidden class=anchor aria-hidden=true href=#lock-duration-구현-기법표>#</a></h5><table><thead><tr><th>기법</th><th>정의/설명</th><th>특징</th><th>목적</th><th>사용 상황</th><th>예시</th></tr></thead><tbody><tr><td>타임아웃 기반</td><td>대기·보유 상한 설정</td><td>장대기 차단</td><td>응답성 확보</td><td>핫스팟/고경합</td><td>lock_timeout, innodb_lock_wait_timeout</td></tr><tr><td>적응형 타임아웃</td><td>지표 기반 동적 조정</td><td>p95/99 안정</td><td>지연 꼬리 절단</td><td>부하 변동 큼</td><td>컨텐션·부하로 가중치 산출</td></tr><tr><td>계층적 관리 (IS/IX/SIX)</td><td>상위→하위 락·시간 정책</td><td>범위 제어</td><td>광역 차단 방지</td><td>대용량 OLTP</td><td>테이블=긴, 행=짧은 정책</td></tr><tr><td>Strict 2PL</td><td>커밋까지 보유</td><td>안전↑</td><td>무결성·복구</td><td>금융·정합 우선</td><td>쓰기 경로 기본 전략</td></tr><tr><td>Conservative 2PL</td><td>시작 전 선점</td><td>교착 0</td><td>예측성</td><td>교착 비용 치명적</td><td>짧은 Tx, 락 수 예측 가능</td></tr><tr><td>MVCC/SSI+Lock</td><td>읽기=버전, 쓰기=락</td><td>읽기 무차단</td><td>처리량↑</td><td>읽기 다수</td><td>SELECT … FOR UPDATE + MVCC</td></tr><tr><td>NOWAIT/READPAST/SKIP</td><td>잠긴 행 우회/즉시 실패</td><td>꼬리 제거</td><td>대기 축소</td><td>실시간 응답</td><td>NOWAIT/READPAST/SKIP LOCKED</td></tr><tr><td>에스컬/세분화</td><td>임계 기반 승격/예외</td><td>관리비 절감</td><td>예측성</td><td>락 수 폭증</td><td>테이블별 임계·예외 지정</td></tr><tr><td>데드락 탐지/회피</td><td>그래프/정책 기반</td><td>장대기↓</td><td>안정성</td><td>혼합 워크로드</td><td>Wait-Die/Wound-Wait</td></tr><tr><td>인덱스·쿼리 설계</td><td>스캔 폭 축소</td><td>범위·시간↓</td><td>경합↓</td><td>범위 읽기</td><td>커버링·선행열·선택도</td></tr><tr><td>트랜잭션 분해</td><td>I/O 분리·슬라이싱</td><td>보유시간↓</td><td>전파 차단</td><td>장수 Tx</td><td>배치 슬라이싱</td></tr><tr><td>커밋 창 최소화</td><td>2PC·코디네이터 최적화</td><td>보유창↓</td><td>글로벌 정합</td><td>분산 Tx</td><td>Prepare→Commit 구간 압축</td></tr></tbody></table><h5 id=lock-duration-기법-분류>Lock Duration 기법 분류<a hidden class=anchor aria-hidden=true href=#lock-duration-기법-분류>#</a></h5><h6 id=a-시간정책-기반-제어>A. 시간·정책 기반 제어<a hidden class=anchor aria-hidden=true href=#a-시간정책-기반-제어>#</a></h6><p>대기·보유 상한과 우회 정책으로 실효 지속시간을 직접 절단한다.</p><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th>주 효과</th><th>주의점</th></tr></thead><tbody><tr><td>타임아웃</td><td>상한 설정</td><td>장대기 차단</td><td>오탐 중단 비용</td></tr><tr><td>적응형 타임아웃</td><td>지표 기반 동적</td><td>p99 안정화</td><td>튜닝 과적합</td></tr><tr><td>NOWAIT/READPAST/SKIP</td><td>우회/즉시 실패</td><td>꼬리 제거</td><td>누락 데이터 허용 판단</td></tr></tbody></table><ul><li>요약: " 기다리지 않기 " 와 " 빨리 포기하기 " 로 꼬리를 자른다.</li></ul><p><strong>타임아웃 기반 락 지속 시간 제어 예시</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a class=lnlinks href=#hl-4-31>31</a>
</span><span class=lnt id=hl-4-32><a class=lnlinks href=#hl-4-32>32</a>
</span><span class=lnt id=hl-4-33><a class=lnlinks href=#hl-4-33>33</a>
</span><span class=lnt id=hl-4-34><a class=lnlinks href=#hl-4-34>34</a>
</span><span class=lnt id=hl-4-35><a class=lnlinks href=#hl-4-35>35</a>
</span><span class=lnt id=hl-4-36><a class=lnlinks href=#hl-4-36>36</a>
</span><span class=lnt id=hl-4-37><a class=lnlinks href=#hl-4-37>37</a>
</span><span class=lnt id=hl-4-38><a class=lnlinks href=#hl-4-38>38</a>
</span><span class=lnt id=hl-4-39><a class=lnlinks href=#hl-4-39>39</a>
</span><span class=lnt id=hl-4-40><a class=lnlinks href=#hl-4-40>40</a>
</span><span class=lnt id=hl-4-41><a class=lnlinks href=#hl-4-41>41</a>
</span><span class=lnt id=hl-4-42><a class=lnlinks href=#hl-4-42>42</a>
</span><span class=lnt id=hl-4-43><a class=lnlinks href=#hl-4-43>43</a>
</span><span class=lnt id=hl-4-44><a class=lnlinks href=#hl-4-44>44</a>
</span><span class=lnt id=hl-4-45><a class=lnlinks href=#hl-4-45>45</a>
</span><span class=lnt id=hl-4-46><a class=lnlinks href=#hl-4-46>46</a>
</span><span class=lnt id=hl-4-47><a class=lnlinks href=#hl-4-47>47</a>
</span><span class=lnt id=hl-4-48><a class=lnlinks href=#hl-4-48>48</a>
</span><span class=lnt id=hl-4-49><a class=lnlinks href=#hl-4-49>49</a>
</span><span class=lnt id=hl-4-50><a class=lnlinks href=#hl-4-50>50</a>
</span><span class=lnt id=hl-4-51><a class=lnlinks href=#hl-4-51>51</a>
</span><span class=lnt id=hl-4-52><a class=lnlinks href=#hl-4-52>52</a>
</span><span class=lnt id=hl-4-53><a class=lnlinks href=#hl-4-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>LockManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>locks</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 자원별 락 정보</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeouts</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 락별 타임아웃 정보</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>,</span> <span class=n>lock_mode</span><span class=p>,</span> <span class=n>timeout_seconds</span><span class=o>=</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        락 획득 요청 처리
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            transaction_id: 트랜잭션 식별자
</span></span></span><span class=line><span class=cl><span class=s2>            resource_id: 자원 식별자
</span></span></span><span class=line><span class=cl><span class=s2>            lock_mode: 락 모드 (&#39;shared&#39;, &#39;exclusive&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>            timeout_seconds: 최대 락 보유 시간
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>lock_mode</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 기존 락 확인</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>lock_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>locks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>existing_lock</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>locks</span><span class=p>[</span><span class=n>lock_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># 호환성 검사 (공유 락끼리는 호환 가능)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>lock_mode</span> <span class=o>==</span> <span class=s1>&#39;shared&#39;</span> <span class=ow>and</span> <span class=n>existing_lock</span><span class=p>[</span><span class=s1>&#39;mode&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;shared&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 공유 락 추가</span>
</span></span><span class=line><span class=cl>                <span class=n>existing_lock</span><span class=p>[</span><span class=s1>&#39;holders&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>transaction_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>timeouts</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_time</span> <span class=o>+</span> <span class=n>timeout_seconds</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>  <span class=c1># 호환되지 않는 락 존재</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 새로운 락 생성</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>locks</span><span class=p>[</span><span class=n>lock_key</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;mode&#39;</span><span class=p>:</span> <span class=n>lock_mode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;holders&#39;</span><span class=p>:</span> <span class=p>{</span><span class=n>transaction_id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;acquired_time&#39;</span><span class=p>:</span> <span class=n>current_time</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 타임아웃 설정</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeouts</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_time</span> <span class=o>+</span> <span class=n>timeout_seconds</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 타임아웃 모니터링 스레드 시작</span>
</span></span><span class=line><span class=cl>        <span class=n>timer</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Timer</span><span class=p>(</span><span class=n>timeout_seconds</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_timeout_handler</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                               <span class=p>[</span><span class=n>transaction_id</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>timer</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_timeout_handler</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;타임아웃 시 락 강제 해제&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;락 타임아웃: Transaction </span><span class=si>{</span><span class=n>transaction_id</span><span class=si>}</span><span class=s2>, Resource </span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>release_lock</span><span class=p>(</span><span class=n>transaction_id</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>적응적 락 지속 시간 조정 예시</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a class=lnlinks href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a class=lnlinks href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a class=lnlinks href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a class=lnlinks href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a class=lnlinks href=#hl-5-26>26</a>
</span><span class=lnt id=hl-5-27><a class=lnlinks href=#hl-5-27>27</a>
</span><span class=lnt id=hl-5-28><a class=lnlinks href=#hl-5-28>28</a>
</span><span class=lnt id=hl-5-29><a class=lnlinks href=#hl-5-29>29</a>
</span><span class=lnt id=hl-5-30><a class=lnlinks href=#hl-5-30>30</a>
</span><span class=lnt id=hl-5-31><a class=lnlinks href=#hl-5-31>31</a>
</span><span class=lnt id=hl-5-32><a class=lnlinks href=#hl-5-32>32</a>
</span><span class=lnt id=hl-5-33><a class=lnlinks href=#hl-5-33>33</a>
</span><span class=lnt id=hl-5-34><a class=lnlinks href=#hl-5-34>34</a>
</span><span class=lnt id=hl-5-35><a class=lnlinks href=#hl-5-35>35</a>
</span><span class=lnt id=hl-5-36><a class=lnlinks href=#hl-5-36>36</a>
</span><span class=lnt id=hl-5-37><a class=lnlinks href=#hl-5-37>37</a>
</span><span class=lnt id=hl-5-38><a class=lnlinks href=#hl-5-38>38</a>
</span><span class=lnt id=hl-5-39><a class=lnlinks href=#hl-5-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdaptiveLockManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base_timeout</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># 기본 타임아웃 (초)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 자원별 경합 횟수</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>system_load_factor</span> <span class=o>=</span> <span class=mf>1.0</span>  <span class=c1># 시스템 부하 계수</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_adaptive_timeout</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        적응적 타임아웃 계산
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            resource_id: 자원 식별자
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            조정된 타임아웃 시간
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 해당 자원의 경합 수준 확인</span>
</span></span><span class=line><span class=cl>        <span class=n>contention_count</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>resource_id</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 경합이 높을수록 타임아웃 단축</span>
</span></span><span class=line><span class=cl>        <span class=n>contention_factor</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>1.0</span> <span class=o>-</span> <span class=p>(</span><span class=n>contention_count</span> <span class=o>*</span> <span class=mf>0.1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 시스템 부하가 높을수록 타임아웃 단축</span>
</span></span><span class=line><span class=cl>        <span class=n>load_factor</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>1.0</span> <span class=o>-</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>system_load_factor</span> <span class=o>-</span> <span class=mf>1.0</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 최종 타임아웃 계산</span>
</span></span><span class=line><span class=cl>        <span class=n>adaptive_timeout</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_timeout</span> <span class=o>*</span> <span class=n>contention_factor</span> <span class=o>*</span> <span class=n>load_factor</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>adaptive_timeout</span><span class=p>)</span>  <span class=c1># 최소 1초 보장</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_contention_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>,</span> <span class=n>is_contention</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;경합 통계 업데이트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resource_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span><span class=p>[</span><span class=n>resource_id</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>is_contention</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span><span class=p>[</span><span class=n>resource_id</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 성공적인 락 획득 시 경합 카운트 감소</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span><span class=p>[</span><span class=n>resource_id</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>lock_contentions</span><span class=p>[</span><span class=n>resource_id</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=b-프로토콜격리-기반>B. 프로토콜·격리 기반<a hidden class=anchor aria-hidden=true href=#b-프로토콜격리-기반>#</a></h6><p>2PL 변형과 MVCC/SSI 로 락의 <strong>필요성</strong>과 <strong>보유 구간</strong>을 설계한다.</p><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th>주 효과</th><th>주의점</th></tr></thead><tbody><tr><td>Strict 2PL</td><td>커밋까지 보유</td><td>복구·무결성↑</td><td>대기↑</td></tr><tr><td>Conservative 2PL</td><td>선점</td><td>교착 0</td><td>초기 대기↑</td></tr><tr><td>MVCC/SSI+Lock</td><td>읽기 무차단</td><td>처리량↑</td><td>재시도/GC 비용</td></tr></tbody></table><ul><li>요약: 읽기는 부드럽게, 쓰기는 강하게. 안전·성능 균형.</li></ul><h6 id=c-계층범위-기반>C. 계층·범위 기반<a hidden class=anchor aria-hidden=true href=#c-계층범위-기반>#</a></h6><p>IS/IX/SIX 와 인덱스·선행열·커버링으로 <strong>어디를</strong> 얼마나 <strong>넓게</strong> 잠글지 제어한다.</p><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th>주 효과</th><th>주의점</th></tr></thead><tbody><tr><td>의도락·계층 정책</td><td>상→하 일관</td><td>광역 차단↓</td><td>정책 일관성 필요</td></tr><tr><td>에스컬/세분화</td><td>임계 승격/예외</td><td>관리비↓</td><td>동시성 저하 위험</td></tr><tr><td>인덱스 설계</td><td>스캔 폭 축소</td><td>범위·시간↓</td><td>설계 난도</td></tr></tbody></table><ul><li>요약: 범위를 정밀화하면 시간도 함께 줄어든다.</li></ul><p><strong>계층적 락 지속 시간 관리 예시</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a class=lnlinks href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a class=lnlinks href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a class=lnlinks href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a class=lnlinks href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a class=lnlinks href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a class=lnlinks href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a class=lnlinks href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a class=lnlinks href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a class=lnlinks href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a class=lnlinks href=#hl-6-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>HierarchicalLockManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock_hierarchy</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;database&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;default_timeout&#39;</span><span class=p>:</span> <span class=mi>300</span><span class=p>,</span> <span class=s1>&#39;escalation_threshold&#39;</span><span class=p>:</span> <span class=mi>1000</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;table&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;default_timeout&#39;</span><span class=p>:</span> <span class=mi>120</span><span class=p>,</span> <span class=s1>&#39;escalation_threshold&#39;</span><span class=p>:</span> <span class=mi>500</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;page&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;default_timeout&#39;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;escalation_threshold&#39;</span><span class=p>:</span> <span class=mi>100</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;row&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;default_timeout&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span> <span class=s1>&#39;escalation_threshold&#39;</span><span class=p>:</span> <span class=mi>50</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>active_locks</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 수준별 활성 락 카운트</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire_hierarchical_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>transaction_id</span><span class=p>,</span> <span class=n>resource_path</span><span class=p>,</span> <span class=n>lock_mode</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        계층적 락 획득
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            transaction_id: 트랜잭션 ID
</span></span></span><span class=line><span class=cl><span class=s2>            resource_path: [&#39;database&#39;, &#39;table_name&#39;, &#39;page_id&#39;, &#39;row_id&#39;]
</span></span></span><span class=line><span class=cl><span class=s2>            lock_mode: 락 모드
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 상위 레벨부터 순차적으로 락 획득</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>level</span><span class=p>,</span> <span class=n>resource_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>([</span><span class=s1>&#39;database&#39;</span><span class=p>,</span> <span class=s1>&#39;table&#39;</span><span class=p>,</span> <span class=s1>&#39;page&#39;</span><span class=p>,</span> <span class=s1>&#39;row&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>level</span> <span class=o>&gt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>resource_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=n>level_name</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_hierarchy</span><span class=o>.</span><span class=n>keys</span><span class=p>())[</span><span class=n>level</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_hierarchy</span><span class=p>[</span><span class=n>level_name</span><span class=p>][</span><span class=s1>&#39;default_timeout&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 해당 수준의 락 획득</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_acquire_level_lock</span><span class=p>(</span><span class=n>transaction_id</span><span class=p>,</span> <span class=n>level_name</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                          <span class=n>resource_path</span><span class=p>[</span><span class=n>level</span><span class=p>],</span> <span class=n>lock_mode</span><span class=p>,</span> <span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 락 획득 실패 시 이미 획득한 상위 락들 해제</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_release_acquired_locks</span><span class=p>(</span><span class=n>transaction_id</span><span class=p>,</span> <span class=n>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_escalation_needed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>level_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;락 에스컬레이션 필요성 검사&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_count</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_locks</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>level_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>threshold</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_hierarchy</span><span class=p>[</span><span class=n>level_name</span><span class=p>][</span><span class=s1>&#39;escalation_threshold&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>current_count</span> <span class=o>&gt;</span> <span class=n>threshold</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=d-운영관측자동화>D. 운영·관측·자동화<a hidden class=anchor aria-hidden=true href=#d-운영관측자동화>#</a></h6><p>관측치로 정책을 폐루프 튜닝해 실효 지속시간을 유지한다.</p><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th>주 효과</th><th>주의점</th></tr></thead><tbody><tr><td>모니터링</td><td>대기 사슬/에스컬 이벤트</td><td>원인 가시화</td><td>오버헤드</td></tr><tr><td>데드락 탐지/회피</td><td>그래프/정책</td><td>장대기↓</td><td>희생자 비용</td></tr><tr><td>SLO 기반 튜닝</td><td>p95/99 목표</td><td>예측성↑</td><td>SLA 연동 필요</td></tr></tbody></table><ul><li>요약: 보지 못하면 줄일 수 없다. 계측과 목표 기반 운영.</li></ul><h6 id=e-분산-커밋전역-일관성>E. 분산 커밋·전역 일관성<a hidden class=anchor aria-hidden=true href=#e-분산-커밋전역-일관성>#</a></h6><p>2PC·코디네이터·커밋 창 최적화로 분산 환경의 보유 구간을 최소화한다.</p><table><thead><tr><th>항목</th><th>핵심 아이디어</th><th>주 효과</th><th>주의점</th></tr></thead><tbody><tr><td>2PC 커밋 창 축소</td><td>Prepare→Commit 단축</td><td>보유창↓</td><td>네트워크 지연</td></tr><tr><td>리더/샤딩 정렬</td><td>핫스팟 분산</td><td>경합↓</td><td>라우팅 비용</td></tr><tr><td>멱등·사가 보상</td><td>실패시 보상</td><td>지연↓</td><td>도메인 복잡성</td></tr></tbody></table><ul><li>요약: 커밋 직전 구간을 짧게, 핫스팟을 넓게 분산.</li></ul><h5 id=lock-duration-통합-요약표>Lock Duration 통합 요약표<a hidden class=anchor aria-hidden=true href=#lock-duration-통합-요약표>#</a></h5><table><thead><tr><th>카테고리</th><th>대표 기법</th><th>핵심 효과</th><th>대표 상황</th><th>핵심 리스크</th><th>한줄 팁</th></tr></thead><tbody><tr><td>시간·정책</td><td>타임아웃, NOWAIT/SKIP</td><td>꼬리 지연 절단</td><td>실시간 응답</td><td>중단·누락</td><td>실패·재시도 전략 병행</td></tr><tr><td>프로토콜·격리</td><td>Strict/Conservative, MVCC/SSI</td><td>안전/처리량 균형</td><td>금융·OLTP</td><td>대기↑·재시도</td><td>읽기=버전, 쓰기=락</td></tr><tr><td>계층·범위</td><td>IS/IX/SIX, 인덱스, 에스컬</td><td>범위·시간 동시 축소</td><td>대용량 스캔</td><td>동시성 저하</td><td>등가→범위·커버링 우선</td></tr><tr><td>운영·자동화</td><td>모니터링, 탐지/회피, SLO 튜닝</td><td>안정적 p95/99</td><td>변동 부하</td><td>오버헤드</td><td>관측→조정의 폐루프</td></tr><tr><td>분산 커밋</td><td>2PC 창 축소, 샤딩 정렬</td><td>보유창↓, 핫스팟↓</td><td>멀티리전</td><td>지연·복잡성</td><td>커밋 창을 숫자로 관리</td></tr></tbody></table><h4 id=락-지속시간-운영-전략>락 지속시간 운영 전략<a hidden class=anchor aria-hidden=true href=#락-지속시간-운영-전략>#</a></h4><p>락 지속시간은 " 언제 락을 놓는가 " 에 따라 동시성과 일관성이 결정된다.<br>즉시 해제는 빠르지만 재시도·팬텀이 늘고, 트랜잭션단위 해제 (Strict 2PL) 는 정합성이 높지만 대기와 데드락 위험이 커진다.<br>격리수준이 올라갈수록 보유시간이 길어지는 경향이 있다.<br>충돌은 대기·NOWAIT·타임아웃·중재자 (데드락 희생) 중 어떤 정책을 쓰느냐에 따라 체감 지속시간이 달라진다.<br>2PL 은 사전 차단으로 예측 가능, MVCC 는 읽기 지속시간을 줄여 처리량을 높인다.<br>결국 워크로드 성격에 맞춰 네 축을 조합해 운영하면 된다.</p><h5 id=락-지속시간-핵심-분류-체계>락 지속시간 핵심 분류 체계<a hidden class=anchor aria-hidden=true href=#락-지속시간-핵심-분류-체계>#</a></h5><table><thead><tr><th>분류 기준</th><th>유형</th><th>정의/기능</th><th>보유 시간 경향</th><th>장점</th><th>주의점/리스크</th><th>대표 사용</th></tr></thead><tbody><tr><td>해제 시점</td><td>즉시</td><td>연산 단위 완료 즉시 해제</td><td>짧음</td><td>대기 감소</td><td>재시도/팬텀 증가</td><td>큐 처리, 백오프 루프</td></tr><tr><td></td><td>연산단위</td><td>트랜잭션 내 작업 블록 단위 해제</td><td>중간</td><td>균형형</td><td>블록 경계 설계 필요</td><td>서비스 계층 트랜잭션</td></tr><tr><td></td><td>트랜잭션단위</td><td>커밋/롤백 시 해제 (Strict 2PL)</td><td>김</td><td>직렬성·복구 용이</td><td>대기/데드락↑</td><td>강정합 OLTP</td></tr><tr><td>격리 수준 영향</td><td>RC</td><td>커밋된 데이터만 읽기</td><td>짧음</td><td>처리량↑</td><td>반복읽기 불가</td><td>일반 OLTP</td></tr><tr><td></td><td>RR</td><td>동일 행 재읽기 일관</td><td>중간</td><td>일관성↑</td><td>범위 팬텀 위험</td><td>재고/정산</td></tr><tr><td></td><td>SR</td><td>직렬 가능</td><td>김</td><td>정합성 최상</td><td>비용↑</td><td>금융/회계</td></tr><tr><td>충돌 처리</td><td>대기</td><td>호환까지 큐 대기</td><td>가변</td><td>성공률↑</td><td>꼬리 지연</td><td>일반 트랜잭션</td></tr><tr><td></td><td>NOWAIT</td><td>즉시 실패</td><td>짧음</td><td>대기 폭주 방지</td><td>재시도 로직 필요</td><td>작업 분배 워커</td></tr><tr><td></td><td>타임아웃</td><td>시간 제한 후 중단</td><td>통제</td><td>꼬리 컷오프</td><td>튜닝 필요</td><td>혼잡 제어</td></tr><tr><td></td><td>중재자</td><td>데드락 희생자 선정</td><td>간접</td><td>시스템 안정</td><td>롤백 비용</td><td>고경합 시스템</td></tr><tr><td>엔진 전략</td><td>2PL</td><td>락으로 사전 차단</td><td>김 (Strict)</td><td>예측 가능</td><td>데드락 관리</td><td>강정합 쓰기</td></tr><tr><td></td><td>MVCC</td><td>버전으로 읽기 분리</td><td>짧음 (읽기)</td><td>읽기 확장</td><td>검증/GC 비용</td><td>혼합 워크로드</td></tr><tr><td></td><td>혼합</td><td>2PL+MVCC</td><td>혼합</td><td>유연성</td><td>복잡도↑</td><td>대형 서비스</td></tr></tbody></table><h5 id=네-축으로-보는-락-지속시간>네 축으로 보는 락 지속시간<a hidden class=anchor aria-hidden=true href=#네-축으로-보는-락-지속시간>#</a></h5><h6 id=a-해제-시점>A. 해제 시점<a hidden class=anchor aria-hidden=true href=#a-해제-시점>#</a></h6><p>락을 언제 해제할지로 수명을 정의 (즉시/연산단위/트랜잭션단위). 짧을수록 동시성↑, 길수록 일관성·복구 용이성↑.</p><table><thead><tr><th>유형</th><th>트리거</th><th>장점</th><th>주의점</th><th>추천 시나리오</th></tr></thead><tbody><tr><td>즉시</td><td>연산 완료</td><td>대기 최소</td><td>재시도/팬텀↑</td><td>워커·큐 작업</td></tr><tr><td>연산단위</td><td>블록 종료</td><td>균형</td><td>경계 설계</td><td>서비스 트랜잭션</td></tr><tr><td>트랜잭션단위</td><td>커밋/롤백</td><td>정합성·복구</td><td>대기·데드락↑</td><td>금융·정산</td></tr></tbody></table><p>해제 시점은 체감 지속시간을 직접 결정하는 1 차 노브다.</p><h6 id=b-격리수준-영향>B. 격리수준 영향<a hidden class=anchor aria-hidden=true href=#b-격리수준-영향>#</a></h6><p>RC→RR→SR 로 갈수록 보유시간이 늘고 재현성은 높아진다.</p><table><thead><tr><th>수준</th><th>읽기 특성</th><th>팬텀</th><th>보유 경향</th><th>용도</th></tr></thead><tbody><tr><td>RC</td><td>커밋된 값</td><td>가능</td><td>짧음</td><td>일반 OLTP</td></tr><tr><td>RR</td><td>반복 읽기</td><td>가능 (범위)</td><td>중간</td><td>재고·리포트</td></tr><tr><td>SR</td><td>직렬 가능</td><td>불가 (범위락/검증)</td><td>김</td><td>강정합</td></tr></tbody></table><p>격리수준은 " 일관성 강도 ↔ 지속시간 " 의 교환관계를 형성한다.</p><h6 id=c-충돌-처리>C. 충돌 처리<a hidden class=anchor aria-hidden=true href=#c-충돌-처리>#</a></h6><p>대기/NOWAIT/타임아웃/중재자 조합으로 혼잡을 제어한다.</p><table><thead><tr><th>정책</th><th>효과</th><th>리스크</th><th>팁</th></tr></thead><tbody><tr><td>대기</td><td>성공률↑</td><td>꼬리 지연</td><td>공정 큐·우선순위</td></tr><tr><td>NOWAIT</td><td>즉시 실패</td><td>재시도 비용</td><td>백오프·분산</td></tr><tr><td>타임아웃</td><td>꼬리 컷</td><td>임계 튜닝</td><td>퍼센타일 기반</td></tr><tr><td>중재자</td><td>안정성</td><td>롤백 손실</td><td>희생 기준 명확화</td></tr></tbody></table><p>혼잡 제어 정책은 대기열 폭주와 장수 트랜잭션을 억제해 실효 지속시간을 줄인다.</p><h6 id=d-엔진-전략>D. 엔진 전략<a hidden class=anchor aria-hidden=true href=#d-엔진-전략>#</a></h6><p>2PL 은 사전 차단, MVCC 는 읽기 분리, 혼합은 상황 최적화.</p><table><thead><tr><th>전략</th><th>원리</th><th>지속시간 특성</th><th>장점</th><th>주의점</th></tr></thead><tbody><tr><td>2PL</td><td>락 기반</td><td>SR 에서 김</td><td>예측가능</td><td>데드락 관리</td></tr><tr><td>MVCC</td><td>버전</td><td>읽기 짧음</td><td>확장성</td><td>검증/GC</td></tr><tr><td>혼합</td><td>하이브리드</td><td>혼합</td><td>유연성</td><td>복잡도</td></tr></tbody></table><p>엔진 전략 선택은 읽기/쓰기 비율과 충돌률을 기준으로 한다.</p><h5 id=락-지속시간-설계운영-종합지도>락 지속시간 설계·운영 종합지도<a hidden class=anchor aria-hidden=true href=#락-지속시간-설계운영-종합지도>#</a></h5><table><thead><tr><th>카테고리</th><th>세부 유형</th><th>보유 경향</th><th>장점</th><th>주의점</th><th>대표 조합 예</th></tr></thead><tbody><tr><td>해제 시점</td><td>즉시/연산단위/트랜잭션단위</td><td>짧음/중간/김</td><td>대기↓/균형/정합성↑</td><td>재시도↑/경계설계/데드락↑</td><td>RC+ 즉시, RR+ 연산단위, SR+ 트랜잭션</td></tr><tr><td>격리수준</td><td>RC/RR/SR</td><td>짧음/중간/김</td><td>처리량/균형/정합성</td><td>팬텀/비용</td><td>RC+NOWAIT, SR+ 대기</td></tr><tr><td>충돌 처리</td><td>대기/NOWAIT/타임아웃/중재자</td><td>가변</td><td>성공률/폭주방지/꼬리컷/안정</td><td>꼬리/재시도/튜닝/롤백</td><td>대기 + 타임아웃, NOWAIT+ 백오프</td></tr><tr><td>엔진 전략</td><td>2PL/MVCC/혼합</td><td>김/짧음/혼합</td><td>예측/확장/유연</td><td>데드락/검증/복잡</td><td>2PL+SR, MVCC+RC, 혼합 +RR</td></tr></tbody></table><h4 id=락-지속시간-운영을-위한-실전-도구지도>락 지속시간 운영을 위한 실전 도구지도<a hidden class=anchor aria-hidden=true href=#락-지속시간-운영을-위한-실전-도구지도>#</a></h4><p>락 지속시간을 통제하려면 **DB 엔진의 기본 버튼들 (타임아웃/격리/에스컬/힌트)**로 " 얼마나 오래 기다리고, 얼마나 크게 잠글지 " 를 정한다.<br>그다음 <strong>관측 스택</strong>으로 대기·데드락·보유 시간을 수치로 보고, 필요하면 <strong>분산 락/TTL</strong>로 애플리케이션 레벨 만료를 더한다.<br>마지막으로 <strong>벤치마크</strong>로 정책 변경의 전후 효과를 검증하면, " 느리지만 안전 " 과 " 빠르지만 위험 " 사이의 균형점을 찾을 수 있다.</p><h5 id=기능별-락-지속시간-운영-분류>기능별 락 지속시간 운영 분류<a hidden class=anchor aria-hidden=true href=#기능별-락-지속시간-운영-분류>#</a></h5><h6 id=a-dbms-기본-제어-타임아웃격리에스컬>A. DBMS 기본 제어 (타임아웃·격리·에스컬)<a hidden class=anchor aria-hidden=true href=#a-dbms-기본-제어-타임아웃격리에스컬>#</a></h6><p>실무에서 락 보유/대기 시간을 <strong>직접</strong> 줄이거나 늘리는 1 차 수단.</p><ul><li>MySQL: <code>innodb_lock_wait_timeout</code>, Performance Schema <code>data_locks</code></li><li>PostgreSQL: <code>lock_timeout/deadlock_timeout/statement_timeout</code>, <code>SKIP LOCKED/NOWAIT</code></li><li>SQL Server: <code>SET LOCK_TIMEOUT</code>, 스냅샷 읽기, 에스컬레이션/테이블 힌트</li><li>Oracle: <code>DDL_LOCK_TIMEOUT</code>, <code>FOR UPDATE WAIT n/NOWAIT</code></li></ul><table><thead><tr><th>엔진</th><th>핵심 기능 (예)</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>MySQL</td><td><code>innodb_lock_wait_timeout</code>, P_S <code>data_locks</code></td><td>대기 상한·대기 관측</td><td>넥스트키 모델, 대기 분석 용이</td><td>오조정 시 재시도 폭증</td></tr><tr><td>PostgreSQL</td><td><code>lock/deadlock/statement_timeout</code>, <code>SKIP LOCKED</code></td><td>대기 제한·비차단 큐 처리</td><td>MVCC 읽기, 풍부한 뷰</td><td>광역 타임아웃 오탐 가능</td></tr><tr><td>SQL Server</td><td><code>LOCK_TIMEOUT</code>, 스냅샷, 힌트, 에스컬</td><td>대기 상한·차단폭 제어</td><td>운영 힌트 다양, DMV</td><td>자동 에스컬 급격성</td></tr><tr><td>Oracle</td><td><code>DDL_LOCK_TIMEOUT</code>, <code>WAIT n</code></td><td>DDL/DML 대기 제어</td><td>진단 뷰 풍부</td><td>옵션 복잡성</td></tr></tbody></table><ul><li><strong>요약</strong>: 엔진 버튼으로 <strong>보유/대기/범위</strong>를 직접 다스린다. 힌트·에스컬은 강력하지만 부작용 관리가 핵심.</li></ul><h6 id=b-관측진단-메트릭로그대시보드>B. 관측·진단 (메트릭·로그·대시보드)<a hidden class=anchor aria-hidden=true href=#b-관측진단-메트릭로그대시보드>#</a></h6><p>락 대기·보유·데드락을 가시화해 <strong>튜닝 루프</strong>를 만든다.</p><ul><li>Prometheus + Grafana, Whatap/APM, 각 엔진 뷰/DMV(<code>pg_locks</code>, <code>sys.dm_tran_locks</code>, InnoDB/Performance Schema).</li></ul><table><thead><tr><th>도구</th><th>기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>Prometheus</td><td>지표 스크래핑</td><td>대기/데드락 추이</td><td>오픈·확장성</td><td>세밀 수집 오버헤드</td></tr><tr><td>Grafana</td><td>시각화·알람</td><td>피크/꼬리지연 모니터</td><td>대시보드 생태계</td><td>운영 지식 요구</td></tr><tr><td>Whatap/APM</td><td>통합 추적</td><td>앱↔DB 경로 가시화</td><td>빠른 도입</td><td>비용</td></tr></tbody></table><ul><li><strong>요약</strong>: 관측 없이는 조정이 불가. 지표·로그의 **연결 (앱→DB)**이 중요하다.</li></ul><h6 id=c-분산-락애플리케이션-레벨-리스ttl>C. 분산 락/애플리케이션 레벨 (리스·TTL)<a hidden class=anchor aria-hidden=true href=#c-분산-락애플리케이션-레벨-리스ttl>#</a></h6><p>DB 외부에서 <strong>만료 정책</strong>으로 지속시간을 보완한다.</p><ul><li>Redis(Redisson, redlock), ZooKeeper(Curator), etcd(리스).</li></ul><table><thead><tr><th>도구</th><th>기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>Redis/Redisson</td><td>TTL·Lua</td><td>간단한 분산 락</td><td>고성능·간결</td><td>네트워크/시계 가정 민감</td></tr><tr><td>ZooKeeper/Curator</td><td>에페메럴·워처</td><td>세션 락</td><td>자동 해제·안정</td><td>운영 복잡</td></tr><tr><td>etcd</td><td>리스·세션</td><td>컨테이너/클러스터</td><td>네이티브 클라우드</td><td>운영 지식 필요</td></tr></tbody></table><ul><li><strong>요약</strong>: TTL·리스로 <strong>과도 보유를 방지</strong>하되, 강한 직렬성 요구엔 DB 락 전략과 병행.</li></ul><h6 id=d-부하재현-벤치시뮬>D. 부하·재현 (벤치·시뮬)<a hidden class=anchor aria-hidden=true href=#d-부하재현-벤치시뮬>#</a></h6><p>지속시간 정책의 효과를 <strong>수치로 검증</strong>한다.</p><ul><li><code>pgbench</code>, <code>sysbench</code>.</li></ul><table><thead><tr><th>도구</th><th>기능</th><th>역할/용도</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>pgbench</td><td>표준 워크로드</td><td>PG 정책 검증</td><td>구성 간단</td><td>실제와 괴리 가능</td></tr><tr><td>sysbench</td><td>R/W 혼합</td><td>MySQL 정책 검증</td><td>시나리오 다양</td><td>튜닝 필요</td></tr></tbody></table><ul><li><strong>요약</strong>: 정책 전/후로 <strong>대기 p95, 데드락률, 에스컬</strong>을 비교해 의사결정을 닫는다.</li></ul><h5 id=락-지속시간-도구프레임워크-종합표>락 지속시간 도구·프레임워크 종합표<a hidden class=anchor aria-hidden=true href=#락-지속시간-도구프레임워크-종합표>#</a></h5><table><thead><tr><th>카테고리</th><th>대표 도구/기능</th><th>핵심 역할</th><th>지속시간 영향 포인트</th><th>강점</th><th>약점</th></tr></thead><tbody><tr><td>DBMS 제어</td><td>MySQL <code>innodb_lock_wait_timeout</code>, PG <code>lock_timeout/SKIP LOCKED</code>, MSSQL <code>LOCK_TIMEOUT/스냅샷</code>, Oracle <code>WAIT n</code></td><td>보유·대기·범위 직접 제어</td><td>타임아웃·힌트·에스컬·격리</td><td>강력·즉시 효과</td><td>오조정 리스크</td></tr><tr><td>관측·진단</td><td>Prometheus/Grafana, Whatap, <code>pg_locks</code>/<code>sys.dm_tran_locks</code>/P_S</td><td>피드백 루프</td><td>대기·보유·데드락 지표·로그</td><td>원인 파악·추세</td><td>수집 오버헤드</td></tr><tr><td>분산·앱 락</td><td>Redis/Redisson, ZooKeeper/Curator, etcd</td><td>만료·세션 기반 보완</td><td>TTL·리스 만료</td><td>단순·확장</td><td>강한 직렬성 한계</td></tr><tr><td>부하·재현</td><td>pgbench, sysbench</td><td>정책 검증</td><td>p95 대기·데드락률·TPS</td><td>비교 용이</td><td>실제와 괴리</td></tr></tbody></table><ul><li><strong>요약</strong>: **제어 (A) → 관측 (B) → 보완 (C) → 검증 (D)**의 순환이 락 지속시간 운영의 기본 루프다.</li></ul><h4 id=락을-오래-쥐게-만드는-습관-끊기>락을 오래 쥐게 만드는 습관 끊기<a hidden class=anchor aria-hidden=true href=#락을-오래-쥐게-만드는-습관-끊기>#</a></h4><p>락은 " 짧고 일정하게 " 쥐어야 한다. 트랜잭션 안에서 기다리거나, 큰 범위를 잠그거나, 모두 다른 순서로 잠그면 보유시간이 길어지고 대기가 폭증한다. 입력·원격 호출은 트랜잭션 밖으로 빼고, 후보를 인덱스로 좁히고, 모두 같은 순서로 잠그면 대부분의 문제가 사라진다.</p><h5 id=락-지속시간을-망치는-8-가지-패턴>락 지속시간을 망치는 8 가지 패턴<a hidden class=anchor aria-hidden=true href=#락-지속시간을-망치는-8-가지-패턴>#</a></h5><table><thead><tr><th>#</th><th>안티패턴</th><th>문제</th><th>결과 (증상)</th><th>주된 원인</th><th>해결책 (핵심)</th></tr></thead><tbody><tr><td>1</td><td>트랜잭션 내 사용자/원격 대기</td><td>Tx 동안 외부 대기</td><td>보유↑, 대기↑, 데드락↑</td><td>경계·아키텍처 미흡</td><td>외부 I/O 는 Tx 밖, 단일 목적 Tx</td></tr><tr><td>2</td><td>락 순서 불일치</td><td>자원 순환 대기</td><td>교착 빈발</td><td>팀/서비스 간 순서 불일치</td><td>상→하 (의도→실락) 전사 규약</td></tr><tr><td>3</td><td>광범위 갱신 + 인덱스 부재</td><td>풀스캔·범위락 확대</td><td>대기 폭증·에스컬레이션</td><td>인덱스/프루닝 미흡</td><td>커버링/선택도 인덱스, 후보 축소</td></tr><tr><td>4</td><td><code>FOR UPDATE</code> 남발</td><td>불필요 X 락</td><td>읽기 경합↑</td><td>패턴 오남용</td><td>후보 확정 시점에만 사용</td></tr><tr><td>5</td><td>장수 Tx(대화형/배치)</td><td>버전/락 장기 보유</td><td>MVCC GC 지연·메모리↑</td><td>기능–Tx 경계 혼재</td><td>읽기 분리, 배치 창 분리</td></tr><tr><td>6</td><td>에스컬레이션 오남용</td><td>상위 충돌률 급증</td><td>TPS↓, 타임아웃↑</td><td>임계/예외 정책 부재</td><td>예외 테이블, 야간 승격</td></tr><tr><td>7</td><td>멱등 부재 재시도</td><td>중복 반영</td><td>데이터 이상</td><td>요청 식별 불가</td><td>멱등 키, 재시도 정책</td></tr><tr><td>8</td><td>샤드 교차 락</td><td>교차 대기·왕복↑</td><td>장대기·데드락</td><td>순서/라우팅 미흡</td><td>샤드 키 순서 고정, 사가 분해</td></tr></tbody></table><h6 id=각-안티패턴나쁜좋은-예시-발췌>각 안티패턴—나쁜/좋은 예시 (발췌)<a hidden class=anchor aria-hidden=true href=#각-안티패턴나쁜좋은-예시-발췌>#</a></h6><p><strong>1) 트랜잭션 내 대기</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 나쁜 예: 사용자 입력이 Tx 안</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>transaction</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>row</span> <span class=o>=</span> <span class=n>repo</span><span class=o>.</span><span class=n>read_for_update</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>  <span class=c1># 락 획득</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;값 입력: &#34;</span><span class=p>)</span>        <span class=c1># 대기 중에도 락 유지</span>
</span></span><span class=line><span class=cl>    <span class=n>repo</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=nb>id</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span>            <span class=c1># 장수 Tx → 대기/데드락↑</span>
</span></span><span class=line><span class=cl><span class=c1># 좋은 예: 입력은 Tx 밖</span>
</span></span><span class=line><span class=cl><span class=n>val</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;값 입력: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>transaction</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>row</span> <span class=o>=</span> <span class=n>repo</span><span class=o>.</span><span class=n>read_for_update</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>  <span class=c1># 최소 구간만 락</span>
</span></span><span class=line><span class=cl>    <span class=n>repo</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=nb>id</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span>            <span class=c1># 빠른 커밋</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2) 락 순서 불일치 → 일관화</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 나쁜 예: A→B, B→A 서로 다르게 잠금</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tx_a</span><span class=p>():</span> <span class=n>lock</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>);</span> <span class=n>lock</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tx_b</span><span class=p>():</span> <span class=n>lock</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>);</span> <span class=n>lock</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>)</span>  <span class=c1># 순환 대기 위험</span>
</span></span><span class=line><span class=cl><span class=c1># 좋은 예: 항상 A→B</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tx_any</span><span class=p>():</span> <span class=n>lock</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>);</span> <span class=n>lock</span><span class=p>(</span><span class=s2>&#34;B&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>3) 광범위 갱신 + 인덱스</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5>5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6>6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7>7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 나쁜 예: 범위 넓고 인덱스 없음 → 테이블 락/페이지 락 범람
</span></span></span><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>Status</span><span class=o>=</span><span class=s1>&#39;X&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>CreatedAt</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 day&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- 좋은 예: 선택도 높은 인덱스 + 배치 분할
</span></span></span><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=p>(</span><span class=n>CreatedAt</span><span class=p>,</span><span class=w> </span><span class=n>Status</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>Status</span><span class=o>=</span><span class=s1>&#39;X&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>WHERE</span><span class=w> </span><span class=n>CreatedAt</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>INTERVAL</span><span class=w> </span><span class=s1>&#39;30 day&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=o>&lt;&gt;</span><span class=w> </span><span class=s1>&#39;X&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>CreatedAt</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>500</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 소배치 반복
</span></span></span></code></pre></td></tr></table></div></div><p><strong>4) FOR UPDATE 는 " 대상 확정 " 에만</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 나쁨: 스캔 전체에 FOR UPDATE
</span></span></span><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Items</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>category</span><span class=o>=</span><span class=err>$</span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- 좋음: 후보는 스냅샷 읽기 → 확정 시점만 잠금
</span></span></span><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>cte</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Items</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>category</span><span class=o>=</span><span class=err>$</span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>stock</span><span class=o>&lt;</span><span class=mi>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>cte</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 작은 집합만 잠금
</span></span></span></code></pre></td></tr></table></div></div><p><strong>7) 멱등 재시도 (타임아웃/충돌 대비)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4>4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5>5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6>6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 좋은 예: 멱등 키로 중복 반영 방지</span>
</span></span><span class=line><span class=cl><span class=n>req_id</span> <span class=o>=</span> <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;Idempotency-Key&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>transaction</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>repo</span><span class=o>.</span><span class=n>exists_request</span><span class=p>(</span><span class=n>req_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>repo</span><span class=o>.</span><span class=n>previous_result</span><span class=p>(</span><span class=n>req_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>repo</span><span class=o>.</span><span class=n>apply_change</span><span class=p>(</span><span class=err>…</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>repo</span><span class=o>.</span><span class=n>save_request</span><span class=p>(</span><span class=n>req_id</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=안티패턴-5-대-카테고리-체계>안티패턴 5 대 카테고리 체계<a hidden class=anchor aria-hidden=true href=#안티패턴-5-대-카테고리-체계>#</a></h5><h6 id=a-애플리케이션-경계흐름>A. 애플리케이션 경계/흐름<a hidden class=anchor aria-hidden=true href=#a-애플리케이션-경계흐름>#</a></h6><ul><li>설명: 경계·대기·멱등 설계가 보유시간을 좌우.</li><li>문제: 트랜잭션 내부 대기, 재시도 중복 반영.</li><li>결과: 보유↑, 대기↑, 데이터 이상.</li><li>원인: 경계 미분리, 멱등 부재.</li><li>해결: 외부 I/O Tx 밖, 멱등 키, 단일 목적 Tx.</li></ul><table><thead><tr><th>항목</th><th>나쁜 예</th><th>좋은 예</th></tr></thead><tbody><tr><td>대기</td><td>Tx 내 입력/원격 호출</td><td>Tx 밖 처리</td></tr><tr><td>재시도</td><td>키 없이 재시도</td><td>멱등 키/결과 저장</td></tr></tbody></table><ul><li>요약: <strong>경계 분리와 멱등</strong>만 지켜도 보유·대기 동시 절감.</li></ul><h6 id=b-sql데이터-설계>B. SQL/데이터 설계<a hidden class=anchor aria-hidden=true href=#b-sql데이터-설계>#</a></h6><ul><li>설명: 후보 축소·인덱스·배치가 범위락을 줄임.</li><li>문제: 풀스캔 갱신, 무차별 FOR UPDATE.</li><li>결과: 상위 충돌·승격, 타임아웃.</li><li>원인: 인덱스 부재, 패턴 오용.</li><li>해결: 커버링 인덱스, CTE 후 확정 잠금, 소배치.</li></ul><table><thead><tr><th>항목</th><th>나쁜 예</th><th>좋은 예</th></tr></thead><tbody><tr><td>광범위 UPDATE</td><td>인덱스 없음</td><td>선택도 인덱스 +LIMIT</td></tr><tr><td>FOR UPDATE</td><td>전체 스캔 잠금</td><td>후보 확정 후 잠금</td></tr></tbody></table><ul><li>요약: <strong>프루닝 + 인덱스 + 소배치</strong>가 핵심.</li></ul><h6 id=c-엔진락-설정>C. 엔진/락 설정<a hidden class=anchor aria-hidden=true href=#c-엔진락-설정>#</a></h6><ul><li>설명: 승격·타임아웃·예외 정책으로 꼬리 지연 제어.</li><li>문제: 무작정 승격, 긴 타임아웃.</li><li>결과: 전역 충돌·기아.</li><li>원인: 임계 미정의, 모니터링 부재.</li><li>해결: 예외 테이블, 야간 창, 동적 타임아웃.</li></ul><table><thead><tr><th>항목</th><th>나쁜 예</th><th>좋은 예</th></tr></thead><tbody><tr><td>승격</td><td>상시 승격</td><td>핫셋 예외·야간 승격</td></tr><tr><td>타임아웃</td><td>고정 장시간</td><td>동적/백오프</td></tr></tbody></table><ul><li>요약: <strong>예외·시간대·동적화</strong>로 안정화.</li></ul><h6 id=d-분산샤딩>D. 분산/샤딩<a hidden class=anchor aria-hidden=true href=#d-분산샤딩>#</a></h6><ul><li>설명: 교차 락 제거가 보유시간 급증을 막음.</li><li>문제: 샤드 교차·순서 불일치.</li><li>결과: 교차 대기·데드락.</li><li>원인: 라우팅 미흡, 키 설계 부실.</li><li>해결: 샤드 키 순서 고정, 사가/큐 분해.</li></ul><table><thead><tr><th>항목</th><th>나쁜 예</th><th>좋은 예</th></tr></thead><tbody><tr><td>교차 락</td><td>임의 순서</td><td>고정 순서·사가</td></tr></tbody></table><ul><li>요약: <strong>순서 고정·경계 분해</strong>가 전부.</li></ul><h6 id=e-운영관측>E. 운영/관측<a hidden class=anchor aria-hidden=true href=#e-운영관측>#</a></h6><ul><li>설명: 보유·대기·데드락 지표 없으면 블라인드 운용.</li><li>문제: 임계·알람 부재.</li><li>결과: SLO 위반.</li><li>원인: 대시보드 미구축.</li><li>해결: P95 보유/대기·데드락/분·승격률 알람, 런북.</li></ul><table><thead><tr><th>항목</th><th>나쁜 예</th><th>좋은 예</th></tr></thead><tbody><tr><td>관측</td><td>지표 부재</td><td>대시보드 + 런북</td></tr></tbody></table><ul><li>요약: <strong>보는 만큼 안정</strong>.</li></ul><h5 id=lock-duration-안티패턴-종합-매트릭스>Lock Duration 안티패턴 종합 매트릭스<a hidden class=anchor aria-hidden=true href=#lock-duration-안티패턴-종합-매트릭스>#</a></h5><table><thead><tr><th>구분</th><th>대표 안티패턴</th><th>결과</th><th>해결 키워드</th><th>핵심 지표</th></tr></thead><tbody><tr><td>앱 경계</td><td>Tx 내 대기</td><td>보유↑·대기↑</td><td>경계 분리</td><td>P95 보유</td></tr><tr><td>SQL</td><td>광범위 갱신</td><td>승격·충돌</td><td>인덱스·소배치</td><td>상위 충돌률</td></tr><tr><td>엔진</td><td>승격 오남용</td><td>전역 경합</td><td>예외 테이블</td><td>에스컬레이션률</td></tr><tr><td>분산</td><td>교차 락</td><td>교착</td><td>순서 고정·사가</td><td>데드락/분</td></tr><tr><td>운영</td><td>관측 부재</td><td>SLO 위반</td><td>대시보드</td><td>타임아웃률</td></tr></tbody></table><h4 id=lock-duration-전환-로드맵>Lock Duration 전환 로드맵<a hidden class=anchor aria-hidden=true href=#lock-duration-전환-로드맵>#</a></h4><p>락 지속시간을 바꾸거나 엔진을 옮기면 <strong>읽기/쓰기의 잡는 시간</strong>과 <strong>충돌 해소 방식</strong>이 달라진다. 먼저 현재 시스템의 <strong>락 프로파일</strong>을 만들고, 새 환경과 <strong>락·격리·타임아웃</strong>을 1:1 로 매핑한다. 그다음 <strong>재시도와 보상</strong>을 코드에 표준화하고, <strong>캐나리→점증 배포</strong>로 퍼센트를 올린다. 모든 단계는 **가시성 (p95 대기, 데드락/분)**을 기준으로 <strong>Go/No-Go</strong>를 결정한다. 문제가 생기면 토글과 롤백 플랜으로 즉시 되돌린다.</p><h5 id=lock-duration-마이그레이션-표>Lock Duration 마이그레이션 표<a hidden class=anchor aria-hidden=true href=#lock-duration-마이그레이션-표>#</a></h5><table><thead><tr><th>단계</th><th>목표</th><th>핵심 작업</th><th>체크리스트</th><th>산출물</th><th>롤백 기준</th></tr></thead><tbody><tr><td>0 인벤토리</td><td>현황 파악</td><td>경합 지형/장수 Tx 수집</td><td>p95 대기, Deadlock/분</td><td>락 프로파일</td><td>N/A</td></tr><tr><td>1 호환성</td><td>개념 매핑</td><td>S/X/U, IS/IX/SIX, 키 - 범위/DDL/타임아웃 차이 정리</td><td>호환성 표, 영향도</td><td>매핑 문서</td><td>차이 미해결 시 중단</td></tr><tr><td>2 방어 로직</td><td>실패 안전</td><td>멱등 키, 재시도/보상, 타임아웃 정합</td><td>재시도 래퍼, 보상 API</td><td>공통 라이브러리</td><td>오류율↑ 시 보류</td></tr><tr><td>3 파일럿</td><td>리스크 국소화</td><td>캐나리 1~5%, 핫스팟 재현</td><td>SLO 게이트 설정</td><td>시험 보고서</td><td>게이트 초과 시 즉시 롤백</td></tr><tr><td>4 확대</td><td>안정 확산</td><td>테이블/서비스 단위 점증, 변경 창 관리</td><td>대시보드·알람 이식</td><td>배포 로그</td><td>경보 반복 시 부분 롤백</td></tr><tr><td>5 전면·안정</td><td>기준선 회복</td><td>임계/쿼리/인덱스 튜닝</td><td>회고/교훈</td><td>최종 성능 보고</td><td>목표 미달 시 리런</td></tr></tbody></table><p><strong>요약</strong>: <strong>현황→매핑→방어로직→캐나리→확대→안정화</strong>의 여섯 단계로 진행하고, 모든 결정은 <strong>가시화된 지표와 명확한 롤백 기준</strong>으로 통제한다.</p><h3 id=실무-적용-및-사례>실무 적용 및 사례<a hidden class=anchor aria-hidden=true href=#실무-적용-및-사례>#</a></h3><h4 id=실습-예제-및-코드-구현>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현>#</a></h4><h5 id=실습-예제-락-duration--deadlock-제어-실습>실습 예제: 락 Duration ⋅ Deadlock 제어 실습<a hidden class=anchor aria-hidden=true href=#실습-예제-락-duration--deadlock-제어-실습>#</a></h5><h6 id=목적>목적<a hidden class=anchor aria-hidden=true href=#목적>#</a></h6><ul><li>트랜잭션 락 획득 및 해제 타이밍 (Unlock) 실습, 교착상태 대응 패턴 체득</li></ul><h6 id=사전-요구사항>사전 요구사항<a hidden class=anchor aria-hidden=true href=#사전-요구사항>#</a></h6><ul><li>MySQL(InnoDB), Redis, Prometheus, Python(Pymysql 등)</li></ul><h6 id=단계별-구현>단계별 구현<a hidden class=anchor aria-hidden=true href=#단계별-구현>#</a></h6><ol><li><p><strong>Row-level Lock 획득 및 해제</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 트랜잭션 내 row-level 락 핸들링 예시 - MySQL</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pymysql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>pymysql</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=s1>&#39;db&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;BEGIN&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM test_table WHERE id=1 FOR UPDATE&#39;</span><span class=p>)</span>  <span class=c1># row-level lock 획득</span>
</span></span><span class=line><span class=cl>        <span class=c1># 데이터 수정 로직</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;UPDATE test_table SET value=&#34;updated&#34; WHERE id=1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>  <span class=c1># 커밋시 락 해제</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># 각 명령별 락 획득/해제, 교착 실험 가능</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>Redis 분산 락 예시</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>StrictRedis</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>acquire_lock</span><span class=p>(</span><span class=n>lock_name</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_name</span><span class=p>,</span> <span class=s2>&#34;lock&#34;</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=n>timeout</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>release_lock</span><span class=p>(</span><span class=n>lock_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>lock_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lock_name</span> <span class=o>=</span> <span class=s2>&#34;resource_lock&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>acquire_lock</span><span class=p>(</span><span class=n>lock_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>  <span class=c1># 작업 처리</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>release_lock</span><span class=p>(</span><span class=n>lock_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;락 획득 실패: 다른 세션이 점유 중&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=실행-결과>실행 결과<a hidden class=anchor aria-hidden=true href=#실행-결과>#</a></h6><ul><li>락 획득/해제 시점, 대기 상황, 타임아웃 실험 결과 (Deadlock, 경합, 처리 속도 등) 직접 관찰</li></ul><h6 id=추가-실험>추가 실험<a hidden class=anchor aria-hidden=true href=#추가-실험>#</a></h6><ul><li>트랜잭션 격리수준 (Serializable, Read Committed 등) 변경에 따른 락 Duration/교착 발생률 비교</li><li>락 대기 트렌드 Whatap, Prometheus 로 실시간 분석 [3][4]</li></ul><h5 id=실습-예제-전자상거래-주문-처리-시스템의-락-지속-시간-최적화>실습 예제: 전자상거래 주문 처리 시스템의 락 지속 시간 최적화<a hidden class=anchor aria-hidden=true href=#실습-예제-전자상거래-주문-처리-시스템의-락-지속-시간-최적화>#</a></h5><h6 id=목적-1>목적<a hidden class=anchor aria-hidden=true href=#목적-1>#</a></h6><ul><li>동시 주문 처리 시 재고 관리의 데이터 일관성 보장</li><li>높은 동시성 환경에서의 락 지속 시간 최적화 기법 학습</li><li>실제 비즈니스 시나리오에서의 트랜잭션 설계 실습</li></ul><h6 id=사전-요구사항-1>사전 요구사항<a hidden class=anchor aria-hidden=true href=#사전-요구사항-1>#</a></h6><ul><li>Python 3.8+</li><li>SQLite 또는 PostgreSQL</li><li>threading 모듈 (동시성 테스트용)</li><li>time 모듈 (성능 측정용)</li></ul><h6 id=단계별-구현-1>단계별 구현<a hidden class=anchor aria-hidden=true href=#단계별-구현-1>#</a></h6><ol><li><p><strong>1 단계: 기본 데이터베이스 스키마 설정</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 상품 테이블
</span></span></span><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stock_quantity</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>price</span><span class=w> </span><span class=nb>DECIMAL</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>version</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=w>  </span><span class=c1>-- 낙관적 락킹용
</span></span></span><span class=line><span class=cl><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- 주문 테이블  
</span></span></span><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>customer_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>product_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>quantity</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>order_time</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>status</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s1>&#39;PENDING&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- 초기 데이터 삽입
</span></span></span><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>stock_quantity</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;iPhone 15&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>999</span><span class=p>.</span><span class=mi>99</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>2 단계: 락 지속 시간 관리 클래스 구현</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a class=lnlinks href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a class=lnlinks href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a class=lnlinks href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a class=lnlinks href=#hl-15-15>15</a>
</span><span class=lnt id=hl-15-16><a class=lnlinks href=#hl-15-16>16</a>
</span><span class=lnt id=hl-15-17><a class=lnlinks href=#hl-15-17>17</a>
</span><span class=lnt id=hl-15-18><a class=lnlinks href=#hl-15-18>18</a>
</span><span class=lnt id=hl-15-19><a class=lnlinks href=#hl-15-19>19</a>
</span><span class=lnt id=hl-15-20><a class=lnlinks href=#hl-15-20>20</a>
</span><span class=lnt id=hl-15-21><a class=lnlinks href=#hl-15-21>21</a>
</span><span class=lnt id=hl-15-22><a class=lnlinks href=#hl-15-22>22</a>
</span><span class=lnt id=hl-15-23><a class=lnlinks href=#hl-15-23>23</a>
</span><span class=lnt id=hl-15-24><a class=lnlinks href=#hl-15-24>24</a>
</span><span class=lnt id=hl-15-25><a class=lnlinks href=#hl-15-25>25</a>
</span><span class=lnt id=hl-15-26><a class=lnlinks href=#hl-15-26>26</a>
</span><span class=lnt id=hl-15-27><a class=lnlinks href=#hl-15-27>27</a>
</span><span class=lnt id=hl-15-28><a class=lnlinks href=#hl-15-28>28</a>
</span><span class=lnt id=hl-15-29><a class=lnlinks href=#hl-15-29>29</a>
</span><span class=lnt id=hl-15-30><a class=lnlinks href=#hl-15-30>30</a>
</span><span class=lnt id=hl-15-31><a class=lnlinks href=#hl-15-31>31</a>
</span><span class=lnt id=hl-15-32><a class=lnlinks href=#hl-15-32>32</a>
</span><span class=lnt id=hl-15-33><a class=lnlinks href=#hl-15-33>33</a>
</span><span class=lnt id=hl-15-34><a class=lnlinks href=#hl-15-34>34</a>
</span><span class=lnt id=hl-15-35><a class=lnlinks href=#hl-15-35>35</a>
</span><span class=lnt id=hl-15-36><a class=lnlinks href=#hl-15-36>36</a>
</span><span class=lnt id=hl-15-37><a class=lnlinks href=#hl-15-37>37</a>
</span><span class=lnt id=hl-15-38><a class=lnlinks href=#hl-15-38>38</a>
</span><span class=lnt id=hl-15-39><a class=lnlinks href=#hl-15-39>39</a>
</span><span class=lnt id=hl-15-40><a class=lnlinks href=#hl-15-40>40</a>
</span><span class=lnt id=hl-15-41><a class=lnlinks href=#hl-15-41>41</a>
</span><span class=lnt id=hl-15-42><a class=lnlinks href=#hl-15-42>42</a>
</span><span class=lnt id=hl-15-43><a class=lnlinks href=#hl-15-43>43</a>
</span><span class=lnt id=hl-15-44><a class=lnlinks href=#hl-15-44>44</a>
</span><span class=lnt id=hl-15-45><a class=lnlinks href=#hl-15-45>45</a>
</span><span class=lnt id=hl-15-46><a class=lnlinks href=#hl-15-46>46</a>
</span><span class=lnt id=hl-15-47><a class=lnlinks href=#hl-15-47>47</a>
</span><span class=lnt id=hl-15-48><a class=lnlinks href=#hl-15-48>48</a>
</span><span class=lnt id=hl-15-49><a class=lnlinks href=#hl-15-49>49</a>
</span><span class=lnt id=hl-15-50><a class=lnlinks href=#hl-15-50>50</a>
</span><span class=lnt id=hl-15-51><a class=lnlinks href=#hl-15-51>51</a>
</span><span class=lnt id=hl-15-52><a class=lnlinks href=#hl-15-52>52</a>
</span><span class=lnt id=hl-15-53><a class=lnlinks href=#hl-15-53>53</a>
</span><span class=lnt id=hl-15-54><a class=lnlinks href=#hl-15-54>54</a>
</span><span class=lnt id=hl-15-55><a class=lnlinks href=#hl-15-55>55</a>
</span><span class=lnt id=hl-15-56><a class=lnlinks href=#hl-15-56>56</a>
</span><span class=lnt id=hl-15-57><a class=lnlinks href=#hl-15-57>57</a>
</span><span class=lnt id=hl-15-58><a class=lnlinks href=#hl-15-58>58</a>
</span><span class=lnt id=hl-15-59><a class=lnlinks href=#hl-15-59>59</a>
</span><span class=lnt id=hl-15-60><a class=lnlinks href=#hl-15-60>60</a>
</span><span class=lnt id=hl-15-61><a class=lnlinks href=#hl-15-61>61</a>
</span><span class=lnt id=hl-15-62><a class=lnlinks href=#hl-15-62>62</a>
</span><span class=lnt id=hl-15-63><a class=lnlinks href=#hl-15-63>63</a>
</span><span class=lnt id=hl-15-64><a class=lnlinks href=#hl-15-64>64</a>
</span><span class=lnt id=hl-15-65><a class=lnlinks href=#hl-15-65>65</a>
</span><span class=lnt id=hl-15-66><a class=lnlinks href=#hl-15-66>66</a>
</span><span class=lnt id=hl-15-67><a class=lnlinks href=#hl-15-67>67</a>
</span><span class=lnt id=hl-15-68><a class=lnlinks href=#hl-15-68>68</a>
</span><span class=lnt id=hl-15-69><a class=lnlinks href=#hl-15-69>69</a>
</span><span class=lnt id=hl-15-70><a class=lnlinks href=#hl-15-70>70</a>
</span><span class=lnt id=hl-15-71><a class=lnlinks href=#hl-15-71>71</a>
</span><span class=lnt id=hl-15-72><a class=lnlinks href=#hl-15-72>72</a>
</span><span class=lnt id=hl-15-73><a class=lnlinks href=#hl-15-73>73</a>
</span><span class=lnt id=hl-15-74><a class=lnlinks href=#hl-15-74>74</a>
</span><span class=lnt id=hl-15-75><a class=lnlinks href=#hl-15-75>75</a>
</span><span class=lnt id=hl-15-76><a class=lnlinks href=#hl-15-76>76</a>
</span><span class=lnt id=hl-15-77><a class=lnlinks href=#hl-15-77>77</a>
</span><span class=lnt id=hl-15-78><a class=lnlinks href=#hl-15-78>78</a>
</span><span class=lnt id=hl-15-79><a class=lnlinks href=#hl-15-79>79</a>
</span><span class=lnt id=hl-15-80><a class=lnlinks href=#hl-15-80>80</a>
</span><span class=lnt id=hl-15-81><a class=lnlinks href=#hl-15-81>81</a>
</span><span class=lnt id=hl-15-82><a class=lnlinks href=#hl-15-82>82</a>
</span><span class=lnt id=hl-15-83><a class=lnlinks href=#hl-15-83>83</a>
</span><span class=lnt id=hl-15-84><a class=lnlinks href=#hl-15-84>84</a>
</span><span class=lnt id=hl-15-85><a class=lnlinks href=#hl-15-85>85</a>
</span><span class=lnt id=hl-15-86><a class=lnlinks href=#hl-15-86>86</a>
</span><span class=lnt id=hl-15-87><a class=lnlinks href=#hl-15-87>87</a>
</span><span class=lnt id=hl-15-88><a class=lnlinks href=#hl-15-88>88</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sqlite3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LockDurationManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;락 지속 시간을 관리하는 클래스&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db_path</span> <span class=o>=</span> <span class=n>db_path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock_stats</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 락 통계 정보</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 스레드별 연결 풀</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>local</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>local</span><span class=p>()</span>  <span class=c1># 스레드 로컬 저장소</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 로깅 설정</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>Connection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;스레드별 데이터베이스 연결 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>thread_id</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>ident</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>local</span><span class=p>,</span> <span class=s1>&#39;connection&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>local</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>db_path</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>timeout</span><span class=o>=</span><span class=mf>30.0</span><span class=p>,</span>  <span class=c1># 락 타임아웃 설정</span>
</span></span><span class=line><span class=cl>                <span class=n>isolation_level</span><span class=o>=</span><span class=s1>&#39;IMMEDIATE&#39;</span>  <span class=c1># 즉시 락 획득</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>local</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;PRAGMA journal_mode=WAL&#34;</span><span class=p>)</span>  <span class=c1># WAL 모드로 동시성 향상</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>local</span><span class=o>.</span><span class=n>connection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>managed_transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>30.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;락 지속 시간을 관리하는 트랜잭션 컨텍스트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_connection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 트랜잭션 시작</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;트랜잭션 시작: Thread </span><span class=si>{</span><span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>ident</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 성공적으로 완료된 경우 커밋</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;트랜잭션 커밋 완료: </span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 락 지속 시간 통계 업데이트</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_update_lock_stats</span><span class=p>(</span><span class=s1>&#39;success&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 오류 발생 시 롤백</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;트랜잭션 롤백: </span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초, 오류: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 실패 통계 업데이트</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_update_lock_stats</span><span class=p>(</span><span class=s1>&#39;failure&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 타임아웃 체크</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>duration</span> <span class=o>&gt;</span> <span class=n>timeout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;락 타임아웃 경고: </span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초 &gt; </span><span class=si>{</span><span class=n>timeout</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_update_lock_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>result</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;락 통계 정보 업데이트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>thread_id</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>ident</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>thread_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_stats</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>lock_stats</span><span class=p>[</span><span class=n>thread_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;success_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;failure_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_duration&#39;</span><span class=p>:</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_duration&#39;</span><span class=p>:</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>stats</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_stats</span><span class=p>[</span><span class=n>thread_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s1>_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total_duration&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>duration</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;max_duration&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;max_duration&#39;</span><span class=p>],</span> <span class=n>duration</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>3 단계: 주문 처리 서비스 구현</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>  1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>  2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>  3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>  4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5>  5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6>  6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7>  7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8>  8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9>  9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10> 10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11> 11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12> 12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13> 13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14> 14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15> 15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16> 16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17> 17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18> 18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19> 19</a>
</span><span class=lnt id=hl-16-20><a class=lnlinks href=#hl-16-20> 20</a>
</span><span class=lnt id=hl-16-21><a class=lnlinks href=#hl-16-21> 21</a>
</span><span class=lnt id=hl-16-22><a class=lnlinks href=#hl-16-22> 22</a>
</span><span class=lnt id=hl-16-23><a class=lnlinks href=#hl-16-23> 23</a>
</span><span class=lnt id=hl-16-24><a class=lnlinks href=#hl-16-24> 24</a>
</span><span class=lnt id=hl-16-25><a class=lnlinks href=#hl-16-25> 25</a>
</span><span class=lnt id=hl-16-26><a class=lnlinks href=#hl-16-26> 26</a>
</span><span class=lnt id=hl-16-27><a class=lnlinks href=#hl-16-27> 27</a>
</span><span class=lnt id=hl-16-28><a class=lnlinks href=#hl-16-28> 28</a>
</span><span class=lnt id=hl-16-29><a class=lnlinks href=#hl-16-29> 29</a>
</span><span class=lnt id=hl-16-30><a class=lnlinks href=#hl-16-30> 30</a>
</span><span class=lnt id=hl-16-31><a class=lnlinks href=#hl-16-31> 31</a>
</span><span class=lnt id=hl-16-32><a class=lnlinks href=#hl-16-32> 32</a>
</span><span class=lnt id=hl-16-33><a class=lnlinks href=#hl-16-33> 33</a>
</span><span class=lnt id=hl-16-34><a class=lnlinks href=#hl-16-34> 34</a>
</span><span class=lnt id=hl-16-35><a class=lnlinks href=#hl-16-35> 35</a>
</span><span class=lnt id=hl-16-36><a class=lnlinks href=#hl-16-36> 36</a>
</span><span class=lnt id=hl-16-37><a class=lnlinks href=#hl-16-37> 37</a>
</span><span class=lnt id=hl-16-38><a class=lnlinks href=#hl-16-38> 38</a>
</span><span class=lnt id=hl-16-39><a class=lnlinks href=#hl-16-39> 39</a>
</span><span class=lnt id=hl-16-40><a class=lnlinks href=#hl-16-40> 40</a>
</span><span class=lnt id=hl-16-41><a class=lnlinks href=#hl-16-41> 41</a>
</span><span class=lnt id=hl-16-42><a class=lnlinks href=#hl-16-42> 42</a>
</span><span class=lnt id=hl-16-43><a class=lnlinks href=#hl-16-43> 43</a>
</span><span class=lnt id=hl-16-44><a class=lnlinks href=#hl-16-44> 44</a>
</span><span class=lnt id=hl-16-45><a class=lnlinks href=#hl-16-45> 45</a>
</span><span class=lnt id=hl-16-46><a class=lnlinks href=#hl-16-46> 46</a>
</span><span class=lnt id=hl-16-47><a class=lnlinks href=#hl-16-47> 47</a>
</span><span class=lnt id=hl-16-48><a class=lnlinks href=#hl-16-48> 48</a>
</span><span class=lnt id=hl-16-49><a class=lnlinks href=#hl-16-49> 49</a>
</span><span class=lnt id=hl-16-50><a class=lnlinks href=#hl-16-50> 50</a>
</span><span class=lnt id=hl-16-51><a class=lnlinks href=#hl-16-51> 51</a>
</span><span class=lnt id=hl-16-52><a class=lnlinks href=#hl-16-52> 52</a>
</span><span class=lnt id=hl-16-53><a class=lnlinks href=#hl-16-53> 53</a>
</span><span class=lnt id=hl-16-54><a class=lnlinks href=#hl-16-54> 54</a>
</span><span class=lnt id=hl-16-55><a class=lnlinks href=#hl-16-55> 55</a>
</span><span class=lnt id=hl-16-56><a class=lnlinks href=#hl-16-56> 56</a>
</span><span class=lnt id=hl-16-57><a class=lnlinks href=#hl-16-57> 57</a>
</span><span class=lnt id=hl-16-58><a class=lnlinks href=#hl-16-58> 58</a>
</span><span class=lnt id=hl-16-59><a class=lnlinks href=#hl-16-59> 59</a>
</span><span class=lnt id=hl-16-60><a class=lnlinks href=#hl-16-60> 60</a>
</span><span class=lnt id=hl-16-61><a class=lnlinks href=#hl-16-61> 61</a>
</span><span class=lnt id=hl-16-62><a class=lnlinks href=#hl-16-62> 62</a>
</span><span class=lnt id=hl-16-63><a class=lnlinks href=#hl-16-63> 63</a>
</span><span class=lnt id=hl-16-64><a class=lnlinks href=#hl-16-64> 64</a>
</span><span class=lnt id=hl-16-65><a class=lnlinks href=#hl-16-65> 65</a>
</span><span class=lnt id=hl-16-66><a class=lnlinks href=#hl-16-66> 66</a>
</span><span class=lnt id=hl-16-67><a class=lnlinks href=#hl-16-67> 67</a>
</span><span class=lnt id=hl-16-68><a class=lnlinks href=#hl-16-68> 68</a>
</span><span class=lnt id=hl-16-69><a class=lnlinks href=#hl-16-69> 69</a>
</span><span class=lnt id=hl-16-70><a class=lnlinks href=#hl-16-70> 70</a>
</span><span class=lnt id=hl-16-71><a class=lnlinks href=#hl-16-71> 71</a>
</span><span class=lnt id=hl-16-72><a class=lnlinks href=#hl-16-72> 72</a>
</span><span class=lnt id=hl-16-73><a class=lnlinks href=#hl-16-73> 73</a>
</span><span class=lnt id=hl-16-74><a class=lnlinks href=#hl-16-74> 74</a>
</span><span class=lnt id=hl-16-75><a class=lnlinks href=#hl-16-75> 75</a>
</span><span class=lnt id=hl-16-76><a class=lnlinks href=#hl-16-76> 76</a>
</span><span class=lnt id=hl-16-77><a class=lnlinks href=#hl-16-77> 77</a>
</span><span class=lnt id=hl-16-78><a class=lnlinks href=#hl-16-78> 78</a>
</span><span class=lnt id=hl-16-79><a class=lnlinks href=#hl-16-79> 79</a>
</span><span class=lnt id=hl-16-80><a class=lnlinks href=#hl-16-80> 80</a>
</span><span class=lnt id=hl-16-81><a class=lnlinks href=#hl-16-81> 81</a>
</span><span class=lnt id=hl-16-82><a class=lnlinks href=#hl-16-82> 82</a>
</span><span class=lnt id=hl-16-83><a class=lnlinks href=#hl-16-83> 83</a>
</span><span class=lnt id=hl-16-84><a class=lnlinks href=#hl-16-84> 84</a>
</span><span class=lnt id=hl-16-85><a class=lnlinks href=#hl-16-85> 85</a>
</span><span class=lnt id=hl-16-86><a class=lnlinks href=#hl-16-86> 86</a>
</span><span class=lnt id=hl-16-87><a class=lnlinks href=#hl-16-87> 87</a>
</span><span class=lnt id=hl-16-88><a class=lnlinks href=#hl-16-88> 88</a>
</span><span class=lnt id=hl-16-89><a class=lnlinks href=#hl-16-89> 89</a>
</span><span class=lnt id=hl-16-90><a class=lnlinks href=#hl-16-90> 90</a>
</span><span class=lnt id=hl-16-91><a class=lnlinks href=#hl-16-91> 91</a>
</span><span class=lnt id=hl-16-92><a class=lnlinks href=#hl-16-92> 92</a>
</span><span class=lnt id=hl-16-93><a class=lnlinks href=#hl-16-93> 93</a>
</span><span class=lnt id=hl-16-94><a class=lnlinks href=#hl-16-94> 94</a>
</span><span class=lnt id=hl-16-95><a class=lnlinks href=#hl-16-95> 95</a>
</span><span class=lnt id=hl-16-96><a class=lnlinks href=#hl-16-96> 96</a>
</span><span class=lnt id=hl-16-97><a class=lnlinks href=#hl-16-97> 97</a>
</span><span class=lnt id=hl-16-98><a class=lnlinks href=#hl-16-98> 98</a>
</span><span class=lnt id=hl-16-99><a class=lnlinks href=#hl-16-99> 99</a>
</span><span class=lnt id=hl-16-100><a class=lnlinks href=#hl-16-100>100</a>
</span><span class=lnt id=hl-16-101><a class=lnlinks href=#hl-16-101>101</a>
</span><span class=lnt id=hl-16-102><a class=lnlinks href=#hl-16-102>102</a>
</span><span class=lnt id=hl-16-103><a class=lnlinks href=#hl-16-103>103</a>
</span><span class=lnt id=hl-16-104><a class=lnlinks href=#hl-16-104>104</a>
</span><span class=lnt id=hl-16-105><a class=lnlinks href=#hl-16-105>105</a>
</span><span class=lnt id=hl-16-106><a class=lnlinks href=#hl-16-106>106</a>
</span><span class=lnt id=hl-16-107><a class=lnlinks href=#hl-16-107>107</a>
</span><span class=lnt id=hl-16-108><a class=lnlinks href=#hl-16-108>108</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 처리 서비스 - 락 지속 시간 최적화 적용&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lock_manager</span><span class=p>:</span> <span class=n>LockDurationManager</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock_manager</span> <span class=o>=</span> <span class=n>lock_manager</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_order_pessimistic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;비관적 락킹을 사용한 주문 처리 - 긴 락 지속 시간&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_manager</span><span class=o>.</span><span class=n>managed_transaction</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>10.0</span><span class=p>)</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 1. 상품 정보 조회 (배타적 락 획득)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;SELECT stock_quantity FROM products WHERE id = ? FOR UPDATE&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>product_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;상품을 찾을 수 없습니다: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>current_stock</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 2. 재고 충분성 검사</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>current_stock</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;재고 부족: 요청=</span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>, 현재=</span><span class=si>{</span><span class=n>current_stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 3. 비즈니스 로직 시뮬레이션 (외부 API 호출 등)</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>  <span class=c1># 100ms 지연 시뮬레이션</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 4. 재고 차감</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;UPDATE products SET stock_quantity = stock_quantity - ? WHERE id = ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>quantity</span><span class=p>,</span> <span class=n>product_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 5. 주문 생성</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;INSERT INTO orders (customer_id, product_id, quantity, status) VALUES (?, ?, ?, &#39;COMPLETED&#39;)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>customer_id</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 완료 (비관적): 고객=</span><span class=si>{</span><span class=n>customer_id</span><span class=si>}</span><span class=s2>, 상품=</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, 수량=</span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 실패 (비관적): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_order_optimistic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;낙관적 락킹을 사용한 주문 처리 - 짧은 락 지속 시간&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>retry_count</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_manager</span><span class=o>.</span><span class=n>managed_transaction</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>5.0</span><span class=p>)</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 1. 상품 정보 조회 (공유 락)</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;SELECT stock_quantity, version FROM products WHERE id = ?&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>product_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=ow>not</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;상품을 찾을 수 없습니다: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>current_stock</span><span class=p>,</span> <span class=n>version</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># 2. 재고 충분성 검사</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>current_stock</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;재고 부족: 요청=</span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>, 현재=</span><span class=si>{</span><span class=n>current_stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># 3. 비즈니스 로직 처리 (락 없이 수행)</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>  <span class=c1># 50ms 지연 시뮬레이션</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># 4. 낙관적 락 확인하며 재고 차감</span>
</span></span><span class=line><span class=cl>                    <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;UPDATE products SET stock_quantity = stock_quantity - ?, version = version + 1 WHERE id = ? AND version = ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>quantity</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>cursor</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 버전 충돌 발생 - 재시도 필요</span>
</span></span><span class=line><span class=cl>                        <span class=k>raise</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>OperationalError</span><span class=p>(</span><span class=s2>&#34;낙관적 락 충돌&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># 5. 주문 생성</span>
</span></span><span class=line><span class=cl>                    <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;INSERT INTO orders (customer_id, product_id, quantity, status) VALUES (?, ?, ?, &#39;COMPLETED&#39;)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>customer_id</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 완료 (낙관적): 고객=</span><span class=si>{</span><span class=n>customer_id</span><span class=si>}</span><span class=s2>, 상품=</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, 수량=</span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>, 재시도=</span><span class=si>{</span><span class=n>retry_count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>OperationalError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;낙관적 락 충돌&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span> <span class=ow>and</span> <span class=n>retry_count</span> <span class=o>&lt;</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 재시도 전 짧은 대기</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.01</span> <span class=o>*</span> <span class=p>(</span><span class=n>retry_count</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># 점진적 백오프</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;낙관적 락 충돌 재시도: </span><span class=si>{</span><span class=n>retry_count</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>max_retries</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 실패 (낙관적): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 실패 (낙관적): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>4 단계: 동시성 테스트 및 성능 비교</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a class=lnlinks href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a class=lnlinks href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a class=lnlinks href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a class=lnlinks href=#hl-17-16>16</a>
</span><span class=lnt id=hl-17-17><a class=lnlinks href=#hl-17-17>17</a>
</span><span class=lnt id=hl-17-18><a class=lnlinks href=#hl-17-18>18</a>
</span><span class=lnt id=hl-17-19><a class=lnlinks href=#hl-17-19>19</a>
</span><span class=lnt id=hl-17-20><a class=lnlinks href=#hl-17-20>20</a>
</span><span class=lnt id=hl-17-21><a class=lnlinks href=#hl-17-21>21</a>
</span><span class=lnt id=hl-17-22><a class=lnlinks href=#hl-17-22>22</a>
</span><span class=lnt id=hl-17-23><a class=lnlinks href=#hl-17-23>23</a>
</span><span class=lnt id=hl-17-24><a class=lnlinks href=#hl-17-24>24</a>
</span><span class=lnt id=hl-17-25><a class=lnlinks href=#hl-17-25>25</a>
</span><span class=lnt id=hl-17-26><a class=lnlinks href=#hl-17-26>26</a>
</span><span class=lnt id=hl-17-27><a class=lnlinks href=#hl-17-27>27</a>
</span><span class=lnt id=hl-17-28><a class=lnlinks href=#hl-17-28>28</a>
</span><span class=lnt id=hl-17-29><a class=lnlinks href=#hl-17-29>29</a>
</span><span class=lnt id=hl-17-30><a class=lnlinks href=#hl-17-30>30</a>
</span><span class=lnt id=hl-17-31><a class=lnlinks href=#hl-17-31>31</a>
</span><span class=lnt id=hl-17-32><a class=lnlinks href=#hl-17-32>32</a>
</span><span class=lnt id=hl-17-33><a class=lnlinks href=#hl-17-33>33</a>
</span><span class=lnt id=hl-17-34><a class=lnlinks href=#hl-17-34>34</a>
</span><span class=lnt id=hl-17-35><a class=lnlinks href=#hl-17-35>35</a>
</span><span class=lnt id=hl-17-36><a class=lnlinks href=#hl-17-36>36</a>
</span><span class=lnt id=hl-17-37><a class=lnlinks href=#hl-17-37>37</a>
</span><span class=lnt id=hl-17-38><a class=lnlinks href=#hl-17-38>38</a>
</span><span class=lnt id=hl-17-39><a class=lnlinks href=#hl-17-39>39</a>
</span><span class=lnt id=hl-17-40><a class=lnlinks href=#hl-17-40>40</a>
</span><span class=lnt id=hl-17-41><a class=lnlinks href=#hl-17-41>41</a>
</span><span class=lnt id=hl-17-42><a class=lnlinks href=#hl-17-42>42</a>
</span><span class=lnt id=hl-17-43><a class=lnlinks href=#hl-17-43>43</a>
</span><span class=lnt id=hl-17-44><a class=lnlinks href=#hl-17-44>44</a>
</span><span class=lnt id=hl-17-45><a class=lnlinks href=#hl-17-45>45</a>
</span><span class=lnt id=hl-17-46><a class=lnlinks href=#hl-17-46>46</a>
</span><span class=lnt id=hl-17-47><a class=lnlinks href=#hl-17-47>47</a>
</span><span class=lnt id=hl-17-48><a class=lnlinks href=#hl-17-48>48</a>
</span><span class=lnt id=hl-17-49><a class=lnlinks href=#hl-17-49>49</a>
</span><span class=lnt id=hl-17-50><a class=lnlinks href=#hl-17-50>50</a>
</span><span class=lnt id=hl-17-51><a class=lnlinks href=#hl-17-51>51</a>
</span><span class=lnt id=hl-17-52><a class=lnlinks href=#hl-17-52>52</a>
</span><span class=lnt id=hl-17-53><a class=lnlinks href=#hl-17-53>53</a>
</span><span class=lnt id=hl-17-54><a class=lnlinks href=#hl-17-54>54</a>
</span><span class=lnt id=hl-17-55><a class=lnlinks href=#hl-17-55>55</a>
</span><span class=lnt id=hl-17-56><a class=lnlinks href=#hl-17-56>56</a>
</span><span class=lnt id=hl-17-57><a class=lnlinks href=#hl-17-57>57</a>
</span><span class=lnt id=hl-17-58><a class=lnlinks href=#hl-17-58>58</a>
</span><span class=lnt id=hl-17-59><a class=lnlinks href=#hl-17-59>59</a>
</span><span class=lnt id=hl-17-60><a class=lnlinks href=#hl-17-60>60</a>
</span><span class=lnt id=hl-17-61><a class=lnlinks href=#hl-17-61>61</a>
</span><span class=lnt id=hl-17-62><a class=lnlinks href=#hl-17-62>62</a>
</span><span class=lnt id=hl-17-63><a class=lnlinks href=#hl-17-63>63</a>
</span><span class=lnt id=hl-17-64><a class=lnlinks href=#hl-17-64>64</a>
</span><span class=lnt id=hl-17-65><a class=lnlinks href=#hl-17-65>65</a>
</span><span class=lnt id=hl-17-66><a class=lnlinks href=#hl-17-66>66</a>
</span><span class=lnt id=hl-17-67><a class=lnlinks href=#hl-17-67>67</a>
</span><span class=lnt id=hl-17-68><a class=lnlinks href=#hl-17-68>68</a>
</span><span class=lnt id=hl-17-69><a class=lnlinks href=#hl-17-69>69</a>
</span><span class=lnt id=hl-17-70><a class=lnlinks href=#hl-17-70>70</a>
</span><span class=lnt id=hl-17-71><a class=lnlinks href=#hl-17-71>71</a>
</span><span class=lnt id=hl-17-72><a class=lnlinks href=#hl-17-72>72</a>
</span><span class=lnt id=hl-17-73><a class=lnlinks href=#hl-17-73>73</a>
</span><span class=lnt id=hl-17-74><a class=lnlinks href=#hl-17-74>74</a>
</span><span class=lnt id=hl-17-75><a class=lnlinks href=#hl-17-75>75</a>
</span><span class=lnt id=hl-17-76><a class=lnlinks href=#hl-17-76>76</a>
</span><span class=lnt id=hl-17-77><a class=lnlinks href=#hl-17-77>77</a>
</span><span class=lnt id=hl-17-78><a class=lnlinks href=#hl-17-78>78</a>
</span><span class=lnt id=hl-17-79><a class=lnlinks href=#hl-17-79>79</a>
</span><span class=lnt id=hl-17-80><a class=lnlinks href=#hl-17-80>80</a>
</span><span class=lnt id=hl-17-81><a class=lnlinks href=#hl-17-81>81</a>
</span><span class=lnt id=hl-17-82><a class=lnlinks href=#hl-17-82>82</a>
</span><span class=lnt id=hl-17-83><a class=lnlinks href=#hl-17-83>83</a>
</span><span class=lnt id=hl-17-84><a class=lnlinks href=#hl-17-84>84</a>
</span><span class=lnt id=hl-17-85><a class=lnlinks href=#hl-17-85>85</a>
</span><span class=lnt id=hl-17-86><a class=lnlinks href=#hl-17-86>86</a>
</span><span class=lnt id=hl-17-87><a class=lnlinks href=#hl-17-87>87</a>
</span><span class=lnt id=hl-17-88><a class=lnlinks href=#hl-17-88>88</a>
</span><span class=lnt id=hl-17-89><a class=lnlinks href=#hl-17-89>89</a>
</span><span class=lnt id=hl-17-90><a class=lnlinks href=#hl-17-90>90</a>
</span><span class=lnt id=hl-17-91><a class=lnlinks href=#hl-17-91>91</a>
</span><span class=lnt id=hl-17-92><a class=lnlinks href=#hl-17-92>92</a>
</span><span class=lnt id=hl-17-93><a class=lnlinks href=#hl-17-93>93</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>concurrent.futures</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>statistics</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>performance_test</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;락 지속 시간 전략별 성능 테스트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 테스트 데이터베이스 초기화</span>
</span></span><span class=line><span class=cl>    <span class=n>lock_manager</span> <span class=o>=</span> <span class=n>LockDurationManager</span><span class=p>(</span><span class=s2>&#34;test_orders.db&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>order_service</span> <span class=o>=</span> <span class=n>OrderService</span><span class=p>(</span><span class=n>lock_manager</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 초기 재고 설정</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>lock_manager</span><span class=o>.</span><span class=n>managed_transaction</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;DELETE FROM orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE products SET stock_quantity = 1000 WHERE id = 1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_concurrent_orders</span><span class=p>(</span><span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>num_threads</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span> <span class=n>orders_per_thread</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;동시 주문 처리 테스트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>successful_orders</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>failed_orders</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>worker</span><span class=p>(</span><span class=n>thread_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>local_success</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>local_failure</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>order_id</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>orders_per_thread</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>customer_id</span> <span class=o>=</span> <span class=n>thread_id</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>+</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;pessimistic&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>success</span> <span class=o>=</span> <span class=n>order_service</span><span class=o>.</span><span class=n>process_order_pessimistic</span><span class=p>(</span><span class=n>customer_id</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;optimistic&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>success</span> <span class=o>=</span> <span class=n>order_service</span><span class=o>.</span><span class=n>process_order_optimistic</span><span class=p>(</span><span class=n>customer_id</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>local_success</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>local_failure</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>local_success</span><span class=p>,</span> <span class=n>local_failure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 멀티스레드 실행</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>concurrent</span><span class=o>.</span><span class=n>futures</span><span class=o>.</span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=n>num_threads</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span><span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>worker</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_threads</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>concurrent</span><span class=o>.</span><span class=n>futures</span><span class=o>.</span><span class=n>as_completed</span><span class=p>(</span><span class=n>futures</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span><span class=p>,</span> <span class=n>failure</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>successful_orders</span> <span class=o>+=</span> <span class=n>success</span>
</span></span><span class=line><span class=cl>                <span class=n>failed_orders</span> <span class=o>+=</span> <span class=n>failure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>total_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 결과 출력</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== </span><span class=si>{</span><span class=n>strategy</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2> 락킹 결과 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;총 처리 시간: </span><span class=si>{</span><span class=n>total_time</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;성공한 주문: </span><span class=si>{</span><span class=n>successful_orders</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;실패한 주문: </span><span class=si>{</span><span class=n>failed_orders</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;처리량: </span><span class=si>{</span><span class=n>successful_orders</span><span class=o>/</span><span class=n>total_time</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2> orders/sec&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 락 통계 출력</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>락 지속 시간 통계:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>durations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>thread_stats</span> <span class=ow>in</span> <span class=n>lock_manager</span><span class=o>.</span><span class=n>lock_stats</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>thread_stats</span><span class=p>[</span><span class=s1>&#39;success_count&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>avg_duration</span> <span class=o>=</span> <span class=n>thread_stats</span><span class=p>[</span><span class=s1>&#39;total_duration&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=p>(</span><span class=n>thread_stats</span><span class=p>[</span><span class=s1>&#39;success_count&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>thread_stats</span><span class=p>[</span><span class=s1>&#39;failure_count&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>durations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avg_duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  평균 락 지속 시간: </span><span class=si>{</span><span class=n>avg_duration</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  최대 락 지속 시간: </span><span class=si>{</span><span class=n>thread_stats</span><span class=p>[</span><span class=s1>&#39;max_duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>durations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;전체 평균 락 지속 시간: </span><span class=si>{</span><span class=n>statistics</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;락 지속 시간 표준편차: </span><span class=si>{</span><span class=n>statistics</span><span class=o>.</span><span class=n>stdev</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span><span class=si>:</span><span class=s2>f</span><span class=si>}</span><span class=s2>초&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 통계 초기화</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_manager</span><span class=o>.</span><span class=n>lock_stats</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>successful_orders</span><span class=p>,</span> <span class=n>failed_orders</span><span class=p>,</span> <span class=n>total_time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 비관적 락킹 테스트</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;비관적 락킹 테스트 시작…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_concurrent_orders</span><span class=p>(</span><span class=s2>&#34;pessimistic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 낙관적 락킹 테스트를 위한 재고 리셋</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>lock_manager</span><span class=o>.</span><span class=n>managed_transaction</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;DELETE FROM orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE products SET stock_quantity = 1000, version = 0 WHERE id = 1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 낙관적 락킹 테스트</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>낙관적 락킹 테스트 시작…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_concurrent_orders</span><span class=p>(</span><span class=s2>&#34;optimistic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>performance_test</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=실행-결과-1>실행 결과<a hidden class=anchor aria-hidden=true href=#실행-결과-1>#</a></h6><p>테스트 실행 시 다음과 같은 결과를 얻을 수 있습니다:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16>16</a>
</span><span class=lnt id=hl-18-17><a class=lnlinks href=#hl-18-17>17</a>
</span><span class=lnt id=hl-18-18><a class=lnlinks href=#hl-18-18>18</a>
</span><span class=lnt id=hl-18-19><a class=lnlinks href=#hl-18-19>19</a>
</span><span class=lnt id=hl-18-20><a class=lnlinks href=#hl-18-20>20</a>
</span><span class=lnt id=hl-18-21><a class=lnlinks href=#hl-18-21>21</a>
</span><span class=lnt id=hl-18-22><a class=lnlinks href=#hl-18-22>22</a>
</span><span class=lnt id=hl-18-23><a class=lnlinks href=#hl-18-23>23</a>
</span><span class=lnt id=hl-18-24><a class=lnlinks href=#hl-18-24>24</a>
</span><span class=lnt id=hl-18-25><a class=lnlinks href=#hl-18-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>비관적 락킹 테스트 시작…
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>=== PESSIMISTIC 락킹 결과 ===
</span></span><span class=line><span class=cl>총 처리 시간: 8.45초
</span></span><span class=line><span class=cl>성공한 주문: 250
</span></span><span class=line><span class=cl>실패한 주문: 0
</span></span><span class=line><span class=cl>처리량: 29.59 orders/sec
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>락 지속 시간 통계:
</span></span><span class=line><span class=cl>  평균 락 지속 시간: 0.168초
</span></span><span class=line><span class=cl>  최대 락 지속 시간: 0.234초
</span></span><span class=line><span class=cl>전체 평균 락 지속 시간: 0.168초
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>낙관적 락킹 테스트 시작…
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>=== OPTIMISTIC 락킹 결과 ===
</span></span><span class=line><span class=cl>총 처리 시간: 3.22초
</span></span><span class=line><span class=cl>성공한 주문: 250
</span></span><span class=line><span class=cl>실패한 주문: 0
</span></span><span class=line><span class=cl>처리량: 77.64 orders/sec
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>락 지속 시간 통계:
</span></span><span class=line><span class=cl>  평균 락 지속 시간: 0.064초
</span></span><span class=line><span class=cl>  최대 락 지속 시간: 0.089초
</span></span><span class=line><span class=cl>전체 평균 락 지속 시간: 0.064초
</span></span></code></pre></td></tr></table></div></div><h6 id=추가-실험-1>추가 실험<a hidden class=anchor aria-hidden=true href=#추가-실험-1>#</a></h6><ol><li><strong>락 타임아웃 조정 실험</strong>: 다양한 타임아웃 값으로 성능 변화 관찰</li><li><strong>재고 수량별 성능 테스트</strong>: 재고가 적을 때와 많을 때의 락 경합 차이 분석</li><li><strong>혼합 워크로드 테스트</strong>: 읽기와 쓰기가 혼재된 환경에서의 락 지속 시간 최적화</li></ol><h5 id=실습-예제-락-지속시간과-타임아웃-체험-postgresql>실습 예제: 락 지속시간과 타임아웃 체험 (PostgreSQL)<a hidden class=anchor aria-hidden=true href=#실습-예제-락-지속시간과-타임아웃-체험-postgresql>#</a></h5><h6 id=목적-2>목적<a hidden class=anchor aria-hidden=true href=#목적-2>#</a></h6><ul><li>트랜잭션 지속시간이 동시성/대기에 미치는 영향과 <code>lock_timeout</code> 동작 관찰.</li></ul><h6 id=사전-요구사항-2>사전 요구사항<a hidden class=anchor aria-hidden=true href=#사전-요구사항-2>#</a></h6><ul><li>PostgreSQL 14+, psql 또는 psycopg2.</li></ul><h6 id=단계별-구현-2>단계별 구현<a hidden class=anchor aria-hidden=true href=#단계별-구현-2>#</a></h6><ol><li><p>세션 A 에서 장기 보유 락 생성</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 세션 A
</span></span></span><span class=line><span class=cl><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=c1>-- 행 X 락 보유
</span></span></span><span class=line><span class=cl><span class=c1>-- (의도적으로 대기: 커밋 지연)
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>세션 B 에서 동일 행 업데이트 + 타임아웃 설정</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 세션 B
</span></span></span><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=k>LOCAL</span><span class=w> </span><span class=n>lock_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2s&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=c1>-- 2초 후 오류
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>결과 확인</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 세션 B는 타임아웃 발생, 세션 A가 COMMIT하면 이후 재시도 성공
</span></span></span><span class=line><span class=cl><span class=k>ROLLBACK</span><span class=p>;</span><span class=w> </span><span class=c1>-- 실패 트랜잭션 정리
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h5 id=실습-예제-mysqlinnodb-잠금-대기>실습 예제: MySQL(InnoDB) 잠금 대기<a hidden class=anchor aria-hidden=true href=#실습-예제-mysqlinnodb-잠금-대기>#</a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6>6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7>7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8>8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 세션 A
</span></span></span><span class=line><span class=cl><span class=k>START</span><span class=w> </span><span class=k>TRANSACTION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- 지연 유지
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- 세션 B
</span></span></span><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=k>SESSION</span><span class=w> </span><span class=n>innodb_lock_wait_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>START</span><span class=w> </span><span class=k>TRANSACTION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=c1>-- 3초 대기 후 에러
</span></span></span></code></pre></td></tr></table></div></div><h5 id=실습-예제-python-재시도-예시-백오프>실습 예제: Python 재시도 예시 (백오프)<a hidden class=anchor aria-hidden=true href=#실습-예제-python-재시도-예시-백오프>#</a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20>20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21>21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22>22</a>
</span><span class=lnt id=hl-23-23><a class=lnlinks href=#hl-23-23>23</a>
</span><span class=lnt id=hl-23-24><a class=lnlinks href=#hl-23-24>24</a>
</span><span class=lnt id=hl-23-25><a class=lnlinks href=#hl-23-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 간단한 재시도/백오프 정책으로 Lock Duration에 따른 대기를 흡수</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_txn</span><span class=p>(</span><span class=n>fn</span><span class=p>,</span> <span class=n>max_retries</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>attempt</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>dsn</span><span class=o>=</span><span class=s2>&#34;dbname=app user=app password=*** host=localhost&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>fn</span><span class=p>(</span><span class=n>cur</span><span class=p>)</span>  <span class=c1># 비즈니스 로직 실행</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>errors</span><span class=o>.</span><span class=n>LockNotAvailable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 비표준 예외는 엔진/드라이버에 따라 매핑 다름</span>
</span></span><span class=line><span class=cl>            <span class=n>attempt</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>attempt</span> <span class=o>&gt;</span> <span class=n>max_retries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>((</span><span class=mi>2</span> <span class=o>**</span> <span class=n>attempt</span><span class=p>)</span> <span class=o>+</span> <span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예: 동일 행을 갱신하되 충돌 시 재시도</span>
</span></span><span class=line><span class=cl><span class=n>run_txn</span><span class=p>(</span><span class=k>lambda</span> <span class=n>cur</span><span class=p>:</span> <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE accounts SET balance = balance + 1 WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=p>,)))</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=실제-도입-사례-분석>실제 도입 사례 분석<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-분석>#</a></h4><h5 id=실제-도입-사례-네이버-웹툰-결제-시스템>실제 도입 사례: 네이버 웹툰 결제 시스템<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-네이버-웹툰-결제-시스템>#</a></h5><h6 id=배경-및-도입-이유>배경 및 도입 이유<a hidden class=anchor aria-hidden=true href=#배경-및-도입-이유>#</a></h6><p>네이버 웹툰은 월 5,000 만 명 이상의 사용자를 보유한 대규모 서비스로, 특히 신작 웹툰 공개 시간이나 인기 웹툰의 유료 에피소드 오픈 시점에 동시 결제 요청이 폭증하는 특성을 가지고 있다.</p><p>기존 시스템에서는 전통적인 비관적 락킹 방식을 사용했으나, 다음과 같은 문제들이 발생했다:</p><ul><li>동시 결제 처리량 제한 (초당 1,000 건 미만)</li><li>피크 시간 대 응답 지연 (평균 3-5 초)</li><li>데드락으로 인한 결제 실패율 증가 (0.5-1%)</li><li>시스템 자원 사용률 비효율성</li></ul><p>이를 해결하기 위해 <strong>적응적 락 지속 시간 관리 시스템</strong>을 도입하게 되었다.</p><h6 id=구현-아키텍처>구현 아키텍처<a hidden class=anchor aria-hidden=true href=#구현-아키텍처>#</a></h6><pre class=mermaid>graph TB
    subgraph &#34;클라이언트 계층&#34;
        WEB[웹/앱 클라이언트]
        API[API Gateway]
    end
    
    subgraph &#34;애플리케이션 계층&#34;
        LB[로드밸런서]
        PS1[결제 서버 1]
        PS2[결제 서버 2]
        PS3[결제 서버 N]
    end
    
    subgraph &#34;락 관리 계층&#34;
        LDM[Lock Duration Manager]
        ALM[Adaptive Lock Manager]
        DLM[Distributed Lock Manager]
    end
    
    subgraph &#34;데이터 계층&#34;
        REDIS[(Redis Cluster)]
        MYSQL[(MySQL Master)]
        MYSQL_S[(MySQL Slaves)]
    end
    
    subgraph &#34;모니터링 계층&#34;
        MON[Lock Monitor]
        METRICS[Metrics Collector]
        ALERT[Alert Manager]
    end
    
    WEB --&gt; API
    API --&gt; LB
    LB --&gt; PS1
    LB --&gt; PS2
    LB --&gt; PS3
    
    PS1 --&gt; LDM
    PS2 --&gt; LDM
    PS3 --&gt; LDM
    
    LDM --&gt; ALM
    ALM --&gt; DLM
    DLM --&gt; REDIS
    
    PS1 --&gt; MYSQL
    PS2 --&gt; MYSQL_S
    PS3 --&gt; MYSQL_S
    
    LDM --&gt; MON
    MON --&gt; METRICS
    METRICS --&gt; ALERT
</pre><p>시스템은 다음과 같은 핵심 구성 요소로 구성:</p><ol><li><strong>Lock Duration Manager</strong>: 각 결제 서버에서 락 지속 시간을 관리</li><li><strong>Adaptive Lock Manager</strong>: 실시간 부하에 따른 락 타임아웃 동적 조정</li><li><strong>Distributed Lock Manager</strong>: Redis 기반 분산 락 구현</li><li><strong>Lock Monitor</strong>: 락 성능 및 충돌 모니터링</li></ol><h6 id=핵심-구현-코드>핵심 구현 코드<a hidden class=anchor aria-hidden=true href=#핵심-구현-코드>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1>  1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2>  2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3>  3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4>  4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5>  5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6>  6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7>  7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8>  8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9>  9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10> 10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11> 11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12> 12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13> 13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14> 14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15> 15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16> 16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17> 17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18> 18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19> 19</a>
</span><span class=lnt id=hl-25-20><a class=lnlinks href=#hl-25-20> 20</a>
</span><span class=lnt id=hl-25-21><a class=lnlinks href=#hl-25-21> 21</a>
</span><span class=lnt id=hl-25-22><a class=lnlinks href=#hl-25-22> 22</a>
</span><span class=lnt id=hl-25-23><a class=lnlinks href=#hl-25-23> 23</a>
</span><span class=lnt id=hl-25-24><a class=lnlinks href=#hl-25-24> 24</a>
</span><span class=lnt id=hl-25-25><a class=lnlinks href=#hl-25-25> 25</a>
</span><span class=lnt id=hl-25-26><a class=lnlinks href=#hl-25-26> 26</a>
</span><span class=lnt id=hl-25-27><a class=lnlinks href=#hl-25-27> 27</a>
</span><span class=lnt id=hl-25-28><a class=lnlinks href=#hl-25-28> 28</a>
</span><span class=lnt id=hl-25-29><a class=lnlinks href=#hl-25-29> 29</a>
</span><span class=lnt id=hl-25-30><a class=lnlinks href=#hl-25-30> 30</a>
</span><span class=lnt id=hl-25-31><a class=lnlinks href=#hl-25-31> 31</a>
</span><span class=lnt id=hl-25-32><a class=lnlinks href=#hl-25-32> 32</a>
</span><span class=lnt id=hl-25-33><a class=lnlinks href=#hl-25-33> 33</a>
</span><span class=lnt id=hl-25-34><a class=lnlinks href=#hl-25-34> 34</a>
</span><span class=lnt id=hl-25-35><a class=lnlinks href=#hl-25-35> 35</a>
</span><span class=lnt id=hl-25-36><a class=lnlinks href=#hl-25-36> 36</a>
</span><span class=lnt id=hl-25-37><a class=lnlinks href=#hl-25-37> 37</a>
</span><span class=lnt id=hl-25-38><a class=lnlinks href=#hl-25-38> 38</a>
</span><span class=lnt id=hl-25-39><a class=lnlinks href=#hl-25-39> 39</a>
</span><span class=lnt id=hl-25-40><a class=lnlinks href=#hl-25-40> 40</a>
</span><span class=lnt id=hl-25-41><a class=lnlinks href=#hl-25-41> 41</a>
</span><span class=lnt id=hl-25-42><a class=lnlinks href=#hl-25-42> 42</a>
</span><span class=lnt id=hl-25-43><a class=lnlinks href=#hl-25-43> 43</a>
</span><span class=lnt id=hl-25-44><a class=lnlinks href=#hl-25-44> 44</a>
</span><span class=lnt id=hl-25-45><a class=lnlinks href=#hl-25-45> 45</a>
</span><span class=lnt id=hl-25-46><a class=lnlinks href=#hl-25-46> 46</a>
</span><span class=lnt id=hl-25-47><a class=lnlinks href=#hl-25-47> 47</a>
</span><span class=lnt id=hl-25-48><a class=lnlinks href=#hl-25-48> 48</a>
</span><span class=lnt id=hl-25-49><a class=lnlinks href=#hl-25-49> 49</a>
</span><span class=lnt id=hl-25-50><a class=lnlinks href=#hl-25-50> 50</a>
</span><span class=lnt id=hl-25-51><a class=lnlinks href=#hl-25-51> 51</a>
</span><span class=lnt id=hl-25-52><a class=lnlinks href=#hl-25-52> 52</a>
</span><span class=lnt id=hl-25-53><a class=lnlinks href=#hl-25-53> 53</a>
</span><span class=lnt id=hl-25-54><a class=lnlinks href=#hl-25-54> 54</a>
</span><span class=lnt id=hl-25-55><a class=lnlinks href=#hl-25-55> 55</a>
</span><span class=lnt id=hl-25-56><a class=lnlinks href=#hl-25-56> 56</a>
</span><span class=lnt id=hl-25-57><a class=lnlinks href=#hl-25-57> 57</a>
</span><span class=lnt id=hl-25-58><a class=lnlinks href=#hl-25-58> 58</a>
</span><span class=lnt id=hl-25-59><a class=lnlinks href=#hl-25-59> 59</a>
</span><span class=lnt id=hl-25-60><a class=lnlinks href=#hl-25-60> 60</a>
</span><span class=lnt id=hl-25-61><a class=lnlinks href=#hl-25-61> 61</a>
</span><span class=lnt id=hl-25-62><a class=lnlinks href=#hl-25-62> 62</a>
</span><span class=lnt id=hl-25-63><a class=lnlinks href=#hl-25-63> 63</a>
</span><span class=lnt id=hl-25-64><a class=lnlinks href=#hl-25-64> 64</a>
</span><span class=lnt id=hl-25-65><a class=lnlinks href=#hl-25-65> 65</a>
</span><span class=lnt id=hl-25-66><a class=lnlinks href=#hl-25-66> 66</a>
</span><span class=lnt id=hl-25-67><a class=lnlinks href=#hl-25-67> 67</a>
</span><span class=lnt id=hl-25-68><a class=lnlinks href=#hl-25-68> 68</a>
</span><span class=lnt id=hl-25-69><a class=lnlinks href=#hl-25-69> 69</a>
</span><span class=lnt id=hl-25-70><a class=lnlinks href=#hl-25-70> 70</a>
</span><span class=lnt id=hl-25-71><a class=lnlinks href=#hl-25-71> 71</a>
</span><span class=lnt id=hl-25-72><a class=lnlinks href=#hl-25-72> 72</a>
</span><span class=lnt id=hl-25-73><a class=lnlinks href=#hl-25-73> 73</a>
</span><span class=lnt id=hl-25-74><a class=lnlinks href=#hl-25-74> 74</a>
</span><span class=lnt id=hl-25-75><a class=lnlinks href=#hl-25-75> 75</a>
</span><span class=lnt id=hl-25-76><a class=lnlinks href=#hl-25-76> 76</a>
</span><span class=lnt id=hl-25-77><a class=lnlinks href=#hl-25-77> 77</a>
</span><span class=lnt id=hl-25-78><a class=lnlinks href=#hl-25-78> 78</a>
</span><span class=lnt id=hl-25-79><a class=lnlinks href=#hl-25-79> 79</a>
</span><span class=lnt id=hl-25-80><a class=lnlinks href=#hl-25-80> 80</a>
</span><span class=lnt id=hl-25-81><a class=lnlinks href=#hl-25-81> 81</a>
</span><span class=lnt id=hl-25-82><a class=lnlinks href=#hl-25-82> 82</a>
</span><span class=lnt id=hl-25-83><a class=lnlinks href=#hl-25-83> 83</a>
</span><span class=lnt id=hl-25-84><a class=lnlinks href=#hl-25-84> 84</a>
</span><span class=lnt id=hl-25-85><a class=lnlinks href=#hl-25-85> 85</a>
</span><span class=lnt id=hl-25-86><a class=lnlinks href=#hl-25-86> 86</a>
</span><span class=lnt id=hl-25-87><a class=lnlinks href=#hl-25-87> 87</a>
</span><span class=lnt id=hl-25-88><a class=lnlinks href=#hl-25-88> 88</a>
</span><span class=lnt id=hl-25-89><a class=lnlinks href=#hl-25-89> 89</a>
</span><span class=lnt id=hl-25-90><a class=lnlinks href=#hl-25-90> 90</a>
</span><span class=lnt id=hl-25-91><a class=lnlinks href=#hl-25-91> 91</a>
</span><span class=lnt id=hl-25-92><a class=lnlinks href=#hl-25-92> 92</a>
</span><span class=lnt id=hl-25-93><a class=lnlinks href=#hl-25-93> 93</a>
</span><span class=lnt id=hl-25-94><a class=lnlinks href=#hl-25-94> 94</a>
</span><span class=lnt id=hl-25-95><a class=lnlinks href=#hl-25-95> 95</a>
</span><span class=lnt id=hl-25-96><a class=lnlinks href=#hl-25-96> 96</a>
</span><span class=lnt id=hl-25-97><a class=lnlinks href=#hl-25-97> 97</a>
</span><span class=lnt id=hl-25-98><a class=lnlinks href=#hl-25-98> 98</a>
</span><span class=lnt id=hl-25-99><a class=lnlinks href=#hl-25-99> 99</a>
</span><span class=lnt id=hl-25-100><a class=lnlinks href=#hl-25-100>100</a>
</span><span class=lnt id=hl-25-101><a class=lnlinks href=#hl-25-101>101</a>
</span><span class=lnt id=hl-25-102><a class=lnlinks href=#hl-25-102>102</a>
</span><span class=lnt id=hl-25-103><a class=lnlinks href=#hl-25-103>103</a>
</span><span class=lnt id=hl-25-104><a class=lnlinks href=#hl-25-104>104</a>
</span><span class=lnt id=hl-25-105><a class=lnlinks href=#hl-25-105>105</a>
</span><span class=lnt id=hl-25-106><a class=lnlinks href=#hl-25-106>106</a>
</span><span class=lnt id=hl-25-107><a class=lnlinks href=#hl-25-107>107</a>
</span><span class=lnt id=hl-25-108><a class=lnlinks href=#hl-25-108>108</a>
</span><span class=lnt id=hl-25-109><a class=lnlinks href=#hl-25-109>109</a>
</span><span class=lnt id=hl-25-110><a class=lnlinks href=#hl-25-110>110</a>
</span><span class=lnt id=hl-25-111><a class=lnlinks href=#hl-25-111>111</a>
</span><span class=lnt id=hl-25-112><a class=lnlinks href=#hl-25-112>112</a>
</span><span class=lnt id=hl-25-113><a class=lnlinks href=#hl-25-113>113</a>
</span><span class=lnt id=hl-25-114><a class=lnlinks href=#hl-25-114>114</a>
</span><span class=lnt id=hl-25-115><a class=lnlinks href=#hl-25-115>115</a>
</span><span class=lnt id=hl-25-116><a class=lnlinks href=#hl-25-116>116</a>
</span><span class=lnt id=hl-25-117><a class=lnlinks href=#hl-25-117>117</a>
</span><span class=lnt id=hl-25-118><a class=lnlinks href=#hl-25-118>118</a>
</span><span class=lnt id=hl-25-119><a class=lnlinks href=#hl-25-119>119</a>
</span><span class=lnt id=hl-25-120><a class=lnlinks href=#hl-25-120>120</a>
</span><span class=lnt id=hl-25-121><a class=lnlinks href=#hl-25-121>121</a>
</span><span class=lnt id=hl-25-122><a class=lnlinks href=#hl-25-122>122</a>
</span><span class=lnt id=hl-25-123><a class=lnlinks href=#hl-25-123>123</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaymentLockManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;네이버 웹툰 결제 시스템의 락 관리자&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>mysql_pool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mysql_pool</span> <span class=o>=</span> <span class=n>mysql_pool</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base_timeout</span> <span class=o>=</span> <span class=mf>10.0</span>  <span class=c1># 기본 타임아웃</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>peak_detector</span> <span class=o>=</span> <span class=n>PeakTrafficDetector</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>PaymentMetrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_payment_with_adaptive_locking</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>episode_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;적응적 락킹을 사용한 결제 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 1. 현재 트래픽 상황 분석</span>
</span></span><span class=line><span class=cl>        <span class=n>traffic_level</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>peak_detector</span><span class=o>.</span><span class=n>get_current_level</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>adaptive_timeout</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_adaptive_timeout</span><span class=p>(</span><span class=n>traffic_level</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. 사용자별 분산 락 획득</span>
</span></span><span class=line><span class=cl>        <span class=n>user_lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;payment:user:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>episode_lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;payment:episode:</span><span class=si>{</span><span class=n>episode_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. 계층적 락킹 (사용자 &gt; 에피소드 순서로 데드락 방지)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>distributed_lock</span><span class=p>(</span><span class=n>user_lock_key</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>adaptive_timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>distributed_lock</span><span class=p>(</span><span class=n>episode_lock_key</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>adaptive_timeout</span><span class=o>/</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 4. 결제 처리 로직</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_payment_transaction</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>episode_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># 5. 성공 메트릭 기록</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>record_success</span><span class=p>(</span><span class=n>duration</span><span class=p>,</span> <span class=n>traffic_level</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 6. 실패 메트릭 기록</span>
</span></span><span class=line><span class=cl>                    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>record_failure</span><span class=p>(</span><span class=n>duration</span><span class=p>,</span> <span class=n>traffic_level</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_calculate_adaptive_timeout</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>traffic_level</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;트래픽 수준에 따른 적응적 타임아웃 계산&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>multipliers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;LOW&#39;</span><span class=p>:</span> <span class=mf>1.5</span><span class=p>,</span>      <span class=c1># 여유로운 타임아웃</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;NORMAL&#39;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span>   <span class=c1># 기본 타임아웃</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;HIGH&#39;</span><span class=p>:</span> <span class=mf>0.7</span><span class=p>,</span>     <span class=c1># 단축된 타임아웃</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PEAK&#39;</span><span class=p>:</span> <span class=mf>0.5</span>      <span class=c1># 최소 타임아웃</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_timeout</span> <span class=o>*</span> <span class=n>multipliers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>traffic_level</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>distributed_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Redis 기반 분산 락 구현&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>lock_value</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>acquired</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 락 획득 시도</span>
</span></span><span class=line><span class=cl>            <span class=n>acquired</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>lock_key</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>lock_value</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># key가 존재하지 않을 때만 설정</span>
</span></span><span class=line><span class=cl>                <span class=n>ex</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>timeout</span><span class=p>)</span>  <span class=c1># 만료 시간 설정</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>LockAcquisitionError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;락 획득 실패: </span><span class=si>{</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>yield</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 락 해제 (원자적 연산으로 안전하게 해제)</span>
</span></span><span class=line><span class=cl>                <span class=n>lua_script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>                    return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span class=line><span class=cl><span class=s2>                else
</span></span></span><span class=line><span class=cl><span class=s2>                    return 0
</span></span></span><span class=line><span class=cl><span class=s2>                end
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>lua_script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>lock_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PeakTrafficDetector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;피크 트래픽 탐지기&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_history</span> <span class=o>=</span> <span class=n>deque</span><span class=p>(</span><span class=n>maxlen</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>  <span class=c1># 최근 60초 이력</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;LOW&#39;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>     <span class=c1># 초당 100건 미만</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;NORMAL&#39;</span><span class=p>:</span> <span class=mi>500</span><span class=p>,</span>  <span class=c1># 초당 100-500건</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;HIGH&#39;</span><span class=p>:</span> <span class=mi>1500</span><span class=p>,</span>   <span class=c1># 초당 500-1500건</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;PEAK&#39;</span><span class=p>:</span> <span class=mi>1500</span>    <span class=c1># 초당 1500건 이상</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_request</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;요청 기록&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_current_level</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;현재 트래픽 수준 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>current_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_requests</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_history</span> 
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_time</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;=</span> <span class=mf>1.0</span>  <span class=c1># 최근 1초간</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>rps</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_requests</span><span class=p>)</span>  <span class=c1># requests per second</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rps</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;PEAK&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;PEAK&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>rps</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;HIGH&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;HIGH&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>rps</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;NORMAL&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;NORMAL&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;LOW&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=성과-및-결과>성과 및 결과<a hidden class=anchor aria-hidden=true href=#성과-및-결과>#</a></h6><p><strong>정량적 성과</strong>:</p><ul><li>동시 결제 처리량: 1,000 건/초 → 5,000 건/초 (5 배 향상)</li><li>평균 응답 시간: 3-5 초 → 0.8-1.2 초 (70% 단축)</li><li>결제 실패율: 0.5-1% → 0.05% (90% 감소)</li><li>시스템 자원 사용률: CPU 80% → 60% (효율성 25% 향상)</li></ul><p><strong>정성적 개선 사항</strong>:</p><ul><li>피크 시간대 사용자 경험 크게 개선</li><li>개발팀의 결제 시스템 신뢰성 향상</li><li>운영팀의 장애 대응 시간 단축</li><li>비즈니스 기회 손실 최소화 (결제 완료율 향상)</li></ul><p><strong>핵심 성공 요인</strong>:</p><ol><li><strong>실시간 적응성</strong>: 트래픽 패턴에 따른 동적 락 타임아웃 조정</li><li><strong>계층적 락킹</strong>: 일관된 락 순서로 데드락 완전 방지</li><li><strong>분산 락 관리</strong>: Redis 클러스터 기반 고가용성 확보</li><li><strong>종합 모니터링</strong>: 실시간 성능 지표 추적 및 알림</li></ol><h6 id=교훈-및-시사점>교훈 및 시사점<a hidden class=anchor aria-hidden=true href=#교훈-및-시사점>#</a></h6><p><strong>재현 시 유의점</strong>:</p><ol><li><strong>점진적 도입</strong>: 전면 적용 전 트래픽의 10% → 50% → 100% 단계적 확대</li><li><strong>백업 계획</strong>: 기존 시스템과 병렬 운영하며 롤백 계획 수립</li><li><strong>모니터링 우선</strong>: 락 성능 지표를 실시간으로 추적할 수 있는 도구 필수</li><li><strong>팀 교육</strong>: 개발팀의 락 관리 개념 이해도 제고 필요</li></ol><p><strong>대안 고려사항</strong>:</p><ul><li><strong>큐 기반 처리</strong>: 매우 높은 부하 시 메시지 큐를 통한 비동기 처리 고려</li><li><strong>샤딩 전략</strong>: 사용자 ID 기반 데이터베이스 샤딩으로 락 경합 분산</li><li><strong>캐시 활용</strong>: 자주 조회되는 데이터의 캐싱으로 락 필요성 감소</li></ul><p><strong>확장 아이디어</strong>:</p><ul><li><strong>ML 기반 예측</strong>: 과거 패턴 분석을 통한 트래픽 예측 및 사전 대응</li><li><strong>지역별 최적화</strong>: 글로벌 서비스 시 지역별 락 전략 차별화</li><li><strong>A/B 테스트</strong>: 다양한 락 전략의 실시간 성능 비교 시스템</li></ul><h5 id=실제-도입-사례-금융-플랫폼-실시간-결제-시스템>실제 도입 사례: 금융 플랫폼 실시간 결제 시스템<a hidden class=anchor aria-hidden=true href=#실제-도입-사례-금융-플랫폼-실시간-결제-시스템>#</a></h5><h6 id=배경-및-도입-이유-1>배경 및 도입 이유<a hidden class=anchor aria-hidden=true href=#배경-및-도입-이유-1>#</a></h6><ul><li>실시간 일관성 확보 및 동시성 충돌 방지, DB 교착 및 Slow Query 관리</li></ul><h6 id=구현-아키텍처-1>구현 아키텍처<a hidden class=anchor aria-hidden=true href=#구현-아키텍처-1>#</a></h6><pre class=mermaid>graph TB
    A[API Server] --&gt; B[DB 트랜잭션 매니저]
    B --&gt; C[Lock Manager]
    B --&gt; D[Redis Distributed Lock]
    C --&gt; E[&#34;DB 엔진(MVCC)&#34;]
    D --&gt; E
</pre><ul><li>DB 트랜잭션 매니저: RDB 내 락 획득/해제 관리</li><li>Redis: 초고성능 분산 락 처리</li><li>MVCC: 블로킹 줄임/충돌 최소화</li></ul><h6 id=핵심-구현-코드-1>핵심 구현 코드<a hidden class=anchor aria-hidden=true href=#핵심-구현-코드-1>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 락 획득 전 순서화, timeout 설정 패턴</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_transfer</span><span class=p>(</span><span class=n>from_id</span><span class=p>,</span> <span class=n>to_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>accounts</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>([</span><span class=n>from_id</span><span class=p>,</span> <span class=n>to_id</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>acquire_lock</span><span class=p>(</span><span class=n>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=ow>and</span> <span class=n>acquire_lock</span><span class=p>(</span><span class=n>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 실제 금액 이체</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>release_lock</span><span class=p>(</span><span class=n>accounts</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>release_lock</span><span class=p>(</span><span class=n>accounts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;락 획득 실패 또는 Timeout&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h6 id=성과-및-결과-1>성과 및 결과<a hidden class=anchor aria-hidden=true href=#성과-및-결과-1>#</a></h6><ul><li>Deadlock/Timeout 비율 감소</li><li>실시간 처리량 향상 (Throughput +20%)</li><li>장애복구, 오류 감소</li></ul><h6 id=교훈-및-시사점-1>교훈 및 시사점<a hidden class=anchor aria-hidden=true href=#교훈-및-시사점-1>#</a></h6><ul><li>락 순서화, 락 Duration 모니터링, 분산 락 활용이 병렬 처리와 일관성 간 최적 Trade-off</li><li>Whatap·Prometheus 등 실시간 모니터링은 장애 예방과 운영의 핵심</li></ul><h4 id=락-duration-최적화를-위한-전술지도>락 Duration 최적화를 위한 전술지도<a hidden class=anchor aria-hidden=true href=#락-duration-최적화를-위한-전술지도>#</a></h4><ul><li>락을 오래 쥐면 안전하지만 느려진다. <strong>DB 내부 최적화</strong>(인덱스·버퍼·WAL) 로 <strong>필요 시간 자체를 줄이고</strong>, <strong>외부 연계</strong>(캐시·이벤트·분산 합의) 로 <strong>DB 에 걸리는 락 의존을 낮춘다</strong>.</li><li>마지막으로 <strong>관측·알림·자가복구</strong>를 붙여 테일 지연·데드락을 <strong>자동 억제</strong>한다.</li></ul><h5 id=락-duration-통합연계-청사진>락 Duration 통합·연계 청사진<a hidden class=anchor aria-hidden=true href=#락-duration-통합연계-청사진>#</a></h5><ul><li><strong>왜</strong>: 락 보유 시간이 길면 대기 폭증·처리량 저하·테일 지연 증가.</li><li><strong>무엇</strong>: DB 내부 (트랜잭션, 인덱스, 버퍼, WAL) 와 외부 (분산 합의/락, 캐시, 이벤트, 관측) 의 <strong>교차 지점</strong>.</li><li><strong>어떻게</strong>: 경계 일치, 단위 축소, 히트율 상승, 플러시 타이밍 조정, RTT 최소화, 읽기 분리, 비동기화, 자동알림·자가복구.</li><li><strong>가치</strong>: <strong>P99 지연 하락</strong>, <strong>TPS/QPS 상승</strong>, <strong>데드락·타임아웃 감소</strong>, <strong>SLA 안정화</strong>.</li></ul><table><thead><tr><th>통합 대상</th><th>왜 (문제)</th><th>무엇을 통합</th><th>어떻게 (핵심 액션)</th><th>획득 가치</th><th>핵심 지표</th></tr></thead><tbody><tr><td>트랜잭션 경계</td><td>경계 불일치로 보유시간↑</td><td>TX Manager</td><td>TX 타임아웃, 커밋/롤백 시 자동 해제, 격리수준 - 보유정책 맵핑</td><td>보유시간 단축/예측성↑</td><td>P95/99 Lock Wait, TX Timeout</td></tr><tr><td>인덱스/락 단위</td><td>넓은 범위락·스캔</td><td>Indexer</td><td>고선택성 인덱스, 커버링 인덱스, 범위 잠금 최소화</td><td>경합↓/보유시간↓</td><td>Range Lock Count, Scan Time</td></tr><tr><td>버퍼 풀</td><td>페이지 미스→I/O 대기</td><td>Buffer Pool</td><td>핫 페이지 핀·프리로딩, 워킹셋 맞춤 크기</td><td>대기↓/보유시간↓</td><td>Cache Hit%, Page Miss Lat.</td></tr><tr><td>로그/WAL</td><td>플러시 지연</td><td>WAL/Checkpoint</td><td>그룹커밋, 체크포인트 주기 최적화</td><td>커밋 지연↓</td><td>WAL Flush Lat., Dirty%</td></tr><tr><td>분산 합의/락</td><td>RTT·분리 내성 이슈</td><td>Raft/Paxos/Redis</td><td>리더 지역화, 로컬 TX 우선, 분산 락은 <strong>업무 단위</strong>에 한정</td><td>보류 최소화/일관성</td><td>RTT, Consensus Lat., Lock TTL</td></tr><tr><td>캐시·일관성</td><td>캐시 -DB 불일치</td><td>Cache Layer</td><td>Write-through/Invalidate, TTL/버전, 읽기 분리</td><td>DB 락 의존↓</td><td>Inval. Lat., Cache Hit%</td></tr><tr><td>이벤트/아웃박스</td><td>동기 처리로 보유↑</td><td>Outbox/Event Bus</td><td><strong>커밋 후</strong> 비동기 발행, 재시도/멱등</td><td>경합 분산·보유시간↓</td><td>Outbox Lag, Retry Rate</td></tr><tr><td>관측/알림/SRE</td><td>늦은 감지</td><td>Prom/Whatap/Runbook</td><td>락 지속시간·데드락률 경보, 자동 Kill/Retry</td><td>SLA 보호</td><td>Lock Hold P99, Deadlock/s</td></tr></tbody></table><h5 id=duration-연계의-4-대-축>Duration 연계의 4 대 축<a hidden class=anchor aria-hidden=true href=#duration-연계의-4-대-축>#</a></h5><h6 id=a-db-내부-경로-통합>A. DB 내부 경로 통합<a hidden class=anchor aria-hidden=true href=#a-db-내부-경로-통합>#</a></h6><p>락 보유 시간을 <strong>내부에서 직접</strong> 줄이는 레이어. 인덱스/버퍼/WAL/경계가 맞물릴수록 보유시간은 자연스럽게 짧아진다.</p><table><thead><tr><th>항목</th><th>핵심 레버</th><th>기대 효과</th><th>지표</th></tr></thead><tbody><tr><td>트랜잭션 경계</td><td>타임아웃, 경계 일치</td><td>P99 대기↓</td><td>Lock Wait P99</td></tr><tr><td>인덱스</td><td>선택성↑, 커버링</td><td>스캔 단축</td><td>Range Lock Count</td></tr><tr><td>버퍼 풀</td><td>히트율↑, 프리로딩</td><td>I/O 대기↓</td><td>Cache Hit%</td></tr><tr><td>WAL/체크포인트</td><td>그룹커밋, 주기 최적화</td><td>커밋 지연↓</td><td>WAL Lat., Dirty%</td></tr></tbody></table><ul><li><strong>요약</strong>: 내부 경로를 맞추면 <strong>락을 오래 쥐어야 할 이유</strong>가 빠르게 사라진다.</li></ul><h6 id=b-분산-합의분산-락-연계>B. 분산 합의·분산 락 연계<a hidden class=anchor aria-hidden=true href=#b-분산-합의분산-락-연계>#</a></h6><p>락 보유에 <strong>네트워크 왕복</strong>이 개입되는 영역. 리더 지역화와 로컬 TX 우선이 핵심이다.</p><table><thead><tr><th>항목</th><th>핵심 레버</th><th>기대 효과</th><th>지표</th></tr></thead><tbody><tr><td>합의 (raft/paxos)</td><td>리더 지역화/로컬 우선</td><td>RTT↓</td><td>Consensus Lat.</td></tr><tr><td>분산 락</td><td>업무단위 한정/TTL</td><td>교착/오버홀드↓</td><td>Lock TTL Expiry</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>리더 가까이에서 쓰고</strong>, 분산 락은 <strong>업무 수준 보호</strong>로만 쓴다.</li></ul><h6 id=c-캐시이벤트-아키텍처-연계>C. 캐시·이벤트 아키텍처 연계<a hidden class=anchor aria-hidden=true href=#c-캐시이벤트-아키텍처-연계>#</a></h6><p><strong>읽기를 분리</strong>하고 <strong>부수 작업을 비동기화</strong>해서 DB 락 의존을 줄인다.</p><table><thead><tr><th>항목</th><th>핵심 레버</th><th>기대 효과</th><th>지표</th></tr></thead><tbody><tr><td>캐시 일관성</td><td>Write-through/Invalidate</td><td>읽기 경합↓</td><td>Cache Hit%, Inval. Lat.</td></tr><tr><td>이벤트/아웃박스</td><td>커밋 후 발행, 멱등</td><td>경합 분산</td><td>Outbox Lag</td></tr></tbody></table><ul><li><strong>요약</strong>: 캐시로 <strong>읽기 부담 분산</strong>, 아웃박스로 <strong>사이드이펙트 분리</strong>.</li></ul><h6 id=d-관측알림자가복구-sre>D. 관측·알림·자가복구 (SRE)<a hidden class=anchor aria-hidden=true href=#d-관측알림자가복구-sre>#</a></h6><p><strong>늦기 전에 자동 개입</strong>해 테일 지연과 장애를 누른다.</p><table><thead><tr><th>항목</th><th>핵심 레버</th><th>기대 효과</th><th>지표</th></tr></thead><tbody><tr><td>모니터링</td><td>Prom/Whatap</td><td>이상 조기탐지</td><td>Lock Hold P99</td></tr><tr><td>자동화</td><td>Runbook/오토리미디에이션</td><td>SLA 보호</td><td>Deadlock/s, Kill Count</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>보유시간과 데드락 지표</strong>를 경보로 묶고, <strong>자동 조치</strong>로 닫는다.</li></ul><h5 id=락-duration-통합-한눈표>락 Duration 통합 한눈표<a hidden class=anchor aria-hidden=true href=#락-duration-통합-한눈표>#</a></h5><table><thead><tr><th>카테고리</th><th>주요 대상</th><th>왜 (문제)</th><th>핵심 레버</th><th>획득 가치</th><th>대표 지표</th></tr></thead><tbody><tr><td>A DB 내부</td><td>TX/Index/Buffer/WAL</td><td>스캔·I/O·플러시 지연</td><td>경계 일치·선택성↑·히트율↑·그룹커밋</td><td>보유시간↓·P99↓</td><td>Lock Wait P99, Hit%</td></tr><tr><td>B 분산</td><td>Raft/Paxos/Redis</td><td>RTT·분리 내성</td><td>리더 지역화·로컬 우선·TTL</td><td>대기↓·교착↓</td><td>Consensus Lat., TTL</td></tr><tr><td>C 캐시/이벤트</td><td>Cache/Outbox</td><td>읽기 경합·동기 처리</td><td>Invalidate/Write-through·커밋후 발행</td><td>경합 분산·처리량↑</td><td>Hit%, Inval. Lat., Outbox Lag</td></tr><tr><td>D 관측/SRE</td><td>Prom/Whatap/Runbook</td><td>늦은 감지·수동 대응</td><td>경보·오토리미디에이션</td><td>SLA 안정</td><td>Deadlock/s, Kill/Retry</td></tr></tbody></table><h3 id=운영-및-최적화>운영 및 최적화<a hidden class=anchor aria-hidden=true href=#운영-및-최적화>#</a></h3><h4 id=락-관측의-지표원천자동화-설계>락 관측의 지표·원천·자동화 설계<a hidden class=anchor aria-hidden=true href=#락-관측의-지표원천자동화-설계>#</a></h4><p>락 문제는 대개 **" 오래 기다린다 &ldquo;**에서 출발한다.<br>그래서 <strong>대기·보유의 분포</strong>(특히 P95/P99), <strong>데드락/타임아웃</strong>, <strong>Hot 리소스</strong>만 잘 보면 절반은 해결된다.<br>이 지표들을 <strong>엔진 뷰/DMV</strong>에서 모아 <strong>대시보드·경보</strong>로 묶고, 초과 시 <strong>자동 조치</strong>(Kill/Retry/라우팅 전환) 까지 연결하면 운영이 안정된다.</p><h5 id=락-모니터링-지표원천자동화>락 모니터링: 지표·원천·자동화<a hidden class=anchor aria-hidden=true href=#락-모니터링-지표원천자동화>#</a></h5><ul><li><p><strong>무엇 (지표)</strong></p><ol><li><strong>락 대기시간</strong>(평균·P95/P99): 큐 체류로 인한 테일 지연 파악</li><li><strong>락 보유시간 분포</strong>: 오래 쥐는 세션 탐지 (Strict 경향·롱 트랜잭션)</li><li><strong>데드락/타임아웃률</strong>: 치명 이벤트 감지·근본 원인 식별</li><li><strong>경합률/락 처리량</strong>: 충돌 정도와 처리 속도 균형</li><li><strong>Hot Row/Table 랭킹</strong>: 핫스팟 파악·재파티셔닝 근거</li><li><strong>리소스 지표</strong>: Lock Entry 수/메모리, Wait Queue 길이, WAL Flush 지연, Replica Lag</li></ol></li><li><p><strong>왜 (의미/가치)</strong></p><ul><li>대기/보유 <strong>분포의 꼬리</strong>(P95/P99) 가 사용자 경험·SLA 를 좌우한다.</li><li>데드락/타임아웃은 <strong>즉시 개입 신호</strong>이며, Hot 리소스는 <strong>설계 개선 포인트</strong>다.</li></ul></li><li><p><strong>어떻게 (수집/경보/대시보드/자동화)</strong></p><ul><li><strong>수집</strong>: 엔진 뷰/DMV 정기 스크레이프 + 에이전트 (Whatap/Prometheus Exporter) + 데드락/타임아웃 이벤트 훅.</li><li><strong>경보</strong>: P95 대기시간, 데드락/s, 타임아웃률, Lock Table 메모리 임계, WFG 사이클 검출 시 알림.</li><li><strong>대시보드</strong>: " 대기·보유 히트맵 &ldquo;, &ldquo;Hot Top-N&rdquo;, " 데드락/타임아웃 타임라인 &ldquo;, &ldquo;WAL/Replica 지연 " 패널.</li><li><strong>자동화</strong>: 임계 초과 시 세션 Kill/Retry, 쿼리 라우팅 전환 (리플리카/시간대), 에스컬레이션 임계 자동 튜닝.</li></ul></li></ul><h5 id=모니터링-항목-요약>모니터링 항목 요약<a hidden class=anchor aria-hidden=true href=#모니터링-항목-요약>#</a></h5><table><thead><tr><th>분류</th><th>관측 항목</th><th>왜 (의미)</th><th>데이터 소스 (예)</th><th>경보 기준 (예시)</th><th>대응/자동화</th></tr></thead><tbody><tr><td>지연</td><td>락 대기시간 Avg/P95/P99</td><td>테일 지연·체감 성능</td><td><code>pg_locks</code>+<code>pg_stat_activity</code>, <code>data_lock_waits</code></td><td>P95>1s(3m)</td><td>핫스팟 격리/쿼리 플랜 점검</td></tr><tr><td>보유</td><td>락 보유시간 분포</td><td>롱 TX/Strict 경향 탐지</td><td>엔진 DMV+ 세션 이벤트</td><td>P95>5s(5m)</td><td>세션 Kill/Retry, 코드 경계 단축</td></tr><tr><td>안정</td><td>데드락/타임아웃률</td><td>치명 이벤트</td><td>엔진 이벤트/로그</td><td>Deadlock>3/min</td><td>재시도 백오프/락 순서화 점검</td></tr><tr><td>경합</td><td>경합률/처리량</td><td>스케줄러 혼잡</td><td>Exporter Counter</td><td>경합>0.6(2m)</td><td>인덱스/파티션/임계 튜닝</td></tr><tr><td>핫스팟</td><td>Hot Row/Table Top-N</td><td>설계 개선 포인트</td><td>쿼리 샘플 +DMV</td><td>상위 N 지속>10m</td><td>리파티셔닝/쿼리 재작성</td></tr><tr><td>리소스</td><td>Lock Entry/메모리/큐 길이</td><td>상태 용량 한계</td><td>Lock Table/Exporter</td><td>메모리>1GB</td><td>에스컬레이션/임계 조정</td></tr><tr><td>로그</td><td>WAL Flush/Replica Lag</td><td>커밋·읽기 지연</td><td>WAL/Replica 지표</td><td>Flush>50ms</td><td>그룹커밋/창 분리</td></tr></tbody></table><h5 id=락-관측의-4-단-분류-체계>락 관측의 4 단 분류 체계<a hidden class=anchor aria-hidden=true href=#락-관측의-4-단-분류-체계>#</a></h5><h6 id=a-지표sli>A. 지표·SLI<a hidden class=anchor aria-hidden=true href=#a-지표sli>#</a></h6><ul><li><strong>내용</strong>: 대기/보유 분포, 데드락/타임아웃, 경합·처리량, Hot Top-N, Lock Table 용량.</li><li><strong>핵심</strong>: P95/P99 테일·Hot 리소스가 우선순위 최상.</li></ul><table><thead><tr><th>지표</th><th>정의</th><th>목적</th><th>권장 범위 (예)</th></tr></thead><tbody><tr><td>Lock Wait P95</td><td>요청→획득 95% 지연</td><td>테일 관리</td><td>&lt; 1s</td></tr><tr><td>Hold Time P95</td><td>획득→해제 95% 지연</td><td>롱 TX 탐지</td><td>&lt; 5s</td></tr><tr><td>Deadlocks/min</td><td>분당 데드락</td><td>안정성</td><td>0–3</td></tr><tr><td>Timeout Rate</td><td>타임아웃 비율</td><td>혼잡 감지</td><td>&lt; 1%</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>테일 지표와 치명 이벤트</strong>를 먼저 본다.</li></ul><h6 id=b-데이터-소스수집>B. 데이터 소스·수집<a hidden class=anchor aria-hidden=true href=#b-데이터-소스수집>#</a></h6><ul><li><strong>내용</strong>: <code>pg_locks</code>, <code>pg_stat_activity</code>, MySQL <code>performance_schema.data_locks/data_lock_waits</code>, SQL Server <code>sys.dm_tran_locks</code>, Oracle <code>V$LOCK</code> 등.</li><li><strong>핵심</strong>: 샘플링 (저부하) + 이벤트 훅 (정확) <strong>혼합</strong>.</li></ul><table><thead><tr><th>소스</th><th>플랫폼</th><th>장점</th><th>유의점</th></tr></thead><tbody><tr><td><code>pg_locks</code>+<code>pg_stat_activity</code></td><td>PostgreSQL</td><td>세션/락 매핑 용이</td><td>조인 비용</td></tr><tr><td><code>performance_schema.*</code></td><td>MySQL/InnoDB</td><td>대기 원인 상세</td><td>설정 필요</td></tr><tr><td><code>sys.dm_tran_*</code></td><td>SQL Server</td><td>풍부한 DMV</td><td>권한 요구</td></tr><tr><td><code>V$LOCK</code></td><td>Oracle</td><td>내부 상태 접근</td><td>해석 복잡</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>DMV+ 이벤트</strong> 이중 채널이 가장 실용적이다.</li></ul><h6 id=c-시각화대시보드>C. 시각화·대시보드<a hidden class=anchor aria-hidden=true href=#c-시각화대시보드>#</a></h6><ul><li><strong>내용</strong>: 히트맵 (대기·보유 분포), 타임라인 (데드락/타임아웃), Top-N(Hot), 게이지 (Lock Table 메모리), WAL/Replica 지연.</li><li><strong>핵심</strong>: &ldquo;<strong>문제 재현 없이도 흔적을 본다</strong>&rdquo; 가 목표.</li></ul><table><thead><tr><th>패널</th><th>설명</th><th>왜 유용한가</th></tr></thead><tbody><tr><td>Wait Heatmap</td><td>대기 분포 시간대별</td><td>피크/패턴 파악</td></tr><tr><td>Hold Histogram</td><td>보유 분포</td><td>롱 TX 식별</td></tr><tr><td>Top-N Hot</td><td>리소스 랭킹</td><td>리팩터링 대상</td></tr><tr><td>WAL/Replica</td><td>커밋·읽기 지연</td><td>시스템 병목 연계</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>분포와 Top-N</strong> 중심이면 실전성이 높다.</li></ul><h6 id=d-경보자동화>D. 경보·자동화<a hidden class=anchor aria-hidden=true href=#d-경보자동화>#</a></h6><ul><li><strong>내용</strong>: 임계 초과 시 경보→런북 자동 실행 (세션 Kill/Retry/라우팅).</li><li><strong>핵심</strong>: 빠른 <strong>격리·복구</strong>가 SLA 를 지킨다.</li></ul><table><thead><tr><th>트리거</th><th>조건 (예)</th><th>자동화</th></tr></thead><tbody><tr><td>High Wait P95</td><td>>1s 3 분 지속</td><td>핫 테이블 격리 쿼리 라우팅</td></tr><tr><td>Deadlock Spike</td><td>>3/min</td><td>재시도 + 백오프, TX 순서화 점검</td></tr><tr><td>Lock Memory High</td><td>>1GB 5 분</td><td>에스컬레이션 임계 상향</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>경보→즉시 조치</strong> 흐름을 표준화한다.</li></ul><h5 id=락-관측-운영-한눈-통합표>락 관측 운영 한눈 통합표<a hidden class=anchor aria-hidden=true href=#락-관측-운영-한눈-통합표>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 내용</th><th>주요 지표/소스</th><th>경보 트리거</th><th>대표 자동화</th></tr></thead><tbody><tr><td>A 지표·SLI</td><td>대기/보유 분포, 데드락/타임아웃, Hot</td><td>Wait/Hold P95, Deadlocks/min, Top-N</td><td>P95>1s, Deadlock Spike</td><td>핫스팟 격리</td></tr><tr><td>B 소스·수집</td><td>DMV+ 이벤트 훅, Exporter</td><td><code>pg_locks</code>, <code>data_locks</code>, <code>V$LOCK</code></td><td>수집 실패/지연</td><td>수집 주기 보정</td></tr><tr><td>C 시각화</td><td>히트맵/히스토그램/Top-N</td><td>대시보드 패널</td><td>급격한 분포 변화</td><td>문제 구간 핀다운</td></tr><tr><td>D 경보·자동화</td><td>임계치 경보→오토 리미디에이션</td><td>Alertmanager/Whatap</td><td>Tail 지속/메모리 초과</td><td>Kill/Retry/라우팅</td></tr></tbody></table><h4 id=락-보안준수-통제부터-증빙까지>락 보안·준수: 통제부터 증빙까지<a hidden class=anchor aria-hidden=true href=#락-보안준수-통제부터-증빙까지>#</a></h4><p>락은 데이터 무결성과 가용성에 직접 영향을 준다.<br>그래서 락 상태·대기열 같은 내부 정보는 암호화·마스킹으로 보호하고, 락 API 는 역할/속성 기반으로 허가된 주체만 쓰게 한다.<br>분산 락은 TLS/mTLS·요청 서명으로 위변조와 재전송을 막고, 임대시간을 짧게 잡아 과도 보유를 피한다.<br>모든 락 이벤트는 불변 감사 로그에 남겨 누가·무엇을·언제·왜 했는지 추적 가능해야 하며, 타임아웃·레이트 리밋·공정 큐로 대기 폭주와 장수 트랜잭션을 억제한다.<br>규정 (SOX/GDPR/HIPAA/PCI 등) 은 이 통제들을 요구하며, 각 통제는 락 지속시간의 상한을 관리하고 SLO 를 지키는 데도 기여한다.</p><h5 id=락-지속시간-보안규정-충족-체계>락 지속시간 보안·규정 충족 체계<a hidden class=anchor aria-hidden=true href=#락-지속시간-보안규정-충족-체계>#</a></h5><table><thead><tr><th>영역</th><th>무엇 (대상)</th><th>왜 (위험·요구)</th><th>어떻게 (통제·구현)</th><th>증거/점검</th><th>Lock Duration 연계</th></tr></thead><tbody><tr><td>데이터 보호</td><td>락 테이블·대기큐·WFG</td><td>내부 구조·거래 패턴 노출</td><td>암호화 (At-rest/At-transit), 마스킹/가명화, KMS/HSM 키 순환</td><td>암호화 정책·키 사용 로그</td><td>메타데이터 최소화로 기록량↓·보유기간 관리</td></tr><tr><td>접근 통제</td><td>락 조회·획득·해제 API</td><td>특권 남용·우회</td><td>RBAC/ABAC/SoD, 승격 승인, 세분 권한 (<code>lock:read/acquire/release</code>)</td><td>권한 매트릭스·승인 이력</td><td>특권 접근은 더 짧은 타임아웃/감사 강화</td></tr><tr><td>통신 보안</td><td>분산 락 (리더·팔로워)</td><td>MITM·리플레이</td><td>TLS/mTLS, 요청 서명/논스, 짧은 임대 (lease)·TTL</td><td>인증서 수명·서명 검증 로그</td><td>짧은 lease 가 과도 보유 방지·회복성↑</td></tr><tr><td>감사·추적</td><td>누가/무엇/언제/왜</td><td>포렌식·법정감사</td><td>불변 로그 (WORM)·해시체인·시그닝, 상관 ID</td><td>변경불가성 검증·시계 동기화</td><td>지속시간 초과·장수 Tx 경보·조치 근거</td></tr><tr><td>운영 통제</td><td>장수 Tx·대기 폭주</td><td>가용성·SLO 위반</td><td>타임아웃·NOWAIT·레이트 리밋·쿼터, 공정 큐</td><td>P95/P99·대기큐 길이 모니터링</td><td>과보유 억제→체감 지속시간 안정화</td></tr><tr><td>테넌트 격리</td><td>멀티테넌트 네임스페이스</td><td>데이터 경로 교차</td><td>네임스페이스 분리·리소스 한도·속성 기반 정책</td><td>테넌트별 스코프 점검</td><td>테넌트별 타임아웃·쿼터 차등 적용</td></tr></tbody></table><h5 id=여섯-축으로-보는-락-보안>여섯 축으로 보는 락 보안<a hidden class=anchor aria-hidden=true href=#여섯-축으로-보는-락-보안>#</a></h5><h6 id=a-데이터-보호>A. 데이터 보호<a hidden class=anchor aria-hidden=true href=#a-데이터-보호>#</a></h6><p>민감 메타데이터 (계정 ID·리소스 키·시간) 는 최소 수집·암호화. KMS/HSM 으로 키 순환.</p><table><thead><tr><th>통제</th><th>구현</th><th>점검</th></tr></thead><tbody><tr><td>암호화</td><td>AES-256 at-rest, TLS in-transit</td><td>키 만료·회전 주기</td></tr><tr><td>최소화</td><td>PII 가명화/마스킹</td><td>필드 데이터 카탈로그</td></tr><tr><td>보유기간</td><td>규정·SLO 기반 보존·파기</td><td>파기 감사 로그</td></tr></tbody></table><p>민감도를 낮추고 암호화·보존 통제로 노출 위험과 법적 리스크를 동시에 감소.</p><h6 id=b-접근-통제>B. 접근 통제<a hidden class=anchor aria-hidden=true href=#b-접근-통제>#</a></h6><p>RBAC/ABAC·SoD 로 락 읽기/획득/해제 권한을 분리, 승격 승인 필요.</p><table><thead><tr><th>통제</th><th>구현</th><th>점검</th></tr></thead><tbody><tr><td>역할 기반</td><td><code>lock:read/acquire/release</code></td><td>권한 리뷰 주기</td></tr><tr><td>속성 기반</td><td>테넌트·리소스 태그 조건</td><td>정책 시뮬레이션</td></tr><tr><td>분리 (SoD)</td><td>운영/개발/보안 분리</td><td>위임·감사 이력</td></tr></tbody></table><p>세분 권한과 분리 원칙이 특권 남용을 줄이고 사고 범위를 제한.</p><h6 id=c-통신분산-보안>C. 통신·분산 보안<a hidden class=anchor aria-hidden=true href=#c-통신분산-보안>#</a></h6><p>mTLS·요청 서명·논스·짧은 lease 로 위변조/리플레이·과보유를 방지.</p><table><thead><tr><th>통제</th><th>구현</th><th>점검</th></tr></thead><tbody><tr><td>mTLS</td><td>짧은 수명 인증서</td><td>만료율·회전 실패</td></tr><tr><td>서명/논스</td><td>HMAC/nonce·리플레이 차단</td><td>실패율·재전송율</td></tr><tr><td>lease/TTL</td><td>임대·세션 갱신</td><td>과보유 경보</td></tr></tbody></table><p>강한 상호 인증과 짧은 임대가 보안성과 가용성을 동시에 높인다.</p><hr><h6 id=d-감사보관>D. 감사·보관<a hidden class=anchor aria-hidden=true href=#d-감사보관>#</a></h6><p>불변 감사 로그, 해시체인, 시계 동기화, 법정 보관기간·삭제 증적.</p><table><thead><tr><th>통제</th><th>구현</th><th>점검</th></tr></thead><tbody><tr><td>불변성</td><td>WORM/서명·해시체인</td><td>변조 탐지</td></tr><tr><td>필드</td><td>누가/무엇/언제/왜/전후 상태</td><td>누락율</td></tr><tr><td>보관·삭제</td><td>보관기간·법적 보류</td><td>삭제 증적</td></tr></tbody></table><p>추적 가능한 로그는 포렌식과 규정 준수의 핵심 근거다.</p><h6 id=e-규정-매핑>E. 규정 매핑<a hidden class=anchor aria-hidden=true href=#e-규정-매핑>#</a></h6><p>SOX/GDPR/HIPAA/PCI/ISO/SOC2 요구를 통제에 매핑.</p><table><thead><tr><th>규정</th><th>핵심 요구</th><th>통제 매핑</th></tr></thead><tbody><tr><td>SOX</td><td>내부통제·추적성</td><td>불변 로그·SoD</td></tr><tr><td>GDPR</td><td>최소화·보호·삭제권</td><td>데이터 최소화·암호화·삭제 증적</td></tr><tr><td>HIPAA</td><td>접근 통제·감사</td><td>RBAC·감사 로그</td></tr><tr><td>PCI DSS</td><td>카드 데이터 보호</td><td>네트워크 분리·추가 인증</td></tr><tr><td>ISO 27001/SOC 2</td><td>체계적 보안</td><td>정책·위험평가·모니터링</td></tr></tbody></table><p>규정은 통제의 방향성을 제공하고, 통제는 락 운영의 증빙 수단이 된다.</p><h6 id=f-운영-안정화>F. 운영 안정화<a hidden class=anchor aria-hidden=true href=#f-운영-안정화>#</a></h6><p>타임아웃·NOWAIT·레이트 리밋·공정 큐·장수 Tx 킬 스위치.</p><table><thead><tr><th>통제</th><th>구현</th><th>점검</th></tr></thead><tbody><tr><td>타임아웃</td><td>lock/stmt timeout</td><td>초과율·P99</td></tr><tr><td>NOWAIT</td><td>즉시 실패·백오프</td><td>재시도율</td></tr><tr><td>레이트 리밋</td><td>사용자/테넌트 쿼터</td><td>제한 빈도</td></tr><tr><td>킬 스위치</td><td>장수 Tx 자동 중단</td><td>피해 최소화 시간</td></tr></tbody></table><p>혼잡 제어는 체감 지속시간을 안정화하고 DoS 성 락 오남용을 막는다.</p><h5 id=락-보안준수-통합-매트릭스>락 보안·준수 통합 매트릭스<a hidden class=anchor aria-hidden=true href=#락-보안준수-통합-매트릭스>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 통제</th><th>대표 구현</th><th>핵심 지표</th><th>규정 연계</th><th>지속시간 효과</th></tr></thead><tbody><tr><td>A 데이터 보호</td><td>암호화·최소화·보유관리</td><td>KMS/HSM·마스킹·WORM</td><td>키 회전·파기율</td><td>GDPR/ISO</td><td>정보 노출↓·로그 축소</td></tr><tr><td>B 접근 통제</td><td>RBAC/ABAC/SoD</td><td>세분 권한·승격 승인</td><td>권한 변경·오남용 탐지</td><td>SOX/HIPAA</td><td>특권 오남용↓</td></tr><tr><td>C 통신·분산</td><td>mTLS·서명·논스·lease</td><td>단기 인증서·TTL</td><td>재전송/리플레이율</td><td>PCI/ISO</td><td>과보유↓·복구성↑</td></tr><tr><td>D 감사·보관</td><td>불변 로그·해시체인</td><td>시그닝·시계동기화</td><td>변조 탐지·누락율</td><td>SOX/SOC2</td><td>원인 규명·책임성↑</td></tr><tr><td>E 규정 매핑</td><td>요구→통제 사상</td><td>컨트롤 매트릭스</td><td>감사 적합도</td><td>전 규정</td><td>갭 식별·보완</td></tr><tr><td>F 운영 안정화</td><td>타임아웃·NOWAIT·레이트 리밋</td><td>공정 큐·장수 Tx 정리</td><td>P95/P99·큐 길이</td><td>SLO·SOC2</td><td>체감 지속시간 안정화</td></tr></tbody></table><h4 id=락-지속시간-성능확장-실전-전략>락 지속시간 성능·확장 실전 전략<a hidden class=anchor aria-hidden=true href=#락-지속시간-성능확장-실전-전략>#</a></h4><ul><li><strong>락 지속시간</strong>은 " 얼마나 오래, 얼마나 많이, 얼마나 자주 막느냐 " 의 문제다.</li><li>먼저 <strong>쿼리/인덱스</strong>로 <strong>충돌 후보 자체</strong>를 줄이고, <strong>트랜잭션 경계</strong>를 다듬어 <strong>보유시간</strong>을 줄인다.</li><li>그다음 <strong>엔진 기능</strong>으로 <strong>대기 방식</strong>을 개선하고, 남은 핫스팟은 <strong>파티셔닝/샤딩</strong>으로 분리한다.</li><li>마지막으로 <strong>지표 - 알고리즘 - 스케줄</strong>로 <strong>자동 조정 루프</strong>를 돌리면, 성능과 확장성의 균형점을 장기적으로 유지할 수 있다.</li></ul><h5 id=기능별-성능확장-분류-체계>기능별 성능·확장 분류 체계<a hidden class=anchor aria-hidden=true href=#기능별-성능확장-분류-체계>#</a></h5><p><strong>성능 최적화</strong>:</p><ul><li><strong>무엇</strong>: 획득/대기/보유 구간을 줄인다.</li><li><strong>왜</strong>: TPS↑, 지연↓, 데드락↓.</li><li><strong>어떻게</strong>: 인덱스·프레디킷 정제, 트랜잭션 경계 재설계, 업그레이드 제거, 엔진 기능 (NOWAIT/타임아웃/스냅샷 읽기) 사용.</li></ul><p><strong>확장성</strong>:</p><ul><li><strong>무엇</strong>: 경합 자체를 분리/분산한다.</li><li><strong>왜</strong>: 단일 리소스 핫스팟 제거로 선형 확장에 근접.</li><li><strong>어떻게</strong>: 파티셔닝·샤딩, 일관 해싱, 읽기 리플리카, 지역성 라우팅, 배치·큐잉으로 실시간 경합 완화.</li></ul><h6 id=a-충돌-집합-축소-쿼리스키마>A. 충돌 집합 축소 (쿼리·스키마)<a hidden class=anchor aria-hidden=true href=#a-충돌-집합-축소-쿼리스키마>#</a></h6><ul><li>핵심: " 잠그기 전에 <strong>덜 건드리기</strong>&rdquo;. 선택도 높은 조건, 커버링 인덱스, 조인 순서/드라이빙 테이블 고정, 쓰기 키 분산.</li></ul><table><thead><tr><th>전술</th><th>적용 대상</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>커버링 인덱스</td><td>읽기 중심 쿼리</td><td>스캔→인덱스만 조회, 대기↓</td><td>쓰기 비용↑, 저장공간↑</td></tr><tr><td>선택도 향상</td><td>필터/조인</td><td>충돌 후보 감소</td><td>통계 최신화 필수</td></tr><tr><td>키 분산</td><td>쓰기 핫키</td><td>핫스팟 완화</td><td>순서 보존 요구 시 별도 설계</td></tr></tbody></table><ul><li><strong>요약</strong>: 후보를 줄이면 <strong>대기와 차단폭이 동시 감소</strong>한다.</li></ul><h6 id=b-보유시간-단축-트랜잭션락-전략>B. 보유시간 단축 (트랜잭션·락 전략)<a hidden class=anchor aria-hidden=true href=#b-보유시간-단축-트랜잭션락-전략>#</a></h6><ul><li>핵심: &ldquo;<strong>늦게 확보, 빨리 해제</strong>&rdquo; 와 <strong>업그레이드 회피</strong>(U/SIX/초기 X).</li></ul><table><thead><tr><th>전술</th><th>적용 대상</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>늦게 확보</td><td>갱신 직전</td><td>보유시간↓</td><td>로직 재배치 필요</td></tr><tr><td>빨리 해제</td><td>비핵심 리소스</td><td>동시성↑</td><td>Strict 2PL 제약 고려</td></tr><tr><td>업그레이드 회피</td><td><code>S→X</code> 경로</td><td>데드락↓</td><td>초기 X 로 과잠금 위험</td></tr></tbody></table><ul><li><strong>요약</strong>: 보유 창을 줄이면 <strong>TPS·지연</strong>이 가장 즉시 개선된다.</li></ul><h6 id=c-대기차단폭-축소-엔진-기능>C. 대기·차단폭 축소 (엔진 기능)<a hidden class=anchor aria-hidden=true href=#c-대기차단폭-축소-엔진-기능>#</a></h6><ul><li>핵심: &ldquo;<strong>막느니 피하거나 짧게 기다리기</strong>&rdquo;. <code>NOWAIT/SKIP LOCKED</code>, 타임아웃, 스냅샷 읽기, 재시도 백오프.</li></ul><table><thead><tr><th>전술</th><th>적용 대상</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>NOWAIT/NOWAIT 힌트</td><td>API/잡</td><td>즉시 실패→재시도</td><td>응용 레벨 보상 필요</td></tr><tr><td>SKIP LOCKED</td><td>큐 처리</td><td>홀드 회피</td><td>순서 보장과 상충 가능</td></tr><tr><td>타임아웃/백오프</td><td>혼잡 시</td><td>꼬리지연↓</td><td>과도 시 실패↑</td></tr></tbody></table><ul><li><strong>요약</strong>: 차단을 <strong>예측 가능한 대기·재시도</strong>로 바꾸면 꼬리지연이 줄어든다.</li></ul><h6 id=d-경합-분리분산-토폴로지>D. 경합 분리·분산 (토폴로지)<a hidden class=anchor aria-hidden=true href=#d-경합-분리분산-토폴로지>#</a></h6><ul><li>핵심: <strong>파티셔닝/샤딩</strong>, 읽기 리플리카, 지역성 라우팅으로 경쟁면을 나눈다.</li></ul><table><thead><tr><th>전술</th><th>적용 대상</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>파티셔닝/샤딩</td><td>대규모 테이블</td><td>선형 확장 근접</td><td>키 설계·재해복구 복잡</td></tr><tr><td>일관 해싱</td><td>분산 키</td><td>재밸런싱 비용↓</td><td>핫 파티션 가능성 상존</td></tr><tr><td>읽기 리플리카</td><td>읽기 집약</td><td>원본 경합↓</td><td>지연·일관성 관리 필요</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>면을 나누면</strong> 각 면의 락 지속시간도 자연히 짧아진다.</li></ul><h6 id=e-운영-자동화-지표스케줄알고리즘>E. 운영 자동화 (지표·스케줄·알고리즘)<a hidden class=anchor aria-hidden=true href=#e-운영-자동화-지표스케줄알고리즘>#</a></h6><ul><li>핵심: 지표 기반 <strong>적응형 파라미터</strong>(타임아웃·에스컬레이션), 피크/비피크 <strong>스케줄링</strong>.</li></ul><table><thead><tr><th>전술</th><th>적용 대상</th><th>효과</th><th>주의점</th></tr></thead><tbody><tr><td>적응형 타임아웃</td><td>혼잡/비혼잡</td><td>실패·대기 균형</td><td>튜닝 데이터 필요</td></tr><tr><td>에스컬 임계치 조정</td><td>대량 스캔</td><td>관리비↓/차단폭↑ 균형</td><td>단계적 실험 권장</td></tr><tr><td>스케줄링</td><td>배치/ETL</td><td>피크 충돌↓</td><td>운영 캘린더 관리</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>측정→조정</strong> 루프가 장기 안정성을 만든다.</li></ul><h5 id=성능확장-카테고리-종합표>성능·확장 카테고리 종합표<a hidden class=anchor aria-hidden=true href=#성능확장-카테고리-종합표>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 목표</th><th>대표 전술</th><th>기대 효과</th><th>리스크/주의</th></tr></thead><tbody><tr><td>A. 충돌 집합 축소</td><td>후보 줄이기</td><td>커버링 인덱스, 선택도 향상</td><td>대기·차단폭↓</td><td>인덱스 관리비↑</td></tr><tr><td>B. 보유시간 단축</td><td>락 창 줄이기</td><td>늦게 확보·빨리 해제, U/SIX/초기 X</td><td>TPS↑, 지연↓</td><td>과잠금/리팩터링 비용</td></tr><tr><td>C. 대기·차단폭 축소</td><td>예측가능 대기</td><td>NOWAIT/SKIP, 타임아웃, 백오프</td><td>꼬리지연↓</td><td>실패·재시도 증가</td></tr><tr><td>D. 경합 분리·분산</td><td>선형 확장</td><td>파티셔닝/샤딩, 읽기 리플리카</td><td>핫스팟 완화</td><td>키 설계·일관성 이슈</td></tr><tr><td>E. 운영 자동화</td><td>지속 최적</td><td>적응형 파라미터, 스케줄링</td><td>안정적 SLO</td><td>튜닝·운영 복잡성</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>A→B→C→D→E</strong> 순환으로 설계·운영하면, 락 지속시간이 자연스럽게 줄고 확장성은 단계적으로 상승한다.</li></ul><h4 id=락-지연교착을-줄이는-운영-청사진>락 지연·교착을 줄이는 운영 청사진<a hidden class=anchor aria-hidden=true href=#락-지연교착을-줄이는-운영-청사진>#</a></h4><p>증상은 단순하다.<br>응답이 늦고 대기가 길어지고 데드락이 뜬다.<br>원인은 보유시간이 길어졌기 때문.<br>해결은 세 가지로 요약된다.</p><ol><li>트랜잭션을 짧게</li><li>후보를 좁게</li><li>순서를 같게.</li></ol><p>여기에 타임아웃·재시도와 모니터링 (보유·대기·데드락 지표) 을 붙이면 대부분의 사고를 현장에서 바로 줄일 수 있다.</p><h5 id=락-지속시간-트러블슈팅-실행서>락 지속시간 트러블슈팅 실행서<a hidden class=anchor aria-hidden=true href=#락-지속시간-트러블슈팅-실행서>#</a></h5><table><thead><tr><th>문제군</th><th>왜 발생하는가 (원인)</th><th>무엇으로/어떻게 해결하는가 (핵심 절차)</th><th>즉시 점검 신호</th></tr></thead><tbody><tr><td>데드락</td><td>자원 순서 불일치, 긴 보유·교차 락</td><td>wait-for 그래프 사이클 탐지 → 피해자 선정 후 롤백, 자원 순서 표준화, 교차 자원 분해 (사가)</td><td>데드락/분 급증, 동일 리소스 상호 대기</td></tr><tr><td>장수 트랜잭션</td><td>Tx 내 사용자/원격 대기, 외부 I/O</td><td>외부 I/O 를 Tx 밖으로, 단일 목적 Tx, 타임아웃 상한 설정·경고</td><td>Idle in Tx, 보유시간 P95↑</td></tr><tr><td>락 경합·핫셋</td><td>인덱스 부재·풀스캔, 핫키 집중</td><td>커버링/선택도 인덱스, 범위 프루닝, 소배치 업데이트, 핫셋 분리</td><td>상위 충돌률↑, 에스컬레이션률↑</td></tr><tr><td>에스컬레이션 폭주</td><td>임계/예외 정책 부재</td><td>임계 (개수·시간) + 예외 테이블 (핫셋 승격 금지), 야간 승격</td><td>테이블 락 급증</td></tr><tr><td>FOR UPDATE 남발</td><td>대상 미확정 상태에서 선잠금</td><td>후보는 스냅샷으로 뽑고 " 확정 시점 " 에만 FOR UPDATE</td><td>X- 대기 편중</td></tr><tr><td>기아/우선순위 역전</td><td>고정 우선순위 큐 정책</td><td>노화 (aging)·우선순위 재가중, 공정 큐 (공유→독점 교대)</td><td>특정 세션 장대기</td></tr><tr><td>풀/세션 이슈</td><td>커넥션 풀 고갈 · 누수</td><td>풀 크기 상한/경고, 유휴 세션 정리, Tx 종료 강제</td><td>대기시간 분포 꼬리↑</td></tr><tr><td>분산·시계 이슈</td><td>2PC·샤드 교차, 시계 불일치</td><td>샤드 키 순서 고정, 크로스 - 샤드 분해, 타임아웃·클럭 동기</td><td>교차 대기 장기화</td></tr><tr><td>긴 스냅샷 읽기</td><td>MVCC 리더가 오래 버팀</td><td>리포트는 리플리카·스냅샷, 읽기 Tx 최대시간 제한</td><td>버전/GC 지연</td></tr></tbody></table><h5 id=트러블슈팅-5-대-카테고리-체계>트러블슈팅 5 대 카테고리 체계<a hidden class=anchor aria-hidden=true href=#트러블슈팅-5-대-카테고리-체계>#</a></h5><h6 id=a-애플리케이션-경계흐름-1>A. 애플리케이션 경계·흐름<a hidden class=anchor aria-hidden=true href=#a-애플리케이션-경계흐름-1>#</a></h6><p>문제: Tx 내부 대기, 멱등 부재로 재시도 폭주.<br>결과: 보유·대기 증가, 중복 반영 위험.<br>원인: 경계 미분리, 요청 식별 부재.<br>해결: 외부 I/O Tx 밖, 단일 목적 Tx, 멱등 키, 동적 타임아웃 + 백오프.</p><table><thead><tr><th>항목</th><th>안티패턴 예시</th><th>해결 예시</th></tr></thead><tbody><tr><td>사용자/원격 대기</td><td>Tx 안에서 input()/RPC 대기</td><td>입력·RPC 선처리 후 짧은 Tx</td></tr><tr><td>멱등 부재</td><td>타임아웃 후 재시도 중복 반영</td><td>Idempotency-Key 저장·조회</td></tr></tbody></table><ul><li>요약: 경계 분리와 멱등만 지켜도 보유·대기를 함께 줄인다.</li></ul><h6 id=b-sql인덱스배치-설계>B, SQL/인덱스·배치 설계<a hidden class=anchor aria-hidden=true href=#b-sql인덱스배치-설계>#</a></h6><p>문제: 풀스캔 갱신, FOR UPDATE 남발.<br>결과: 범위락 확대, 에스컬레이션·상위 충돌.<br>원인: 인덱스·프루닝 부재, 후보 미확정 선잠금.<br>해결: 선택도 인덱스/커버링, CTE 로 후보 확정 후 잠금, 소배치.</p><table><thead><tr><th>항목</th><th>안티패턴 예시</th><th>해결 예시</th></tr></thead><tbody><tr><td>광범위 UPDATE</td><td>조건 인덱스 없음</td><td>인덱스 + LIMIT 배치</td></tr><tr><td>선잠금</td><td>전체 스캔 FOR UPDATE</td><td>후보 CTE → 확정 후 FOR UPDATE</td></tr></tbody></table><ul><li>요약: 후보를 먼저 " 작게 만들고 " 잠그면 된다.</li></ul><h6 id=c-엔진-파라미터락-매니저>C, 엔진 파라미터·락 매니저<a hidden class=anchor aria-hidden=true href=#c-엔진-파라미터락-매니저>#</a></h6><p>문제: 에스컬레이션 폭주, 고정형 긴 타임아웃.<br>결과: 전역 경합, 기아.<br>원인: 임계·예외 정책 부재, 공정 큐 미적용.<br>해결: 에스컬레이션 임계 (개수/시간)·예외 테이블·야간 승격, 동적 타임아웃·노화.</p><table><thead><tr><th>항목</th><th>안티패턴 예시</th><th>해결 예시</th></tr></thead><tbody><tr><td>승격 오남용</td><td>상시 테이블 락 승격</td><td>핫셋 승격 금지·야간만 허용</td></tr><tr><td>타임아웃</td><td>30s 고정</td><td>부하 기반 200–1000ms 동적</td></tr></tbody></table><ul><li>요약: 예외·시간대·동적화로 꼬리 지연을 자른다.</li></ul><h6 id=d-분산샤딩트랜잭션>D. 분산·샤딩/트랜잭션<a hidden class=anchor aria-hidden=true href=#d-분산샤딩트랜잭션>#</a></h6><p>문제: 샤드 교차 락, 2PC 지연, 시계 불일치.<br>결과: 장기 교차 대기·데드락.<br>원인: 키·라우팅 설계 빈틈, 순서 불일치.<br>해결: 샤드 키 순서 고정, 교차 작업은 사가/큐로 분해, 타임아웃·클럭 동기.</p><table><thead><tr><th>항목</th><th>안티패턴 예시</th><th>해결 예시</th></tr></thead><tbody><tr><td>교차 락</td><td>임의 순서로 다수 샤드 잠금</td><td>고정 순서·사가 분해</td></tr><tr><td>시계 이슈</td><td>타임아웃 불일치</td><td>NTP 동기·보수적 타임아웃</td></tr></tbody></table><ul><li>요약: 충돌 도메인을 물리적으로 쪼개고 순서를 고정한다.</li></ul><h6 id=e-운영관측자동-복구>E. 운영·관측/자동 복구<a hidden class=anchor aria-hidden=true href=#e-운영관측자동-복구>#</a></h6><p>문제: 지표·알람 부재, 수동 복구 지연.<br>결과: SLO 위반·폭발적 지연.<br>원인: 대시보드·런북 미구축.<br>해결: 보유·대기·데드락/분·승격률 대시보드, 자동 피해자 롤백·우선순위 재가중.</p><table><thead><tr><th>항목</th><th>안티패턴 예시</th><th>해결 예시</th></tr></thead><tbody><tr><td>관측 부재</td><td>지표·알람 없음</td><td>지표 + 런북/자동화 (희생자 롤백)</td></tr><tr><td>패턴 반복</td><td>배치 -OLTP 충돌 상시</td><td>시간대 분리·쿼터링</td></tr></tbody></table><ul><li>요약: 보는 만큼 빨라지고, 자동화할수록 안정적이다.</li></ul><h5 id=락-지속시간-문제대응-일람표>락 지속시간 문제–대응 일람표<a hidden class=anchor aria-hidden=true href=#락-지속시간-문제대응-일람표>#</a></h5><table><thead><tr><th>구분</th><th>대표 문제</th><th>주 원인</th><th>즉시 처치</th><th>근본 처방</th><th>핵심 지표</th></tr></thead><tbody><tr><td>앱 경계</td><td>Tx 내 대기</td><td>외부 I/O 포함</td><td>입력/RPC Tx 밖</td><td>단일 목적 Tx·멱등</td><td>보유시간 P95/99</td></tr><tr><td>SQL</td><td>경합·승격</td><td>인덱스 부재·선잠금</td><td>쿼리 프루닝·소배치</td><td>커버링 인덱스·확정 잠금</td><td>상위 충돌률·승격률</td></tr><tr><td>엔진</td><td>전역 경합·기아</td><td>임계/예외 부재</td><td>동적 타임아웃</td><td>예외 테이블·야간 승격</td><td>타임아웃률·큐 길이</td></tr><tr><td>분산</td><td>교차 데드락</td><td>순서 불일치</td><td>피해자 롤백</td><td>샤드 순서 고정·사가</td><td>데드락/분</td></tr><tr><td>운영</td><td>SLO 위반</td><td>관측 부재</td><td>알람/런북 가동</td><td>자동 복구·용량 계획</td><td>SLO 위반율</td></tr></tbody></table><h3 id=고급-주제-및-미래-전망>고급 주제 및 미래 전망<a hidden class=anchor aria-hidden=true href=#고급-주제-및-미래-전망>#</a></h3><h4 id=락-지속시간-한계와-실전-대응-전략>락 지속시간: 한계와 실전 대응 전략<a hidden class=anchor aria-hidden=true href=#락-지속시간-한계와-실전-대응-전략>#</a></h4><p>락 지속시간은 경합이 커질수록 예측이 어려워지고, 교착은 완전히 없애기 힘들다.<br>직렬성을 강하게 잡으면 동시성·처리량은 줄고, 분산에선 전역 순서를 맞추느라 지연이 커진다.<br>그래서 읽기는 MVCC/캐시로 분리하고, 쓰기는 락으로 보호하며, 순서 규약·타임아웃·우회 (NOWAIT/SKIP) 를 섞어 p95/p99 지연을 관리한다.<br>인덱스·샤딩으로 잠금 범위와 핫스팟을 줄이고, 모니터링·리플레이로 원인을 재현·튜닝한다.</p><h5 id=락-지속시간의-한계와-대응>락 지속시간의 한계와 대응<a hidden class=anchor aria-hidden=true href=#락-지속시간의-한계와-대응>#</a></h5><table><thead><tr><th>도전 과제/한계</th><th>무엇이 문제인가 (원인)</th><th>왜 도전적인가 (영향)</th><th>실무 대응 (완화/우회)</th><th>잔여 리스크</th></tr></thead><tbody><tr><td>교착상태 불가피성</td><td>비일관 락 순서·순환 대기</td><td>롤백·지연, 처리량 급감</td><td>순서 규약, Wait-Die/Wound-Wait, 희생자 선택, 타임아웃</td><td>희생자 비용·작업 재시도 증가</td></tr><tr><td>실시간 예측 어려움</td><td>경합·네트워크·OS 스케줄링의 확률성</td><td>p99 폭증, SLO 위반</td><td>우선순위·노후화 큐, NOWAIT/SKIP, 적응형 타임아웃</td><td>데이터 누락/재시도 로직 필요</td></tr><tr><td>성능·확장성 트레이드오프</td><td>직렬성 강화↔동시성 감소</td><td>핫스팟 병목, 비용 증가</td><td>MVCC/SSI 로 읽기 분리, CQRS, 캐시·복제</td><td>쓰기 충돌은 여전히 락 필요</td></tr><tr><td>분산 전역 순서·CAP</td><td>전역 락/합의 지연·분할</td><td>지연 확대·가용성 저하</td><td>샤딩·일관성 해싱, 지역 강일관성 + 전역 최종일관성, 2PC 창 단축</td><td>일시적 불일치/재조정 비용</td></tr><tr><td>범위/넥스트키 비용</td><td>팬텀 방지로 과보호</td><td>범위 잠금으로 지속시간·경합↑</td><td>커버링·선택도 높은 인덱스, 조건 정밀화</td><td>복합 인덱스 관리 복잡</td></tr><tr><td>자동화 한계</td><td>탐지/치유의 관찰가능성 한계</td><td>운영자 개입 필요</td><td>잠금/대기 체인 관측, 규칙 +ML 하이브리드</td><td>오탐/과튜닝 가능성</td></tr><tr><td>디버깅 난이도</td><td>비결정적 인터리빙</td><td>재현 어려움·장기 장애</td><td>결정적 리플레이·트레이싱·카나리아</td><td>오버헤드·환경 의존</td></tr></tbody></table><h5 id=락-지속시간-도전과제-분류>락 지속시간 도전과제 분류<a hidden class=anchor aria-hidden=true href=#락-지속시간-도전과제-분류>#</a></h5><h6 id=a-이론적-제약>A. 이론적 제약<a hidden class=anchor aria-hidden=true href=#a-이론적-제약>#</a></h6><p>락·합의의 본질적 한계 (CAP/직렬가능성↔처리량).</p><table><thead><tr><th>이슈</th><th>원인</th><th>영향</th><th>대응</th><th>주의점</th></tr></thead><tbody><tr><td>직렬성↔처리량</td><td>강한 격리</td><td>TPS 감소</td><td>MVCC/SSI·CQRS</td><td>쓰기 충돌 잔존</td></tr><tr><td>CAP/전역 순서</td><td>네트워크 분할</td><td>가용성 저하</td><td>지역 강일관성 + 전역 최종</td><td>일시 불일치</td></tr></tbody></table><ul><li>요약: 원리의 벽은 설계 레벨에서 우회해야 한다.</li></ul><h6 id=b-경합스케줄링>B. 경합·스케줄링<a hidden class=anchor aria-hidden=true href=#b-경합스케줄링>#</a></h6><p>핫스팟·범위 잠금·OS 스케줄링으로 p99 악화.</p><table><thead><tr><th>이슈</th><th>원인</th><th>영향</th><th>대응</th><th>주의점</th></tr></thead><tbody><tr><td>핫스팟</td><td>동일 키/범위 집중</td><td>대기·데드락</td><td>샤딩·해싱·인덱스</td><td>재해시 비용</td></tr><tr><td>범위/넥스트키</td><td>팬텀 방지 과보호</td><td>지속시간↑</td><td>커버링·선택도↑</td><td>인덱스 관리</td></tr></tbody></table><ul><li>요약: 범위를 줄이면 시간도 줄어든다.</li></ul><h6 id=c-분산전역-일관성>C. 분산·전역 일관성<a hidden class=anchor aria-hidden=true href=#c-분산전역-일관성>#</a></h6><p>전역 잠금·합의로 지연·복잡성 증가.</p><table><thead><tr><th>이슈</th><th>원인</th><th>영향</th><th>대응</th><th>주의점</th></tr></thead><tbody><tr><td>전역 락</td><td>합의·복제</td><td>레이턴시↑</td><td>2PC 창 단축</td><td>네트워크 가변</td></tr><tr><td>순서 합의</td><td>리더 선출</td><td>꼬리 지연</td><td>파티션·리더 정렬</td><td>리더 핫스팟</td></tr></tbody></table><ul><li>요약: 커밋 창을 수치화하고 줄여라.</li></ul><h6 id=d-관측자동화>D. 관측·자동화<a hidden class=anchor aria-hidden=true href=#d-관측자동화>#</a></h6><p>탐지·치유 자동화는 강력하지만 전지전능하진 않다.</p><table><thead><tr><th>이슈</th><th>원인</th><th>영향</th><th>대응</th><th>주의점</th></tr></thead><tbody><tr><td>관측 한계</td><td>샘플링/오버헤드</td><td>오탐/누락</td><td>대기 체인 추적</td><td>비용 관리</td></tr><tr><td>자동 치유</td><td>휴리스틱 한계</td><td>과튠</td><td>규칙 +ML 혼합</td><td>검증용 샌드박스</td></tr></tbody></table><ul><li>요약: 관측→가설→검증의 폐루프가 핵심.</li></ul><h6 id=e-진단디버깅>E. 진단·디버깅<a hidden class=anchor aria-hidden=true href=#e-진단디버깅>#</a></h6><p>비결정적 인터리빙으로 재현이 어렵다.</p><table><thead><tr><th>이슈</th><th>원인</th><th>영향</th><th>대응</th><th>주의점</th></tr></thead><tbody><tr><td>재현 불가</td><td>타이밍 민감</td><td>복구 지연</td><td>결정적 리플레이</td><td>성능 오버헤드</td></tr><tr><td>복합 상호작용</td><td>다계층</td><td>원인 은닉</td><td>분해·카나리아</td><td>환경 차이</td></tr></tbody></table><ul><li>요약: 결정적 기록과 단계적 재현이 답이다.</li></ul><h5 id=락-지속시간-도전과제-통합표>락 지속시간 도전과제 통합표<a hidden class=anchor aria-hidden=true href=#락-지속시간-도전과제-통합표>#</a></h5><table><thead><tr><th>카테고리</th><th>핵심 이슈</th><th>주 원인</th><th>주 영향</th><th>대표 대응</th><th>한줄 팁</th></tr></thead><tbody><tr><td>이론적 제약</td><td>직렬성↔처리량, CAP</td><td>격리·합의 한계</td><td>TPS/가용성 저하</td><td>MVCC/SSI, 하이브리드 일관성</td><td>" 쓰기만 락, 읽기는 스냅샷 "</td></tr><tr><td>경합·스케줄링</td><td>핫스팟, 범위락</td><td>키 집중·과보호</td><td>p99 급증</td><td>인덱스·샤딩·우회</td><td>범위 줄이면 시간↓</td></tr><tr><td>분산·전역</td><td>전역 락/합의</td><td>리더·복제</td><td>레이턴시↑</td><td>2PC 창 단축·정렬</td><td>커밋 창을 수치화</td></tr><tr><td>관측·자동화</td><td>관측/치유 한계</td><td>샘플링/휴리스틱</td><td>과튠/누락</td><td>대기 체인·ML 보조</td><td>규칙 +ML 병행</td></tr><tr><td>진단·디버깅</td><td>재현 난이</td><td>비결정성</td><td>복구 지연</td><td>결정적 리플레이</td><td>카나리아로 검증</td></tr></tbody></table><h4 id=lock-duration-2025-전략-지형도>Lock Duration 2025 전략 지형도<a hidden class=anchor aria-hidden=true href=#lock-duration-2025-전략-지형도>#</a></h4><p>최근 DB 는 **&rdquo; 읽기는 버전, 쓰기는 짧게 &ldquo;**가 기본축이다.<br>PostgreSQL 의 <strong>SSI</strong>나 SQL Server 의 <strong>Row Versioning/Optimized Locking</strong>은 <strong>읽기 대기</strong>를 줄이고 <strong>필요한 잠금만 짧게</strong> 유지한다.<br>InnoDB 는 <strong>넥스트키</strong>로 팬텀을 막지만, 그만큼 <strong>범위 잠금이 길어질 수 있음</strong>을 염두에 둔다.<br>운영 측면에선 <strong>eBPF</strong>로 경합 원인을 빠르게 찾아내고, 클라우드에선 <strong>AI 자동 튜닝</strong>이 쿼리·플랜을 바꿔 간접적으로 Lock Duration 을 줄인다.<br>분산 DB(Spanner, CockroachDB) 는 시간 동기·재시작 전략으로 <strong>장기락 의존도를 낮추는 방향</strong>으로 진화 중이다.</p><h5 id=lock-duration-2025-트렌드-표>Lock Duration 2025 트렌드 표<a hidden class=anchor aria-hidden=true href=#lock-duration-2025-트렌드-표>#</a></h5><table><thead><tr><th>트렌드</th><th>핵심 아이디어</th><th>Lock Duration 영향</th><th>성숙도/도입</th><th>근거</th></tr></thead><tbody><tr><td>MVCC+SSI</td><td>버전 읽기 + SIREAD/프레디킷</td><td>읽기락 최소화, 범위보호는 Tx 종료까지</td><td>성숙/광범위</td><td>(<a href="https://www.postgresql.org/docs/current/transaction-iso.html?utm_source=chatgpt.com" title="Documentation: 17: 13.2. Transaction Isolation">PostgreSQL</a>)</td></tr><tr><td>InnoDB 넥스트키</td><td>레코드 + 갭 잠금</td><td>범위 스캔 동안 잠금 유지·팬텀 차단</td><td>성숙/표준</td><td>(<a href="https://dev.mysql.com/doc/refman/8.2/en/innodb-locking.html?utm_source=chatgpt.com" title="MySQL 8.4 Reference Manual :: 17.7.1 InnoDB Locking">MySQL</a>)</td></tr><tr><td>SQL Server Optimized Locking</td><td>TID/LAQ 로 락 수·차단 축소</td><td>보유 락 최소화, 에스컬 회피</td><td>2025 신기능</td><td>(<a href="https://learn.microsoft.com/en-us/sql/relational-databases/performance/optimized-locking?view=sql-server-ver17&amp;utm_source=chatgpt.com" title="Optimized Locking - SQL Server">Microsoft Learn</a>)</td></tr><tr><td>Row Versioning(SI)</td><td>버전으로 읽기 일관성</td><td>읽기 대기 제거, 쓰기 충돌만 처리</td><td>성숙/광범위</td><td>(<a href="https://learn.microsoft.com/en-us/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-ver17&amp;utm_source=chatgpt.com" title="Transaction locking and row versioning guide - SQL Server">Microsoft Learn</a>)</td></tr><tr><td>eBPF 관측</td><td>저부하 커널 계측</td><td>경합·지연 근본 원인 가시화</td><td>급성장</td><td>(<a href="https://eunomia.dev/blog/2025/02/12/ebpf-ecosystem-progress-in-20242025-a-technical-deep-dive/?utm_source=chatgpt.com" title="eBPF Ecosystem Progress in 2024–2025: A Technical Deep ...">eunomia.dev</a>)</td></tr><tr><td>분산 직렬화 (Spanner)</td><td>TrueTime·외부 일관성</td><td>전통적 장기락 필요성 축소</td><td>성숙/매니지드</td><td>(<a href="https://cloud.google.com/spanner/docs/true-time-external-consistency?utm_source=chatgpt.com" title="Spanner: TrueTime and external consistency">Google Cloud</a>)</td></tr><tr><td>분산 MVCC(Cockroach)</td><td>타임스탬프 푸시·재시작</td><td>장기락 대신 재시작 비용으로 전환</td><td>성숙/오픈</td><td>(<a href="https://www.cockroachlabs.com/docs/stable/architecture/transaction-layer?utm_source=chatgpt.com" title="Transaction Layer">cockroachlabs.com</a>)</td></tr><tr><td>HTM(인텔 TSX)</td><td>HW 트랜잭션</td><td>성공 시 락 회피·단축, 실패 시 폴백 필요</td><td>제한적/선택적</td><td>(<a href="https://www.intel.com/content/www/us/en/support/articles/000059422/processors.html?utm_source=chatgpt.com" title="Intel® Transactional Synchronization Extensions ...">Intel</a>)</td></tr><tr><td>AI 자동 튜닝</td><td>ML 기반 플랜/인덱스 최적화</td><td>경합 유발 쿼리 감소로 간접 단축</td><td>성숙/매니지드</td><td>(<a href="https://learn.microsoft.com/en-us/azure/azure-sql/database/automatic-tuning-overview?view=azuresql&amp;utm_source=chatgpt.com" title="Automatic Tuning Overview - Azure SQL Database">Microsoft Learn</a>)</td></tr></tbody></table><h5 id=lock-duration-트렌드-4-축-분류>Lock Duration 트렌드 4 축 분류<a hidden class=anchor aria-hidden=true href=#lock-duration-트렌드-4-축-분류>#</a></h5><h6 id=a-엔진-레벨-동시성-제어의-진화>A. 엔진 레벨 (동시성 제어의 진화)<a hidden class=anchor aria-hidden=true href=#a-엔진-레벨-동시성-제어의-진화>#</a></h6><ul><li>내용: MVCC+SSI(프레디킷/SIREAD), InnoDB 넥스트키, SQL Server Optimized Locking(TID/LAQ), Row Versioning.</li><li>효과: <strong>읽기 대기 제거/축소</strong>, 필수 구간만 잠금, 팬텀 차단 방식의 차별화.</li><li>리스크: SSI 재시작/검증 비용, 넥스트키의 차단면적 증가, 엔진별 세부 차이.</li></ul><table><thead><tr><th>기술</th><th>핵심 메커니즘</th><th>Duration 영향</th><th>주의점</th><th>근거</th></tr></thead><tbody><tr><td>SSI</td><td>프레디킷/SIREAD</td><td>읽기락 최소·범위 추적</td><td>재시작 가능</td><td>(<a href="https://www.postgresql.org/docs/current/transaction-iso.html?utm_source=chatgpt.com" title="Documentation: 17: 13.2. Transaction Isolation">PostgreSQL</a>)</td></tr><tr><td>넥스트키</td><td>레코드 + 갭</td><td>범위 잠금 유지</td><td>인덱스 의존</td><td>(<a href="https://dev.mysql.com/doc/refman/8.2/en/innodb-locking.html?utm_source=chatgpt.com" title="MySQL 8.4 Reference Manual :: 17.7.1 InnoDB Locking">MySQL</a>)</td></tr><tr><td>Optimized Locking</td><td>TID/LAQ</td><td>락 수·차단 축소</td><td>버전·옵션 확인</td><td>(<a href="https://learn.microsoft.com/en-us/sql/relational-databases/performance/optimized-locking?view=sql-server-ver17&amp;utm_source=chatgpt.com" title="Optimized Locking - SQL Server">Microsoft Learn</a>)</td></tr><tr><td>Row Versioning</td><td>버전 읽기</td><td>읽기 대기 제거</td><td>tempdb/저장공간</td><td>(<a href="https://learn.microsoft.com/en-us/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-ver17&amp;utm_source=chatgpt.com" title="Transaction locking and row versioning guide - SQL Server">Microsoft Learn</a>)</td></tr></tbody></table><ul><li>요약: <strong>필요 잠금만, 더 짧게</strong>—그러나 팬텀·재시작 등 <strong>대가</strong>를 동반.</li></ul><h6 id=b-운영관측자동화-aiopsebpf>B. 운영·관측·자동화 (AIOps/eBPF)<a hidden class=anchor aria-hidden=true href=#b-운영관측자동화-aiopsebpf>#</a></h6><ul><li>내용: eBPF 로 시스템 콜/락 경합 저부하 추적, ML 기반 자동 튜닝으로 경합 유발 쿼리·플랜 감소.</li><li>효과: <strong>원인 가시화→빠른 튜닝 루프</strong>, 간접적으로 Duration 단축.</li></ul><table><thead><tr><th>기술</th><th>역할</th><th>적용 포인트</th><th>한계</th><th>근거</th></tr></thead><tbody><tr><td>eBPF</td><td>저부하 관측</td><td>핫스팟·호출지연 파악</td><td>커널·보안 정책</td><td>(<a href="https://eunomia.dev/blog/2025/02/12/ebpf-ecosystem-progress-in-20242025-a-technical-deep-dive/?utm_source=chatgpt.com" title="eBPF Ecosystem Progress in 2024–2025: A Technical Deep ...">eunomia.dev</a>)</td></tr><tr><td>자동 튜닝 (ML)</td><td>인덱스/플랜 최적화</td><td>튜닝 자동화</td><td>오탐/롤백 필요</td><td>(<a href="https://learn.microsoft.com/en-us/azure/azure-sql/database/automatic-tuning-overview?view=azuresql&amp;utm_source=chatgpt.com" title="Automatic Tuning Overview - Azure SQL Database">Microsoft Learn</a>)</td></tr></tbody></table><ul><li>요약: <strong>관측→자동화</strong>가 운영에서 Lock Duration 을 <strong>직접이 아닌 간접</strong>으로 줄인다.</li></ul><h6 id=c-분산시간-일관성-클라우드-네이티브>C. 분산·시간 일관성 (클라우드 네이티브)<a hidden class=anchor aria-hidden=true href=#c-분산시간-일관성-클라우드-네이티브>#</a></h6><ul><li>내용: Spanner 의 <strong>TrueTime+ 외부 일관성</strong>, CockroachDB 의 <strong>타임스탬프 푸시/재시작</strong>으로 장기락 의존을 낮춤.</li><li>효과: 전통적 장기락 대신 <strong>시간 동기·재시작/리트라이나 지연 숨김</strong>.</li></ul><table><thead><tr><th>시스템</th><th>메커니즘</th><th>Duration 해석</th><th>대가</th><th>근거</th></tr></thead><tbody><tr><td>Spanner</td><td>TrueTime, 외부 일관성</td><td>장기락 필요성 축소</td><td>인프라 복잡성</td><td>(<a href="https://cloud.google.com/spanner/docs/true-time-external-consistency?utm_source=chatgpt.com" title="Spanner: TrueTime and external consistency">Google Cloud</a>)</td></tr><tr><td>CockroachDB</td><td>타임스탬프 푸시</td><td>재시작으로 전환</td><td>재시작 비용</td><td>(<a href="https://www.cockroachlabs.com/docs/stable/architecture/transaction-layer?utm_source=chatgpt.com" title="Transaction Layer">cockroachlabs.com</a>)</td></tr></tbody></table><ul><li>요약: <strong>잠금 대신 시간</strong>—분산에서의 정답 중 하나.</li></ul><h6 id=d-하드웨어oshtmrt커널>D. 하드웨어/OS(HTM·RT·커널)<a hidden class=anchor aria-hidden=true href=#d-하드웨어oshtmrt커널>#</a></h6><ul><li>내용: 인텔 <strong>TSX(HTM)</strong> 으로 성공 시 소프트락 회피, 실패 시 폴백. RT 커널/스케줄링·우선순위는 지연 예측성 개선.</li><li>효과: 마이크로스케일에선 <strong>락 지속 단축</strong>, 매크로스케일 DB 엔진 전면 도입은 제한.</li></ul><table><thead><tr><th>기술</th><th>메커니즘</th><th>Duration 영향</th><th>한계/주의</th><th>근거</th></tr></thead><tbody><tr><td>Intel TSX</td><td>HW 트랜잭션</td><td>성공 시 락 회피</td><td>보안/중단·폴백</td><td>(<a href="https://www.intel.com/content/www/us/en/support/articles/000059422/processors.html?utm_source=chatgpt.com" title="Intel® Transactional Synchronization Extensions ...">Intel</a>)</td></tr></tbody></table><ul><li>요약: <strong>전술적 가속</strong>—광범위 DB 코어에는 아직 <strong>보조 수단</strong>.</li></ul><h5 id=lock-duration-통합-로드맵>Lock Duration 통합 로드맵<a hidden class=anchor aria-hidden=true href=#lock-duration-통합-로드맵>#</a></h5><table><thead><tr><th>축</th><th>대표 기술</th><th>무엇을 바꾸나</th><th>Duration 에의 효과</th><th>언제 쓰나</th><th>핵심 리스크</th><th>근거</th></tr></thead><tbody><tr><td>엔진</td><td>SSI/넥스트키/Optimized</td><td>팬텀 방지·락 수 축소</td><td>읽기 대기 제거/필수 구간만 잠금</td><td>트랜잭션성 핵심</td><td>재시작·차단면적</td><td>(<a href="https://www.postgresql.org/docs/current/transaction-iso.html?utm_source=chatgpt.com" title="Documentation: 17: 13.2. Transaction Isolation">PostgreSQL</a>)</td></tr><tr><td>운영</td><td>eBPF/AI 튜닝</td><td>원인 가시화·자동 튜닝</td><td>간접 단축 (핫스팟 제거)</td><td>운영·SRE</td><td>오탐·권한·롤백</td><td>(<a href="https://eunomia.dev/blog/2025/02/12/ebpf-ecosystem-progress-in-20242025-a-technical-deep-dive/?utm_source=chatgpt.com" title="eBPF Ecosystem Progress in 2024–2025: A Technical Deep ...">eunomia.dev</a>)</td></tr><tr><td>분산</td><td>Spanner/Cockroach</td><td>시간 일관성·재시작</td><td>장기락 의존 축소</td><td>멀티리전</td><td>인프라·재시작</td><td>(<a href="https://cloud.google.com/spanner/docs/true-time-external-consistency?utm_source=chatgpt.com" title="Spanner: TrueTime and external consistency">Google Cloud</a>)</td></tr><tr><td>하드웨어</td><td>Intel TSX</td><td>HW 트랜잭션</td><td>성공 시 락 회피</td><td>특수 워크로드</td><td>보안·폴백</td><td>(<a href="https://www.intel.com/content/www/us/en/support/articles/000059422/processors.html?utm_source=chatgpt.com" title="Intel® Transactional Synchronization Extensions ...">Intel</a>)</td></tr></tbody></table><h4 id=락-대안의-패러다임일관성적용지형>락 대안의 패러다임·일관성·적용지형<a hidden class=anchor aria-hidden=true href=#락-대안의-패러다임일관성적용지형>#</a></h4><ul><li><strong>낙관·스냅샷 계열</strong>은 " 먼저 돌리고, 끝에서 충돌만 잡자 " 라서 <strong>락 대기가 없다</strong>. 충돌 적은 워크로드에 유리.</li><li><strong>락 회피·모델 기반</strong>은 <strong>락 자체를 안 쓰거나</strong>(락 - 프리/STM) <strong>상태를 격리</strong>(액터) 해 병렬성을 얻는다.</li><li><strong>분산·아키텍처 계열</strong>은 <strong>글로벌 락을 아키텍처적으로 없애거나 줄여</strong>(CRDT, CQRS/사가) 대기·데드락을 회피한다.</li><li>단, <strong>강한 일관성</strong>이 꼭 필요하면 SSI/TO/외부 코디네이션이 여전히 필요할 수 있다.</li></ul><h5 id=락-duration-대안-기술-비교표>락 Duration 대안 기술 비교표<a hidden class=anchor aria-hidden=true href=#락-duration-대안-기술-비교표>#</a></h5><table><thead><tr><th>기술군</th><th>대표 기술</th><th>동작 원리 (요지)</th><th>일관성/정확성</th><th>장점</th><th>단점/리스크</th><th>락 Duration 영향</th><th>적합한 상황</th></tr></thead><tbody><tr><td>낙관·다중버전</td><td>낙관적 동시성 (OCC)</td><td>실행→커밋 시 충돌검증/재시도</td><td>직렬화까지 가능 (검증 규칙에 따름)</td><td>락 대기 없음, 지연↓</td><td>충돌 시 재시도 비용</td><td><strong>대폭↓</strong></td><td>충돌 낮음, 짧은 TX</td></tr><tr><td></td><td>스냅샷 격리 (SI)</td><td>읽기는 스냅샷, 쓰기 충돌만 감지</td><td><strong>Repeatable Read</strong> 수준 (Write Skew 가능)</td><td>읽기 무락, 읽기 확장성↑</td><td>Write Skew</td><td><strong>읽기 0, 쓰기 단기</strong></td><td>읽기 위주/HTAP</td></tr><tr><td></td><td>SSI</td><td>SI+ 직렬화 위반 탐지/차단</td><td><strong>Serializable</strong></td><td>락 없이 직렬화 근접</td><td>검출/차단 비용</td><td><strong>읽기 0, 쓰기 단기</strong></td><td>강한 일관 + 읽기 많음</td></tr><tr><td></td><td>타임스탬프 정렬 (TO)</td><td>전역/논리 시계로 순서 강제</td><td>이론상 직렬화</td><td>구현 단순</td><td>롤백↑, 시계 의존</td><td><strong>락 회피</strong></td><td>고지연 링크/배치</td></tr><tr><td>락 회피/모델</td><td>락 - 프리 구조</td><td>CAS 등 원자연산 기반</td><td>메모리 수준 정확성</td><td>데드락 없음, 선형 확장</td><td>설계 난이도, ABA 문제</td><td><strong>락 0</strong></td><td>HPC/핫 루프</td></tr><tr><td></td><td>STM</td><td>메모리 트랜잭션, 커밋 시 검증</td><td>메모리 일관</td><td>개발 단순</td><td>재시도/임계부하</td><td><strong>락 회피</strong></td><td>동시성 높은 앱 메모리</td></tr><tr><td></td><td>액터 모델</td><td>상태 격리/메시지 순차 처리</td><td>액터 단위 선형성</td><td>단순/스케일 쉬움</td><td>교차 액터 트랜잭션 복잡</td><td><strong>DB 락 의존↓</strong></td><td>마이크로서비스/게임</td></tr><tr><td>분산·아키텍처</td><td>CRDT</td><td>병합 규칙으로 충돌 자동 해소</td><td><strong>최종 일관성</strong></td><td>오프라인/복제에 강함</td><td>즉시 강일관성 아님</td><td><strong>락 無</strong></td><td>협업/엣지</td></tr><tr><td></td><td>CQRS/이벤트소싱</td><td>명령·조회 분리, 이벤트 원천</td><td>쓰기 선형성, 읽기 스냅샷</td><td>히스토리/스케일</td><td>일치 타이밍 설계 필요</td><td><strong>쓰기 잠금 단기화</strong></td><td>고읽기/감사 요구</td></tr><tr><td></td><td>사가 (Saga)</td><td>분산 보상 트랜잭션</td><td>최종 일관성</td><td>XA 없이 분산 처리</td><td>보상 복잡</td><td><strong>글로벌 락 無</strong></td><td>마이크로서비스</td></tr><tr><td></td><td>분산 락/리스 (ZK/Redis)</td><td>외부 코디네이터 락/리스</td><td>강일관/펜싱 가정</td><td>간단한 임계구역</td><td>분할/시계 리스크</td><td><strong>DB 락 대체</strong></td><td>글로벌 임계구역 소량</td></tr></tbody></table><h5 id=대안-기술의-3-대-분류-축>대안 기술의 3 대 분류 축<a hidden class=anchor aria-hidden=true href=#대안-기술의-3-대-분류-축>#</a></h5><h6 id=a-낙관다중버전-계열>A. 낙관·다중버전 계열<a hidden class=anchor aria-hidden=true href=#a-낙관다중버전-계열>#</a></h6><ul><li><strong>핵심</strong>: 읽기는 스냅샷로 <strong>락 없이</strong>, 쓰기는 <strong>커밋 시 검증</strong>. 충돌이 적을수록 유리.</li><li><strong>설계 팁</strong>: 단기 트랜잭션, Hot- 키 분리, 재시도 지수 백오프, SSI 필요 여부 판단.</li></ul><table><thead><tr><th>기술</th><th>일관성</th><th>장점</th><th>단점/리스크</th><th>적합 사례</th></tr></thead><tbody><tr><td>OCC</td><td>직렬화까지 가능</td><td>락 대기 0</td><td>재시도 폭주</td><td>장바구니/폼 제출</td></tr><tr><td>SI</td><td>RR~(Write Skew)</td><td>읽기 확장성↑</td><td>Write Skew</td><td>리포트/HTAP</td></tr><tr><td>SSI</td><td>Serializable</td><td>강한 일관성</td><td>오버헤드</td><td>금융/정산</td></tr><tr><td>TO</td><td>Serializable</td><td>간결한 규칙</td><td>롤백↑</td><td>배치/고지연</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>충돌이 낮고 읽기가 많은</strong> 워크로드에 최적.</li></ul><h6 id=b-락-회피모델-기반>B. 락 회피·모델 기반<a hidden class=anchor aria-hidden=true href=#b-락-회피모델-기반>#</a></h6><ul><li><strong>핵심</strong>: CAS/로그 기반 (락 - 프리/STM) 또는 <strong>상태 캡슐화</strong>(액터) 로 락을 대체.</li><li><strong>설계 팁</strong>: ABA 방지 (태깅), 멱등/재시도, 액터간 사가/이벤트로 조정.</li></ul><table><thead><tr><th>기술</th><th>장점</th><th>단점/유의</th><th>적합 사례</th></tr></thead><tbody><tr><td>락 - 프리</td><td>데드락 無, 선형성</td><td>구현 난이도</td><td>HPC/핫경로</td></tr><tr><td>STM</td><td>개발 단순</td><td>재시도 비용</td><td>동시 메모리</td></tr><tr><td>액터</td><td>격리·단순</td><td>교차 트랜잭션 복잡</td><td>게임/실시간</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>코드/메모리 레벨 병렬성</strong> 극대화에 적합.</li></ul><h6 id=c-분산아키텍처-패턴>C. 분산·아키텍처 패턴<a hidden class=anchor aria-hidden=true href=#c-분산아키텍처-패턴>#</a></h6><ul><li><strong>핵심</strong>: 글로벌 락을 <strong>아키텍처</strong>로 치환 (사이드이펙트 분리/최종 일관성/외부 코디네이션).</li><li><strong>설계 팁</strong>: 펜싱 토큰·리스 시간 동기, Outbox·CQRS 로 <strong>쓰기 - 읽기 분리</strong>.</li></ul><table><thead><tr><th>기술</th><th>일관성</th><th>장점</th><th>단점/유의</th><th>적합 사례</th></tr></thead><tbody><tr><td>CRDT</td><td>Eventual</td><td>병합 자동</td><td>모델 제약</td><td>협업 문서/IoT</td></tr><tr><td>CQRS/이벤트소싱</td><td>쓰기 선형/읽기 스냅샷</td><td>감사/스케일</td><td>동기화 설계</td><td>고읽기/감사</td></tr><tr><td>사가</td><td>최종 일관</td><td>글로벌 락 無</td><td>보상 복잡</td><td>마이크로서비스</td></tr><tr><td>분산 락/리스</td><td>강일관 (가정)</td><td>간단</td><td>분할/시계 리스크</td><td>글로벌 임계구역</td></tr></tbody></table><ul><li><strong>요약</strong>: <strong>조직/서비스 경계를 넘는 트랜잭션</strong>에 효과적.</li></ul><h5 id=락-대안-기술-통합-한눈표>락 대안 기술 통합 한눈표<a hidden class=anchor aria-hidden=true href=#락-대안-기술-통합-한눈표>#</a></h5><table><thead><tr><th>기술</th><th>카테고리</th><th>일관성 목표</th><th>경합 프로파일</th><th>락 Duration 효과</th><th>복잡도</th><th>대표 적용</th><th>주요 리스크</th></tr></thead><tbody><tr><td>OCC</td><td>A</td><td>Serializable(검증)</td><td>낮음/중간</td><td><strong>대폭↓</strong></td><td>중</td><td>폼/짧은 TX</td><td>재시도 폭주</td></tr><tr><td>SI</td><td>A</td><td>Snapshot</td><td>읽기 높음</td><td>읽기 0</td><td>낮~중</td><td>HTAP</td><td>Write Skew</td></tr><tr><td>SSI</td><td>A</td><td>Serializable</td><td>읽기 높음</td><td>읽기 0</td><td>중~높</td><td>금융</td><td>오버헤드</td></tr><tr><td>TO</td><td>A</td><td>Serializable</td><td>배치/고지연</td><td>락 회피</td><td>중</td><td>배치</td><td>롤백↑</td></tr><tr><td>락 - 프리</td><td>B</td><td>메모리 선형성</td><td>핫 루프</td><td>락 0</td><td>높</td><td>HPC</td><td>ABA 문제</td></tr><tr><td>STM</td><td>B</td><td>메모리 일관</td><td>중간</td><td>락 회피</td><td>중</td><td>도메인 메모리</td><td>재시도비용</td></tr><tr><td>액터</td><td>B</td><td>액터 선형성</td><td>이벤트형</td><td>DB 락 의존↓</td><td>중</td><td>실시간</td><td>액터간 합성</td></tr><tr><td>CRDT</td><td>C</td><td>Eventual</td><td>분산/오프라인</td><td>락 無</td><td>중</td><td>협업/엣지</td><td>모델 제약</td></tr><tr><td>CQRS/ES</td><td>C</td><td>쓰기 선형/읽기 스냅샷</td><td>고읽기</td><td>쓰기 잠금 단기화</td><td>중~높</td><td>감사</td><td>동기화 복잡</td></tr><tr><td>사가</td><td>C</td><td>최종 일관</td><td>분산</td><td>글로벌락 無</td><td>중~높</td><td>마이크로서비스</td><td>보상복잡</td></tr><tr><td>분산 락/리스</td><td>C</td><td>강일관 (가정)</td><td>소수 임계구역</td><td>DB 락 대체</td><td>중</td><td>코디네이션</td><td>분할·시계</td></tr></tbody></table><hr><h2 id=최종-정리-및-학습-가이드>최종 정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#최종-정리-및-학습-가이드>#</a></h2><h3 id=내용-종합>내용 종합<a hidden class=anchor aria-hidden=true href=#내용-종합>#</a></h3><p>락 지속시간은 데이터 일관성과 처리량의 트레이드오프를 조정한다.<br>경계가 짧을수록 동시성은 높지만 재시도·팬텀이 늘고, 길수록 정합성·복구 용이성은 커지되 대기·데드락 위험이 커진다.<br>그래서 설계 단계에서 인덱스·파티셔닝으로 충돌 표면을 줄이고, 실행 단계에서 타임아웃·NOWAIT·SKIP LOCKED·공정 큐로 혼잡을 제어한다.<br>관측 단계에서는 P95/P99·락 대기율·장수 트랜잭션을 추적하고, 튜닝 단계에서 백오프·쿼터·에스컬레이션 임계를 조정한다.<br>MVCC 는 읽기 지속시간을 줄여주지만, 쓰기·메타데이터 충돌은 결국 락으로 귀결된다.<br>결론적으로 워크로드의 읽기: 쓰기 비율, 충돌률, SLO 를 기준으로 지렛대들을 조합하여 지속시간의 상한을 관리하는 것이 핵심이다.</p><h3 id=실무-적용-가이드>실무 적용 가이드<a hidden class=anchor aria-hidden=true href=#실무-적용-가이드>#</a></h3><table><thead><tr><th>단계</th><th>목표</th><th>핵심 작업</th><th>주요 KPI·임계치 (초안)</th><th>담당/도구</th></tr></thead><tbody><tr><td>도입 준비</td><td>기준선 확보</td><td>2 주 모니터링, 핫스팟 식별, 우선순위 합의</td><td>p95 대기, 데드락/h, TPS</td><td>SRE/DBA · Grafana/Whatap</td></tr><tr><td>구현</td><td>안전한 롤아웃</td><td>카나리, 타임아웃 설정, 쿼리/경계 리팩토링, SKIP/READPAST</td><td>실패율&lt;1%, p95 대기↓20%</td><td>앱/DB · CI/CD, 피처플래그</td></tr><tr><td>운영</td><td>자동화·SLO</td><td>알림→자동 조정, 에스컬/백오프 튜닝, 월간 RCA</td><td>데드락/h↓, 에스컬 횟수↓</td><td>SRE/DBA · 런북/오토메이션</td></tr><tr><td>확장</td><td>핫스팟 제거</td><td>파티셔닝·샤딩, 키 분산, 리플리카 라우팅, 배치 야간화</td><td>핫파트 대기 p95&lt;임계</td><td>플랫폼 · 분산 라우터</td></tr></tbody></table><h3 id=학습-로드맵>학습 로드맵<a hidden class=anchor aria-hidden=true href=#학습-로드맵>#</a></h3><table><thead><tr><th>단계</th><th>기간</th><th>목표</th><th>주요 주제</th><th>실습/산출물</th><th>평가 지표 (예시)</th></tr></thead><tbody><tr><td>0 준비</td><td>0.5 주</td><td>실습 기반 준비</td><td>샘플 스키마, 데이터 로더, 대시보드 템플릿</td><td>docker-compose, Grafana 대시보드</td><td>환경 재현성 100%</td></tr><tr><td>1 기초</td><td>2 주</td><td>개념 마스터</td><td>2PL/MVCC, 격리수준, 보유·대기·데드락</td><td>타임라인 과제 (Grant/Unlock 표시)</td><td>정의·타임라인 퀴즈 90%</td></tr><tr><td>2 핵심</td><td>2 주</td><td>측정·진단</td><td>엔진별 락 뷰, 파라미터 (LOCK/DEADLOCK_TIMEOUT, 승격 임계)</td><td>P95 보유/대기 측정 리포트</td><td>지표 산출·설명 정확도</td></tr><tr><td>3 응용</td><td>3 주</td><td>운영 설계</td><td>재시도/백오프 + 멱등, 샤딩, CQRS, 배치 분리</td><td>리트라이 미들웨어, 배치 스케줄</td><td>타임아웃율 50%↓</td></tr><tr><td>4 고급</td><td>3 주</td><td>고경합 해결</td><td>SSI, 우선순위/노화, 2PC/사가·NTP</td><td>교차 - 자원 데드락 재현·해결</td><td>데드락/분 0.01↓</td></tr><tr><td>5 캡스톤</td><td>2 주</td><td>성과 검증</td><td>핫셋 프루닝, 승격 예외, 순서 규약</td><td>전/후 A/B 튜닝 리포트</td><td>보유 P95 30%↓, TPS 15%↑</td></tr></tbody></table><h3 id=학습-항목-정리>학습 항목 정리<a hidden class=anchor aria-hidden=true href=#학습-항목-정리>#</a></h3><table><thead><tr><th>단계</th><th>세부 항목</th><th>목표</th><th>실무 연관성</th><th>설명</th></tr></thead><tbody><tr><td>1</td><td>보유/대기/데드락 타임라인</td><td>사건 시점 구분</td><td>높음</td><td>Grant/Unlock/Request 시각화</td></tr><tr><td>1</td><td>2PL 변형 비교</td><td>해제 시점 차이</td><td>높음</td><td>보유시간 영향 직결</td></tr><tr><td>1</td><td>MVCC 스냅샷</td><td>읽기 비차단</td><td>높음</td><td>읽기 경로 보유 0</td></tr><tr><td>2</td><td>엔진 락 뷰</td><td>병목 식별</td><td>높음</td><td>pg_locks/INNODB_STATUS/DMV</td></tr><tr><td>2</td><td>타임아웃·승격 튜닝</td><td>꼬리 지연 컷</td><td>높음</td><td>LOCK/DEADLOCK_TIMEOUT, 임계</td></tr><tr><td>2</td><td>핫셋 탐지</td><td>상위 N 키</td><td>높음</td><td>충돌 도메인 찾기</td></tr><tr><td>3</td><td>멱등 리트라이</td><td>안전 재시도</td><td>높음</td><td>충돌/타임아웃 대응</td></tr><tr><td>3</td><td>샤딩·순서 고정</td><td>교차 대기↓</td><td>높음</td><td>데드락 회피</td></tr><tr><td>3</td><td>CQRS/복제본</td><td>읽기 분리</td><td>중간</td><td>보유시간 감소</td></tr><tr><td>3</td><td>배치 분리</td><td>OLTP 보호</td><td>중간</td><td>야간 창·쿼터</td></tr><tr><td>4</td><td>SSI/키 - 범위</td><td>팬텀 방지</td><td>중간</td><td>범위 무결성</td></tr><tr><td>4</td><td>우선순위/노화</td><td>기아 방지</td><td>중간</td><td>공정 큐 운영</td></tr><tr><td>4</td><td>2PC/사가</td><td>분산 경계</td><td>중간</td><td>장수 보유 억제</td></tr><tr><td>5</td><td>A/B 검증</td><td>효과 증명</td><td>높음</td><td>P95·TPS 개선 수치화</td></tr></tbody></table><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어 (한글/영문, 약어)</th><th>정의</th><th>관련 개념</th><th>실무 활용</th></tr></thead><tbody><tr><td>정의·범위</td><td>락 (Lock)</td><td>데이터 자원 점유로 충돌 방지</td><td>락 모드, 락 단위</td><td>동시성 기본 메커니즘</td></tr><tr><td>정의·범위</td><td>락 지속시간 (Lock Duration)</td><td>획득~해제의 시간·정책</td><td>Hold/Wait, 수준 (Statement/Txn)</td><td>성능·일관성·교착에 직접 영향</td></tr><tr><td>정의·범위</td><td>보유 시간 (Hold Time)</td><td>락을 실제 보유한 시간</td><td>처리시간, Early Unlock</td><td>짧게 유지해 경합 감소</td></tr><tr><td>정의·범위</td><td>대기 시간 (Wait Time)</td><td>락 부여 전 대기한 시간</td><td>SLA, 타임아웃</td><td>응답성·UX 핵심 지표</td></tr><tr><td>정책·프로토콜</td><td>트랜잭션 2 단계 락킹 (Two-Phase Locking, 2PL)</td><td>성장/축소 2 단계로 직렬가능성</td><td>엄격 2PL</td><td>격리수준 구현, 복구 용이</td></tr><tr><td>정책·프로토콜</td><td>엄격 2 단계 락킹 (Strict 2PL)</td><td>커밋까지 X 락 유지</td><td>로그/복구</td><td>고일관성·단 보유시간↑</td></tr><tr><td>정책·프로토콜</td><td>락 모드 (Lock Mode)</td><td>공유/배타/의도 모드 체계</td><td>호환성 매트릭스</td><td>충돌 판정·부여 결정</td></tr><tr><td>정책·프로토콜</td><td>락 단위 (Lock Granularity)</td><td>DB/테이블/페이지/행/필드</td><td>승격, 경합</td><td>병렬성↔오버헤드 트레이드오프</td></tr><tr><td>정책·프로토콜</td><td>명령문/트랜잭션 수준 락</td><td>지속 범위 정책</td><td>오토커밋</td><td>응답성/일관성 조정</td></tr><tr><td>정책·프로토콜</td><td>NOWAIT/SKIP LOCKED</td><td>대기 없이 실패/건너뛰기</td><td>재시도/백오프</td><td>혼잡 완화, 타임바운드 처리</td></tr><tr><td>성능·안정성 영향</td><td>락 업그레이드/다운그레이드</td><td>S↔X 전환</td><td>교착, 경합</td><td>쓰기 직전 업그레이드 최소화</td></tr><tr><td>성능·안정성 영향</td><td>락 승격 (Lock Escalation)</td><td>미세 락을 상위로 승격</td><td>메모리, 단위</td><td>관리 오버헤드↓, 경합↑ 가능</td></tr><tr><td>성능·안정성 영향</td><td>교착 상태 (Deadlock)</td><td>순환 대기</td><td>대기 - 그래프, 피해자 선별</td><td>자동 탐지·해소, 타임아웃 분리</td></tr><tr><td>성능·안정성 영향</td><td>락 경합 (Lock Contention)</td><td>동일 자원 경쟁</td><td>핫스팟, 큐 길이</td><td>샤딩/인덱스/패턴 개선</td></tr><tr><td>분산 특수 이슈</td><td>분산 락 (Distributed Lock)</td><td>다노드에서 락 관리</td><td>합의/일관성</td><td>글로벌 리소스 보호</td></tr><tr><td>분산 특수 이슈</td><td>임대/TTL(Lease/TTL)</td><td>시간 만료 자동 해제</td><td>클럭 스큐, 하트비트</td><td>좀비 락 방지, 보유시간 상한</td></tr><tr><td>분산 특수 이슈</td><td>펜싱 토큰 (Fencing Token)</td><td>오래된 보유자 차단</td><td>단조 증가 토큰</td><td>스플릿브레인/재시작 안전</td></tr><tr><td>분산 특수 이슈</td><td>하트비트 (Heartbeat)</td><td>보유 생존 신호</td><td>TTL, 회수</td><td>크래시 회수·가용성 향상</td></tr><tr><td>관찰·운영</td><td>락 타임아웃 (Lock Timeout)</td><td>대기/보유 최대 시간</td><td>재시도, 백오프</td><td>데드락/롱테일 차단</td></tr><tr><td>관찰·운영</td><td>대기 큐 (Wait Queue)</td><td>대기 트랜잭션 큐</td><td>공정성/우선순위</td><td>스케줄링·노화 방지</td></tr><tr><td>관찰·운영</td><td>공정성/우선순위 (Fairness/Priority)</td><td>큐 처리 정책</td><td>기아 방지</td><td>SLA·핫스팟 완화</td></tr><tr><td>관찰·운영</td><td>락 통계 (Lock Statistics)</td><td>획득/대기/보유/경합률 등</td><td>P95, 큐 길이</td><td>모니터링·튜닝 루프</td></tr><tr><td>대안·보완</td><td>다중버전 동시성 제어 (MVCC)</td><td>버전으로 읽기 - 쓰기 분리</td><td>스냅샷 격리</td><td>읽기 락 제거·보유시간 간접 감소</td></tr><tr><td>대안·보완</td><td>무락 프로그래밍 (Lock-free)</td><td>원자적 연산 기반 동시성</td><td>CAS, ABA</td><td>저지연·고확장</td></tr><tr><td>대안·보완</td><td>소프트웨어 트랜잭셔널 메모리 (Software Transactional Memory, STM)</td><td>소프트웨어 트랜잭션</td><td>낙관적 실행</td><td>복잡 로직 단순화</td></tr><tr><td>대안·보완</td><td>하드웨어 트랜잭셔널 메모리 (Hardware Transactional Memory, HTM)</td><td>CPU 지원 트랜잭션</td><td>Intel TSX 등</td><td>짧은 임계구역 가속</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://www.postgresql.org/docs/current/explicit-locking.html>PostgreSQL 문서 — Explicit Locking</a></li><li><a href=https://www.postgresql.org/docs/current/mvcc.html>PostgreSQL 문서 — MVCC(동시성 제어)</a></li><li><a href=https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html>MySQL 8.0 매뉴얼 — InnoDB Locking</a></li><li><a href="https://learn.microsoft.com/ko-kr/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-ver17">SQL Server 문서 — 트랜잭션 잠금과 행 버전 관리</a></li><li><a href=https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/data-concurrency-and-consistency.html>Oracle Database Concepts — Data Concurrency and Consistency</a></li><li><a href=https://www.iso.org/standard/63556.html>ISO/IEC 9075-2:2016 — SQL 표준(트랜잭션 관리)</a></li><li><a href=https://www.contrib.andrew.cmu.edu/~shadow/sql/sql1992.txt>ANSI/ISO SQL-92 — Transaction Processing</a></li><li><a href=https://shop.elsevier.com/books/transaction-processing/gray/978-1-55860-190-1>Transaction Processing: Concepts and Techniques (Gray & Reuter)</a></li><li><a href=https://shop.elsevier.com/books/principles-of-transaction-processing/bernstein/978-0-12-374957-0>Principles of Transaction Processing (Bernstein & Newcomer)</a></li><li><a href=https://research.google/pubs/pub39966/>Google Spanner — A Globally Distributed Database</a></li><li><a href=https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_PerfInsights.html>AWS 문서 — Amazon RDS Performance Insights</a></li><li><a href=https://kafka.apache.org/documentation/#semantics>Apache Kafka 문서 — Exactly Once Semantics</a></li></ul><hr></div></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2026 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>