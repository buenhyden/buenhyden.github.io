<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Distributed Locking | hyunyoun's Blog</title><meta name=keywords content="System-Design,Distributed-Coordination,Distributed-Locking"><meta name=description content="분산 락킹(Distributed Locking)은 분산 시스템에서 여러 노드가 공유 자원에 동시에 접근하지 못하도록 상호 배제를 보장하는 메커니즘입니다. 데이터 일관성과 무결성을 확보하며, Redlock, ZooKeeper, Etcd 등 다양한 방식으로 구현되고, 리더 선출, 중복 실행 방지, 트랜잭션 제어 등 실무에서 활용됩니다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/distributed-locking/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.a9863521b3bd3c240bc506f46b95e3c06ccef2ae37f529d5f99bdaef442bccce.css integrity="sha256-qYY1IbO9PCQLxQb0a5XjwGzO8q439SnV+Zva70QrzM4=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/distributed-locking/index.xml><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/distributed-locking/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/distributed-locking/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="Distributed Locking"><meta property="og:description" content="분산 락킹(Distributed Locking)은 분산 시스템에서 여러 노드가 공유 자원에 동시에 접근하지 못하도록 상호 배제를 보장하는 메커니즘입니다. 데이터 일관성과 무결성을 확보하며, Redlock, ZooKeeper, Etcd 등 다양한 방식으로 구현되고, 리더 선출, 중복 실행 방지, 트랜잭션 제어 등 실무에서 활용됩니다."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="Distributed Locking"><meta name=twitter:description content="분산 락킹(Distributed Locking)은 분산 시스템에서 여러 노드가 공유 자원에 동시에 접근하지 못하도록 상호 배제를 보장하는 메커니즘입니다. 데이터 일관성과 무결성을 확보하며, Redlock, ZooKeeper, Etcd 등 다양한 방식으로 구현되고, 리더 선출, 중복 실행 방지, 트랜잭션 제어 등 실무에서 활용됩니다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Computer Science and Engineering","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":2,"name":"System Design","item":"https://buenhyden.github.io/posts/system-design/"},{"@type":"ListItem","position":3,"name":"분산 시스템(Distributed Systems)","item":"https://buenhyden.github.io/posts/system-design/distributed-systems/"},{"@type":"ListItem","position":4,"name":"Distributed Coordination","item":"https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/"},{"@type":"ListItem","position":5,"name":"Distributed Locking","item":"https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/distributed-locking/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>Computer Science and Engineering</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/system-design/>System Design</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/system-design/distributed-systems/>분산 시스템(Distributed Systems)</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/system-design/distributed-systems/distributed-coordination/>Distributed Coordination</a></div><h1>Distributed Locking</h1><div class=post-description>분산 락킹(Distributed Locking)은 분산 시스템에서 여러 노드가 공유 자원에 동시에 접근하지 못하도록 상호 배제를 보장하는 메커니즘입니다. 데이터 일관성과 무결성을 확보하며, Redlock, ZooKeeper, Etcd 등 다양한 방식으로 구현되고, 리더 선출, 중복 실행 방지, 트랜잭션 제어 등 실무에서 활용됩니다.</div></header><div class=post-content><h2 id=distributed-locking>Distributed Locking<a hidden class=anchor aria-hidden=true href=#distributed-locking>#</a></h2><p>분산 락은 다수 노드가 공유 자원에 동시 접근하지 않도록 제어하여 데이터 일관성과 무결성을 보장하는 핵심 동기화 메커니즘이다. ZooKeeper 의 ephemeral znode, etcd 의 lease, Redis Redlock 등 다양한 구현이 존재하며, fencing token, TTL, 세션 감시 등을 통해 장애 상황에서도 안전성을 확보한다. 리더 선출, 예약 처리, 트랜잭션 제어 등 실무에서 널리 활용되며, CAP 이론 기반의 성능과 일관성 트레이드오프 설계가 중요하다.</p><h3 id=등장-배경-및-발전-과정>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정>#</a></h3><h4 id=등장-배경>등장 배경<a hidden class=anchor aria-hidden=true href=#등장-배경>#</a></h4><ul><li>초기 컴퓨터 시스템에서는 단일 프로세스 내에서 Mutex, Spinlock 등을 사용해 동시성을 제어했음.</li><li>하지만 분산 시스템 환경에서는 여러 노드가 동일 자원에 접근하면서 <strong>Race Condition, 중복 실행, 일관성 손상</strong> 문제가 발생.</li><li>특히 클러스터, MSA, NoSQL, 비동기 처리 확산과 함께 <strong>분산 환경에서의 상호 배제 (Mutual Exclusion)</strong> 보장이 필요해졌음.</li></ul><h4 id=이론적-기반-1970s2000s>이론적 기반 (1970s~2000s)<a hidden class=anchor aria-hidden=true href=#이론적-기반-1970s2000s>#</a></h4><ul><li><strong>1978</strong>: Lamport 의 Logical Clock 및 Mutual Exclusion 이론 등장</li><li><strong>1981</strong>: Ricart–Agrawala 알고리즘 발표</li><li><strong>1989</strong>: Paxos(분산 합의 알고리즘) 발표</li><li>이 시기에는 분산 환경에서의 상호 배제를 위한 이론이 주로 연구됨</li></ul><h4 id=실용화-시작-2000-년대-초반>실용화 시작 (2000 년대 초반)<a hidden class=anchor aria-hidden=true href=#실용화-시작-2000-년대-초반>#</a></h4><ul><li><strong>2006</strong>: Google 이 내부 시스템 (GFS, Bigtable) 을 위해 <strong>Chubby</strong> 락 서비스를 도입</li><li><strong>2008</strong>: Yahoo 에서 <strong>ZooKeeper</strong> 오픈소스로 공개 → Hadoop, Kafka 등에서 광범위하게 사용됨</li><li><strong>2010 년대</strong>: 클라우드와 컨테이너 기술 확산에 따라 락 서비스도 고가용성 기반으로 요구됨</li></ul><h4 id=현대적-진화-2010s현재>현대적 진화 (2010s~현재)<a hidden class=anchor aria-hidden=true href=#현대적-진화-2010s현재>#</a></h4><ul><li><strong>2013</strong>: Raft 알고리즘 등장–Paxos 보다 이해하기 쉬운 합의 프로토콜</li><li><strong>2014~2016</strong>: Redis 기반의 <strong>Redlock 알고리즘</strong> 등장 (antirez), 이후 Martin Kleppmann 에 의해 안정성 논쟁 촉발</li><li><strong>etcd</strong>, <strong>Consul</strong> 등 새로운 고가용 락/키 - 값 저장소가 확산되며, Kubernetes 에서도 <strong>Lease API</strong>를 통해 리더 선출 등에서 락 개념이 적용됨</li></ul><h4 id=오늘날-활용-예>오늘날 활용 예<a hidden class=anchor aria-hidden=true href=#오늘날-활용-예>#</a></h4><ul><li><strong>Kubernetes</strong>, <strong>Kafka</strong>, <strong>DB Failover 시스템</strong>, <strong>MSA 기반 잡 스케줄러</strong> 등에서 사용</li><li>Redis/etcd/ZooKeeper 를 통한 <strong>분산락 구현</strong>은 고가용성 (HR), 리더 선출, 작업 중복 방지, 동시성 보장 등에 필수 요소로 자리잡음</li></ul><h3 id=목적-및-필요성>목적 및 필요성<a hidden class=anchor aria-hidden=true href=#목적-및-필요성>#</a></h3><h4 id=목적>목적<a hidden class=anchor aria-hidden=true href=#목적>#</a></h4><ol><li><p><strong>데이터 일관성 보장</strong></p><ul><li>동시에 접근하는 노드로 인한 데이터 손상을 방지하고, ACID 속성 중 일관성을 유지</li></ul></li><li><p><strong>안전한 동시성 제어</strong></p><ul><li>여러 노드/프로세스 간 임계 구역 보호 및 race condition 회피</li></ul></li><li><p><strong>예측 가능한 단일 실행</strong></p><ul><li>배치 잡, 리더 선출, 스케줄링 등에서 중복 실행 없이 한 번만 수행되도록 보장</li></ul></li><li><p><strong>시스템 신뢰성 및 복원력 확보</strong></p><ul><li>장애 발생 시 자동 해제, 소유권 이전, 복구를 통해 시스템 중단 최소화</li></ul></li><li><p><strong>운영 정책 및 통합 제어 실현</strong></p><ul><li>API 중복 호출 방지, 외부 요청 제어, 서비스 정책 기반 락 처리</li></ul></li><li><p><strong>감사 및 모니터링 기반 추적성 확보</strong></p><ul><li>락 획득/해제 기록과 함께 관찰 가능성 확보, 운영 중 디버깅 용이</li></ul></li><li><p><strong>확장성과 클라우드 네이티브 아키텍처 대응</strong></p><ul><li>마이크로서비스 기반 아키텍처에서 락을 통한 서비스 조율과 확장 대응 가능</li></ul></li></ol><h4 id=필요성>필요성<a hidden class=anchor aria-hidden=true href=#필요성>#</a></h4><ul><li><p><strong>분산 시스템의 비결정성 대응</strong></p><ul><li>노드 간 상태 공유의 어려움, 글로벌 시계 부재, 네트워크 지연 등 비동기 특성으로 인한 불확실성 제거</li></ul></li><li><p><strong>데이터 무결성 및 비즈니스 신뢰성 확보</strong></p><ul><li>재고 차감, 금융 트랜잭션, 예약 시스템 등에서 정확한 실행 및 결과 보장</li></ul></li><li><p><strong>성능과 일관성 간 트레이드오프 해결 도구</strong></p><ul><li>CAP 이론 하에서 일관성과 가용성의 균형을 설계에 반영</li></ul></li><li><p><strong>자동화된 장애 복구를 위한 핵심 컴포넌트</strong></p><ul><li>TTL, fencing token, session timeout 등을 통한 자가 복구 메커니즘 구현</li></ul></li><li><p><strong>관찰 가능성과 운영 최적화 수단</strong></p><ul><li>트레이싱/로그/모니터링을 통한 장애 진단 및 성능 최적화</li></ul></li></ul><h3 id=핵심-개념-core-concepts>핵심 개념 (Core Concepts)<a hidden class=anchor aria-hidden=true href=#핵심-개념-core-concepts>#</a></h3><h4 id=기본-개념>기본 개념<a hidden class=anchor aria-hidden=true href=#기본-개념>#</a></h4><table><thead><tr><th>개념</th><th>설명</th></tr></thead><tbody><tr><td><strong>상호 배제 (Mutual Exclusion)</strong></td><td>한 번에 하나의 노드만 공유 자원 접근을 허용하는 핵심 원칙</td></tr><tr><td><strong>임계 영역 (Critical Section)</strong></td><td>보호되어야 할 공유 자원 접근 구간</td></tr><tr><td><strong>락 메커니즘 (Lock Mechanism)</strong></td><td>자원 접근 제어 방식 (Exclusive, Shared, Partitioned 등)</td></tr><tr><td><strong>락 유효 기간 관리 (TTL/Lease)</strong></td><td>자동 만료 설정 혹은 세션 기반 유지 방식</td></tr><tr><td><strong>펜싱 토큰 (Fencing Token)</strong></td><td>락 획득 순서 보장을 위한 단조 증가 식별자</td></tr></tbody></table><h4 id=분산-환경-특화-개념>분산 환경 특화 개념<a hidden class=anchor aria-hidden=true href=#분산-환경-특화-개념>#</a></h4><table><thead><tr><th>개념</th><th>설명</th></tr></thead><tbody><tr><td><strong>리더 선출 (Leader Election)</strong></td><td>Ephemeral zNode or Lease 기반으로 단일 리더 지정</td></tr><tr><td><strong>분산 합의 (Distributed Consensus)</strong></td><td>Paxos, Raft, PBFT 등으로 락 상태 일관성 보장</td></tr><tr><td><strong>논리 시계 (Logical Timestamp)</strong></td><td>요청 순서 보장을 위한 Lamport/Vector Clock</td></tr><tr><td><strong>FLP 정리</strong></td><td>완전한 비동기 시스템에서 합의 불가능성 이론</td></tr><tr><td><strong>CAP 정리</strong></td><td>분산 시스템에서 일관성, 가용성, 분할 허용성의 트레이드오프</td></tr></tbody></table><h4 id=실무-구현-연관성>실무 구현 연관성<a hidden class=anchor aria-hidden=true href=#실무-구현-연관성>#</a></h4><table><thead><tr><th>실무 요소</th><th>설명</th></tr></thead><tbody><tr><td><strong>Redis 기반 Redlock</strong></td><td>TTL 과 SETNX 를 이용한 경량 락 방식, 짧은 기간에 적합</td></tr><tr><td><strong>ZooKeeper 기반 락</strong></td><td>Ephemeral Sequential Node 사용, 순서 보장</td></tr><tr><td><strong>etcd 기반 락</strong></td><td>Lease 기반, Kubernetes Lease API 와 연동</td></tr><tr><td><strong>장애 감지 및 복구</strong></td><td>하트비트, 세션 종료 감지, TTL 만료 등을 통한 자동 복구</td></tr><tr><td><strong>성능 최적화 전략</strong></td><td>Retry + Backoff, 락 세분화, 대기 큐 등 경합 완화 방식</td></tr><tr><td><strong>보안 및 신뢰성</strong></td><td>요청 ID, Idempotency, 펜싱 토큰 기반 멱등성 처리</td></tr></tbody></table><h4 id=분산-시스템-설계-시-고려-사항>분산 시스템 설계 시 고려 사항<a hidden class=anchor aria-hidden=true href=#분산-시스템-설계-시-고려-사항>#</a></h4><ul><li>네트워크 분할 (Split-Brain) 시 다중 리더 방지</li><li>클러스터 내 단일 실패 지점 (SPOF) 제거</li><li>세션 기반 락 해제 vs TTL 기반 해제의 안정성 차이</li><li>클라이언트 장애 대비 멱등성 및 롤백 전략 필수</li></ul><h3 id=주요-기능-및-역할>주요 기능 및 역할<a hidden class=anchor aria-hidden=true href=#주요-기능-및-역할>#</a></h3><table><thead><tr><th>기능 구분</th><th>기능</th><th>대응 역할</th><th>설명</th></tr></thead><tbody><tr><td><strong>획득</strong></td><td>락 획득 (Lock Acquire)</td><td><strong>동시성 제어자</strong></td><td>자원에 대한 단일 접근 보장</td></tr><tr><td><strong>해제</strong></td><td>락 해제 (Release, TTL Expiry)</td><td><strong>일관성 보장자</strong></td><td>중복 실행 방지, 자원 반환 보장</td></tr><tr><td><strong>연장</strong></td><td>락 유지/갱신 (Heartbeat, Lease)</td><td><strong>자원 관리자</strong></td><td>장기 작업 지속 가능, premature 해제 방지</td></tr><tr><td><strong>감시</strong></td><td>락 변화 감지 (Watch, Notify)</td><td><strong>중재자 / 분산 조정자</strong></td><td>다음 클라이언트에게 통제 권한 이전</td></tr><tr><td><strong>재시도</strong></td><td>Retry with Backoff</td><td><strong>성능 최적화 도우미</strong></td><td>부하 완화, 경합 시도 조정</td></tr><tr><td><strong>검사</strong></td><td>소유자 검증 / 상태 확인</td><td><strong>보호자 역할</strong></td><td>락 위조 방지, 외부 해제 요청 검증</td></tr><tr><td><strong>장애 처리</strong></td><td>자동 해제 / 소유권 이전</td><td><strong>장애 복구 지원자</strong></td><td>노드 장애 시 타 클라이언트로 안전하게 이전</td></tr><tr><td><strong>관찰성</strong></td><td>트레이싱 / 로그 / 이벤트 기록</td><td><strong>운영 모니터링 도우미</strong></td><td>SLA 보장, 문제 추적 가능성 확보</td></tr><tr><td><strong>리더 선출</strong></td><td>단일 노드 선정 / 우선순위 락 할당</td><td><strong>조정자</strong></td><td>분산 시스템에서 결정권자 역할 조정</td></tr></tbody></table><ul><li>**기능은 행동 (Action)**이고, **역할은 목적 (Purpose)**이다.</li><li>예를 들어 <code>락 획득</code> 은 <code>자원에 대한 배타적 접근을 위한 기능</code> 이며, 이를 통해 <strong>시스템 전체 동시성 제어</strong>라는 역할을 수행한다.</li><li><code>락 유지</code> 는 장기 실행 시 필요한 기능이며, <strong>작업 지속성과 자원 관리 역할</strong>을 충족시킨다.</li><li><code>Watch</code> 나 <code>TTL Expiry</code> 는 락의 흐름을 조율하거나 복구 시나리오에서 <strong>조정자 및 복구자 역할</strong>로 기능한다.</li></ul><h4 id=distributed-lock-state-transition-diagram>Distributed Lock State Transition Diagram<a hidden class=anchor aria-hidden=true href=#distributed-lock-state-transition-diagram>#</a></h4><pre class=mermaid>stateDiagram-v2
    [*] --&gt; Idle: 초기 상태

    Idle --&gt; Acquiring: Lock 획득 시도
    Acquiring --&gt; Acquired: 락 획득 성공
    Acquiring --&gt; Failed: 타 클라이언트가 이미 점유

    Acquired --&gt; Renewing: TTL 연장(Heartbeat/Lease)
    Renewing --&gt; Acquired: 연장 성공
    Acquired --&gt; Expired: TTL 만료
    Acquired --&gt; Releasing: 정상 해제
    Releasing --&gt; Released: 해제 완료

    Expired --&gt; Recovering: 자동 복구 절차
    Recovering --&gt; Idle: 다음 클라이언트에게 기회 부여

    Failed --&gt; RetryWait: 재시도 백오프 대기
    RetryWait --&gt; Acquiring

    Released --&gt; [*]
    Expired --&gt; [*]
</pre><table><thead><tr><th>상태</th><th>설명</th></tr></thead><tbody><tr><td><strong>Idle</strong></td><td>락 요청 전 대기 상태</td></tr><tr><td><strong>Acquiring</strong></td><td>락 획득 요청 중 (SETNX, znode 생성 등)</td></tr><tr><td><strong>Acquired</strong></td><td>락 획득 성공, 자원 접근 가능</td></tr><tr><td><strong>Renewing</strong></td><td>TTL 또는 lease 갱신 (장기 작업용)</td></tr><tr><td><strong>Releasing</strong></td><td>클라이언트가 명시적으로 해제 요청</td></tr><tr><td><strong>Released</strong></td><td>정상 해제 완료</td></tr><tr><td><strong>Expired</strong></td><td>TTL 또는 세션 만료로 자동 해제</td></tr><tr><td><strong>Recovering</strong></td><td>Expired 이후 다른 클라이언트 접근 가능하게 초기화</td></tr><tr><td><strong>RetryWait</strong></td><td>실패 후 재시도까지 대기 시간 (Backoff 적용)</td></tr><tr><td><strong>Failed</strong></td><td>락 획득 실패 상태</td></tr></tbody></table><h3 id=특징>특징<a hidden class=anchor aria-hidden=true href=#특징>#</a></h3><table><thead><tr><th>카테고리</th><th>특징</th><th>설명</th></tr></thead><tbody><tr><td><strong>분산 구조적 특성</strong></td><td>분산성 (Distribution)</td><td>여러 노드 간 동기화 및 상태 일관성 유지 (Quorum 기반)</td></tr><tr><td></td><td>순서 보장 (Ordering)</td><td>Sequential Node, Timestamp 등으로 요청 순서 보장</td></tr><tr><td></td><td>확장성 (Scalability)</td><td>시스템 노드 확장 대응, Partition Lock, Sharding 활용</td></tr><tr><td><strong>신뢰성/복원 특성</strong></td><td>내결함성 (Fault Tolerance)</td><td>클라이언트 장애 시 자동 해제, 세션 기반 복원력</td></tr><tr><td></td><td>자동 복구 (TTL/Lease)</td><td>타임아웃 기반 자동 해제 혹은 세션 종료 시 해제</td></tr><tr><td><strong>설계/운영 특성</strong></td><td>사용 투명성 (Transparency)</td><td>API 추상화 및 클라이언트 라이브러리 제공</td></tr><tr><td></td><td>유연성 (Flexibility)</td><td>다양한 백엔드 지원 (Redis, etcd, ZooKeeper 등)</td></tr><tr><td></td><td>시간 민감성 및 오버헤드</td><td>클럭 스큐 민감, TTL 방식의 불안정성, 합의 기반 비용 증가</td></tr></tbody></table><ul><li><p><strong>분산 구조적 특성</strong>: Distributed Locking 은 반드시 여러 노드 간 상태 일관성을 보장해야 하며, 요청 순서를 명확히 관리해야 한다. 특히 확장성을 고려한 락 분할 전략이 필요하다.</p></li><li><p><strong>신뢰성/복원 특성</strong>: TTL 과 세션 기반의 자동 해제는 장애 대응의 핵심이며, 리더 선출 및 세션 만료 로직은 내결함성을 결정짓는 요소다.</p></li><li><p><strong>설계/운영 특성</strong>: 실제 시스템에 도입할 때는 클럭 오차와 네트워크 비용, 락 API 추상화 수준, 스토리지 유연성 등을 고려해 설계해야 하며, 성능과 안정성 사이의 트레이드오프가 존재한다.</p></li></ul><h3 id=핵심-원칙>핵심 원칙<a hidden class=anchor aria-hidden=true href=#핵심-원칙>#</a></h3><table><thead><tr><th>카테고리</th><th>원칙</th><th>설명</th></tr></thead><tbody><tr><td><strong>기능적 동작 보장</strong></td><td>안전성 (Safety)</td><td>동시에 하나의 노드만 자원에 접근 가능하게 보장</td></tr><tr><td></td><td>생존성 (Liveness)</td><td>락이 결국은 해제되며 다음 요청자가 획득할 수 있어야 함</td></tr><tr><td></td><td>원자성 (Atomicity)</td><td>락 획득/해제는 한 번에 실패 없이 완료되어야 함</td></tr><tr><td><strong>시스템 일관성 보장</strong></td><td>일관성 (Consistency)</td><td>분산 노드 간 락 상태는 항상 동일한 정보를 가져야 함</td></tr><tr><td></td><td>순차성 (Ordering)</td><td>요청 순서 또는 시간 순서에 따라 락이 처리되어야 함</td></tr><tr><td><strong>장애 대응 특성</strong></td><td>장애 허용성 (Fault Tolerance)</td><td>일부 노드 장애나 네트워크 문제에도 시스템 유지</td></tr><tr><td></td><td>시간 기반 복구 (TTL/Session)</td><td>자동 만료, 세션 기반 종료로 락 해제 보장</td></tr><tr><td><strong>기술 기반 원칙</strong></td><td>합의 기반 일관성 (Consensus)</td><td>Paxos/Raft 기반 합의를 통해 선형화 보장</td></tr></tbody></table><ul><li><p><strong>기능적 동작 보장</strong>: 락의 본질은 하나의 자원을 동시에 하나의 노드만 점유하도록 보장하는 것이며, 원자적 연산과 공정한 처리를 통해 이 목표를 달성해야 한다.</p></li><li><p><strong>시스템 일관성 보장</strong>: 락 상태에 대한 시점 일관성, 순서 제어, 읽기/쓰기 간 정합성은 분산 환경에서 반드시 보장해야 할 설계 원칙이다.</p></li><li><p><strong>장애 대응 특성</strong>: 장애 복원력은 분산 락 시스템의 생존성 핵심이며, 세션 만료 또는 TTL 기반의 자동 해제는 이를 실현하는 핵심 전략이다.</p></li><li><p><strong>기술 기반 원칙</strong>: Paxos, Raft 같은 합의 알고리즘을 통해 분산된 노드 간에 단일한 락 상태를 유지하고 선형화 가능성을 확보할 수 있어야 한다.</p></li></ul><h3 id=주요-원리-및-작동-원리>주요 원리 및 작동 원리<a hidden class=anchor aria-hidden=true href=#주요-원리-및-작동-원리>#</a></h3><h4 id=주요-원리>주요 원리<a hidden class=anchor aria-hidden=true href=#주요-원리>#</a></h4><p><strong>합의 기반 토큰 발급 및 fencing 적용 원리</strong></p><pre class=mermaid>graph TD
    A[Lock Request from Client] --&gt; B[&#34;Lock Service (Redis/ZK/etcd)&#34;]

    B --&gt; C{Is Lock Free?}
    C --&gt;|Yes| D[&#34;Generate fencing_token (monotonic)&#34;]
    C --&gt;|No| E[Add to Wait Queue]

    D --&gt; F[Grant Lock + Set TTL]
    F --&gt; G[Client Performs Operation with Token]
    G --&gt; H[Resource checks token ≥ last_token]
    H --&gt;|Valid| I[Operation Success &amp; Update last_token]
    H --&gt;|Invalid| J[&#34;Reject Operation (Stale)&#34;]

    subgraph Failure Handling
      F2[TTL Expiry] --&gt; E
      K[Client Disconnect] --&gt; E
    end
</pre><ul><li><strong>fencing token 발급</strong>: 단조 증가하는 정수로 클라이언트의 자원 접근 권한을 시각적으로 구분</li><li><strong>TTL 기반 자동 만료</strong>: 락 소유자가 다운되면 TTL 을 통해 자동 해제 유도</li><li><strong>자원 접근 시 토큰 검증</strong>: 토큰이 최신값 이상인지 검증해야만 <strong>진짜 락 보장</strong></li><li><strong>Wait Queue 기반 순서 보장</strong>: ZooKeeper 의 sequential znode 등에서 구현</li><li><strong>클라이언트 장애 시 복구</strong>: TTL, 세션 종료, fencing, watch 기반으로 자동 대기자에게 락 이전</li></ul><h4 id=작동-원리>작동 원리<a hidden class=anchor aria-hidden=true href=#작동-원리>#</a></h4><p><strong>분산 락의 생명주기 흐름</strong></p><pre class=mermaid>sequenceDiagram
    participant C1 as Client 1
    participant LockService as Lock Server (Redis/ZK/etcd)
    participant Resource as Shared Resource

    C1-&gt;&gt;LockService: Request Lock(&#34;resource_x&#34;)
    LockService--&gt;&gt;C1: Granted (fencing_token = 101)
    
    C1-&gt;&gt;Resource: Access with token(101)
    Resource-&gt;&gt;Resource: if token &gt;= last_token → allow
    Resource--&gt;&gt;C1: Operation Success

    Note over C1: Client GC or paused

    LockService-&gt;&gt;LockService: TTL expired
    participant C2 as Client 2
    C2-&gt;&gt;LockService: Request Lock(&#34;resource_x&#34;)
    LockService--&gt;&gt;C2: Granted (token = 102)

    C2-&gt;&gt;Resource: Access with token(102)
    Resource-&gt;&gt;Resource: update last_token = 102
    Resource--&gt;&gt;C2: Operation Success

    C1-&gt;&gt;Resource: Access with token(101)
    Resource--&gt;&gt;C1: Rejected (Stale Token)
</pre><hr><ul><li><strong>분산 락의 작동 원리</strong>는 " 요청 → 부여 → 사용 → 해제 " 의 생명주기를 따라 움직이며, 중간에 TTL 및 fencing token 이 시스템의 안전성을 보장하는 핵심 수단이 된다.</li><li><strong>Fencing Token</strong>은 클라이언트 간 순서를 보장하고, 네트워크 지연/장애로 인한 stale 요청을 차단하기 위한 보안 수단이다.</li><li><strong>TTL 및 세션 기반 유지</strong>는 클라이언트의 예기치 못한 실패에도 시스템이 자동으로 복구 가능하도록 해준다.</li><li>**락 대기열 (FIFO 또는 우선순위 기반)**은 공정성과 효율성을 함께 고려한 락 할당 정책이다.</li><li><strong>멀티 락 처리나 장애 복구 시</strong>는 deadlock, force unlock, quorum consensus 등 고급 메커니즘이 필수적으로 작동한다.</li><li><strong>운영 측면에서는</strong> 각 상태 전이와 이벤트 발생 시점의 로그, 메트릭, 트레이싱을 통해 실시간 가시성과 디버깅 기반을 마련해야 한다.</li></ul><h3 id=구조-및-아키텍처>구조 및 아키텍처<a hidden class=anchor aria-hidden=true href=#구조-및-아키텍처>#</a></h3><pre class=mermaid>flowchart TD
  subgraph Client Layer
    C1[Client 1]
    C2[Client 2]
    C3[Client N]
  end

  subgraph Lock Service Cluster
    LM1[Lock Manager 1&lt;br/&gt;Leader]
    LM2[Lock Manager 2&lt;br/&gt;Follower]
    LM3[Lock Manager 3&lt;br/&gt;Follower]
    TM[Token Manager]
    SM[Session Manager]
    CE[Consensus Engine]
  end

  subgraph Storage Backend
    DB1[(Redis/Etcd/ZooKeeper)]
    DB2[(Replica)]
  end

  subgraph Protected Resource
    R1[Database]
    R2[Cache]
    R3[External API]
  end

  %% Client Interaction
  C1 --&gt;|acquire/release| LM1
  C2 --&gt;|acquire/release| LM1
  C3 --&gt;|acquire/release| LM1

  %% Lock coordination
  LM1 --&gt; TM
  LM1 --&gt; SM
  LM1 --&gt; CE
  CE &lt;--&gt; LM2
  CE &lt;--&gt; LM3

  %% Persistence
  LM1 --&gt; DB1
  DB1 --&gt; DB2

  %% Access to resources with token
  C1 --&gt;|fenced operation| R1
  C2 --&gt;|fenced operation| R2
  C3 --&gt;|fenced operation| R3
</pre><hr><ul><li>락 요청은 Lock Manager 를 통해 처리되며, 내부적으로 Session Manager 가 TTL/세션 유지, Token Manager 가 순서를 보장한다.</li><li>락 상태는 Consensus Engine 을 통해 여러 노드에 복제되며, Storage Backend 에 저장되어 복구가 가능하다.</li><li>각 클라이언트는 락 획득 후 Fencing Token 을 통해 공유 자원에 안전하게 접근하며, 장애 발생 시 TTL 또는 세션 종료로 자동 회수된다.</li></ul><h4 id=구성-요소>구성 요소<a hidden class=anchor aria-hidden=true href=#구성-요소>#</a></h4><table><thead><tr><th>분류</th><th>구성 요소</th><th>역할 및 기능</th><th>구현 예시 / 특징</th></tr></thead><tbody><tr><td><strong>필수</strong></td><td>Lock Manager</td><td>락 획득/해제 요청 처리 및 상태 관리</td><td>Redis SETNX, ZK Ephemeral Node, etcd Lease</td></tr><tr><td></td><td>Consensus Engine</td><td>리더 선출, 락 상태 복제 및 합의</td><td>Raft (etcd), ZAB (ZK), Paxos</td></tr><tr><td></td><td>Session Manager</td><td>TTL/세션 관리, Heartbeat 처리</td><td>클라이언트 장애 시 자동 해제, 좀비 락 방지</td></tr><tr><td></td><td>Token Manager</td><td>펜싱 토큰 발급, 순서 보장</td><td>단조 증가 시퀀스, CAS 비교 기반</td></tr><tr><td></td><td>Storage Backend</td><td>락 상태 저장 및 복제</td><td>Redis, Etcd, ZooKeeper, RDBMS</td></tr><tr><td><strong>선택</strong></td><td>Request Queue</td><td>락 요청의 순서성/공정성 보장</td><td>FIFO 또는 우선순위 기반</td></tr><tr><td></td><td>Monitoring/Alert</td><td>성능 추적, 지연 탐지, 알림 연동</td><td>Grafana, Prometheus, ELK</td></tr><tr><td></td><td>Backup/Recovery</td><td>상태 백업, 리더 교체 시 롤백 방지</td><td>Snapshot, WAL (Write Ahead Log)</td></tr><tr><td></td><td>Lease Renewal</td><td>장기 작업을 위한 TTL 연장</td><td>자동 또는 명시적 연장 (P-Expire 등)</td></tr></tbody></table><h3 id=구현-기법-및-방법>구현 기법 및 방법<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법>#</a></h3><table><thead><tr><th>기법</th><th>구성 요소</th><th>장점</th><th>고려사항 / 단점</th></tr></thead><tbody><tr><td>Redis 단일 인스턴스 락</td><td><code>SET key value NX PX</code>, Lua 스크립트</td><td>간단, 빠름, 낮은 지연</td><td>단일 장애점, clock skew 에 취약</td></tr><tr><td>Redlock (Redis 다중 인스턴스)</td><td>N Redis + 과반수 락 획득 + TTL</td><td>장애 내성 확보, Quorum 기반 안정성</td><td>네트워크 분리, clock skew 고려 필요</td></tr><tr><td>ZooKeeper 기반 락</td><td>Ephemeral Sequential ZNode + Watch</td><td>강한 일관성, 공정한 FIFO 제공</td><td>구축 복잡도, 운영 오버헤드</td></tr><tr><td>etcd 기반 락</td><td>Lease(TTL) + Compare-and-Swap 트랜잭션 + Watch</td><td>Kubernetes 통합, Raft 기반 신뢰성</td><td>clock skew 문제, 키 외 시스템 자원 연계 시 제한 (<a href="https://www.swiftorial.com/qa/system-design/57/?utm_source=chatgpt.com" title="Q&amp;A - system-design Page 57 | Swiftorial">Swiftorial</a>, <a href="https://medium.com/%40hanxuyang0826/roadmap-to-backend-programming-master-building-resilient-systems-with-distributed-locks-1674447955b9?utm_source=chatgpt.com" title="Building Resilient Systems with Distributed Locks | by Lagu">Medium</a>, <a href="https://dzone.com/articles/distributed-lock-implementation-with-redis?utm_source=chatgpt.com" title="Distributed Lock Implementation With Redis">DZone</a>, <a href="https://sumofbytes.com/blog/distributed-locks-uses-and-implemetation?utm_source=chatgpt.com" title="Distributed Locks: Use Cases and Implementations">Sum of Bytes</a>, <a href="https://www.alibabacloud.com/blog/implementation-principles-and-best-practices-of-distributed-lock_600811?utm_source=chatgpt.com" title="Implementation Principles and Best Practices of Distributed ...">Alibaba Cloud</a>, <a href="https://etcd.io/docs/v3.5/learning/why/?utm_source=chatgpt.com" title="etcd versus other key-value stores">etcd</a>)</td></tr><tr><td>DB row-lock</td><td><code>SELECT FOR UPDATE</code> 또는 버전 CAS 기반</td><td>DB 내락 활용 간단 적용</td><td>다중 노드 간 확장 제한, 성능 병목 가능성</td></tr></tbody></table><h4 id=redis-기반-락-setnx--ttl--안전-해제>Redis 기반 락 (SETNX + TTL + 안전 해제)<a hidden class=anchor aria-hidden=true href=#redis-기반-락-setnx--ttl--안전-해제>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RedisLock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>key</span> <span class=o>=</span> <span class=n>key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ttl</span> <span class=o>=</span> <span class=n>ttl</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>retry_delay</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>end</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>ttl</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>retry_delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>            return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span class=line><span class=cl><span class=s2>        else
</span></span></span><span class=line><span class=cl><span class=s2>            return 0
</span></span></span><span class=line><span class=cl><span class=s2>        end
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=zookeeper-기반-락-kazooclient-활용>ZooKeeper 기반 락 (KazooClient 활용)<a hidden class=anchor aria-hidden=true href=#zookeeper-기반-락-kazooclient-활용>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a class=lnlinks href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a class=lnlinks href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a class=lnlinks href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a class=lnlinks href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a class=lnlinks href=#hl-5-26>26</a>
</span><span class=lnt id=hl-5-27><a class=lnlinks href=#hl-5-27>27</a>
</span><span class=lnt id=hl-5-28><a class=lnlinks href=#hl-5-28>28</a>
</span><span class=lnt id=hl-5-29><a class=lnlinks href=#hl-5-29>29</a>
</span><span class=lnt id=hl-5-30><a class=lnlinks href=#hl-5-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kazoo.client</span> <span class=kn>import</span> <span class=n>KazooClient</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ZkLock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>zk_hosts</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zk</span> <span class=o>=</span> <span class=n>KazooClient</span><span class=p>(</span><span class=n>hosts</span><span class=o>=</span><span class=n>zk_hosts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zk</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>root</span> <span class=o>=</span> <span class=n>path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>node</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cv</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Condition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>node</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>zk</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=si>}</span><span class=s2>/lock-&#34;</span><span class=p>,</span> <span class=n>ephemeral</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>sequence</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>children</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>zk</span><span class=o>.</span><span class=n>get_children</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>node</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>children</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>prev</span> <span class=o>=</span> <span class=n>children</span><span class=p>[</span><span class=n>children</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>node</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>prev_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>prev</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>zk</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>prev_path</span><span class=p>,</span> <span class=n>watch</span><span class=o>=</span><span class=k>lambda</span> <span class=n>e</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_wake</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_wake</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cv</span><span class=o>.</span><span class=n>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zk</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>node</span> <span class=o>=</span> <span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=etcd-기반-락-lease--transaction>Etcd 기반 락 (lease + transaction)<a hidden class=anchor aria-hidden=true href=#etcd-기반-락-lease--transaction>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>Etcd3</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;etcd3&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Etcd3</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>acquireLock</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>ttl</span> <span class=o>=</span> <span class=mi>30</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>lease</span> <span class=o>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>lease</span><span class=p>(</span><span class=nx>ttl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>txn</span> <span class=o>=</span> <span class=nx>client</span><span class=p>.</span><span class=k>if</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=s2>&#34;Create&#34;</span><span class=p>,</span> <span class=s2>&#34;=&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>client</span><span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=nx>key</span><span class=p>).</span><span class=nx>value</span><span class=p>(</span><span class=s2>&#34;locked&#34;</span><span class=p>).</span><span class=nx>lease</span><span class=p>(</span><span class=nx>lease</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>commit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>txn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>succeeded</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>lease</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;lost&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Lease lost&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>lease</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>lease</span><span class=p>.</span><span class=nx>revoke</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>releaseLock</span><span class=p>(</span><span class=nx>lease</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>lease</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>lease</span><span class=p>.</span><span class=nx>revoke</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=장점>장점<a hidden class=anchor aria-hidden=true href=#장점>#</a></h3><table><thead><tr><th>카테고리</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>데이터 무결성과 일관성</td><td>데이터 정합성 보장</td><td>동시 수정 방지, 원자성 확보, 트랜잭션 무결성 보장</td></tr><tr><td>동시성 제어 및 경합 방지</td><td>상호 배제, 경합 최소화</td><td>동시 접근 차단으로 작업 충돌 예방</td></tr><tr><td>장애 복구 및 내결함성</td><td>자동 해제 / TTL 기반 회복</td><td>클라이언트 실패 시 자동 락 해제 및 대기자에게 이전</td></tr><tr><td>장애 복구 및 내결함성</td><td>고가용성 / 내결함성</td><td>다중 인스턴스, 과반 합의 등으로 서비스 연속성 유지</td></tr><tr><td>확장성 및 유연성</td><td>수평 확장 / 클러스터 대응</td><td>시스템 부하 증가 시 노드 추가로 성능 확장 가능</td></tr><tr><td>개발 생산성과 투명성</td><td>API 추상화, 다양한 라이브러리 지원</td><td>분산 락 처리의 복잡성을 간단한 API 로 캡슐화</td></tr><tr><td>공정성 및 자원 분배</td><td>FIFO, 우선순위 락 할당</td><td>큐 기반 대기 구조로 공정하게 자원 분배 가능</td></tr><tr><td>운영 관찰성 및 정책 제어</td><td>상태 추적, 이벤트 로그, 정책 기반 제어</td><td>락 상태를 기반으로 SLA 추적 및 설정 가능</td></tr></tbody></table><ul><li><p><strong>데이터 무결성과 일관성</strong> 측면에서 분산 락은 동시 수정이나 경합으로 인한 데이터 손상을 방지하며 트랜잭션 일관성을 유지하는 핵심 기법이다.</p></li><li><p><strong>동시성 제어 및 충돌 회피</strong>는 분산 환경에서 작업의 예측 가능성과 정확성을 높인다.</p></li><li><p><strong>자동 복구와 장애 내성</strong>은 TTL, 세션 종료, 리더 선출 등을 통해 무중단 회복을 가능케 한다.</p></li><li><p><strong>확장성</strong>은 클러스터 기반 수평 확장 구조에서 필수이며, 대규모 시스템에서도 유연한 적용이 가능하다.</p></li><li><p><strong>API 추상화 및 오픈소스 생태계</strong> 덕분에 개발 생산성이 높고 다양한 환경에서 재사용이 가능하다.</p></li><li><p>**공정한 분배 구조 (FIFO 등)**는 선점 우선순위나 대기자 처리를 명확히 함으로써 리소스 관리에 신뢰성을 더한다.</p></li><li><p><strong>관찰 가능성과 정책 통제</strong>는 운영 중 발생 가능한 문제의 추적 및 SLA 기반의 제어를 지원하여 실무 적용성을 강화한다.</p></li></ul><h3 id=12-단점과-문제점-그리고-해결방안>12. 단점과 문제점 그리고 해결방안<a hidden class=anchor aria-hidden=true href=#12-단점과-문제점-그리고-해결방안>#</a></h3><h4 id=단점>단점<a hidden class=anchor aria-hidden=true href=#단점>#</a></h4><table><thead><tr><th>카테고리</th><th>항목</th><th>설명</th><th>해결책</th></tr></thead><tbody><tr><td>네트워크 기반 제약</td><td>네트워크 지연/파티션</td><td>분산 락은 네트워크 품질에 의존, 지연 발생 시 성능 저하</td><td>로컬 캐싱, 지역 클러스터 구성, 비동기 처리 도입</td></tr><tr><td>시간 동기화 문제</td><td>클럭 스큐 / Clock Drift</td><td>TTL 기반 락 시스템에서 시계 차이로 잘못된 만료 시간 계산</td><td>NTP, 논리적 시계, Hybrid Logical Clock, 펜싱 토큰</td></tr><tr><td>성능 및 리소스 오버헤드</td><td>성능 병목</td><td>락 요청 집중 시 락 서버 병목 발생</td><td>락 세분화, 읽기 - 쓰기 분리, 리더 선출, Sharding</td></tr><tr><td>구현/운영 복잡성</td><td>복잡한 설계/운영 구조</td><td>락 유지, 타임아웃, 세션 추적 등 설계와 모니터링 복잡도 증가</td><td>검증된 라이브러리 (Curator, etc.), 추상화 계층 도입</td></tr><tr><td>가용성 트레이드오프</td><td>합의 기반의 일관성 유지</td><td>강한 일관성 모델 적용 시 가용성이 떨어질 수 있음</td><td>결과적 일관성 모델, fallback 대응</td></tr><tr><td>인프라 의존성</td><td>락 서비스 단일 장애점</td><td>락 서버 장애 시 전체 시스템에 영향</td><td>Redlock, Zookeeper quorum, 다중 노드 구성</td></tr></tbody></table><ul><li>분산 락 시스템은 네트워크 지연, 시계 동기화 실패, 락 서버 병목 등 다양한 인프라 의존성과 성능 병목을 동반한다.</li><li>구현과 운영이 복잡하여 잘못된 설계는 오히려 시스템 장애를 유발할 수 있으며, 신중한 툴 선택과 테스트가 필수이다.</li><li>가용성과 일관성 사이에서 트레이드오프가 발생하며, 시스템 특성에 맞는 선택이 필요하다.</li></ul><h4 id=문제점>문제점<a hidden class=anchor aria-hidden=true href=#문제점>#</a></h4><table><thead><tr><th>카테고리</th><th>항목</th><th>원인</th><th>영향</th><th>탐지 및 진단</th><th>예방 방법</th><th>해결 방법</th></tr></thead><tbody><tr><td>동기화 실패 및 충돌</td><td>Deadlock</td><td>순환 대기 락, 락 순서 불일치</td><td>응답 지연, 시스템 정지</td><td>락 의존성 그래프, 타임아웃</td><td>락 순서 강제, 타임아웃 설정</td><td>데드락 탐지 알고리즘, Watchdog</td></tr><tr><td>자원 고착</td><td>Zombie Lock</td><td>TTL 만료 전 클라이언트 다운 등으로 락 해제 실패</td><td>자원 고착</td><td>세션 모니터링, Heartbeat</td><td>TTL, heartbeat 유지</td><td>세션 종료 시 강제 해제</td></tr><tr><td>공정성 문제</td><td>Starvation</td><td>높은 경쟁 환경에서 특정 클라이언트 기회 상실</td><td>특정 프로세스 무한 대기</td><td>대기 시간 모니터링</td><td>우선순위 기반 큐, 공정한 큐잉</td><td>Priority Queue, 랜덤 백오프 적용</td></tr><tr><td>시간/TTL 오작동</td><td>Clock Drift</td><td>클럭 차이로 TTL 해석 오류</td><td>락 순서 오류, 중복 실행 가능성</td><td>타임스탬프 비교 실패 감지</td><td>논리적 시계, 시간 동기화 강화</td><td>Vector Clock, 펜싱 메커니즘</td></tr><tr><td>네트워크 분할</td><td>Split-Brain</td><td>파티션으로 인한 락 중복 획득</td><td>일관성 위반, 데이터 손상 위험</td><td>클러스터 상태 모니터링</td><td>Quorum 기반 동기화</td><td>Fencing Token, 상태 동기화 재설정</td></tr><tr><td>대량 요청/과부하 이슈</td><td>Thundering Herd</td><td>TTL 종료 후 다수 클라이언트가 동시에 요청 시도</td><td>서버 부하 증가, 시스템 지연</td><td>요청 패턴 분석, 로깅</td><td>Rate Limiter, Exponential Backoff 적용</td><td>Jittered Retry, 분산 리더 구조 도입</td></tr></tbody></table><ul><li>분산 락의 주요 문제는 Deadlock, 자원 고착, Starvation, 스플릿 브레인 등 시스템 동기화 실패로부터 유발된다.</li><li>네트워크, 클럭, 프로세스 크래시 등 다양한 요소가 복합적으로 작용하여 문제를 발생시키므로 다중 레벨의 대응 전략이 필요하다.</li><li>예방적 설계 (락 순서, TTL, heartbeat) 와 탐지 메커니즘 (모니터링, 로그 분석, 그래프 추적) 이 반드시 병행되어야 한다.</li></ul><h3 id=도전-과제>도전 과제<a hidden class=anchor aria-hidden=true href=#도전-과제>#</a></h3><table><thead><tr><th>카테고리</th><th>항목</th><th>원인</th><th>영향</th><th>탐지/진단</th><th>예방 방법</th><th>해결/대응 기법</th></tr></thead><tbody><tr><td>네트워크 분할 / CAP</td><td>Split‑Brain</td><td>통신 단절, quorum 부족</td><td>동시 락 획득, 일관성 위반</td><td>quorum 실패, 로그 이상징후</td><td>quorum 모델 기반 락, 리더 선출</td><td>TTL 만료 후 재획득, 펜싱 검증, 리더 선출</td></tr><tr><td>시계 동기화 (Clock Skew)</td><td>Clock Skew</td><td>노드 간 시간 불일치</td><td>TTL 오작동, stale 요청</td><td>로그 timestamp 비교</td><td>NTP/GPS 동기화, 논리 클록, fencing token 활용</td><td>Lamport timestamp, TTL 여유 확보, 시간 기반 방지</td></tr><tr><td>데드락 / 락 오버홀드</td><td>Lock Hold Too Long</td><td>긴 작업, 버그, 갱신 미갱신</td><td>자원 차단, 작업 지연</td><td>heartbeat 미갱신 감지</td><td>타이머 기반 갱신, grace 기간 설정</td><td>강제 해제 정책, 모니터링 기반 자동 해제</td></tr><tr><td>성능 병목 / 경합</td><td>고경합 / Busy Loop</td><td>다수 클라이언트 동시에 락 시도</td><td>지연↑, 처리율 저하</td><td>대기 큐 길이/응답 시간 모니터링</td><td>backoff + jitter, 샤딩, 임계영역 최소화</td><td>exponential backoff, priority queue, 락 분할 적용</td></tr><tr><td>관찰 가능성 & 운영 정책</td><td>Observability 부족</td><td>락 이벤트 미수집, 로그 부재</td><td>장애 분석 어려움, SLA 추적 불가</td><td>메트릭 부재, 이벤트 누락</td><td>구조화된 로깅, Distributed Tracing, 정책 기반 경보 설정</td><td>대시보드, 알림 시스템 구축, 정책 기반 자동 제어</td></tr></tbody></table><ul><li><p><strong>네트워크 분할 & CAP 이슈</strong>는 quorum 기반 설계를 통해 split‑brain 시나리오를 예방하고, 펜싱/리더 선출로 일관성을 유지해야 한다.</p></li><li><p><strong>Clock Skew</strong>는 TTL 오작동 및 stale 요청 유발의 원인이 되므로, NTP 동기화 또는 논리 시간 기반 설계를 통해 보완해야 한다.</p></li><li><p><strong>락 오버홀드</strong> 상황—긴 락 유지 또는 갱신 미갱신—은 자동 해제 정책과 Grace 기간 설정을 통해 해결할 수 있다.</p></li><li><p><strong>성능 병목</strong>은 과도한 락 경쟁에서 발생하며, exponential backoff 와 jitter 도입, 락 최소화 및 샤딩 전략으로 대응한다.</p></li><li><p><strong>관찰 가능성 부족</strong>은 장애 상황 분석과 SLA 보장에 문제를 일으킵니다. 이벤트 로깅, 트레이싱, 정책 기반 알림 체계를 도입해 운영 신뢰성을 확보해야 한다.</p></li></ul><h3 id=분류-기준에-따른-종류-및-유형>분류 기준에 따른 종류 및 유형<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-종류-및-유형>#</a></h3><table><thead><tr><th>분류 기준</th><th>주요 유형</th><th>설명</th></tr></thead><tbody><tr><td>아키텍처 유형</td><td>중앙 집중형 / 분산 합의 기반</td><td>단일 서버 또는 여러 노드 간의 합의 기반 구성</td></tr><tr><td>구현 방식</td><td>TTL 기반 / Session 기반 / Quorum 기반</td><td>TTL: 단순/속도, Session: 신뢰성, Quorum: 다수 노드 합의</td></tr><tr><td>저장소 기반</td><td>In-memory / Persistent / DB 기반</td><td>Redis, ZooKeeper, etcd, RDBMS 등 다양한 저장 방식</td></tr><tr><td>일관성 모델</td><td>강한 일관성 / 결과적 일관성 / 인과적 일관성</td><td>선형화 보장 vs 성능 우선 / 인과 관계 반영</td></tr><tr><td>락 타입</td><td>배타 락 / 공유 락 / 읽기 - 쓰기 락</td><td>접근 권한 제어 기준에 따른 분류</td></tr><tr><td>획득 방식</td><td>Blocking / Non-blocking</td><td>락 획득 시 대기 여부에 따라 구분</td></tr><tr><td>재진입성</td><td>재진입 가능 / 불가능</td><td>동일 클라이언트가 중복 락 획득 가능 여부</td></tr><tr><td>락 범위</td><td>전역 락 / 리소스 단위 락 / 객체 단위 락</td><td>전체 시스템, 특정 리소스 또는 개별 객체에 대한 제어</td></tr><tr><td>지속성 기반</td><td>영구 락 / 임시 락 / 세션 락</td><td>해제 방식: 명시적, TTL 기반, 세션 만료</td></tr><tr><td>기능 목적</td><td>뮤텍스 / 리더 선출 / 세마포어</td><td>단순 상호배제 외에도 분산 시스템에서 다양한 역할 수행 가능</td></tr></tbody></table><ul><li><p><strong>아키텍처 측면</strong>에서는 중앙 집중형은 단순하지만 SPOF 위험이 크며, 분산 합의형은 고가용성을 제공하지만 복잡도가 높다.</p></li><li><p><strong>구현 방식</strong>은 TTL 방식이 빠르지만 클럭 스큐에 취약하고, 세션 기반은 신뢰성이 높으나 과도한 상태 관리가 필요하다. Quorum 기반은 안정성과 확장성의 균형을 제공한다.</p></li><li><p><strong>저장소 기반</strong>은 Redis, etcd, ZooKeeper 등 각기 다른 특성과 성능 특화점을 가지며, 선택 시 목적과 환경에 따라 고려해야 한다.</p></li><li><p><strong>일관성 모델</strong>은 강한 일관성이 중요할 경우 ZooKeeper/etcd 를, 성능이 우선이라면 Redis 등을 고려할 수 있다.</p></li><li><p><strong>락 타입과 획득 방식</strong>은 시스템 처리량과 공정성에 영향을 주며, 논블로킹 방식은 Throughput 중심 환경에 적합하다.</p></li><li><p><strong>재진입성과 지속성</strong>은 락의 제어 범위와 예측 가능성에 영향을 주며, 복잡한 호출 관계에서는 재진입 락이 필수다.</p></li><li><p><strong>기능 목적</strong>으로는 단순한 Mutual Exclusion 외에도 리더 선출, 세마포어 기능까지 복합적으로 활용되며, 락 시스템을 선택할 때 요구사항을 명확히 파악하는 것이 중요하다.</p></li></ul><h3 id=실무-사용-예시>실무 사용 예시<a hidden class=anchor aria-hidden=true href=#실무-사용-예시>#</a></h3><table><thead><tr><th>카테고리</th><th>사용 목적</th><th>적용 기술</th><th>효과</th></tr></thead><tbody><tr><td>배치/잡 스케줄링</td><td>동일 잡의 중복 실행 방지</td><td>ZooKeeper, etcd, Redis</td><td>단일 실행 보장, 충돌 방지</td></tr><tr><td>전자상거래 주문 처리</td><td>재고 감소, 결제 중복 처리 방지</td><td>Redis Lock, Redlock, SETNX + TTL + Lua</td><td>데이터 정합성 확보, 이중 처리 방지</td></tr><tr><td>리더 선출 및 Coordination</td><td>마스터 노드 선출 및 고가용성 유지</td><td>etcd + Lease, Consul, Kubernetes</td><td>장애 발생 시 안정적 failover, 단일 책임</td></tr><tr><td>캐시 일관성 유지</td><td>캐시 동시 갱신 방지, 캐시 미스 보호</td><td>Redis, etcd, Redisson, TTL 기반 Lock</td><td>캐시 정합성 유지, 트래픽 안정화</td></tr><tr><td>설정 및 구성 관리</td><td>설정의 일관된 배포 및 변경 제어</td><td>Consul, etcd, Service Discovery</td><td>설정 오류 최소화, 서비스 안정성 확보</td></tr><tr><td>파일/리소스 동시 접근 제어</td><td>공유 파일, 로그, 배포 자원의 중복 접근 방지</td><td>NFS Lock, Distributed FS + Lock</td><td>충돌 방지, 자원 보호</td></tr><tr><td>데이터 마이그레이션 제어</td><td>스키마 변경 등 마이그레이션 단일 실행 보장</td><td>Redis + Migration Tool, Leader Election</td><td>중복 실행 방지, 데이터 무결성 유지</td></tr><tr><td>특수 목적 시스템</td><td>게임 점수 동기화, 거래 처리, IoT 명령 처리</td><td>Redis + TTL + Logical Clock, MQTT, DB Lock</td><td>순차 처리, 이중화 방지, 상태 보호</td></tr></tbody></table><ul><li><p><strong>배치/잡 스케줄링</strong>: 분산 환경에서 동일 잡이 여러 노드에서 동시에 실행되지 않도록 제어하여 안정성과 중복 방지를 달성함.</p></li><li><p><strong>전자상거래 주문 처리</strong>: 사용자 경험 및 재고 정합성 확보를 위해 Redis 락 기반으로 동시 주문 충돌을 방지함.</p></li><li><p><strong>리더 선출 및 Coordination</strong>: 고가용성 유지 및 장애 전환을 위한 핵심 전략으로, lease 및 fencing 기법과 함께 적용됨.</p></li><li><p><strong>캐시 일관성 유지</strong>: TTL 기반 락과 재진입 불가 락을 통해 갱신 충돌을 방지하며, 고성능 시스템에서 특히 중요함.</p></li><li><p><strong>설정 및 구성 관리</strong>: 마이크로서비스에서의 일관된 구성 배포를 위해 Consul, etcd 와 락 연동이 필수적임.</p></li><li><p><strong>파일/리소스 동시 접근 제어</strong>: 로그나 리소스 파일에 대한 병렬 작업 충돌을 방지하여 정합성과 처리 순서를 보장함.</p></li><li><p><strong>데이터 마이그레이션 제어</strong>: 중복된 마이그레이션 실행을 방지하여 데이터 손실과 충돌을 예방함.</p></li><li><p><strong>특수 목적 시스템</strong>: 게임, 금융, IoT 등 시간 민감적이거나 실시간 데이터 동기화가 필요한 환경에서 락을 통해 예측 가능한 처리를 가능하게 함.</p></li></ul><h3 id=다양한-락-구현체-비교-분석>다양한 락 구현체 비교 분석<a hidden class=anchor aria-hidden=true href=#다양한-락-구현체-비교-분석>#</a></h3><table><thead><tr><th>구현체</th><th>기반</th><th>특징</th><th>장단점</th><th>주요 활용</th></tr></thead><tbody><tr><td>Redis Redlock</td><td>Redis Cluster</td><td>TTL 기반 빠른 락, 단일 키</td><td>구현 쉬움, 강한 일관성 부족</td><td>API Rate Limit, short task</td></tr><tr><td>ZooKeeper Lock</td><td>ZAB 프로토콜</td><td>Ephemeral + Sequential zNode</td><td>안정성 높음, 느린 편</td><td>순차 작업, 리더 선출</td></tr><tr><td>etcd Lock</td><td>Raft + lease 기반</td><td>TTL lease 방식</td><td>구현 단순, 성능 안정적</td><td>마이크로서비스 coordination</td></tr><tr><td>Consul Session Lock</td><td>KV + session 기반</td><td>세션 유지 필요</td><td>성능 우수, 복잡도 중간</td><td>서비스 디스커버리</td></tr><tr><td>PostgreSQL Advisory Lock</td><td>DB native</td><td>트랜잭션 내 advisory lock</td><td>DB 의존, 신뢰성 높음</td><td>스크립트 락, 작업 예약</td></tr><tr><td>Hazelcast Lock</td><td>분산 메모리 기반</td><td>Java-centric, cluster-wide</td><td>JVM 내 통합 유리</td><td>분산 캐시 락</td></tr><tr><td>DynamoDB Conditional Write</td><td>NoSQL 기반</td><td>락 없는 락 (Compare & Set)</td><td>고가용성, eventual</td><td>서버리스 환경, SaaS backend</td></tr></tbody></table><h3 id=활용-사례>활용 사례<a hidden class=anchor aria-hidden=true href=#활용-사례>#</a></h3><h4 id=사례-1-redis-distributed-lock-을-활용한-전자상거래-결제-중복-처리-방지>사례 1: Redis Distributed Lock 을 활용한 전자상거래 결제 중복 처리 방지<a hidden class=anchor aria-hidden=true href=#사례-1-redis-distributed-lock-을-활용한-전자상거래-결제-중복-처리-방지>#</a></h4><p><strong>사례</strong>: Redis Distributed Lock 을 활용한 전자상거래 결제 중복 처리 방지</p><p><strong>구성</strong>: 프론트엔드 → 백엔드 (마이크로서비스 인스턴스) → Redis(락서버) → DB</p><p><strong>워크플로우</strong>:</p><ol><li>주문 발생 시 결제 로직 진입 전 Redis 에 " 주문번호 " 로 락 시도 (SET NX)</li><li>락 성공 시에만 결제, 제품 차감, 주문 완료 작업 진행</li><li>모든 작업 완료 후 REDIS 락 해제</li><li>락 획득 실패 시 다른 인스턴스는 주문 거절 및 에러 반환</li></ol><pre class=mermaid>sequenceDiagram
    participant User
    participant App1
    participant Redis
    participant DB

    User-&gt;&gt;App1: 주문 요청
    App1-&gt;&gt;Redis: SET order:123 lock NX PX=5000
    Redis--&gt;&gt;App1: OK
    App1-&gt;&gt;DB: 결제 처리
    App1-&gt;&gt;Redis: DEL order:123 lock
    App1--&gt;&gt;User: 주문 완료 응답

    Note over App1,Redis: 주문번호별 락 발생, 단일 인스턴스만 처리
</pre><ul><li>락 없으면 Race Condition 등 장애/이슈 발생</li></ul><p><strong>역할</strong>: 하나의 주문번호에 대해 단일 인스턴스만 처리, 데이터 오염 방지</p><p><strong>구현 예시</strong>: Python, Redis 사용</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DistributedLock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_url</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>expiry</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=n>redis_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span> <span class=o>=</span> <span class=n>lock_key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>expiry</span> <span class=o>=</span> <span class=n>expiry</span>  <span class=c1># 락 TTL(초)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>  <span class=c1># 고유 토큰</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># SET NX PX=5000: 이미 락이 있으면 실패</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>token</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>expiry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span> <span class=ow>is</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 조건부 DEL: 내 토큰일 때만 락 해제 (다른 인스턴스가 실수로 DEL 방지)</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>r</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=p>)</span>  <span class=c1># 현재 락 소유자 확인</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span> <span class=ow>and</span> <span class=n>value</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>r</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>DistributedLock</span><span class=p>(</span><span class=s2>&#34;redis://localhost:6379&#34;</span><span class=p>,</span> <span class=s2>&#34;order:lock:123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 결제 및 주문 로직(단일 실행 보장)</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;다른 노드가 락을 선점하여 주문 처리 거절&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>NX(비존재시에만 셋), EX(TTL), 소유토큰 유지, 메서드 분리</li></ul><h4 id=사례-2-분산-스케줄러>사례 2: 분산 스케줄러<a hidden class=anchor aria-hidden=true href=#사례-2-분산-스케줄러>#</a></h4><p><strong>시나리오</strong>: 분산 스케줄러가 매 분 실행되는데, 단일 인스턴스만 실행하게끔 락을 사용</p><p><strong>시스템 구성</strong>:</p><ul><li>ZooKeeper ensemble</li><li>다수 scheduler 인스턴스</li><li>락 경로 <code>/locks/jobA</code></li></ul><pre class=mermaid>graph TD
  subgraph Schedulers
    A[Scheduler A]
    B[Scheduler B]
  end

  subgraph ZooKeeper Ensemble
    Z1[ZK1]
    Z2[ZK2]
    Z3[ZK3]
  end

  A --&gt;|acquire lock| Z1
  B --&gt;|acquire lock| Z2
</pre><p><strong>Workflow</strong>:</p><ul><li>각 인스턴스 락 요청 → ZooKeeper 에 sequential zNode 생성 → 가장 낮은 순번만 실행</li><li>실행 후 zNode 삭제 → 다음 순번 실행</li></ul><p><strong>역할</strong>:</p><ul><li>ZooKeeper: 락 관리 및 큐잉</li><li>Scheduler: 락 요청 → 작업 실행 → 해제</li></ul><p><strong>유무 차이</strong>:</p><ul><li>락 없을 경우 다중 인스턴스 동시 실행 → 중복 작업 및 자원 낭비</li></ul><p><strong>구현 예시 (Python, kazoo)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kazoo.client</span> <span class=kn>import</span> <span class=n>KazooClient</span>
</span></span><span class=line><span class=cl><span class=n>zk</span><span class=o>=</span><span class=n>KazooClient</span><span class=p>(</span><span class=n>hosts</span><span class=o>=</span><span class=s1>&#39;127.0.0.1:2181&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>zk</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>zk</span><span class=o>.</span><span class=n>Lock</span><span class=p>(</span><span class=s2>&#34;/locks/jobA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>run_job</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>zk</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-3-전자상거래-플랫폼의-재고-관리>사례 3: 전자상거래 플랫폼의 재고 관리<a hidden class=anchor aria-hidden=true href=#사례-3-전자상거래-플랫폼의-재고-관리>#</a></h4><p><strong>시나리오</strong>: 대규모 전자상거래 플랫폼의 플래시 세일 이벤트 재고 관리</p><p><strong>시스템 구성</strong>:</p><ul><li>웹 애플리케이션 서버 클러스터 (10 대)</li><li>Redis 클러스터 (분산 락 서비스)</li><li>MySQL 마스터 - 슬레이브 (재고 데이터)</li><li>로드 밸런서 및 CDN</li></ul><pre class=mermaid>graph TB
    subgraph &#34;사용자&#34;
        U1[사용자 1]
        U2[사용자 2]
        U3[사용자 N]
    end
    
    subgraph &#34;프론트엔드&#34;
        LB[로드 밸런서]
        CDN[CDN]
    end
    
    subgraph &#34;애플리케이션 계층&#34;
        WS1[웹서버 1]
        WS2[웹서버 2]
        WS3[웹서버 N]
    end
    
    subgraph &#34;분산 락 클러스터&#34;
        R1[Redis 마스터 1]
        R2[Redis 마스터 2]
        R3[Redis 마스터 3]
    end
    
    subgraph &#34;데이터 계층&#34;
        DB1[MySQL 마스터]
        DB2[MySQL 슬레이브]
    end
    
    U1 --&gt; LB
    U2 --&gt; LB
    U3 --&gt; LB
    LB --&gt; WS1
    LB --&gt; WS2
    LB --&gt; WS3
    
    WS1 --&gt; R1
    WS1 --&gt; R2
    WS1 --&gt; R3
    WS2 --&gt; R1
    WS2 --&gt; R2
    WS2 --&gt; R3
    WS3 --&gt; R1
    WS3 --&gt; R2
    WS3 --&gt; R3
    
    WS1 --&gt; DB1
    WS2 --&gt; DB1
    WS3 --&gt; DB1
    DB1 --&gt; DB2
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 상품 구매 요청 전송</li><li>로드 밸런서가 요청을 웹서버로 라우팅</li><li>웹서버가 상품별 분산 락 획득 시도</li><li>락 획득 성공 시 재고 확인 및 차감</li><li>데이터베이스에 주문 정보 저장</li><li>락 해제 및 사용자에게 결과 응답</li></ol><p><strong>역할</strong>:</p><ul><li><strong>분산 락</strong>: 동일 상품에 대한 동시 주문 방지</li><li><strong>Redis 클러스터</strong>: 고가용성 락 서비스 제공</li><li><strong>펜싱 토큰</strong>: 지연된 요청으로 인한 오버셀링 방지</li><li><strong>TTL 메커니즘</strong>: 장애 상황에서 자동 락 해제</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>분산 락 적용 시</strong>: 정확한 재고 관리, 오버셀링 방지, 데이터 일관성 보장</li><li><strong>분산 락 미적용 시</strong>: 경쟁 상태 발생, 재고 부족 상품 중복 판매, 고객 불만 및 손실</li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>  1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>  2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>  3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>  4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>  5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>  6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>  7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8>  8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9>  9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10> 10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11> 11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12> 12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13> 13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14> 14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15> 15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16> 16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17> 17</a>
</span><span class=lnt id=hl-12-18><a class=lnlinks href=#hl-12-18> 18</a>
</span><span class=lnt id=hl-12-19><a class=lnlinks href=#hl-12-19> 19</a>
</span><span class=lnt id=hl-12-20><a class=lnlinks href=#hl-12-20> 20</a>
</span><span class=lnt id=hl-12-21><a class=lnlinks href=#hl-12-21> 21</a>
</span><span class=lnt id=hl-12-22><a class=lnlinks href=#hl-12-22> 22</a>
</span><span class=lnt id=hl-12-23><a class=lnlinks href=#hl-12-23> 23</a>
</span><span class=lnt id=hl-12-24><a class=lnlinks href=#hl-12-24> 24</a>
</span><span class=lnt id=hl-12-25><a class=lnlinks href=#hl-12-25> 25</a>
</span><span class=lnt id=hl-12-26><a class=lnlinks href=#hl-12-26> 26</a>
</span><span class=lnt id=hl-12-27><a class=lnlinks href=#hl-12-27> 27</a>
</span><span class=lnt id=hl-12-28><a class=lnlinks href=#hl-12-28> 28</a>
</span><span class=lnt id=hl-12-29><a class=lnlinks href=#hl-12-29> 29</a>
</span><span class=lnt id=hl-12-30><a class=lnlinks href=#hl-12-30> 30</a>
</span><span class=lnt id=hl-12-31><a class=lnlinks href=#hl-12-31> 31</a>
</span><span class=lnt id=hl-12-32><a class=lnlinks href=#hl-12-32> 32</a>
</span><span class=lnt id=hl-12-33><a class=lnlinks href=#hl-12-33> 33</a>
</span><span class=lnt id=hl-12-34><a class=lnlinks href=#hl-12-34> 34</a>
</span><span class=lnt id=hl-12-35><a class=lnlinks href=#hl-12-35> 35</a>
</span><span class=lnt id=hl-12-36><a class=lnlinks href=#hl-12-36> 36</a>
</span><span class=lnt id=hl-12-37><a class=lnlinks href=#hl-12-37> 37</a>
</span><span class=lnt id=hl-12-38><a class=lnlinks href=#hl-12-38> 38</a>
</span><span class=lnt id=hl-12-39><a class=lnlinks href=#hl-12-39> 39</a>
</span><span class=lnt id=hl-12-40><a class=lnlinks href=#hl-12-40> 40</a>
</span><span class=lnt id=hl-12-41><a class=lnlinks href=#hl-12-41> 41</a>
</span><span class=lnt id=hl-12-42><a class=lnlinks href=#hl-12-42> 42</a>
</span><span class=lnt id=hl-12-43><a class=lnlinks href=#hl-12-43> 43</a>
</span><span class=lnt id=hl-12-44><a class=lnlinks href=#hl-12-44> 44</a>
</span><span class=lnt id=hl-12-45><a class=lnlinks href=#hl-12-45> 45</a>
</span><span class=lnt id=hl-12-46><a class=lnlinks href=#hl-12-46> 46</a>
</span><span class=lnt id=hl-12-47><a class=lnlinks href=#hl-12-47> 47</a>
</span><span class=lnt id=hl-12-48><a class=lnlinks href=#hl-12-48> 48</a>
</span><span class=lnt id=hl-12-49><a class=lnlinks href=#hl-12-49> 49</a>
</span><span class=lnt id=hl-12-50><a class=lnlinks href=#hl-12-50> 50</a>
</span><span class=lnt id=hl-12-51><a class=lnlinks href=#hl-12-51> 51</a>
</span><span class=lnt id=hl-12-52><a class=lnlinks href=#hl-12-52> 52</a>
</span><span class=lnt id=hl-12-53><a class=lnlinks href=#hl-12-53> 53</a>
</span><span class=lnt id=hl-12-54><a class=lnlinks href=#hl-12-54> 54</a>
</span><span class=lnt id=hl-12-55><a class=lnlinks href=#hl-12-55> 55</a>
</span><span class=lnt id=hl-12-56><a class=lnlinks href=#hl-12-56> 56</a>
</span><span class=lnt id=hl-12-57><a class=lnlinks href=#hl-12-57> 57</a>
</span><span class=lnt id=hl-12-58><a class=lnlinks href=#hl-12-58> 58</a>
</span><span class=lnt id=hl-12-59><a class=lnlinks href=#hl-12-59> 59</a>
</span><span class=lnt id=hl-12-60><a class=lnlinks href=#hl-12-60> 60</a>
</span><span class=lnt id=hl-12-61><a class=lnlinks href=#hl-12-61> 61</a>
</span><span class=lnt id=hl-12-62><a class=lnlinks href=#hl-12-62> 62</a>
</span><span class=lnt id=hl-12-63><a class=lnlinks href=#hl-12-63> 63</a>
</span><span class=lnt id=hl-12-64><a class=lnlinks href=#hl-12-64> 64</a>
</span><span class=lnt id=hl-12-65><a class=lnlinks href=#hl-12-65> 65</a>
</span><span class=lnt id=hl-12-66><a class=lnlinks href=#hl-12-66> 66</a>
</span><span class=lnt id=hl-12-67><a class=lnlinks href=#hl-12-67> 67</a>
</span><span class=lnt id=hl-12-68><a class=lnlinks href=#hl-12-68> 68</a>
</span><span class=lnt id=hl-12-69><a class=lnlinks href=#hl-12-69> 69</a>
</span><span class=lnt id=hl-12-70><a class=lnlinks href=#hl-12-70> 70</a>
</span><span class=lnt id=hl-12-71><a class=lnlinks href=#hl-12-71> 71</a>
</span><span class=lnt id=hl-12-72><a class=lnlinks href=#hl-12-72> 72</a>
</span><span class=lnt id=hl-12-73><a class=lnlinks href=#hl-12-73> 73</a>
</span><span class=lnt id=hl-12-74><a class=lnlinks href=#hl-12-74> 74</a>
</span><span class=lnt id=hl-12-75><a class=lnlinks href=#hl-12-75> 75</a>
</span><span class=lnt id=hl-12-76><a class=lnlinks href=#hl-12-76> 76</a>
</span><span class=lnt id=hl-12-77><a class=lnlinks href=#hl-12-77> 77</a>
</span><span class=lnt id=hl-12-78><a class=lnlinks href=#hl-12-78> 78</a>
</span><span class=lnt id=hl-12-79><a class=lnlinks href=#hl-12-79> 79</a>
</span><span class=lnt id=hl-12-80><a class=lnlinks href=#hl-12-80> 80</a>
</span><span class=lnt id=hl-12-81><a class=lnlinks href=#hl-12-81> 81</a>
</span><span class=lnt id=hl-12-82><a class=lnlinks href=#hl-12-82> 82</a>
</span><span class=lnt id=hl-12-83><a class=lnlinks href=#hl-12-83> 83</a>
</span><span class=lnt id=hl-12-84><a class=lnlinks href=#hl-12-84> 84</a>
</span><span class=lnt id=hl-12-85><a class=lnlinks href=#hl-12-85> 85</a>
</span><span class=lnt id=hl-12-86><a class=lnlinks href=#hl-12-86> 86</a>
</span><span class=lnt id=hl-12-87><a class=lnlinks href=#hl-12-87> 87</a>
</span><span class=lnt id=hl-12-88><a class=lnlinks href=#hl-12-88> 88</a>
</span><span class=lnt id=hl-12-89><a class=lnlinks href=#hl-12-89> 89</a>
</span><span class=lnt id=hl-12-90><a class=lnlinks href=#hl-12-90> 90</a>
</span><span class=lnt id=hl-12-91><a class=lnlinks href=#hl-12-91> 91</a>
</span><span class=lnt id=hl-12-92><a class=lnlinks href=#hl-12-92> 92</a>
</span><span class=lnt id=hl-12-93><a class=lnlinks href=#hl-12-93> 93</a>
</span><span class=lnt id=hl-12-94><a class=lnlinks href=#hl-12-94> 94</a>
</span><span class=lnt id=hl-12-95><a class=lnlinks href=#hl-12-95> 95</a>
</span><span class=lnt id=hl-12-96><a class=lnlinks href=#hl-12-96> 96</a>
</span><span class=lnt id=hl-12-97><a class=lnlinks href=#hl-12-97> 97</a>
</span><span class=lnt id=hl-12-98><a class=lnlinks href=#hl-12-98> 98</a>
</span><span class=lnt id=hl-12-99><a class=lnlinks href=#hl-12-99> 99</a>
</span><span class=lnt id=hl-12-100><a class=lnlinks href=#hl-12-100>100</a>
</span><span class=lnt id=hl-12-101><a class=lnlinks href=#hl-12-101>101</a>
</span><span class=lnt id=hl-12-102><a class=lnlinks href=#hl-12-102>102</a>
</span><span class=lnt id=hl-12-103><a class=lnlinks href=#hl-12-103>103</a>
</span><span class=lnt id=hl-12-104><a class=lnlinks href=#hl-12-104>104</a>
</span><span class=lnt id=hl-12-105><a class=lnlinks href=#hl-12-105>105</a>
</span><span class=lnt id=hl-12-106><a class=lnlinks href=#hl-12-106>106</a>
</span><span class=lnt id=hl-12-107><a class=lnlinks href=#hl-12-107>107</a>
</span><span class=lnt id=hl-12-108><a class=lnlinks href=#hl-12-108>108</a>
</span><span class=lnt id=hl-12-109><a class=lnlinks href=#hl-12-109>109</a>
</span><span class=lnt id=hl-12-110><a class=lnlinks href=#hl-12-110>110</a>
</span><span class=lnt id=hl-12-111><a class=lnlinks href=#hl-12-111>111</a>
</span><span class=lnt id=hl-12-112><a class=lnlinks href=#hl-12-112>112</a>
</span><span class=lnt id=hl-12-113><a class=lnlinks href=#hl-12-113>113</a>
</span><span class=lnt id=hl-12-114><a class=lnlinks href=#hl-12-114>114</a>
</span><span class=lnt id=hl-12-115><a class=lnlinks href=#hl-12-115>115</a>
</span><span class=lnt id=hl-12-116><a class=lnlinks href=#hl-12-116>116</a>
</span><span class=lnt id=hl-12-117><a class=lnlinks href=#hl-12-117>117</a>
</span><span class=lnt id=hl-12-118><a class=lnlinks href=#hl-12-118>118</a>
</span><span class=lnt id=hl-12-119><a class=lnlinks href=#hl-12-119>119</a>
</span><span class=lnt id=hl-12-120><a class=lnlinks href=#hl-12-120>120</a>
</span><span class=lnt id=hl-12-121><a class=lnlinks href=#hl-12-121>121</a>
</span><span class=lnt id=hl-12-122><a class=lnlinks href=#hl-12-122>122</a>
</span><span class=lnt id=hl-12-123><a class=lnlinks href=#hl-12-123>123</a>
</span><span class=lnt id=hl-12-124><a class=lnlinks href=#hl-12-124>124</a>
</span><span class=lnt id=hl-12-125><a class=lnlinks href=#hl-12-125>125</a>
</span><span class=lnt id=hl-12-126><a class=lnlinks href=#hl-12-126>126</a>
</span><span class=lnt id=hl-12-127><a class=lnlinks href=#hl-12-127>127</a>
</span><span class=lnt id=hl-12-128><a class=lnlinks href=#hl-12-128>128</a>
</span><span class=lnt id=hl-12-129><a class=lnlinks href=#hl-12-129>129</a>
</span><span class=lnt id=hl-12-130><a class=lnlinks href=#hl-12-130>130</a>
</span><span class=lnt id=hl-12-131><a class=lnlinks href=#hl-12-131>131</a>
</span><span class=lnt id=hl-12-132><a class=lnlinks href=#hl-12-132>132</a>
</span><span class=lnt id=hl-12-133><a class=lnlinks href=#hl-12-133>133</a>
</span><span class=lnt id=hl-12-134><a class=lnlinks href=#hl-12-134>134</a>
</span><span class=lnt id=hl-12-135><a class=lnlinks href=#hl-12-135>135</a>
</span><span class=lnt id=hl-12-136><a class=lnlinks href=#hl-12-136>136</a>
</span><span class=lnt id=hl-12-137><a class=lnlinks href=#hl-12-137>137</a>
</span><span class=lnt id=hl-12-138><a class=lnlinks href=#hl-12-138>138</a>
</span><span class=lnt id=hl-12-139><a class=lnlinks href=#hl-12-139>139</a>
</span><span class=lnt id=hl-12-140><a class=lnlinks href=#hl-12-140>140</a>
</span><span class=lnt id=hl-12-141><a class=lnlinks href=#hl-12-141>141</a>
</span><span class=lnt id=hl-12-142><a class=lnlinks href=#hl-12-142>142</a>
</span><span class=lnt id=hl-12-143><a class=lnlinks href=#hl-12-143>143</a>
</span><span class=lnt id=hl-12-144><a class=lnlinks href=#hl-12-144>144</a>
</span><span class=lnt id=hl-12-145><a class=lnlinks href=#hl-12-145>145</a>
</span><span class=lnt id=hl-12-146><a class=lnlinks href=#hl-12-146>146</a>
</span><span class=lnt id=hl-12-147><a class=lnlinks href=#hl-12-147>147</a>
</span><span class=lnt id=hl-12-148><a class=lnlinks href=#hl-12-148>148</a>
</span><span class=lnt id=hl-12-149><a class=lnlinks href=#hl-12-149>149</a>
</span><span class=lnt id=hl-12-150><a class=lnlinks href=#hl-12-150>150</a>
</span><span class=lnt id=hl-12-151><a class=lnlinks href=#hl-12-151>151</a>
</span><span class=lnt id=hl-12-152><a class=lnlinks href=#hl-12-152>152</a>
</span><span class=lnt id=hl-12-153><a class=lnlinks href=#hl-12-153>153</a>
</span><span class=lnt id=hl-12-154><a class=lnlinks href=#hl-12-154>154</a>
</span><span class=lnt id=hl-12-155><a class=lnlinks href=#hl-12-155>155</a>
</span><span class=lnt id=hl-12-156><a class=lnlinks href=#hl-12-156>156</a>
</span><span class=lnt id=hl-12-157><a class=lnlinks href=#hl-12-157>157</a>
</span><span class=lnt id=hl-12-158><a class=lnlinks href=#hl-12-158>158</a>
</span><span class=lnt id=hl-12-159><a class=lnlinks href=#hl-12-159>159</a>
</span><span class=lnt id=hl-12-160><a class=lnlinks href=#hl-12-160>160</a>
</span><span class=lnt id=hl-12-161><a class=lnlinks href=#hl-12-161>161</a>
</span><span class=lnt id=hl-12-162><a class=lnlinks href=#hl-12-162>162</a>
</span><span class=lnt id=hl-12-163><a class=lnlinks href=#hl-12-163>163</a>
</span><span class=lnt id=hl-12-164><a class=lnlinks href=#hl-12-164>164</a>
</span><span class=lnt id=hl-12-165><a class=lnlinks href=#hl-12-165>165</a>
</span><span class=lnt id=hl-12-166><a class=lnlinks href=#hl-12-166>166</a>
</span><span class=lnt id=hl-12-167><a class=lnlinks href=#hl-12-167>167</a>
</span><span class=lnt id=hl-12-168><a class=lnlinks href=#hl-12-168>168</a>
</span><span class=lnt id=hl-12-169><a class=lnlinks href=#hl-12-169>169</a>
</span><span class=lnt id=hl-12-170><a class=lnlinks href=#hl-12-170>170</a>
</span><span class=lnt id=hl-12-171><a class=lnlinks href=#hl-12-171>171</a>
</span><span class=lnt id=hl-12-172><a class=lnlinks href=#hl-12-172>172</a>
</span><span class=lnt id=hl-12-173><a class=lnlinks href=#hl-12-173>173</a>
</span><span class=lnt id=hl-12-174><a class=lnlinks href=#hl-12-174>174</a>
</span><span class=lnt id=hl-12-175><a class=lnlinks href=#hl-12-175>175</a>
</span><span class=lnt id=hl-12-176><a class=lnlinks href=#hl-12-176>176</a>
</span><span class=lnt id=hl-12-177><a class=lnlinks href=#hl-12-177>177</a>
</span><span class=lnt id=hl-12-178><a class=lnlinks href=#hl-12-178>178</a>
</span><span class=lnt id=hl-12-179><a class=lnlinks href=#hl-12-179>179</a>
</span><span class=lnt id=hl-12-180><a class=lnlinks href=#hl-12-180>180</a>
</span><span class=lnt id=hl-12-181><a class=lnlinks href=#hl-12-181>181</a>
</span><span class=lnt id=hl-12-182><a class=lnlinks href=#hl-12-182>182</a>
</span><span class=lnt id=hl-12-183><a class=lnlinks href=#hl-12-183>183</a>
</span><span class=lnt id=hl-12-184><a class=lnlinks href=#hl-12-184>184</a>
</span><span class=lnt id=hl-12-185><a class=lnlinks href=#hl-12-185>185</a>
</span><span class=lnt id=hl-12-186><a class=lnlinks href=#hl-12-186>186</a>
</span><span class=lnt id=hl-12-187><a class=lnlinks href=#hl-12-187>187</a>
</span><span class=lnt id=hl-12-188><a class=lnlinks href=#hl-12-188>188</a>
</span><span class=lnt id=hl-12-189><a class=lnlinks href=#hl-12-189>189</a>
</span><span class=lnt id=hl-12-190><a class=lnlinks href=#hl-12-190>190</a>
</span><span class=lnt id=hl-12-191><a class=lnlinks href=#hl-12-191>191</a>
</span><span class=lnt id=hl-12-192><a class=lnlinks href=#hl-12-192>192</a>
</span><span class=lnt id=hl-12-193><a class=lnlinks href=#hl-12-193>193</a>
</span><span class=lnt id=hl-12-194><a class=lnlinks href=#hl-12-194>194</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FlashSaleInventoryManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_cluster_nodes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis_pools</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>redis_cluster_nodes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>redis_pools</span><span class=p>[</span><span class=n>node</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>ConnectionPool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>host</span><span class=o>=</span><span class=n>node</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>                <span class=n>port</span><span class=o>=</span><span class=n>node</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>max_connections</span><span class=o>=</span><span class=mi>20</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis_clients</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=p>:</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>connection_pool</span><span class=o>=</span><span class=n>pool</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>pool</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_pools</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire_product_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;제품별 분산 락 컨텍스트 매니저&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;flash_sale_lock:product:</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_value</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>ttl_ms</span> <span class=o>=</span> <span class=n>timeout</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Redlock 알고리즘 구현</span>
</span></span><span class=line><span class=cl>        <span class=n>acquired_locks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 모든 Redis 노드에서 락 획득 시도</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>client</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_clients</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>client</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>lock_value</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>px</span><span class=o>=</span><span class=n>ttl_ms</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>acquired_locks</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>name</span><span class=p>,</span> <span class=n>client</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>redis</span><span class=o>.</span><span class=n>RedisError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>elapsed_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=n>quorum</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>redis_clients</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 과반수 락 획득 및 시간 검증</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>acquired_locks</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>quorum</span> <span class=ow>and</span> <span class=n>elapsed_time</span> <span class=o>&lt;</span> <span class=n>ttl_ms</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>remaining_ttl</span> <span class=o>=</span> <span class=n>ttl_ms</span> <span class=o>-</span> <span class=n>elapsed_time</span>
</span></span><span class=line><span class=cl>                <span class=k>yield</span> <span class=n>lock_value</span><span class=p>,</span> <span class=n>remaining_ttl</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;락 획득 실패: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 락 해제 (Lua 스크립트로 안전한 해제)</span>
</span></span><span class=line><span class=cl>            <span class=n>release_script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>                return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span class=line><span class=cl><span class=s2>            else
</span></span></span><span class=line><span class=cl><span class=s2>                return 0
</span></span></span><span class=line><span class=cl><span class=s2>            end
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>client</span> <span class=ow>in</span> <span class=n>acquired_locks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>client</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>release_script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>lock_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>redis</span><span class=o>.</span><span class=n>RedisError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_flash_sale_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;플래시 세일 주문 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 분산 락으로 동시성 제어</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>acquire_product_lock</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>lock_token</span><span class=p>,</span> <span class=n>ttl</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 현재 재고 확인</span>
</span></span><span class=line><span class=cl>            <span class=n>current_inventory</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_inventory</span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_inventory</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;재고 부족&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;available&#34;</span><span class=p>:</span> <span class=n>current_inventory</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 재고 차감 및 주문 생성 (원자적 트랜잭션)</span>
</span></span><span class=line><span class=cl>            <span class=n>order_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_order_transaction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>lock_token</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 성공 로그 및 모니터링 메트릭</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>log_successful_order</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>lock_token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;주문 성공&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;주문 처리 실패&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_current_inventory</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;현재 재고 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># MySQL에서 재고 조회</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>get_db_connection</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;SELECT quantity FROM inventory WHERE product_id = </span><span class=si>%s</span><span class=s2> FOR UPDATE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>product_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>result</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_order_transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>fencing_token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;펜싱 토큰을 포함한 주문 트랜잭션&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>get_db_connection</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>autocommit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 펜싱 토큰 검증 (이전 토큰보다 새로운지 확인)</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;SELECT last_fencing_token FROM product_locks WHERE product_id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>product_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>last_token</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>last_token</span> <span class=ow>and</span> <span class=n>last_token</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>fencing_token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 재고 차감</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;UPDATE inventory SET quantity = quantity - </span><span class=si>%s</span><span class=s2> WHERE product_id = </span><span class=si>%s</span><span class=s2> AND quantity &gt;= </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>quantity</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>cursor</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 주문 생성</span>
</span></span><span class=line><span class=cl>                <span class=n>order_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;INSERT INTO orders (order_id, product_id, user_id, quantity, fencing_token, created_at) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, NOW())&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>fencing_token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 펜싱 토큰 업데이트</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;UPDATE product_locks SET last_fencing_token = </span><span class=si>%s</span><span class=s2> WHERE product_id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>fencing_token</span><span class=p>,</span> <span class=n>product_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_successful_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;성공 주문 로깅 및 메트릭&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s1>&#39;flash_sale&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 성공: product=</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, user=</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>, qty=</span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>, token=</span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 메트릭 전송 (예: Prometheus)</span>
</span></span><span class=line><span class=cl>        <span class=c1># metrics.increment(&#39;flash_sale_orders_total&#39;, tags={&#39;product_id&#39;: product_id})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_flash_sale_request</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;플래시 세일 요청 처리 핸들러&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>redis_nodes</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;redis1&#39;</span><span class=p>,</span> <span class=s1>&#39;host&#39;</span><span class=p>:</span> <span class=s1>&#39;redis1.internal&#39;</span><span class=p>,</span> <span class=s1>&#39;port&#39;</span><span class=p>:</span> <span class=mi>6379</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;redis2&#39;</span><span class=p>,</span> <span class=s1>&#39;host&#39;</span><span class=p>:</span> <span class=s1>&#39;redis2.internal&#39;</span><span class=p>,</span> <span class=s1>&#39;port&#39;</span><span class=p>:</span> <span class=mi>6379</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;redis3&#39;</span><span class=p>,</span> <span class=s1>&#39;host&#39;</span><span class=p>:</span> <span class=s1>&#39;redis3.internal&#39;</span><span class=p>,</span> <span class=s1>&#39;port&#39;</span><span class=p>:</span> <span class=mi>6379</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>inventory_manager</span> <span class=o>=</span> <span class=n>FlashSaleInventoryManager</span><span class=p>(</span><span class=n>redis_nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>inventory_manager</span><span class=o>.</span><span class=n>process_flash_sale_order</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>product_id</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;시스템 오류: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-4-대형-커머스-사이트에서-장바구니-주문>사례 4: 대형 커머스 사이트에서 장바구니 주문<a hidden class=anchor aria-hidden=true href=#사례-4-대형-커머스-사이트에서-장바구니-주문>#</a></h4><p><strong>시나리오</strong>: 대형 커머스 사이트에서 장바구니 주문 시 중복 결제 및 재고 감소 오류를 방지하기 위해 Redis 기반 RedLock 기법 적용</p><p><strong>시스템 구성</strong>:</p><ul><li>Web 서버 2 대, Redis 클러스터 3 대, 결제 백엔드</li></ul><pre class=mermaid>graph LR
    A[사용자] --&gt; B[Web 서버]
    B --&gt; C[Redis 클러스터]
    B --&gt; D[결제 백엔드]
    C --&gt; B
    D --&gt; B
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자 주문 요청</li><li>Web 서버가 Redis 에 락 요청</li><li>락 성공 시 결제 처리 진행</li><li>결제 완료 후 락 해제</li><li>락 실패 시 메시지 반환 (중복 결제 방지)</li></ol><p><strong>역할</strong>:</p><ul><li>Redis: 락 서비스, 중복 방지</li><li>Web 서버: 주문 처리 및 분산 락 관리</li><li>결제 백엔드: 결제/재고 로직 실행</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>유: 동일 주문 중복 결제/재고 감소 절대 불가</li><li>무: 경합 발생 시 두 번 결제, 재고 2 번 감소 가능 (심각한 장애 유발)</li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a class=lnlinks href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a class=lnlinks href=#hl-14-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>acquire_lock</span><span class=p>(</span><span class=n>redis_client</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>expire_time</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span> <span class=o>+</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>redis_client</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>expire_time</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 락 획득 성공</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>release_lock</span><span class=p>(</span><span class=n>redis_client</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_client</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span> <span class=c1># 락 해제</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 실사용 예시</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>StrictRedis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>acquire_lock</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=s2>&#34;order:lock:1234&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 결제 로직</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>release_lock</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=s2>&#34;order:lock:1234&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 이미 처리 중이므로 중복 방지</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;이미 결제 처리 중입니다.&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-5-멀티-노드로-구성된-스케줄링-시스템>사례 5: 멀티 노드로 구성된 스케줄링 시스템<a hidden class=anchor aria-hidden=true href=#사례-5-멀티-노드로-구성된-스케줄링-시스템>#</a></h4><p><strong>시나리오</strong>: 멀티 노드로 구성된 <strong>스케줄링 시스템</strong>에서 특정 배치 작업 (Job A) 을 <strong>동시에 하나의 노드만 실행하도록 제한</strong>해야 함.</p><p><strong>시스템 구성</strong>:</p><ul><li>3 개의 Scheduler 인스턴스</li><li>3 개의 ZooKeeper 노드 (Quorum 보장)</li><li>락 경로 <code>/locks/batch_job_A</code></li><li>각 인스턴스는 정해진 시간마다 락을 시도하고 성공한 인스턴스만 작업 수행</li></ul><pre class=mermaid>graph LR
  subgraph Cluster
    ZK1[ZooKeeper Node 1]
    ZK2[ZooKeeper Node 2]
    ZK3[ZooKeeper Node 3]
  end

  SchedulerA -- Acquire Lock --&gt; ZK1
  SchedulerA -- Acquire Lock --&gt; ZK2
  SchedulerA -- Acquire Lock --&gt; ZK3

  SchedulerB -- Acquire Lock --&gt; ZK1
  SchedulerC -- Acquire Lock --&gt; ZK2

  ZK1 -- Grant Lock --&gt; SchedulerA
  SchedulerA -- Run Batch Job --&gt; JobA[Job Executor]

  SchedulerB -- Wait/Fail --&gt; ZK2
  SchedulerC -- Wait/Fail --&gt; ZK3
</pre><p><strong>Workflow</strong>:</p><ol><li>각 스케줄러는 <code>/locks/batch_job_A</code> 에 <strong>ephemeral sequential zNode</strong>를 생성</li><li>가장 작은 시퀀스 값을 가진 클라이언트만 락을 획득</li><li>해당 클라이언트가 작업 실행 후 zNode 삭제</li><li>다음 시퀀스의 클라이언트가 락 획득 후 실행</li></ol><p><strong>역할</strong>:</p><ul><li>ZooKeeper: 락 노드 유지 및 세션 모니터링</li><li>Scheduler: 락 획득 → 작업 실행 → 락 해제</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li>락 미사용 시 → 동시 중복 실행 → 외부 시스템 또는 DB 에 중복 데이터 삽입</li><li>락 사용 시 → 하나의 인스턴스만 실행 → 동기화 보장</li></ul><p><strong>구현 예시 (Python - kazoo)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kazoo.client</span> <span class=kn>import</span> <span class=n>KazooClient</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kazoo.recipe.lock</span> <span class=kn>import</span> <span class=n>Lock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>zk</span> <span class=o>=</span> <span class=n>KazooClient</span><span class=p>(</span><span class=n>hosts</span><span class=o>=</span><span class=s1>&#39;zk1:2181,zk2:2181,zk3:2181&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>zk</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>Lock</span><span class=p>(</span><span class=n>zk</span><span class=p>,</span> <span class=s1>&#39;/locks/batch_job_A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>  <span class=c1># TTL 또는 timeout 설정</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Lock acquired, running job…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>run_batch_job</span><span class=p>()</span>  <span class=c1># 작업 실행</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Lock released.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Lock not acquired, skipping execution.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>zk</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-6-전자상거래-재고-관리-시스템>사례 6: 전자상거래 재고 관리 시스템<a hidden class=anchor aria-hidden=true href=#사례-6-전자상거래-재고-관리-시스템>#</a></h4><p><strong>시스템 구성</strong>:</p><pre class=mermaid>graph TB
    subgraph &#34;E-commerce Inventory System&#34;
        subgraph &#34;Client Layer&#34;
            W1[Web Server 1]
            W2[Web Server 2]
            W3[Web Server N]
        end
        
        subgraph &#34;Distributed Lock Service&#34;
            R1[Redis Master]
            R2[Redis Slave 1]
            R3[Redis Slave 2]
        end
        
        subgraph &#34;Business Logic&#34;
            IS[Inventory Service]
            OS[Order Service]
            PS[Payment Service]
        end
        
        subgraph &#34;Data Layer&#34;
            DB[(Inventory DB)]
            MQ[Message Queue]
        end
    end
    
    W1 --&gt;|order request| IS
    W2 --&gt;|order request| IS
    W3 --&gt;|order request| IS
    
    IS --&gt;|acquire lock| R1
    R1 --&gt;|replicate| R2
    R1 --&gt;|replicate| R3
    
    IS --&gt;|check/update| DB
    IS --&gt;|publish event| MQ
    
    MQ --&gt;|consume| OS
    MQ --&gt;|consume| PS
</pre><p><strong>워크플로우</strong>:</p><pre class=mermaid>sequenceDiagram
    participant U1 as User 1
    participant U2 as User 2
    participant IS as Inventory Service
    participant RL as Redis Lock
    participant DB as Inventory DB
    
    Note over U1, U2: 동시에 마지막 상품 주문
    
    U1-&gt;&gt;IS: order(product_id: 123, quantity: 1)
    U2-&gt;&gt;IS: order(product_id: 123, quantity: 1)
    
    IS-&gt;&gt;RL: acquire_lock(&#34;inventory:123&#34;)
    RL-&gt;&gt;IS: granted (token: 1001)
    
    IS-&gt;&gt;RL: acquire_lock(&#34;inventory:123&#34;)
    RL-&gt;&gt;IS: blocked (waiting)
    
    IS-&gt;&gt;DB: SELECT stock FROM inventory WHERE id=123
    DB-&gt;&gt;IS: stock: 1
    
    IS-&gt;&gt;IS: validate: 1 &gt;= 1 ✓
    IS-&gt;&gt;DB: UPDATE inventory SET stock=0 WHERE id=123
    
    IS-&gt;&gt;RL: release_lock(&#34;inventory:123&#34;)
    RL-&gt;&gt;IS: released
    
    RL-&gt;&gt;IS: granted (token: 1002) [for User 2]
    
    IS-&gt;&gt;DB: SELECT stock FROM inventory WHERE id=123
    DB-&gt;&gt;IS: stock: 0
    
    IS-&gt;&gt;IS: validate: 0 &gt;= 1 ✗
    IS-&gt;&gt;RL: release_lock(&#34;inventory:123&#34;)
    
    IS-&gt;&gt;U1: order_confirmed
    IS-&gt;&gt;U2: out_of_stock
</pre><p><strong>분산 잠금 유무에 따른 차이점</strong>:</p><ul><li><strong>잠금 없이 구현한 경우:</strong><ul><li>재고 확인과 차감 사이의 경쟁 조건 발생</li><li>음수 재고 가능성</li><li>과도한 판매로 인한 고객 불만</li></ul></li><li><strong>분산 잠금 적용한 경우:</strong><ul><li>원자적 재고 관리 보장</li><li>정확한 재고 수량 유지</li><li>고객 신뢰도 향상</li></ul></li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1>  1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2>  2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3>  3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4>  4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5>  5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6>  6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7>  7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8>  8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9>  9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10> 10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11> 11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12> 12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13> 13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14> 14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15> 15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16> 16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17> 17</a>
</span><span class=lnt id=hl-19-18><a class=lnlinks href=#hl-19-18> 18</a>
</span><span class=lnt id=hl-19-19><a class=lnlinks href=#hl-19-19> 19</a>
</span><span class=lnt id=hl-19-20><a class=lnlinks href=#hl-19-20> 20</a>
</span><span class=lnt id=hl-19-21><a class=lnlinks href=#hl-19-21> 21</a>
</span><span class=lnt id=hl-19-22><a class=lnlinks href=#hl-19-22> 22</a>
</span><span class=lnt id=hl-19-23><a class=lnlinks href=#hl-19-23> 23</a>
</span><span class=lnt id=hl-19-24><a class=lnlinks href=#hl-19-24> 24</a>
</span><span class=lnt id=hl-19-25><a class=lnlinks href=#hl-19-25> 25</a>
</span><span class=lnt id=hl-19-26><a class=lnlinks href=#hl-19-26> 26</a>
</span><span class=lnt id=hl-19-27><a class=lnlinks href=#hl-19-27> 27</a>
</span><span class=lnt id=hl-19-28><a class=lnlinks href=#hl-19-28> 28</a>
</span><span class=lnt id=hl-19-29><a class=lnlinks href=#hl-19-29> 29</a>
</span><span class=lnt id=hl-19-30><a class=lnlinks href=#hl-19-30> 30</a>
</span><span class=lnt id=hl-19-31><a class=lnlinks href=#hl-19-31> 31</a>
</span><span class=lnt id=hl-19-32><a class=lnlinks href=#hl-19-32> 32</a>
</span><span class=lnt id=hl-19-33><a class=lnlinks href=#hl-19-33> 33</a>
</span><span class=lnt id=hl-19-34><a class=lnlinks href=#hl-19-34> 34</a>
</span><span class=lnt id=hl-19-35><a class=lnlinks href=#hl-19-35> 35</a>
</span><span class=lnt id=hl-19-36><a class=lnlinks href=#hl-19-36> 36</a>
</span><span class=lnt id=hl-19-37><a class=lnlinks href=#hl-19-37> 37</a>
</span><span class=lnt id=hl-19-38><a class=lnlinks href=#hl-19-38> 38</a>
</span><span class=lnt id=hl-19-39><a class=lnlinks href=#hl-19-39> 39</a>
</span><span class=lnt id=hl-19-40><a class=lnlinks href=#hl-19-40> 40</a>
</span><span class=lnt id=hl-19-41><a class=lnlinks href=#hl-19-41> 41</a>
</span><span class=lnt id=hl-19-42><a class=lnlinks href=#hl-19-42> 42</a>
</span><span class=lnt id=hl-19-43><a class=lnlinks href=#hl-19-43> 43</a>
</span><span class=lnt id=hl-19-44><a class=lnlinks href=#hl-19-44> 44</a>
</span><span class=lnt id=hl-19-45><a class=lnlinks href=#hl-19-45> 45</a>
</span><span class=lnt id=hl-19-46><a class=lnlinks href=#hl-19-46> 46</a>
</span><span class=lnt id=hl-19-47><a class=lnlinks href=#hl-19-47> 47</a>
</span><span class=lnt id=hl-19-48><a class=lnlinks href=#hl-19-48> 48</a>
</span><span class=lnt id=hl-19-49><a class=lnlinks href=#hl-19-49> 49</a>
</span><span class=lnt id=hl-19-50><a class=lnlinks href=#hl-19-50> 50</a>
</span><span class=lnt id=hl-19-51><a class=lnlinks href=#hl-19-51> 51</a>
</span><span class=lnt id=hl-19-52><a class=lnlinks href=#hl-19-52> 52</a>
</span><span class=lnt id=hl-19-53><a class=lnlinks href=#hl-19-53> 53</a>
</span><span class=lnt id=hl-19-54><a class=lnlinks href=#hl-19-54> 54</a>
</span><span class=lnt id=hl-19-55><a class=lnlinks href=#hl-19-55> 55</a>
</span><span class=lnt id=hl-19-56><a class=lnlinks href=#hl-19-56> 56</a>
</span><span class=lnt id=hl-19-57><a class=lnlinks href=#hl-19-57> 57</a>
</span><span class=lnt id=hl-19-58><a class=lnlinks href=#hl-19-58> 58</a>
</span><span class=lnt id=hl-19-59><a class=lnlinks href=#hl-19-59> 59</a>
</span><span class=lnt id=hl-19-60><a class=lnlinks href=#hl-19-60> 60</a>
</span><span class=lnt id=hl-19-61><a class=lnlinks href=#hl-19-61> 61</a>
</span><span class=lnt id=hl-19-62><a class=lnlinks href=#hl-19-62> 62</a>
</span><span class=lnt id=hl-19-63><a class=lnlinks href=#hl-19-63> 63</a>
</span><span class=lnt id=hl-19-64><a class=lnlinks href=#hl-19-64> 64</a>
</span><span class=lnt id=hl-19-65><a class=lnlinks href=#hl-19-65> 65</a>
</span><span class=lnt id=hl-19-66><a class=lnlinks href=#hl-19-66> 66</a>
</span><span class=lnt id=hl-19-67><a class=lnlinks href=#hl-19-67> 67</a>
</span><span class=lnt id=hl-19-68><a class=lnlinks href=#hl-19-68> 68</a>
</span><span class=lnt id=hl-19-69><a class=lnlinks href=#hl-19-69> 69</a>
</span><span class=lnt id=hl-19-70><a class=lnlinks href=#hl-19-70> 70</a>
</span><span class=lnt id=hl-19-71><a class=lnlinks href=#hl-19-71> 71</a>
</span><span class=lnt id=hl-19-72><a class=lnlinks href=#hl-19-72> 72</a>
</span><span class=lnt id=hl-19-73><a class=lnlinks href=#hl-19-73> 73</a>
</span><span class=lnt id=hl-19-74><a class=lnlinks href=#hl-19-74> 74</a>
</span><span class=lnt id=hl-19-75><a class=lnlinks href=#hl-19-75> 75</a>
</span><span class=lnt id=hl-19-76><a class=lnlinks href=#hl-19-76> 76</a>
</span><span class=lnt id=hl-19-77><a class=lnlinks href=#hl-19-77> 77</a>
</span><span class=lnt id=hl-19-78><a class=lnlinks href=#hl-19-78> 78</a>
</span><span class=lnt id=hl-19-79><a class=lnlinks href=#hl-19-79> 79</a>
</span><span class=lnt id=hl-19-80><a class=lnlinks href=#hl-19-80> 80</a>
</span><span class=lnt id=hl-19-81><a class=lnlinks href=#hl-19-81> 81</a>
</span><span class=lnt id=hl-19-82><a class=lnlinks href=#hl-19-82> 82</a>
</span><span class=lnt id=hl-19-83><a class=lnlinks href=#hl-19-83> 83</a>
</span><span class=lnt id=hl-19-84><a class=lnlinks href=#hl-19-84> 84</a>
</span><span class=lnt id=hl-19-85><a class=lnlinks href=#hl-19-85> 85</a>
</span><span class=lnt id=hl-19-86><a class=lnlinks href=#hl-19-86> 86</a>
</span><span class=lnt id=hl-19-87><a class=lnlinks href=#hl-19-87> 87</a>
</span><span class=lnt id=hl-19-88><a class=lnlinks href=#hl-19-88> 88</a>
</span><span class=lnt id=hl-19-89><a class=lnlinks href=#hl-19-89> 89</a>
</span><span class=lnt id=hl-19-90><a class=lnlinks href=#hl-19-90> 90</a>
</span><span class=lnt id=hl-19-91><a class=lnlinks href=#hl-19-91> 91</a>
</span><span class=lnt id=hl-19-92><a class=lnlinks href=#hl-19-92> 92</a>
</span><span class=lnt id=hl-19-93><a class=lnlinks href=#hl-19-93> 93</a>
</span><span class=lnt id=hl-19-94><a class=lnlinks href=#hl-19-94> 94</a>
</span><span class=lnt id=hl-19-95><a class=lnlinks href=#hl-19-95> 95</a>
</span><span class=lnt id=hl-19-96><a class=lnlinks href=#hl-19-96> 96</a>
</span><span class=lnt id=hl-19-97><a class=lnlinks href=#hl-19-97> 97</a>
</span><span class=lnt id=hl-19-98><a class=lnlinks href=#hl-19-98> 98</a>
</span><span class=lnt id=hl-19-99><a class=lnlinks href=#hl-19-99> 99</a>
</span><span class=lnt id=hl-19-100><a class=lnlinks href=#hl-19-100>100</a>
</span><span class=lnt id=hl-19-101><a class=lnlinks href=#hl-19-101>101</a>
</span><span class=lnt id=hl-19-102><a class=lnlinks href=#hl-19-102>102</a>
</span><span class=lnt id=hl-19-103><a class=lnlinks href=#hl-19-103>103</a>
</span><span class=lnt id=hl-19-104><a class=lnlinks href=#hl-19-104>104</a>
</span><span class=lnt id=hl-19-105><a class=lnlinks href=#hl-19-105>105</a>
</span><span class=lnt id=hl-19-106><a class=lnlinks href=#hl-19-106>106</a>
</span><span class=lnt id=hl-19-107><a class=lnlinks href=#hl-19-107>107</a>
</span><span class=lnt id=hl-19-108><a class=lnlinks href=#hl-19-108>108</a>
</span><span class=lnt id=hl-19-109><a class=lnlinks href=#hl-19-109>109</a>
</span><span class=lnt id=hl-19-110><a class=lnlinks href=#hl-19-110>110</a>
</span><span class=lnt id=hl-19-111><a class=lnlinks href=#hl-19-111>111</a>
</span><span class=lnt id=hl-19-112><a class=lnlinks href=#hl-19-112>112</a>
</span><span class=lnt id=hl-19-113><a class=lnlinks href=#hl-19-113>113</a>
</span><span class=lnt id=hl-19-114><a class=lnlinks href=#hl-19-114>114</a>
</span><span class=lnt id=hl-19-115><a class=lnlinks href=#hl-19-115>115</a>
</span><span class=lnt id=hl-19-116><a class=lnlinks href=#hl-19-116>116</a>
</span><span class=lnt id=hl-19-117><a class=lnlinks href=#hl-19-117>117</a>
</span><span class=lnt id=hl-19-118><a class=lnlinks href=#hl-19-118>118</a>
</span><span class=lnt id=hl-19-119><a class=lnlinks href=#hl-19-119>119</a>
</span><span class=lnt id=hl-19-120><a class=lnlinks href=#hl-19-120>120</a>
</span><span class=lnt id=hl-19-121><a class=lnlinks href=#hl-19-121>121</a>
</span><span class=lnt id=hl-19-122><a class=lnlinks href=#hl-19-122>122</a>
</span><span class=lnt id=hl-19-123><a class=lnlinks href=#hl-19-123>123</a>
</span><span class=lnt id=hl-19-124><a class=lnlinks href=#hl-19-124>124</a>
</span><span class=lnt id=hl-19-125><a class=lnlinks href=#hl-19-125>125</a>
</span><span class=lnt id=hl-19-126><a class=lnlinks href=#hl-19-126>126</a>
</span><span class=lnt id=hl-19-127><a class=lnlinks href=#hl-19-127>127</a>
</span><span class=lnt id=hl-19-128><a class=lnlinks href=#hl-19-128>128</a>
</span><span class=lnt id=hl-19-129><a class=lnlinks href=#hl-19-129>129</a>
</span><span class=lnt id=hl-19-130><a class=lnlinks href=#hl-19-130>130</a>
</span><span class=lnt id=hl-19-131><a class=lnlinks href=#hl-19-131>131</a>
</span><span class=lnt id=hl-19-132><a class=lnlinks href=#hl-19-132>132</a>
</span><span class=lnt id=hl-19-133><a class=lnlinks href=#hl-19-133>133</a>
</span><span class=lnt id=hl-19-134><a class=lnlinks href=#hl-19-134>134</a>
</span><span class=lnt id=hl-19-135><a class=lnlinks href=#hl-19-135>135</a>
</span><span class=lnt id=hl-19-136><a class=lnlinks href=#hl-19-136>136</a>
</span><span class=lnt id=hl-19-137><a class=lnlinks href=#hl-19-137>137</a>
</span><span class=lnt id=hl-19-138><a class=lnlinks href=#hl-19-138>138</a>
</span><span class=lnt id=hl-19-139><a class=lnlinks href=#hl-19-139>139</a>
</span><span class=lnt id=hl-19-140><a class=lnlinks href=#hl-19-140>140</a>
</span><span class=lnt id=hl-19-141><a class=lnlinks href=#hl-19-141>141</a>
</span><span class=lnt id=hl-19-142><a class=lnlinks href=#hl-19-142>142</a>
</span><span class=lnt id=hl-19-143><a class=lnlinks href=#hl-19-143>143</a>
</span><span class=lnt id=hl-19-144><a class=lnlinks href=#hl-19-144>144</a>
</span><span class=lnt id=hl-19-145><a class=lnlinks href=#hl-19-145>145</a>
</span><span class=lnt id=hl-19-146><a class=lnlinks href=#hl-19-146>146</a>
</span><span class=lnt id=hl-19-147><a class=lnlinks href=#hl-19-147>147</a>
</span><span class=lnt id=hl-19-148><a class=lnlinks href=#hl-19-148>148</a>
</span><span class=lnt id=hl-19-149><a class=lnlinks href=#hl-19-149>149</a>
</span><span class=lnt id=hl-19-150><a class=lnlinks href=#hl-19-150>150</a>
</span><span class=lnt id=hl-19-151><a class=lnlinks href=#hl-19-151>151</a>
</span><span class=lnt id=hl-19-152><a class=lnlinks href=#hl-19-152>152</a>
</span><span class=lnt id=hl-19-153><a class=lnlinks href=#hl-19-153>153</a>
</span><span class=lnt id=hl-19-154><a class=lnlinks href=#hl-19-154>154</a>
</span><span class=lnt id=hl-19-155><a class=lnlinks href=#hl-19-155>155</a>
</span><span class=lnt id=hl-19-156><a class=lnlinks href=#hl-19-156>156</a>
</span><span class=lnt id=hl-19-157><a class=lnlinks href=#hl-19-157>157</a>
</span><span class=lnt id=hl-19-158><a class=lnlinks href=#hl-19-158>158</a>
</span><span class=lnt id=hl-19-159><a class=lnlinks href=#hl-19-159>159</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>InventoryManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;분산 잠금을 활용한 재고 관리 시스템&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>db_connection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db_connection</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>distributed_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>resource_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;분산 잠금 컨텍스트 매니저&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;inventory_lock:</span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>identifier</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 잠금 획득 시도</span>
</span></span><span class=line><span class=cl>        <span class=n>acquired</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>acquired</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_acquire_lock</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>identifier</span><span class=p>,</span> <span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>TimeoutError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to acquire lock for </span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock acquired for </span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2> with ID </span><span class=si>{</span><span class=n>identifier</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>identifier</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>acquired</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_release_lock</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>identifier</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock released for </span><span class=si>{</span><span class=n>resource_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_acquire_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>identifier</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Redis를 사용한 잠금 획득&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>end_time</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 30초 TTL로 잠금 설정</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>identifier</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.001</span><span class=p>)</span>  <span class=c1># 1ms 대기</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_release_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>identifier</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;안전한 잠금 해제&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># Lua 스크립트로 원자적 해제</span>
</span></span><span class=line><span class=cl>        <span class=n>release_script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>            return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span class=line><span class=cl><span class=s2>        else
</span></span></span><span class=line><span class=cl><span class=s2>            return 0
</span></span></span><span class=line><span class=cl><span class=s2>        end
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>bool</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>release_script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>identifier</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 처리 (분산 잠금 활용)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 제품별 분산 잠금 획득</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>distributed_lock</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span> <span class=k>as</span> <span class=n>lock_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 현재 재고 확인</span>
</span></span><span class=line><span class=cl>                <span class=n>current_stock</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_current_stock</span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>current_stock</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Insufficient stock. Available: </span><span class=si>{</span><span class=n>current_stock</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;lock_id&#34;</span><span class=p>:</span> <span class=n>lock_id</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 재고 차감 (원자적 연산)</span>
</span></span><span class=line><span class=cl>                <span class=n>updated_stock</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_update_stock</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=o>-</span><span class=n>quantity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 주문 기록 생성</span>
</span></span><span class=line><span class=cl>                <span class=n>order_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_order</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 성공 로그 기록</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=sa>f</span><span class=s2>&#34;Order processed successfully: &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=sa>f</span><span class=s2>&#34;order_id=</span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>, product_id=</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, &#34;</span>
</span></span><span class=line><span class=cl>                    <span class=sa>f</span><span class=s2>&#34;quantity=</span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>, remaining_stock=</span><span class=si>{</span><span class=n>updated_stock</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;remaining_stock&#34;</span><span class=p>:</span> <span class=n>updated_stock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;lock_id&#34;</span><span class=p>:</span> <span class=n>lock_id</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>TimeoutError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock timeout for product </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;System busy, please try again&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Order processing failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Internal error&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_current_stock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;현재 재고 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;SELECT stock_quantity FROM inventory WHERE product_id = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>product_id</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>result</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_update_stock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>delta</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;재고 업데이트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            UPDATE inventory 
</span></span></span><span class=line><span class=cl><span class=s2>            SET stock_quantity = stock_quantity + </span><span class=si>%s</span><span class=s2>,
</span></span></span><span class=line><span class=cl><span class=s2>                last_updated = NOW()
</span></span></span><span class=line><span class=cl><span class=s2>            WHERE product_id = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>            RETURNING stock_quantity
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>delta</span><span class=p>,</span> <span class=n>product_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>result</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_create_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ORD-</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span><span class=p>[:</span><span class=mi>8</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            INSERT INTO orders (order_id, product_id, quantity, customer_id, created_at)
</span></span></span><span class=line><span class=cl><span class=s2>            VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, NOW())
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Redis 및 DB 연결 설정</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>db_connection</span> <span class=o>=</span> <span class=n>get_database_connection</span><span class=p>()</span>  <span class=c1># 가상의 DB 연결 함수</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 재고 관리자 초기화</span>
</span></span><span class=line><span class=cl>    <span class=n>inventory_manager</span> <span class=o>=</span> <span class=n>InventoryManager</span><span class=p>(</span><span class=n>redis_client</span><span class=p>,</span> <span class=n>db_connection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 동시 주문 시나리오 테스트</span>
</span></span><span class=line><span class=cl>    <span class=n>result1</span> <span class=o>=</span> <span class=n>inventory_manager</span><span class=o>.</span><span class=n>process_order</span><span class=p>(</span><span class=s2>&#34;PHONE-123&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;customer-1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result2</span> <span class=o>=</span> <span class=n>inventory_manager</span><span class=o>.</span><span class=n>process_order</span><span class=p>(</span><span class=s2>&#34;PHONE-123&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;customer-2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Order 1 Result:&#34;</span><span class=p>,</span> <span class=n>result1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Order 2 Result:&#34;</span><span class=p>,</span> <span class=n>result2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=사례-7-워크-큐-경쟁-제거-rabbitmq--redis-lock>사례 7: 워크 큐 경쟁 제거 (RabbitMQ + Redis Lock)<a hidden class=anchor aria-hidden=true href=#사례-7-워크-큐-경쟁-제거-rabbitmq--redis-lock>#</a></h4><p><strong>구성</strong>: 여러 작업자 (Consumer) 가 대기 큐에서 동시 메시지 획득 시 Redis SETNX 로 선착순 락 생성</p><p><strong>Flow</strong>:</p><pre class=mermaid>sequenceDiagram
  participant C as Consumer
  participant R as Redis
  participant Q as RabbitMQQueue

  C-&gt;&gt;R: SETNX lock:item:ID
  alt SETNX 성공
    C-&gt;&gt;Q: ack &amp; process
    C-&gt;&gt;R: DEL lock:item:ID
  else SETNX 실패
    Note right of C: Retry later
  end
</pre><ul><li><strong>비교</strong>: 락 없이 RabbitMQ Ack 쓰면 처리 중복 발생 → 락으로 중복 방지 및 idempotency 확보</li></ul><p><strong>구현 예시</strong>: Python + Redis</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26>26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27>27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28>28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29>29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>redis_cli</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>lock_key</span> <span class=o>=</span> <span class=s2>&#34;lock:item:123&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>acquire_lock</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>redis_cli</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>token</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>release_lock</span><span class=p>(</span><span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>        return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span class=line><span class=cl><span class=s2>    else
</span></span></span><span class=line><span class=cl><span class=s2>        return 0
</span></span></span><span class=line><span class=cl><span class=s2>    end
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_cli</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=n>token</span> <span class=o>=</span> <span class=n>acquire_lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 공유 자원 작업</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>release_lock</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>특징</strong>: 안전한 release 보장 및 idempotent 한 락 관리가 가능.</li></ul><h4 id=사례-8-대규모-e-commerce-주문-처리-시스템>사례 8: 대규모 E-commerce 주문 처리 시스템<a hidden class=anchor aria-hidden=true href=#사례-8-대규모-e-commerce-주문-처리-시스템>#</a></h4><p><strong>시스템 구성:</strong></p><ul><li>로드 밸런서 뒤의 여러 애플리케이션 서버</li><li>Redis Cluster (분산 락 서버)</li><li>PostgreSQL 데이터베이스</li><li>RabbitMQ 메시지 큐</li></ul><pre class=mermaid>graph TB
    subgraph &#34;Client Layer&#34;
        U1[User 1]
        U2[User 2]
        U3[User N]
    end
    
    subgraph &#34;Application Layer&#34;
        LB[Load Balancer]
        AS1[App Server 1]
        AS2[App Server 2]
        AS3[App Server N]
    end
    
    subgraph &#34;Lock Layer&#34;
        RC[Redis Cluster]
        R1[Redis Node 1]
        R2[Redis Node 2]
        R3[Redis Node 3]
    end
    
    subgraph &#34;Data Layer&#34;
        DB[(PostgreSQL)]
        MQ[RabbitMQ]
    end
    
    U1 --&gt; LB
    U2 --&gt; LB
    U3 --&gt; LB
    LB --&gt; AS1
    LB --&gt; AS2
    LB --&gt; AS3
    
    AS1 --&gt; RC
    AS2 --&gt; RC
    AS3 --&gt; RC
    
    AS1 --&gt; DB
    AS2 --&gt; DB
    AS3 --&gt; DB
    
    AS1 --&gt; MQ
    AS2 --&gt; MQ
    AS3 --&gt; MQ
    
    RC --&gt; R1
    RC --&gt; R2
    RC --&gt; R3
</pre><p><strong>Workflow:</strong></p><ol><li>사용자 주문 요청 수신</li><li>재고 확인을 위한 상품별 락 획득 시도</li><li>락 획득 성공 시 재고 차감 및 주문 생성</li><li>결제 처리 및 락 해제</li><li>주문 완료 알림 및 후속 처리</li></ol><p><strong>분산 락의 역할:</strong></p><ul><li>동일 상품에 대한 동시 주문 시 재고 일관성 보장</li><li>재고 부족 상황에서 정확한 재고 관리</li><li>중복 결제 방지</li></ul><p><strong>분산 락 유무에 따른 차이점:</strong></p><ul><li><strong>분산 락 있음:</strong><ul><li>재고 정확성 100% 보장</li><li>오버셀링 방지</li><li>데이터 일관성 유지</li></ul></li><li><strong>분산 락 없음:</strong><ul><li>동시 접근으로 인한 재고 오류 발생</li><li>마이너스 재고 가능성</li><li>고객 불만 및 비즈니스 손실</li></ul></li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>  1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2>  2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3>  3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4>  4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5>  5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6>  6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7>  7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8>  8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9>  9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10> 10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11> 11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12> 12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13> 13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14> 14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15> 15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16> 16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17> 17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18> 18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19> 19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20> 20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21> 21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22> 22</a>
</span><span class=lnt id=hl-23-23><a class=lnlinks href=#hl-23-23> 23</a>
</span><span class=lnt id=hl-23-24><a class=lnlinks href=#hl-23-24> 24</a>
</span><span class=lnt id=hl-23-25><a class=lnlinks href=#hl-23-25> 25</a>
</span><span class=lnt id=hl-23-26><a class=lnlinks href=#hl-23-26> 26</a>
</span><span class=lnt id=hl-23-27><a class=lnlinks href=#hl-23-27> 27</a>
</span><span class=lnt id=hl-23-28><a class=lnlinks href=#hl-23-28> 28</a>
</span><span class=lnt id=hl-23-29><a class=lnlinks href=#hl-23-29> 29</a>
</span><span class=lnt id=hl-23-30><a class=lnlinks href=#hl-23-30> 30</a>
</span><span class=lnt id=hl-23-31><a class=lnlinks href=#hl-23-31> 31</a>
</span><span class=lnt id=hl-23-32><a class=lnlinks href=#hl-23-32> 32</a>
</span><span class=lnt id=hl-23-33><a class=lnlinks href=#hl-23-33> 33</a>
</span><span class=lnt id=hl-23-34><a class=lnlinks href=#hl-23-34> 34</a>
</span><span class=lnt id=hl-23-35><a class=lnlinks href=#hl-23-35> 35</a>
</span><span class=lnt id=hl-23-36><a class=lnlinks href=#hl-23-36> 36</a>
</span><span class=lnt id=hl-23-37><a class=lnlinks href=#hl-23-37> 37</a>
</span><span class=lnt id=hl-23-38><a class=lnlinks href=#hl-23-38> 38</a>
</span><span class=lnt id=hl-23-39><a class=lnlinks href=#hl-23-39> 39</a>
</span><span class=lnt id=hl-23-40><a class=lnlinks href=#hl-23-40> 40</a>
</span><span class=lnt id=hl-23-41><a class=lnlinks href=#hl-23-41> 41</a>
</span><span class=lnt id=hl-23-42><a class=lnlinks href=#hl-23-42> 42</a>
</span><span class=lnt id=hl-23-43><a class=lnlinks href=#hl-23-43> 43</a>
</span><span class=lnt id=hl-23-44><a class=lnlinks href=#hl-23-44> 44</a>
</span><span class=lnt id=hl-23-45><a class=lnlinks href=#hl-23-45> 45</a>
</span><span class=lnt id=hl-23-46><a class=lnlinks href=#hl-23-46> 46</a>
</span><span class=lnt id=hl-23-47><a class=lnlinks href=#hl-23-47> 47</a>
</span><span class=lnt id=hl-23-48><a class=lnlinks href=#hl-23-48> 48</a>
</span><span class=lnt id=hl-23-49><a class=lnlinks href=#hl-23-49> 49</a>
</span><span class=lnt id=hl-23-50><a class=lnlinks href=#hl-23-50> 50</a>
</span><span class=lnt id=hl-23-51><a class=lnlinks href=#hl-23-51> 51</a>
</span><span class=lnt id=hl-23-52><a class=lnlinks href=#hl-23-52> 52</a>
</span><span class=lnt id=hl-23-53><a class=lnlinks href=#hl-23-53> 53</a>
</span><span class=lnt id=hl-23-54><a class=lnlinks href=#hl-23-54> 54</a>
</span><span class=lnt id=hl-23-55><a class=lnlinks href=#hl-23-55> 55</a>
</span><span class=lnt id=hl-23-56><a class=lnlinks href=#hl-23-56> 56</a>
</span><span class=lnt id=hl-23-57><a class=lnlinks href=#hl-23-57> 57</a>
</span><span class=lnt id=hl-23-58><a class=lnlinks href=#hl-23-58> 58</a>
</span><span class=lnt id=hl-23-59><a class=lnlinks href=#hl-23-59> 59</a>
</span><span class=lnt id=hl-23-60><a class=lnlinks href=#hl-23-60> 60</a>
</span><span class=lnt id=hl-23-61><a class=lnlinks href=#hl-23-61> 61</a>
</span><span class=lnt id=hl-23-62><a class=lnlinks href=#hl-23-62> 62</a>
</span><span class=lnt id=hl-23-63><a class=lnlinks href=#hl-23-63> 63</a>
</span><span class=lnt id=hl-23-64><a class=lnlinks href=#hl-23-64> 64</a>
</span><span class=lnt id=hl-23-65><a class=lnlinks href=#hl-23-65> 65</a>
</span><span class=lnt id=hl-23-66><a class=lnlinks href=#hl-23-66> 66</a>
</span><span class=lnt id=hl-23-67><a class=lnlinks href=#hl-23-67> 67</a>
</span><span class=lnt id=hl-23-68><a class=lnlinks href=#hl-23-68> 68</a>
</span><span class=lnt id=hl-23-69><a class=lnlinks href=#hl-23-69> 69</a>
</span><span class=lnt id=hl-23-70><a class=lnlinks href=#hl-23-70> 70</a>
</span><span class=lnt id=hl-23-71><a class=lnlinks href=#hl-23-71> 71</a>
</span><span class=lnt id=hl-23-72><a class=lnlinks href=#hl-23-72> 72</a>
</span><span class=lnt id=hl-23-73><a class=lnlinks href=#hl-23-73> 73</a>
</span><span class=lnt id=hl-23-74><a class=lnlinks href=#hl-23-74> 74</a>
</span><span class=lnt id=hl-23-75><a class=lnlinks href=#hl-23-75> 75</a>
</span><span class=lnt id=hl-23-76><a class=lnlinks href=#hl-23-76> 76</a>
</span><span class=lnt id=hl-23-77><a class=lnlinks href=#hl-23-77> 77</a>
</span><span class=lnt id=hl-23-78><a class=lnlinks href=#hl-23-78> 78</a>
</span><span class=lnt id=hl-23-79><a class=lnlinks href=#hl-23-79> 79</a>
</span><span class=lnt id=hl-23-80><a class=lnlinks href=#hl-23-80> 80</a>
</span><span class=lnt id=hl-23-81><a class=lnlinks href=#hl-23-81> 81</a>
</span><span class=lnt id=hl-23-82><a class=lnlinks href=#hl-23-82> 82</a>
</span><span class=lnt id=hl-23-83><a class=lnlinks href=#hl-23-83> 83</a>
</span><span class=lnt id=hl-23-84><a class=lnlinks href=#hl-23-84> 84</a>
</span><span class=lnt id=hl-23-85><a class=lnlinks href=#hl-23-85> 85</a>
</span><span class=lnt id=hl-23-86><a class=lnlinks href=#hl-23-86> 86</a>
</span><span class=lnt id=hl-23-87><a class=lnlinks href=#hl-23-87> 87</a>
</span><span class=lnt id=hl-23-88><a class=lnlinks href=#hl-23-88> 88</a>
</span><span class=lnt id=hl-23-89><a class=lnlinks href=#hl-23-89> 89</a>
</span><span class=lnt id=hl-23-90><a class=lnlinks href=#hl-23-90> 90</a>
</span><span class=lnt id=hl-23-91><a class=lnlinks href=#hl-23-91> 91</a>
</span><span class=lnt id=hl-23-92><a class=lnlinks href=#hl-23-92> 92</a>
</span><span class=lnt id=hl-23-93><a class=lnlinks href=#hl-23-93> 93</a>
</span><span class=lnt id=hl-23-94><a class=lnlinks href=#hl-23-94> 94</a>
</span><span class=lnt id=hl-23-95><a class=lnlinks href=#hl-23-95> 95</a>
</span><span class=lnt id=hl-23-96><a class=lnlinks href=#hl-23-96> 96</a>
</span><span class=lnt id=hl-23-97><a class=lnlinks href=#hl-23-97> 97</a>
</span><span class=lnt id=hl-23-98><a class=lnlinks href=#hl-23-98> 98</a>
</span><span class=lnt id=hl-23-99><a class=lnlinks href=#hl-23-99> 99</a>
</span><span class=lnt id=hl-23-100><a class=lnlinks href=#hl-23-100>100</a>
</span><span class=lnt id=hl-23-101><a class=lnlinks href=#hl-23-101>101</a>
</span><span class=lnt id=hl-23-102><a class=lnlinks href=#hl-23-102>102</a>
</span><span class=lnt id=hl-23-103><a class=lnlinks href=#hl-23-103>103</a>
</span><span class=lnt id=hl-23-104><a class=lnlinks href=#hl-23-104>104</a>
</span><span class=lnt id=hl-23-105><a class=lnlinks href=#hl-23-105>105</a>
</span><span class=lnt id=hl-23-106><a class=lnlinks href=#hl-23-106>106</a>
</span><span class=lnt id=hl-23-107><a class=lnlinks href=#hl-23-107>107</a>
</span><span class=lnt id=hl-23-108><a class=lnlinks href=#hl-23-108>108</a>
</span><span class=lnt id=hl-23-109><a class=lnlinks href=#hl-23-109>109</a>
</span><span class=lnt id=hl-23-110><a class=lnlinks href=#hl-23-110>110</a>
</span><span class=lnt id=hl-23-111><a class=lnlinks href=#hl-23-111>111</a>
</span><span class=lnt id=hl-23-112><a class=lnlinks href=#hl-23-112>112</a>
</span><span class=lnt id=hl-23-113><a class=lnlinks href=#hl-23-113>113</a>
</span><span class=lnt id=hl-23-114><a class=lnlinks href=#hl-23-114>114</a>
</span><span class=lnt id=hl-23-115><a class=lnlinks href=#hl-23-115>115</a>
</span><span class=lnt id=hl-23-116><a class=lnlinks href=#hl-23-116>116</a>
</span><span class=lnt id=hl-23-117><a class=lnlinks href=#hl-23-117>117</a>
</span><span class=lnt id=hl-23-118><a class=lnlinks href=#hl-23-118>118</a>
</span><span class=lnt id=hl-23-119><a class=lnlinks href=#hl-23-119>119</a>
</span><span class=lnt id=hl-23-120><a class=lnlinks href=#hl-23-120>120</a>
</span><span class=lnt id=hl-23-121><a class=lnlinks href=#hl-23-121>121</a>
</span><span class=lnt id=hl-23-122><a class=lnlinks href=#hl-23-122>122</a>
</span><span class=lnt id=hl-23-123><a class=lnlinks href=#hl-23-123>123</a>
</span><span class=lnt id=hl-23-124><a class=lnlinks href=#hl-23-124>124</a>
</span><span class=lnt id=hl-23-125><a class=lnlinks href=#hl-23-125>125</a>
</span><span class=lnt id=hl-23-126><a class=lnlinks href=#hl-23-126>126</a>
</span><span class=lnt id=hl-23-127><a class=lnlinks href=#hl-23-127>127</a>
</span><span class=lnt id=hl-23-128><a class=lnlinks href=#hl-23-128>128</a>
</span><span class=lnt id=hl-23-129><a class=lnlinks href=#hl-23-129>129</a>
</span><span class=lnt id=hl-23-130><a class=lnlinks href=#hl-23-130>130</a>
</span><span class=lnt id=hl-23-131><a class=lnlinks href=#hl-23-131>131</a>
</span><span class=lnt id=hl-23-132><a class=lnlinks href=#hl-23-132>132</a>
</span><span class=lnt id=hl-23-133><a class=lnlinks href=#hl-23-133>133</a>
</span><span class=lnt id=hl-23-134><a class=lnlinks href=#hl-23-134>134</a>
</span><span class=lnt id=hl-23-135><a class=lnlinks href=#hl-23-135>135</a>
</span><span class=lnt id=hl-23-136><a class=lnlinks href=#hl-23-136>136</a>
</span><span class=lnt id=hl-23-137><a class=lnlinks href=#hl-23-137>137</a>
</span><span class=lnt id=hl-23-138><a class=lnlinks href=#hl-23-138>138</a>
</span><span class=lnt id=hl-23-139><a class=lnlinks href=#hl-23-139>139</a>
</span><span class=lnt id=hl-23-140><a class=lnlinks href=#hl-23-140>140</a>
</span><span class=lnt id=hl-23-141><a class=lnlinks href=#hl-23-141>141</a>
</span><span class=lnt id=hl-23-142><a class=lnlinks href=#hl-23-142>142</a>
</span><span class=lnt id=hl-23-143><a class=lnlinks href=#hl-23-143>143</a>
</span><span class=lnt id=hl-23-144><a class=lnlinks href=#hl-23-144>144</a>
</span><span class=lnt id=hl-23-145><a class=lnlinks href=#hl-23-145>145</a>
</span><span class=lnt id=hl-23-146><a class=lnlinks href=#hl-23-146>146</a>
</span><span class=lnt id=hl-23-147><a class=lnlinks href=#hl-23-147>147</a>
</span><span class=lnt id=hl-23-148><a class=lnlinks href=#hl-23-148>148</a>
</span><span class=lnt id=hl-23-149><a class=lnlinks href=#hl-23-149>149</a>
</span><span class=lnt id=hl-23-150><a class=lnlinks href=#hl-23-150>150</a>
</span><span class=lnt id=hl-23-151><a class=lnlinks href=#hl-23-151>151</a>
</span><span class=lnt id=hl-23-152><a class=lnlinks href=#hl-23-152>152</a>
</span><span class=lnt id=hl-23-153><a class=lnlinks href=#hl-23-153>153</a>
</span><span class=lnt id=hl-23-154><a class=lnlinks href=#hl-23-154>154</a>
</span><span class=lnt id=hl-23-155><a class=lnlinks href=#hl-23-155>155</a>
</span><span class=lnt id=hl-23-156><a class=lnlinks href=#hl-23-156>156</a>
</span><span class=lnt id=hl-23-157><a class=lnlinks href=#hl-23-157>157</a>
</span><span class=lnt id=hl-23-158><a class=lnlinks href=#hl-23-158>158</a>
</span><span class=lnt id=hl-23-159><a class=lnlinks href=#hl-23-159>159</a>
</span><span class=lnt id=hl-23-160><a class=lnlinks href=#hl-23-160>160</a>
</span><span class=lnt id=hl-23-161><a class=lnlinks href=#hl-23-161>161</a>
</span><span class=lnt id=hl-23-162><a class=lnlinks href=#hl-23-162>162</a>
</span><span class=lnt id=hl-23-163><a class=lnlinks href=#hl-23-163>163</a>
</span><span class=lnt id=hl-23-164><a class=lnlinks href=#hl-23-164>164</a>
</span><span class=lnt id=hl-23-165><a class=lnlinks href=#hl-23-165>165</a>
</span><span class=lnt id=hl-23-166><a class=lnlinks href=#hl-23-166>166</a>
</span><span class=lnt id=hl-23-167><a class=lnlinks href=#hl-23-167>167</a>
</span><span class=lnt id=hl-23-168><a class=lnlinks href=#hl-23-168>168</a>
</span><span class=lnt id=hl-23-169><a class=lnlinks href=#hl-23-169>169</a>
</span><span class=lnt id=hl-23-170><a class=lnlinks href=#hl-23-170>170</a>
</span><span class=lnt id=hl-23-171><a class=lnlinks href=#hl-23-171>171</a>
</span><span class=lnt id=hl-23-172><a class=lnlinks href=#hl-23-172>172</a>
</span><span class=lnt id=hl-23-173><a class=lnlinks href=#hl-23-173>173</a>
</span><span class=lnt id=hl-23-174><a class=lnlinks href=#hl-23-174>174</a>
</span><span class=lnt id=hl-23-175><a class=lnlinks href=#hl-23-175>175</a>
</span><span class=lnt id=hl-23-176><a class=lnlinks href=#hl-23-176>176</a>
</span><span class=lnt id=hl-23-177><a class=lnlinks href=#hl-23-177>177</a>
</span><span class=lnt id=hl-23-178><a class=lnlinks href=#hl-23-178>178</a>
</span><span class=lnt id=hl-23-179><a class=lnlinks href=#hl-23-179>179</a>
</span><span class=lnt id=hl-23-180><a class=lnlinks href=#hl-23-180>180</a>
</span><span class=lnt id=hl-23-181><a class=lnlinks href=#hl-23-181>181</a>
</span><span class=lnt id=hl-23-182><a class=lnlinks href=#hl-23-182>182</a>
</span><span class=lnt id=hl-23-183><a class=lnlinks href=#hl-23-183>183</a>
</span><span class=lnt id=hl-23-184><a class=lnlinks href=#hl-23-184>184</a>
</span><span class=lnt id=hl-23-185><a class=lnlinks href=#hl-23-185>185</a>
</span><span class=lnt id=hl-23-186><a class=lnlinks href=#hl-23-186>186</a>
</span><span class=lnt id=hl-23-187><a class=lnlinks href=#hl-23-187>187</a>
</span><span class=lnt id=hl-23-188><a class=lnlinks href=#hl-23-188>188</a>
</span><span class=lnt id=hl-23-189><a class=lnlinks href=#hl-23-189>189</a>
</span><span class=lnt id=hl-23-190><a class=lnlinks href=#hl-23-190>190</a>
</span><span class=lnt id=hl-23-191><a class=lnlinks href=#hl-23-191>191</a>
</span><span class=lnt id=hl-23-192><a class=lnlinks href=#hl-23-192>192</a>
</span><span class=lnt id=hl-23-193><a class=lnlinks href=#hl-23-193>193</a>
</span><span class=lnt id=hl-23-194><a class=lnlinks href=#hl-23-194>194</a>
</span><span class=lnt id=hl-23-195><a class=lnlinks href=#hl-23-195>195</a>
</span><span class=lnt id=hl-23-196><a class=lnlinks href=#hl-23-196>196</a>
</span><span class=lnt id=hl-23-197><a class=lnlinks href=#hl-23-197>197</a>
</span><span class=lnt id=hl-23-198><a class=lnlinks href=#hl-23-198>198</a>
</span><span class=lnt id=hl-23-199><a class=lnlinks href=#hl-23-199>199</a>
</span><span class=lnt id=hl-23-200><a class=lnlinks href=#hl-23-200>200</a>
</span><span class=lnt id=hl-23-201><a class=lnlinks href=#hl-23-201>201</a>
</span><span class=lnt id=hl-23-202><a class=lnlinks href=#hl-23-202>202</a>
</span><span class=lnt id=hl-23-203><a class=lnlinks href=#hl-23-203>203</a>
</span><span class=lnt id=hl-23-204><a class=lnlinks href=#hl-23-204>204</a>
</span><span class=lnt id=hl-23-205><a class=lnlinks href=#hl-23-205>205</a>
</span><span class=lnt id=hl-23-206><a class=lnlinks href=#hl-23-206>206</a>
</span><span class=lnt id=hl-23-207><a class=lnlinks href=#hl-23-207>207</a>
</span><span class=lnt id=hl-23-208><a class=lnlinks href=#hl-23-208>208</a>
</span><span class=lnt id=hl-23-209><a class=lnlinks href=#hl-23-209>209</a>
</span><span class=lnt id=hl-23-210><a class=lnlinks href=#hl-23-210>210</a>
</span><span class=lnt id=hl-23-211><a class=lnlinks href=#hl-23-211>211</a>
</span><span class=lnt id=hl-23-212><a class=lnlinks href=#hl-23-212>212</a>
</span><span class=lnt id=hl-23-213><a class=lnlinks href=#hl-23-213>213</a>
</span><span class=lnt id=hl-23-214><a class=lnlinks href=#hl-23-214>214</a>
</span><span class=lnt id=hl-23-215><a class=lnlinks href=#hl-23-215>215</a>
</span><span class=lnt id=hl-23-216><a class=lnlinks href=#hl-23-216>216</a>
</span><span class=lnt id=hl-23-217><a class=lnlinks href=#hl-23-217>217</a>
</span><span class=lnt id=hl-23-218><a class=lnlinks href=#hl-23-218>218</a>
</span><span class=lnt id=hl-23-219><a class=lnlinks href=#hl-23-219>219</a>
</span><span class=lnt id=hl-23-220><a class=lnlinks href=#hl-23-220>220</a>
</span><span class=lnt id=hl-23-221><a class=lnlinks href=#hl-23-221>221</a>
</span><span class=lnt id=hl-23-222><a class=lnlinks href=#hl-23-222>222</a>
</span><span class=lnt id=hl-23-223><a class=lnlinks href=#hl-23-223>223</a>
</span><span class=lnt id=hl-23-224><a class=lnlinks href=#hl-23-224>224</a>
</span><span class=lnt id=hl-23-225><a class=lnlinks href=#hl-23-225>225</a>
</span><span class=lnt id=hl-23-226><a class=lnlinks href=#hl-23-226>226</a>
</span><span class=lnt id=hl-23-227><a class=lnlinks href=#hl-23-227>227</a>
</span><span class=lnt id=hl-23-228><a class=lnlinks href=#hl-23-228>228</a>
</span><span class=lnt id=hl-23-229><a class=lnlinks href=#hl-23-229>229</a>
</span><span class=lnt id=hl-23-230><a class=lnlinks href=#hl-23-230>230</a>
</span><span class=lnt id=hl-23-231><a class=lnlinks href=#hl-23-231>231</a>
</span><span class=lnt id=hl-23-232><a class=lnlinks href=#hl-23-232>232</a>
</span><span class=lnt id=hl-23-233><a class=lnlinks href=#hl-23-233>233</a>
</span><span class=lnt id=hl-23-234><a class=lnlinks href=#hl-23-234>234</a>
</span><span class=lnt id=hl-23-235><a class=lnlinks href=#hl-23-235>235</a>
</span><span class=lnt id=hl-23-236><a class=lnlinks href=#hl-23-236>236</a>
</span><span class=lnt id=hl-23-237><a class=lnlinks href=#hl-23-237>237</a>
</span><span class=lnt id=hl-23-238><a class=lnlinks href=#hl-23-238>238</a>
</span><span class=lnt id=hl-23-239><a class=lnlinks href=#hl-23-239>239</a>
</span><span class=lnt id=hl-23-240><a class=lnlinks href=#hl-23-240>240</a>
</span><span class=lnt id=hl-23-241><a class=lnlinks href=#hl-23-241>241</a>
</span><span class=lnt id=hl-23-242><a class=lnlinks href=#hl-23-242>242</a>
</span><span class=lnt id=hl-23-243><a class=lnlinks href=#hl-23-243>243</a>
</span><span class=lnt id=hl-23-244><a class=lnlinks href=#hl-23-244>244</a>
</span><span class=lnt id=hl-23-245><a class=lnlinks href=#hl-23-245>245</a>
</span><span class=lnt id=hl-23-246><a class=lnlinks href=#hl-23-246>246</a>
</span><span class=lnt id=hl-23-247><a class=lnlinks href=#hl-23-247>247</a>
</span><span class=lnt id=hl-23-248><a class=lnlinks href=#hl-23-248>248</a>
</span><span class=lnt id=hl-23-249><a class=lnlinks href=#hl-23-249>249</a>
</span><span class=lnt id=hl-23-250><a class=lnlinks href=#hl-23-250>250</a>
</span><span class=lnt id=hl-23-251><a class=lnlinks href=#hl-23-251>251</a>
</span><span class=lnt id=hl-23-252><a class=lnlinks href=#hl-23-252>252</a>
</span><span class=lnt id=hl-23-253><a class=lnlinks href=#hl-23-253>253</a>
</span><span class=lnt id=hl-23-254><a class=lnlinks href=#hl-23-254>254</a>
</span><span class=lnt id=hl-23-255><a class=lnlinks href=#hl-23-255>255</a>
</span><span class=lnt id=hl-23-256><a class=lnlinks href=#hl-23-256>256</a>
</span><span class=lnt id=hl-23-257><a class=lnlinks href=#hl-23-257>257</a>
</span><span class=lnt id=hl-23-258><a class=lnlinks href=#hl-23-258>258</a>
</span><span class=lnt id=hl-23-259><a class=lnlinks href=#hl-23-259>259</a>
</span><span class=lnt id=hl-23-260><a class=lnlinks href=#hl-23-260>260</a>
</span><span class=lnt id=hl-23-261><a class=lnlinks href=#hl-23-261>261</a>
</span><span class=lnt id=hl-23-262><a class=lnlinks href=#hl-23-262>262</a>
</span><span class=lnt id=hl-23-263><a class=lnlinks href=#hl-23-263>263</a>
</span><span class=lnt id=hl-23-264><a class=lnlinks href=#hl-23-264>264</a>
</span><span class=lnt id=hl-23-265><a class=lnlinks href=#hl-23-265>265</a>
</span><span class=lnt id=hl-23-266><a class=lnlinks href=#hl-23-266>266</a>
</span><span class=lnt id=hl-23-267><a class=lnlinks href=#hl-23-267>267</a>
</span><span class=lnt id=hl-23-268><a class=lnlinks href=#hl-23-268>268</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 로깅 설정</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DistributedLock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Redis 기반 분산 락 구현&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>:</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                 <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>30</span><span class=p>,</span> <span class=n>blocking_timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        분산 락 초기화
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            redis_client: Redis 클라이언트 인스턴스
</span></span></span><span class=line><span class=cl><span class=s2>            lock_key: 락의 고유 키
</span></span></span><span class=line><span class=cl><span class=s2>            timeout: 락 유지 시간 (초)
</span></span></span><span class=line><span class=cl><span class=s2>            blocking_timeout: 락 획득 대기 시간 (초)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;lock:</span><span class=si>{</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>blocking_timeout</span> <span class=o>=</span> <span class=n>blocking_timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>identifier</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>  <span class=c1># 락 소유자 식별자</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>renewal_thread</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stop_renewal</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        락 획득 시도
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            bool: 락 획득 성공 여부
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>blocking_timeout</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>end_time</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># SET NX (Not Exists) + EX (Expire) 를 사용한 원자적 락 획득</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>identifier</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                             <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock acquired: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 락 갱신 스레드 시작</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_start_renewal_thread</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 짧은 대기 후 재시도</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to acquire lock: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>release</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        락 해제
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            bool: 락 해제 성공 여부
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 락 갱신 중지</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stop_renewal</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>renewal_thread</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>renewal_thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Lua 스크립트를 사용한 원자적 락 해제</span>
</span></span><span class=line><span class=cl>        <span class=c1># 자신이 소유한 락만 해제 가능</span>
</span></span><span class=line><span class=cl>        <span class=n>lua_script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        if redis.call(&#34;GET&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>            return redis.call(&#34;DEL&#34;, KEYS[1])
</span></span></span><span class=line><span class=cl><span class=s2>        else
</span></span></span><span class=line><span class=cl><span class=s2>            return 0
</span></span></span><span class=line><span class=cl><span class=s2>        end
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>lua_script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>identifier</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock released: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to release lock (not owner): </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_start_renewal_thread</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;락 갱신 스레드 시작&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stop_renewal</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>renewal_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_renew_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>renewal_thread</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>renewal_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_renew_lock</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        락 자동 갱신 (TTL의 1/3 주기로 갱신)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>renewal_interval</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_renewal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>renewal_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>stop_renewal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 락이 여전히 자신의 소유인지 확인하고 갱신</span>
</span></span><span class=line><span class=cl>            <span class=n>lua_script</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            if redis.call(&#34;GET&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span class=line><span class=cl><span class=s2>                return redis.call(&#34;EXPIRE&#34;, KEYS[1], ARGV[2])
</span></span></span><span class=line><span class=cl><span class=s2>            else
</span></span></span><span class=line><span class=cl><span class=s2>                return 0
</span></span></span><span class=line><span class=cl><span class=s2>            end
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>lua_script</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                   <span class=bp>self</span><span class=o>.</span><span class=n>identifier</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock renewed: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Lock renewal failed: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Context Manager 진입&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>acquire</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to acquire lock: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>lock_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_val</span><span class=p>,</span> <span class=n>exc_tb</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Context Manager 종료&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 서비스 - 분산 락을 활용한 재고 관리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>:</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>inventory</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 간단한 메모리 재고 관리</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 초기 재고 설정</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>inventory</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;product_001&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;product_002&#34;</span><span class=p>:</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;product_003&#34;</span><span class=p>:</span> <span class=mi>25</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                     <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        주문 처리 - 분산 락을 사용한 안전한 재고 차감
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            product_id: 상품 ID
</span></span></span><span class=line><span class=cl><span class=s2>            quantity: 주문 수량
</span></span></span><span class=line><span class=cl><span class=s2>            customer_id: 고객 ID
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            dict: 주문 처리 결과
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 상품별 락 키 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>lock_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;inventory:</span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 분산 락을 사용한 재고 처리</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>DistributedLock</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=p>,</span> <span class=n>lock_key</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing order: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, &#34;</span>
</span></span><span class=line><span class=cl>                          <span class=sa>f</span><span class=s2>&#34;quantity: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>, customer: </span><span class=si>{</span><span class=n>customer_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 현재 재고 확인</span>
</span></span><span class=line><span class=cl>                <span class=n>current_stock</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>inventory</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>current_stock</span> <span class=o>&lt;</span> <span class=n>quantity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Insufficient stock: </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>, &#34;</span>
</span></span><span class=line><span class=cl>                                 <span class=sa>f</span><span class=s2>&#34;available: </span><span class=si>{</span><span class=n>current_stock</span><span class=si>}</span><span class=s2>, requested: </span><span class=si>{</span><span class=n>quantity</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;재고 부족&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;available_stock&#34;</span><span class=p>:</span> <span class=n>current_stock</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 재고 차감 (실제로는 데이터베이스 업데이트)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>inventory</span><span class=p>[</span><span class=n>product_id</span><span class=p>]</span> <span class=o>-=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 주문 생성 로직 시뮬레이션</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>  <span class=c1># 데이터베이스 작업 시뮬레이션</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>order_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;ORDER_</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>customer_id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Order completed: </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>, &#34;</span>
</span></span><span class=line><span class=cl>                          <span class=sa>f</span><span class=s2>&#34;remaining stock: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>inventory</span><span class=p>[</span><span class=n>product_id</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;product_id&#34;</span><span class=p>:</span> <span class=n>product_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=n>quantity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;remaining_stock&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>inventory</span><span class=p>[</span><span class=n>product_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>RuntimeError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to acquire lock for </span><span class=si>{</span><span class=n>product_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;시스템 오류 - 락 획득 실패&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Order processing error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;주문 처리 오류: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_inventory_status</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;현재 재고 상태 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>inventory</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시 및 테스트</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>demo_distributed_locking</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;분산 락킹 데모&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== Distributed Locking Demo ===</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Redis 연결</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                              <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 주문 서비스 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>order_service</span> <span class=o>=</span> <span class=n>OrderService</span><span class=p>(</span><span class=n>redis_client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;초기 재고 상태:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>order_service</span><span class=o>.</span><span class=n>get_inventory_status</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 동시 주문 시뮬레이션</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>simulate_order</span><span class=p>(</span><span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 시뮬레이션 함수&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>order_service</span><span class=o>.</span><span class=n>process_order</span><span class=p>(</span><span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Customer </span><span class=si>{</span><span class=n>customer_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 여러 스레드로 동시 주문 테스트</span>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 동일 상품에 대한 동시 주문</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=o>=</span><span class=n>simulate_order</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s2>&#34;product_001&#34;</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;CUST_</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>03d</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>thread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;동시 주문 처리 시작…&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 모든 스레드 시작</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 모든 스레드 완료 대기</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>최종 재고 상태:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>order_service</span><span class=o>.</span><span class=n>get_inventory_status</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>demo_distributed_locking</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>구현 특징:</strong></p><ol><li><strong>원자적 연산</strong>: Redis 의 SET NX EX 명령어로 락 획득</li><li><strong>자동 갱신</strong>: 백그라운드 스레드를 통한 TTL 갱신</li><li><strong>안전한 해제</strong>: Lua 스크립트로 소유자 검증 후 해제</li><li><strong>컨텍스트 매니저</strong>: with 문을 통한 자동 락 관리</li><li><strong>재시도 로직</strong>: 블로킹 타임아웃 내에서 반복 시도</li></ol><h4 id=분산-락과-모던-오케스트레이션-예시>분산 락과 모던 오케스트레이션 예시<a hidden class=anchor aria-hidden=true href=#분산-락과-모던-오케스트레이션-예시>#</a></h4><p><strong>시나리오</strong>: K8s(쿠버네티스) 기반 대규모 마이크로서비스 환경에서, 잡 (Job) 실행을 단일 노드만 수행하게 동기화.</p><p><strong>시스템 구성</strong>:</p><ul><li>K8s 클러스터, 마이크로서비스 파드 (Pod), Etcd, 컨테이너 애플리케이션</li></ul><pre class=mermaid>graph TD
    S1[파드1] -- 락 요청 --&gt; E[Etcd]
    S2[파드2] -- 락 요청 --&gt; E
    E -- 락 소유 권한 부여 --&gt; S1
    S2 -- 락 대기중 --&gt; E
    S1 -- 락 해제/테스크 완료 --&gt; E
    E -- 다음 소유자 권한 부여 --&gt; S2
</pre><p><strong>워크플로우</strong>:</p><ol><li>각 파드 (Pod) 는 작업 (Job) 시작 전 Etcd 에 락 (Lease Lock) 요청</li><li>첫 번째로 락 소유에 성공한 파드만 잡 실행</li><li>작업 완료 후 락 반환 (Release)</li><li>다른 파드는 락 해제까지 대기, 타임아웃 시 재시도</li></ol><p><strong>구현 예시 (Python, etcd3)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>etcd3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># etcd3 클라이언트 연결</span>
</span></span><span class=line><span class=cl><span class=n>etcd</span> <span class=o>=</span> <span class=n>etcd3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;etcd-server&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>2379</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lock</span> <span class=o>=</span> <span class=n>etcd</span><span class=o>.</span><span class=n>lock</span><span class=p>(</span><span class=s1>&#39;job-lock&#39;</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Lock 획득! 작업 실행.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 실제 잡(Job) 실행 코드…</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Lock 해제&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;다른 인스턴스가 이미 Lock을 소유중&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>실무에서 효과적으로 적용하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#실무에서-효과적으로-적용하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>카테고리</th><th>고려사항</th><th>권장사항</th></tr></thead><tbody><tr><td>시간/TTL 관리</td><td>TTL/세션 만료 설정</td><td>예상 작업 시간 기반 TTL + Buffer 설정, heartbeat 로 갱신</td></tr><tr><td>락 범위 관리</td><td>Granularity 조정</td><td>최소 단위 자원 단위로 세분화, 병목 방지</td></tr><tr><td>재시도/실패 처리</td><td>락 획득 실패, 장애 상황 처리</td><td>지수적 백오프, 최대 재시도 제한, fallback, 서킷 브레이커 적용</td></tr><tr><td>모니터링/가시성</td><td>상태 추적 및 알람 체계 구축</td><td>락 획득률, 대기 시간, orphan lock 모니터링, 이벤트 알람, 대시보드 구성</td></tr><tr><td>장애 대응 전략</td><td>클러스터 장애, 네트워크 단절 등</td><td>자동 failover, 롤백/재시도 로직, quorum 기반 HA 구성</td></tr><tr><td>성능 최적화</td><td>락 경합, 네트워크 비용</td><td>읽기/쓰기 락 분리, 캐시, 지역 클러스터 배치, 압축/연결 풀링 활용</td></tr><tr><td>보안 및 접근 제어</td><td>악의적 요청 방지</td><td>인증/인가, 레이트 리밋, 감사 로그, 락 토큰 기반 식별</td></tr><tr><td>멱등성 및 일관성 보장</td><td>락 중복 해제, 동시성 오작동 방지</td><td>요청 ID, fencing token, 소유자 검증 기반 해제</td></tr><tr><td>테스트 전략</td><td>동시성·장애 상황 검증</td><td>Chaos Testing, concurrency test, timeout scenario 테스트 도입</td></tr></tbody></table><ul><li><p><strong>시간/TTL/세션 관리</strong>는 락의 자동 만료 시점과 클라이언트 장애 시 회복 설계의 핵심으로, TTL 설정과 heartbeat 활용이 기본이다.</p></li><li><p><strong>락 범위 (GRANULARITY)</strong> 는 락이 너무 넓으면 병목, 너무 좁으면 관리 복잡도를 유발하므로 비즈니스 단위에 맞춰 세분화가 중요하다.</p></li><li><p><strong>재시도 및 실패 처리</strong>는 예외 상황을 안정적으로 넘기기 위한 백오프 전략, 서킷 브레이커, 최대 재시도 횟수 제한이 필요하다.</p></li><li><p><strong>모니터링 및 가시성</strong> 확보는 실시간 문제 탐지와 트러블슈팅을 위해 필수이며, 메트릭/로그/트레이스 통합이 바람직하다.</p></li><li><p><strong>장애 대응</strong>은 단일 노드 장애나 네트워크 단절 시에도 지속 가능한 구조 (HA, Auto-Failover, Rollback 등) 를 갖춰야 한다.</p></li><li><p><strong>성능 최적화</strong>는 락 경합 해소, 지역 클러스터 구성, 네트워크 지연 최소화 등 시스템 처리량 확보에 직접적 영향을 준다.</p></li><li><p><strong>보안과 접근 제어</strong>는 악의적 사용 방지를 위한 인증/인가, 레이트 제한, 감사 로깅, 소유권 검증 체계로 보완되어야 한다.</p></li><li><p><strong>멱등성과 일관성 확보</strong>는 중복 락 해제나 충돌 방지를 위한 fencing token, 요청 ID 기반 검증이 필요하다.</p></li><li><p><strong>테스트 전략</strong>은 락의 신뢰성과 회복력을 보장하기 위한 동시성 시뮬레이션, 장애 유도 테스트 등을 반드시 포함해야 한다.</p></li></ul><h4 id=실무-설계-가이드-architecture-design-guide>실무 설계 가이드 (Architecture Design Guide)<a hidden class=anchor aria-hidden=true href=#실무-설계-가이드-architecture-design-guide>#</a></h4><h5 id=핵심-설계-원칙>핵심 설계 원칙<a hidden class=anchor aria-hidden=true href=#핵심-설계-원칙>#</a></h5><table><thead><tr><th>항목</th><th>설계 기준 예시</th></tr></thead><tbody><tr><td>일관성 유지</td><td>quorum 기반 합의, fencing token 적용</td></tr><tr><td>가용성 보장</td><td>3 개 이상 노드 구성, failover 시나리오 설계</td></tr><tr><td>성능 최적화</td><td>지역 클러스터 구성, 읽기 락과 쓰기 락 분리, 락 세분화 적용</td></tr><tr><td>시간 동기화</td><td>NTP + monotonic clock 기반 TTL 계산</td></tr><tr><td>확장성 확보</td><td>sharded 락 key 설계, scalable 리더 선출 알고리즘 활용</td></tr><tr><td>락 경합 최소화</td><td>랜덤 백오프, jitter 적용, 경쟁 대상 분산</td></tr><tr><td>멱등성 및 안전성 확보</td><td>요청 UUID 기반 락 소유권 식별, fencing token 으로 중복 실행 방지</td></tr></tbody></table><h5 id=구성-요소-아키텍처>구성 요소 아키텍처<a hidden class=anchor aria-hidden=true href=#구성-요소-아키텍처>#</a></h5><pre class=mermaid>flowchart TD
    Client --&gt;|lock request| LockGateway
    LockGateway --&gt; LockManager
    LockManager --&gt;|quorum| DistributedStorage[(Zookeeper/etcd/RedisCluster)]
    LockManager --&gt;|monitor| MetricsExporter
    LockManager --&gt;|log| CentralizedLogger
    MetricsExporter --&gt; Dashboard
</pre><h5 id=설계-고려-포인트>설계 고려 포인트<a hidden class=anchor aria-hidden=true href=#설계-고려-포인트>#</a></h5><table><thead><tr><th>설계 요소</th><th>고려사항</th></tr></thead><tbody><tr><td>LockManager</td><td>비즈니스 context-aware 구조로 설계 (락 획득 조건, 유효시간 포함)</td></tr><tr><td>LockGateway</td><td>HTTP/gRPC 또는 Webhook 기반 통신 추상화 계층</td></tr><tr><td>분산 저장소</td><td>ZooKeeper/etcd/Redis 선택 시 Consistency vs Latency 트레이드오프 고려</td></tr><tr><td>TTL 정책</td><td>고정 TTL + 재연장 heartbeat 병행 전략 (락 유지/오류 방지)</td></tr><tr><td>로그 및 트레이스</td><td>락 획득/해제 성공/실패, TTL 만료, 재시도, 경합 통계 등을 structured logging 또는 trace 로 기록</td></tr></tbody></table><h4 id=실무-환경에서-락-시스템-선택-가이드>실무 환경에서 락 시스템 선택 가이드<a hidden class=anchor aria-hidden=true href=#실무-환경에서-락-시스템-선택-가이드>#</a></h4><table><thead><tr><th>조건</th><th>권장 락 시스템</th><th>이유</th></tr></thead><tbody><tr><td>빠른 반응속도 우선</td><td>Redis Redlock</td><td>latency 가 낮고 TTL 관리 간편</td></tr><tr><td>작업 순서 중요</td><td>ZooKeeper Lock</td><td>sequential zNode 로 순서 보장</td></tr><tr><td>장기 작업 처리</td><td>etcd Lock</td><td>lease 연장 기능으로 안정성 확보</td></tr><tr><td>DB-centric 아키텍처</td><td>PostgreSQL Advisory Lock</td><td>트랜잭션과 연계 쉬움</td></tr><tr><td>클라우드 네이티브, 서버리스</td><td>DynamoDB Conditional Write</td><td>락 없이도 일관성 확보 가능</td></tr><tr><td>다수 클러스터 노드 운영</td><td>Consul Lock</td><td>서비스 상태 기반 자동 해제 기능</td></tr></tbody></table><h4 id=devops-연동-전략-deployment--observability-strategy>DevOps 연동 전략 (Deployment & Observability Strategy)<a hidden class=anchor aria-hidden=true href=#devops-연동-전략-deployment--observability-strategy>#</a></h4><h5 id=배포-전략-cicd-연계>배포 전략 (CI/CD 연계)<a hidden class=anchor aria-hidden=true href=#배포-전략-cicd-연계>#</a></h5><table><thead><tr><th>항목</th><th>전략</th></tr></thead><tbody><tr><td>IaC 구성</td><td>Terraform 으로 ZooKeeper/etcd/Redis 구성 자동화, Helm 으로 Lock Service 배포</td></tr><tr><td>CI 테스트</td><td>락 획득/해제 유닛 테스트, TTL 경계 조건 테스트 포함</td></tr><tr><td>배포 무중단 설계</td><td>롤링 업데이트, leader election 안전성 확인 후 배포</td></tr><tr><td>Canary 지원</td><td>신규 버전의 락 해제 실패 등 실험적 기능에 대한 traffic 분산</td></tr><tr><td>버전 롤백</td><td>Lock Gateway 에서 Circuit Breaker 기반 롤백 허용 구조 포함</td></tr></tbody></table><h5 id=모니터링알림-체계-구성>모니터링/알림 체계 구성<a hidden class=anchor aria-hidden=true href=#모니터링알림-체계-구성>#</a></h5><table><thead><tr><th>항목</th><th>구체 구성</th></tr></thead><tbody><tr><td>메트릭 수집</td><td>Prometheus + Lock Exporter (대기 시간, 획득률, TTL 만료 횟수 등)</td></tr><tr><td>로그 관리</td><td>Loki/ELK 기반 락 이벤트 로그 수집 및 조회</td></tr><tr><td>분산 추적</td><td>OpenTelemetry 기반 락 처리 트레이스 연동 (클라이언트 ~ 락 매니저 ~ 저장소까지)</td></tr><tr><td>장애 탐지</td><td>TTL 만료 경보, lock contention 비율 급증, orphan lock 탐지</td></tr><tr><td>Alerting</td><td>Slack/Email/Incident tool 연동, 임계값 기반 알림</td></tr></tbody></table><h5 id=클라우드-네이티브-연동-전략>클라우드 네이티브 연동 전략<a hidden class=anchor aria-hidden=true href=#클라우드-네이티브-연동-전략>#</a></h5><table><thead><tr><th>환경/도구</th><th>연동 전략</th></tr></thead><tbody><tr><td>Kubernetes</td><td>Zookeeper/etcd StatefulSet 배포, headless service 구성, Readiness probe 포함</td></tr><tr><td>ArgoCD/GitOps</td><td>락 시스템 구성 자동화, Helm values 통한 lock TTL 및 storage 설정 관리</td></tr><tr><td>Service Mesh</td><td>락 API 트래픽 제어 및 observability 확보 (Istio + Prometheus 연동)</td></tr><tr><td>Secret 관리</td><td>Redis password, fencing token key 등을 HashiCorp Vault 등으로 관리</td></tr></tbody></table><h3 id=최적화하기-위한-고려사항-및-주의할-점>최적화하기 위한 고려사항 및 주의할 점<a hidden class=anchor aria-hidden=true href=#최적화하기-위한-고려사항-및-주의할-점>#</a></h3><table><thead><tr><th>카테고리</th><th>최적화 주제</th><th>설명</th><th>권장 전략 / 실무 적용 예시</th></tr></thead><tbody><tr><td>성능 최적화</td><td>락 경합 최소화</td><td>병렬 작업 간 과도한 경쟁 방지</td><td>비동기 요청 + 지수 백오프 + 지터 / 임계 구역 최소화</td></tr><tr><td>성능 최적화</td><td>락 보유 시간 단축</td><td>락을 장기간 보유 시 서비스 지연 발생</td><td>작업 분할, 타임아웃 기반 자동 릴리즈</td></tr><tr><td>캐시 최적화</td><td>락 상태 캐싱</td><td>자주 조회되는 락 정보 캐싱</td><td>로컬 캐시 + TTL 설정 + 캐시 무효화 전략</td></tr><tr><td>재시도/백오프 정책</td><td>충돌 회피</td><td>락 충돌 시 무한 재시도 방지</td><td>지수 백오프 + 지터 적용</td></tr><tr><td>재시도/백오프 정책</td><td>자동 재시도</td><td>일시적 실패 시 자동 복구</td><td>Future/Promise + 제한된 재시도 횟수</td></tr><tr><td>알고리즘 최적화</td><td>fencing token</td><td>lock holder 의 유효성 검증</td><td>Redis set with version/token 비교</td></tr><tr><td>알고리즘 최적화</td><td>TTL/Lease 관리</td><td>락의 만료 및 자동 갱신 처리</td><td>Lease 갱신 스케줄러 + 만료 후 캐시 무효화</td></tr><tr><td>아키텍처 최적화</td><td>샤딩 및 파티셔닝</td><td>락 병목 완화 및 수평 확장</td><td>리소스별 lock key 분할, 해시 기반 샤딩</td></tr><tr><td>아키텍처 최적화</td><td>클러스터 확장성</td><td>락 서비스의 처리량 확대</td><td>ZooKeeper 3-5 노드 구성, etcd 클러스터화</td></tr><tr><td>아키텍처 최적화</td><td>작업 큐 연계</td><td>락 획득 후 병렬 처리 가능하도록 큐 기반 분산 처리</td><td>RabbitMQ/Kafka 기반 분산 락 연계</td></tr><tr><td>가용성 전략</td><td>리더 선출 및 복구</td><td>장애 시 자동 failover</td><td>ZAB, Raft 기반 리더 전환 / 세션 기반 모니터링</td></tr><tr><td>신뢰성 전략</td><td>Split-Brain 방지</td><td>이중 마스터 방지</td><td>quorum 기반 쓰기, fencing token 활용</td></tr><tr><td>운영 전략</td><td>모니터링 및 대시보드</td><td>락 경합, 병목, 실패 추적</td><td>APM + 분산 트레이싱 + 대시보드 (Grafana, Prometheus 등)</td></tr><tr><td>운영 전략</td><td>용량 계획 및 부하 분산</td><td>락 요청 증가 대비 적정 자원 확보</td><td>노드/클러스터 별 트래픽 분산, 수평 확장</td></tr></tbody></table><ul><li><p><strong>성능 최적화</strong>는 지연과 병목을 최소화하기 위한 핵심 전략으로, 비동기 처리와 락 보유 시간 단축이 중요하다.</p></li><li><p><strong>캐시 최적화</strong>는 락 상태 조회의 부하를 줄이고, TTL 과 무효화 전략으로 일관성을 유지해야 한다.</p></li><li><p><strong>재시도 및 백오프</strong>는 과도한 요청 폭주를 방지하며, 지수 백오프와 지터를 함께 적용하는 것이 효과적이다.</p></li><li><p><strong>알고리즘 최적화</strong>는 fencing token 과 TTL/Lease 로 stale lock 및 경쟁 문제를 방지하는 데 필수적이다.</p></li><li><p><strong>아키텍처 최적화</strong>는 락의 수평 확장성과 분산 처리 능력을 높이며, 샤딩과 작업 큐 연계가 핵심이다.</p></li><li><p><strong>가용성과 신뢰성 전략</strong>은 장애 복구와 split-brain 방지를 위한 기반을 마련하며, 리더 선출 및 quorum 정책이 중요하다.</p></li><li><p><strong>운영 전략</strong>은 모니터링 및 자동화된 용량 계획 수립으로 안정적인 분산 락 시스템 운영을 보장한다.</p></li></ul><h3 id=비관적-pessimistic-vs-낙관적-optimistic-잠금-전략>비관적 (Pessimistic) vs. 낙관적 (Optimistic) 잠금 전략<a hidden class=anchor aria-hidden=true href=#비관적-pessimistic-vs-낙관적-optimistic-잠금-전략>#</a></h3><h4 id=비관적-vs-낙관적-잠금-전략-비교>비관적 Vs 낙관적 잠금 전략 비교<a hidden class=anchor aria-hidden=true href=#비관적-vs-낙관적-잠금-전략-비교>#</a></h4><table><thead><tr><th>구분</th><th>비관적 잠금 (Pessimistic)</th><th>낙관적 잠금 (Optimistic)</th></tr></thead><tbody><tr><td>가정</td><td>충돌이 자주 발생한다고 가정</td><td>충돌이 드물다고 가정</td></tr><tr><td>구현 방식</td><td>DB 에서 행 수준 락을 즉시 걸어 동시 접근 차단</td><td>버전 번호나 타임스탬프로 충돌 여부 확인 후 처리</td></tr><tr><td>장점</td><td>충돌을 확실히 방지할 수 있음</td><td>병목 점이 없고 성능이 좋음</td></tr><tr><td>단점</td><td>락 보유로 병목 발생, Deadlock 위험 있음</td><td>충돌 시 롤백 필요, 재시도 로직 필요</td></tr><tr><td>사용 적합성</td><td>동시 수정 많고 강한 일관성 필요할 때 적합</td><td>충돌이 적고 성능 우선, eventual consistency 허용 시 적합</td></tr></tbody></table><h4 id=비관적-잠금-구현-예시-python--sqlalchemy>비관적 잠금 구현 예시 (Python + SQLAlchemy)<a hidden class=anchor aria-hidden=true href=#비관적-잠금-구현-예시-python--sqlalchemy>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a class=lnlinks href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a class=lnlinks href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a class=lnlinks href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a class=lnlinks href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a class=lnlinks href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a class=lnlinks href=#hl-27-18>18</a>
</span><span class=lnt id=hl-27-19><a class=lnlinks href=#hl-27-19>19</a>
</span><span class=lnt id=hl-27-20><a class=lnlinks href=#hl-27-20>20</a>
</span><span class=lnt id=hl-27-21><a class=lnlinks href=#hl-27-21>21</a>
</span><span class=lnt id=hl-27-22><a class=lnlinks href=#hl-27-22>22</a>
</span><span class=lnt id=hl-27-23><a class=lnlinks href=#hl-27-23>23</a>
</span><span class=lnt id=hl-27-24><a class=lnlinks href=#hl-27-24>24</a>
</span><span class=lnt id=hl-27-25><a class=lnlinks href=#hl-27-25>25</a>
</span><span class=lnt id=hl-27-26><a class=lnlinks href=#hl-27-26>26</a>
</span><span class=lnt id=hl-27-27><a class=lnlinks href=#hl-27-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.exc</span> <span class=kn>import</span> <span class=n>OperationalError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Account</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;accounts&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>balance</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;postgresql://user:pass@localhost/db&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transfer_pessimistic</span><span class=p>(</span><span class=n>from_id</span><span class=p>,</span> <span class=n>to_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>src</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Account</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>from_id</span><span class=p>)</span><span class=o>.</span><span class=n>with_for_update</span><span class=p>()</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>dst</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Account</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>to_id</span><span class=p>)</span><span class=o>.</span><span class=n>with_for_update</span><span class=p>()</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>src</span><span class=o>.</span><span class=n>balance</span> <span class=o>-=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=n>dst</span><span class=o>.</span><span class=n>balance</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>OperationalError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>with_for_update()</code> 를 이용해 행 잠금을 즉시 획득</li><li>동시성 높은 환경에서 충돌 방지, 그러나 <strong>대기 및 데드락 가능성 존재</strong></li></ul><h4 id=낙관적-잠금-구현-예시-python--sqlalchemy>낙관적 잠금 구현 예시 (Python + SQLAlchemy)<a hidden class=anchor aria-hidden=true href=#낙관적-잠금-구현-예시-python--sqlalchemy>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a class=lnlinks href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a class=lnlinks href=#hl-28-18>18</a>
</span><span class=lnt id=hl-28-19><a class=lnlinks href=#hl-28-19>19</a>
</span><span class=lnt id=hl-28-20><a class=lnlinks href=#hl-28-20>20</a>
</span><span class=lnt id=hl-28-21><a class=lnlinks href=#hl-28-21>21</a>
</span><span class=lnt id=hl-28-22><a class=lnlinks href=#hl-28-22>22</a>
</span><span class=lnt id=hl-28-23><a class=lnlinks href=#hl-28-23>23</a>
</span><span class=lnt id=hl-28-24><a class=lnlinks href=#hl-28-24>24</a>
</span><span class=lnt id=hl-28-25><a class=lnlinks href=#hl-28-25>25</a>
</span><span class=lnt id=hl-28-26><a class=lnlinks href=#hl-28-26>26</a>
</span><span class=lnt id=hl-28-27><a class=lnlinks href=#hl-28-27>27</a>
</span><span class=lnt id=hl-28-28><a class=lnlinks href=#hl-28-28>28</a>
</span><span class=lnt id=hl-28-29><a class=lnlinks href=#hl-28-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Counter</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;counters&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s1>&#39;postgresql://user:pass@localhost/db&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>increment_optimistic</span><span class=p>(</span><span class=n>counter_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>obj</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Counter</span><span class=p>)</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>counter_id</span><span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>current_version</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=n>new_count</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=n>count</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>updated</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>Counter</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>counter_id</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=n>current_version</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>update</span><span class=p>({</span><span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=n>new_count</span><span class=p>,</span> <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=n>current_version</span> <span class=o>+</span> <span class=mi>1</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>updated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>version</code> 칼럼을 사용해 <strong>충돌 시 재시도</strong></li><li>병목이 적고 고성능, 충돌이 잦은 환경에서는 재시도 부담이 있음</li></ul><h3 id=주목할-내용>주목할 내용<a hidden class=anchor aria-hidden=true href=#주목할-내용>#</a></h3><table><thead><tr><th>우선순위</th><th>카테고리</th><th>주제</th><th>항목</th><th>설명 요약</th></tr></thead><tbody><tr><td>기본</td><td>합의 알고리즘 & 이론</td><td>CAP / FLP</td><td>일관성 vs 가용성</td><td>분산 락 설계 시 트레이드오프 정확히 인지 필요</td></tr><tr><td>기본</td><td>락 메커니즘</td><td>Redlock 한계</td><td>fencing token 없음</td><td>Redlock 은 monotonic token 보장이 없어 안전성 결여</td></tr><tr><td>기본</td><td>락 메커니즘</td><td>TTL / Lease 기반 락</td><td>automatic expiry</td><td>TTL 만료 및 세션 기반 회복 전략</td></tr><tr><td>심화</td><td>락 메커니즘</td><td>Fencing token</td><td>요청 타이밍 취약점</td><td>lower token 이 먼저 도착할 경우 race condition 발생 가능</td></tr><tr><td>심화</td><td>구현 도구</td><td>ZooKeeper / etcd</td><td>Ephemeral zNode, Lease</td><td>zk/zxid 기반 fencing token 포함 락 구현</td></tr><tr><td>실무</td><td>신기술 / 대안</td><td>스마트 컨트랙트 락</td><td>온체인 자동 실행 락</td><td>블록체인 기반 락, 높은 신뢰성·낮은 성능</td></tr><tr><td>실무</td><td>신기술 / 대안</td><td>CRDT 기반 동기화</td><td>락 없는 경쟁 제어</td><td>최종 일관성 보장, 동시성 제어 시 성능 탁월</td></tr><tr><td>실무</td><td>인프라 / 구현 도구</td><td>Kubernetes operator 연동</td><td>자동화된 락 관리</td><td>쿠버네티스 환경에서 선언적 락 관리</td></tr><tr><td>실무</td><td>운영 전략</td><td>트레이싱 / 혼돈 공학</td><td>Jaeger, Zipkin, Chaos</td><td>락 장애 복원력 평가 및 모니터링 전략</td></tr></tbody></table><ul><li><p><strong>CAP 이론과 합의 알고리즘</strong>: 락 시스템 디자인에서는 CAP 트레이드오프를 이해하고, Paxos 나 Raft 기반 합의를 사용해야 일관성과 가용성을 적절히 조절할 수 있어요.</p></li><li><p><strong>Redlock 의 한계</strong>: fencing token 이 없어 stale client 문제를 완전히 방지할 수는 없습니다. TTL 기반 자동 만료는 일정 수준 안전성을 보장하지만 완전한 대체는 아니에요.</p></li><li><p><strong>Fencing token 의 타이밍 문제</strong>: 락 소유권 기반 보장에도 lower‑token 요청이 먼저 도착하면 race condition 이 발생할 수 있어, 저장소 차원에서 요청 순서를 강력하게 검증할 수 있어야 합니다.</p></li><li><p><strong>ZooKeeper / etcd 기반 락</strong>: zxid, ephemerals 및 lease 기능을 사용해 fencing token 구조를 구현할 경우 분산 락의 안전성을 확보할 수 있어요.</p></li><li><p><strong>스마트 컨트랙트 락</strong>: 블록체인의 불변성과 자동 실행 논리에 기반해 높은 신뢰성을 제공하지만, 거래 속도 (Gas), 성능 등의 제약 조건이 존재합니다.</p></li><li><p><strong>CRDT 기반 접근</strong>: 락 없이도 데이터 충돌을 방지할 수 있으며, 성능 면에서 유리한 대안 방식입니다.</p></li><li><p><strong>쿠버네티스 및 서비스 메시 연동</strong>: 락을 선언적 리소스로 다루거나 사이드카 패턴으로 관리하는 방식은 클라우드 네이티브 환경에서 실무 적용 시 유용합니다.</p></li><li><p><strong>모니터링 및 혼돈 공학</strong>: 락 장애를 사전에 감지하고 복구력을 검증하는 트레이스 기반 및 Chaos engineering 전략은 실제 운영에서 생존성을 높여줍니다.</p></li></ul><h3 id=반드시-학습해야할-내용>반드시 학습해야할 내용<a hidden class=anchor aria-hidden=true href=#반드시-학습해야할-내용>#</a></h3><table><thead><tr><th>카테고리</th><th>주제</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>기초 이론</td><td>일관성 모델</td><td>CAP Theorem, ACID vs BASE</td><td>일관성, 가용성, 분할 허용성 간의 트레이드오프 및 정합성 모델</td></tr><tr><td>기초 이론</td><td>시간 모델</td><td>Lamport Clock, Vector Clock</td><td>분산 시스템 내 시간 동기화 및 이벤트 순서 보장</td></tr><tr><td>알고리즘 및 모델</td><td>합의 알고리즘</td><td>Paxos, Raft, PBFT</td><td>분산 노드 간의 합의와 리더 선출 알고리즘</td></tr><tr><td>알고리즘 및 모델</td><td>리더 선출 기법</td><td>Ephemeral Node, Lease API</td><td>ZooKeeper 및 Kubernetes 기반 동적 리더 선출</td></tr><tr><td>구현 기술 및 실습</td><td>Redis 기반 락 구현</td><td>Redlock, Lua Script, SETNX</td><td>Redis 의 원자 연산과 스크립트 기반 락 구현 전략</td></tr><tr><td>구현 기술 및 실습</td><td>Zookeeper 기반 락 구현</td><td>Ephemeral Sequential Node, ZAB</td><td>ZooKeeper 기반의 분산 락 구현 방식</td></tr><tr><td>구현 기술 및 실습</td><td>etcd 기반 구현</td><td>Lease, MVCC</td><td>TTL 기반 세션, 버전 기반 동시성 제어</td></tr><tr><td>장애 처리 및 복구</td><td>스플릿 브레인 대응</td><td>Quorum, Fencing Token</td><td>분할 상황에서 다중 리더 방지 및 접근 차단</td></tr><tr><td>장애 처리 및 복구</td><td>TTL/Heartbeat</td><td>세션 만료, 갱신 주기</td><td>락 유지를 위한 주기적 신호와 자동 해제 처리</td></tr><tr><td>장애 처리 및 복구</td><td>페일오버 및 복원 전략</td><td>Graceful Shutdown, 백업/복원</td><td>장애 복구를 위한 상태 보존 및 단계적 전환 방식</td></tr><tr><td>운영/모니터링</td><td>관측 가능성</td><td>분산 추적, 메트릭, 로그 분석</td><td>락 획득/해제, 지연, 실패 등 상태 추적</td></tr><tr><td>운영/모니터링</td><td>Chaos Engineering</td><td>Jepsen, 장애 주입</td><td>장애 시나리오 시뮬레이션 및 복원력 검증</td></tr><tr><td>보안 및 멱등성</td><td>요청 무결성</td><td>Idempotency, Token 기반 요청</td><td>중복 요청 또는 실패 후 재요청 시 안전성 보장</td></tr><tr><td>최적화 전략</td><td>락 경합 최소화</td><td>Backoff, Jitter, Granularity</td><td>경쟁 상황 최소화를 위한 전략 및 재시도 설계</td></tr><tr><td>실무 적용 사례</td><td>사례 분석</td><td>결제 시스템, 잡 스케줄러</td><td>고신뢰 락 구조가 필요한 영역의 실제 사례 분석</td></tr><tr><td>클라우드 환경 구현</td><td>매니지드 락 서비스</td><td>AWS DynamoDB, GCP Spanner 등</td><td>클라우드 벤더가 제공하는 락 서비스 및 API</td></tr><tr><td>고급 주제</td><td>분산 세마포어</td><td>Hazelcast, Sidekiq</td><td>세마포어 형태의 동시성 제어 구조</td></tr><tr><td>고급 주제</td><td>잠금 전략 비교</td><td>Pessimistic vs Optimistic</td><td>선점/비선점 기반의 접근 전략 비교 분석</td></tr></tbody></table><ul><li><p><strong>기초 이론</strong>은 락을 이해하기 위한 전제 지식으로, 시간 모델, 정합성 트레이드오프, 분산 환경의 조건 등을 포함하며 가장 먼저 학습해야 할 영역이다.</p></li><li><p><strong>알고리즘 및 모델</strong>에서는 락의 핵심이 되는 합의 및 리더 선출 과정을 다루며, 실제 락 획득과 릴리즈 로직에 직접적으로 작동한다.</p></li><li><p><strong>구현 기술</strong>은 Redis, Zookeeper, Etcd 등에서 락이 어떻게 구현되는지를 실습 위주로 배우는 영역이다.</p></li><li><p><strong>장애 복구/복원 전략</strong>은 락의 안정성과 고가용성 측면에서 필수적이며, Split-brain 과 TTL 실패 대응 등을 포함한다.</p></li><li><p><strong>운영/모니터링</strong>은 락의 성능과 상태를 지속적으로 추적하고, 장애를 사전에 탐지하기 위한 필수적인 운영 영역이다.</p></li><li><p><strong>보안 및 멱등성</strong>은 락을 활용한 API 설계와 중복 요청 처리에서 중요한 설계 요소다.</p></li><li><p><strong>최적화 전략</strong>은 시스템 병목 방지와 성능 향상을 위한 전략으로, 재시도 및 세분화 설계가 포함된다.</p></li><li><p><strong>실무 적용 사례</strong>는 추상 이론을 실제 시스템에 적용하기 위한 가이드 역할을 하며, 아키텍처 설계에 매우 중요하다.</p></li><li><p><strong>클라우드 환경 구현</strong>은 SaaS 기반 락 설계를 위한 현실적인 접근을 가능케 하며, 멀티 리전 구성에도 활용된다.</p></li><li><p><strong>고급 주제</strong>는 락 외의 동시성 제어 구조와 대체 전략을 포함하며, 시스템 설계 레벨에서의 심화 학습 주제에 해당한다.</p></li></ul><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>기본 개념 및 원리</td><td>Mutual Exclusion (상호 배제)</td><td>임계 영역에 동시에 하나의 프로세스만 접근 허용</td></tr><tr><td></td><td>Critical Section</td><td>공유 자원 접근 구간</td></tr><tr><td></td><td>Deadlock</td><td>서로 락을 대기하다 무한 대기 상태</td></tr><tr><td></td><td>Quorum</td><td>합의나 락 결정을 위한 최소 노드 수</td></tr><tr><td>락 메커니즘</td><td>TTL (Time To Live)</td><td>설정 시간 초과 시 자동 만료되는 락</td></tr><tr><td></td><td>Lease</td><td>TTL 포함 + 소유권까지 포함하는 임대 락</td></tr><tr><td></td><td>Ephemeral Node</td><td>세션 종료 시 자동 삭제되는 임시 노드</td></tr><tr><td></td><td>Sequential Node</td><td>자동 증가 번호가 붙는 znode (ZK)</td></tr><tr><td></td><td>Fencing Token</td><td>락 순서를 보장하는 단조 증가 식별자</td></tr><tr><td></td><td>Shared Lock</td><td>다중 읽기 허용 락</td></tr><tr><td></td><td>Exclusive Lock</td><td>단일 접근만 허용하는 락</td></tr><tr><td>합의 알고리즘</td><td>Raft</td><td>리더 선출 기반 합의 알고리즘</td></tr><tr><td></td><td>Paxos</td><td>복잡하지만 견고한 분산 합의 알고리즘</td></tr><tr><td></td><td>PBFT</td><td>비잔틴 장애를 처리할 수 있는 합의 알고리즘</td></tr><tr><td></td><td>Leader Election</td><td>단일 리더 노드 선출 방식</td></tr><tr><td></td><td>Log Replication</td><td>리더 로그를 팔로워로 전파</td></tr><tr><td></td><td>Lamport Clock</td><td>분산 이벤트 순서를 위한 논리 시계</td></tr><tr><td>성능 및 장애 대응 전략</td><td>Lock Convoy</td><td>동일 락에 경합이 집중되어 발생하는 성능 저하 현상</td></tr><tr><td></td><td>Exponential Backoff</td><td>재시도 대기시간을 점점 늘리는 전략</td></tr><tr><td></td><td>Jitter</td><td>재시도 타이밍을 분산시키는 랜덤 지연</td></tr><tr><td></td><td>Failover</td><td>장애 시 다른 노드로 전환하는 방식</td></tr><tr><td></td><td>Circuit Breaker</td><td>연쇄 장애 방지를 위한 요청 차단 장치</td></tr><tr><td></td><td>Throughput</td><td>락 처리량</td></tr><tr><td></td><td>Latency</td><td>락 요청부터 응답까지의 시간</td></tr><tr><td>인프라 및 구현 기술</td><td>Redlock</td><td>Redis 기반 분산 락 알고리즘 (Antirez 제안)</td></tr><tr><td></td><td>ZooKeeper</td><td>분산 코디네이션/락 플랫폼 (Ephemeral znode 기반)</td></tr><tr><td></td><td>Etcd</td><td>분산 키 - 값 저장소, Lease 기반 락 구현 가능</td></tr><tr><td></td><td>SETNX</td><td>Redis 락 구현을 위한 원자 연산</td></tr><tr><td></td><td>CAS (Compare-And-Swap)</td><td>상태를 원자적으로 갱신하는 연산 방식</td></tr><tr><td>클라우드 및 운영 환경</td><td>Managed Lock Service</td><td>AWS DynamoDB Lock, GCP Spanner Lock 등</td></tr><tr><td></td><td>Pod</td><td>Kubernetes 내 컨테이너 실행 단위</td></tr><tr><td></td><td>Operator</td><td>Kubernetes 리소스를 관리하는 제어기</td></tr><tr><td></td><td>Liveness</td><td>락 서비스가 eventually 응답함을 보장하는 성질</td></tr><tr><td></td><td>Split-Brain</td><td>네트워크 분할로 인한 다중 리더 문제</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html>Martin Kleppmann: How to do distributed locking (Redlock vs safer consensus + fencing token)</a></li><li><a href=https://etcd.io/docs/v3.5/learning/why/>etcd 공식 문서: 권한 기반 분산 락/Lease + fencing token API</a></li><li><a href=https://medium.com/towardsdev/implementing-distributed-locks-correctly-5a35179422a6>Medium: Implementing Distributed Locks Correctly (etcd fencing token + compare-and-swap 방식)</a></li><li><a href="https://news.ycombinator.com/item?id=41315621">Hacker News / Reddit 논의: Redlock의 한계와 fencing 필요성 (Kleppmann 인용 포함)</a></li><li><a href=https://asrathore08.medium.com/system-design-distributed-lock-821da42054db>Medium (Amit Singh Rathore): Distributed Lock System Design 및 fencing 권장 사항</a></li></ul><hr></div></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2025 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>