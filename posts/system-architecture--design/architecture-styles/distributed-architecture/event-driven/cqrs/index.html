<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CQRS | hyunyoun's Blog</title><meta name=keywords content="Software-Engineering,Design-and-Architecture,Architecture-Styles-and-Patterns,Architecture-Patterns,Data-Management-Patterns,CQRS,Command-Query-Responsibility-Segregation"><meta name=description content="CQRS는 쓰기(명령)와 읽기(조회)를 별도 모델로 분리해 각자 최적화·독립적 확장을 가능하게 하는 아키텍처 패턴이다. 읽기 전용 뷰·비대칭 스케일링에 유리하고 보안/검증 경계도 선명해진다. 다만 복잡성과 동기화 비용이 늘며, ES와의 결합은 선택 사항이다."><meta name=author content="Me"><link rel=canonical href=https://buenhyden.github.io/posts/system-architecture--design/architecture-styles/distributed-architecture/event-driven/cqrs/><meta name=google-site-verification content="googlee06938ebbfcbac49.html"><link crossorigin=anonymous href=/assets/css/stylesheet.5311427199677f919b17469b4ca383951185b54edbae0ec7a5b4378f78d8f4f4.css integrity="sha256-UxFCcZlnf5GbF0abTKODlRGFtU7brg7HpbQ3j3jY9PQ=" rel="preload stylesheet" as=style><link rel=icon href=https://buenhyden.github.io/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://buenhyden.github.io/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://buenhyden.github.io/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><link rel=mask-icon href=https://buenhyden.github.io/favicons/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://buenhyden.github.io/posts/system-architecture--design/architecture-styles/distributed-architecture/event-driven/cqrs/index.xml><link rel=alternate hreflang=en href=https://buenhyden.github.io/posts/system-architecture--design/architecture-styles/distributed-architecture/event-driven/cqrs/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3156423099418350" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W8XTMYPTLC"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W8XTMYPTLC")}</script><meta property="og:url" content="https://buenhyden.github.io/posts/system-architecture--design/architecture-styles/distributed-architecture/event-driven/cqrs/"><meta property="og:site_name" content="hyunyoun's Blog"><meta property="og:title" content="CQRS"><meta property="og:description" content="CQRS는 쓰기(명령)와 읽기(조회)를 별도 모델로 분리해 각자 최적화·독립적 확장을 가능하게 하는 아키텍처 패턴이다. 읽기 전용 뷰·비대칭 스케일링에 유리하고 보안/검증 경계도 선명해진다. 다만 복잡성과 동기화 비용이 늘며, ES와의 결합은 선택 사항이다."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://buenhyden.github.io/images"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://buenhyden.github.io/images"><meta name=twitter:title content="CQRS"><meta name=twitter:description content="CQRS는 쓰기(명령)와 읽기(조회)를 별도 모델로 분리해 각자 최적화·독립적 확장을 가능하게 하는 아키텍처 패턴이다. 읽기 전용 뷰·비대칭 스케일링에 유리하고 보안/검증 경계도 선명해진다. 다만 복잡성과 동기화 비용이 늘며, ES와의 결합은 선택 사항이다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HY's Blog","item":"https://buenhyden.github.io/posts/"},{"@type":"ListItem","position":5,"name":"CQRS","item":"https://buenhyden.github.io/posts/system-architecture--design/architecture-styles/distributed-architecture/event-driven/cqrs/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://buenhyden.github.io/ accesskey=h title="Hy's Blog (Alt + H)"><img src=https://buenhyden.github.io/favicons/apple-touch-icon.png alt aria-label=logo height=35>Hy's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://buenhyden.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://buenhyden.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://buenhyden.github.io/til/ title="Today I Learned"><span>Today I Learned</span></a></li><li><a href=https://buenhyden.github.io/coding-test/ title="Coding Test"><span>Coding Test</span></a></li><li><a href=https://buenhyden.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://buenhyden.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://buenhyden.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://buenhyden.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://buenhyden.github.io/posts/>HY's Blog</a></div><h1>CQRS</h1><div class=post-description>CQRS는 쓰기(명령)와 읽기(조회)를 별도 모델로 분리해 각자 최적화·독립적 확장을 가능하게 하는 아키텍처 패턴이다. 읽기 전용 뷰·비대칭 스케일링에 유리하고 보안/검증 경계도 선명해진다. 다만 복잡성과 동기화 비용이 늘며, ES와의 결합은 선택 사항이다.</div></header><div class=post-content><h2 id=cqrs-command-query-responsibility-segregation>CQRS (Command Query Responsibility Segregation)<a hidden class=anchor aria-hidden=true href=#cqrs-command-query-responsibility-segregation>#</a></h2><p>CQRS 는 애플리케이션의 <strong>쓰기 (Command)</strong> 와 <strong>읽기 (Query)</strong> 를 <strong>별도 모델·경로로 분리</strong>해 각 측면을 독립적으로 최적화·확장하는 패턴이다.</p><p>쓰기 모델은 도메인 규칙과 상태 변경을 책임지고, 읽기 모델은 조회 성능에 맞춰 <strong>전용 뷰 스키마/저장소</strong>를 쓴다.<br>필요에 따라 Event Sourcing 을 결합해 이벤트로 읽기 모델을 갱신할 수 있으나 <strong>필수는 아니다</strong>.</p><p>마이크로서비스·복잡 도메인에서 성능·확장성·보안을 높일 수 있지만, <strong>구현·운영 복잡성</strong>과 <strong>일관성 관리 비용</strong>이 증가하므로 신중한 적용이 요구된다.</p><h3 id=핵심-개념>핵심 개념<a hidden class=anchor aria-hidden=true href=#핵심-개념>#</a></h3><p>CQRS 는 &ldquo;<strong>쓰기 전용 모델</strong>&rdquo; 과 &ldquo;<strong>읽기 전용 모델</strong>&rdquo; 을 <strong>완전히 분리</strong>해 각자에 맞게 설계·확장하는 방식이다.<br>쓰기는 <strong>도메인 규칙/트랜잭션</strong>을 지키고, 읽기는 <strong>질의 성능</strong>만 바라본다. 둘 사이 데이터는 주로 <strong>이벤트</strong>로 흘러가며, 이 과정에서 <strong>최종일관성</strong>을 받아들인다. 이벤트 전달의 <strong>원자성</strong>은 <strong>Outbox</strong>로, 다 단계 쓰기 조율은 <strong>Saga</strong>로 보완한다.</p><table><thead><tr><th>개념</th><th>무엇</th><th>왜 중요한가</th></tr></thead><tbody><tr><td>CQRS</td><td>읽기/쓰기 책임·모델·저장소 분리</td><td><strong>독립 최적화/확장</strong>, 복잡성 분리, 경합 감소.</td></tr><tr><td>CQS</td><td>명령/조회 역할 분리 원칙 (메서드 레벨)</td><td>CQRS 의 이론 기반, 부작용 최소화.</td></tr><tr><td>Write Model</td><td>도메인 규칙·트랜잭션을 담는 쓰기 전용 모델</td><td>무결성 보장·비즈니스 규칙 초점.</td></tr><tr><td>Read Model</td><td>조회 전용 프로젝션/뷰/캐시</td><td>고성능 조회·저비용 스케일아웃.</td></tr><tr><td>Event Sourcing</td><td>상태 변경을 <strong>이벤트 로그</strong>로 저장</td><td>이력/감사·재생·프로젝션 생성 용이.</td></tr><tr><td>최종일관성</td><td>읽기 모델 반영이 지연될 수 있음</td><td>성능·확장성 대가를 인지하고 UX 보정 필요.</td></tr><tr><td>Outbox</td><td>DB 변경과 이벤트 발행의 <strong>원자성</strong> 보장</td><td>듀얼 라이트/유실 방지·멱등 처리 토대.</td></tr><tr><td>Saga</td><td>분산 쓰기 단계의 조율/보상 트랜잭션</td><td>다 애그리게이트/서비스 쓰기 안전화.</td></tr></tbody></table><ul><li>CQRS 는 &ldquo;<strong>분리로 얻는 최적화</strong>&rdquo; 가 본질이고, <strong>최종일관성</strong>을 <strong>Outbox·Saga</strong>로 실무급으로 다룬다. 이벤트 소싱은 선택이지만 <strong>읽기 모델 생성엔 강력한 도우미</strong>다.</li></ul><h4 id=실무-구현과의-연관성>실무 구현과의 연관성<a hidden class=anchor aria-hidden=true href=#실무-구현과의-연관성>#</a></h4><table><thead><tr><th>핵심 개념</th><th>왜 연관?</th><th>어떻게 구현? (대표 수단)</th><th>품질 지표/체크</th></tr></thead><tbody><tr><td>CQRS</td><td>읽기/쓰기 성격·튜닝 포인트가 다름</td><td>API/핸들러·스키마 분리, 서비스/DB 분리</td><td>R/W 비율, 읽기 p95, 쓰기 p95.</td></tr><tr><td>Read Model</td><td>조회 부하 대응·개별 최적화</td><td><strong>머티리얼라이즈드 뷰</strong>, 캐시, NoSQL, 인덱스</td><td>뷰 갱신 지연 (ms), 캐시 히트율.</td></tr><tr><td>Write Model</td><td>무결성·도메인 규칙 중심</td><td>애그리게이트/도메인 서비스·강한 트랜잭션</td><td>도메인 불변식 위반률, 트랜잭션 재시도율.</td></tr><tr><td>최종일관성</td><td>분리 전파 지연의 필연</td><td>UX 보정 (스낵바, 로컬 캐시), <strong>R-Y-W</strong> 전략</td><td>읽기 최신성 SLA, 간극 분포.</td></tr><tr><td>Event Sourcing</td><td>읽기 모델 생성·감사 요구</td><td>이벤트→프로젝션 파이프라인</td><td>재생 시간, 이벤트 멱등률.</td></tr><tr><td>Outbox</td><td>DB 변경 + 이벤트 발행 원자화</td><td>트랜잭션 내 Outbox 기록→릴레이 전송</td><td>미전송 이벤트 수, 중복 전송률.</td></tr><tr><td>Saga</td><td>분산 쓰기 조율</td><td>오케스트레이션/코레오그래피·보상 트랜잭션</td><td>보상률, 타임아웃률.</td></tr></tbody></table><ul><li><strong>읽기=뷰 튜닝</strong>, <strong>쓰기=도메인 무결성</strong>, <strong>간극=최종일관성 관리</strong>. 신뢰성은 <strong>Outbox</strong>, 분산 일관성은 <strong>Saga</strong>로 덧댄다.</li></ul><h3 id=기초-이해-foundation-understanding>기초 이해 (Foundation Understanding)<a hidden class=anchor aria-hidden=true href=#기초-이해-foundation-understanding>#</a></h3><h4 id=개념-정의-및-본질>개념 정의 및 본질<a hidden class=anchor aria-hidden=true href=#개념-정의-및-본질>#</a></h4><p>CQRS 는 프로그램에서 " 쓰기 (명령)" 와 " 읽기 (조회)" 를 완전히 다른 경로로 처리하는 설계 방법이다.<br>예를 들어, 주문을 넣을 때는 쓰기 모델이 처리하고, 주문 내역을 볼 때는 조회 모델이 처리한다.<br>이렇게 나누면 각 경로를 성능에 맞게 최적화할 수 있지만, 두 모델의 데이터가 맞춰져 있어야 해서 동기화가 필요하다. 작은 시스템보다는 복잡하고 읽기·쓰기 비율이 크게 다른 시스템에 유리하다.</p><table><thead><tr><th>구분</th><th>내용</th></tr></thead><tbody><tr><td><strong>정의</strong></td><td>데이터 변경 (명령) 과 조회 (쿼리) 의 책임을 별도의 모델로 분리하는 아키텍처 패턴</td></tr><tr><td><strong>기원</strong></td><td>Robert C. Martin 의 CQS 원칙 확장</td></tr><tr><td><strong>구성 요소</strong></td><td>Command Model(쓰기 전용), Query Model(읽기 전용), 별도 저장소, 이벤트 버스</td></tr><tr><td><strong>목적</strong></td><td>읽기/쓰기 요구사항을 독립적으로 최적화, 성능·확장성 향상</td></tr><tr><td><strong>특징</strong></td><td>모델·저장소·서비스 계층 분리, Event Sourcing 과 잘 결합</td></tr><tr><td><strong>장점</strong></td><td>읽기 성능 최적화, 확장성 확보, 유지보수 용이</td></tr><tr><td><strong>단점</strong></td><td>데이터 동기화 복잡성, 과도 설계 가능성</td></tr><tr><td><strong>적용 사례</strong></td><td>읽기 요청이 많은 시스템, 복잡한 도메인, DDD 환경</td></tr></tbody></table><p>CQRS 는 읽기와 쓰기를 분리해 각 경로를 최적화하는 아키텍처 패턴으로, 확장성과 성능을 높이는 대신 동기화 복잡성이 따른다.</p><pre class=mermaid>graph TB
    Client[클라이언트] --&gt; CommandAPI[명령 API]
    Client --&gt; QueryAPI[조회 API]
    
    CommandAPI --&gt; CommandModel[명령 모델]
    QueryAPI --&gt; QueryModel[조회 모델]
    
    CommandModel --&gt; WriteDB[(쓰기 DB)]
    QueryModel --&gt; ReadDB[(읽기 DB)]
    
    WriteDB --&gt; EventBus[이벤트 버스]
    EventBus --&gt; ReadDB
</pre><h4 id=등장-배경-및-발전-과정>등장 배경 및 발전 과정<a hidden class=anchor aria-hidden=true href=#등장-배경-및-발전-과정>#</a></h4><p>CQRS 는 **" 읽기와 쓰기 문제를 따로 푼다 &ldquo;**는 생각에서 출발했다.<br>CQS(메서드 원칙) → CQRS(시스템 설계) 로 확장되며, <strong>읽기는 빠르게·쓰기는 정확하게</strong>를 동시에 달성하도록 진화했다. 클라우드 시대엔 읽기를 마음껏 <strong>수평 확장</strong>하고, 쓰기는 <strong>도메인 규칙</strong>에 집중하면서 둘 사이를 <strong>이벤트/비동기</strong>로 연결하는 게 표준이 됐다.</p><h5 id=등장-배경>등장 배경<a hidden class=anchor aria-hidden=true href=#등장-배경>#</a></h5><ul><li>전통 CRUD 단일 모델이 <strong>읽기/쓰기의 상충 요구</strong>(인덱스/스키마/잠금) 로 병목 → 대규모·다지역 서비스에서 가속.</li><li>CQRS 는 <strong>모델/핸들러/저장소 분리</strong>로 각자 최적화하고, <strong>비동기 전파</strong>로 전체 시스템 처리량과 확장성 향상을 노린다.</li></ul><h5 id=발전-과정>발전 과정<a hidden class=anchor aria-hidden=true href=#발전-과정>#</a></h5><table><thead><tr><th>시기</th><th>사건/주요 인물</th><th>왜 등장했나</th><th>무엇이 개선됐나</th></tr></thead><tbody><tr><td>1988~90s</td><td><strong>CQS</strong>·Bertrand Meyer</td><td>부작용 분리·코드 추론성 향상</td><td>명령/조회 <strong>책임 경계</strong> 확립</td></tr><tr><td>2006~2010</td><td><strong>CQRS 정립</strong>·Greg Young</td><td>읽기/쓰기 <strong>튜닝 포인트 상이</strong></td><td>R/W <strong>모델·스토리지 분리</strong>로 독립 최적화</td></tr><tr><td>2009~2012</td><td><strong>Clarified CQRS</strong>, <strong>CQRS Journey</strong></td><td>오해 정리·실무 지침 필요</td><td>ES 와의 <strong>관계 정리</strong>, 레퍼런스 아키텍처·가이드 제공</td></tr><tr><td>2010s~현재</td><td><strong>클라우드·마이크로서비스·이벤트 기반</strong></td><td>읽기 우세·분산·독립 확장 요구</td><td>읽기 수평 확장, 쓰기 무결성, <strong>최종 일관성 운영</strong></td></tr></tbody></table><ul><li>CQS 가 <strong>이론적 분리</strong>를 제시했고, CQRS 가 이를 <strong>시스템 설계</strong>로 끌어올렸다. 2010 년대 이후 <strong>운영 지침과 사례</strong>가 축적되며 클라우드 환경에서 표준화됐다.</li></ul><pre class=mermaid>timeline
  title CQRS: 등장 배경 및 발전 과정
  section 개념 형성
    1988 : CQS 원칙 제안 (Bertrand Meyer) – 메서드 수준 분리
  section 패턴 정립
    2006-2010 : CQRS 명명·정립 (Greg Young) – 읽기/쓰기 분리 확립
    2009 : Clarified CQRS (Udi Dahan) – 오해 정리
  section 실무 확산
    2012 : Microsoft &#34;CQRS Journey&#34; – 레퍼런스 구현·가이드
    2010s-2025 : 클라우드·MSA·이벤트 기반 확산 – 수평 확장·최종 일관성
</pre><ul><li><strong>CQS → CQRS</strong>로의 확장은 " 메서드 분리 " 를 " 시스템 분리 " 로 확장해 <strong>독립 최적화/확장</strong>을 가능하게 했다.</li><li>2010 년 전후 <strong>Young·Dahan</strong>의 정립·정리와 <strong>MS CQRS Journey</strong>가 <strong>실무 표준</strong>을 만들었고, 오늘날 <strong>읽기 우세·분산 환경</strong>에서 CQRS 는 <strong>사실상 기본 선택지</strong>가 되었다.</li></ul><h4 id=핵심-동기-및-가치-제안>핵심 동기 및 가치 제안<a hidden class=anchor aria-hidden=true href=#핵심-동기-및-가치-제안>#</a></h4><p>CQRS 의 목적은 <strong>서로 다른 요구를 가진 읽기와 쓰기를 갈라서 잘하게 만들기</strong>다. 쓰기는 규칙·트랜잭션 일관성에 집중하고, 읽기는 빠른 응답과 다양한 뷰에 집중한다. 이렇게 나누면 각 부분을 <strong>따로 설계·배포·확장</strong>할 수 있어 성능과 유지보수성이 좋아진다. 필요하면 Event Sourcing 을 더해 <strong>이벤트로 읽기 모델을 채우고 이력/감사</strong>도 강화할 수 있지만, <strong>반드시 결합해야 하는 것은 아니다</strong>.</p><table><thead><tr><th>범주</th><th>목적/가치</th><th>왜 필요한가</th><th>적용 포인트</th></tr></thead><tbody><tr><td>성능/확장성</td><td>읽기·쓰기 독립 최적화/스케일</td><td>경로 특성이 다름 (검증·트랜잭션 vs. 조회·캐시)</td><td>쓰기: 도메인 모델·트랜잭션, 읽기: 뷰 DB/리플리카</td></tr><tr><td>복잡성 관리</td><td>변경 영향 축소·테스트 용이</td><td>규칙/조회 요구 동시 충족 시 결합도↑</td><td>코드·스키마·핸들러를 분리 배치</td></tr><tr><td>유지보수/팀 조직</td><td>병렬 개발·독립 배포</td><td>대규모 팀에서 충돌/대기 비용 큼</td><td>서비스/리포지토리 레벨 분리, CI/CD 분리</td></tr><tr><td>보안/권한</td><td>변경 경로 엄격, 조회 경로 안전 공개</td><td>쓰기 권한·검증이 더 중요</td><td>커맨드 핸들러 보호, 조회는 캐시/리드뷰로 확장</td></tr><tr><td>이벤트성 (옵션)</td><td>이력/감사/재생, 비동기 업데이트</td><td>감사·타임머신 요구, 읽기 갱신 모델 필요</td><td>ES 로 이벤트 발행→리드 모델 물질화 (필수 아님)</td></tr></tbody></table><ul><li>CQRS 는 <strong>이질적 요구 (쓰기 규칙 vs. 읽기 성능)</strong> 를 분리해 각각을 제대로 하도록 만든다.</li><li><strong>독립 스케일·배포</strong>가 가능해지고, 팀·스키마 충돌을 줄여 <strong>변경 비용</strong>을 낮춘다.</li><li>Event Sourcing 은 <strong>선택적으로 결합</strong>해 감사/재생/물질화 뷰를 강화한다.</li></ul><h4 id=주요-특징>주요 특징<a hidden class=anchor aria-hidden=true href=#주요-특징>#</a></h4><p>CQRS 는 &ldquo;<strong>쓰기 길</strong>(명령) 과 <strong>읽기 길</strong>(조회) 을 <strong>아예 다른 도로</strong>로 나누는 설계 " 다. 그래서 읽기 도로는 <strong>빠르게 조회</strong>하도록 깔고, 쓰기 도로는 <strong>규칙·검증</strong>을 두껍게 깐다. 바쁘면 읽기 도로만 <strong>폭 넓게 확장</strong>할 수 있고, 쓰기·읽기를 <strong>다른 DB</strong>로 운영할 수도 있다. 다만 두 도로 사이를 <strong>이벤트로 이어 주기</strong> 때문에, 읽기 쪽이 약간 늦게 반영되는 <strong>최종 일관성</strong>을 감수해야 한다.</p><table><thead><tr><th>특징</th><th>설명</th><th>왜 가능한가/근거</th></tr></thead><tbody><tr><td>모델 분리</td><td>명령과 조회를 다른 모델·인터페이스로 분리</td><td>CQRS 정의 자체가 분리 원칙을 전제.</td></tr><tr><td>독립 최적화/스케일</td><td>읽기·쓰기 각각 스키마·캐시·인덱싱·배포 단위 최적화·확장</td><td>Azure 가 독립 스케일·스키마 최적화를 명시.</td></tr><tr><td>저장소 분리/폴리글랏</td><td>읽기/쓰기 저장소를 분리하고 기술을 달리 쓸 수 있음</td><td>" 서로 다른 데이터 스토어/기술 사용 " 을 공식적으로 제시.</td></tr><tr><td>이벤트 기반 갱신</td><td>쓰기 이벤트를 읽기 모델의 프로젝션/뷰 갱신에 사용</td><td>Materialized View·ES 문서의 조합 패턴.</td></tr><tr><td>최종 일관성</td><td>분리된 저장소 간 비동기 동기화로 잠시 지연 허용</td><td>Azure 가 &lsquo;Eventual consistency&rsquo; 트레이드오프를 명시.</td></tr><tr><td>보안/검증 경계</td><td>쓰기 측에 검증·권한 집중, 읽기 측은 읽기 전용 DTO</td><td>Azure 가 보안 이점과 역할 분리를 명시.</td></tr><tr><td>CQS 기반</td><td>" 질의는 상태를 바꾸지 않음 " 원칙을 시스템 레벨로 확장</td><td>Fowler CQS 가 사상적 배경을 제공.</td></tr></tbody></table><ul><li><strong>분리</strong>가 출발점, <strong>독립 최적화/스케일</strong>이 핵심 이점.</li><li><strong>이벤트로 연결</strong>해 읽기 모델을 갱신하되 <strong>최종 일관성</strong>을 설계로 흡수.</li><li>필요하면 <strong>서로 다른 저장소/기술</strong>을 선택, 쓰기 경로에 <strong>보안·검증</strong>을 집중한다.</li></ul><h3 id=핵심-이론-core-theory>핵심 이론 (Core Theory)<a hidden class=anchor aria-hidden=true href=#핵심-이론-core-theory>#</a></h3><h4 id=핵심-설계-원칙>핵심 설계 원칙<a hidden class=anchor aria-hidden=true href=#핵심-설계-원칙>#</a></h4><p>CQRS 는 <strong>도로 두 개</strong>를 까는 설계다. 한 도로 (쓰기) 는 <strong>신호·검문</strong>이 빡세고, 다른 도로 (읽기) 는 <strong>고속도로</strong>처럼 빠르다.<br>쓰기 도로에서 난 변화는 <strong>이벤트</strong>로 읽기 도로에 전달돼 안내표지 (프로젝션) 가 갱신된다. 다만 표지 갱신이 <strong>살짝 늦을 수 있음 (최종 일관성)</strong> 을 감수하면, <strong>확장성과 성능</strong>을 크게 얻는다.</p><table><thead><tr><th>원칙</th><th>목적</th><th>필요한 이유</th></tr></thead><tbody><tr><td>책임 분리 (CQS)</td><td>읽기/쓰기 부수효과·성능 요구 분리</td><td>한 모델로 두 요구 충족 시 상충·결합 ↑</td></tr><tr><td>단일 책임·관심사 분리</td><td>쓰기=규칙·검증, 읽기=조회 최적화</td><td>변경 이유 분리로 충돌·복잡도 ↓</td></tr><tr><td>독립 최적화·스케일</td><td>각 워크로드별 성능·비용 최적</td><td>읽기 편중/쓰기 편중을 개별 확장</td></tr><tr><td>이벤트 기반 갱신</td><td>읽기 모델 (프로젝션) 최신화</td><td>모델 분리로 직접 조인 불가→이벤트 전파</td></tr><tr><td>최종 일관성</td><td>성능·가용성 확보</td><td>비동기 동기화로 전파 지연 수용</td></tr><tr><td>폴리글랏 저장소</td><td>모델별 최적 DB 선택</td><td>데이터 특성별 강점 활용</td></tr><tr><td>보안·검증 경계</td><td>변경 경로에 강한 검증·인가</td><td>공격면 축소·감사 용이</td></tr><tr><td>단순함 우선</td><td>과설계 방지</td><td>복잡성·운영 비용 상쇄</td></tr></tbody></table><p>핵심은 <strong>분리</strong>이고, 효과는 <strong>독립 최적화·확장</strong>이다. 읽기는 <strong>프로젝션</strong>으로 빠르게, 쓰기는 <strong>규칙·검증</strong>을 두껍게. 저장소는 <strong>필요하면 다르게</strong>, 일관성은 <strong>최종적</strong>으로 맞춘다. 단, <strong>복잡성 비용</strong>이 정당화될 때만 쓴다.</p><h4 id=기본-원리-및-동작-메커니즘>기본 원리 및 동작 메커니즘<a hidden class=anchor aria-hidden=true href=#기본-원리-및-동작-메커니즘>#</a></h4><p>CQRS 는 &ldquo;<strong>쓰기랑 읽기를 갈라서, 각자 잘하게 만든다</strong>&rdquo; 가 전부다. 쓰기 경로는 규칙 검증과 트랜잭션에 집중하고, 읽기 경로는 빠른 응답과 맞춤형 뷰에 집중한다. 쓰기 후 이벤트를 흘려 보내 프로젝션이 읽기 DB 를 갱신하기 때문에, 조회 데이터는 약간 늦게 반영될 수 있다 (대신 속도·확장성이 좋아진다).<br>Event Sourcing 을 더하면 이벤트로 상태를 재구성·감사할 수 있지만 <strong>꼭 필요하진 않다</strong>.</p><h5 id=기본-원리>기본 원리<a hidden class=anchor aria-hidden=true href=#기본-원리>#</a></h5><table><thead><tr><th>원리</th><th>요지</th><th>구현 포인트</th></tr></thead><tbody><tr><td>책임 분리</td><td>Command/Query <strong>모델·핸들러·저장소 분리</strong></td><td>CommandHandler/QueryHandler, WriteDB/ReadDB 분리</td></tr><tr><td>CQS 기반</td><td>Command=상태 변경, Query=부작용 없음</td><td>메서드/엔드포인트 계층에서 원칙 준수</td></tr><tr><td>물질화 뷰</td><td>이벤트로 <strong>ReadDB</strong> 갱신 (프로젝션)</td><td>비정규화/캐시/리드뷰, 재빌드 가능</td></tr><tr><td>일관성 모델</td><td><strong>Eventual consistency</strong> 허용</td><td>읽기 지연·보상 로직·리드 모델 랙 모니터링</td></tr><tr><td>선택적 ES</td><td>ES 는 <strong>옵션</strong>(감사·재생 강화)</td><td>Event Store, 스냅샷·리플레이 전략</td></tr><tr><td>적용 판단</td><td>이득>복잡성일 때 채택</td><td>조회 패턴 다양/스케일 요구 뚜렷할 때 유리</td></tr></tbody></table><ul><li>CQRS 는 <strong>구조 (모델·저장소) 까지 분리</strong>해야 효과가 크다.</li><li>읽기 측은 <strong>전용 뷰 DB</strong>로 단순·고속화하고, 필요하면 <strong>재구축</strong>한다.</li><li><strong>ES 결합은 선택</strong>이며, 도입 시 스냅샷·리플레이·이벤트 스키마 버저닝을 설계한다.</li><li>결국 <strong>성능·확장성 ↔ 복잡성</strong>의 트레이드오프를 판단하는 문제다.</li></ul><h5 id=동작-메커니즘>동작 메커니즘<a hidden class=anchor aria-hidden=true href=#동작-메커니즘>#</a></h5><pre class=mermaid>sequenceDiagram
    participant Client
    participant CmdAPI as Command API
    participant CmdHandler as Command Handler
    participant WriteDB as Write DB / Aggregate
    participant EvtBus as Event Bus (옵션: Event Store)
    participant Proj as Projection / ReadModel Updater
    participant ReadDB as Read DB (Materialized View)
    participant QryAPI as Query API
    participant QryHandler as Query Handler

    Client-&gt;&gt;CmdAPI: Command 전송
    CmdAPI-&gt;&gt;CmdHandler: 검증/도메인 규칙 실행
    CmdHandler-&gt;&gt;WriteDB: 상태 변경(트랜잭션)
    CmdHandler--&gt;&gt;EvtBus: 이벤트 발행(필요 시)
    EvtBus--&gt;&gt;Proj: 이벤트 전달
    Proj-&gt;&gt;ReadDB: 읽기 모델 갱신(비동기)

    Client-&gt;&gt;QryAPI: Query 전송
    QryAPI-&gt;&gt;QryHandler: 질의 처리
    QryHandler-&gt;&gt;ReadDB: 물질화 뷰 조회
    ReadDB--&gt;&gt;QryHandler: 결과
    QryHandler--&gt;&gt;Client: 응답
</pre><ul><li><strong>명령 경로</strong>는 규칙 검증→트랜잭션 저장→이벤트 발행까지 담당하고,</li><li><strong>프로젝션</strong>이 이벤트를 소비해 ** 읽기 모델 (비정규화/캐시)** 을 갱신한다.</li><li><strong>조회 경로</strong>는 읽기 모델만 조회하므로 빠르지만, <strong>반영 지연</strong>(eventual consistency) 을 수반할 수 있다.</li></ul><pre class=mermaid>graph TD
    User[사용자] --&gt; API
    API --&gt; CommandHandler[명령 핸들러]
    CommandHandler --&gt; WriteDB[쓰기DB]
    API --&gt; QueryHandler[조회 핸들러]
    QueryHandler --&gt; ReadDB[조회DB]
    WriteDB --&gt; EventBus[이벤트 버스]
    EventBus --&gt; ReadDB
</pre><ul><li>사용자는 API 를 통해 명령 (Command) 과 조회 (Query) 를 분리하여 요청.</li><li>Command 는 CommandHandler, WriteDB 를 통해 처리, 필요시 이벤트 (이벤트 소싱) 발행.</li><li>Query 는 QueryHandler, ReadDB 를 통해 빠르게 조회.</li></ul><h4 id=아키텍처-및-구성-요소>아키텍처 및 구성 요소<a hidden class=anchor aria-hidden=true href=#아키텍처-및-구성-요소>#</a></h4><p>CQRS 는 <strong>쓰기 (정확성)</strong> 와 <strong>읽기 (속도)</strong> 를 <strong>서로 다른 모델과 저장소</strong>로 나눠 각자 최적화하는 설계다.<br>쓰기에서 바뀐 내용은 이벤트/배치로 <strong>읽기 모델</strong>에 반영되어, 전체 시스템은 보통 <strong>최종 일관성</strong>으로 동작한다. 신뢰성·분산 일관성은 <strong>Outbox</strong>와 <strong>Saga</strong>로 보강한다.</p><pre class=mermaid>graph TB
  %% 외부 인터페이스
  U[Client/UI] --&gt;|Commands| CMDAPI[Command API/Bus]
  U --&gt;|Queries| QAPI[Query API/Bus]

  %% Command Side
  subgraph &#34;Command Side (Write)&#34;
    CH[Command Handler&lt;br/&gt;- 검증·도메인 규칙·트랜잭션]
    WM[Write Model]
    WDB[(Write DB)]
    CH --&gt; WM --&gt; WDB
  end
  CMDAPI --&gt; CH

  %% 신뢰성 보완
  subgraph Reliability
    OX[Outbox Table]
    RELAY[Outbox Relay]
  end
  WDB -. 동일 트랜잭션 .-&gt; OX
  OX --&gt; RELAY

  %% 이벤트/프로젝션
  subgraph Eventing
    MB[(Event Bus/Broker)]
    ES[(Event Store)]
    PROJ[Projection/Read Model Updater]
  end
  RELAY --&gt; MB
  MB --&gt; ES
  MB --&gt; PROJ

  %% Query Side
  subgraph &#34;Query Side (Read)&#34;
    RM[Read Model&lt;br/&gt;- 비정규화/인덱스/캐시]
    RDB[(Read DB/Cache)]
    QH[Query Handler]
    PROJ --&gt; RM --&gt; RDB
    QAPI --&gt; QH --&gt; RDB
  end

  %% 분산 트랜잭션
  subgraph &#34;Coordination (Optional)&#34;
    SAGA[Saga Orchestrator/Choreography]
  end
  CH -. cross-service commands .-&gt; SAGA
  SAGA -. emits .-&gt; MB
</pre><ul><li><strong>Command 경로</strong>는 무결성과 도메인 규칙에 집중 (트랜잭션). <strong>Outbox</strong>로 DB 변경 + 이벤트 발행의 원자성을 보장한다.</li><li><strong>Eventing 경로</strong>는 브로커를 통해 이벤트를 전달하고 <strong>Projection</strong>이 이를 <strong>Read Model</strong>로 반영 (머티리얼라이즈드 뷰).</li><li><strong>Query 경로</strong>는 <strong>읽기 전용 저장소</strong>만 조회 (부작용 없음). 읽기/쓰기의 <strong>독립 확장</strong>이 가능하다.</li><li><strong>Saga</strong>는 다 서비스 쓰기를 보상/오케스트레이션으로 조율한다.</li></ul><h5 id=구성-요소>구성 요소<a hidden class=anchor aria-hidden=true href=#구성-요소>#</a></h5><table><thead><tr><th>구성 요소</th><th>핵심 역할</th><th>대표 기술/패턴</th><th>품질 지표 예시</th></tr></thead><tbody><tr><td>Command Handler</td><td>명령 검증·도메인 규칙·트랜잭션</td><td>계층형/DDD 애그리게이트</td><td>쓰기 p95, 실패율</td></tr><tr><td>Write Model/DB</td><td>무결성·동시성 관리</td><td>RDBMS/도큐먼트</td><td>Deadlock/Retry 율</td></tr><tr><td>Outbox/Relay</td><td>이벤트 발행 원자화</td><td>Outbox 테이블·릴레이</td><td>미전송 이벤트 수</td></tr><tr><td>Event Bus</td><td>비동기 전달</td><td>Kafka/RabbitMQ</td><td>지연/중복률</td></tr><tr><td>Event Store</td><td>이벤트 영속</td><td>EventStoreDB 등</td><td>재생 시간</td></tr><tr><td>Projection</td><td>읽기 모델 생성</td><td>Stream processor</td><td>뷰 갱신 지연</td></tr><tr><td>Read Model/DB</td><td>조회 최적화</td><td>NoSQL/캐시/뷰</td><td>읽기 p95/히트율</td></tr><tr><td>Query Handler</td><td>질의 처리</td><td>API/GraphQL/GRPC</td><td>오류율</td></tr><tr><td>Saga</td><td>분산 쓰기 조율</td><td>Orchestrator/Choreo</td><td>보상률/타임아웃</td></tr></tbody></table><ul><li><strong>쓰기=무결성/도메인</strong>, <strong>읽기=속도/스케일</strong>에 집중하도록 경로와 저장소를 분리한다.</li><li><strong>Outbox+Projection</strong>으로 <strong>최종 일관성</strong>을 통제 가능한 방식으로 운영하고, 분산 쓰기는 <strong>Saga</strong>로 안전하게 조율한다.</li></ul><h4 id=주요-기능과-역할>주요 기능과 역할<a hidden class=anchor aria-hidden=true href=#주요-기능과-역할>#</a></h4><p>CQRS 는 프로그램에서 " 데이터 바꾸는 부분 " 과 " 데이터 보는 부분 " 을 완전히 다른 구조로 설계하는 방법이다.</p><ul><li><strong>Command Side</strong>는 &rsquo; 규칙대로 데이터를 바꾸는 &rsquo; 역할을 한다.</li><li><strong>Query Side</strong>는 &rsquo; 최대한 빠르고 보기 좋게 데이터를 보여주는 &rsquo; 역할을 한다.</li><li>두 영역은 <strong>이벤트</strong>라는 메시지를 주고받으며 동기화된다.<br>이렇게 나누면 각 부분을 더 잘 최적화할 수 있고, 큰 시스템에서도 성능을 유지하기 쉽다.</li></ul><table><thead><tr><th>영역</th><th>구성 요소</th><th>주요 기능</th><th>개선·해결 효과</th></tr></thead><tbody><tr><td><strong>명령 처리</strong> (Command Side)</td><td>Command Model, Command Handler</td><td>비즈니스 규칙 검증, 상태 변경, 트랜잭션 처리, 이벤트 발행</td><td>데이터 무결성·일관성 확보, 도메인 규칙 강화</td></tr><tr><td><strong>조회 처리</strong> (Query Side)</td><td>Query Model, Query Handler</td><td>성능 최적화 조회, 다양한 View 제공, 캐싱·비정규화 활용</td><td>응답 속도 향상, 읽기 전용 확장성 강화</td></tr><tr><td><strong>이벤트 관리·프로젝션</strong></td><td>Event Bus, Projection, Event Store(선택)</td><td>이벤트 발행·전달, 읽기 모델 업데이트, 감사 추적</td><td>최종 일관성 유지, 결합도 감소, 장애 복구 용이</td></tr></tbody></table><p>CQRS 의 Command 는 무결성과 규칙 준수를, Query 는 조회 성능과 확장성을, Event 관리·프로젝션은 양측 간 연결과 일관성 유지를 담당한다.</p><h3 id=특성-분석-characteristics-analysis>특성 분석 (Characteristics Analysis)<a hidden class=anchor aria-hidden=true href=#특성-분석-characteristics-analysis>#</a></h3><h4 id=장점-및-이점>장점 및 이점<a hidden class=anchor aria-hidden=true href=#장점-및-이점>#</a></h4><p>CQRS 는 <strong>도로를 두 개</strong>로 가르는 설계다.<br>한쪽 (쓰기) 은 <strong>규칙·검증이 빡센 도로</strong>, 다른 쪽 (읽기) 은 <strong>고속도로</strong>다. 고속도로 표지판 (프로젝션/뷰) 은 쓰기에서 온 <strong>이벤트</strong>로 갱신된다. 그래서 읽기를 크게 늘려도 쓰기가 버티고, 필요하면 두 도로를 <strong>따로 확장</strong>하거나 <strong>다른 DB</strong>를 쓸 수 있다.<br>단, 표지판 갱신이 약간 늦는 <strong>최종 일관성</strong>은 설계·UX 로 흡수해야 한다.</p><table><thead><tr><th>구분</th><th>항목</th><th>설명</th></tr></thead><tbody><tr><td>성능</td><td>조회 성능 향상</td><td>읽기 모델을 프로젝션/머티리얼라이즈드 뷰로 구성해 복잡 조인 없이 고속 응답</td></tr><tr><td>성능</td><td>쓰기 성능·안정성</td><td>쓰기 모델이 도메인 규칙·트랜잭션에 집중하여 락 경합·조회 부담 감소</td></tr><tr><td>확장성</td><td>독립적 스케일링</td><td>읽기/쓰기 파이프라인을 별도로 수평 확장</td></tr><tr><td>확장성</td><td>폴리글랏 퍼시스턴스</td><td>읽기/쓰기에 다른 저장소·스키마 (예: SQL/NoSQL) 적용</td></tr><tr><td>유지보수</td><td>관심사 분리</td><td>쓰기=검증·규칙, 읽기=DTO/뷰로 분리되어 변경 충돌·복잡도 감소</td></tr><tr><td>보안</td><td>권한 경계 강화</td><td>쓰기 엔드포인트에만 변경 권한을 집중, 읽기는 최소 권한 조회</td></tr><tr><td>조직</td><td>병렬 개발·배포</td><td>읽기/쓰기 컴포넌트를 분리해서 팀 단위 병렬 개발/배포</td></tr><tr><td>운영 (조합)</td><td>감사/재구성 (ES 결합)</td><td>이벤트 로그 재생으로 읽기 모델 재생성·감사 추적</td></tr></tbody></table><p>핵심은 <strong>분리</strong>다. 분리 덕에 읽기는 <strong>빠르게</strong>, 쓰기는 <strong>엄격하게</strong> 다듬을 수 있고, 각자 <strong>따로 확장·따로 DB</strong>를 선택한다. 감사·재구성은 <strong>ES 를 곁들였을 때</strong> 특히 강력해진다.</p><h4 id=단점-및-제약사항과-해결방안>단점 및 제약사항과 해결방안<a hidden class=anchor aria-hidden=true href=#단점-및-제약사항과-해결방안>#</a></h4><p>CQRS 의 단점은 한마디로 <strong>&rdquo; 복잡해지고, 읽기가 늦게 반영될 수 있다 &ldquo;</strong> 이다. 그래서 <strong>이득이 확실한 경우</strong>(읽기/쓰기 부하·요구가 매우 다를 때) 만 쓴다. 신뢰성은 <strong>Outbox</strong>(이중쓰기 제거) 와 <strong>멱등 소비자</strong>(중복 안전), <strong>Saga</strong>(분산 보상) 로 다지고, ES 를 쓰면 <strong>스냅샷/아카이빙</strong>으로 크기와 복구 시간을 관리한다.</p><table><thead><tr><th>범주</th><th>단점/문제</th><th>원인</th><th>영향</th><th>탐지·진단</th><th>예방</th><th>해결 기법/패턴</th></tr></thead><tbody><tr><td>복잡성/학습</td><td>구성요소·경로 증가</td><td>모델/DB/브로커 분리</td><td>개발·운영 비용↑</td><td>아키텍처 리뷰</td><td>단계적 도입·경계 명확화</td><td>" 필요할 때만 " 채택 (가이드 준수)</td></tr><tr><td>최종 일관성</td><td>읽기 지연/불일치</td><td>비동기 프로젝션</td><td>UX 혼란</td><td><strong>읽기 랙</strong> 모니터링</td><td>기대치·SLA 명시</td><td>UI 지연 표시·보상 트랜잭션 (사가)</td></tr><tr><td>인프라 비용</td><td>다중 DB·브로커</td><td>기술 스택 확대</td><td>장애 지점↑·비용↑</td><td>비용/장애 지표</td><td>IaC·관리형 서비스</td><td>아키텍처 단순화·리소스 상한</td></tr><tr><td>테스트 복잡</td><td>경로별 검증 필요</td><td>흐름 분리</td><td>테스트 시간↑</td><td>계약/통합 테스트</td><td>표준 템플릿</td><td>리플레이/계약 테스트 체계화</td></tr><tr><td>메시징 실패/중복/순서</td><td>재시도·중복소비·오더링</td><td>분산·네트워크 특성</td><td>상태 불일치</td><td>중복률/오프셋 랙</td><td>파티셔닝·키 설계</td><td><strong>멱등 소비자</strong>, 트랜잭션/EOS 활용</td></tr><tr><td>이중쓰기</td><td>DB 쓰기↔이벤트 발행 사이 실패</td><td>분산 경계</td><td>데이터·이벤트 불일치</td><td>발행 실패율</td><td>로컬 트랜잭션 우선</td><td><strong>Transactional Outbox + CDC</strong></td></tr><tr><td>스키마 진화</td><td>이벤트/뷰 버전 불일치</td><td>장기 진화</td><td>역직렬화 오류</td><td>호환성 테스트</td><td>스키마 레지스트리</td><td>업/다운캐스터·버저닝 전략</td></tr><tr><td>ES 팽창/복구 지연</td><td>이벤트 무한 적재</td><td>ES 도입</td><td>저장비용↑·리플레이 지연</td><td>스토리지/리플레이 시간</td><td>보존정책</td><td><strong>스냅샷/아카이빙</strong></td></tr></tbody></table><ul><li>EOS(Exactly-once) 는 브로커·클라이언트 조합에서 " 범위 제한 " 으로 달성되며, <strong>엔드투엔드</strong>에선 멱등성·Outbox 가 실효적이다.</li></ul><p>핵심 리스크는 <strong>복잡성·EC·메시징 불확실성</strong>이고, 실무 기본값은 <strong>Outbox(이중쓰기 제거) + 멱등 소비자 (중복 안전) + Saga(보상)</strong> 다. ES 를 쓰면 <strong>스냅샷/아카이빙·스키마 버저닝</strong>이 생존 전략이다.</p><h4 id=트레이드오프-관계-분석>트레이드오프 관계 분석<a hidden class=anchor aria-hidden=true href=#트레이드오프-관계-분석>#</a></h4><p>CQRS 는 <strong>쓰기=정확성</strong>, <strong>읽기=속도</strong>를 따로 최적화해 성능과 확장을 얻는 대신, <strong>복잡도와 운영 부담</strong>을 치른다.<br>강한 즉시 일관성이 필요한 기능은 동기화·RPC 를, 대량 조회·피드·검색은 비동기·이벤트·폴리글랏으로 가져가고, 신뢰성은 <strong>Outbox</strong>, 분산 일관성은 <strong>Saga</strong>, UX 는 <strong>낙관적 UI</strong>로 메운다.</p><table><thead><tr><th>트레이드오프 축</th><th>선택지</th><th>장점</th><th>단점</th><th>적용 기준</th><th>관련 패턴/완화</th></tr></thead><tbody><tr><td>성능/확장성 ↔ 복잡도</td><td>CRUD</td><td>단순, 운영 쉬움</td><td>확장/튜닝 충돌</td><td>소규모, 즉시일관성 강함</td><td>-</td></tr><tr><td></td><td>CQRS</td><td>독립 최적화·확장</td><td>구조·운영 복잡</td><td>R≫W, 질의 다양</td><td>프로젝션/캐시</td></tr><tr><td>일관성 ↔ 확장성</td><td>동기 반영</td><td>최신성 보장</td><td>지연·결합↑</td><td>결제·재고 등</td><td>트랜잭션/RPC</td></tr><tr><td></td><td>비동기 반영</td><td>처리량·내결함성↑</td><td>RYW 미보장</td><td>피드/리포트</td><td>낙관적 UI/세션 일관성</td></tr><tr><td>신뢰성 ↔ 단순성</td><td>직접 발행</td><td>구현 간단</td><td>유실·중복 위험</td><td>프로토타입</td><td>-</td></tr><tr><td></td><td>Outbox</td><td>원자성·재시도·멱등</td><td>릴레이 운영 부담</td><td>프로덕션</td><td>멱등 키/DLQ</td></tr><tr><td>일관성 ↔ 유연성</td><td>단일 트랜잭션</td><td>ACID 롤백</td><td>경계 확장 불가</td><td>모놀리식</td><td>-</td></tr><tr><td></td><td>Saga</td><td>분산 일관성·확장</td><td>보상·타임아웃 복잡</td><td>다 서비스 쓰기</td><td>오케스트레이션/코레오</td></tr><tr><td>유연성 ↔ 운영 부담</td><td>단일 DB</td><td>운영 단순</td><td>튜닝 충돌</td><td>단순 도메인</td><td>-</td></tr><tr><td></td><td>폴리글랏</td><td>목적별 최적화</td><td>거버넌스·비용↑</td><td>대규모/다양 질의</td><td>스키마 버전닝/백필</td></tr><tr><td>결합도/지연 ↔ 복잡도</td><td>동기 RPC</td><td>단순·예측가능</td><td>스파이크 취약</td><td>강한 상호의존</td><td>Circuit Breaker</td></tr><tr><td></td><td>이벤트 구독</td><td>느슨 결합·버퍼링</td><td>순서·중복 처리</td><td>비동기 허용</td><td>멱등성/리플레이</td></tr></tbody></table><ul><li><strong>효과는 분명</strong>(읽기/쓰기 독립 최적화·확장) 하지만, <strong>대가도 분명</strong>(복잡도·운영비용).</li><li>도입은 <strong>핵심 병목부터</strong>: 기본 CQRS → <strong>Outbox</strong>(신뢰성) → <strong>프로젝션 SLA</strong> → <strong>Saga</strong>(분산 쓰기) 순으로 단계적 확대가 안전하다.</li><li>UX 는 기술이 아닌 <strong>경험 설계</strong>로 보완 (낙관적 UI, 세션 일관성, 재시도·정정 플로우).</li></ul><pre class=mermaid>graph LR
    A[성능 향상] &lt;--&gt; B[복잡성 증가]
    C[확장성] &lt;--&gt; D[일관성 약화]
    E[유연성] &lt;--&gt; F[운영 부담]
    G[개발 자유도] &lt;--&gt; H[통합 복잡도]
</pre><h3 id=구현-및-분류-implementation--classification>구현 및 분류 (Implementation & Classification)<a hidden class=anchor aria-hidden=true href=#구현-및-분류-implementation--classification>#</a></h3><h4 id=구현-기법-및-방법>구현 기법 및 방법<a hidden class=anchor aria-hidden=true href=#구현-기법-및-방법>#</a></h4><ul><li><strong>단일 저장소</strong>로 " 코드는 분리하되 DB 는 하나 " 에서 시작 → <strong>분리 저장소</strong>로 읽기/쓰기를 따로 확장 → <strong>이벤트 소싱 결합</strong>으로 감사/재생까지.</li><li>동기화·정합성은 <strong>Outbox+CDC</strong>로 안전하게, 순서는 <strong>파티션 키</strong>로 지킨다.</li><li>단순 CRUD 면 굳이 복잡도를 올리지 않는다. 필요에 따라 성숙도를 올린다.</li></ul><table><thead><tr><th>분류</th><th>정의</th><th>구성 요소</th><th>원리</th><th>목적</th><th>사용 상황</th><th>특징</th></tr></thead><tbody><tr><td>단일 저장소 CQRS</td><td>한 DB 로 쓰기/읽기 <strong>로직·모델만 분리</strong></td><td>Command/Query Handler, Shared DB</td><td>쓰기·읽기 모델 분리 (논리), 동일 저장소</td><td>구조적 분리 도입, 저비용 시작</td><td>초기 단계, 단일 서비스</td><td>단순·낮은 운영비, 이행 쉬움. 필요 시 분리 저장소로 확장</td></tr><tr><td>분리된 저장소 CQRS</td><td>쓰기/읽기 <strong>DB 분리</strong></td><td>Write DB(RDB), Read DB(NoSQL/캐시), 동기화</td><td>쓰기 후 이벤트→읽기 저장소 갱신</td><td>독립 확장, 쿼리 성능 최적화</td><td>읽기 비율↑, 고성능 UI</td><td>스키마 다변화·확장 용이, <strong>최종 일관성</strong> 설계 필요</td></tr><tr><td>ES + CQRS</td><td><strong>이벤트 스토어</strong>가 진실원, 이벤트 재생으로 읽기 모델</td><td>Event Store, Aggregate, Projection</td><td>변경을 이벤트로 영속, 재생으로 상태/뷰 구성</td><td>감사/시간여행/재구성</td><td>규제/감사, 복잡한 도메인</td><td>이력 완전, 복잡도↑·스냅샷/재생 비용 고려</td></tr><tr><td>Outbox + CDC</td><td>DB 트랜잭션 안에 <strong>이벤트 기록</strong>, CDC 로 브로커 전송</td><td>Outbox Table, CDC(Debezium 등), Broker</td><td>&ldquo;DB 쓰기 = Outbox 기록 " 원자화 → CDC</td><td>이중 쓰기/유실 방지</td><td>Kafka·Debezium 환경</td><td>일관성↑, 지연 약간↑, 표준화 쉬움</td></tr><tr><td>파티션 키 설계</td><td><strong>키별 파티션 고정</strong>으로 파티션 내 순서 보장</td><td>Producer(Key), Topic/Partition</td><td>동일 키→동일 파티션, 파티션 내 순서</td><td>상태 전이 순서 보장</td><td>주문/계정 등 엔티티별 이벤트</td><td>글로벌 순서 X, 키 선정이 관건</td></tr></tbody></table><p>단일 DB 로 <strong>논리 분리</strong>부터 시작하고, 필요 시 <strong>저장소 분리</strong>로 확장한다. <strong>이벤트 소싱</strong>은 감사/재생이 필요할 때 채택한다. <strong>정합성</strong>은 Outbox+CDC 로, <strong>순서</strong>는 파티션 키로 보장한다. 단순 도메인엔 과도 설계를 피한다.</p><h5 id=단일-저장소--outbox>단일 저장소 + Outbox<a hidden class=anchor aria-hidden=true href=#단일-저장소--outbox>#</a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a class=lnlinks href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a class=lnlinks href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a class=lnlinks href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a class=lnlinks href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a class=lnlinks href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a class=lnlinks href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a class=lnlinks href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a class=lnlinks href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a class=lnlinks href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a class=lnlinks href=#hl-6-41>41</a>
</span><span class=lnt id=hl-6-42><a class=lnlinks href=#hl-6-42>42</a>
</span><span class=lnt id=hl-6-43><a class=lnlinks href=#hl-6-43>43</a>
</span><span class=lnt id=hl-6-44><a class=lnlinks href=#hl-6-44>44</a>
</span><span class=lnt id=hl-6-45><a class=lnlinks href=#hl-6-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># pip install fastapi uvicorn sqlalchemy psycopg2-binary pydantic</span>
</span></span><span class=line><span class=cl><span class=c1># 핵심: 동일 트랜잭션 내에 &#39;도메인 쓰기&#39;와 &#39;outbox 이벤트 기록&#39;을 함께 커밋</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span> <span class=n>JSON</span><span class=p>,</span> <span class=n>text</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>declarative_base</span><span class=p>,</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=s2>&#34;postgresql://user:pass@localhost/app&#34;</span><span class=p>,</span> <span class=n>future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>,</span> <span class=n>expire_on_commit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;orders&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;CREATED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Outbox</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;outbox&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>aggregate_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>          <span class=c1># e.g. &#34;OrderCreated&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>JSON</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateOrderCommand</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>cmd</span><span class=p>:</span> <span class=n>CreateOrderCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>Session</span><span class=o>.</span><span class=n>begin</span><span class=p>()</span> <span class=k>as</span> <span class=n>s</span><span class=p>:</span>  <span class=c1># 1) 트랜잭션 시작</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=n>customer_id</span><span class=o>=</span><span class=n>cmd</span><span class=o>.</span><span class=n>customer_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2) 같은 트랜잭션에서 Outbox 레코드 삽입 (정합성 보장)</span>
</span></span><span class=line><span class=cl>        <span class=n>evt</span> <span class=o>=</span> <span class=n>Outbox</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate_id</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;OrderCreated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;orderId&#34;</span><span class=p>:</span> <span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=s2>&#34;customerId&#34;</span><span class=p>:</span> <span class=n>order</span><span class=o>.</span><span class=n>customer_id</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>evt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3) Debezium Outbox Router가 outbox 테이블 CDC→Kafka로 게시(비동기)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;orderId&#34;</span><span class=p>:</span> <span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;CREATED&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>위 패턴이 &ldquo;<strong>Outbox+CDC</strong>&rdquo; 의 요지이다.</li><li>DB 커밋=이벤트 기록이 원자적으로 보장되므로 이중 쓰기 문제가 사라진다.</li><li>Debezium 이 <code>outbox</code> 테이블만 캡처해 브로커로 전달.</li></ul><h5 id=분리-저장소--파티션-키--프로젝션>분리 저장소 + 파티션 키 + 프로젝션<a hidden class=anchor aria-hidden=true href=#분리-저장소--파티션-키--프로젝션>#</a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20>20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21>21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22>22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23>23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24>24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25>25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26>26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27>27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28>28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29>29</a>
</span><span class=lnt id=hl-7-30><a class=lnlinks href=#hl-7-30>30</a>
</span><span class=lnt id=hl-7-31><a class=lnlinks href=#hl-7-31>31</a>
</span><span class=lnt id=hl-7-32><a class=lnlinks href=#hl-7-32>32</a>
</span><span class=lnt id=hl-7-33><a class=lnlinks href=#hl-7-33>33</a>
</span><span class=lnt id=hl-7-34><a class=lnlinks href=#hl-7-34>34</a>
</span><span class=lnt id=hl-7-35><a class=lnlinks href=#hl-7-35>35</a>
</span><span class=lnt id=hl-7-36><a class=lnlinks href=#hl-7-36>36</a>
</span><span class=lnt id=hl-7-37><a class=lnlinks href=#hl-7-37>37</a>
</span><span class=lnt id=hl-7-38><a class=lnlinks href=#hl-7-38>38</a>
</span><span class=lnt id=hl-7-39><a class=lnlinks href=#hl-7-39>39</a>
</span><span class=lnt id=hl-7-40><a class=lnlinks href=#hl-7-40>40</a>
</span><span class=lnt id=hl-7-41><a class=lnlinks href=#hl-7-41>41</a>
</span><span class=lnt id=hl-7-42><a class=lnlinks href=#hl-7-42>42</a>
</span><span class=lnt id=hl-7-43><a class=lnlinks href=#hl-7-43>43</a>
</span><span class=lnt id=hl-7-44><a class=lnlinks href=#hl-7-44>44</a>
</span><span class=lnt id=hl-7-45><a class=lnlinks href=#hl-7-45>45</a>
</span><span class=lnt id=hl-7-46><a class=lnlinks href=#hl-7-46>46</a>
</span><span class=lnt id=hl-7-47><a class=lnlinks href=#hl-7-47>47</a>
</span><span class=lnt id=hl-7-48><a class=lnlinks href=#hl-7-48>48</a>
</span><span class=lnt id=hl-7-49><a class=lnlinks href=#hl-7-49>49</a>
</span><span class=lnt id=hl-7-50><a class=lnlinks href=#hl-7-50>50</a>
</span><span class=lnt id=hl-7-51><a class=lnlinks href=#hl-7-51>51</a>
</span><span class=lnt id=hl-7-52><a class=lnlinks href=#hl-7-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// npm i kafkajs mongodb
</span></span></span><span class=line><span class=cl><span class=c1>// 핵심: (1) Producer가 &#34;주문ID&#34;를 파티션 키로 사용 → 파티션 내 순서 보장
</span></span></span><span class=line><span class=cl><span class=c1>//      (2) Consumer가 이벤트를 받아 MongoDB 읽기 모델을 업데이트(프로젝션)
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Kafka</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;kafkajs&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>MongoClient</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;mongodb&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 1) Producer: 파티션 키=orderId
</span></span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>publishOrderEvent</span><span class=p>(</span><span class=nx>broker</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>orderId</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>payload</span>: <span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>kafka</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Kafka</span><span class=p>({</span> <span class=nx>clientId</span><span class=o>:</span> <span class=s2>&#34;orders&#34;</span><span class=p>,</span> <span class=nx>brokers</span><span class=o>:</span> <span class=p>[</span><span class=nx>broker</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>producer</span> <span class=o>=</span> <span class=nx>kafka</span><span class=p>.</span><span class=nx>producer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>producer</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>producer</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>topic</span><span class=o>:</span> <span class=s2>&#34;order.events&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>messages</span><span class=o>:</span> <span class=p>[{</span> <span class=nx>key</span>: <span class=kt>orderId</span><span class=p>,</span> <span class=nx>value</span>: <span class=kt>JSON.stringify</span><span class=p>(</span><span class=nx>payload</span><span class=p>)</span> <span class=p>}],</span> <span class=c1>// 파티션 키
</span></span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>producer</span><span class=p>.</span><span class=nx>disconnect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 2) Consumer/Projection: MongoDB 읽기 모델 업데이트
</span></span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>startProjection</span><span class=p>(</span><span class=nx>broker</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>mongoUri</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>kafka</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Kafka</span><span class=p>({</span> <span class=nx>clientId</span><span class=o>:</span> <span class=s2>&#34;orders-projection&#34;</span><span class=p>,</span> <span class=nx>brokers</span><span class=o>:</span> <span class=p>[</span><span class=nx>broker</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>consumer</span> <span class=o>=</span> <span class=nx>kafka</span><span class=p>.</span><span class=nx>consumer</span><span class=p>({</span> <span class=nx>groupId</span><span class=o>:</span> <span class=s2>&#34;orders-read-model&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mongo</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MongoClient</span><span class=p>(</span><span class=nx>mongoUri</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>mongo</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>view</span> <span class=o>=</span> <span class=nx>mongo</span><span class=p>.</span><span class=nx>db</span><span class=p>(</span><span class=s2>&#34;read&#34;</span><span class=p>).</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;order_views&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>consumer</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>consumer</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>({</span> <span class=nx>topic</span><span class=o>:</span> <span class=s2>&#34;order.events&#34;</span><span class=p>,</span> <span class=nx>fromBeginning</span>: <span class=kt>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>consumer</span><span class=p>.</span><span class=nx>run</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>eachMessage</span>: <span class=kt>async</span> <span class=p>({</span> <span class=nx>message</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>message</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>event</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>toString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 이벤트 타입에 따라 읽기 모델 비정규화/업데이트
</span></span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nx>view</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=nx>orderId</span>: <span class=kt>event.orderId</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=nx>$set</span><span class=o>:</span> <span class=p>{</span> <span class=nx>orderId</span>: <span class=kt>event.orderId</span><span class=p>,</span> <span class=nx>customerId</span>: <span class=kt>event.customerId</span><span class=p>,</span> <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;CREATED&#34;</span> <span class=p>}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=nx>upsert</span>: <span class=kt>true</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;OrderPaid&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nx>view</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span> <span class=nx>orderId</span>: <span class=kt>event.orderId</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>$set</span><span class=o>:</span> <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;PAID&#34;</span> <span class=p>}</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 사용 예시
</span></span></span><span class=line><span class=cl><span class=c1>// publishOrderEvent(&#34;localhost:9092&#34;, &#34;order-123&#34;, { type: &#34;OrderCreated&#34;, orderId: &#34;order-123&#34;, customerId: &#34;c-1&#34; });
</span></span></span><span class=line><span class=cl><span class=c1>// startProjection(&#34;localhost:9092&#34;, &#34;mongodb://localhost:27017&#34;).then(() =&gt; console.log(&#34;projection running&#34;));
</span></span></span></code></pre></td></tr></table></div></div><ul><li>같은 키 (<code>orderId</code>) 는 <strong>같은 파티션</strong>으로 가므로 <strong>순서가 보장</strong>된다.</li><li>읽기 모델 (MongoDB) 은 비정규화된 뷰를 유지한다.</li></ul><h4 id=분류-기준에-따른-유형-구분>분류 기준에 따른 유형 구분<a hidden class=anchor aria-hidden=true href=#분류-기준에-따른-유형-구분>#</a></h4><p>CQRS 를 <strong>레고 블록</strong>처럼 생각하자.</p><ol><li>먼저 <strong>분리 수준</strong> 블록 (Type 1→2→3) 중 가능한 수준을 고른다.</li><li>다음 <strong>저장소 구성</strong>(단일↔이중↔폴리글랏) 을 고르고,</li><li><strong>일관성 방식</strong>(동기↔비동기) 을 정한다.</li><li>필요하면 <strong>이벤트 블록</strong>(Outbox/ES) 까지 붙인다.<br>→ 이렇게 조합해 <strong>지금의 요구</strong>(트래픽, 팀, 규정) 에 맞춘다.</li></ol><table><thead><tr><th>분류 축</th><th>유형</th><th>핵심 설명</th><th>언제 쓰나</th><th>트레이드오프/주의</th></tr></thead><tbody><tr><td><strong>분리 수준</strong></td><td>Type 1: 클래스 분리</td><td>명령/조회 클래스를 분리 (같은 모델)</td><td>초기 진입, 코드 충돌 완화</td><td>성능 이득 제한.</td></tr><tr><td></td><td>Type 2: 모델 분리</td><td>명령/조회 <strong>도메인 모델</strong> 분리, 동일 DB</td><td>읽기/쓰기 변경 이유가 뚜렷할 때</td><td>스키마/코드 중복 증가.</td></tr><tr><td></td><td><strong>Type 3: 저장소 분리</strong></td><td>Write-Read 저장소 분리 (읽기는 프로젝션)</td><td>대규모 조회/확장성 최우선</td><td>최종 일관성·동기화 파이프라인 필요.</td></tr><tr><td><strong>저장소 구성</strong></td><td>단일 DB CQRS</td><td>같은 DB, 읽기용 뷰/테이블·인덱스</td><td>초기/운영 단순화</td><td>읽기 확장 한계.</td></tr><tr><td></td><td>이중 DB CQRS</td><td>Write/Read DB 분리</td><td>읽기 폭증, 비용 최적화</td><td>복제/동기화 운영 필요.</td></tr><tr><td></td><td>폴리글랏</td><td>서로 다른 DB 기술 믹스</td><td>워크로드별 최적화</td><td>복잡한 운영·보안 거버넌스.</td></tr><tr><td><strong>일관성</strong></td><td>동기</td><td>요청 내 읽기 즉시 반영</td><td>강한 일관성·소규모</td><td>확장성 제한.</td></tr><tr><td></td><td><strong>비동기 (최종)</strong></td><td>이벤트로 프로젝션 갱신</td><td>대규모·고처리량 시스템</td><td>지연·재시도/멱등성 설계 필요.</td></tr><tr><td><strong>이벤트 결합</strong></td><td>Outbox+CDC</td><td>이중쓰기 방지, 신뢰성↑</td><td>다중 스토어 동기화</td><td>CDC 인프라 운영.</td></tr><tr><td></td><td><strong>CQRS+ES</strong></td><td>이벤트 스토어 + 프로젝션 재생</td><td>감사/이력 필수 도메인</td><td>설계/운영 복잡성↑.</td></tr><tr><td><strong>적용 범위</strong></td><td>도메인 단위</td><td>특정 바운디드 컨텍스트만 적용</td><td>점진 도입</td><td>경계 설계 필요.</td></tr><tr><td></td><td>시스템 전역</td><td>전 서비스로 확장</td><td>공통 거버넌스 용이</td><td>락인·조직 복잡성↑.</td></tr></tbody></table><p>핵심은 <strong>분리 수준을 적정선으로 잡고</strong>(Type 1→3), 그 위에 <strong>저장소 구성</strong>과 <strong>일관성 방식</strong>을 조합하는 것이다. <strong>비동기 + 프로젝션</strong>이 대규모에 흔하고, <strong>Outbox/ES</strong>는 필요 시점에만 더해 운영 복잡성을 통제한다.</p><h3 id=실무-적용-practical-application>실무 적용 (Practical Application)<a hidden class=anchor aria-hidden=true href=#실무-적용-practical-application>#</a></h3><h4 id=실습-예제-및-코드-구현>실습 예제 및 코드 구현<a hidden class=anchor aria-hidden=true href=#실습-예제-및-코드-구현>#</a></h4><h5 id=간단한-주문-시스템에서-cqrs-를-적용>간단한 주문 시스템에서 CQRS 를 적용<a hidden class=anchor aria-hidden=true href=#간단한-주문-시스템에서-cqrs-를-적용>#</a></h5><p><strong>시나리오</strong>: 간단한 주문 시스템에서 CQRS 를 적용해 쓰기/읽기 분리</p><p><strong>시스템 구성</strong>:</p><ul><li>Command API (FastAPI)</li><li>Query API (FastAPI)</li><li>Kafka (이벤트 브로커)</li><li>PostgreSQL (쓰기 DB)</li><li>Redis (읽기 캐시)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    C[Client] --&gt; CA[Command API]
    CA --&gt; CH[Command Handler]
    CH --&gt; WDB[Write DB]
    CH --&gt; EB[Event Bus]
    EB --&gt; QH[Query Handler]
    QH --&gt; RDB[Read DB]
    C --&gt; QA[Query API]
    QA --&gt; RDB
</pre><p><strong>Workflow</strong>:</p><ol><li>Client 가 주문 생성 요청 (Command) 전송</li><li>Command Handler 가 Write DB 저장 후 이벤트 발행</li><li>Query Handler 가 이벤트 수신 후 Read DB 업데이트</li><li>Client 가 Query API 로 조회 요청 → Read DB 응답</li></ol><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 읽기와 쓰기 동일 DB, 쿼리 성능 저하</li><li>도입 후: 읽기 요청 성능 향상, 쓰기와 독립 확장 가능</li></ul><p><strong>구현 예시</strong> (Python/FastAPI + Redis):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span><span class=lnt id=hl-9-23><a class=lnlinks href=#hl-9-23>23</a>
</span><span class=lnt id=hl-9-24><a class=lnlinks href=#hl-9-24>24</a>
</span><span class=lnt id=hl-9-25><a class=lnlinks href=#hl-9-25>25</a>
</span><span class=lnt id=hl-9-26><a class=lnlinks href=#hl-9-26>26</a>
</span><span class=lnt id=hl-9-27><a class=lnlinks href=#hl-9-27>27</a>
</span><span class=lnt id=hl-9-28><a class=lnlinks href=#hl-9-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Command API 예시</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaProducer</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>producer</span> <span class=o>=</span> <span class=n>KafkaProducer</span><span class=p>(</span><span class=n>bootstrap_servers</span><span class=o>=</span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>order</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. Write DB에 저장 (간략화 예시)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Saving order: </span><span class=si>{</span><span class=n>order</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 이벤트 발행</span>
</span></span><span class=line><span class=cl>    <span class=n>producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;order_created&#39;</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>order</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;order created&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Query API 예시</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>query_app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cache</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@query_app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Redis 캐시 조회</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=k>if</span> <span class=n>data</span> <span class=k>else</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Not found&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Command API 는 쓰기와 이벤트 발행, Query API 는 읽기 전용 캐시 조회를 담당.</li></ul><h5 id=읽기-모델-projection-을-redis-와-opensearch-로-갱신>읽기 모델 (Projection) 을 Redis 와 OpenSearch 로 갱신<a hidden class=anchor aria-hidden=true href=#읽기-모델-projection-을-redis-와-opensearch-로-갱신>#</a></h5><p><strong>시나리오</strong>: " 주문 (Order) 생성→결제 승인→배송 시작 " 이벤트가 발생하면, 읽기 모델 (Projection) 을 Redis 와 OpenSearch 로 갱신하는 <strong>CQRS+Outbox</strong> 미니 시스템.</p><p><strong>시스템 구성</strong>:</p><ul><li>FastAPI(Command/Query API)</li><li>PostgreSQL(Write)</li><li><strong>Outbox 테이블</strong></li><li>Debezium CDC → Kafka(Event Bus), <strong>Projection Consumer</strong>(Python), Redis(OpenSearch 대체 가능)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
  C[Client] --&gt; CA[&#34;Command API(FastAPI)&#34;]
  CA --&gt; WDB[(PostgreSQL)]
  CA --&gt; OUTBOX[(outbox)]
  Deb[Debezium CDC] --&gt; K[Kafka]
  K --&gt; PC[Projection Consumer]
  PC --&gt; R[Redis - Read Model]
  C --&gt; QA[&#34;Query API(FastAPI)&#34;]
  QA --&gt; R
</pre><p><strong>Workflow</strong>:</p><ol><li>Command API 가 쓰기 트랜잭션으로 <code>orders</code> 와 <code>outbox</code> 에 기록 (이중 쓰기 방지)</li><li>Debezium 이 outbox 변화 감지 → Kafka 토픽 발행</li><li>Projection Consumer 가 이벤트를 수신하여 Redis 의 읽기 모델 업데이트</li><li>Query API 는 Redis 에서 빠른 조회 응답</li></ol><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: 동일 DB 에서 조인/인덱스 경쟁으로 조회 지연</li><li>도입 후: 읽기 경로 짧고 (캐시/키 조회), 쓰기 확장과 독립적 운영</li></ul><p><strong>구현 예시</strong> (Python/SQL - 핵심 부분 주석 포함)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18>18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19>19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20>20</a>
</span><span class=lnt id=hl-11-21><a class=lnlinks href=#hl-11-21>21</a>
</span><span class=lnt id=hl-11-22><a class=lnlinks href=#hl-11-22>22</a>
</span><span class=lnt id=hl-11-23><a class=lnlinks href=#hl-11-23>23</a>
</span><span class=lnt id=hl-11-24><a class=lnlinks href=#hl-11-24>24</a>
</span><span class=lnt id=hl-11-25><a class=lnlinks href=#hl-11-25>25</a>
</span><span class=lnt id=hl-11-26><a class=lnlinks href=#hl-11-26>26</a>
</span><span class=lnt id=hl-11-27><a class=lnlinks href=#hl-11-27>27</a>
</span><span class=lnt id=hl-11-28><a class=lnlinks href=#hl-11-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># FastAPI Command API: 트랜잭션 내 본데이터+Outbox에 함께 기록하여 이중 쓰기 문제 방지</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>uuid</span><span class=o>,</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;dbname=orders user=app password=secret host=localhost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>payload</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>evt</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;event_id&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;aggregate_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;occurred_at&#34;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;version&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 1) 본 데이터 저장 (쓰기 모델)</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;INSERT INTO orders(id, status, total_amount) VALUES (</span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>, </span><span class=si>%s</span><span class=s2>)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;CREATED&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=p>[</span><span class=s2>&#34;total_amount&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=c1># 2) Outbox에 이벤트 기록 (동일 트랜잭션)</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;INSERT INTO outbox(event_id, aggregate_id, event_type, payload, occurred_at, status)
</span></span></span><span class=line><span class=cl><span class=s2>                           VALUES (</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>, to_timestamp(</span><span class=si>%s</span><span class=s2>), &#39;PENDING&#39;)&#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>evt</span><span class=p>[</span><span class=s2>&#34;event_id&#34;</span><span class=p>],</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;aggregate_id&#34;</span><span class=p>],</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>],</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>evt</span><span class=p>),</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;occurred_at&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;created&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- PostgreSQL 테이블 (쓰기 모델 + Outbox)
</span></span></span><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>total_amount</span><span class=w> </span><span class=nb>numeric</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>outbox</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>event_id</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>aggregate_id</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>event_type</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>payload</span><span class=w> </span><span class=n>jsonb</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>occurred_at</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>-- Debezium은 outbox 테이블의 변경을 캡처하여 Kafka로 전달 (CDC)
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Outbox+CDC 구성이 <strong>이중 쓰기 문제</strong>를 해결하는 정석 패턴.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span><span class=lnt id=hl-13-17><a class=lnlinks href=#hl-13-17>17</a>
</span><span class=lnt id=hl-13-18><a class=lnlinks href=#hl-13-18>18</a>
</span><span class=lnt id=hl-13-19><a class=lnlinks href=#hl-13-19>19</a>
</span><span class=lnt id=hl-13-20><a class=lnlinks href=#hl-13-20>20</a>
</span><span class=lnt id=hl-13-21><a class=lnlinks href=#hl-13-21>21</a>
</span><span class=lnt id=hl-13-22><a class=lnlinks href=#hl-13-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Projection Consumer (Kafka -&gt; Redis): 동일 aggregate_id 키를 사용해 순서 보장(단일 파티션 가정)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaConsumer</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span><span class=o>,</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>consumer</span> <span class=o>=</span> <span class=n>KafkaConsumer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;orders-events&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap_servers</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;localhost:9092&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>group_id</span><span class=o>=</span><span class=s2>&#34;projection-readmodel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>enable_auto_commit</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>consumer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>evt</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>agg_id</span> <span class=o>=</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;aggregate_id&#34;</span><span class=p>]</span>  <span class=c1># 파티션 키로 설정되어 있다고 가정</span>
</span></span><span class=line><span class=cl>    <span class=c1># 이벤트 타입별 Projection 갱신</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>agg_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;CREATED&#34;</span><span class=p>,</span> <span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;total_amount&#34;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;OrderPaid&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>agg_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;PAID&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>evt</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;OrderShipped&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>agg_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;SHIPPED&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>  <span class=c1># at-least-once, idempotent 갱신 로직 권장</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>파티션 키=주문 ID 로 설정하면 <strong>순서 보장</strong>(같은 파티션) → 상태 전이 안전.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># FastAPI Query API: 읽기 전용(Projection) 경로</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span><span class=o>,</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@q.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>hgetall</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span> <span class=k>if</span> <span class=n>data</span> <span class=k>else</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;not-found&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=게시글-등록-및-조회-서비스>게시글 등록 및 조회 서비스<a hidden class=anchor aria-hidden=true href=#게시글-등록-및-조회-서비스>#</a></h5><p><strong>시나리오</strong>: 게시글 등록 및 조회 서비스 (도메인별 CQRS 패턴 구현)</p><p><strong>시스템 구성</strong>:</p><ul><li>Board Command Service (게시글 등록/수정/삭제)</li><li>Board Query Service (게시글 조회)</li><li>Message Broker (Kafka 등)</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    User[사용자] --&gt; API
    API --&gt; CommandService
    API --&gt; QueryService
    CommandService --&gt; WriteDB
    CommandService --&gt; EventBus[Kafka/EventBus]
    EventBus --&gt; QueryService
    QueryService --&gt; ReadDB
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 게시글 등록 요청 (Command)</li><li>CommandService 가 처리 후 WriteDB 저장/이벤트 발행</li><li>QueryService 가 이벤트를 감지, 게시글 정보 갱신</li><li>사용자는 실시간으로 게시글을 조회 (쿼리)</li></ol><p><strong>핵심 역할</strong>: 독립적 읽기/쓰기 구조로 실시간 데이터 일관성 보장</p><p><strong>유무에 따른 차이점</strong>:</p><ul><li>도입 전: DB 트랜잭션 충돌, 조회/쓰기 부하 관리 어려움</li><li>도입 후: 읽기와 쓰기 트래픽 분산, 데이터 확장 및 성능 개선</li></ul><p><strong>구현 예시</strong> (Python)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19>19</a>
</span><span class=lnt id=hl-16-20><a class=lnlinks href=#hl-16-20>20</a>
</span><span class=lnt id=hl-16-21><a class=lnlinks href=#hl-16-21>21</a>
</span><span class=lnt id=hl-16-22><a class=lnlinks href=#hl-16-22>22</a>
</span><span class=lnt id=hl-16-23><a class=lnlinks href=#hl-16-23>23</a>
</span><span class=lnt id=hl-16-24><a class=lnlinks href=#hl-16-24>24</a>
</span><span class=lnt id=hl-16-25><a class=lnlinks href=#hl-16-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># commands.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreatePostCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;게시글 생성 명령 객체 - CQRS 패턴의 명령 모델 역할&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>title</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>title</span> <span class=o>=</span> <span class=n>title</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>content</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># handlers.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CommandHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;명령 처리 핸들러 - 게시글 생성 로직 분리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 비즈니스 로직 수행, DB에 저장, 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=n>save_to_write_db</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>publish_event</span><span class=p>(</span><span class=s2>&#34;PostCreated&#34;</span><span class=p>,</span> <span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># queries.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetPostQuery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;게시글 조회 쿼리 객체 - CQRS 패턴의 조회 모델 역할&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>post_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>post_id</span> <span class=o>=</span> <span class=n>post_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QueryHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;조회 처리 핸들러 - 읽기 전용 DB 또는 캐시 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>fetch_from_read_db</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>post_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=전자상거래-주문-관리-시스템>전자상거래 주문 관리 시스템<a hidden class=anchor aria-hidden=true href=#전자상거래-주문-관리-시스템>#</a></h5><p><strong>시나리오</strong>: 전자상거래 주문 관리 시스템</p><p><strong>시스템 구성</strong>:</p><ul><li>명령 측: PostgreSQL (주문 데이터)</li><li>조회 측: Redis (주문 요약), Elasticsearch (검색)</li><li>이벤트 버스: Apache Kafka</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    Client[클라이언트] --&gt; API[API 게이트웨이]
    
    API --&gt; CMD[주문 명령 API]
    API --&gt; QRY[주문 조회 API]
    
    CMD --&gt; OrderService[주문 서비스]
    QRY --&gt; QueryService[조회 서비스]
    
    OrderService --&gt; PostgreSQL[(PostgreSQL)]
    OrderService --&gt; Kafka[Apache Kafka]
    
    Kafka --&gt; Projection[프로젝션 서비스]
    Projection --&gt; Redis[(Redis)]
    Projection --&gt; Elasticsearch[(Elasticsearch)]
    
    QueryService --&gt; Redis
    QueryService --&gt; Elasticsearch
</pre><p><strong>Workflow</strong>:</p><ol><li>클라이언트가 주문 생성 요청</li><li>주문 서비스가 비즈니스 로직 검증 후 PostgreSQL 에 저장</li><li>주문 생성 이벤트를 Kafka 로 발행</li><li>프로젝션 서비스가 이벤트를 수신하여 Redis 와 Elasticsearch 업데이트</li><li>조회 요청은 Redis/Elasticsearch 에서 처리</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>CQRS 는 주문 생성 (명령) 과 주문 조회 (쿼리) 를 완전히 분리</li><li>각 저장소는 해당 워크로드에 최적화</li><li>이벤트를 통한 비동기 데이터 동기화</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 단일 데이터베이스에서 복잡한 조인 쿼리로 성능 저하</li><li><strong>도입 후</strong>: 읽기는 비정규화된 뷰에서 빠른 조회, 쓰기는 정규화된 모델에서 일관성 보장</li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>  1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>  2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>  3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>  4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>  5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6>  6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7>  7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8>  8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9>  9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10> 10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11> 11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12> 12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13> 13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14> 14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15> 15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16> 16</a>
</span><span class=lnt id=hl-18-17><a class=lnlinks href=#hl-18-17> 17</a>
</span><span class=lnt id=hl-18-18><a class=lnlinks href=#hl-18-18> 18</a>
</span><span class=lnt id=hl-18-19><a class=lnlinks href=#hl-18-19> 19</a>
</span><span class=lnt id=hl-18-20><a class=lnlinks href=#hl-18-20> 20</a>
</span><span class=lnt id=hl-18-21><a class=lnlinks href=#hl-18-21> 21</a>
</span><span class=lnt id=hl-18-22><a class=lnlinks href=#hl-18-22> 22</a>
</span><span class=lnt id=hl-18-23><a class=lnlinks href=#hl-18-23> 23</a>
</span><span class=lnt id=hl-18-24><a class=lnlinks href=#hl-18-24> 24</a>
</span><span class=lnt id=hl-18-25><a class=lnlinks href=#hl-18-25> 25</a>
</span><span class=lnt id=hl-18-26><a class=lnlinks href=#hl-18-26> 26</a>
</span><span class=lnt id=hl-18-27><a class=lnlinks href=#hl-18-27> 27</a>
</span><span class=lnt id=hl-18-28><a class=lnlinks href=#hl-18-28> 28</a>
</span><span class=lnt id=hl-18-29><a class=lnlinks href=#hl-18-29> 29</a>
</span><span class=lnt id=hl-18-30><a class=lnlinks href=#hl-18-30> 30</a>
</span><span class=lnt id=hl-18-31><a class=lnlinks href=#hl-18-31> 31</a>
</span><span class=lnt id=hl-18-32><a class=lnlinks href=#hl-18-32> 32</a>
</span><span class=lnt id=hl-18-33><a class=lnlinks href=#hl-18-33> 33</a>
</span><span class=lnt id=hl-18-34><a class=lnlinks href=#hl-18-34> 34</a>
</span><span class=lnt id=hl-18-35><a class=lnlinks href=#hl-18-35> 35</a>
</span><span class=lnt id=hl-18-36><a class=lnlinks href=#hl-18-36> 36</a>
</span><span class=lnt id=hl-18-37><a class=lnlinks href=#hl-18-37> 37</a>
</span><span class=lnt id=hl-18-38><a class=lnlinks href=#hl-18-38> 38</a>
</span><span class=lnt id=hl-18-39><a class=lnlinks href=#hl-18-39> 39</a>
</span><span class=lnt id=hl-18-40><a class=lnlinks href=#hl-18-40> 40</a>
</span><span class=lnt id=hl-18-41><a class=lnlinks href=#hl-18-41> 41</a>
</span><span class=lnt id=hl-18-42><a class=lnlinks href=#hl-18-42> 42</a>
</span><span class=lnt id=hl-18-43><a class=lnlinks href=#hl-18-43> 43</a>
</span><span class=lnt id=hl-18-44><a class=lnlinks href=#hl-18-44> 44</a>
</span><span class=lnt id=hl-18-45><a class=lnlinks href=#hl-18-45> 45</a>
</span><span class=lnt id=hl-18-46><a class=lnlinks href=#hl-18-46> 46</a>
</span><span class=lnt id=hl-18-47><a class=lnlinks href=#hl-18-47> 47</a>
</span><span class=lnt id=hl-18-48><a class=lnlinks href=#hl-18-48> 48</a>
</span><span class=lnt id=hl-18-49><a class=lnlinks href=#hl-18-49> 49</a>
</span><span class=lnt id=hl-18-50><a class=lnlinks href=#hl-18-50> 50</a>
</span><span class=lnt id=hl-18-51><a class=lnlinks href=#hl-18-51> 51</a>
</span><span class=lnt id=hl-18-52><a class=lnlinks href=#hl-18-52> 52</a>
</span><span class=lnt id=hl-18-53><a class=lnlinks href=#hl-18-53> 53</a>
</span><span class=lnt id=hl-18-54><a class=lnlinks href=#hl-18-54> 54</a>
</span><span class=lnt id=hl-18-55><a class=lnlinks href=#hl-18-55> 55</a>
</span><span class=lnt id=hl-18-56><a class=lnlinks href=#hl-18-56> 56</a>
</span><span class=lnt id=hl-18-57><a class=lnlinks href=#hl-18-57> 57</a>
</span><span class=lnt id=hl-18-58><a class=lnlinks href=#hl-18-58> 58</a>
</span><span class=lnt id=hl-18-59><a class=lnlinks href=#hl-18-59> 59</a>
</span><span class=lnt id=hl-18-60><a class=lnlinks href=#hl-18-60> 60</a>
</span><span class=lnt id=hl-18-61><a class=lnlinks href=#hl-18-61> 61</a>
</span><span class=lnt id=hl-18-62><a class=lnlinks href=#hl-18-62> 62</a>
</span><span class=lnt id=hl-18-63><a class=lnlinks href=#hl-18-63> 63</a>
</span><span class=lnt id=hl-18-64><a class=lnlinks href=#hl-18-64> 64</a>
</span><span class=lnt id=hl-18-65><a class=lnlinks href=#hl-18-65> 65</a>
</span><span class=lnt id=hl-18-66><a class=lnlinks href=#hl-18-66> 66</a>
</span><span class=lnt id=hl-18-67><a class=lnlinks href=#hl-18-67> 67</a>
</span><span class=lnt id=hl-18-68><a class=lnlinks href=#hl-18-68> 68</a>
</span><span class=lnt id=hl-18-69><a class=lnlinks href=#hl-18-69> 69</a>
</span><span class=lnt id=hl-18-70><a class=lnlinks href=#hl-18-70> 70</a>
</span><span class=lnt id=hl-18-71><a class=lnlinks href=#hl-18-71> 71</a>
</span><span class=lnt id=hl-18-72><a class=lnlinks href=#hl-18-72> 72</a>
</span><span class=lnt id=hl-18-73><a class=lnlinks href=#hl-18-73> 73</a>
</span><span class=lnt id=hl-18-74><a class=lnlinks href=#hl-18-74> 74</a>
</span><span class=lnt id=hl-18-75><a class=lnlinks href=#hl-18-75> 75</a>
</span><span class=lnt id=hl-18-76><a class=lnlinks href=#hl-18-76> 76</a>
</span><span class=lnt id=hl-18-77><a class=lnlinks href=#hl-18-77> 77</a>
</span><span class=lnt id=hl-18-78><a class=lnlinks href=#hl-18-78> 78</a>
</span><span class=lnt id=hl-18-79><a class=lnlinks href=#hl-18-79> 79</a>
</span><span class=lnt id=hl-18-80><a class=lnlinks href=#hl-18-80> 80</a>
</span><span class=lnt id=hl-18-81><a class=lnlinks href=#hl-18-81> 81</a>
</span><span class=lnt id=hl-18-82><a class=lnlinks href=#hl-18-82> 82</a>
</span><span class=lnt id=hl-18-83><a class=lnlinks href=#hl-18-83> 83</a>
</span><span class=lnt id=hl-18-84><a class=lnlinks href=#hl-18-84> 84</a>
</span><span class=lnt id=hl-18-85><a class=lnlinks href=#hl-18-85> 85</a>
</span><span class=lnt id=hl-18-86><a class=lnlinks href=#hl-18-86> 86</a>
</span><span class=lnt id=hl-18-87><a class=lnlinks href=#hl-18-87> 87</a>
</span><span class=lnt id=hl-18-88><a class=lnlinks href=#hl-18-88> 88</a>
</span><span class=lnt id=hl-18-89><a class=lnlinks href=#hl-18-89> 89</a>
</span><span class=lnt id=hl-18-90><a class=lnlinks href=#hl-18-90> 90</a>
</span><span class=lnt id=hl-18-91><a class=lnlinks href=#hl-18-91> 91</a>
</span><span class=lnt id=hl-18-92><a class=lnlinks href=#hl-18-92> 92</a>
</span><span class=lnt id=hl-18-93><a class=lnlinks href=#hl-18-93> 93</a>
</span><span class=lnt id=hl-18-94><a class=lnlinks href=#hl-18-94> 94</a>
</span><span class=lnt id=hl-18-95><a class=lnlinks href=#hl-18-95> 95</a>
</span><span class=lnt id=hl-18-96><a class=lnlinks href=#hl-18-96> 96</a>
</span><span class=lnt id=hl-18-97><a class=lnlinks href=#hl-18-97> 97</a>
</span><span class=lnt id=hl-18-98><a class=lnlinks href=#hl-18-98> 98</a>
</span><span class=lnt id=hl-18-99><a class=lnlinks href=#hl-18-99> 99</a>
</span><span class=lnt id=hl-18-100><a class=lnlinks href=#hl-18-100>100</a>
</span><span class=lnt id=hl-18-101><a class=lnlinks href=#hl-18-101>101</a>
</span><span class=lnt id=hl-18-102><a class=lnlinks href=#hl-18-102>102</a>
</span><span class=lnt id=hl-18-103><a class=lnlinks href=#hl-18-103>103</a>
</span><span class=lnt id=hl-18-104><a class=lnlinks href=#hl-18-104>104</a>
</span><span class=lnt id=hl-18-105><a class=lnlinks href=#hl-18-105>105</a>
</span><span class=lnt id=hl-18-106><a class=lnlinks href=#hl-18-106>106</a>
</span><span class=lnt id=hl-18-107><a class=lnlinks href=#hl-18-107>107</a>
</span><span class=lnt id=hl-18-108><a class=lnlinks href=#hl-18-108>108</a>
</span><span class=lnt id=hl-18-109><a class=lnlinks href=#hl-18-109>109</a>
</span><span class=lnt id=hl-18-110><a class=lnlinks href=#hl-18-110>110</a>
</span><span class=lnt id=hl-18-111><a class=lnlinks href=#hl-18-111>111</a>
</span><span class=lnt id=hl-18-112><a class=lnlinks href=#hl-18-112>112</a>
</span><span class=lnt id=hl-18-113><a class=lnlinks href=#hl-18-113>113</a>
</span><span class=lnt id=hl-18-114><a class=lnlinks href=#hl-18-114>114</a>
</span><span class=lnt id=hl-18-115><a class=lnlinks href=#hl-18-115>115</a>
</span><span class=lnt id=hl-18-116><a class=lnlinks href=#hl-18-116>116</a>
</span><span class=lnt id=hl-18-117><a class=lnlinks href=#hl-18-117>117</a>
</span><span class=lnt id=hl-18-118><a class=lnlinks href=#hl-18-118>118</a>
</span><span class=lnt id=hl-18-119><a class=lnlinks href=#hl-18-119>119</a>
</span><span class=lnt id=hl-18-120><a class=lnlinks href=#hl-18-120>120</a>
</span><span class=lnt id=hl-18-121><a class=lnlinks href=#hl-18-121>121</a>
</span><span class=lnt id=hl-18-122><a class=lnlinks href=#hl-18-122>122</a>
</span><span class=lnt id=hl-18-123><a class=lnlinks href=#hl-18-123>123</a>
</span><span class=lnt id=hl-18-124><a class=lnlinks href=#hl-18-124>124</a>
</span><span class=lnt id=hl-18-125><a class=lnlinks href=#hl-18-125>125</a>
</span><span class=lnt id=hl-18-126><a class=lnlinks href=#hl-18-126>126</a>
</span><span class=lnt id=hl-18-127><a class=lnlinks href=#hl-18-127>127</a>
</span><span class=lnt id=hl-18-128><a class=lnlinks href=#hl-18-128>128</a>
</span><span class=lnt id=hl-18-129><a class=lnlinks href=#hl-18-129>129</a>
</span><span class=lnt id=hl-18-130><a class=lnlinks href=#hl-18-130>130</a>
</span><span class=lnt id=hl-18-131><a class=lnlinks href=#hl-18-131>131</a>
</span><span class=lnt id=hl-18-132><a class=lnlinks href=#hl-18-132>132</a>
</span><span class=lnt id=hl-18-133><a class=lnlinks href=#hl-18-133>133</a>
</span><span class=lnt id=hl-18-134><a class=lnlinks href=#hl-18-134>134</a>
</span><span class=lnt id=hl-18-135><a class=lnlinks href=#hl-18-135>135</a>
</span><span class=lnt id=hl-18-136><a class=lnlinks href=#hl-18-136>136</a>
</span><span class=lnt id=hl-18-137><a class=lnlinks href=#hl-18-137>137</a>
</span><span class=lnt id=hl-18-138><a class=lnlinks href=#hl-18-138>138</a>
</span><span class=lnt id=hl-18-139><a class=lnlinks href=#hl-18-139>139</a>
</span><span class=lnt id=hl-18-140><a class=lnlinks href=#hl-18-140>140</a>
</span><span class=lnt id=hl-18-141><a class=lnlinks href=#hl-18-141>141</a>
</span><span class=lnt id=hl-18-142><a class=lnlinks href=#hl-18-142>142</a>
</span><span class=lnt id=hl-18-143><a class=lnlinks href=#hl-18-143>143</a>
</span><span class=lnt id=hl-18-144><a class=lnlinks href=#hl-18-144>144</a>
</span><span class=lnt id=hl-18-145><a class=lnlinks href=#hl-18-145>145</a>
</span><span class=lnt id=hl-18-146><a class=lnlinks href=#hl-18-146>146</a>
</span><span class=lnt id=hl-18-147><a class=lnlinks href=#hl-18-147>147</a>
</span><span class=lnt id=hl-18-148><a class=lnlinks href=#hl-18-148>148</a>
</span><span class=lnt id=hl-18-149><a class=lnlinks href=#hl-18-149>149</a>
</span><span class=lnt id=hl-18-150><a class=lnlinks href=#hl-18-150>150</a>
</span><span class=lnt id=hl-18-151><a class=lnlinks href=#hl-18-151>151</a>
</span><span class=lnt id=hl-18-152><a class=lnlinks href=#hl-18-152>152</a>
</span><span class=lnt id=hl-18-153><a class=lnlinks href=#hl-18-153>153</a>
</span><span class=lnt id=hl-18-154><a class=lnlinks href=#hl-18-154>154</a>
</span><span class=lnt id=hl-18-155><a class=lnlinks href=#hl-18-155>155</a>
</span><span class=lnt id=hl-18-156><a class=lnlinks href=#hl-18-156>156</a>
</span><span class=lnt id=hl-18-157><a class=lnlinks href=#hl-18-157>157</a>
</span><span class=lnt id=hl-18-158><a class=lnlinks href=#hl-18-158>158</a>
</span><span class=lnt id=hl-18-159><a class=lnlinks href=#hl-18-159>159</a>
</span><span class=lnt id=hl-18-160><a class=lnlinks href=#hl-18-160>160</a>
</span><span class=lnt id=hl-18-161><a class=lnlinks href=#hl-18-161>161</a>
</span><span class=lnt id=hl-18-162><a class=lnlinks href=#hl-18-162>162</a>
</span><span class=lnt id=hl-18-163><a class=lnlinks href=#hl-18-163>163</a>
</span><span class=lnt id=hl-18-164><a class=lnlinks href=#hl-18-164>164</a>
</span><span class=lnt id=hl-18-165><a class=lnlinks href=#hl-18-165>165</a>
</span><span class=lnt id=hl-18-166><a class=lnlinks href=#hl-18-166>166</a>
</span><span class=lnt id=hl-18-167><a class=lnlinks href=#hl-18-167>167</a>
</span><span class=lnt id=hl-18-168><a class=lnlinks href=#hl-18-168>168</a>
</span><span class=lnt id=hl-18-169><a class=lnlinks href=#hl-18-169>169</a>
</span><span class=lnt id=hl-18-170><a class=lnlinks href=#hl-18-170>170</a>
</span><span class=lnt id=hl-18-171><a class=lnlinks href=#hl-18-171>171</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 도메인 모델 (Domain Model)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 애그리게이트 (Order Aggregate)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=s1>&#39;OrderItem&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>total_amount</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_total</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;총 주문 금액 계산 - 도메인 로직&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>price</span> <span class=o>*</span> <span class=n>item</span><span class=o>.</span><span class=n>quantity</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>confirm</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 확정 - 비즈니스 규칙 적용&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=s1>&#39;pending&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;이미 처리된 주문입니다&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s1>&#39;confirmed&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 명령 핸들러 (Command Handler)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateOrderCommandHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>repository</span><span class=p>,</span> <span class=n>event_bus</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>repository</span> <span class=o>=</span> <span class=n>repository</span>  <span class=c1># PostgreSQL 저장소</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span> <span class=o>=</span> <span class=n>event_bus</span>    <span class=c1># Kafka 이벤트 버스</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>:</span> <span class=s1>&#39;CreateOrderCommand&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 명령 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 도메인 객체 생성 및 검증</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>id</span><span class=o>=</span><span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>customer_id</span><span class=o>=</span><span class=n>command</span><span class=o>.</span><span class=n>customer_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>items</span><span class=o>=</span><span class=n>command</span><span class=o>.</span><span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=o>=</span><span class=s1>&#39;pending&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>created_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>total_amount</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 비즈니스 로직 실행</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>total_amount</span> <span class=o>=</span> <span class=n>order</span><span class=o>.</span><span class=n>calculate_total</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>confirm</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 영속성 저장 (PostgreSQL)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>repository</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>order</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 발행 (비동기 처리를 위한 이벤트)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>OrderCreatedEvent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>order_id</span><span class=o>=</span><span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>customer_id</span><span class=o>=</span><span class=n>order</span><span class=o>.</span><span class=n>customer_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>total_amount</span><span class=o>=</span><span class=n>order</span><span class=o>.</span><span class=n>total_amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>items</span><span class=o>=</span><span class=n>order</span><span class=o>.</span><span class=n>items</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 조회 핸들러 (Query Handler)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderQueryHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>elasticsearch_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>           <span class=c1># 빠른 조회용</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>elasticsearch</span> <span class=o>=</span> <span class=n>elasticsearch_client</span>  <span class=c1># 검색용</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_order_summary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 요약 조회 - Redis에서 빠른 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># Redis에서 비정규화된 주문 요약 데이터 조회</span>
</span></span><span class=line><span class=cl>        <span class=n>order_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>hgetall</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>order_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_name&#39;</span><span class=p>:</span> <span class=n>order_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;customer_name&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_amount&#39;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>order_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;total_amount&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>order_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;status&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;item_count&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>order_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;item_count&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>search_orders</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 검색 - Elasticsearch에서 검색&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>search_body</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;bool&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;must&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span><span class=s2>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;customer_id&#34;</span><span class=p>:</span> <span class=n>customer_id</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span><span class=s2>&#34;multi_match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;fields&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;items.name&#34;</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=p>}}</span>
</span></span><span class=line><span class=cl>                    <span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>elasticsearch</span><span class=o>.</span><span class=n>search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>index</span><span class=o>=</span><span class=s2>&#34;orders&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>body</span><span class=o>=</span><span class=n>search_body</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>hit</span><span class=p>[</span><span class=s1>&#39;_source&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>hit</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>][</span><span class=s1>&#39;hits&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 프로젝션 핸들러 (Projection Handler)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderProjectionHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>elasticsearch_client</span><span class=p>,</span> <span class=n>customer_service</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>elasticsearch</span> <span class=o>=</span> <span class=n>elasticsearch_client</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>customer_service</span> <span class=o>=</span> <span class=n>customer_service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_order_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=s1>&#39;OrderCreatedEvent&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주문 생성 이벤트 처리 - 읽기 모델 업데이트&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 고객 정보 조회 (외부 서비스 호출)</span>
</span></span><span class=line><span class=cl>        <span class=n>customer</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>customer_service</span><span class=o>.</span><span class=n>get_customer</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>customer_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Redis에 주문 요약 저장 (빠른 조회용)</span>
</span></span><span class=line><span class=cl>        <span class=n>order_summary</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>customer_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_name&#39;</span><span class=p>:</span> <span class=n>customer</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_amount&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>total_amount</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;confirmed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;item_count&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>items</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=n>order_summary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Elasticsearch에 검색용 문서 저장</span>
</span></span><span class=line><span class=cl>        <span class=n>search_document</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>customer_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;customer_name&#39;</span><span class=p>:</span> <span class=n>customer</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_amount&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>total_amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;confirmed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=p>[{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>item</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=s1>&#39;category&#39;</span><span class=p>:</span> <span class=n>item</span><span class=o>.</span><span class=n>category</span><span class=p>}</span> 
</span></span><span class=line><span class=cl>                     <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>items</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>elasticsearch</span><span class=o>.</span><span class=n>index</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>index</span><span class=o>=</span><span class=s2>&#34;orders&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nb>id</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>body</span><span class=o>=</span><span class=n>search_document</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. API 엔드포인트 (FastAPI 예시)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 명령 API 엔드포인트</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=n>CreateOrderCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 생성 - 명령 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>order_command_handler</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;주문이 성공적으로 생성되었습니다&#34;</span><span class=p>,</span> <span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 조회 API 엔드포인트  </span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 조회 - 쿼리 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span> <span class=o>=</span> <span class=k>await</span> <span class=n>order_query_handler</span><span class=o>.</span><span class=n>get_order_summary</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;주문을 찾을 수 없습니다&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/customers/</span><span class=si>{customer_id}</span><span class=s2>/orders/search&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>search_customer_orders</span><span class=p>(</span><span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>q</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;고객 주문 검색 - 복잡한 쿼리 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>orders</span> <span class=o>=</span> <span class=k>await</span> <span class=n>order_query_handler</span><span class=o>.</span><span class=n>search_orders</span><span class=p>(</span><span class=n>customer_id</span><span class=p>,</span> <span class=n>q</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;orders&#34;</span><span class=p>:</span> <span class=n>orders</span><span class=p>,</span> <span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>orders</span><span class=p>)}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=cqrs--이벤트-소싱--사가-패턴-통합-아키텍처-실전-예시>CQRS + 이벤트 소싱 + 사가 패턴 통합 아키텍처 실전 예시<a hidden class=anchor aria-hidden=true href=#cqrs--이벤트-소싱--사가-패턴-통합-아키텍처-실전-예시>#</a></h5><p><strong>시나리오</strong>: 대형 이커머스에서 <strong>결제와 배송을 포함한 주문 처리 프로세스</strong>를 여러 서비스에 걸친 분산 트랜잭션으로 관리한다.</p><ul><li>주문 생성, 결제 승인, 재고 차감, 배송 예약 등 각 서비스가 CQRS, 이벤트 소싱, 사가 패턴을 조합해 비동기 일관성을 보장한다.</li></ul><p><strong>시스템 구성</strong>:</p><ul><li>Order Command Service (주문 생성/변경)</li><li>Payment Command Service (결제 처리)</li><li>Inventory Command Service (재고 관리)</li><li>Delivery Command Service (배송 예약)</li><li>Event Bus (Kafka/RabbitMQ 등 이벤트 브로커)</li><li>Saga Coordinator (트랜잭션 조정 및 보상 로직)</li><li>각 서비스별 Read DB (Elasticsearch/Redis 등)</li></ul><pre class=mermaid>graph LR
    User[사용자] --&gt; APIGateway[API Gateway]
    APIGateway --&gt; OrderCmdSvc[Order Command Service]
    OrderCmdSvc--&gt;|OrderCreatedEvent|EventBus(Kafka)
    EventBus--&gt;|OrderSagaStart|SagaCoordinator
    SagaCoordinator--&gt;|PaymentCommand|PaymentCmdSvc[Payment Command Service]
    PaymentCmdSvc--&gt;|PaymentApprovedEvent|EventBus
    SagaCoordinator--&gt;|InventoryCommand|InventoryCmdSvc[Inventory Command Service]
    InventoryCmdSvc--&gt;|InventoryReservedEvent|EventBus
    SagaCoordinator--&gt;|DeliveryCommand|DeliveryCmdSvc[Delivery Command Service]
    DeliveryCmdSvc--&gt;|DeliveryScheduledEvent|EventBus
    SagaCoordinator--&gt;|OrderCompletedEvent|EventBus
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자 주문 요청 (Command)</li><li>Order Command 서비스가 주문 생성 후 <strong>OrderCreatedEvent(주문 생성 이벤트)</strong> 발행</li><li>Saga Coordinator(사가 조정자) 가 이벤트 수신, 결제/재고/배송 등 하위 서비스 명령 분산</li><li>각 서비스가 처리 후 <strong>PaymentApprovedEvent(결제 승인 이벤트)</strong>, <strong>InventoryReservedEvent(재고 예약 이벤트)</strong>, <strong>DeliveryScheduledEvent(배송 예약 이벤트)</strong> 등을 이벤트 버스로 발행</li><li>Saga Coordinator 가 이벤트 종합 후, 최종적으로 <strong>OrderCompletedEvent(주문 완료 이벤트)</strong> 발행 또는 실패 시 <strong>보상 트랜잭션 (Compensation)</strong> 수행</li></ol><p><strong>사가 패턴의 통합 처리 Event Flow 설명</strong>:</p><ol><li><strong>OrderCreatedEvent</strong>가 발생하면<br>→ Saga Coordinator(사가 조정자) 가 <strong>ApprovePaymentCommand</strong>를 결제 서비스로 전송</li><li>결제 성공 (PaymentApprovedEvent)<br>→ Saga Coordinator 가 <strong>ReserveInventoryCommand</strong>를 재고 서비스로 전송</li><li>재고 성공 (InventoryReservedEvent)<br>→ Saga Coordinator 가 <strong>ScheduleDeliveryCommand</strong>를 배송 서비스로 전송</li><li>모든 단계가 Success 일 때<br>→ Saga Coordinator 가 <strong>OrderCompletedEvent</strong>를 발행<br>→ 모든 서비스 Read DB 에 최종 상태 반영</li><li>단계별 실패 시 (예: 결제 승인 실패)<br>→ Saga Coordinator 가 보상 명령 (PaymentCompensationCommand 등) 을 발행<br>→ 이전 단계 변경분을 Rollback, 전체 주문 취소 이벤트 (OrderCancelledEvent) 발행</li></ol><p><strong>핵심 역할</strong>:</p><ul><li><strong>CQRS</strong>: 각 서비스에서 읽기/쓰기를 분리해 확장성 확보</li><li><strong>Event Sourcing (이벤트 소싱)</strong>: 상태 변경을 이벤트로 저장, 장애 복구/이력 추적 가능</li><li><strong>Saga Pattern (사가 패턴)</strong>: 다수 서비스 간 프로세스를 이벤트 기반으로 연결, 실패 시 보상 트랜잭션으로 데이터 일관성 유지</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 단일 트랜잭션 실패 시 전체 주문 취소, 장애 복원 어렵고 장애 시 타 서비스 일관성 깨짐</li><li><strong>도입 후</strong>: 서비스별 상태·이력·보상 처리로 분산 트랜잭션 일관성 보장, 장애 복구 용이, 실시간 처리 성능 개선</li></ul><p><strong>구현 예시</strong>:</p><ol><li><p>사가 코디네이터 보상 로직 예시 (Saga Coordinator Compensation Logic)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20>20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21>21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22>22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23>23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24>24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25>25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26>26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27>27</a>
</span><span class=lnt id=hl-20-28><a class=lnlinks href=#hl-20-28>28</a>
</span><span class=lnt id=hl-20-29><a class=lnlinks href=#hl-20-29>29</a>
</span><span class=lnt id=hl-20-30><a class=lnlinks href=#hl-20-30>30</a>
</span><span class=lnt id=hl-20-31><a class=lnlinks href=#hl-20-31>31</a>
</span><span class=lnt id=hl-20-32><a class=lnlinks href=#hl-20-32>32</a>
</span><span class=lnt id=hl-20-33><a class=lnlinks href=#hl-20-33>33</a>
</span><span class=lnt id=hl-20-34><a class=lnlinks href=#hl-20-34>34</a>
</span><span class=lnt id=hl-20-35><a class=lnlinks href=#hl-20-35>35</a>
</span><span class=lnt id=hl-20-36><a class=lnlinks href=#hl-20-36>36</a>
</span><span class=lnt id=hl-20-37><a class=lnlinks href=#hl-20-37>37</a>
</span><span class=lnt id=hl-20-38><a class=lnlinks href=#hl-20-38>38</a>
</span><span class=lnt id=hl-20-39><a class=lnlinks href=#hl-20-39>39</a>
</span><span class=lnt id=hl-20-40><a class=lnlinks href=#hl-20-40>40</a>
</span><span class=lnt id=hl-20-41><a class=lnlinks href=#hl-20-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># saga_coordinator.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SagaCoordinator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;사가 패턴 중심 주문 트랜잭션 처리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_order_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 결제 서비스 명령 전송</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>publish_command</span><span class=p>(</span><span class=s1>&#39;payment&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;amount&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>amount</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_payment_approved</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 재고 서비스 명령 전송</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>publish_command</span><span class=p>(</span><span class=s1>&#39;inventory&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;items&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>items</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_inventory_reserved</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 배송 서비스 명령 전송</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>publish_command</span><span class=p>(</span><span class=s1>&#39;delivery&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=s1>&#39;address&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>address</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_delivery_scheduled</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 주문 완료 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>publish_event</span><span class=p>(</span><span class=s1>&#39;order_completed&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_failure</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stage</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 실패 단계에 따라 보상(Compensation) 트랜잭션 실행</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stage</span> <span class=o>==</span> <span class=s1>&#39;payment&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 결제 취소 로직</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>publish_command</span><span class=p>(</span><span class=s1>&#39;payment_compensate&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>stage</span> <span class=o>==</span> <span class=s1>&#39;inventory&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 재고 복원 로직</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>publish_command</span><span class=p>(</span><span class=s1>&#39;inventory_compensate&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>stage</span> <span class=o>==</span> <span class=s1>&#39;delivery&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 배송 예약 취소 로직</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>publish_command</span><span class=p>(</span><span class=s1>&#39;delivery_compensate&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>publish_command</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service</span><span class=p>,</span> <span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 각 서비스에 명령 메시지 전달</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>  <span class=c1># 실제 구현은 Kafka/RabbitMQ 등 사용</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>publish_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 마무리 이벤트 송신 (Kafka 등)</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>결제 서비스 (Payment Command/Query)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># payment_command.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ApprovePaymentCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제 승인 명령 - CQRS 명령 모델&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>amount</span> <span class=o>=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># payment_handler.py</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_approve_payment</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=n>ApprovePaymentCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제 승인 처리 - 결제 DB 업데이트 + 이벤트 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>save_payment_to_db</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>command</span><span class=o>.</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payment_event</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;APPROVED&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>publish_event</span><span class=p>(</span><span class=s2>&#34;payment_approved&#34;</span><span class=p>,</span> <span class=n>payment_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># payment_query.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetPaymentStatusQuery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제 상태 조회 쿼리 - CQRS 조회 모델&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_get_payment_status</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=n>GetPaymentStatusQuery</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제 상태 조회 실행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fetch_payment_status_from_read_db</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>order_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>재고 서비스 (Inventory Command/Query)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1> 1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2> 2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3> 3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4> 4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5> 5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6> 6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7> 7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8> 8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9> 9</a>
</span><span class=lnt id=hl-22-10><a class=lnlinks href=#hl-22-10>10</a>
</span><span class=lnt id=hl-22-11><a class=lnlinks href=#hl-22-11>11</a>
</span><span class=lnt id=hl-22-12><a class=lnlinks href=#hl-22-12>12</a>
</span><span class=lnt id=hl-22-13><a class=lnlinks href=#hl-22-13>13</a>
</span><span class=lnt id=hl-22-14><a class=lnlinks href=#hl-22-14>14</a>
</span><span class=lnt id=hl-22-15><a class=lnlinks href=#hl-22-15>15</a>
</span><span class=lnt id=hl-22-16><a class=lnlinks href=#hl-22-16>16</a>
</span><span class=lnt id=hl-22-17><a class=lnlinks href=#hl-22-17>17</a>
</span><span class=lnt id=hl-22-18><a class=lnlinks href=#hl-22-18>18</a>
</span><span class=lnt id=hl-22-19><a class=lnlinks href=#hl-22-19>19</a>
</span><span class=lnt id=hl-22-20><a class=lnlinks href=#hl-22-20>20</a>
</span><span class=lnt id=hl-22-21><a class=lnlinks href=#hl-22-21>21</a>
</span><span class=lnt id=hl-22-22><a class=lnlinks href=#hl-22-22>22</a>
</span><span class=lnt id=hl-22-23><a class=lnlinks href=#hl-22-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># inventory_command.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ReserveInventoryCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;재고 예약 명령 - CQRS 명령 모델&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>,</span> <span class=n>items</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>items</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_reserve_inventory</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=n>ReserveInventoryCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;재고 예약 처리 - 재고 DB 업데이트 + 이벤트 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>command</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>update_inventory_count</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=s2>&#34;product_id&#34;</span><span class=p>],</span> <span class=o>-</span><span class=n>item</span><span class=p>[</span><span class=s2>&#34;quantity&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>inventory_event</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;RESERVED&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>publish_event</span><span class=p>(</span><span class=s2>&#34;inventory_reserved&#34;</span><span class=p>,</span> <span class=n>inventory_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># inventory_query.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetInventoryStatusQuery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;재고 상태 조회 쿼리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>product_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product_id</span> <span class=o>=</span> <span class=n>product_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_get_inventory_status</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=n>GetInventoryStatusQuery</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;조회 DB에서 재고 상태 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fetch_inventory_status_from_read_db</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>product_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>배송 서비스 (Delivery Command/Query)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20>20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21>21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># delivery_command.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ScheduleDeliveryCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;배송 예약 명령 모델&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>,</span> <span class=n>address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>address</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_schedule_delivery</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=n>ScheduleDeliveryCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;배송 예약 처리 - 배송 DB 기록 + 이벤트 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>save_delivery_schedule_to_db</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>command</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>delivery_event</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;order_id&#34;</span><span class=p>:</span> <span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;SCHEDULED&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>publish_event</span><span class=p>(</span><span class=s2>&#34;delivery_scheduled&#34;</span><span class=p>,</span> <span class=n>delivery_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># delivery_query.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetDeliveryStatusQuery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;배송 상태 조회 쿼리&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_get_delivery_status</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=n>GetDeliveryStatusQuery</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;조회 DB에서 배송 상태 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fetch_delivery_status_from_read_db</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>order_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>이벤트 소비 및 상태 반영 예시 (Query Side)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1>1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2>2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3>3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4>4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5>5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6>6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7>7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># event_handler.py</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_order_completed_event</span><span class=p>(</span><span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 완료 이벤트 수신 후 Read DB 갱신&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>update_order_status_in_read_db</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>],</span> <span class=n>status</span><span class=o>=</span><span class=s1>&#39;COMPLETED&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_payment_approved_event</span><span class=p>(</span><span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;결제 승인 이벤트 수신 후 Read DB 반영&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>update_payment_status_in_read_db</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;order_id&#39;</span><span class=p>],</span> <span class=n>status</span><span class=o>=</span><span class=s1>&#39;APPROVED&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>각 핸들러마다 CQRS 분리, 이벤트 소비 후 Read DB(Materialized View, 비정규화 DB) 빠른 상태 반영</li></ul></li></ol><h4 id=실제-도입-사례>실제 도입 사례<a hidden class=anchor aria-hidden=true href=#실제-도입-사례>#</a></h4><p>CQRS 도입은 <strong>읽기와 쓰기의 요구가 크게 다를 때</strong> 힘을 발휘한다. 주문·거래처럼 규칙과 트랜잭션이 중요한 쓰기 경로는 <strong>도메인 규칙</strong>에 맞춰 설계하고, 상품 검색·대시보드처럼 속도가 중요한 읽기 경로는 <strong>비정규화된 물질화 뷰</strong>로 최적화한다. 이벤트를 흘려 <strong>프로젝션</strong>이 읽기 뷰를 갱신하므로, 조회는 빠르되 약간의 지연이 있을 수 있다. 처음엔 <strong>단순 분리</strong>로 시작하고, 필요해지면 <strong>브로커·ES</strong>를 더해 확장한다.</p><table><thead><tr><th>도메인/목적</th><th>전형 구성 (쓰기↔읽기)</th><th>함께 쓰는 기술/패턴</th><th>핵심 효과</th></tr></thead><tbody><tr><td>이커머스 주문·검색 분리</td><td>주문/결제=RDB 트랜잭션 ↔ 카탈로그/검색=물질화 뷰 (Elasticsearch/캐시)</td><td>Kafka/Outbox, 프로젝션, 물질화 뷰</td><td>피크 트래픽에서도 조회 안정·지연 감소, 팀별 독립 확장.</td></tr><tr><td>금융 원장/조회</td><td>거래=ES 로 이벤트 영속 ↔ 잔액/명세=리드뷰</td><td>파티셔닝·순서보장, 스냅샷, 사가</td><td>감사/복구 용이, 순서 일관성 유지, 규제 대응.</td></tr><tr><td>실시간 분석/대시보드</td><td>인입 스트림 ↔ OLAP/검색용 여러 읽기 뷰</td><td>Kafka, ClickHouse/OpenSearch, 다중 프로젝션</td><td>다양한 질의 패턴에 최적화된 뷰 제공, 확장 용이.</td></tr><tr><td>소셜/콘텐츠 피드</td><td>포스팅/상호작용=쓰기 ↔ 피드/검색=읽기</td><td>캐시/검색 엔진, 물질화 뷰</td><td>짧은 응답시간, 읽기 부하 흡수.</td></tr><tr><td>IoT/텔레메트리</td><td>시계열 쓰기 ↔ 집계/알람용 읽기</td><td>시계열 DB, 스트림 프로세싱, 물질화 뷰</td><td>실시간 모니터링·집계 분리, 비용 효율적 처리.</td></tr><tr><td>서버리스 CQRS/ES</td><td>DynamoDB(Event store) ↔ OpenSearch/Redis(읽기)</td><td>Streams→Lambda 프로젝션, Outbox/CDC</td><td>운영 자동화·탄력 확장, 관리 부담↓.</td></tr><tr><td>단계적 도입 (레퍼런스)</td><td>동일 DB 내 논리적 CQRS→필요 시 분리</td><td>eShopOnContainers(간단 CQRS)</td><td>리스크 낮은 시작·점진 확장.</td></tr></tbody></table><ul><li><strong>읽기/쓰기의 이질성</strong>이 큰 도메인 (주문 vs 검색, 거래 vs 잔액) 에선 CQRS 가 <strong>성능·확장·조직 분리</strong>를 동시에 준다.</li><li><strong>프로젝션 + 물질화 뷰</strong>로 읽기를 빠르게 만들고, **ES(옵션)**를 결합하면 감사/복구가 쉬워진다.</li><li>현실적인 접근은 <strong>단순 CQRS→저장소 분리→브로커/ES</strong> 순으로 <strong>점진 도입</strong>이다.</li></ul><h4 id=실제-도입-사례의-코드-구현>실제 도입 사례의 코드 구현<a hidden class=anchor aria-hidden=true href=#실제-도입-사례의-코드-구현>#</a></h4><h5 id=netflix-스타일의-개인화-추천-시스템>Netflix 스타일의 개인화 추천 시스템<a hidden class=anchor aria-hidden=true href=#netflix-스타일의-개인화-추천-시스템>#</a></h5><p><strong>시나리오</strong>: Netflix 스타일의 개인화 추천 시스템</p><p><strong>시스템 구성</strong>:</p><ul><li>명령 측: 사용자 행동 데이터 수집 (Cassandra)</li><li>조회 측: 추천 결과 제공 (Redis, MongoDB)</li><li>이벤트 스트리밍: Apache Kafka</li><li>머신러닝 파이프라인: Apache Spark</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    User[사용자] --&gt; API[추천 API]
    
    subgraph &#34;명령 측면 (행동 수집)&#34;
        API --&gt; TrackingAPI[행동 추적 API]
        TrackingAPI --&gt; Kafka[Apache Kafka]
        Kafka --&gt; Cassandra[(Cassandra)]
    end
    
    subgraph &#34;ML 파이프라인&#34;  
        Cassandra --&gt; Spark[Apache Spark]
        Spark --&gt; MLModel[ML 모델]
    end
    
    subgraph &#34;조회 측면 (추천 제공)&#34;
        API --&gt; RecommendAPI[추천 조회 API]
        RecommendAPI --&gt; Redis[(Redis)]
        RecommendAPI --&gt; MongoDB[(MongoDB)]
    end
    
    MLModel --&gt; Redis
    MLModel --&gt; MongoDB
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자 행동 데이터 실시간 수집 및 Kafka 로 스트리밍</li><li>Cassandra 에 원시 행동 데이터 저장</li><li>Spark 가 배치로 데이터를 처리하여 ML 모델 훈련</li><li>개인화된 추천 결과를 Redis/MongoDB 에 저장</li><li>사용자 요청 시 사전 계산된 추천 결과 즉시 반환</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>CQRS 를 통해 데이터 수집과 추천 제공을 완전히 분리</li><li>실시간 수집과 배치 처리의 하이브리드 아키텍처</li><li>개인화 추천의 낮은 레이턴시 보장</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 사용자 요청 시 실시간 추천 계산으로 높은 지연시간</li><li><strong>도입 후</strong>: 사전 계산된 추천 결과로 밀리초 단위 응답</li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>  1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2>  2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3>  3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4>  4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5>  5</a>
</span><span class=lnt id=hl-26-6><a class=lnlinks href=#hl-26-6>  6</a>
</span><span class=lnt id=hl-26-7><a class=lnlinks href=#hl-26-7>  7</a>
</span><span class=lnt id=hl-26-8><a class=lnlinks href=#hl-26-8>  8</a>
</span><span class=lnt id=hl-26-9><a class=lnlinks href=#hl-26-9>  9</a>
</span><span class=lnt id=hl-26-10><a class=lnlinks href=#hl-26-10> 10</a>
</span><span class=lnt id=hl-26-11><a class=lnlinks href=#hl-26-11> 11</a>
</span><span class=lnt id=hl-26-12><a class=lnlinks href=#hl-26-12> 12</a>
</span><span class=lnt id=hl-26-13><a class=lnlinks href=#hl-26-13> 13</a>
</span><span class=lnt id=hl-26-14><a class=lnlinks href=#hl-26-14> 14</a>
</span><span class=lnt id=hl-26-15><a class=lnlinks href=#hl-26-15> 15</a>
</span><span class=lnt id=hl-26-16><a class=lnlinks href=#hl-26-16> 16</a>
</span><span class=lnt id=hl-26-17><a class=lnlinks href=#hl-26-17> 17</a>
</span><span class=lnt id=hl-26-18><a class=lnlinks href=#hl-26-18> 18</a>
</span><span class=lnt id=hl-26-19><a class=lnlinks href=#hl-26-19> 19</a>
</span><span class=lnt id=hl-26-20><a class=lnlinks href=#hl-26-20> 20</a>
</span><span class=lnt id=hl-26-21><a class=lnlinks href=#hl-26-21> 21</a>
</span><span class=lnt id=hl-26-22><a class=lnlinks href=#hl-26-22> 22</a>
</span><span class=lnt id=hl-26-23><a class=lnlinks href=#hl-26-23> 23</a>
</span><span class=lnt id=hl-26-24><a class=lnlinks href=#hl-26-24> 24</a>
</span><span class=lnt id=hl-26-25><a class=lnlinks href=#hl-26-25> 25</a>
</span><span class=lnt id=hl-26-26><a class=lnlinks href=#hl-26-26> 26</a>
</span><span class=lnt id=hl-26-27><a class=lnlinks href=#hl-26-27> 27</a>
</span><span class=lnt id=hl-26-28><a class=lnlinks href=#hl-26-28> 28</a>
</span><span class=lnt id=hl-26-29><a class=lnlinks href=#hl-26-29> 29</a>
</span><span class=lnt id=hl-26-30><a class=lnlinks href=#hl-26-30> 30</a>
</span><span class=lnt id=hl-26-31><a class=lnlinks href=#hl-26-31> 31</a>
</span><span class=lnt id=hl-26-32><a class=lnlinks href=#hl-26-32> 32</a>
</span><span class=lnt id=hl-26-33><a class=lnlinks href=#hl-26-33> 33</a>
</span><span class=lnt id=hl-26-34><a class=lnlinks href=#hl-26-34> 34</a>
</span><span class=lnt id=hl-26-35><a class=lnlinks href=#hl-26-35> 35</a>
</span><span class=lnt id=hl-26-36><a class=lnlinks href=#hl-26-36> 36</a>
</span><span class=lnt id=hl-26-37><a class=lnlinks href=#hl-26-37> 37</a>
</span><span class=lnt id=hl-26-38><a class=lnlinks href=#hl-26-38> 38</a>
</span><span class=lnt id=hl-26-39><a class=lnlinks href=#hl-26-39> 39</a>
</span><span class=lnt id=hl-26-40><a class=lnlinks href=#hl-26-40> 40</a>
</span><span class=lnt id=hl-26-41><a class=lnlinks href=#hl-26-41> 41</a>
</span><span class=lnt id=hl-26-42><a class=lnlinks href=#hl-26-42> 42</a>
</span><span class=lnt id=hl-26-43><a class=lnlinks href=#hl-26-43> 43</a>
</span><span class=lnt id=hl-26-44><a class=lnlinks href=#hl-26-44> 44</a>
</span><span class=lnt id=hl-26-45><a class=lnlinks href=#hl-26-45> 45</a>
</span><span class=lnt id=hl-26-46><a class=lnlinks href=#hl-26-46> 46</a>
</span><span class=lnt id=hl-26-47><a class=lnlinks href=#hl-26-47> 47</a>
</span><span class=lnt id=hl-26-48><a class=lnlinks href=#hl-26-48> 48</a>
</span><span class=lnt id=hl-26-49><a class=lnlinks href=#hl-26-49> 49</a>
</span><span class=lnt id=hl-26-50><a class=lnlinks href=#hl-26-50> 50</a>
</span><span class=lnt id=hl-26-51><a class=lnlinks href=#hl-26-51> 51</a>
</span><span class=lnt id=hl-26-52><a class=lnlinks href=#hl-26-52> 52</a>
</span><span class=lnt id=hl-26-53><a class=lnlinks href=#hl-26-53> 53</a>
</span><span class=lnt id=hl-26-54><a class=lnlinks href=#hl-26-54> 54</a>
</span><span class=lnt id=hl-26-55><a class=lnlinks href=#hl-26-55> 55</a>
</span><span class=lnt id=hl-26-56><a class=lnlinks href=#hl-26-56> 56</a>
</span><span class=lnt id=hl-26-57><a class=lnlinks href=#hl-26-57> 57</a>
</span><span class=lnt id=hl-26-58><a class=lnlinks href=#hl-26-58> 58</a>
</span><span class=lnt id=hl-26-59><a class=lnlinks href=#hl-26-59> 59</a>
</span><span class=lnt id=hl-26-60><a class=lnlinks href=#hl-26-60> 60</a>
</span><span class=lnt id=hl-26-61><a class=lnlinks href=#hl-26-61> 61</a>
</span><span class=lnt id=hl-26-62><a class=lnlinks href=#hl-26-62> 62</a>
</span><span class=lnt id=hl-26-63><a class=lnlinks href=#hl-26-63> 63</a>
</span><span class=lnt id=hl-26-64><a class=lnlinks href=#hl-26-64> 64</a>
</span><span class=lnt id=hl-26-65><a class=lnlinks href=#hl-26-65> 65</a>
</span><span class=lnt id=hl-26-66><a class=lnlinks href=#hl-26-66> 66</a>
</span><span class=lnt id=hl-26-67><a class=lnlinks href=#hl-26-67> 67</a>
</span><span class=lnt id=hl-26-68><a class=lnlinks href=#hl-26-68> 68</a>
</span><span class=lnt id=hl-26-69><a class=lnlinks href=#hl-26-69> 69</a>
</span><span class=lnt id=hl-26-70><a class=lnlinks href=#hl-26-70> 70</a>
</span><span class=lnt id=hl-26-71><a class=lnlinks href=#hl-26-71> 71</a>
</span><span class=lnt id=hl-26-72><a class=lnlinks href=#hl-26-72> 72</a>
</span><span class=lnt id=hl-26-73><a class=lnlinks href=#hl-26-73> 73</a>
</span><span class=lnt id=hl-26-74><a class=lnlinks href=#hl-26-74> 74</a>
</span><span class=lnt id=hl-26-75><a class=lnlinks href=#hl-26-75> 75</a>
</span><span class=lnt id=hl-26-76><a class=lnlinks href=#hl-26-76> 76</a>
</span><span class=lnt id=hl-26-77><a class=lnlinks href=#hl-26-77> 77</a>
</span><span class=lnt id=hl-26-78><a class=lnlinks href=#hl-26-78> 78</a>
</span><span class=lnt id=hl-26-79><a class=lnlinks href=#hl-26-79> 79</a>
</span><span class=lnt id=hl-26-80><a class=lnlinks href=#hl-26-80> 80</a>
</span><span class=lnt id=hl-26-81><a class=lnlinks href=#hl-26-81> 81</a>
</span><span class=lnt id=hl-26-82><a class=lnlinks href=#hl-26-82> 82</a>
</span><span class=lnt id=hl-26-83><a class=lnlinks href=#hl-26-83> 83</a>
</span><span class=lnt id=hl-26-84><a class=lnlinks href=#hl-26-84> 84</a>
</span><span class=lnt id=hl-26-85><a class=lnlinks href=#hl-26-85> 85</a>
</span><span class=lnt id=hl-26-86><a class=lnlinks href=#hl-26-86> 86</a>
</span><span class=lnt id=hl-26-87><a class=lnlinks href=#hl-26-87> 87</a>
</span><span class=lnt id=hl-26-88><a class=lnlinks href=#hl-26-88> 88</a>
</span><span class=lnt id=hl-26-89><a class=lnlinks href=#hl-26-89> 89</a>
</span><span class=lnt id=hl-26-90><a class=lnlinks href=#hl-26-90> 90</a>
</span><span class=lnt id=hl-26-91><a class=lnlinks href=#hl-26-91> 91</a>
</span><span class=lnt id=hl-26-92><a class=lnlinks href=#hl-26-92> 92</a>
</span><span class=lnt id=hl-26-93><a class=lnlinks href=#hl-26-93> 93</a>
</span><span class=lnt id=hl-26-94><a class=lnlinks href=#hl-26-94> 94</a>
</span><span class=lnt id=hl-26-95><a class=lnlinks href=#hl-26-95> 95</a>
</span><span class=lnt id=hl-26-96><a class=lnlinks href=#hl-26-96> 96</a>
</span><span class=lnt id=hl-26-97><a class=lnlinks href=#hl-26-97> 97</a>
</span><span class=lnt id=hl-26-98><a class=lnlinks href=#hl-26-98> 98</a>
</span><span class=lnt id=hl-26-99><a class=lnlinks href=#hl-26-99> 99</a>
</span><span class=lnt id=hl-26-100><a class=lnlinks href=#hl-26-100>100</a>
</span><span class=lnt id=hl-26-101><a class=lnlinks href=#hl-26-101>101</a>
</span><span class=lnt id=hl-26-102><a class=lnlinks href=#hl-26-102>102</a>
</span><span class=lnt id=hl-26-103><a class=lnlinks href=#hl-26-103>103</a>
</span><span class=lnt id=hl-26-104><a class=lnlinks href=#hl-26-104>104</a>
</span><span class=lnt id=hl-26-105><a class=lnlinks href=#hl-26-105>105</a>
</span><span class=lnt id=hl-26-106><a class=lnlinks href=#hl-26-106>106</a>
</span><span class=lnt id=hl-26-107><a class=lnlinks href=#hl-26-107>107</a>
</span><span class=lnt id=hl-26-108><a class=lnlinks href=#hl-26-108>108</a>
</span><span class=lnt id=hl-26-109><a class=lnlinks href=#hl-26-109>109</a>
</span><span class=lnt id=hl-26-110><a class=lnlinks href=#hl-26-110>110</a>
</span><span class=lnt id=hl-26-111><a class=lnlinks href=#hl-26-111>111</a>
</span><span class=lnt id=hl-26-112><a class=lnlinks href=#hl-26-112>112</a>
</span><span class=lnt id=hl-26-113><a class=lnlinks href=#hl-26-113>113</a>
</span><span class=lnt id=hl-26-114><a class=lnlinks href=#hl-26-114>114</a>
</span><span class=lnt id=hl-26-115><a class=lnlinks href=#hl-26-115>115</a>
</span><span class=lnt id=hl-26-116><a class=lnlinks href=#hl-26-116>116</a>
</span><span class=lnt id=hl-26-117><a class=lnlinks href=#hl-26-117>117</a>
</span><span class=lnt id=hl-26-118><a class=lnlinks href=#hl-26-118>118</a>
</span><span class=lnt id=hl-26-119><a class=lnlinks href=#hl-26-119>119</a>
</span><span class=lnt id=hl-26-120><a class=lnlinks href=#hl-26-120>120</a>
</span><span class=lnt id=hl-26-121><a class=lnlinks href=#hl-26-121>121</a>
</span><span class=lnt id=hl-26-122><a class=lnlinks href=#hl-26-122>122</a>
</span><span class=lnt id=hl-26-123><a class=lnlinks href=#hl-26-123>123</a>
</span><span class=lnt id=hl-26-124><a class=lnlinks href=#hl-26-124>124</a>
</span><span class=lnt id=hl-26-125><a class=lnlinks href=#hl-26-125>125</a>
</span><span class=lnt id=hl-26-126><a class=lnlinks href=#hl-26-126>126</a>
</span><span class=lnt id=hl-26-127><a class=lnlinks href=#hl-26-127>127</a>
</span><span class=lnt id=hl-26-128><a class=lnlinks href=#hl-26-128>128</a>
</span><span class=lnt id=hl-26-129><a class=lnlinks href=#hl-26-129>129</a>
</span><span class=lnt id=hl-26-130><a class=lnlinks href=#hl-26-130>130</a>
</span><span class=lnt id=hl-26-131><a class=lnlinks href=#hl-26-131>131</a>
</span><span class=lnt id=hl-26-132><a class=lnlinks href=#hl-26-132>132</a>
</span><span class=lnt id=hl-26-133><a class=lnlinks href=#hl-26-133>133</a>
</span><span class=lnt id=hl-26-134><a class=lnlinks href=#hl-26-134>134</a>
</span><span class=lnt id=hl-26-135><a class=lnlinks href=#hl-26-135>135</a>
</span><span class=lnt id=hl-26-136><a class=lnlinks href=#hl-26-136>136</a>
</span><span class=lnt id=hl-26-137><a class=lnlinks href=#hl-26-137>137</a>
</span><span class=lnt id=hl-26-138><a class=lnlinks href=#hl-26-138>138</a>
</span><span class=lnt id=hl-26-139><a class=lnlinks href=#hl-26-139>139</a>
</span><span class=lnt id=hl-26-140><a class=lnlinks href=#hl-26-140>140</a>
</span><span class=lnt id=hl-26-141><a class=lnlinks href=#hl-26-141>141</a>
</span><span class=lnt id=hl-26-142><a class=lnlinks href=#hl-26-142>142</a>
</span><span class=lnt id=hl-26-143><a class=lnlinks href=#hl-26-143>143</a>
</span><span class=lnt id=hl-26-144><a class=lnlinks href=#hl-26-144>144</a>
</span><span class=lnt id=hl-26-145><a class=lnlinks href=#hl-26-145>145</a>
</span><span class=lnt id=hl-26-146><a class=lnlinks href=#hl-26-146>146</a>
</span><span class=lnt id=hl-26-147><a class=lnlinks href=#hl-26-147>147</a>
</span><span class=lnt id=hl-26-148><a class=lnlinks href=#hl-26-148>148</a>
</span><span class=lnt id=hl-26-149><a class=lnlinks href=#hl-26-149>149</a>
</span><span class=lnt id=hl-26-150><a class=lnlinks href=#hl-26-150>150</a>
</span><span class=lnt id=hl-26-151><a class=lnlinks href=#hl-26-151>151</a>
</span><span class=lnt id=hl-26-152><a class=lnlinks href=#hl-26-152>152</a>
</span><span class=lnt id=hl-26-153><a class=lnlinks href=#hl-26-153>153</a>
</span><span class=lnt id=hl-26-154><a class=lnlinks href=#hl-26-154>154</a>
</span><span class=lnt id=hl-26-155><a class=lnlinks href=#hl-26-155>155</a>
</span><span class=lnt id=hl-26-156><a class=lnlinks href=#hl-26-156>156</a>
</span><span class=lnt id=hl-26-157><a class=lnlinks href=#hl-26-157>157</a>
</span><span class=lnt id=hl-26-158><a class=lnlinks href=#hl-26-158>158</a>
</span><span class=lnt id=hl-26-159><a class=lnlinks href=#hl-26-159>159</a>
</span><span class=lnt id=hl-26-160><a class=lnlinks href=#hl-26-160>160</a>
</span><span class=lnt id=hl-26-161><a class=lnlinks href=#hl-26-161>161</a>
</span><span class=lnt id=hl-26-162><a class=lnlinks href=#hl-26-162>162</a>
</span><span class=lnt id=hl-26-163><a class=lnlinks href=#hl-26-163>163</a>
</span><span class=lnt id=hl-26-164><a class=lnlinks href=#hl-26-164>164</a>
</span><span class=lnt id=hl-26-165><a class=lnlinks href=#hl-26-165>165</a>
</span><span class=lnt id=hl-26-166><a class=lnlinks href=#hl-26-166>166</a>
</span><span class=lnt id=hl-26-167><a class=lnlinks href=#hl-26-167>167</a>
</span><span class=lnt id=hl-26-168><a class=lnlinks href=#hl-26-168>168</a>
</span><span class=lnt id=hl-26-169><a class=lnlinks href=#hl-26-169>169</a>
</span><span class=lnt id=hl-26-170><a class=lnlinks href=#hl-26-170>170</a>
</span><span class=lnt id=hl-26-171><a class=lnlinks href=#hl-26-171>171</a>
</span><span class=lnt id=hl-26-172><a class=lnlinks href=#hl-26-172>172</a>
</span><span class=lnt id=hl-26-173><a class=lnlinks href=#hl-26-173>173</a>
</span><span class=lnt id=hl-26-174><a class=lnlinks href=#hl-26-174>174</a>
</span><span class=lnt id=hl-26-175><a class=lnlinks href=#hl-26-175>175</a>
</span><span class=lnt id=hl-26-176><a class=lnlinks href=#hl-26-176>176</a>
</span><span class=lnt id=hl-26-177><a class=lnlinks href=#hl-26-177>177</a>
</span><span class=lnt id=hl-26-178><a class=lnlinks href=#hl-26-178>178</a>
</span><span class=lnt id=hl-26-179><a class=lnlinks href=#hl-26-179>179</a>
</span><span class=lnt id=hl-26-180><a class=lnlinks href=#hl-26-180>180</a>
</span><span class=lnt id=hl-26-181><a class=lnlinks href=#hl-26-181>181</a>
</span><span class=lnt id=hl-26-182><a class=lnlinks href=#hl-26-182>182</a>
</span><span class=lnt id=hl-26-183><a class=lnlinks href=#hl-26-183>183</a>
</span><span class=lnt id=hl-26-184><a class=lnlinks href=#hl-26-184>184</a>
</span><span class=lnt id=hl-26-185><a class=lnlinks href=#hl-26-185>185</a>
</span><span class=lnt id=hl-26-186><a class=lnlinks href=#hl-26-186>186</a>
</span><span class=lnt id=hl-26-187><a class=lnlinks href=#hl-26-187>187</a>
</span><span class=lnt id=hl-26-188><a class=lnlinks href=#hl-26-188>188</a>
</span><span class=lnt id=hl-26-189><a class=lnlinks href=#hl-26-189>189</a>
</span><span class=lnt id=hl-26-190><a class=lnlinks href=#hl-26-190>190</a>
</span><span class=lnt id=hl-26-191><a class=lnlinks href=#hl-26-191>191</a>
</span><span class=lnt id=hl-26-192><a class=lnlinks href=#hl-26-192>192</a>
</span><span class=lnt id=hl-26-193><a class=lnlinks href=#hl-26-193>193</a>
</span><span class=lnt id=hl-26-194><a class=lnlinks href=#hl-26-194>194</a>
</span><span class=lnt id=hl-26-195><a class=lnlinks href=#hl-26-195>195</a>
</span><span class=lnt id=hl-26-196><a class=lnlinks href=#hl-26-196>196</a>
</span><span class=lnt id=hl-26-197><a class=lnlinks href=#hl-26-197>197</a>
</span><span class=lnt id=hl-26-198><a class=lnlinks href=#hl-26-198>198</a>
</span><span class=lnt id=hl-26-199><a class=lnlinks href=#hl-26-199>199</a>
</span><span class=lnt id=hl-26-200><a class=lnlinks href=#hl-26-200>200</a>
</span><span class=lnt id=hl-26-201><a class=lnlinks href=#hl-26-201>201</a>
</span><span class=lnt id=hl-26-202><a class=lnlinks href=#hl-26-202>202</a>
</span><span class=lnt id=hl-26-203><a class=lnlinks href=#hl-26-203>203</a>
</span><span class=lnt id=hl-26-204><a class=lnlinks href=#hl-26-204>204</a>
</span><span class=lnt id=hl-26-205><a class=lnlinks href=#hl-26-205>205</a>
</span><span class=lnt id=hl-26-206><a class=lnlinks href=#hl-26-206>206</a>
</span><span class=lnt id=hl-26-207><a class=lnlinks href=#hl-26-207>207</a>
</span><span class=lnt id=hl-26-208><a class=lnlinks href=#hl-26-208>208</a>
</span><span class=lnt id=hl-26-209><a class=lnlinks href=#hl-26-209>209</a>
</span><span class=lnt id=hl-26-210><a class=lnlinks href=#hl-26-210>210</a>
</span><span class=lnt id=hl-26-211><a class=lnlinks href=#hl-26-211>211</a>
</span><span class=lnt id=hl-26-212><a class=lnlinks href=#hl-26-212>212</a>
</span><span class=lnt id=hl-26-213><a class=lnlinks href=#hl-26-213>213</a>
</span><span class=lnt id=hl-26-214><a class=lnlinks href=#hl-26-214>214</a>
</span><span class=lnt id=hl-26-215><a class=lnlinks href=#hl-26-215>215</a>
</span><span class=lnt id=hl-26-216><a class=lnlinks href=#hl-26-216>216</a>
</span><span class=lnt id=hl-26-217><a class=lnlinks href=#hl-26-217>217</a>
</span><span class=lnt id=hl-26-218><a class=lnlinks href=#hl-26-218>218</a>
</span><span class=lnt id=hl-26-219><a class=lnlinks href=#hl-26-219>219</a>
</span><span class=lnt id=hl-26-220><a class=lnlinks href=#hl-26-220>220</a>
</span><span class=lnt id=hl-26-221><a class=lnlinks href=#hl-26-221>221</a>
</span><span class=lnt id=hl-26-222><a class=lnlinks href=#hl-26-222>222</a>
</span><span class=lnt id=hl-26-223><a class=lnlinks href=#hl-26-223>223</a>
</span><span class=lnt id=hl-26-224><a class=lnlinks href=#hl-26-224>224</a>
</span><span class=lnt id=hl-26-225><a class=lnlinks href=#hl-26-225>225</a>
</span><span class=lnt id=hl-26-226><a class=lnlinks href=#hl-26-226>226</a>
</span><span class=lnt id=hl-26-227><a class=lnlinks href=#hl-26-227>227</a>
</span><span class=lnt id=hl-26-228><a class=lnlinks href=#hl-26-228>228</a>
</span><span class=lnt id=hl-26-229><a class=lnlinks href=#hl-26-229>229</a>
</span><span class=lnt id=hl-26-230><a class=lnlinks href=#hl-26-230>230</a>
</span><span class=lnt id=hl-26-231><a class=lnlinks href=#hl-26-231>231</a>
</span><span class=lnt id=hl-26-232><a class=lnlinks href=#hl-26-232>232</a>
</span><span class=lnt id=hl-26-233><a class=lnlinks href=#hl-26-233>233</a>
</span><span class=lnt id=hl-26-234><a class=lnlinks href=#hl-26-234>234</a>
</span><span class=lnt id=hl-26-235><a class=lnlinks href=#hl-26-235>235</a>
</span><span class=lnt id=hl-26-236><a class=lnlinks href=#hl-26-236>236</a>
</span><span class=lnt id=hl-26-237><a class=lnlinks href=#hl-26-237>237</a>
</span><span class=lnt id=hl-26-238><a class=lnlinks href=#hl-26-238>238</a>
</span><span class=lnt id=hl-26-239><a class=lnlinks href=#hl-26-239>239</a>
</span><span class=lnt id=hl-26-240><a class=lnlinks href=#hl-26-240>240</a>
</span><span class=lnt id=hl-26-241><a class=lnlinks href=#hl-26-241>241</a>
</span><span class=lnt id=hl-26-242><a class=lnlinks href=#hl-26-242>242</a>
</span><span class=lnt id=hl-26-243><a class=lnlinks href=#hl-26-243>243</a>
</span><span class=lnt id=hl-26-244><a class=lnlinks href=#hl-26-244>244</a>
</span><span class=lnt id=hl-26-245><a class=lnlinks href=#hl-26-245>245</a>
</span><span class=lnt id=hl-26-246><a class=lnlinks href=#hl-26-246>246</a>
</span><span class=lnt id=hl-26-247><a class=lnlinks href=#hl-26-247>247</a>
</span><span class=lnt id=hl-26-248><a class=lnlinks href=#hl-26-248>248</a>
</span><span class=lnt id=hl-26-249><a class=lnlinks href=#hl-26-249>249</a>
</span><span class=lnt id=hl-26-250><a class=lnlinks href=#hl-26-250>250</a>
</span><span class=lnt id=hl-26-251><a class=lnlinks href=#hl-26-251>251</a>
</span><span class=lnt id=hl-26-252><a class=lnlinks href=#hl-26-252>252</a>
</span><span class=lnt id=hl-26-253><a class=lnlinks href=#hl-26-253>253</a>
</span><span class=lnt id=hl-26-254><a class=lnlinks href=#hl-26-254>254</a>
</span><span class=lnt id=hl-26-255><a class=lnlinks href=#hl-26-255>255</a>
</span><span class=lnt id=hl-26-256><a class=lnlinks href=#hl-26-256>256</a>
</span><span class=lnt id=hl-26-257><a class=lnlinks href=#hl-26-257>257</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 사용자 행동 추적 명령 핸들러</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserBehaviorTrackingHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>kafka_producer</span><span class=p>,</span> <span class=n>cassandra_session</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_producer</span> <span class=o>=</span> <span class=n>kafka_producer</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cassandra</span> <span class=o>=</span> <span class=n>cassandra_session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>track_user_interaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=s1>&#39;UserInteractionEvent&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;사용자 상호작용 추적 - Netflix의 시청/평가/검색 행동&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 실시간 스트리밍을 위한 Kafka 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=n>event_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;content_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>content_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;interaction_type&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>interaction_type</span><span class=p>,</span>  <span class=c1># view, rate, search, click</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;interaction_value&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>value</span><span class=p>,</span>  <span class=c1># 시청 시간, 평점 등</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;context&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;device_type&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>device_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;session_id&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>session_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;location&#39;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>location</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Kafka로 실시간 이벤트 스트리밍</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>kafka_producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>topic</span><span class=o>=</span><span class=s1>&#39;user-interactions&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Cassandra에 원시 데이터 저장 (대용량 시계열 데이터 처리)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cassandra</span><span class=o>.</span><span class=n>execute_async</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            INSERT INTO user_interactions 
</span></span></span><span class=line><span class=cl><span class=s2>            (user_id, content_id, interaction_type, interaction_value, timestamp, context)
</span></span></span><span class=line><span class=cl><span class=s2>            VALUES (?, ?, ?, ?, ?, ?)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>user_id</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>content_id</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>interaction_type</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=n>interaction_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event_data</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 추천 시스템 조회 핸들러</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RecommendationQueryHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>,</span> <span class=n>mongodb_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>      <span class=c1># 빠른 개인화 추천 캐시</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mongodb</span> <span class=o>=</span> <span class=n>mongodb_client</span>  <span class=c1># 복잡한 추천 메타데이터</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_personalized_recommendations</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>category</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;개인화된 추천 목록 조회 - 사전 계산된 결과 반환&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Redis에서 개인화된 추천 목록 조회 (밀리초 응답)</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;recommendations:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>category</span> <span class=ow>or</span> <span class=s1>&#39;all&#39;</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cached_recommendations</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cached_recommendations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cached_recommendations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># MongoDB에서 상세 메타데이터 조회</span>
</span></span><span class=line><span class=cl>            <span class=n>content_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>rec</span><span class=p>[</span><span class=s1>&#39;content_id&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>recommendations</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>content_details</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>mongodb</span><span class=o>.</span><span class=n>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;contents&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;_id&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;$in&#34;</span><span class=p>:</span> <span class=n>content_ids</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;thumbnail&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;rating&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 추천 점수와 콘텐츠 상세 정보 결합</span>
</span></span><span class=line><span class=cl>            <span class=n>detailed_recommendations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>recommendations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>content_detail</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>content_details</span> <span class=k>if</span> <span class=n>c</span><span class=p>[</span><span class=s1>&#39;_id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>rec</span><span class=p>[</span><span class=s1>&#39;content_id&#39;</span><span class=p>]),</span> 
</span></span><span class=line><span class=cl>                    <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>content_detail</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>detailed_recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                        <span class=o>**</span><span class=n>rec</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=o>**</span><span class=n>content_detail</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;recommendation_reason&#39;</span><span class=p>:</span> <span class=n>rec</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;reason&#39;</span><span class=p>,</span> <span class=s1>&#39;당신을 위한 추천&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>detailed_recommendations</span><span class=p>[:</span><span class=mi>20</span><span class=p>]</span>  <span class=c1># 상위 20개 반환</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 캐시 미스인 경우 기본 추천 반환 (실제로는 fallback 로직)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_default_recommendations</span><span class=p>(</span><span class=n>category</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_trending_content</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>time_window</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;24h&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;실시간 트렌딩 콘텐츠 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>trending_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;trending:</span><span class=si>{</span><span class=n>time_window</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>trending_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>zrevrange</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>trending_key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>19</span><span class=p>,</span> <span class=n>withscores</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;content_id&#39;</span><span class=p>:</span> <span class=n>content_id</span><span class=o>.</span><span class=n>decode</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;trending_score&#39;</span><span class=p>:</span> <span class=n>score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;rank&#39;</span><span class=p>:</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=p>(</span><span class=n>content_id</span><span class=p>,</span> <span class=n>score</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>trending_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ML 기반 추천 파이프라인 (배치 처리)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.sql</span> <span class=kn>import</span> <span class=n>SparkSession</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.ml.recommendation</span> <span class=kn>import</span> <span class=n>ALS</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pyspark.ml.feature</span> <span class=kn>import</span> <span class=n>StringIndexer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RecommendationPipelineHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>spark_session</span><span class=p>,</span> <span class=n>cassandra_config</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>spark</span> <span class=o>=</span> <span class=n>spark_session</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cassandra_config</span> <span class=o>=</span> <span class=n>cassandra_config</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process_recommendations</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;주기적 추천 모델 훈련 및 결과 생성&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Cassandra에서 사용자 행동 데이터 로드</span>
</span></span><span class=line><span class=cl>        <span class=n>user_interactions</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>spark</span><span class=o>.</span><span class=n>read</span> \
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;org.apache.spark.sql.cassandra&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>options</span><span class=p>(</span><span class=n>table</span><span class=o>=</span><span class=s2>&#34;user_interactions&#34;</span><span class=p>,</span> <span class=n>keyspace</span><span class=o>=</span><span class=s2>&#34;recommendations&#34;</span><span class=p>)</span> \
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>load</span><span class=p>()</span> \
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=s2>&#34;timestamp &gt; date_sub(current_date(), 30)&#34;</span><span class=p>)</span>  <span class=c1># 최근 30일 데이터</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 협업 필터링을 위한 데이터 전처리</span>
</span></span><span class=line><span class=cl>        <span class=n>indexer_user</span> <span class=o>=</span> <span class=n>StringIndexer</span><span class=p>(</span><span class=n>inputCol</span><span class=o>=</span><span class=s2>&#34;user_id&#34;</span><span class=p>,</span> <span class=n>outputCol</span><span class=o>=</span><span class=s2>&#34;user_idx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>indexer_content</span> <span class=o>=</span> <span class=n>StringIndexer</span><span class=p>(</span><span class=n>inputCol</span><span class=o>=</span><span class=s2>&#34;content_id&#34;</span><span class=p>,</span> <span class=n>outputCol</span><span class=o>=</span><span class=s2>&#34;content_idx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>df_indexed</span> <span class=o>=</span> <span class=n>indexer_user</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>user_interactions</span><span class=p>)</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=n>user_interactions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>df_indexed</span> <span class=o>=</span> <span class=n>indexer_content</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>df_indexed</span><span class=p>)</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=n>df_indexed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 암시적 평점 계산 (시청 시간, 완료율 등으로부터)</span>
</span></span><span class=line><span class=cl>        <span class=n>df_ratings</span> <span class=o>=</span> <span class=n>df_indexed</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span><span class=s2>&#34;rating&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_implicit_rating</span><span class=p>(</span><span class=n>df_indexed</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># ALS 모델 훈련</span>
</span></span><span class=line><span class=cl>        <span class=n>als</span> <span class=o>=</span> <span class=n>ALS</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>maxIter</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>regParam</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>userCol</span><span class=o>=</span><span class=s2>&#34;user_idx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>itemCol</span><span class=o>=</span><span class=s2>&#34;content_idx&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>ratingCol</span><span class=o>=</span><span class=s2>&#34;rating&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>coldStartStrategy</span><span class=o>=</span><span class=s2>&#34;drop&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>als</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>df_ratings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 모든 사용자에 대한 추천 생성</span>
</span></span><span class=line><span class=cl>        <span class=n>user_recommendations</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>recommendForAllUsers</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 추천 결과를 Redis에 저장</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>user_recommendations</span><span class=o>.</span><span class=n>collect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_original_user_id</span><span class=p>(</span><span class=n>row</span><span class=o>.</span><span class=n>user_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;content_id&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_original_content_id</span><span class=p>(</span><span class=n>rec</span><span class=o>.</span><span class=n>content_idx</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>rec</span><span class=o>.</span><span class=n>rating</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_recommendation_reason</span><span class=p>(</span><span class=n>rec</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>row</span><span class=o>.</span><span class=n>recommendations</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Redis에 개인화 추천 저장 (24시간 TTL)</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;recommendations:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>:all&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>86400</span><span class=p>,</span>  <span class=c1># 24시간</span>
</span></span><span class=line><span class=cl>                <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>recommendations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_calculate_implicit_rating</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;암시적 평점 계산 로직&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 시청 시간, 완료율, 재시청 여부 등을 종합한 점수</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>pyspark.sql.functions</span> <span class=kn>import</span> <span class=n>when</span><span class=p>,</span> <span class=n>col</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>when</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>col</span><span class=p>(</span><span class=s2>&#34;interaction_type&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;view&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>col</span><span class=p>(</span><span class=s2>&#34;interaction_value&#34;</span><span class=p>)</span> <span class=o>/</span> <span class=mf>3600.0</span>  <span class=c1># 시청 시간(초) -&gt; 시간 단위 점수</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>when</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>col</span><span class=p>(</span><span class=s2>&#34;interaction_type&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;rate&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=n>col</span><span class=p>(</span><span class=s2>&#34;interaction_value&#34;</span><span class=p>)</span>  <span class=c1># 직접 평점</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>when</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>col</span><span class=p>(</span><span class=s2>&#34;interaction_type&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;complete&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=mf>5.0</span>  <span class=c1># 완료 시청 = 높은 점수</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>otherwise</span><span class=p>(</span><span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. API 엔드포인트 (FastAPI)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Query</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>title</span><span class=o>=</span><span class=s2>&#34;Netflix-Style Recommendation API&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/track&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>track_interaction</span><span class=p>(</span><span class=n>interaction</span><span class=p>:</span> <span class=n>UserInteractionEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;사용자 상호작용 추적 - 명령 API&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>behavior_handler</span><span class=o>.</span><span class=n>track_user_interaction</span><span class=p>(</span><span class=n>interaction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;tracked&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/users/</span><span class=si>{user_id}</span><span class=s2>/recommendations&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_recommendations</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>category</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;콘텐츠 카테고리&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;개인화된 추천 조회 - 쿼리 API&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>recommendations</span> <span class=o>=</span> <span class=k>await</span> <span class=n>recommendation_handler</span><span class=o>.</span><span class=n>get_personalized_recommendations</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span><span class=p>,</span> <span class=n>category</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;recommendations&#34;</span><span class=p>:</span> <span class=n>recommendations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;generated_at&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/trending&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_trending</span><span class=p>(</span><span class=n>time_window</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=s2>&#34;24h&#34;</span><span class=p>,</span> <span class=n>regex</span><span class=o>=</span><span class=s2>&#34;^(1h|24h|7d)$&#34;</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;트렌딩 콘텐츠 조회&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>trending</span> <span class=o>=</span> <span class=k>await</span> <span class=n>recommendation_handler</span><span class=o>.</span><span class=n>get_trending_content</span><span class=p>(</span><span class=n>time_window</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;time_window&#34;</span><span class=p>:</span> <span class=n>time_window</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;trending&#34;</span><span class=p>:</span> <span class=n>trending</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 이벤트 프로세서 (실시간 트렌딩 계산)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TrendingEventProcessor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>kafka_consumer</span><span class=p>,</span> <span class=n>redis_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_consumer</span> <span class=o>=</span> <span class=n>kafka_consumer</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process_trending_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;실시간 트렌딩 점수 계산&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>kafka_consumer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>event_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>event_data</span><span class=p>[</span><span class=s1>&#39;interaction_type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;view&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 실시간 트렌딩 점수 업데이트</span>
</span></span><span class=line><span class=cl>                <span class=n>content_id</span> <span class=o>=</span> <span class=n>event_data</span><span class=p>[</span><span class=s1>&#39;content_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>fromisoformat</span><span class=p>(</span><span class=n>event_data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 시간 기반 가중치 적용 (최근일수록 높은 가중치)</span>
</span></span><span class=line><span class=cl>                <span class=n>weight</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_time_weight</span><span class=p>(</span><span class=n>timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># Redis Sorted Set에 트렌딩 점수 누적</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>zincrby</span><span class=p>(</span><span class=s2>&#34;trending:24h&#34;</span><span class=p>,</span> <span class=n>weight</span><span class=p>,</span> <span class=n>content_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>zincrby</span><span class=p>(</span><span class=s2>&#34;trending:7d&#34;</span><span class=p>,</span> <span class=n>weight</span> <span class=o>*</span> <span class=mf>0.7</span><span class=p>,</span> <span class=n>content_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># TTL 설정으로 오래된 데이터 자동 정리</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>expire</span><span class=p>(</span><span class=s2>&#34;trending:24h&#34;</span><span class=p>,</span> <span class=mi>86400</span><span class=p>)</span>  <span class=c1># 24시간</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>expire</span><span class=p>(</span><span class=s2>&#34;trending:7d&#34;</span><span class=p>,</span> <span class=mi>604800</span><span class=p>)</span>  <span class=c1># 7일</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_calculate_time_weight</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;시간 기반 가중치 계산 (최근일수록 높은 가중치)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>time_diff</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=n>hours_ago</span> <span class=o>=</span> <span class=n>time_diff</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span> <span class=o>/</span> <span class=mi>3600</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>24.0</span> <span class=o>-</span> <span class=n>hours_ago</span><span class=p>)</span> <span class=o>/</span> <span class=mf>24.0</span>  <span class=c1># 0-24시간 전 데이터에 가중치</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=serverless-cqrs--event-sourcing>Serverless CQRS + Event Sourcing<a hidden class=anchor aria-hidden=true href=#serverless-cqrs--event-sourcing>#</a></h5><p><strong>시나리오</strong>: DynamoDB(Event Store) 에 이벤트를 Append 하고, DynamoDB Streams → AWS Lambda 로 OpenSearch(또는 Redis) Projection 을 생성.</p><p><strong>효과</strong>: 서버 관리 최소화, 초당 이벤트 폭증에도 원활한 <strong>수평 확장</strong>, <strong>비용 효율성</strong>.</p><p><strong>시스템 구성</strong>:</p><ul><li><strong>Write(API Gateway + Lambda)</strong>: <code>PUT /orders/{id}</code> → DynamoDB <code>events</code> 테이블에 Append(타입/버전/페이로드)</li><li><strong>Stream Processor(Lambda)</strong>: Streams 레코드 → OpenSearch/Redis 업데이트</li><li><strong>Read(API Gateway + Lambda)</strong>: Projection 에서 조회</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
  C[Client] --&gt; APIGW[API Gateway]
  APIGW --&gt; W[&#34;Lambda(Command)&#34;]
  W --&gt; DDB[(DynamoDB Event Store)]
  DDB --&gt; DS[DynamoDB Streams]
  DS --&gt; P[&#34;Lambda(Projection)&#34;]
  P --&gt; OS[OpenSearch / Redis]
  C --&gt; QAPIGW[&#34;API Gateway(Query)&#34;]
  QAPIGW --&gt; QR[&#34;Lambda(Query)&#34;]
  QR --&gt; OS
</pre><p><strong>Workflow</strong>:</p><ol><li>Command Lambda 가 <code>OrderCreated</code> 이벤트를 이벤트 스토어 (DDB) 에 Append</li><li>Streams 가 이벤트를 트리거 → Projection Lambda 가 OpenSearch/Redis 업데이트</li><li>Query Lambda 가 Projection 에서 조회 반환</li></ol><p><strong>유무에 따른 차이점</strong>:</p><ul><li>전: 단일 RDB 조인 기반 조회로 지연/경쟁</li><li>후: Write/Read 경로 분리, 대량 조회 시 선형 확장</li></ul><p><strong>구현 예시</strong> (Python Lambda 핵심)</p><ul><li><p>Command Lambda</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Command Lambda: 이벤트 소싱 Append (CQRS 쓰기 측)</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>uuid</span><span class=o>,</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl><span class=n>ddb</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>resource</span><span class=p>(</span><span class=s1>&#39;dynamodb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>Table</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;EVENTS_TABLE&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order_id</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;pathParameters&#34;</span><span class=p>][</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s2>&#34;body&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>evt</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;aggregate_id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;version&#34;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span><span class=o>*</span><span class=mi>1000</span><span class=p>),</span>  <span class=c1># 간단 버전(프로덕션은 정합 설계 필요)</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;payload&#34;</span><span class=p>:</span> <span class=n>body</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;occurred_at&#34;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ddb</span><span class=o>.</span><span class=n>put_item</span><span class=p>(</span><span class=n>Item</span><span class=o>=</span><span class=n>evt</span><span class=p>)</span>  <span class=c1># append-only</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;statusCode&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;body&#34;</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s2>&#34;ok&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>order_id</span><span class=p>})}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>Projection Lambda</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Projection Lambda: Streams → OpenSearch/Redis 업데이트 (CQRS 읽기 측)</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>json</span><span class=o>,</span> <span class=nn>boto3</span><span class=o>,</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;REDIS_HOST&#39;</span><span class=p>],</span> <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;Records&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rec</span><span class=p>[</span><span class=s2>&#34;eventName&#34;</span><span class=p>]</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;INSERT&#34;</span><span class=p>,</span><span class=s2>&#34;MODIFY&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>new</span> <span class=o>=</span> <span class=n>rec</span><span class=p>[</span><span class=s2>&#34;dynamodb&#34;</span><span class=p>][</span><span class=s2>&#34;NewImage&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>agg</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=s2>&#34;aggregate_id&#34;</span><span class=p>][</span><span class=s2>&#34;S&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>et</span>  <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>][</span><span class=s2>&#34;S&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>new</span><span class=p>[</span><span class=s2>&#34;payload&#34;</span><span class=p>][</span><span class=s2>&#34;S&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>et</span> <span class=o>==</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>agg</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;CREATED&#34;</span><span class=p>,</span><span class=s2>&#34;total&#34;</span><span class=p>:</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;total_amount&#34;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>et</span> <span class=o>==</span> <span class=s2>&#34;OrderPaid&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>agg</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;PAID&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>et</span> <span class=o>==</span> <span class=s2>&#34;OrderShipped&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>hset</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;order:</span><span class=si>{</span><span class=n>agg</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>mapping</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;SHIPPED&#34;</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>AWS 공식/레퍼런스 아키텍처에서 <strong>DynamoDB Streams + Lambda</strong>로 CQRS/Event Sourcing 구현을 권장.</p></li></ul><h5 id=대형-전자상거래-플랫폼에서--주문-order-과--재고-inventory-관리>대형 전자상거래 플랫폼에서 " 주문 (Order)&rdquo; 과 " 재고 (Inventory)&rdquo; 관리<a hidden class=anchor aria-hidden=true href=#대형-전자상거래-플랫폼에서--주문-order-과--재고-inventory-관리>#</a></h5><p><strong>시나리오</strong>: 대형 전자상거래 플랫폼에서 " 주문 (Order)&rdquo; 과 " 재고 (Inventory)" 를 CQRS + Event Sourcing 방식으로 관리.</p><ul><li>사용자가 주문을 생성하면 <strong>Command Service</strong>가 처리하고, 이벤트를 발행한다.</li><li><strong>Query Service</strong>는 이벤트를 기반으로 읽기용 DB(Materialized View) 를 업데이트하여, 실시간 재고 조회 성능을 높인다.</li></ul><p><strong>시스템 구성</strong>:</p><ul><li><strong>Order Command Service</strong>: 주문 생성/취소 처리</li><li><strong>Order Query Service</strong>: 주문 내역 조회</li><li><strong>Inventory Command Service</strong>: 재고 조정 처리</li><li><strong>Inventory Query Service</strong>: 재고 현황 조회</li><li><strong>Event Store (Kafka, RabbitMQ)</strong>: 이벤트 저장 및 전송</li><li><strong>Read DB (Elasticsearch, Redis)</strong>: 빠른 조회 모델</li></ul><p><strong>시스템 구성 다이어그램</strong>:</p><pre class=mermaid>graph TB
    User[사용자] --&gt; API[API Gateway]
    API --&gt; OrderCmdSvc[Order Command Service]
    API --&gt; OrderQrySvc[Order Query Service]
    OrderCmdSvc --&gt; WriteDB[(Order WriteDB)]
    OrderCmdSvc --&gt; EventBus[&#34;Event Bus (Kafka)&#34;]
    EventBus --&gt; OrderQrySvc
    OrderQrySvc --&gt; ReadDB[(Order ReadDB)]
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 주문 생성 요청 (Command)</li><li>Order Command Handler 가 Write Model 에 저장</li><li>주문 생성 이벤트 (OrderCreated) 를 Event Store 에 발행</li><li>Order Query Handler 가 이벤트를 소비하여 Read Model 갱신</li><li>사용자가 주문 내역 또는 재고를 실시간 조회 (Query)</li></ol><p><strong>핵심 역할</strong>:</p><ul><li>CQRS: 읽기/쓰기 모델 분리로 대규모 요청 처리 최적화</li><li>Event Sourcing: 주문 변경 이력 추적 및 재연 가능</li><li>Materialized View: 실시간 조회 성능 향상</li></ul><p><strong>유무에 따른 차이점</strong>:</p><ul><li><strong>도입 전</strong>: 단일 DB 에서 CRUD 처리, 높은 조회 부하 발생 시 쓰기 지연</li><li><strong>도입 후</strong>: 읽기 트래픽은 Read Model 이 처리, 쓰기 성능 안정화, 이벤트 기반 확장 용이</li></ul><p><strong>구현 예시 (Python + Kafka + Redis 등)</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1> 1</a>
</span><span class=lnt id=hl-31-2><a class=lnlinks href=#hl-31-2> 2</a>
</span><span class=lnt id=hl-31-3><a class=lnlinks href=#hl-31-3> 3</a>
</span><span class=lnt id=hl-31-4><a class=lnlinks href=#hl-31-4> 4</a>
</span><span class=lnt id=hl-31-5><a class=lnlinks href=#hl-31-5> 5</a>
</span><span class=lnt id=hl-31-6><a class=lnlinks href=#hl-31-6> 6</a>
</span><span class=lnt id=hl-31-7><a class=lnlinks href=#hl-31-7> 7</a>
</span><span class=lnt id=hl-31-8><a class=lnlinks href=#hl-31-8> 8</a>
</span><span class=lnt id=hl-31-9><a class=lnlinks href=#hl-31-9> 9</a>
</span><span class=lnt id=hl-31-10><a class=lnlinks href=#hl-31-10>10</a>
</span><span class=lnt id=hl-31-11><a class=lnlinks href=#hl-31-11>11</a>
</span><span class=lnt id=hl-31-12><a class=lnlinks href=#hl-31-12>12</a>
</span><span class=lnt id=hl-31-13><a class=lnlinks href=#hl-31-13>13</a>
</span><span class=lnt id=hl-31-14><a class=lnlinks href=#hl-31-14>14</a>
</span><span class=lnt id=hl-31-15><a class=lnlinks href=#hl-31-15>15</a>
</span><span class=lnt id=hl-31-16><a class=lnlinks href=#hl-31-16>16</a>
</span><span class=lnt id=hl-31-17><a class=lnlinks href=#hl-31-17>17</a>
</span><span class=lnt id=hl-31-18><a class=lnlinks href=#hl-31-18>18</a>
</span><span class=lnt id=hl-31-19><a class=lnlinks href=#hl-31-19>19</a>
</span><span class=lnt id=hl-31-20><a class=lnlinks href=#hl-31-20>20</a>
</span><span class=lnt id=hl-31-21><a class=lnlinks href=#hl-31-21>21</a>
</span><span class=lnt id=hl-31-22><a class=lnlinks href=#hl-31-22>22</a>
</span><span class=lnt id=hl-31-23><a class=lnlinks href=#hl-31-23>23</a>
</span><span class=lnt id=hl-31-24><a class=lnlinks href=#hl-31-24>24</a>
</span><span class=lnt id=hl-31-25><a class=lnlinks href=#hl-31-25>25</a>
</span><span class=lnt id=hl-31-26><a class=lnlinks href=#hl-31-26>26</a>
</span><span class=lnt id=hl-31-27><a class=lnlinks href=#hl-31-27>27</a>
</span><span class=lnt id=hl-31-28><a class=lnlinks href=#hl-31-28>28</a>
</span><span class=lnt id=hl-31-29><a class=lnlinks href=#hl-31-29>29</a>
</span><span class=lnt id=hl-31-30><a class=lnlinks href=#hl-31-30>30</a>
</span><span class=lnt id=hl-31-31><a class=lnlinks href=#hl-31-31>31</a>
</span><span class=lnt id=hl-31-32><a class=lnlinks href=#hl-31-32>32</a>
</span><span class=lnt id=hl-31-33><a class=lnlinks href=#hl-31-33>33</a>
</span><span class=lnt id=hl-31-34><a class=lnlinks href=#hl-31-34>34</a>
</span><span class=lnt id=hl-31-35><a class=lnlinks href=#hl-31-35>35</a>
</span><span class=lnt id=hl-31-36><a class=lnlinks href=#hl-31-36>36</a>
</span><span class=lnt id=hl-31-37><a class=lnlinks href=#hl-31-37>37</a>
</span><span class=lnt id=hl-31-38><a class=lnlinks href=#hl-31-38>38</a>
</span><span class=lnt id=hl-31-39><a class=lnlinks href=#hl-31-39>39</a>
</span><span class=lnt id=hl-31-40><a class=lnlinks href=#hl-31-40>40</a>
</span><span class=lnt id=hl-31-41><a class=lnlinks href=#hl-31-41>41</a>
</span><span class=lnt id=hl-31-42><a class=lnlinks href=#hl-31-42>42</a>
</span><span class=lnt id=hl-31-43><a class=lnlinks href=#hl-31-43>43</a>
</span><span class=lnt id=hl-31-44><a class=lnlinks href=#hl-31-44>44</a>
</span><span class=lnt id=hl-31-45><a class=lnlinks href=#hl-31-45>45</a>
</span><span class=lnt id=hl-31-46><a class=lnlinks href=#hl-31-46>46</a>
</span><span class=lnt id=hl-31-47><a class=lnlinks href=#hl-31-47>47</a>
</span><span class=lnt id=hl-31-48><a class=lnlinks href=#hl-31-48>48</a>
</span><span class=lnt id=hl-31-49><a class=lnlinks href=#hl-31-49>49</a>
</span><span class=lnt id=hl-31-50><a class=lnlinks href=#hl-31-50>50</a>
</span><span class=lnt id=hl-31-51><a class=lnlinks href=#hl-31-51>51</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># command_models.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateOrderCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 생성 명령 - CQRS의 Command 역할&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>,</span> <span class=n>items</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>items</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># event_models.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderCreatedEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;주문 생성 이벤트 - Event Sourcing 핵심 역할&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>,</span> <span class=n>items</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>items</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># handlers.py (Command Side)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_create_order</span><span class=p>(</span><span class=n>command</span><span class=p>:</span> <span class=n>CreateOrderCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;명령 처리 -&gt; Write DB 저장 + 이벤트 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>save_order_to_write_db</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>event</span> <span class=o>=</span> <span class=n>OrderCreatedEvent</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>command</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>publish_event_to_kafka</span><span class=p>(</span><span class=s2>&#34;order_created&#34;</span><span class=p>,</span> <span class=n>event</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># handlers.py (Query Side)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_order_created_event</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>OrderCreatedEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 처리 -&gt; Read DB 갱신&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>update_order_in_read_db</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>order_id</span><span class=p>,</span> <span class=n>event</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># message_broker.py (Kafka Publisher &amp; Consumer)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaProducer</span><span class=p>,</span> <span class=n>KafkaConsumer</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>producer</span> <span class=o>=</span> <span class=n>KafkaProducer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap_servers</span><span class=o>=</span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value_serializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>v</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>publish_event_to_kafka</span><span class=p>(</span><span class=n>topic</span><span class=p>,</span> <span class=n>event_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 발행&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>topic</span><span class=p>,</span> <span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>producer</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>consume_order_created_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;이벤트 수신 후 Query 모델 갱신&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span> <span class=o>=</span> <span class=n>KafkaConsumer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;order_created&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap_servers</span><span class=o>=</span><span class=s1>&#39;localhost:9092&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>value_deserializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>m</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>consumer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>event_data</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>OrderCreatedEvent</span><span class=p>(</span><span class=o>**</span><span class=n>event_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handle_order_created_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=전자상거래-플랫폼>전자상거래 플랫폼<a hidden class=anchor aria-hidden=true href=#전자상거래-플랫폼>#</a></h5><p><strong>시스템 구성</strong>:</p><ul><li><strong>명령 측</strong>: 주문 생성, 재고 업데이트, 결제 처리</li><li><strong>조회 측</strong>: 상품 검색, 주문 이력, 재고 현황</li></ul><p><strong>시스템 구성도</strong>:</p><pre class=mermaid>graph TB
    subgraph &#34;사용자 인터페이스&#34;
        A[웹 애플리케이션]
        B[모바일 앱]
    end
    
    subgraph &#34;명령 측 (Order Service)&#34;
        C[Order API]
        D[Order Handler]
        E[Order DB]
    end
    
    subgraph &#34;조회 측 (Catalog Service)&#34;
        F[Catalog API]
        G[Search Handler]
        H[Read DB]
    end
    
    subgraph &#34;인프라&#34;
        I[Event Bus]
        J[Cache Layer]
    end
    
    A --&gt; C
    B --&gt; C
    A --&gt; F
    B --&gt; F
    C --&gt; D
    D --&gt; E
    D --&gt; I
    I --&gt; G
    G --&gt; H
    G --&gt; J
    F --&gt; G
</pre><p><strong>Workflow</strong>:</p><ol><li>사용자가 주문 생성 요청</li><li>Order Handler 가 비즈니스 로직 검증</li><li>Order DB 에 주문 정보 저장</li><li>OrderCreated 이벤트 발행</li><li>Catalog Service 가 이벤트 수신</li><li>Read DB 업데이트 (재고 감소)</li><li>캐시 갱신</li></ol><p><strong>CQRS 역할</strong>:</p><ul><li><strong>명령 측</strong>: 복잡한 주문 로직과 재고 관리</li><li><strong>조회 측</strong>: 빠른 상품 검색과 추천</li></ul><p><strong>CQRS 유무에 따른 차이점</strong>:</p><ul><li><strong>CQRS 적용 전</strong>:<ul><li>단일 데이터베이스에서 모든 작업 처리</li><li>복잡한 조인 쿼리로 성능 저하</li><li>읽기/쓰기 경합으로 인한 대기 시간 증가</li></ul></li><li><strong>CQRS 적용 후</strong>:<ul><li>읽기 최적화된 별도 데이터베이스</li><li>검색 성능 10 배 향상</li><li>주문 처리와 독립적인 카탈로그 조회</li></ul></li></ul><p><strong>구현 예시</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a class=lnlinks href=#hl-33-1>  1</a>
</span><span class=lnt id=hl-33-2><a class=lnlinks href=#hl-33-2>  2</a>
</span><span class=lnt id=hl-33-3><a class=lnlinks href=#hl-33-3>  3</a>
</span><span class=lnt id=hl-33-4><a class=lnlinks href=#hl-33-4>  4</a>
</span><span class=lnt id=hl-33-5><a class=lnlinks href=#hl-33-5>  5</a>
</span><span class=lnt id=hl-33-6><a class=lnlinks href=#hl-33-6>  6</a>
</span><span class=lnt id=hl-33-7><a class=lnlinks href=#hl-33-7>  7</a>
</span><span class=lnt id=hl-33-8><a class=lnlinks href=#hl-33-8>  8</a>
</span><span class=lnt id=hl-33-9><a class=lnlinks href=#hl-33-9>  9</a>
</span><span class=lnt id=hl-33-10><a class=lnlinks href=#hl-33-10> 10</a>
</span><span class=lnt id=hl-33-11><a class=lnlinks href=#hl-33-11> 11</a>
</span><span class=lnt id=hl-33-12><a class=lnlinks href=#hl-33-12> 12</a>
</span><span class=lnt id=hl-33-13><a class=lnlinks href=#hl-33-13> 13</a>
</span><span class=lnt id=hl-33-14><a class=lnlinks href=#hl-33-14> 14</a>
</span><span class=lnt id=hl-33-15><a class=lnlinks href=#hl-33-15> 15</a>
</span><span class=lnt id=hl-33-16><a class=lnlinks href=#hl-33-16> 16</a>
</span><span class=lnt id=hl-33-17><a class=lnlinks href=#hl-33-17> 17</a>
</span><span class=lnt id=hl-33-18><a class=lnlinks href=#hl-33-18> 18</a>
</span><span class=lnt id=hl-33-19><a class=lnlinks href=#hl-33-19> 19</a>
</span><span class=lnt id=hl-33-20><a class=lnlinks href=#hl-33-20> 20</a>
</span><span class=lnt id=hl-33-21><a class=lnlinks href=#hl-33-21> 21</a>
</span><span class=lnt id=hl-33-22><a class=lnlinks href=#hl-33-22> 22</a>
</span><span class=lnt id=hl-33-23><a class=lnlinks href=#hl-33-23> 23</a>
</span><span class=lnt id=hl-33-24><a class=lnlinks href=#hl-33-24> 24</a>
</span><span class=lnt id=hl-33-25><a class=lnlinks href=#hl-33-25> 25</a>
</span><span class=lnt id=hl-33-26><a class=lnlinks href=#hl-33-26> 26</a>
</span><span class=lnt id=hl-33-27><a class=lnlinks href=#hl-33-27> 27</a>
</span><span class=lnt id=hl-33-28><a class=lnlinks href=#hl-33-28> 28</a>
</span><span class=lnt id=hl-33-29><a class=lnlinks href=#hl-33-29> 29</a>
</span><span class=lnt id=hl-33-30><a class=lnlinks href=#hl-33-30> 30</a>
</span><span class=lnt id=hl-33-31><a class=lnlinks href=#hl-33-31> 31</a>
</span><span class=lnt id=hl-33-32><a class=lnlinks href=#hl-33-32> 32</a>
</span><span class=lnt id=hl-33-33><a class=lnlinks href=#hl-33-33> 33</a>
</span><span class=lnt id=hl-33-34><a class=lnlinks href=#hl-33-34> 34</a>
</span><span class=lnt id=hl-33-35><a class=lnlinks href=#hl-33-35> 35</a>
</span><span class=lnt id=hl-33-36><a class=lnlinks href=#hl-33-36> 36</a>
</span><span class=lnt id=hl-33-37><a class=lnlinks href=#hl-33-37> 37</a>
</span><span class=lnt id=hl-33-38><a class=lnlinks href=#hl-33-38> 38</a>
</span><span class=lnt id=hl-33-39><a class=lnlinks href=#hl-33-39> 39</a>
</span><span class=lnt id=hl-33-40><a class=lnlinks href=#hl-33-40> 40</a>
</span><span class=lnt id=hl-33-41><a class=lnlinks href=#hl-33-41> 41</a>
</span><span class=lnt id=hl-33-42><a class=lnlinks href=#hl-33-42> 42</a>
</span><span class=lnt id=hl-33-43><a class=lnlinks href=#hl-33-43> 43</a>
</span><span class=lnt id=hl-33-44><a class=lnlinks href=#hl-33-44> 44</a>
</span><span class=lnt id=hl-33-45><a class=lnlinks href=#hl-33-45> 45</a>
</span><span class=lnt id=hl-33-46><a class=lnlinks href=#hl-33-46> 46</a>
</span><span class=lnt id=hl-33-47><a class=lnlinks href=#hl-33-47> 47</a>
</span><span class=lnt id=hl-33-48><a class=lnlinks href=#hl-33-48> 48</a>
</span><span class=lnt id=hl-33-49><a class=lnlinks href=#hl-33-49> 49</a>
</span><span class=lnt id=hl-33-50><a class=lnlinks href=#hl-33-50> 50</a>
</span><span class=lnt id=hl-33-51><a class=lnlinks href=#hl-33-51> 51</a>
</span><span class=lnt id=hl-33-52><a class=lnlinks href=#hl-33-52> 52</a>
</span><span class=lnt id=hl-33-53><a class=lnlinks href=#hl-33-53> 53</a>
</span><span class=lnt id=hl-33-54><a class=lnlinks href=#hl-33-54> 54</a>
</span><span class=lnt id=hl-33-55><a class=lnlinks href=#hl-33-55> 55</a>
</span><span class=lnt id=hl-33-56><a class=lnlinks href=#hl-33-56> 56</a>
</span><span class=lnt id=hl-33-57><a class=lnlinks href=#hl-33-57> 57</a>
</span><span class=lnt id=hl-33-58><a class=lnlinks href=#hl-33-58> 58</a>
</span><span class=lnt id=hl-33-59><a class=lnlinks href=#hl-33-59> 59</a>
</span><span class=lnt id=hl-33-60><a class=lnlinks href=#hl-33-60> 60</a>
</span><span class=lnt id=hl-33-61><a class=lnlinks href=#hl-33-61> 61</a>
</span><span class=lnt id=hl-33-62><a class=lnlinks href=#hl-33-62> 62</a>
</span><span class=lnt id=hl-33-63><a class=lnlinks href=#hl-33-63> 63</a>
</span><span class=lnt id=hl-33-64><a class=lnlinks href=#hl-33-64> 64</a>
</span><span class=lnt id=hl-33-65><a class=lnlinks href=#hl-33-65> 65</a>
</span><span class=lnt id=hl-33-66><a class=lnlinks href=#hl-33-66> 66</a>
</span><span class=lnt id=hl-33-67><a class=lnlinks href=#hl-33-67> 67</a>
</span><span class=lnt id=hl-33-68><a class=lnlinks href=#hl-33-68> 68</a>
</span><span class=lnt id=hl-33-69><a class=lnlinks href=#hl-33-69> 69</a>
</span><span class=lnt id=hl-33-70><a class=lnlinks href=#hl-33-70> 70</a>
</span><span class=lnt id=hl-33-71><a class=lnlinks href=#hl-33-71> 71</a>
</span><span class=lnt id=hl-33-72><a class=lnlinks href=#hl-33-72> 72</a>
</span><span class=lnt id=hl-33-73><a class=lnlinks href=#hl-33-73> 73</a>
</span><span class=lnt id=hl-33-74><a class=lnlinks href=#hl-33-74> 74</a>
</span><span class=lnt id=hl-33-75><a class=lnlinks href=#hl-33-75> 75</a>
</span><span class=lnt id=hl-33-76><a class=lnlinks href=#hl-33-76> 76</a>
</span><span class=lnt id=hl-33-77><a class=lnlinks href=#hl-33-77> 77</a>
</span><span class=lnt id=hl-33-78><a class=lnlinks href=#hl-33-78> 78</a>
</span><span class=lnt id=hl-33-79><a class=lnlinks href=#hl-33-79> 79</a>
</span><span class=lnt id=hl-33-80><a class=lnlinks href=#hl-33-80> 80</a>
</span><span class=lnt id=hl-33-81><a class=lnlinks href=#hl-33-81> 81</a>
</span><span class=lnt id=hl-33-82><a class=lnlinks href=#hl-33-82> 82</a>
</span><span class=lnt id=hl-33-83><a class=lnlinks href=#hl-33-83> 83</a>
</span><span class=lnt id=hl-33-84><a class=lnlinks href=#hl-33-84> 84</a>
</span><span class=lnt id=hl-33-85><a class=lnlinks href=#hl-33-85> 85</a>
</span><span class=lnt id=hl-33-86><a class=lnlinks href=#hl-33-86> 86</a>
</span><span class=lnt id=hl-33-87><a class=lnlinks href=#hl-33-87> 87</a>
</span><span class=lnt id=hl-33-88><a class=lnlinks href=#hl-33-88> 88</a>
</span><span class=lnt id=hl-33-89><a class=lnlinks href=#hl-33-89> 89</a>
</span><span class=lnt id=hl-33-90><a class=lnlinks href=#hl-33-90> 90</a>
</span><span class=lnt id=hl-33-91><a class=lnlinks href=#hl-33-91> 91</a>
</span><span class=lnt id=hl-33-92><a class=lnlinks href=#hl-33-92> 92</a>
</span><span class=lnt id=hl-33-93><a class=lnlinks href=#hl-33-93> 93</a>
</span><span class=lnt id=hl-33-94><a class=lnlinks href=#hl-33-94> 94</a>
</span><span class=lnt id=hl-33-95><a class=lnlinks href=#hl-33-95> 95</a>
</span><span class=lnt id=hl-33-96><a class=lnlinks href=#hl-33-96> 96</a>
</span><span class=lnt id=hl-33-97><a class=lnlinks href=#hl-33-97> 97</a>
</span><span class=lnt id=hl-33-98><a class=lnlinks href=#hl-33-98> 98</a>
</span><span class=lnt id=hl-33-99><a class=lnlinks href=#hl-33-99> 99</a>
</span><span class=lnt id=hl-33-100><a class=lnlinks href=#hl-33-100>100</a>
</span><span class=lnt id=hl-33-101><a class=lnlinks href=#hl-33-101>101</a>
</span><span class=lnt id=hl-33-102><a class=lnlinks href=#hl-33-102>102</a>
</span><span class=lnt id=hl-33-103><a class=lnlinks href=#hl-33-103>103</a>
</span><span class=lnt id=hl-33-104><a class=lnlinks href=#hl-33-104>104</a>
</span><span class=lnt id=hl-33-105><a class=lnlinks href=#hl-33-105>105</a>
</span><span class=lnt id=hl-33-106><a class=lnlinks href=#hl-33-106>106</a>
</span><span class=lnt id=hl-33-107><a class=lnlinks href=#hl-33-107>107</a>
</span><span class=lnt id=hl-33-108><a class=lnlinks href=#hl-33-108>108</a>
</span><span class=lnt id=hl-33-109><a class=lnlinks href=#hl-33-109>109</a>
</span><span class=lnt id=hl-33-110><a class=lnlinks href=#hl-33-110>110</a>
</span><span class=lnt id=hl-33-111><a class=lnlinks href=#hl-33-111>111</a>
</span><span class=lnt id=hl-33-112><a class=lnlinks href=#hl-33-112>112</a>
</span><span class=lnt id=hl-33-113><a class=lnlinks href=#hl-33-113>113</a>
</span><span class=lnt id=hl-33-114><a class=lnlinks href=#hl-33-114>114</a>
</span><span class=lnt id=hl-33-115><a class=lnlinks href=#hl-33-115>115</a>
</span><span class=lnt id=hl-33-116><a class=lnlinks href=#hl-33-116>116</a>
</span><span class=lnt id=hl-33-117><a class=lnlinks href=#hl-33-117>117</a>
</span><span class=lnt id=hl-33-118><a class=lnlinks href=#hl-33-118>118</a>
</span><span class=lnt id=hl-33-119><a class=lnlinks href=#hl-33-119>119</a>
</span><span class=lnt id=hl-33-120><a class=lnlinks href=#hl-33-120>120</a>
</span><span class=lnt id=hl-33-121><a class=lnlinks href=#hl-33-121>121</a>
</span><span class=lnt id=hl-33-122><a class=lnlinks href=#hl-33-122>122</a>
</span><span class=lnt id=hl-33-123><a class=lnlinks href=#hl-33-123>123</a>
</span><span class=lnt id=hl-33-124><a class=lnlinks href=#hl-33-124>124</a>
</span><span class=lnt id=hl-33-125><a class=lnlinks href=#hl-33-125>125</a>
</span><span class=lnt id=hl-33-126><a class=lnlinks href=#hl-33-126>126</a>
</span><span class=lnt id=hl-33-127><a class=lnlinks href=#hl-33-127>127</a>
</span><span class=lnt id=hl-33-128><a class=lnlinks href=#hl-33-128>128</a>
</span><span class=lnt id=hl-33-129><a class=lnlinks href=#hl-33-129>129</a>
</span><span class=lnt id=hl-33-130><a class=lnlinks href=#hl-33-130>130</a>
</span><span class=lnt id=hl-33-131><a class=lnlinks href=#hl-33-131>131</a>
</span><span class=lnt id=hl-33-132><a class=lnlinks href=#hl-33-132>132</a>
</span><span class=lnt id=hl-33-133><a class=lnlinks href=#hl-33-133>133</a>
</span><span class=lnt id=hl-33-134><a class=lnlinks href=#hl-33-134>134</a>
</span><span class=lnt id=hl-33-135><a class=lnlinks href=#hl-33-135>135</a>
</span><span class=lnt id=hl-33-136><a class=lnlinks href=#hl-33-136>136</a>
</span><span class=lnt id=hl-33-137><a class=lnlinks href=#hl-33-137>137</a>
</span><span class=lnt id=hl-33-138><a class=lnlinks href=#hl-33-138>138</a>
</span><span class=lnt id=hl-33-139><a class=lnlinks href=#hl-33-139>139</a>
</span><span class=lnt id=hl-33-140><a class=lnlinks href=#hl-33-140>140</a>
</span><span class=lnt id=hl-33-141><a class=lnlinks href=#hl-33-141>141</a>
</span><span class=lnt id=hl-33-142><a class=lnlinks href=#hl-33-142>142</a>
</span><span class=lnt id=hl-33-143><a class=lnlinks href=#hl-33-143>143</a>
</span><span class=lnt id=hl-33-144><a class=lnlinks href=#hl-33-144>144</a>
</span><span class=lnt id=hl-33-145><a class=lnlinks href=#hl-33-145>145</a>
</span><span class=lnt id=hl-33-146><a class=lnlinks href=#hl-33-146>146</a>
</span><span class=lnt id=hl-33-147><a class=lnlinks href=#hl-33-147>147</a>
</span><span class=lnt id=hl-33-148><a class=lnlinks href=#hl-33-148>148</a>
</span><span class=lnt id=hl-33-149><a class=lnlinks href=#hl-33-149>149</a>
</span><span class=lnt id=hl-33-150><a class=lnlinks href=#hl-33-150>150</a>
</span><span class=lnt id=hl-33-151><a class=lnlinks href=#hl-33-151>151</a>
</span><span class=lnt id=hl-33-152><a class=lnlinks href=#hl-33-152>152</a>
</span><span class=lnt id=hl-33-153><a class=lnlinks href=#hl-33-153>153</a>
</span><span class=lnt id=hl-33-154><a class=lnlinks href=#hl-33-154>154</a>
</span><span class=lnt id=hl-33-155><a class=lnlinks href=#hl-33-155>155</a>
</span><span class=lnt id=hl-33-156><a class=lnlinks href=#hl-33-156>156</a>
</span><span class=lnt id=hl-33-157><a class=lnlinks href=#hl-33-157>157</a>
</span><span class=lnt id=hl-33-158><a class=lnlinks href=#hl-33-158>158</a>
</span><span class=lnt id=hl-33-159><a class=lnlinks href=#hl-33-159>159</a>
</span><span class=lnt id=hl-33-160><a class=lnlinks href=#hl-33-160>160</a>
</span><span class=lnt id=hl-33-161><a class=lnlinks href=#hl-33-161>161</a>
</span><span class=lnt id=hl-33-162><a class=lnlinks href=#hl-33-162>162</a>
</span><span class=lnt id=hl-33-163><a class=lnlinks href=#hl-33-163>163</a>
</span><span class=lnt id=hl-33-164><a class=lnlinks href=#hl-33-164>164</a>
</span><span class=lnt id=hl-33-165><a class=lnlinks href=#hl-33-165>165</a>
</span><span class=lnt id=hl-33-166><a class=lnlinks href=#hl-33-166>166</a>
</span><span class=lnt id=hl-33-167><a class=lnlinks href=#hl-33-167>167</a>
</span><span class=lnt id=hl-33-168><a class=lnlinks href=#hl-33-168>168</a>
</span><span class=lnt id=hl-33-169><a class=lnlinks href=#hl-33-169>169</a>
</span><span class=lnt id=hl-33-170><a class=lnlinks href=#hl-33-170>170</a>
</span><span class=lnt id=hl-33-171><a class=lnlinks href=#hl-33-171>171</a>
</span><span class=lnt id=hl-33-172><a class=lnlinks href=#hl-33-172>172</a>
</span><span class=lnt id=hl-33-173><a class=lnlinks href=#hl-33-173>173</a>
</span><span class=lnt id=hl-33-174><a class=lnlinks href=#hl-33-174>174</a>
</span><span class=lnt id=hl-33-175><a class=lnlinks href=#hl-33-175>175</a>
</span><span class=lnt id=hl-33-176><a class=lnlinks href=#hl-33-176>176</a>
</span><span class=lnt id=hl-33-177><a class=lnlinks href=#hl-33-177>177</a>
</span><span class=lnt id=hl-33-178><a class=lnlinks href=#hl-33-178>178</a>
</span><span class=lnt id=hl-33-179><a class=lnlinks href=#hl-33-179>179</a>
</span><span class=lnt id=hl-33-180><a class=lnlinks href=#hl-33-180>180</a>
</span><span class=lnt id=hl-33-181><a class=lnlinks href=#hl-33-181>181</a>
</span><span class=lnt id=hl-33-182><a class=lnlinks href=#hl-33-182>182</a>
</span><span class=lnt id=hl-33-183><a class=lnlinks href=#hl-33-183>183</a>
</span><span class=lnt id=hl-33-184><a class=lnlinks href=#hl-33-184>184</a>
</span><span class=lnt id=hl-33-185><a class=lnlinks href=#hl-33-185>185</a>
</span><span class=lnt id=hl-33-186><a class=lnlinks href=#hl-33-186>186</a>
</span><span class=lnt id=hl-33-187><a class=lnlinks href=#hl-33-187>187</a>
</span><span class=lnt id=hl-33-188><a class=lnlinks href=#hl-33-188>188</a>
</span><span class=lnt id=hl-33-189><a class=lnlinks href=#hl-33-189>189</a>
</span><span class=lnt id=hl-33-190><a class=lnlinks href=#hl-33-190>190</a>
</span><span class=lnt id=hl-33-191><a class=lnlinks href=#hl-33-191>191</a>
</span><span class=lnt id=hl-33-192><a class=lnlinks href=#hl-33-192>192</a>
</span><span class=lnt id=hl-33-193><a class=lnlinks href=#hl-33-193>193</a>
</span><span class=lnt id=hl-33-194><a class=lnlinks href=#hl-33-194>194</a>
</span><span class=lnt id=hl-33-195><a class=lnlinks href=#hl-33-195>195</a>
</span><span class=lnt id=hl-33-196><a class=lnlinks href=#hl-33-196>196</a>
</span><span class=lnt id=hl-33-197><a class=lnlinks href=#hl-33-197>197</a>
</span><span class=lnt id=hl-33-198><a class=lnlinks href=#hl-33-198>198</a>
</span><span class=lnt id=hl-33-199><a class=lnlinks href=#hl-33-199>199</a>
</span><span class=lnt id=hl-33-200><a class=lnlinks href=#hl-33-200>200</a>
</span><span class=lnt id=hl-33-201><a class=lnlinks href=#hl-33-201>201</a>
</span><span class=lnt id=hl-33-202><a class=lnlinks href=#hl-33-202>202</a>
</span><span class=lnt id=hl-33-203><a class=lnlinks href=#hl-33-203>203</a>
</span><span class=lnt id=hl-33-204><a class=lnlinks href=#hl-33-204>204</a>
</span><span class=lnt id=hl-33-205><a class=lnlinks href=#hl-33-205>205</a>
</span><span class=lnt id=hl-33-206><a class=lnlinks href=#hl-33-206>206</a>
</span><span class=lnt id=hl-33-207><a class=lnlinks href=#hl-33-207>207</a>
</span><span class=lnt id=hl-33-208><a class=lnlinks href=#hl-33-208>208</a>
</span><span class=lnt id=hl-33-209><a class=lnlinks href=#hl-33-209>209</a>
</span><span class=lnt id=hl-33-210><a class=lnlinks href=#hl-33-210>210</a>
</span><span class=lnt id=hl-33-211><a class=lnlinks href=#hl-33-211>211</a>
</span><span class=lnt id=hl-33-212><a class=lnlinks href=#hl-33-212>212</a>
</span><span class=lnt id=hl-33-213><a class=lnlinks href=#hl-33-213>213</a>
</span><span class=lnt id=hl-33-214><a class=lnlinks href=#hl-33-214>214</a>
</span><span class=lnt id=hl-33-215><a class=lnlinks href=#hl-33-215>215</a>
</span><span class=lnt id=hl-33-216><a class=lnlinks href=#hl-33-216>216</a>
</span><span class=lnt id=hl-33-217><a class=lnlinks href=#hl-33-217>217</a>
</span><span class=lnt id=hl-33-218><a class=lnlinks href=#hl-33-218>218</a>
</span><span class=lnt id=hl-33-219><a class=lnlinks href=#hl-33-219>219</a>
</span><span class=lnt id=hl-33-220><a class=lnlinks href=#hl-33-220>220</a>
</span><span class=lnt id=hl-33-221><a class=lnlinks href=#hl-33-221>221</a>
</span><span class=lnt id=hl-33-222><a class=lnlinks href=#hl-33-222>222</a>
</span><span class=lnt id=hl-33-223><a class=lnlinks href=#hl-33-223>223</a>
</span><span class=lnt id=hl-33-224><a class=lnlinks href=#hl-33-224>224</a>
</span><span class=lnt id=hl-33-225><a class=lnlinks href=#hl-33-225>225</a>
</span><span class=lnt id=hl-33-226><a class=lnlinks href=#hl-33-226>226</a>
</span><span class=lnt id=hl-33-227><a class=lnlinks href=#hl-33-227>227</a>
</span><span class=lnt id=hl-33-228><a class=lnlinks href=#hl-33-228>228</a>
</span><span class=lnt id=hl-33-229><a class=lnlinks href=#hl-33-229>229</a>
</span><span class=lnt id=hl-33-230><a class=lnlinks href=#hl-33-230>230</a>
</span><span class=lnt id=hl-33-231><a class=lnlinks href=#hl-33-231>231</a>
</span><span class=lnt id=hl-33-232><a class=lnlinks href=#hl-33-232>232</a>
</span><span class=lnt id=hl-33-233><a class=lnlinks href=#hl-33-233>233</a>
</span><span class=lnt id=hl-33-234><a class=lnlinks href=#hl-33-234>234</a>
</span><span class=lnt id=hl-33-235><a class=lnlinks href=#hl-33-235>235</a>
</span><span class=lnt id=hl-33-236><a class=lnlinks href=#hl-33-236>236</a>
</span><span class=lnt id=hl-33-237><a class=lnlinks href=#hl-33-237>237</a>
</span><span class=lnt id=hl-33-238><a class=lnlinks href=#hl-33-238>238</a>
</span><span class=lnt id=hl-33-239><a class=lnlinks href=#hl-33-239>239</a>
</span><span class=lnt id=hl-33-240><a class=lnlinks href=#hl-33-240>240</a>
</span><span class=lnt id=hl-33-241><a class=lnlinks href=#hl-33-241>241</a>
</span><span class=lnt id=hl-33-242><a class=lnlinks href=#hl-33-242>242</a>
</span><span class=lnt id=hl-33-243><a class=lnlinks href=#hl-33-243>243</a>
</span><span class=lnt id=hl-33-244><a class=lnlinks href=#hl-33-244>244</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># CQRS 패턴을 활용한 전자상거래 주문 시스템</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 도메인 이벤트</span>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DomainEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>event_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>aggregate_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 명령 (Commands)</span>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateOrderCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UpdateInventoryCommand</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 쿼리 (Queries)</span>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetOrderHistoryQuery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SearchProductsQuery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>keyword</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>category</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 이벤트 스토어</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventStore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>DomainEvent</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>callable</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>save_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 발행</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>subscriber</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>subscriber</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_events</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>aggregate_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>DomainEvent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>aggregate_id</span> <span class=o>==</span> <span class=n>aggregate_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 애그리게이트 루트</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;PENDING&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total_amount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=s2>&#34;PENDING&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Order already created&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>customer_id</span> <span class=o>=</span> <span class=n>customer_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>items</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total_amount</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;quantity&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;CREATED&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>DomainEvent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event_id</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>            <span class=n>aggregate_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>event_type</span><span class=o>=</span><span class=s2>&#34;OrderCreated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;customer_id&#34;</span><span class=p>:</span> <span class=n>customer_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;total_amount&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_amount</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>version</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_uncommitted_events</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mark_events_as_committed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uncommitted_events</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 명령 핸들러</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderCommandHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_store</span><span class=p>:</span> <span class=n>EventStore</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>event_store</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Order</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_create_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>:</span> <span class=n>CreateOrderCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>order_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>Order</span><span class=p>(</span><span class=n>order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>create_order</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>customer_id</span><span class=p>,</span> <span class=n>command</span><span class=o>.</span><span class=n>items</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 저장</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>order</span><span class=o>.</span><span class=n>get_uncommitted_events</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>save_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>order</span><span class=o>.</span><span class=n>mark_events_as_committed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>[</span><span class=n>order_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>order_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 읽기 모델</span>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderView</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>customer_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>total_amount</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductView</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>price</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>category</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>inventory</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 조회 핸들러</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderQueryHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_views</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>OrderView</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_get_order_history</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=n>GetOrderHistoryQuery</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>OrderView</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>order</span> <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>order_views</span> 
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>order</span><span class=o>.</span><span class=n>customer_id</span> <span class=o>==</span> <span class=n>query</span><span class=o>.</span><span class=n>customer_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>update_order_view</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order_view</span> <span class=o>=</span> <span class=n>OrderView</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nb>id</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>aggregate_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>customer_id</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;customer_id&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>items</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;items&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>total_amount</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;total_amount&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>status</span><span class=o>=</span><span class=s2>&#34;CREATED&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>created_at</span><span class=o>=</span><span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>order_views</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>order_view</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductQueryHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product_views</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>ProductView</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 초기 상품 데이터</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product_views</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>ProductView</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;노트북&#34;</span><span class=p>,</span> <span class=mi>1500000</span><span class=p>,</span> <span class=s2>&#34;전자제품&#34;</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=s2>&#34;고성능 노트북&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>ProductView</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;마우스&#34;</span><span class=p>,</span> <span class=mi>50000</span><span class=p>,</span> <span class=s2>&#34;전자제품&#34;</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=s2>&#34;무선 마우스&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_search_products</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=n>SearchProductsQuery</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>ProductView</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>product_views</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>query</span><span class=o>.</span><span class=n>keyword</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span> <span class=o>=</span> <span class=p>[</span><span class=n>p</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>query</span><span class=o>.</span><span class=n>keyword</span> <span class=ow>in</span> <span class=n>p</span><span class=o>.</span><span class=n>name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>query</span><span class=o>.</span><span class=n>category</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span> <span class=o>=</span> <span class=p>[</span><span class=n>p</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>p</span><span class=o>.</span><span class=n>category</span> <span class=o>==</span> <span class=n>query</span><span class=o>.</span><span class=n>category</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>update_inventory</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>DomainEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;OrderCreated&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;items&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>product_id</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&#34;product_id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>quantity</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&#34;quantity&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>product</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>product_views</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>product</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>product_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>product</span><span class=o>.</span><span class=n>inventory</span> <span class=o>-=</span> <span class=n>quantity</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CQRS 시스템 조합</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CQRSSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span> <span class=o>=</span> <span class=n>EventStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_command_handler</span> <span class=o>=</span> <span class=n>OrderCommandHandler</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>order_query_handler</span> <span class=o>=</span> <span class=n>OrderQueryHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>product_query_handler</span> <span class=o>=</span> <span class=n>ProductQueryHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 이벤트 구독 설정</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>order_query_handler</span><span class=o>.</span><span class=n>update_order_view</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_store</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>product_query_handler</span><span class=o>.</span><span class=n>update_inventory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_command</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>CreateOrderCommand</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>order_command_handler</span><span class=o>.</span><span class=n>handle_create_order</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>GetOrderHistoryQuery</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>order_query_handler</span><span class=o>.</span><span class=n>handle_get_order_history</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>SearchProductsQuery</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>product_query_handler</span><span class=o>.</span><span class=n>handle_search_products</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 사용 예시</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>cqrs_system</span> <span class=o>=</span> <span class=n>CQRSSystem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 명령 실행: 주문 생성</span>
</span></span><span class=line><span class=cl>    <span class=n>create_order_cmd</span> <span class=o>=</span> <span class=n>CreateOrderCommand</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>customer_id</span><span class=o>=</span><span class=s2>&#34;customer_123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;product_id&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;노트북&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>1500000</span><span class=p>,</span> <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;product_id&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;마우스&#34;</span><span class=p>,</span> <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>50000</span><span class=p>,</span> <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>order_id</span> <span class=o>=</span> <span class=k>await</span> <span class=n>cqrs_system</span><span class=o>.</span><span class=n>execute_command</span><span class=p>(</span><span class=n>create_order_cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 생성됨: </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 조회 실행: 주문 이력 조회</span>
</span></span><span class=line><span class=cl>    <span class=n>order_history_query</span> <span class=o>=</span> <span class=n>GetOrderHistoryQuery</span><span class=p>(</span><span class=n>customer_id</span><span class=o>=</span><span class=s2>&#34;customer_123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>order_history</span> <span class=o>=</span> <span class=k>await</span> <span class=n>cqrs_system</span><span class=o>.</span><span class=n>execute_query</span><span class=p>(</span><span class=n>order_history_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;주문 이력: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>order_history</span><span class=p>)</span><span class=si>}</span><span class=s2>건&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>order_history</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - 주문 ID: </span><span class=si>{</span><span class=n>order</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>, 총액: </span><span class=si>{</span><span class=n>order</span><span class=o>.</span><span class=n>total_amount</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 조회 실행: 상품 검색</span>
</span></span><span class=line><span class=cl>    <span class=n>product_search_query</span> <span class=o>=</span> <span class=n>SearchProductsQuery</span><span class=p>(</span><span class=n>keyword</span><span class=o>=</span><span class=s2>&#34;노트북&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>products</span> <span class=o>=</span> <span class=k>await</span> <span class=n>cqrs_system</span><span class=o>.</span><span class=n>execute_query</span><span class=p>(</span><span class=n>product_search_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;상품 검색 결과: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>products</span><span class=p>)</span><span class=si>}</span><span class=s2>건&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>product</span> <span class=ow>in</span> <span class=n>products</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>product</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>product</span><span class=o>.</span><span class=n>inventory</span><span class=si>}</span><span class=s2>개 남음&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=운영-및-최적화-operations--optimization>운영 및 최적화 (Operations & Optimization)<a hidden class=anchor aria-hidden=true href=#운영-및-최적화-operations--optimization>#</a></h3><h4 id=보안-및-거버넌스>보안 및 거버넌스<a hidden class=anchor aria-hidden=true href=#보안-및-거버넌스>#</a></h4><p>CQRS 보안은 **" 두 개의 길 + 울타리 &ldquo;**로 보면 쉽다.</p><ul><li>쓰기 길 (명령) 은 <strong>높은 펜스</strong>(강한 권한·검증), 읽기 길 (조회) 은 <strong>얕은 펜스</strong>(최소권한·고속).</li><li>길 사이의 교차로 (이벤트 브로커) 는 <strong>암호화·인증·ACL</strong>로 통제.</li><li>표지판 (스키마·프로젝션) 은 <strong>버전·호환성</strong> 규칙으로 바뀌어도 안전.</li><li>모든 움직임은 <strong>감사 로그</strong>로 남기고, <strong>규정</strong>(NIST/GDPR) 에 맞춰 보관한다.</li></ul><table><thead><tr><th>영역</th><th>핵심 위험</th><th>보안 요구/정책</th><th>구현 방안</th><th>모니터링/감사</th></tr></thead><tbody><tr><td>인증/인가 (API)</td><td>권한 상승, 토큰 오용</td><td>Command/Query <strong>권한 분리</strong>, 최소권한 (RBAC/ABAC)</td><td>OAuth 2.0 BCP(권장 플로우, PKCE/PAR), JWT <strong>서명·클레임 검증</strong>(exp/iss/aud 등)</td><td>접근 로그, 토큰 실패율/이상 패턴 탐지</td></tr><tr><td>통신 보안</td><td>도청·중간자 공격</td><td>외부 <strong>TLS 1.3</strong>, 내부 <strong>mTLS</strong> 강제</td><td>L7 게이트웨이 TLS1.3, 서비스 메시 인증정책 (mTLS)</td><td>인증서 만료/회전, 암호 스위트 준수</td></tr><tr><td>이벤트/브로커</td><td>위·변조, 무단 구독</td><td>브로커 <strong>인증·인가</strong>, 토픽 분리</td><td>Kafka <strong>SASL_SSL</strong> + ACL, 프로듀서/컨슈머 자격 분리</td><td>토픽 접근 실패·비정상 소비량 경보</td></tr><tr><td>동기화/일관성</td><td>이중쓰기, 유실</td><td><strong>Outbox+CDC</strong>, 멱등 소비</td><td>트랜잭셔널 아웃박스 + Debezium, 재처리·DLQ</td><td>오프셋 지연·누락 이벤트 대시보드</td></tr><tr><td>데이터 보호</td><td>PII 누출</td><td>전송·저장 <strong>암호화</strong>, 키관리·회전</td><td>필드 레벨 암호화, 키 볼트/KMS, 로테이션</td><td>키 만료·교체 감사, 민감필드 접근 추적</td></tr><tr><td>스키마 거버넌스</td><td>소비자 장애</td><td><strong>호환성 모드</strong>(Backward 등) 규정</td><td>Confluent <strong>Schema Registry</strong> + CI 검증</td><td>스키마 변경 이력·호환성 실패 알림</td></tr><tr><td>규정 준수</td><td>책임소재 불분명</td><td><strong>최소권한 (AC-6)</strong>, <strong>감사 (AU-2)</strong> 매핑</td><td>역할·권한 증적, 이벤트/관리행위 로그 보존</td><td>정기 리뷰·침해 대응 (72h 규정 등 도메인별)</td></tr><tr><td>제품·UX</td><td>최종 일관성 혼동</td><td>지연 알림·리프레시 UX</td><td>" 처리 중/곧 반영 " 피드백, 수동 새로고침</td><td>읽기 - 쓰기 지연 (SLA) 관측</td></tr></tbody></table><p>핵심은 <strong>경계 분리와 표준화</strong>다. 쓰기·읽기·브로커 각각에 <strong>맞춤 보호대</strong>(권한·TLS/mTLS·ACL) 를 치고, <strong>Outbox+CDC</strong>와 <strong>스키마 호환성</strong>으로 데이터 흐름을 안정화한다. 마지막으로 <strong>최소권한·감사</strong>를 규정과 매핑해 신뢰를 완성한다.</p><h4 id=모니터링-및-관측성>모니터링 및 관측성<a hidden class=anchor aria-hidden=true href=#모니터링-및-관측성>#</a></h4><p>CQRS 에서는 <strong>쓰기와 읽기가 따로 움직여</strong> 읽기가 조금 늦게 반영될 수 있다.<br>그래서 <strong>두 가지 축</strong>을 꼭 본다:</p><ol><li><strong>이벤트 파이프라인</strong>이 잘 흐르는지 (컨슈머 랙·실패율·DLQ),</li><li><strong>읽기 모델이 제때 갱신되는지</strong>(프로젝션 랙).<br>그리고 OpenTelemetry 로 <strong>요청→이벤트→프로젝션→조회</strong>를 하나의 <strong>트레이스</strong>로 묶으면, 어디서 느려졌는지 바로 찾을 수 있다.</li></ol><table><thead><tr><th>영역</th><th>핵심 지표</th><th>의미/목적</th><th>수집원/도구</th><th>경보 아이디어</th></tr></thead><tbody><tr><td>이벤트 파이프라인</td><td><strong>Consumer Lag</strong></td><td>소비 지연 (오프셋 기준) 로 <strong>처리 적체</strong> 파악</td><td>Kafka JMX/Exporter, Confluent/MSK 모니터링</td><td>랙의 절대값·증가율 경보, 파티션별 임계치.</td></tr><tr><td></td><td>처리율/실패율</td><td>초당 이벤트 처리·실패 추세</td><td>Broker/Consumer metrics</td><td>실패율 급증·처리율 급감 시 경보</td></tr><tr><td></td><td>DLQ 크기/증가율</td><td>재처리 필요 이벤트 적체</td><td>브로커/파이프라인 메트릭</td><td>DLQ 증가율·체류 시간 경보</td></tr><tr><td></td><td>파티션 스큐</td><td>일부 파티션 과부하</td><td>Exporter·대시보드</td><td>스큐 비율 초과 시 재파티셔닝</td></tr><tr><td>저장소·동기화</td><td><strong>프로젝션 랙 (seconds)</strong></td><td>이벤트→읽기모델 반영 지연 (EC 가시화)</td><td>프로젝션 워커 메트릭/로그</td><td>랙 P95/P99 경보 (업무 SLA 기준).</td></tr><tr><td></td><td>Write/Read DB 지연·에러율</td><td>각각의 병목/장애 조기 탐지</td><td>DB/드라이버 메트릭</td><td>지연·에러율 임계치</td></tr><tr><td>추적/로깅</td><td><strong>엔드투엔드 트레이스</strong></td><td>Command→Event→Projection→Query 연결</td><td>OpenTelemetry, W3C Trace Context</td><td>스팬 지연 초과·오류 스팬 비율 경보.</td></tr><tr><td>신뢰성 보강</td><td>Outbox 배출 지연</td><td>아웃박스→브로커 전파 지연</td><td>CDC/퍼블리셔 메트릭</td><td>배출 지연·미전파 건수 경보.</td></tr><tr><td></td><td>스키마 검증 실패율</td><td>이벤트 스키마 불일치 탐지</td><td>레지스트리/소비자 로깅</td><td>실패율 급증 경보</td></tr></tbody></table><p>관측의 축은 <strong>이벤트 흐름 (랙·실패·DLQ)</strong> 과 <strong>읽기 반영 (프로젝션 랙)</strong>, 그리고 <strong>엔드투엔드 추적</strong>이다. 이 세 축만 꾸준히 보면 CQRS 의 <strong>지연 일관성</strong>과 <strong>병목</strong>을 체계적으로 다 잡을 수 있다. 지표는 Kafka/Exporter·DB 메트릭·OpenTelemetry 로 표준화해 대시보드와 경보에 연결하라.</p><h4 id=실무-적용-고려사항-및-주의점>실무 적용 고려사항 및 주의점<a hidden class=anchor aria-hidden=true href=#실무-적용-고려사항-및-주의점>#</a></h4><table><thead><tr><th>카테고리</th><th>고려사항</th><th>위험/주의</th><th>권장사항</th><th>핵심 지표</th></tr></thead><tbody><tr><td>설계/도입</td><td>Bounded Context 기준 점진 도입</td><td>전면 전환 실패 리스크</td><td>파일럿→확장, 간단 도메인은 CRUD 유지</td><td>전환 범위 대비 결함률</td></tr><tr><td>설계/도입</td><td>도메인 복잡성 평가</td><td>과도한 아키텍처</td><td>읽기≫쓰기·질의 다양에서만 적용</td><td>R:W, 질의 수/복잡도</td></tr><tr><td>일관성/동기화</td><td>최종 일관성으로 인한 UX</td><td>RYW 미보장</td><td>낙관적 UI/세션 일관성, 중요 화면 동기화</td><td>뷰 갱신 지연 p95</td></tr><tr><td>일관성/동기화</td><td>Projection/뷰 설계</td><td>중복·정합성 관리</td><td>이벤트 기반 뷰 갱신/리플레이</td><td>프로젝션 지연/실패율</td></tr><tr><td>신뢰성/내결함성</td><td>듀얼라이트 (유실/중복)</td><td>DB↔브로커 불일치</td><td><strong>Transactional Outbox</strong> + 멱등</td><td>미전송/중복 이벤트 수</td></tr><tr><td>신뢰성/내결함성</td><td>분산 트랜잭션</td><td>전역 롤백 부재</td><td><strong>Saga</strong>(보상/오케스트레이션)</td><td>보상률/타임아웃</td></tr><tr><td>이벤트/순서/버전</td><td>순서 보장</td><td>파티션 확장 시 순서 붕괴</td><td><strong>파티션 키</strong>로 엔티티 고정, 단일 파티션 선택적</td><td>out-of-order 비율</td></tr><tr><td>이벤트/순서/버전</td><td>이벤트/스키마 버전</td><td>리플레이·호환성 오류</td><td>이벤트/스키마 버전 전략·백필 플랜</td><td>버전 충돌 건수</td></tr><tr><td>인프라/운영/관측</td><td>메시징/모니터링 인프라</td><td>원인 미상 지연</td><td>Lag, 처리율, 오류율, DLQ</td><td>Lag, DLQ 적재량</td></tr><tr><td>팀/테스트/거버넌스</td><td>학습 곡선/테스트 복잡</td><td>생산성 초기 저하</td><td>교육·런북·<strong>계약/통합 테스트</strong></td><td>실패 시 재처리 성공률</td></tr><tr><td>보안/감사</td><td>R/W API 분리</td><td>권한·감사 누락</td><td>최소권한, 감사로그, 추적 ID</td><td>감사 이벤트 결손률</td></tr><tr><td>운영 자동화</td><td>Outbox/CDC 운영</td><td>릴레이·청소 비용</td><td>Debezium Outbox Router/Quarkus</td><td>릴레이 지연/적체</td></tr></tbody></table><ul><li><strong>효과는 분명</strong>: 읽기/쓰기 분리로 성능·확장·보안이 좋아진다.</li><li><strong>대가도 분명</strong>: 복잡도·운영비용이 오른다. 그래서 <strong>점진도입</strong>과 <strong>관측 지표</strong>가 필수다.</li><li><strong>신뢰성·순서</strong>는 <strong>Outbox·멱등·DLQ·파티션 키</strong>로, <strong>분산 쓰기</strong>는 <strong>Saga</strong>로 보강한다.</li></ul><h4 id=성능-최적화-전략-및-고려사항>성능 최적화 전략 및 고려사항<a hidden class=anchor aria-hidden=true href=#성능-최적화-전략-및-고려사항>#</a></h4><p>핵심은 <strong>읽기와 쓰기의 길을 분리하고</strong>, 그 사이를 <strong>이벤트로 느슨하게 연결</strong>하면서 성능·확장·정합성을 균형 있게 잡는 것.</p><ul><li>성능은 <strong>읽기=캐시/프로젝션</strong>, 쓰기는 <strong>비동기/배치/파티션</strong>으로 끌어올린다.</li><li>정합성은 <strong>Outbox+CDC</strong>로 보장하고, <strong>파티션 키</strong>로 순서를 지킨다.</li><li>운영은 <strong>관측성과 스키마 진화</strong>가 성패를 가른다. 작은 구성으로 시작해 점진적 확대가 정석이다.</li></ul><table><thead><tr><th>카테고리</th><th>전략/고려사항</th><th>정의·원리</th><th>구성 요소</th><th>목적</th><th>사용 상황</th><th>특징/주의</th></tr></thead><tbody><tr><td>읽기 최적화</td><td>캐시/프로젝션/머뷰</td><td>쓰기와 분리된 읽기 전용 뷰로 핫패스 최소화</td><td>Redis/Elastic/읽기 DB, Projection</td><td>지연↓·처리량↑</td><td>조회 비율↑ 서비스</td><td>캐시 무효화 정책 필수.</td></tr><tr><td>쓰기·확장</td><td>비동기/배치/파티셔닝</td><td>개별 트랜잭션 비용↓, 병렬 처리↑</td><td>배치 프로듀서, 파티션 키</td><td>처리량↑·지연 균형</td><td>고트래픽 쓰기</td><td>배치 크기·재시도·백프레셔 튜닝</td></tr><tr><td>이벤트·브로커·순서</td><td>키=파티션 고정, 멱등성, DLQ</td><td>파티션 내 순서 보장·중복 허용 처리</td><td>Kafka/Rabbit, Idempotent Consumer</td><td>순서·신뢰성</td><td>엔티티별 이벤트 흐름</td><td>글로벌 순서 불가, 키 설계가 전부.</td></tr><tr><td>정합성·동기화</td><td>Outbox+CDC</td><td>&ldquo;DB 커밋=이벤트 기록 " 원자화→CDC 전달</td><td>Outbox 테이블, Debezium SMT, Broker</td><td>이중쓰기 제거</td><td>분산 동기화</td><td>약간의 지연, 표준화 쉬움.</td></tr><tr><td>스냅샷</td><td>주기 스냅샷/압축</td><td>이벤트 재생 비용 절감</td><td>스냅샷 스토어</td><td>리플레이 비용↓</td><td>ES 결합</td><td>용량/주기 설계 필요.</td></tr><tr><td>스키마 진화</td><td>Backward-compat</td><td>소비자/프로듀서 호환성 유지</td><td>스키마 레지스트리/버전 핸들러</td><td>배포 리스크↓</td><td>장수 서비스</td><td>Producer-First 금지, Consumer-First 권장.</td></tr><tr><td>운영·관측성</td><td>분산 추적/지연 모니터링</td><td>명령→이벤트→프로젝션→조회 체인 추적</td><td>OTel/APM/로그</td><td>이상 탐지·SLA</td><td>다팀 운영</td><td>상관 ID/샘플링·알람 룰 필수</td></tr><tr><td>보안·거버넌스</td><td>RBAC/암호화/격리</td><td>원천·전송·저장 보안</td><td>IAM/KMS/VPC</td><td>규제 충족</td><td>멀티테넌시·규제 도메인</td><td>성능·비용 트레이드오프</td></tr><tr><td>비용·용량</td><td>TTL/아카이빙/압축</td><td>오래된 데이터 비용↓</td><td>DLQ/아카이브/Topic 관리</td><td>비용 최적화</td><td>대용량 로그</td><td>회수·보존 정책 명문화</td></tr></tbody></table><p>작게 시작해 (단일 DB+ 프로젝션) 병목을 찾고, 필요 시 저장소 분리·배치·파티셔닝으로 확장한다.<br>정합성은 Outbox+CDC 로, 순서는 파티션 키로 지킨다.<br>스키마는 뒤호환을 우선하며, 관측성과 비용·보안을 동일한 1 급 요구사항으로 다룬다.</p><h3 id=고급-주제-advanced-topics>고급 주제 (Advanced Topics)<a hidden class=anchor aria-hidden=true href=#고급-주제-advanced-topics>#</a></h3><h4 id=도전-과제>도전 과제<a hidden class=anchor aria-hidden=true href=#도전-과제>#</a></h4><p>핵심은 <strong>명령 (쓰기) 모델</strong>과 <strong>조회 (읽기) 모델</strong>의 분리로 인해 발생하는 추가적인 복잡성을 어떻게 다룰 것인가이다.</p><p>가장 큰 기술적 문제는 <strong>&rsquo; 데이터 일관성 &lsquo;</strong> 이다.<br>쓰기 모델의 데이터가 읽기 모델로 즉시 동기화되지 않고, 비동기 이벤트에 의존하기 때문에 일시적인 데이터 불일치가 발생할 수 있다. 이는 사용자가 최신 정보를 보지 못하는 결과를 초래할 수 있다.<br>또한, 아키텍처가 복잡해지면서 <strong>개발 및 운영 부담</strong>이 커진다. 두 개의 모델을 관리해야 하고, 그 사이의 비동기 이벤트를 추적하고 모니터링해야 한다. 이 과정에서 <strong>데이터 중복</strong>이나 <strong>이벤트 스키마</strong> 관리에 대한 문제도 발생한다.</p><p>이러한 기술적 문제들은 결국 <strong>팀 구조</strong>와 <strong>협업 방식</strong>에 영향을 준다. 명령 모델과 조회 모델을 담당하는 팀을 분리하거나, 기존의 CRUD(Create, Read, Update, Delete) 기반 시스템에서 CQRS 로 전환하는 과정에서 <strong>기술 부채</strong>와 <strong>마이그레이션</strong>이라는 난관에 부딪히게 된다. CQRS 도입은 단순히 기술 스택을 바꾸는 것이 아니라, 조직의 운영 방식과도 깊은 관련이 있는 중대한 변화이다.</p><table><thead><tr><th><strong>카테고리</strong></th><th><strong>도전 과제</strong></th><th><strong>원인</strong></th><th><strong>영향</strong></th><th><strong>해결 방안</strong></th></tr></thead><tbody><tr><td><strong>기술적 복잡성 및 일관성 관리</strong></td><td><strong>최종 일관성 (Eventual Consistency)</strong></td><td>명령/조회 모델의 분리 및 비동기 이벤트 통신</td><td>사용자 경험 저하, 일시적 데이터 불일치</td><td>사용자 인터페이스 (UI) 에서 지연을 명시하거나, 동기 업데이트 옵션 설계, 사용자에게 피드백 제공</td></tr><tr><td></td><td><strong>분산 트랜잭션 관리</strong></td><td>여러 데이터베이스 간 ACID 트랜잭션 보장 어려움</td><td>데이터 무결성 위험, 복잡한 비즈니스 로직 처리 어려움</td><td>Saga 패턴, 2PC(Two-Phase Commit), 트랜잭션 아웃박스 (Transactional Outbox) 패턴</td></tr><tr><td></td><td><strong>아키텍처 복잡성</strong></td><td>읽기/쓰기 모델의 분리 및 추가 시스템 (메시징 시스템 등) 도입</td><td>개발, 운영, 테스트 난이도 증가, 팀 온보딩 비용 상승</td><td>마이크로서비스 경계 명확화, 점진적 도입 (Incremental adoption), 자동화된 테스트 및 배포 파이프라인 구축</td></tr><tr><td><strong>데이터 및 이벤트 관리</strong></td><td><strong>데이터 중복 및 유지보수</strong></td><td>읽기 모델의 비정규화된 데이터 저장</td><td>스토리지 비용 증가, 동기화 관리 비용 상승</td><td>스냅샷 (Snapshot), 변경 데이터 캡처 (CDC, Change Data Capture) 활용, 효율적인 동기화 전략 수립</td></tr><tr><td></td><td><strong>이벤트 순서, 중복, 유실</strong></td><td>분산 시스템의 비결정성, 네트워크 지연, 재시도 로직</td><td>데이터 불일치, 비즈니스 로직 오류</td><td>메시지 브로커 파티셔닝 (Partitioning), 멱등성 (Idempotency) 프로젝션, 트랜잭션 아웃박스 (Transactional Outbox) 패턴</td></tr><tr><td></td><td><strong>이벤트 스키마 진화</strong></td><td>비즈니스 요구사항 변경에 따른 이벤트 구조 변경</td><td>기존 프로젝션 (Projection) 과의 호환성 문제, 기술 부채</td><td>스키마 레지스트리 (Schema Registry) 도입, 이벤트 버전 관리 및 호환성 유지 전략 수립</td></tr><tr><td><strong>조직 및 운영 부담</strong></td><td><strong>운영 및 모니터링 복잡성</strong></td><td>분산된 컴포넌트들 (DB, 메시징, 서비스)</td><td>장애 진단 및 추적 어려움, 운영 비용 증가</td><td>통합 로깅, 분산 추적 (Distributed Tracing), 모니터링 대시보드 (Grafana, Kibana 등) 구축</td></tr><tr><td></td><td><strong>팀 구조 및 협업</strong></td><td>명령/조회 책임 분리에 따른 팀 역할 재정의</td><td>개발 속도 저하, 의존성 관리 문제</td><td>Conway&rsquo;s Law(콘웨이의 법칙) 를 고려한 팀 구조 재편, API(Application Programming Interface) 우선 설계, 계약 테스트 (Contract Testing) 도입</td></tr><tr><td></td><td><strong>레거시 시스템 통합</strong></td><td>기존 CRUD(Create, Read, Update, Delete) 기반 시스템과의 호환성</td><td>마이그레이션 복잡성, 기술 부채</td><td>점진적 마이그레이션, 스트랭글러 피그 (Strangler Fig) 패턴 적용</td></tr></tbody></table><p>CQRS 도입의 도전 과제는 크게 세 가지 영역으로 나뉜다.</p><ol><li><p>기술적 복잡성 및 일관성 관리이다.<br>분리된 모델과 비동기 통신 때문에 발생하는 최종 일관성 문제는 사용자 경험에 직접적인 영향을 준다. 이를 해결하기 위해 Saga 패턴 같은 분산 트랜잭션 관리 기법을 사용하거나, 아키텍처의 복잡성을 관리하는 전략이 필요하다.</p></li><li><p>데이터 및 이벤트 관리이다.<br>읽기 모델의 데이터 중복과 이벤트의 순서, 중복, 유실 문제는 시스템의 신뢰성을 떨어뜨릴 수 있다. 멱등성을 보장하는 프로젝션 (Projection) 이나 트랜잭션 아웃박스 (Transactional Outbox) 패턴을 통해 이를 방지해야 한다. 또한, 비즈니스 변경에 따라 발생하는 이벤트 스키마 진화 문제도 중요한 관리 포인트이다.</p></li><li><p><strong>조직 및 운영 부담</strong>이다.<br>CQRS 는 단순히 기술적인 선택이 아니라, 팀 구조와 운영 방식을 재정립하는 일이다. 복잡해진 시스템을 효율적으로 <strong>모니터링</strong>하고, 기존 <strong>레거시 시스템</strong>과의 통합을 위한 명확한 **마이그레이션 전략 (예: Strangler Fig 패턴)**이 필요하다. 이러한 도전 과제들을 극복하려면 기술적 솔루션과 함께 조직의 변화를 유도하는 노력이 병행되어야 한다.</p></li></ol><h4 id=생태계-및-관련-기술>생태계 및 관련 기술<a hidden class=anchor aria-hidden=true href=#생태계-및-관련-기술>#</a></h4><p>CQRS(Command Query Responsibility Segregation) 는 단독으로 사용되기보다는 여러 기술과 결합하여 그 진가를 발휘하는 패턴이다.<br>이 아키텍처의 핵심은 <strong>비동기 통신</strong>이다.<br>명령 (Command) 이 처리된 후, 그 결과를 <strong>이벤트 브로커</strong>인 <strong>Kafka(카프카)</strong> 나 <strong>RabbitMQ(래빗엠큐)</strong> 를 통해 읽기 모델로 전달하여 데이터를 업데이트한다. 이 과정에서 <strong>이벤트 소싱 (Event Sourcing)</strong> 과 같은 패턴을 함께 사용하면 모든 상태 변화 이력을 보존할 수 있어 시스템의 신뢰성을 높일 수 있다.</p><p>또한, CQRS 에서는 읽기 모델의 성능을 극대화하기 위해 목적에 맞는 다양한 데이터 저장소를 활용한다.<br>예를 들어, 복잡한 검색 기능은 **Elasticsearch(엘라스틱서치)**를 사용하고, 빠른 응답이 필요한 조회는 **Redis(레디스)**와 같은 인메모리 캐시를 활용하는 방식이다. 이러한 분산된 시스템을 효과적으로 관리하기 위해 **OpenTelemetry(오픈텔레메트리)**와 같은 <strong>관측성 (Observability)</strong> 도구는 필수적이며, **CloudEvents(클라우드이벤트)**와 같은 표준은 시스템 간의 원활한 통신을 보장한다.</p><table><thead><tr><th>카테고리</th><th>기술/표준</th><th>역할</th></tr></thead><tbody><tr><td><strong>메시징 및 이벤트 처리</strong></td><td><strong>Apache Kafka/RabbitMQ</strong></td><td>명령 처리 결과를 읽기 모델에 비동기적으로 전달하는 <strong>이벤트 브로커</strong></td></tr><tr><td></td><td><strong>Event Sourcing</strong></td><td>모든 상태 변화를 <strong>이벤트로 저장</strong>하여 감사 (Audit) 및 과거 상태 재구성 가능</td></tr><tr><td></td><td><strong>CloudEvents</strong></td><td>이벤트에 대한 메타데이터 (Metadata) 를 표준화하여 상호 운용성 보장</td></tr><tr><td><strong>데이터 저장소 및 관리</strong></td><td><strong>PostgreSQL/MongoDB</strong></td><td>쓰기 모델의 원본 데이터 저장소로 사용 (이벤트 스토어 역할 가능)</td></tr><tr><td></td><td><strong>Elasticsearch/OpenSearch</strong></td><td>복잡한 검색 및 집계 쿼리를 위한 <strong>읽기 모델 저장소</strong></td></tr><tr><td></td><td><strong>Redis</strong></td><td>빠른 응답이 필요한 읽기 모델을 위한 <strong>인메모리 캐시</strong></td></tr><tr><td></td><td><strong>Debezium CDC/Transactional Outbox</strong></td><td>이중 쓰기 (Dual Write) 문제를 해결하고 DB 변경 내용을 이벤트로 캡처</td></tr><tr><td><strong>관측성 및 표준</strong></td><td><strong>OpenTelemetry(OTel)</strong></td><td>분산 시스템 전반의 로그 (Log), 메트릭 (Metric), 추적 (Trace) 을 통합 관리하는 <strong>관측성 표준</strong></td></tr><tr><td></td><td><strong>JSON Schema/Avro</strong></td><td>이벤트 데이터의 구조와 스키마 (Schema) 를 정의하여 버전 호환성을 관리</td></tr><tr><td><strong>구현 및 프레임워크</strong></td><td><strong>Axon Framework</strong></td><td>CQRS 와 이벤트 소싱 구현을 돕는 전용 프레임워크</td></tr><tr><td></td><td><strong>Azure/AWS Patterns</strong></td><td>클라우드 환경에서 CQRS 를 설계하고 구현하는 가이드라인 제공</td></tr></tbody></table><p>CQRS 는 단일 기술이 아닌 여러 기술의 조합으로 완성되는 아키텍처 패턴이다.<br>가장 핵심적인 요소는 <strong>메시징 시스템</strong>으로, Kafka(카프카) 와 같은 이벤트 브로커가 비동기 통신의 중추 역할을 한다. 쓰기 모델의 데이터는 일반적으로 관계형 또는 NoSQL(NoSQL) 데이터베이스에 저장되고, 읽기 모델은 사용자 조회에 최적화된 Elasticsearch(엘라스틱서치) 와 같은 검색 엔진이나 Redis(레디스) 와 같은 캐시를 활용하여 성능을 높인다. 이러한 분산 환경을 효율적으로 운영하기 위해서는 OpenTelemetry(오픈텔레메트리) 같은 표준을 통해 시스템의 상태를 **관측 (Observability)**하고, 스키마 관리 도구를 사용해 데이터 호환성을 유지하는 것이 중요하다.</p><h4 id=최신-기술-트렌드와-미래-방향>최신 기술 트렌드와 미래 방향<a hidden class=anchor aria-hidden=true href=#최신-기술-트렌드와-미래-방향>#</a></h4><p>CQRS(Command Query Responsibility Segregation) 는 이제 단순한 아키텍처 패턴을 넘어, 최신 기술 트렌드와 결합하며 진화하고 있다. 가장 두드러진 변화는 <strong>클라우드 네이티브</strong> 환경으로의 전환이다. 개발자들은 더 이상 서버를 직접 관리하지 않는 <strong>서버리스 (Serverless) 아키텍처</strong>를 선호하며, 이를 통해 운영 부담을 줄이고 개발에 집중한다. 이와 함께, <strong>AI(인공지능)/ML(머신러닝)</strong> 기술이 도입되어 쿼리 패턴을 분석하고 읽기 모델을 자동으로 최적화하는 등 시스템이 스스로 진화하는 방향으로 나아가고 있다.</p><p>또한, 사용자에게 더 빠른 서비스를 제공하기 위해 **에지 컴퓨팅 (Edge Computing)**이 중요한 트렌드로 부상하고 있다. CDN(Content Delivery Network) 에지에 읽기 모델을 캐싱 (Caching) 하여 데이터 접근 지연 시간을 줄이는 방식이 대표적이다. 마지막으로, 복잡해진 CQRS 시스템을 효율적으로 운영하기 위해 **DevOps(데브옵스)**와 **GitOps(깃옵스)**를 기반으로 한 자동화된 배포 및 모니터링이 필수가 되고 있다.</p><table><thead><tr><th>카테고리</th><th>기술 트렌드</th><th>핵심 내용</th></tr></thead><tbody><tr><td><strong>클라우드/서버리스</strong></td><td><strong>서버리스 CQRS</strong></td><td>AWS Lambda, DynamoDB Streams 등을 활용하여 서버 관리 없이 CQRS 구현. 운영 비용 및 관리 부담 절감.</td></tr><tr><td></td><td><strong>클라우드 네이티브</strong></td><td>Kubernetes, Istio 와 같은 기술로 CQRS 컴포넌트의 자동 확장, 트래픽 관리, 유연성 확보.</td></tr><tr><td><strong>지능형 자동화</strong></td><td><strong>AI/ML 기반 최적화</strong></td><td>ML 모델이 쿼리 패턴을 분석하여 읽기 모델의 인덱스 구조, 파티셔닝 등을 자동으로 최적화.</td></tr><tr><td></td><td><strong>스트림 프로세싱</strong></td><td>Apache Flink, Apache Spark Streaming 등을 통해 대용량 이벤트를 고성능으로 실시간 처리.</td></tr><tr><td><strong>분산 및 에지 컴퓨팅</strong></td><td><strong>에지 컴퓨팅 통합</strong></td><td>CDN 에지에 읽기 모델을 캐싱하거나, 지역별로 명령 처리를 분산하여 사용자에게 더 가까운 서비스 제공.</td></tr><tr><td></td><td><strong>마이크로서비스/데이터 메시</strong></td><td>각 도메인 (Domain) 을 독립적인 데이터 제품 (Data Product) 으로 관리하여 데이터 거버넌스 (Governance) 및 통합 용이성 확보.</td></tr><tr><td><strong>개발/운영 혁신</strong></td><td><strong>DevOps 및 GitOps</strong></td><td>코드형 인프라 (Infrastructure as Code) 를 사용하여 배포를 자동화하고, Git 을 통해 시스템 상태를 관리.</td></tr><tr><td></td><td><strong>관측성 강화</strong></td><td>Prometheus, Grafana, Jaeger 등을 통합하여 분산된 CQRS 아키텍처의 상태를 실시간으로 모니터링하고 장애를 진단.</td></tr></tbody></table><p>CQRS 의 최신 트렌드는 <strong>클라우드 네이티브</strong>로의 전환과 <strong>지능형 자동화</strong>에 초점을 맞추고 있다. <strong>서버리스 아키텍처</strong>를 통해 인프라 관리 부담을 줄이고, Kubernetes(쿠버네티스) 와 같은 기술로 시스템을 유연하게 확장한다. 또한, <strong>AI/ML</strong>을 활용하여 읽기 모델을 자동으로 최적화하고, <strong>스트림 프로세싱 기술</strong>로 대용량 데이터를 실시간으로 처리하는 추세가 강화되고 있다. 사용자 경험을 개선하기 위한 <strong>에지 컴퓨팅</strong>의 도입도 활발하며, 이러한 복잡성을 효율적으로 관리하기 위해 **DevOps(데브옵스)**와 <strong>관측성</strong>은 필수적인 요소로 자리 잡았다.</p><hr><h2 id=최종-정리-및-학습-가이드>최종 정리 및 학습 가이드<a hidden class=anchor aria-hidden=true href=#최종-정리-및-학습-가이드>#</a></h2><h3 id=내용-정리>내용 정리<a hidden class=anchor aria-hidden=true href=#내용-정리>#</a></h3><p>&ldquo;<strong>도로 두 개</strong>&rdquo; 를 깐다 생각하면 쉽다.<br>한 도로 (쓰기) 는 <strong>규칙·검증</strong>이 촘촘하고, 다른 도로 (읽기) 는 <strong>고속도로</strong>처럼 빠르다.<br>쓰기에서 생긴 변화는 <strong>이벤트</strong>로 읽기 쪽 <strong>표지판 (프로젝션)</strong> 을 업데이트한다. 그래서 읽기를 크게 늘려도 쓰기 성능이 무너지지 않는다. 대신 표지판 갱신이 <strong>살짝 늦을 수 있음 (최종 일관성)</strong> 을 제품·UX 로 보완해야 한다.</p><ol><li><p><strong>무엇/왜</strong></p><ul><li>정의: 읽기/쓰기 모델·파이프라인 분리.</li><li>장점: 조회 가속, 쓰기 안정화, 독립 스케일, 폴리글랏, 보안 경계.</li><li>주의: 복잡성·일관성 관리.</li></ul></li><li><p><strong>어떻게</strong></p><ul><li>읽기: 프로젝션/머티리얼라이즈드 뷰, 캐시·인덱스 최적화.</li><li>쓰기: 트랜잭션·도메인 규칙·권한 집중.</li><li>동기화: 이벤트·메시지 브로커, Outbox/CDC.</li></ul></li><li><p><strong>언제</strong></p><ul><li>읽기 편중, 도메인 규칙 복잡, 팀 분리·배포 독립이 필요, 데이터 저장소 이질성 수용 필요 시 적합.</li><li>단순 CRUD 엔 과설계가 될 수 있음.</li></ul></li><li><p><strong>사례</strong></p><ul><li>Microsoft eShopOnContainers: 단순화된 CQRS 레퍼런스.</li><li>Netflix Tudum: CQRS 구현을 RAW/Hollow 방향으로 최적화.</li></ul></li><li><p><strong>함께 볼 패턴</strong></p><ul><li>ES(감사·재생성), EDA, Sagas/Outbox, Database-per-service.</li></ul></li></ol><h3 id=학습-로드맵>학습 로드맵<a hidden class=anchor aria-hidden=true href=#학습-로드맵>#</a></h3><table><thead><tr><th>Phase</th><th>기간</th><th>목표</th><th>주요 학습 내용</th><th>산출물/성과</th></tr></thead><tbody><tr><td>1. 기초 이해</td><td>1~2 주</td><td>개념·배경 이해</td><td>CRUD 한계, CQS vs CQRS</td><td>개념 노트, 비교표</td></tr><tr><td>2. 이론 학습</td><td>1~2 주</td><td>설계 원리 습득</td><td>구성 요소, 데이터 흐름, 일관성 모델</td><td>아키텍처 다이어그램</td></tr><tr><td>3. 분석</td><td>1 주</td><td>적용 판단</td><td>장단점, 트레이드오프, 사례 분석</td><td>적용 가이드</td></tr><tr><td>4. 구현 실습</td><td>2~4 주</td><td>CQRS 구축</td><td>단일 앱 구현, Outbox+CDC, 파티션 설계</td><td>동작 예제 코드</td></tr><tr><td>5. 운영 최적화</td><td>2 주</td><td>안정적 운영</td><td>OTel 관측성, 지연 모니터링, 장애 복구</td><td>모니터링 대시보드</td></tr><tr><td>6. 고급 주제</td><td>지속</td><td>확장·최적화</td><td>Event Sourcing, Saga, Serverless</td><td>고급 설계 문서</td></tr></tbody></table><h3 id=학습-항목-매트릭스>학습 항목 매트릭스<a hidden class=anchor aria-hidden=true href=#학습-항목-매트릭스>#</a></h3><table><thead><tr><th>카테고리</th><th style=text-align:right>Phase</th><th>항목</th><th>중요도</th><th>설명</th></tr></thead><tbody><tr><td>기초</td><td style=text-align:right>1</td><td><strong>CQS 원칙</strong></td><td>필수</td><td>CQRS 의 이론적 기반 (명령/조회 분리).</td></tr><tr><td>기초</td><td style=text-align:right>1</td><td><strong>CQRS 핵심 개념</strong></td><td>필수</td><td>읽기/쓰기 모델·인터페이스를 분리해 독립 최적화.</td></tr><tr><td>기초</td><td style=text-align:right>1</td><td><strong>최종 일관성</strong></td><td>필수</td><td>비동기 전파로 읽기 최신성이 지연될 수 있음을 이해.</td></tr><tr><td>기초</td><td style=text-align:right>1</td><td><strong>CAP 맥락 이해</strong></td><td>권장</td><td>가용성/일관성·분할 내성 트레이드오프 감각 잡기.</td></tr><tr><td>이론</td><td style=text-align:right>2</td><td><strong>도메인 모델링 (애그리게이트)</strong></td><td>필수</td><td>쓰기 모델의 트랜잭션 경계·불변식 설계.</td></tr><tr><td>이론</td><td style=text-align:right>2</td><td><strong>프로젝션/뷰 설계</strong></td><td>필수</td><td>조회 특화 <strong>머티리얼라이즈드 뷰</strong> 설계 원칙.</td></tr><tr><td>이론</td><td style=text-align:right>2</td><td><strong>도메인 이벤트</strong></td><td>권장</td><td>상태 변화 사실을 이벤트로 표준화 (의미·스키마).</td></tr><tr><td>구현</td><td style=text-align:right>4</td><td><strong>기본 CQRS 구현</strong></td><td>필수</td><td>Command/Query 핸들러·Read/Write 모델 분리.</td></tr><tr><td>구현</td><td style=text-align:right>4</td><td><strong>메시지 브로커 도입</strong></td><td>권장</td><td>비동기 이벤트 전달 (Kafka/RabbitMQ 등).</td></tr><tr><td>구현</td><td style=text-align:right>4</td><td><strong>Transactional Outbox</strong></td><td>필수급 권장</td><td>DB 쓰기 + 이벤트 발행 <strong>원자성</strong> 보장.</td></tr><tr><td>구현</td><td style=text-align:right>5</td><td><strong>프로젝션 파이프라인</strong></td><td>권장</td><td>이벤트→읽기 모델 갱신 (실시간/배치).</td></tr><tr><td>구현</td><td style=text-align:right>5</td><td><strong>폴리글랏 퍼시스턴스</strong></td><td>권장</td><td>읽기/쓰기 저장소를 목적별로 분리·튜닝.</td></tr><tr><td>구현</td><td style=text-align:right>5</td><td><strong>MSA 통합 (선택)</strong></td><td>선택</td><td>서비스 경계 분리·API 게이트웨이·스키마 경계.</td></tr><tr><td>운영</td><td style=text-align:right>6</td><td><strong>모니터링/관측</strong></td><td>권장</td><td>읽기 p95·뷰 갱신 지연·Outbox 미전송·중복률.</td></tr></tbody></table><hr><h2 id=용어-정리>용어 정리<a hidden class=anchor aria-hidden=true href=#용어-정리>#</a></h2><table><thead><tr><th>카테고리</th><th>용어</th><th>정의</th><th>관련/주의</th></tr></thead><tbody><tr><td>핵심 패턴·원칙</td><td><strong>CQRS</strong></td><td>읽기 (Query) 와 쓰기 (Command) 모델·경로를 분리하는 설계 패턴. 성능·확장성 최적화가 목적</td><td>대부분 시스템엔 과한 복잡성일 수 있음. 선별 적용 권장.</td></tr><tr><td></td><td><strong>CQS</strong></td><td>쿼리는 부작용 없고, 명령은 결과를 반환하지 않는 <strong>메서드 수준</strong> 규율</td><td>CQRS 의 사상적 기반.</td></tr><tr><td></td><td><strong>Event Sourcing</strong></td><td>모든 상태 변경을 <strong>이벤트로 영속화</strong>하고 이벤트 재생으로 상태 복원</td><td>CQRS 와 자주 결합되나 <strong>필수 아님</strong>.</td></tr><tr><td>도메인/경계</td><td><strong>Aggregate</strong></td><td>DDD 의 일관성 경계. 명령 처리와 상태 변경의 단위</td><td>CQRS 쓰기 모델의 핵심 단위</td></tr><tr><td></td><td><strong>Bounded Context</strong></td><td>모델/언어의 경계를 명시하는 DDD 전략 개념</td><td>마이크로서비스 경계 설정에 활용.</td></tr><tr><td>구성요소/역할</td><td><strong>Command</strong></td><td>시스템 상태를 <strong>변경</strong>하는 요청/메시지</td><td>Command Handler 와 1:1 관계</td></tr><tr><td></td><td><strong>Query</strong></td><td>상태를 <strong>조회</strong>하는 요청 (부작용 없음)</td><td>Read Model 만 접근</td></tr><tr><td></td><td><strong>Command Handler</strong></td><td>명령 검증·도메인 규칙 실행·쓰기 저장수행</td><td>Outbox 와 함께 이벤트 발행 연결</td></tr><tr><td></td><td><strong>Query Handler</strong></td><td>조회 요청을 처리하고 <strong>읽기 모델</strong>에서 응답</td><td>Read DB 최적화와 결합</td></tr><tr><td></td><td><strong>Projection</strong></td><td>이벤트를 소비해 <strong>읽기 모델 (물질화 뷰)</strong> 을 갱신하는 프로세스</td><td>Denormalizer 라고도 부름</td></tr><tr><td></td><td><strong>Read Model / Write Model</strong></td><td>조회 전용 모델 / 상태 변경 전용 모델</td><td>분리 저장소 권장 (성능·독립 스케일)</td></tr><tr><td></td><td><strong>Event Store</strong></td><td>이벤트 소싱용 이벤트 영속 저장소</td><td>스냅샷·리플레이 지원</td></tr><tr><td>데이터·저장소</td><td><strong>Materialized View</strong></td><td>읽기 성능을 위해 비정규화된 <strong>실시간/준실시간 뷰</strong></td><td>Projection 결과물</td></tr><tr><td></td><td><strong>Snapshot</strong></td><td>특정 시점 Aggregate 상태 스냅샷</td><td>긴 리플레이 시간 단축</td></tr><tr><td></td><td><strong>Polyglot Persistence</strong></td><td>워크로드별 최적화된 DB 를 혼합 사용</td><td>Read/Write 저장소 이기종화</td></tr><tr><td>메시징/동기화</td><td><strong>Event Broker</strong></td><td>이벤트 발행/구독 인프라 (Kafka, RabbitMQ 등)</td><td>전달 보장·순서·중복 고려</td></tr><tr><td></td><td><strong>Delivery Semantics</strong></td><td>at-most/at-least/ exactly-once 전달 의미</td><td>EOS 는 범위·전제조건이 있음.</td></tr><tr><td></td><td><strong>Consumer Lag</strong></td><td>브로커 오프셋 대비 소비 지연</td><td>읽기 모델 랙 지표로 활용</td></tr><tr><td>신뢰성·일관성 패턴</td><td><strong>Transactional Outbox</strong></td><td>DB 트랜잭션 안에서 <strong>아웃박스 레코드</strong>를 기록하고 CDC/퍼블리셔로 브로커 전송</td><td>Dual-write 문제 표준 해법.</td></tr><tr><td></td><td><strong>Saga(보상 트랜잭션)</strong></td><td>로컬 트랜잭션들의 연쇄와 <strong>보상 처리</strong>로 분산 일관성 확보</td><td>오케스트레이션/코레오그래피.</td></tr><tr><td></td><td><strong>Idempotence</strong></td><td>같은 메시지를 여러 번 처리해도 결과가 동일</td><td>중복·재시도 안전 처리의 기본</td></tr></tbody></table><hr><h2 id=참고-및-출처>참고 및 출처<a hidden class=anchor aria-hidden=true href=#참고-및-출처>#</a></h2><ul><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs>CQRS 패턴 – Microsoft Learn</a></li><li><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing>Event Sourcing 패턴 – Microsoft Learn</a></li><li><a href=https://www.martinfowler.com/bliki/CQRS.html>CQRS – Martin Fowler</a></li><li><a href=https://microservices.io/patterns/data/cqrs.html>CQRS 패턴 – microservices.io</a></li><li><a href=https://docs.aws.amazon.com/prescriptive-guidance/latest/modernization-data-persistence/cqrs-pattern.html>CQRS 패턴 – AWS Prescriptive Guidance</a></li><li><a href=https://www.confluent.io/learn/cqrs/>CQRS 학습 가이드 – Confluent</a></li><li><a href=https://developers.eventstore.com/>Kurrent(EventStoreDB) 공식 문서</a></li><li><a href=https://debezium.io/documentation/reference/stable/transformations/outbox-event-router.html>Outbox Event Router – Debezium 문서</a></li><li><a href=https://microservices.io/patterns/data/transactional-outbox.html>Transactional Outbox – microservices.io</a></li><li><a href=https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/transactional-outbox.html>Transactional Outbox – AWS Prescriptive Guidance</a></li><li><a href=https://www.baeldung.com/cqrs-event-sourcing-java>CQRS와 이벤트 소싱 in Java – Baeldung</a></li><li><a href=https://www.redhat.com/ko/blog/illustrated-cqrs>그림으로 보는 CQRS – Red Hat</a></li><li><a href=https://www.techtarget.com/searchapparchitecture/definition/CQRS-command-query-responsibility-segregation>CQRS 정의 – TechTarget</a></li><li><a href=https://enterprisecraftsmanship.com/posts/types-of-cqrs/>Types of CQRS – Enterprise Craftsmanship</a></li><li><a href=https://learn.microsoft.com/en-us/samples/azure-samples/cosmos-db-design-patterns/event-sourcing/>Azure Cosmos DB: Event Sourcing 코드 샘플 – Microsoft</a></li><li><a href=https://developer.confluent.io/patterns/compositional-patterns/command-query-responsibility-segregation/>CQRS 패턴(구성 패턴) – Confluent Developer</a></li><li><a href=https://microservices.io/patterns/data/event-sourcing.html>Event Sourcing 패턴 – microservices.io</a></li><li><a href=https://mia-platform.eu/blog/understanding-event-sourcing-and-cqrs-pattern/>Event Sourcing & CQRS 패턴 이해 – Mia-Platform</a></li><li><a href=https://www.geeksforgeeks.org/cqrs-command-query-responsibility-segregation/>CQRS 디자인 패턴 – GeeksforGeeks</a></li><li><a href=https://www.rootstrap.com/blog/demystifying-cqrs-a-practical-approach---simple-cqrs-part-1>Demystifying CQRS: Simple CQRS Part 1 – Rootstrap</a></li><li><a href=https://systemdesignschool.io/blog/cqrs-pattern>CQRS 패턴 – System Design School</a></li><li><a href=https://aws.amazon.com/blogs/database/build-a-cqrs-event-store-with-amazon-dynamodb/>Amazon DynamoDB로 CQRS 이벤트 스토어 구축 – AWS 블로그</a></li><li><a href=https://www.baeldung.com/kafka-message-ordering>Kafka 메시지 순서 보장 전략 – Baeldung</a></li><li><a href=https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/decompose-monoliths-into-microservices-by-using-cqrs-and-event-sourcing.html>모놀리스를 CQRS+ES로 마이크로서비스로 분해 – AWS Prescriptive Guidance(패턴)</a></li></ul><hr></div></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script><footer class=footer><span>&copy; 2026 <a href=https://buenhyden.github.io/>hyunyoun's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>